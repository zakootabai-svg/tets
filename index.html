<!DOCTYPE html> 
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<meta name="description" content="Al Fizaa Girls Hostel Management System - Secure student accommodation management platform with comprehensive features for admissions, fees, and administrative tasks." />
<meta name="keywords" content="hostel management, student accommodation, girls hostel, Al Fizaa, hostel administration, student management system" />

<link rel="manifest" href="manifest.json">
<!-- Theme color for browsers that support it -->
<meta name="theme-color" content="#6200ee">
<meta name="msapplication-TileColor" content="#6200ee">
<meta name="apple-mobile-web-app-status-bar-style" content="#6200ee">
<link rel="apple-touch-icon" sizes="180x180" href="logo.png">
<link rel="icon" type="image/png" sizes="32x32" href="logo.png">
<link rel="icon" type="image/png" sizes="16x16" href="logo.png">

<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<style>
/* Accessibility Enhancements */
.sr-only {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0, 0, 0, 0);
  white-space: nowrap;
  border: 0;
}

/* Focus indicators for better keyboard navigation */
*:focus {
  outline: 2px solid #667eea !important;
  outline-offset: 2px !important;
}

/* High contrast mode support */
@media (prefers-contrast: high) {
  .login-container {
    background: #ffffff !important;
    border: 3px solid #000000 !important;
  }
  
  .login-btn {
    border: 2px solid #000000 !important;
  }
}

/* Reduced motion support */
@media (prefers-reduced-motion: reduce) {
  * {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
  }
}

#admin-notifications-btn {
  padding:6px 12px;
  background:rgba(255,255,255,0.2);
  color:white;
  border:1px solid rgba(255,255,255,0.3);
  border-radius:6px;
  cursor:pointer;
  margin-right:10px;
  font-size:0.85rem;
  display:none;
  position:relative;
}
#notification-badge {
  position:absolute;
  top:-8px;
  right:-8px;
  background:#ff4444;
  color:white;
  border-radius:50%;
  min-width:20px;
  height:20px;
  display:none;
  font-size:0.7rem;
  font-weight:bold;
  line-height:20px;
  text-align:center;
}

/* Mobile scrolling fix */
@media (max-width: 768px) {
  html {
    height: 100%;
    overflow-x: hidden;
  }
  
  body {
    min-height: 100vh;
    overflow-x: hidden;
    overflow-y: auto;
    width: 100%;
    position: static;
  }
  
  /* Fix for all containers */
  .container, .main-content, [class*="container"], [class*="content"] {
    overflow-y: auto;
  }
  
  /* Remove problematic transforms and filters */
  * {
    -webkit-transform: none !important;
    transform: none !important;
    -webkit-backdrop-filter: none !important;
    backdrop-filter: none !important;
    will-change: auto !important;
  }
  
  /* Add smooth scrolling for all containers */
  .main-content, 
  [id*="template"], 
  .content-area,
  .table-container,
  .students-content,
  .admin-content, 
  .guest-content,
  .login-container,
  #login-page {
    overflow-y: auto !important;
    overflow-x: hidden !important;
    scroll-behavior: smooth !important;
    height: auto !important;
    max-height: calc(100vh - 80px) !important;
  }
  
  /* Specific template container fixes */
  [id*="template"] {
    padding: 10px !important;
    margin: 0 !important;
    box-sizing: border-box !important;
    width: 100% !important;
  }
  
  /* Ensure proper content flow */
  .content-area {
    padding: 8px !important;
    margin: 0 !important;
    position: relative !important;
  }
  
  /* Prevent zoom and improve inputs */
  input, select, textarea, button {
    font-size: 16px !important;
    -webkit-appearance: none;
    appearance: none;
    border-radius: 0;
  }
  
  /* Disable animations that can cause scroll issues */
  *, *::before, *::after {
    animation-duration: 0s !important;
    transition-duration: 0s !important;
  }
}
</style>
<title>Al Fizaa Girls Hostel - Management Software</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
  import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
  import { getFirestore, doc, setDoc, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

  // Firebase Configuration
  const firebaseConfig = {
    apiKey: "AIzaSyBge9K_Zyx0v9zzXxwWGSBPne4ChkdDP5M",
    authDomain: "alfizaagirlshostelvs.firebaseapp.com",
    projectId: "alfizaagirlshostelvs",
    storageBucket: "alfizaagirlshostelvs.firebasestorage.app",
    messagingSenderId: "655264186937",
    appId: "1:655264186937:web:46f7371aeda70ddb60c3e8",
    measurementId: "G-JJ8J8W2BP2"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // Make Firebase available globally
  window.firebaseAuth = auth;
  window.firebaseDb = db;
  window.firebaseSignIn = signInWithEmailAndPassword;
  window.firebaseSignUp = createUserWithEmailAndPassword;
  window.firebaseSignOut = signOut;
  window.firebaseOnAuthStateChanged = onAuthStateChanged;
  window.firebaseSetDoc = setDoc;
  window.firebaseDoc = doc;
  window.firebaseGetDoc = getDoc;
</script>
<script>
// PWA Service Worker Registration
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('data:text/javascript;base64,' + btoa(`
const CACHE_NAME = 'al-fizaa-hostel-v1';
const urlsToCache = ['/index1.html', '/manifest.json'];
self.addEventListener('install', event => {
  event.waitUntil(caches.open(CACHE_NAME).then(cache => cache.addAll(urlsToCache)));
});
self.addEventListener('fetch', event => {
  event.respondWith(caches.match(event.request).then(response => response || fetch(event.request)));
});
self.addEventListener('sync', event => {
  if (event.tag === 'background-sync') event.waitUntil(syncData());
});
async function syncData() {
  try {
    const data = JSON.parse(localStorage.getItem('pendingSync') || '[]');
    if (data.length > 0) {
      localStorage.removeItem('pendingSync');
      console.log('Synced', data.length, 'items');
    }
  } catch (e) {}
}
    `)).then(reg => console.log('SW registered')).catch(err => console.log('SW failed'));
  });
}

// Data Manager
class DataManager {
  constructor() {
    this.isOnline = navigator.onLine;
    this.init();
  }
  
  init() {
    window.addEventListener('online', () => {
      this.isOnline = true;
      this.showStatus('Online - Syncing...', 'online');
      this.syncPendingData();
    });
    window.addEventListener('offline', () => {
      this.isOnline = false;
      this.showStatus('Offline Mode', 'offline');
    });
  }
  
  async saveData(key, data) {
    localStorage.setItem(key, JSON.stringify(data));
    if (!this.isOnline) {
      const pending = JSON.parse(localStorage.getItem('pendingSync') || '[]');
      pending.push({key, data, timestamp: Date.now()});
      localStorage.setItem('pendingSync', JSON.stringify(pending));
    }
  }
  
  getData(key) {
    return JSON.parse(localStorage.getItem(key) || '[]');
  }
  
  async syncPendingData() {
    const pending = JSON.parse(localStorage.getItem('pendingSync') || '[]');
    if (pending.length > 0) {
      localStorage.removeItem('pendingSync');
      this.showStatus('Data synced', 'success');
    }
  }
  
  showStatus(message, type) {
    let statusEl = document.getElementById('sync-status');
    if (!statusEl) {
      statusEl = document.createElement('div');
      statusEl.id = 'sync-status';
      statusEl.style.cssText = 'position:fixed;top:20px;right:20px;padding:8px 12px;border-radius:5px;color:white;font-size:12px;z-index:10000;';
      document.body.appendChild(statusEl);
    }
    statusEl.textContent = message;
    statusEl.style.background = type === 'online' ? '#28a745' : type === 'offline' ? '#dc3545' : '#ffc107';
    statusEl.style.display = 'block';
    setTimeout(() => statusEl.style.display = 'none', 3000);
  }
}

// Initialize
window.dataManager = new DataManager();

// PWA Install
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  const installBtn = document.createElement('button');
  installBtn.textContent = 'Install App';
  installBtn.style.cssText = 'position:fixed;bottom:20px;right:20px;padding:10px 20px;background:#4D388A;color:white;border:none;border-radius:5px;cursor:pointer;z-index:1000;';
  installBtn.onclick = async () => {
    if (deferredPrompt) {
      deferredPrompt.prompt();
      await deferredPrompt.userChoice;
      deferredPrompt = null;
      installBtn.remove();
    }
  };
  document.body.appendChild(installBtn);
});
</script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');
:root{
--primary:#4D388A;--secondary:#6D57A8;--accent:#28A745;--bg:#F4F6F9;
--card:#FFFFFF;--text:#333;--border:#E0E0E0;--red:#DC3545;--green:#28A745;
--blue:#17A2B8;--yellow:#FFC107;
--gradient-1:#4a5cc9;--gradient-2:#5d3987;--gradient-3:#d575e0;--gradient-4:#d43851;
--gradient-5:#3989e3;--gradient-6:#00d1e3;--gradient-7:#e44f4f;--gradient-8:#3ca89c;
--gradient-9:#2d96b8;--gradient-10:#7bb599;--gradient-11:#e5b03c;--gradient-12:#e57fd8;
}

/* Animations disabled on mobile for better performance */
@media (min-width: 769px) {
  @keyframes gradientShift {
      0% { background-position: 0% 50% }
      50% { background-position: 100% 50% }
      100% { background-position: 0% 50% }
  }
  @keyframes float {
      0%, 100% { transform: translateY(0px) rotate(0deg) }
      33% { transform: translateY(-20px) rotate(5deg) }
      66% { transform: translateY(-10px) rotate(-3deg) }
  }
  @keyframes pulse {
      0%, 100% { transform: scale(1) }
      50% { transform: scale(1.05) }
  }
  @keyframes shimmer {
      0% { background-position: -200% center }
      100% { background-position: 200% center }
  }
}
.vibrant-input {
    background: rgba(255,255,255,0.95);
    border: 1px solid rgba(0,0,0,0.2);
    transition: none;
}
.vibrant-input:focus {
    border: 1px solid rgba(0,0,0,0.4);
    box-shadow: none;
    transform: none;
}
.gradient-text {
    background: none;
    -webkit-background-clip: initial;
    -webkit-text-fill-color: initial;
    background-clip: initial;
    background-size: initial;
    animation: none;
    color: #333;
}

/* Theme Variants */
.theme-purple{--primary:#4D388A;--secondary:#6D57A8;--accent:#28A745;
--gradient-1:#4a5cc9;--gradient-2:#5d3987;--gradient-3:#d575e0;--gradient-4:#d43851;
--gradient-5:#3989e3;--gradient-6:#00d1e3;--gradient-7:#e44f4f;--gradient-8:#3ca89c;
--gradient-9:#2d96b8;--gradient-10:#7bb599;--gradient-11:#e5b03c;--gradient-12:#e57fd8;}

.theme-ocean{--primary:#0077be;--secondary:#00a8cc;--accent:#00d4aa;
--gradient-1:#0077be;--gradient-2:#00a8cc;--gradient-3:#00d4aa;--gradient-4:#7dd3fc;
--gradient-5:#38bdf8;--gradient-6:#0ea5e9;--gradient-7:#0284c7;--gradient-8:#0369a1;
--gradient-9:#075985;--gradient-10:#0c4a6e;--gradient-11:#164e63;--gradient-12:#155e75;}

.theme-sunset{--primary:#ff6b35;--secondary:#f7931e;--accent:#ffb347;
--gradient-1:#ff6b35;--gradient-2:#f7931e;--gradient-3:#ffb347;--gradient-4:#ffd700;
--gradient-5:#ff8c00;--gradient-6:#ff4500;--gradient-7:#dc143c;--gradient-8:#b22222;
--gradient-9:#8b0000;--gradient-10:#a0522d;--gradient-11:#d2691e;--gradient-12:#cd853f;}

.theme-forest{--primary:#228b22;--secondary:#32cd32;--accent:#90ee90;
--gradient-1:#228b22;--gradient-2:#32cd32;--gradient-3:#90ee90;--gradient-4:#98fb98;
--gradient-5:#00ff7f;--gradient-6:#00fa9a;--gradient-7:#20b2aa;--gradient-8:#008b8b;
--gradient-9:#2e8b57;--gradient-10:#3cb371;--gradient-11:#66cdaa;--gradient-12:#7fffd4;}

.theme-royal{--primary:#4b0082;--secondary:#8a2be2;--accent:#9370db;
--gradient-1:#4b0082;--gradient-2:#8a2be2;--gradient-3:#9370db;--gradient-4:#ba55d3;
--gradient-5:#da70d6;--gradient-6:#ee82ee;--gradient-7:#dda0dd;--gradient-8:#d8bfd8;
--gradient-9:#e6e6fa;--gradient-10:#f0e68c;--gradient-11:#ffd700;--gradient-12:#ffb347;}

.theme-cherry{--primary:#dc143c;--secondary:#ff1493;--accent:#ff69b4;
--gradient-1:#dc143c;--gradient-2:#ff1493;--gradient-3:#ff69b4;--gradient-4:#ff6347;
--gradient-5:#ff4500;--gradient-6:#ffa500;--gradient-7:#ffd700;--gradient-8:#ffff00;
--gradient-9:#adff2f;--gradient-10:#7fff00;--gradient-11:#32cd32;--gradient-12:#00ff00;}

.theme-midnight{--primary:#191970;--secondary:#483d8b;--accent:#6a5acd;
--gradient-1:#191970;--gradient-2:#483d8b;--gradient-3:#6a5acd;--gradient-4:#7b68ee;
--gradient-5:#9370db;--gradient-6:#8a2be2;--gradient-7:#9932cc;--gradient-8:#ba55d3;
--gradient-9:#da70d6;--gradient-10:#ee82ee;--gradient-11:#dda0dd;--gradient-12:#d8bfd8;}

.theme-tropical{--primary:#ff7f50;--secondary:#ff6347;--accent:#ffa500;
--gradient-1:#ff7f50;--gradient-2:#ff6347;--gradient-3:#ffa500;--gradient-4:#ffd700;
--gradient-5:#ffff00;--gradient-6:#adff2f;--gradient-7:#7fff00;--gradient-8:#32cd32;
--gradient-9:#00ff7f;--gradient-10:#00fa9a;--gradient-11:#20b2aa;--gradient-12:#008b8b;}

.theme-aurora{--primary:#00ced1;--secondary:#48d1cc;--accent:#7fffd4;
--gradient-1:#00ced1;--gradient-2:#48d1cc;--gradient-3:#7fffd4;--gradient-4:#afeeee;
--gradient-5:#e0ffff;--gradient-6:#f0f8ff;--gradient-7:#e6e6fa;--gradient-8:#d8bfd8;
--gradient-9:#dda0dd;--gradient-10:#ee82ee;--gradient-11:#da70d6;--gradient-12:#ba55d3;}

.theme-cosmic{--primary:#8b008b;--secondary:#9932cc;--accent:#ba55d3;
--gradient-1:#8b008b;--gradient-2:#9932cc;--gradient-3:#ba55d3;--gradient-4:#da70d6;
--gradient-5:#ee82ee;--gradient-6:#dda0dd;--gradient-7:#d8bfd8;--gradient-8:#e6e6fa;
--gradient-9:#f0f8ff;--gradient-10:#e0ffff;--gradient-11:#afeeee;--gradient-12:#7fffd4;}
*{box-sizing:border-box;margin:0;padding:0;font-family:'Poppins',sans-serif;-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none;}
html{height:-webkit-fill-available;height:100vh;font-size:16px;overflow-x:hidden;scroll-behavior:smooth;}
body{background:var(--bg);min-height:-webkit-fill-available;min-height:100vh;margin:0;overflow-x:hidden;position:relative;overscroll-behavior:contain;scroll-behavior:smooth;}
.page{display:none}
/* Default state - always show login page first, hide app page until logged in */
#app-page{display:none !important;}
#login-page{display:block !important;}
body.showing-login #app-page{display:none !important;}
body.showing-login #login-page{display:block !important;}
body.showing-app #login-page{display:none !important;}
body.showing-app #app-page{display:block !important;}
body:not(.showing-app) #app-page{display:none;}
.app-container{display:flex;min-height:-webkit-fill-available;min-height:100vh;position:relative;overflow-x:hidden;width:100%;transition:all 0.3s ease;}
/* Login */
#login-page{display:flex;align-items:center;justify-content:center;min-height:100vh;background:linear-gradient(135deg,var(--gradient-1),var(--gradient-2));position:relative;overflow:hidden;}
.login-container{background:rgba(255,255,255,0.95);padding:40px;border-radius:15px;box-shadow:0 20px 40px rgba(0,0,0,0.1);max-width:400px;width:90%;text-align:center;}
.login-form input{width:100%;padding:12px;margin:10px 0;border:1px solid #ddd;border-radius:8px;font-size:16px;}
.login-btn{width:100%;padding:12px;background:var(--primary);color:white;border:none;border-radius:8px;font-size:16px;cursor:pointer;margin-top:10px;}
.login-btn:hover{background:var(--secondary);}

#app-page{padding:20px;}
.dashboard{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;margin-bottom:30px;}
.card{background:white;padding:20px;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,0.1);}
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:30px;}
.stat-card{background:linear-gradient(135deg,var(--primary),var(--secondary));color:white;padding:20px;border-radius:10px;text-align:center;}
.student-card,.payment-card{background:#f8f9fa;padding:15px;margin:10px 0;border-radius:8px;border-left:4px solid var(--primary);}
.form-group{margin:15px 0;}
.form-group label{display:block;margin-bottom:5px;font-weight:500;}
.form-group input,.form-group select{width:100%;padding:10px;border:1px solid #ddd;border-radius:5px;}
.btn{padding:10px 20px;background:var(--primary);color:white;border:none;border-radius:5px;cursor:pointer;}
.btn:hover{background:var(--secondary);}

@media (max-width:768px){
.dashboard{grid-template-columns:1fr;}
.stats{grid-template-columns:1fr;}
.login-container{padding:30px 20px;}

/* Fix mobile login page viewport and scrolling issues */
#login-page {
  min-height: 100vh !important;
  height: auto !important;
  overflow-y: auto !important;
  overflow-x: hidden !important;
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
  position: relative !important;
  padding: 20px 10px !important;
  box-sizing: border-box !important;
}

/* Ensure login container fits properly on mobile */
.login-container {
  min-height: unset !important;
  max-height: 90vh !important;
  overflow-y: auto !important;
  overflow-x: hidden !important;
  margin: auto !important;
  position: relative !important;
  width: 95% !important;
  max-width: 400px !important;
  display: block !important;
  box-sizing: border-box !important;
}

/* Fix mobile viewport blank space issues */
html, body {
  height: 100% !important;
  width: 100% !important;
  margin: 0 !important;
  padding: 0 !important;
  overflow-x: hidden !important;
}
}

/* Enhanced animated background when no video or on mobile */
#login-page::before {
  display: none;
}

/* Additional animated particles */
#login-page::after {
  display: none;
}

/* Force mobile animated background to show */
body.mobile-animated-bg #login-page::before,
body.mobile-animated-bg #login-page::after {
  display: block !important;
  opacity: 1 !important;
}

@keyframes floatingBubbles {
  0%, 100% { 
    transform: translateY(0px) rotate(0deg) scale(1);
    opacity: 0.8;
  }
  25% { 
    transform: translateY(-30px) rotate(5deg) scale(1.1);
    opacity: 0.9;
  }
  50% { 
    transform: translateY(-20px) rotate(-3deg) scale(0.9);
    opacity: 1;
  }
  75% { 
    transform: translateY(-40px) rotate(8deg) scale(1.05);
    opacity: 0.85;
  }
}

@keyframes sparkle {
  0% { 
    background-position: 0% 0%, 0% 0%, 0% 0%, 0% 0%;
  }
  100% { 
    background-position: 100% 100%, -100% 100%, 50% -50%, -25% 75%;
  }
}

.hero-video{
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
  z-index: 1;
  opacity: 0.8;
  pointer-events: none;
  display: block;
  visibility: visible;
}

/* Desktop specific styles */
@media (min-width: 769px) {
  .hero-video {
    opacity: 0.7 !important;
    z-index: 1 !important;
  }
}

/* Video error handling - show animated background if video fails */
.hero-video[style*="display: none"] + .login-container {
  background: rgba(255,255,255,0.5) !important;
}

/* Ensure video plays on mobile */
@media (max-width: 768px) {
  .hero-video {
    opacity: 0.8 !important;
    display: block !important;
    visibility: visible !important;
    z-index: 1 !important;
    pointer-events: none;
    width: 100% !important;
    height: 100% !important;
    object-fit: cover !important;
    position: absolute !important;
    top: 0 !important;
    left: 0 !important;
  }
  
  /* Mobile-specific animated background when no video */
  #login-page {
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    min-height: -webkit-fill-available !important;
    min-height: 100vh !important;
    width: 100% !important;
    max-width: 100vw !important;
    overflow-x: hidden !important;
    padding: 20px !important;
    overflow: hidden !important;
    background: transparent !important;
  }
  
  /* Enhanced mobile background animation */
  #login-page::before {
    display: none;
  }
  
  /* Mobile sparkle effect */
  #login-page::after {
    display: none;
  }
  
  /* Enhance login container for mobile */
  .login-container {
    width: 95% !important;
    max-width: 400px !important;
    min-width: 320px !important;
    margin: 0 auto !important;
    padding: 25px 20px !important;
    background: rgba(255,255,255,0.95) !important;
    border-radius: 12px !important;
    position: relative !important;
    z-index: 100 !important;
    max-height: none !important;
    height: auto !important;
    overflow: hidden !important;
    border: 1px solid rgba(0,0,0,0.1) !important;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1) !important;
  }
  
  .login-container::before {
    display: none !important;
  }

  /* Make form elements more compact on mobile */
  .login-container h1 {
    font-size: 1.3rem !important;
    margin: 10px 0 !important;
    line-height: 1.4 !important;
  }

  .login-container h2 {
    font-size: 1rem !important;
    margin: 12px 0 !important;
    line-height: 1.4 !important;
  }

  .login-container .input-group {
    margin-bottom: 15px !important;
  }

  .login-container .input-group input {
    padding: 14px 16px !important;
    font-size: 1rem !important;
    border-radius: 10px !important;
    min-height: 44px !important;
    width: 100% !important;
    box-sizing: border-box !important;
  }

  .login-container .login-btn-group {
    gap: 10px !important;
    margin-top: 20px !important;
    display: flex !important;
    flex-direction: column !important;
    align-items: stretch !important;
  }

  .login-container .login-btn,
  .login-container .btn-submit {
    padding: 14px 16px !important;
    font-size: 1rem !important;
    border-radius: 8px !important;
    margin: 4px 0 !important;
    min-height: 44px !important;
    width: 100% !important;
    box-sizing: border-box !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    touch-action: manipulation !important;
    -webkit-tap-highlight-color: transparent !important;
    cursor: pointer !important;
    position: relative !important;
    z-index: 100 !important;
  }
  
  /* Enhanced mobile button feedback */
  .login-container .login-btn:active,
  .login-container .btn-submit:active {
    transform: scale(0.98) !important;
    transition: transform 0.1s ease !important;
  }

  .login-container .logo {
    width: 40px !important;
    height: 40px !important;
    font-size: 1.4rem !important;
  }
  
  /* Fix mobile navigation display issues */
  .login-container * {
    max-height: none !important;
    overflow: visible !important;
  }
  
  .login-container .input-group,
  .login-container .login-btn-group,
  .login-container form {
    display: block !important;
    visibility: visible !important;
    height: auto !important;
    max-height: none !important;
  }
  
  /* Ensure mobile viewport is properly utilized */
  .login-container {
    transform: none !important;
    clip: none !important;
    clip-path: none !important;
  }
}

/* Mobile Performance Optimizations - Reduce Heavy Animations */
@media (max-width: 768px) {
  /* Disable heavy gradient animations on mobile */
  [style*="gradientShift"] {
    animation: none !important;
    background: linear-gradient(135deg, #667eea, #764ba2) !important;
    background-size: 100% 100% !important;
  }
  
  /* Reduce Welcome U text animation complexity */
  h2[style*="gradientShift"] {
    animation: none !important;
    background: linear-gradient(45deg, #667eea, #764ba2) !important;
    -webkit-background-clip: text !important;
    background-clip: text !important;
    -webkit-text-fill-color: transparent !important;
  }
  
  /* Simplify transforms for better mobile performance */
  * {
    will-change: auto !important;
  }
  
  /* Disable complex box shadows on mobile */
  .login-container {
    box-shadow: 0 4px 15px rgba(0,0,0,0.1) !important;
  }
  
  /* Optimize transitions for mobile performance */
  * {
    transition-duration: 0.15s !important;
    transition-timing-function: ease-out !important;
  }
  
  /* Reduce complex transitions that cause lag */
  .sidebar {
    transition: transform 0.25s ease-out !important;
  }
  
  .mobile-menu-btn {
    transition: transform 0.15s ease-out !important;
  }
  
  /* Hardware acceleration for smooth animations */
  .sidebar, .mobile-menu-btn, .btn, button {
    transform: translateZ(0) !important;
    backface-visibility: hidden !important;
    perspective: 1000px !important;
    will-change: transform !important;
  }
  
  /* Disable complex hover effects on mobile */
  .btn:hover, button:hover {
    transform: none !important;
    box-shadow: none !important;
  }
  
  /* Disable hardware acceleration for complex elements */
  .login-container,
  .create-account-container {
    transform: translate3d(0,0,0) !important;
    backface-visibility: hidden !important;
  }
}

/* Low-End Device Optimizations */
.low-end-device * {
  animation: none !important;
  transition: none !important;
  transform: none !important;
  filter: none !important;
  -webkit-backdrop-filter: none !important;
  backdrop-filter: none !important;
}

/* Mobile Performance Optimizations - Disable expensive effects */
@media (max-width: 768px) {
  /* iOS Safari smooth scrolling optimization */
  html, body {
    scroll-behavior: smooth !important;
    overscroll-behavior: contain !important;
  }
  
  /* Enable momentum scrolling for iOS */
  .main-content, .sidebar-nav, .content-area {
    overscroll-behavior: contain !important;
  }
  
  /* Improve touch responsiveness on iOS */
  * {
    -webkit-tap-highlight-color: transparent !important;
    -webkit-touch-callout: none !important;
    -webkit-user-select: none !important;
    user-select: none !important;
  }
  
  /* Allow text selection where needed */
  input, textarea, [contenteditable] {
    -webkit-user-select: text !important;
    user-select: text !important;
  }
  
  /* Reduce backdrop-filter usage on mobile */
  .sidebar-header {
    -webkit-backdrop-filter: none !important;
    backdrop-filter: none !important;
    background: rgba(79, 70, 229, 0.95) !important;
  }
  
  /* Remove all backdrop filters on mobile for better performance */
  .mobile-menu-btn {
    -webkit-backdrop-filter: none !important;
    backdrop-filter: none !important;
    background: rgba(79, 70, 229, 0.9) !important;
  }
  
  .sidebar {
    -webkit-backdrop-filter: none !important;
    backdrop-filter: none !important;
    background: linear-gradient(180deg, #667eea 0%, #764ba2 100%) !important;
  }
  
  .sidebar-overlay {
    -webkit-backdrop-filter: none !important;
    backdrop-filter: none !important;
    background: rgba(0, 0, 0, 0.7) !important;
  }
  
  /* Optimize modal backdrop on mobile */
  #modal-bg, #idcard-modal-bg {
    -webkit-backdrop-filter: none !important;
    backdrop-filter: none !important;
    background: rgba(0, 0, 0, 0.8) !important;
  }
  
  /* Disable all backdrop filters on mobile for better performance */
  @media (max-width: 768px) {
    * {
      -webkit-backdrop-filter: none !important;
      backdrop-filter: none !important;
    }
    
    /* Mobile body and html fixes */
    html, body {
      position: static !important;
      height: auto !important;
      min-height: 100vh !important;
      overflow-x: hidden !important;
      overflow-y: auto !important;
      scroll-behavior: smooth !important;
    }
    
    /* Specific mobile panel fixes */
    .login-container {
      -webkit-backdrop-filter: none !important;
      backdrop-filter: none !important;
      background: rgba(255, 255, 255, 0.95) !important;
    }
    
    /* Mobile sidebar performance fixes */
    .sidebar-header,
    .mobile-menu-btn,
    .sidebar,
    .sidebar-overlay {
      -webkit-backdrop-filter: none !important;
      backdrop-filter: none !important;
    }
    
    /* Prevent blur artifacts during animations */
    .sidebar.active,
    .sidebar.open {
      transform: translateX(0) !important;
      will-change: transform !important;
    }
    
    /* Smooth transitions without blur */
    .sidebar {
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
    }
    
    /* Ensure all content containers scroll properly */
    .main-content,
    [id*="template"],
    .content-area,
    .table-container {
      position: relative !important;
      height: auto !important;
      overflow-y: auto !important;
      overflow-x: hidden !important;
      scroll-behavior: smooth !important;
    }
  }
  
  /* Remove heavy gradients on mobile for better performance */
  .mobile-performance-mode .sidebar {
    background: linear-gradient(180deg, #667eea 0%, #764ba2 100%) !important;
  }
}

.low-end-device .login-container,
.low-end-device .create-account-container {
  background: rgba(255,255,255,0.9) !important;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
}

/* Mobile-specific animations */
@keyframes mobileGradientFlow {
  0%, 100% { 
    background-position: 0% 50%;
    transform: scale(1);
  }
  25% { 
    background-position: 100% 50%;
    transform: scale(1.05);
  }
  50% { 
    background-position: 100% 100%;
    transform: scale(1.02);
  }
  75% { 
    background-position: 0% 100%;
    transform: scale(1.08);
  }
}

@keyframes mobileFloatingBubbles {
  0%, 100% { 
    transform: translateY(0px) rotate(0deg) scale(1);
    opacity: 0.6;
  }
  33% { 
    transform: translateY(-40px) rotate(10deg) scale(1.2);
    opacity: 0.8;
  }
  66% { 
    transform: translateY(-20px) rotate(-8deg) scale(0.9);
    opacity: 1;
  }
}

@keyframes mobileSparkle {
  0% { 
    background-position: 0% 0%, 0% 0%, 0% 0%, 0% 0%;
    opacity: 0.8;
  }
  50% {
    opacity: 1;
  }
  100% { 
    background-position: 120% 120%, -80% 100%, 60% -40%, -30% 80%;
    opacity: 0.8;
  }
}
.login-container{
  width:100%;
  max-width:380px;
  background:rgba(255,255,255,0.15);
  padding:25px 20px;
  border-radius:15px;
  position:relative;
  z-index:100;
  border:1px solid rgba(0,0,0,0.1);
  box-shadow:0 4px 15px rgba(0,0,0,0.1);
  transition:all 0.3s ease;
  overflow:hidden;
  -webkit-backdrop-filter:blur(5px);
  backdrop-filter:blur(5px);
}

.login-container::before {
  display:none;
}

.create-account-container:hover {
  transform:translateY(-2px);
  box-shadow:0 15px 35px rgba(0,0,0,0.15);
}

.login-container:hover {
  transform:translateY(-2px);
  box-shadow:0 8px 25px rgba(0,0,0,0.15);
}

.login-container:focus-within {
  transform:translateY(-1px);
  box-shadow:0 6px 20px rgba(0,0,0,0.12);
}
.login-header{display:flex;align-items:center;justify-content:center;gap:15px;margin-bottom:20px;flex-direction:column;}
.login-header .logo{width:60px;height:60px;background:#4D388A;color:#fff;border-radius:15px;display:grid;place-items:center;font-weight:800;font-size:1.5rem;box-shadow:none;}
.login-header h1{font-size:1.8rem;font-weight:800;background:none;-webkit-background-clip:initial;background-clip:initial;-webkit-text-fill-color:initial;margin:0;text-align:center;color:#333;}
#login-form{position:relative;z-index:10;}
#login-form h2{text-align:center;margin-bottom:20px;color:#333;font-size:1.5rem;font-weight:700;}
.input-group{margin-bottom:15px;position:relative;z-index:10;}
.input-group input{
  width:100%;
  padding:12px 15px;
  border-radius:12px;
  border:2px solid rgba(255,255,255,0.2);
  font-size:1rem;
  transition:all 0.3s ease;
  background:rgba(255,255,255,0.05);
  -webkit-backdrop-filter:blur(5px);
  backdrop-filter:blur(5px);
  position:relative;
  z-index:10;
  pointer-events:auto;
  color:#333;
  font-weight:500;
}

.input-group input:focus{
  border:2px solid #4D388A;
  background:rgba(255,255,255,0.9);
  box-shadow:none;
  outline:none;
  transform:none;
}

.input-group input:focus::before {
  display:none;
}

.input-group input::placeholder {
  color:rgba(0,0,0,0.6);
  font-weight:500;
}
.error-message{min-height:20px;color:#e74c3c;text-align:center;margin-bottom:12px;font-weight:600;font-size:0.9rem;}
.login-btn-group{display:flex;flex-direction:column;gap:6px;}
.login-btn{padding:14px 20px;border-radius:12px;border:none;color:#fff;cursor:pointer;font-weight:700;font-size:1rem;transition:all 0.3s ease;position:relative;overflow:hidden;margin:0;}
.login-btn.admin{background:#4D388A;box-shadow:none;}
.login-btn.student{background:#17A2B8;box-shadow:none;}
.login-btn.parent{background:#28A745;box-shadow:none;}
.login-btn.guest{background:#6C757D;box-shadow:none;border:1px solid #5A6268;}
.login-btn:hover{transform:none;box-shadow:none;opacity:0.9;}
.btn-submit{background:#DC3545;box-shadow:none;padding:14px 20px;border-radius:12px;border:none;color:#fff;cursor:pointer;font-weight:700;font-size:1rem;transition:all 0.3s ease;}
.btn-submit:hover{transform:translateY(-3px);box-shadow:0 15px 35px rgba(240,147,251,0.4);}
/* Create Account Form Styles */
input:focus{border-color:#667eea !important;box-shadow:0 0 20px rgba(102,126,234,0.2) !important;outline:none;transform:translateY(-2px);}
label:hover{background:linear-gradient(135deg,#667eea,#764ba2) !important;color:white !important;transform:translateY(-2px);}
button:hover{transform:translateY(-3px) !important;box-shadow:0 15px 35px rgba(0,0,0,0.3) !important;}
/* Sidebar - Optimized */
.sidebar{width:260px;background:linear-gradient(180deg,var(--primary),var(--secondary));color:#e0e0e0;display:flex;flex-direction:column;position:fixed;top:0;left:0;height:100vh;z-index:1000;transform:translateX(0);transition:all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);will-change:transform}
.sidebar-header{display:flex;align-items:center;padding:var(--space-md);background:rgba(255,255,255,0.1);-webkit-backdrop-filter:blur(10px);backdrop-filter:blur(10px);border-bottom:1px solid rgba(255,255,255,0.1)}
.sidebar-toggle{position:absolute;top:18px;right:18px;background:rgba(255,255,255,0.1);color:white;border:none;padding:var(--space-xs);border-radius:var(--radius-sm);cursor:pointer;font-size:14px;transition:var(--transition);display:none;flex-direction:column;align-items:center;justify-content:center;width:24px;height:24px}

@media (max-width: 768px) {
  .sidebar{
    transform:translateX(100%) !important;
    width:280px !important;
    max-width:280px !important;
    left:auto !important;
    right:0 !important;
    z-index:9998 !important;
    position:fixed !important;
    top:0 !important;
    height:100vh !important;
    visibility:hidden !important;
    opacity:0 !important;
    transition:all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) !important;
    background:linear-gradient(180deg,var(--primary),var(--secondary)) !important;
    border-left:1px solid rgba(255,255,255,0.1) !important;
    box-shadow:-5px 0 25px rgba(0,0,0,0.4) !important;
    will-change:transform, opacity, visibility !important;
  }
  .sidebar.open,.sidebar.active{
    transform:translateX(0) !important;
    visibility:visible !important;
    opacity:1 !important;
  }
  /* Ensure proper scrolling on mobile */
  .sidebar-nav {
    height: calc(100vh - 80px) !important;
    overflow-y: auto !important;
    overflow-x: hidden !important;
    padding-bottom: 30px !important;
    overscroll-behavior: contain !important;
  }
  .sidebar-nav ul {
    padding: 8px 0 20px 0 !important;
  }
  /* Hide main content when sidebar is open using body class */
  body.sidebar-open .main-wrapper {
    position: fixed;
    left: -100vw;
    visibility: hidden;
    opacity: 0;
    transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  }
}
@media (min-width: 769px) {
  .sidebar{transform:translateX(0)}
}

.sidebar-toggle:hover{background:rgba(255,255,255,0.2);transform:scale(1.1);}
.sidebar-toggle .line{width:12px;height:2px;background:white;margin:1px 0;transition:all 0.3s ease;}
.sidebar-header .logo{width:44px;height:44px;background:#fff;color:var(--primary);display:grid;place-items:center;border-radius:8px;margin-right:10px;font-weight:700}
.sidebar-nav{flex:1;overflow-y:auto;overflow-x:hidden;padding-bottom:20px}
.sidebar-nav ul{list-style:none;padding:8px 0;margin:0;min-height:min-content}
.sidebar-nav a{display:flex;align-items:center;padding:12px 18px;margin:6px 10px;border-radius:8px;color:#e0e0e0;text-decoration:none;cursor:pointer;transition:all 0.3s ease;}
.sidebar-nav a i{width:22px;text-align:center;margin-right:12px;flex-shrink:0;}
.sidebar-nav a span{transition:opacity 0.3s ease;}
.sidebar-nav a:hover{background:rgba(255,255,255,.06);transform:translateX(5px);}
.sidebar-nav a.active{background:#fff;color:var(--primary);font-weight:600}
.sidebar-nav a.disabled{opacity:.6;cursor:not-allowed}

/* Mobile Menu Button - Always positioned on right side */
.mobile-menu-btn{
  display:none;
  position:fixed;
  top:12px;
  right:12px;
  left:auto;
  z-index:1001;
  background:linear-gradient(135deg,var(--gradient-1),var(--gradient-2));
  color:white;
  border:none;
  padding:6px;
  border-radius:8px;
  cursor:pointer;
  width:32px;
  height:32px;
  box-shadow:0 2px 10px rgba(102,126,234,0.3);
  transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  flex-direction:column;
  justify-content:center;
  align-items:center;
  gap:2px;
}

/* Show mobile menu button on mobile screens ONLY when logged in */
@media (max-width: 768px) {
  body.showing-app .mobile-menu-btn {
    display:flex !important;
    right:12px !important;
    left:auto !important;
  }
  
  /* Hide mobile menu button when login page is showing */
  body.showing-login .mobile-menu-btn,
  body:not(.showing-app) .mobile-menu-btn {
    display:none !important;
  }
}

/* Force right positioning in all states */
.mobile-menu-btn {
  right:12px !important;
  left:auto !important;
}

.mobile-menu-btn:hover{
  transform:scale(1.05);
  box-shadow:0 4px 15px rgba(102,126,234,0.4);
  background:linear-gradient(135deg,var(--gradient-2),var(--gradient-3));
}

.mobile-menu-btn:active{
  transform:scale(0.95);
}

.hamburger-line{
  width:14px;
  height:2px;
  background:white;
  border-radius:2px;
  transition:all 0.3s ease;
}

.mobile-menu-btn.active .hamburger-line:nth-child(1){
  transform:rotate(45deg) translate(5px, 5px);
}
.mobile-menu-btn.active .hamburger-line:nth-child(2){
  opacity:0;
}
.mobile-menu-btn.active .hamburger-line:nth-child(3){
  transform:rotate(-45deg) translate(7px, -6px);
}

/* Sidebar Close Button */
.sidebar-close{
  display:none;
  position:absolute;
  top:15px;
  left:15px;
  background:rgba(255,255,255,0.2);
  color:white;
  border:none;
  padding:8px;
  border-radius:8px;
  cursor:pointer;
  width:32px;
  height:32px;
  transition:all 0.3s ease;
  justify-content:center;
  align-items:center;
}

/* Show sidebar close button on mobile screens */
@media (max-width: 768px) {
  .sidebar-close{
    display:flex !important;
    top:15px;
    right:15px;
    left:auto;
  }
}

.sidebar-close:hover{
  background:linear-gradient(135deg,rgba(255,255,255,0.25),rgba(255,255,255,0.15));
  transform:scale(1.1);
  box-shadow:0 4px 12px rgba(0,0,0,0.2);
}

.close-x{
  position:absolute;
  width:16px;
  height:2px;
  background:white;
  border-radius:2px;
}
.close-x:first-child{
  transform:rotate(45deg);
}
.close-x:last-child{
  transform:rotate(-45deg);
}

/* Sidebar Header Styling */
.sidebar-header{
  display:flex;
  align-items:center;
  padding:15px;
  position:relative;
  background:linear-gradient(135deg,rgba(255,255,255,0.1),rgba(255,255,255,0.05));
  -webkit-backdrop-filter:blur(10px);
  backdrop-filter:blur(10px);
  border-bottom:1px solid rgba(255,255,255,0.1);
}

.sidebar-header .logo{
  width:36px;
  height:36px;
  background:linear-gradient(135deg,#fff,#f0f8ff);
  color:var(--primary);
  display:grid;
  place-items:center;
  border-radius:10px;
  margin-right:10px;
  font-weight:700;
  font-size:1.2rem;
  box-shadow:0 4px 12px rgba(255,255,255,0.2);
}

.hostel-title{
  font-weight:700;
  font-size:0.95rem;
  background:linear-gradient(135deg,#fff,#e6f3ff);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  background-clip:text;
  text-shadow:0 1px 2px rgba(0,0,0,0.1);
  line-height:1.2;
}

/* Overlay */
.sidebar-overlay{
  display:none;
  position:fixed;
  top:0;
  left:0;
  width:100%;
  height:100%;
  background:rgba(0,0,0,0.5);
  z-index:999;
  opacity:0;
  transition:opacity 0.3s ease;
  visibility:hidden;
}
.sidebar-overlay.active{
  opacity:1;
  visibility:visible;
}

/* Show overlay on mobile screens only */
@media (max-width: 768px) {
  .sidebar-overlay{
    display:block !important;
    width: 100vw !important;
    height: 100vh !important;
    left: 0 !important;
    top: 0 !important;
    z-index: 9997 !important;
    background: rgba(0,0,0,0.6) !important;
    position: fixed !important;
  }
  .sidebar-overlay.active {
    display: block !important;
    opacity: 1 !important;
    visibility: visible !important;
  }
}

/* Main */
.main-wrapper{
  flex:1;
  display:flex;
  flex-direction:column;
  margin-left:260px;
  transition:margin-left 0.3s ease;
}

/* Mobile main wrapper */
@media (max-width: 768px) {
  .main-wrapper{
    margin-left:0 !important;
    width: 100% !important;
    max-width: 100% !important;
    overflow-x: hidden !important;
    position: relative !important;
    z-index: 1 !important;
    box-sizing: border-box !important;
    height: auto !important;
    min-height: 100vh !important;
  }
  
  #main-content {
    padding: 12px !important;
    margin: 0 !important;
    width: 100% !important;
    max-width: 100% !important;
    box-sizing: border-box !important;
    overflow-x: hidden !important;
    overflow-y: auto !important;
    height: auto !important;
    min-height: calc(100vh - 80px) !important;
  }
  
  .top-bar {
    width: 100% !important;
    box-sizing: border-box !important;
    padding: 8px 12px !important;
  }
  
  /* Ensure sidebar is completely hidden by default on mobile */
  .sidebar:not(.open):not(.active) {
    transform: translateX(-100%) !important;
    visibility: hidden !important;
    opacity: 0 !important;
    pointer-events: none !important;
  }
  
  body.sidebar-open .main-wrapper {
    margin-left: 0 !important;
    width: 100vw !important;
    transform: translateX(100vw) !important;
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    opacity: 0 !important;
    visibility: hidden !important;
    pointer-events: none !important;
    z-index: -1 !important;
  }
  body.sidebar-open .top-bar {
    transform: translateX(100vw) !important;
    opacity: 0 !important;
    visibility: hidden !important;
  }
  
  /* Mobile responsive tables */
  .table-container, table {
    width: 100% !important;
    max-width: 100% !important;
    overflow-x: auto !important;
    box-sizing: border-box !important;
  }
  
  /* Mobile responsive forms */
  .form-container, .form-group {
    width: 100% !important;
    box-sizing: border-box !important;
  }
  
  .form-group input, .form-group select, .form-group textarea {
    width: 100% !important;
    box-sizing: border-box !important;
    font-size: 16px !important; /* Prevents zoom on iOS */
    padding: 12px 8px !important;
  }
  
  /* Mobile responsive buttons */
  .btn, button {
    width: 100% !important;
    margin: 4px 0 !important;
    padding: 12px 8px !important;
    font-size: 14px !important;
    box-sizing: border-box !important;
  }
  
  .btn-group {
    display: flex !important;
    flex-direction: column !important;
    gap: 8px !important;
    width: 100% !important;
  }
  
  /* Mobile responsive cards and panels */
  .card, .panel {
    margin: 8px 0 !important;
    padding: 12px 8px !important;
    border-radius: 8px !important;
    width: 100% !important;
    box-sizing: border-box !important;
  }
  
  /* Mobile responsive modals */
  .modal-content {
    width: 95vw !important;
    max-width: 95vw !important;
    margin: 10px auto !important;
    padding: 15px !important;
    max-height: 90vh !important;
    overflow-y: auto !important;
    box-sizing: border-box !important;
  }
  
  /* Mobile responsive navigation */
  .nav-tabs, .nav-pills {
    flex-direction: column !important;
    width: 100% !important;
  }
  
  .nav-tabs li, .nav-pills li {
    width: 100% !important;
    margin: 2px 0 !important;
  }
  
  /* Mobile responsive flex containers */
  .flex-container, .d-flex {
    flex-direction: column !important;
    align-items: stretch !important;
    gap: 8px !important;
  }
  
  /* Mobile responsive grid containers */
  .grid-container {
    grid-template-columns: 1fr !important;
    gap: 8px !important;
  }
  
  /* Mobile responsive text */
  h1 { font-size: 1.8rem !important; }
  h2 { font-size: 1.5rem !important; }
  h3 { font-size: 1.3rem !important; }
  h4 { font-size: 1.1rem !important; }
  h5 { font-size: 1rem !important; }
  h6 { font-size: 0.9rem !important; }
  
  /* Mobile responsive images */
  img {
    max-width: 100% !important;
    height: auto !important;
  }
  
  /* Mobile responsive charts and canvas */
  canvas {
    max-width: 100% !important;
    height: auto !important;
    max-height: 250px !important;
  }
}

/* Top Bar and other styles */
.top-bar{display:flex;justify-content:space-between;align-items:center;padding:12px 20px;background:linear-gradient(135deg,var(--secondary) 0%,var(--primary) 100%);color:#fff;position:relative;}
#page-title{font-size:1.15rem;font-weight:600;margin-left:0;transition:margin-left 0.3s ease;}
.right-content{display:flex;gap:12px;align-items:center;flex-wrap:wrap;}

/* Mobile Header Collapse Feature */
.header-collapse-btn {
  display: none;
  background: transparent;
  border: none;
  color: white;
  font-size: 0.8rem;
  cursor: pointer;
  padding: 2px;
  border-radius: 0;
  transition: none;
  box-shadow: none;
  outline: none;
}

.header-collapse-btn:hover {
  background: transparent;
  transform: none;
}

.header-collapsed .right-content {
  display: none;
}

.header-collapsed .top-bar {
  padding: 6px 15px;
}

.header-collapsed #page-title {
  font-size: 0.9rem;
}

/* Smooth transitions for collapse/expand */
.top-bar {
  transition: padding 0.3s ease;
}

.right-content {
  transition: opacity 0.3s ease, height 0.3s ease;
  overflow: hidden;
}

.header-collapsed .right-content {
  opacity: 0;
  height: 0;
  display: block;
}

/* Show collapse button only on mobile */
@media (max-width: 768px) {
  .header-collapse-btn {
    display: block;
  }
  
  .top-bar {
    padding: 12px 60px 12px 20px;
    min-height: 60px;
    flex-direction: column;
    align-items: stretch;
    gap: 10px;
  }
  
  /* Top row with title and collapse button */
  .top-bar > .top-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
  }
  
  /* Right content area - full width on mobile */
  .top-bar .right-content {
    width: 100%;
    justify-content: center;
    flex-wrap: wrap;
    gap: 10px;
    transition: all 0.3s ease;
  }
  
  /* Collapsed state on mobile */
  .header-collapsed .top-bar {
    min-height: 50px;
    padding: 8px 60px 8px 20px;
  }
  
  .header-collapsed .right-content {
    display: none;
  }
  
  /* Make collapse button smaller and cleaner on mobile */
  .header-collapse-btn {
    background: transparent !important;
    border: none !important;
    padding: 3px !important;
    border-radius: 0 !important;
    color: white !important;
    font-size: 0.75rem !important;
    font-weight: normal;
    transition: none;
    box-shadow: none !important;
    outline: none !important;
  }
  
  .header-collapse-btn:hover {
    background: transparent !important;
    transform: none;
  }
  
  .header-collapsed .top-bar {
    min-height: 36px;
  }
  
  #page-title {
    font-size: 0.95rem;
  }
  
  .header-collapsed #page-title {
    font-size: 0.85rem;
  }
  
  /* Make dashboard title smaller on mobile */
  #page-title {
    font-size: 0.8rem !important;
    line-height: 1.2;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  .right-content {
    gap: 8px;
    flex-wrap: wrap;
    overflow: visible;
    position: relative;
    background: rgba(255,255,255,0.1);
    border-radius: 8px;
    padding: 8px;
    -webkit-backdrop-filter: blur(10px);
    backdrop-filter: blur(10px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
  }
  
  .right-content::-webkit-scrollbar {
    display: none;
  }
  
  /* Make header buttons larger and more touch-friendly on mobile */
  .right-content button,
  .right-content select,
  .right-content label {
    padding: 10px 14px !important;
    font-size: 0.9rem !important;
    border-radius: 8px !important;
    white-space: nowrap;
    min-width: 44px !important;
    min-height: 44px !important;
    background: rgba(255,255,255,0.9) !important;
    color: #333 !important;
    border: 1px solid rgba(0,0,0,0.2) !important;
    font-weight: 500;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .right-content button:hover,
  .right-content select:hover,
  .right-content label:hover {
    background: rgba(255,255,255,1) !important;
    transform: none;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  }
}
.profile-icon{width:36px;height:36px;border-radius:50%;background:var(--green);display:grid;place-items:center;border:2px solid #fff;font-weight:700}

/* Notification System Styles */
#admin-notifications-btn {
  position: relative;
  transition: all 0.3s ease;
}
#admin-notifications-btn:hover {
  background: rgba(255,255,255,0.3) !important;
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}
#notification-badge {
  position: absolute;
  top: -8px;
  right: -8px;
  background: #ff4444;
  color: white;
  border-radius: 50%;
  min-width: 20px;
  height: 20px;
  display: none;
  font-size: 0.7rem;
  font-weight: bold;
  line-height: 20px;
  text-align: center;
  animation: none;
}
/* Notification pulse animation removed for cleaner look */
.notification-item {
  border-radius: 10px;
  transition: all 0.3s ease;
  border-left: 4px solid transparent;
}
.notification-item.unread {
  border-left-color: #ff9800;
  background: linear-gradient(135deg, #fff3e0, #ffe0b2);
}
.notification-item.read {
  background: #f9f9f9;
  border-left-color: #e0e0e0;
}
.notification-item:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}
.whatsapp-btn {
  background: linear-gradient(135deg, #25d366, #128c7e);
  transition: all 0.3s ease;
}
.whatsapp-btn:hover {
  background: linear-gradient(135deg, #128c7e, #075e54);
  transform: scale(1.05);
}
.approve-btn {
  background: linear-gradient(135deg, #4caf50, #388e3c);
  transition: all 0.3s ease;
}
.approve-btn:hover {
  background: linear-gradient(135deg, #388e3c, #2e7d32);
  transform: scale(1.05);
}
.reject-btn {
  background: linear-gradient(135deg, #f44336, #d32f2f);
  transition: all 0.3s ease;
}
.reject-btn:hover {
  background: linear-gradient(135deg, #d32f2f, #c62828);
  transform: scale(1.05);
}
.content-area{padding:22px;overflow:auto}
.table-container,.form-container{background:#fff;padding:16px;border-radius:8px;margin-bottom:18px;box-shadow:0 1px 2px rgba(0,0,0,0.03)}
.data-table{width:100%;border-collapse:collapse}
.data-table th,.data-table td{padding:10px;border:1px solid #e9e9e9;text-align:left;vertical-align:middle;font-size:.95rem}
.data-table th{background:#f8f9fa}
.generic-form{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
.form-group{display:flex;flex-direction:column}
.form-group label{margin-bottom:6px;font-weight:600;color:#444}
.form-group input,.form-group select,.form-group textarea{padding:9px;border:1px solid #ccc;border-radius:6px}
.form-group.full-width{grid-column:1/-1}
.btn-submit{padding:10px;border:none;border-radius:6px;background:linear-gradient(135deg,var(--gradient-3),var(--gradient-4));color:#fff;font-weight:700;cursor:pointer;transition:all 0.3s ease;box-shadow:0 4px 15px rgba(0,0,0,0.2)}
.btn-submit:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(0,0,0,0.3);animation:themeGlow 2s ease infinite}
.btn-view{padding:6px 10px;border-radius:6px;border:none;background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;cursor:pointer;transition:all 0.3s ease;box-shadow:0 4px 15px rgba(0,0,0,0.2)}
.btn-view:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(0,0,0,0.3)}
.btn-edit{padding:6px 10px;border-radius:6px;border:none;background:linear-gradient(135deg,#ffc107,#fd7e14);color:#fff;cursor:pointer;transition:all 0.3s ease;box-shadow:0 4px 15px rgba(0,0,0,0.2);margin-right:5px}
.btn-edit:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(0,0,0,0.3)}
.btn-delete{padding:6px 10px;border-radius:6px;border:none;background:linear-gradient(135deg,#dc3545,#c82333);color:#fff;cursor:pointer;transition:all 0.3s ease;box-shadow:0 4px 15px rgba(0,0,0,0.2)}
.btn-delete:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(0,0,0,0.3)}
.modal{display:flex;align-items:center;justify-content:center}
.search-input{margin-bottom:12px;padding:6px 10px;border:1px solid #ccc;border-radius:6px;width:100%;max-width:320px}
/* status */
.status-tag{display:inline-block;padding:6px 10px;border-radius:14px;font-weight:600;font-size:.85rem}
.status-paid{background:var(--green);color:#fff}
.status-due{background:var(--yellow);color:#000}
.status-overdue{background:var(--red);color:#fff}
/* Dynamic Buttons */
.dynamic-buttons{display:flex;flex-wrap:wrap;gap:12px;margin:12px 0}
.dynamic-buttons button{flex:1 1 180px;padding:12px 18px;border-radius:10px;border:none;color:#fff;font-weight:600;font-size:.95rem;cursor:pointer;transition:all .3s ease;box-shadow:0 4px 8px rgba(0,0,0,0.15);position:relative;overflow:hidden}
.dynamic-buttons button:hover{transform:translateY(-3px) scale(1.02);box-shadow:0 8px 20px rgba(0,0,0,0.25);animation:pulseGlow 2s ease infinite}
.dynamic-buttons button:active{transform:translateY(-1px) scale(0.98)}
.btn-rooms{background:linear-gradient(135deg,var(--gradient-4),var(--gradient-1))}
.btn-fee{background:linear-gradient(135deg,var(--gradient-5),var(--gradient-2))}
.btn-visitors{background:linear-gradient(135deg,var(--gradient-6),var(--gradient-3))}
.btn-materials{background:linear-gradient(135deg,var(--gradient-7),var(--gradient-4))}
.btn-help{background:linear-gradient(135deg,var(--gradient-8),var(--gradient-5))}
.btn-complaints{background:linear-gradient(135deg,var(--gradient-9),var(--gradient-6))}
.btn-feedback{background:linear-gradient(135deg,var(--gradient-10),var(--gradient-7))}
.btn-social{background:linear-gradient(135deg,var(--gradient-11),var(--gradient-8))}
.dropdown-content{display:none;position:absolute;background:#fff;color:#333;min-width:180px;box-shadow:0 4px 8px rgba(0,0,0,.2);border-radius:8px;padding:6px 0;z-index:100}
.dropdown-content div{padding:8px 12px;cursor:pointer}
.dropdown-content div:hover{background:#f1f1f1}
.dropdown-wrapper{position:relative;display:inline-block}
/* Dashboard Cards */
.dashboard-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;}
.dashboard-grid .card {
  background: linear-gradient(135deg, var(--gradient-1) 0%, var(--gradient-2) 40%, var(--gradient-3) 100%);
  color: #fff;
  border-radius: 20px;
  box-shadow: 0 15px 35px rgba(0,0,0,0.1);
  padding: 20px 16px;
  transition: all .4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  cursor: pointer;
  font-family: 'Poppins', sans-serif;
  position: relative;
  overflow: hidden;
  -webkit-backdrop-filter: blur(15px);
  backdrop-filter: blur(15px);
  border: 1px solid rgba(255,255,255,0.2);
  text-shadow: 0 1px 3px rgba(0,0,0,0.3);
  font-weight: 600;
}
.dashboard-grid .card::before {
  content: '';
  position: absolute;
  top: -50%;
  left: -50%;
  width: 200%;
  height: 200%;
  background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, transparent 70%);
  opacity: 0;
  transition: all 0.6s ease;
  transform: scale(0);
}
.dashboard-grid .card::after {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
  transition: left 0.8s ease;
}
.dashboard-grid .card:nth-child(1) { 
  background: linear-gradient(135deg,var(--gradient-1),var(--gradient-2));
  box-shadow: 0 15px 35px rgba(102,126,234,0.4);
}
.dashboard-grid .card:nth-child(2) { 
  background: linear-gradient(135deg,var(--gradient-3),var(--gradient-4));
  box-shadow: 0 15px 35px rgba(255,107,107,0.4);
}
.dashboard-grid .card:nth-child(3) { 
  background: linear-gradient(135deg,var(--gradient-5),var(--gradient-6));
  box-shadow: 0 15px 35px rgba(79,172,254,0.4);
}
.dashboard-grid .card:nth-child(4) { 
  background: linear-gradient(135deg,var(--gradient-7),var(--gradient-8));
  box-shadow: 0 15px 35px rgba(150,206,180,0.4);
}
.dashboard-grid .card:nth-child(5) { 
  background: linear-gradient(135deg,var(--gradient-9),var(--gradient-10));
  box-shadow: 0 15px 35px rgba(69,183,209,0.4);
}
.dashboard-grid .card:nth-child(6) { 
  background: linear-gradient(135deg,var(--gradient-11),var(--gradient-12));
  box-shadow: 0 15px 35px rgba(254,202,87,0.4);
}
.dashboard-grid .card:nth-child(7) { 
  background: linear-gradient(135deg,var(--gradient-2),var(--gradient-3));
  box-shadow: 0 15px 35px rgba(118,75,162,0.4);
}
.dashboard-grid .card:nth-child(8) { 
  background: linear-gradient(135deg,var(--gradient-4),var(--gradient-5));
  box-shadow: 0 15px 35px rgba(255,107,107,0.4);
}
.dashboard-grid .card:nth-child(9) { 
  background: linear-gradient(135deg,var(--gradient-6),var(--gradient-7));
  box-shadow: 0 15px 35px rgba(79,172,254,0.4);
}
.dashboard-grid .card:nth-child(10) { 
  background: linear-gradient(135deg,var(--gradient-8),var(--gradient-9));
  box-shadow: 0 15px 35px rgba(150,206,180,0.4);
}
.dashboard-grid .card:nth-child(11) { 
  background: linear-gradient(135deg,var(--gradient-10),var(--gradient-11));
  box-shadow: 0 15px 35px rgba(69,183,209,0.4);
}
.dashboard-grid .card:nth-child(12) { 
  background: linear-gradient(135deg,var(--gradient-12),var(--gradient-1));
  box-shadow: 0 15px 35px rgba(254,202,87,0.4);
}
.dashboard-grid .card:nth-child(8) { 
  background: linear-gradient(135deg,var(--gradient-4),var(--gradient-5));
  box-shadow: 0 15px 35px rgba(255,107,107,0.4);
}
.dashboard-grid .card:nth-child(9) { 
  background: linear-gradient(135deg,var(--gradient-6),var(--gradient-7));
  box-shadow: 0 15px 35px rgba(79,172,254,0.4);
}
.dashboard-grid .card:hover {
  transform: translateY(-12px) scale(1.08) rotateX(3deg);
  box-shadow: 0 25px 50px rgba(0,0,0,0.2);
  opacity: .98;
  animation: dashboardCardGlow 2s ease infinite;
  filter: brightness(1.1) saturate(1.2);
}
.dashboard-grid .card:hover::before {
  opacity: 1;
  transform: scale(1);
}
.dashboard-grid .card:hover::after {
  left: 100%;
}
.dashboard-grid .card:active {
  transform: translateY(-8px) scale(1.05);
  transition: all 0.1s ease;
}
.dashboard-grid .card .label {
  font-size: 0.9rem;
  font-weight: 600;
  margin-bottom: 4px;
  color: #fff;
  text-shadow: 0 1px 2px rgba(0,0,0,0.1);
}
.dashboard-grid .card .value {
  font-size: 1.6rem;
  font-weight: 700;
  color: #fff;
  text-shadow: 0 1px 3px rgba(0,0,0,0.2);
}
.dashboard-grid .card .muted {
  font-size: .8rem;
  font-weight: 400;
  opacity: .9;
  color: rgba(255,255,255,0.9);
  margin-top: 2px;
}
/* Modal */
#modal-bg{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:9999;justify-content:center;align-items:center}

/* Standardized Z-Index System for Mobile */
/* Sidebar: 1000, Sidebar Overlay: 999, Modals: 9999, Mobile Menu: 9998, WhatsApp: 10000 */
@media (max-width: 768px) {
  .sidebar {
    z-index: 1000 !important;
  }
  .sidebar-overlay {
    z-index: 999 !important;
  }
  #modal-bg, #idcard-modal-bg, [id*="modal"] {
    z-index: 9999 !important;
  }
  .mobile-menu-btn {
    z-index: 9998 !important;
  }
  /* WhatsApp float button should be highest */
  .whatsapp-float {
    z-index: 10000 !important;
  }
}
#modal-content{background:#fff;padding:20px;border-radius:10px;min-width:300px;max-width:95vw;max-height:95vh;overflow-y:auto;box-shadow:0 4px 12px rgba(0,0,0,0.25)}
#modal-close{cursor:pointer;float:right;font-weight:700;color:#333}
/* AI Chat Card Styles */
.ai-chat-card {
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}
.ai-chat-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
  transition: left 0.5s ease;
}
.ai-chat-card:hover::before {
  left: 100%;
}
.ai-chat-card:hover {
  transform: translateY(-8px) scale(1.05);
  box-shadow: 0 20px 40px rgba(0,0,0,0.3) !important;
  animation: pulseGlow 2s ease infinite;
}

/* Add/replace below for elegant Students Portal buttons */
.students-portal-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit,minmax(220px,1fr));
  gap: 18px;
  margin: 18px 0;
}
.students-portal-card {
  background: var(--card-bg);
  border-radius: 20px;
  box-shadow: 0 15px 35px rgba(0,0,0,0.1);
  padding: 28px 18px;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 12px;
  cursor: pointer;
  transition: all .4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  font-weight: 600;
  font-size: 1.08rem;
  position: relative;
  min-height: 140px;
  overflow: hidden;
  border: 1px solid rgba(255,255,255,0.2);
}
.students-portal-card::before {
  content: '';
  position: absolute;
  top: -50%;
  left: -50%;
  width: 200%;
  height: 200%;
  background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, transparent 70%);
  opacity: 0;
  transition: all 0.6s ease;
  transform: scale(0);
}
.students-portal-card::after {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
  transition: left 0.8s ease;
}
.students-portal-card:hover::before {
  opacity: 1;
  transform: scale(1);
}
.students-portal-card:hover::after {
  left: 100%;
}
.students-portal-card i {
  font-size: 2.2rem;
  margin-bottom: 6px;
  opacity: .85;
  transition: all 0.4s ease;
  filter: drop-shadow(0 0 10px rgba(255,255,255,0.3));
}
.students-portal-card.rooms {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
  color: #fff;
  box-shadow: 0 15px 35px rgba(102,126,234,0.4);
}
.students-portal-card.fee {
  background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); 
  color: #fff;
  box-shadow: 0 15px 35px rgba(240,147,251,0.4);
}
.students-portal-card.visitors {
  background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); 
  color: #fff;
  box-shadow: 0 15px 35px rgba(79,172,254,0.4);
}
.students-portal-card.materials {
  background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); 
  color: #fff;
  box-shadow: 0 15px 35px rgba(67,233,123,0.4);
}
.students-portal-card.help {
  background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); 
  color: #fff;
  box-shadow: 0 15px 35px rgba(250,112,154,0.4);
}
.students-portal-card.complaints {
  background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); 
  color: #333;
  box-shadow: 0 15px 35px rgba(168,237,234,0.4);
}
.students-portal-card.feedback {
  background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); 
  color: #333;
  box-shadow: 0 15px 35px rgba(255,154,158,0.4);
}
.students-portal-card.social {
  background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%); 
  color: #fff;
  box-shadow: 0 15px 35px rgba(161,140,209,0.4);
}
.students-portal-card.idcard {
  background: linear-gradient(135deg, #fad0c4 0%, #ffd1ff 100%); 
  color: #333;
  box-shadow: 0 15px 35px rgba(250,208,196,0.4);
}
.students-portal-card.mess {
  background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); 
  color: #333;
  box-shadow: 0 15px 35px rgba(168,237,234,0.4);
}
.students-portal-card.rules {
  background: linear-gradient(135deg, #d299c2 0%, #fef9d7 100%); 
  color: #333;
  box-shadow: 0 15px 35px rgba(210,153,194,0.4);
}
.students-portal-card:hover {
  transform: translateY(-15px) scale(1.08) rotateX(5deg);
  box-shadow: 0 25px 50px rgba(0,0,0,0.2);
  opacity: .98;
  animation: vibrantPulse 1.5s ease infinite;
  filter: brightness(1.1) saturate(1.2);
}
.students-portal-card:hover i {
  transform: scale(1.2) rotateY(10deg);
  text-shadow: 0 0 20px rgba(255,255,255,0.8);
  animation: iconBounce 0.6s ease;
}
.students-portal-card:active {
  transform: translateY(-10px) scale(1.05);
  transition: all 0.1s ease;
}

/* Enhanced Dashboard Cards Active States */
.dashboard-grid .card:nth-child(1):active { 
  background: linear-gradient(135deg,#7c8cea 0%,#8659c2 50%,#f5a3fb 100%);
}
.dashboard-grid .card:nth-child(2):active { 
  background: linear-gradient(135deg,#6fbcfe 0%,#20f2fe 50%,#63e99b 100%);
}
.dashboard-grid .card:nth-child(3):active { 
  background: linear-gradient(135deg,#fc90ba 0%,#fee960 50%,#ff8b8b 100%);
}
.dashboard-grid .card:nth-child(4):active { 
  background: linear-gradient(135deg,#ffbabe 0%,#fedff0 50%,#fedff0 100%);
}
.dashboard-grid .card:nth-child(5):active { 
  background: linear-gradient(135deg,#c8fdfa 0%,#fee6f3 50%,#e2b9d2 100%);
}

/* Floating animation for special emphasis */
@keyframes floatEmphasis {
  0%, 100% { transform: translateY(-15px) scale(1.08) rotateX(5deg); }
  50% { transform: translateY(-20px) scale(1.12) rotateX(8deg); }
}

.students-portal-card.special-emphasis {
  animation: floatEmphasis 3s ease-in-out infinite;
}
.students-portal-card .label {
  font-size: 1.08rem;
  font-weight: 700;
  margin-bottom: 2px;
}
.students-portal-card .desc {
  font-size: .95rem;
  font-weight: 400;
  opacity: .85;
}
.admin-only-col {
    display: none;
}
.social-link-card {
  background: linear-gradient(135deg, var(--gradient-1), var(--gradient-2));
  color: white;
  padding: 30px 20px;
  border-radius: 15px;
  text-align: center;
  cursor: pointer;
  transition: transform 0.3s, box-shadow 0.3s;
  box-shadow: 0 8px 25px rgba(109, 87, 168, 0.3);
}
.social-link-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 15px 35px rgba(109, 87, 168, 0.4);
}
.social-link-card i {
  font-size: 3rem;
  margin-bottom: 15px;
  display: block;
}
.social-link-card h4 {
  margin: 10px 0;
  font-size: 1.3rem;
}
.social-link-card p {
  margin: 0;
  opacity: 0.9;
  font-size: 0.95rem;
}
.menu-item {
  cursor: pointer;
  padding: 5px;
  border-radius: 4px;
  transition: background 0.2s;
}
.menu-item:hover {
  background: rgba(109, 87, 168, 0.1);
}
.menu-item.editing {
  background: #fff3cd;
  border: 1px solid #ffeaa7;
}
.menu-edit-input {
  width: 100%;
  padding: 5px;
  border: 1px solid #ddd;
  border-radius: 4px;
  font-size: 0.9rem;
}

/* Mobile Responsive Styles */
@media (max-width: 768px) {
  .sidebar{width:280px;}
  .main-wrapper.sidebar-open{margin-left:0;}
  .mobile-menu-btn{display:block !important;right:15px;left:auto;}
  .sidebar-close{display:block !important;}
  .sidebar-overlay{display:block;}
  
  .top-bar{padding:12px 60px 12px 20px;}
  #page-title{font-size:1.1rem;font-weight:600;}
  .right-content{gap:8px;}
  .right-content select{font-size:0.9rem;padding:6px;}
  .profile-icon{width:36px;height:36px;font-size:1rem;}
  
  /* Ensure mobile menu button is always on right */
  .mobile-menu-btn{right:15px !important;left:auto !important;}
  
  /* Fix main content area for mobile */
  .content-area{padding:16px;margin-top:0;min-height:calc(100vh - 120px);}
  .table-container,.form-container{padding:12px;margin-bottom:12px;}
  
  /* Improve mobile table display */
  .data-table{font-size:0.9rem;overflow-x:auto;display:block;white-space:nowrap;}
  .data-table th,.data-table td{padding:10px 6px;min-width:90px;}
  
  /* Mobile form improvements */
  .generic-form{grid-template-columns:1fr;gap:12px;}
  .form-group input,.form-group select,.form-group textarea{padding:12px;font-size:1rem;min-height:44px;}
  
  /* Mobile tables - horizontal scroll */
  .table-container{
    width:100%;
    overflow-x:auto;
    overflow-y: visible;
    border-radius:8px;
    box-shadow:0 2px 8px rgba(0,0,0,0.1);
    scroll-behavior: smooth;
    position: relative;
  }
  
  /* Improve table wrapper scrolling */
  .table-wrapper {
    overflow-x: auto;
    overflow-y: visible;
    width: 100%;
    position: relative;
  }
  
  table{
    min-width:700px;
    width:100%;
    border-collapse:collapse;
    background:white;
    position: relative;
  }
  
  th,td{
    padding:10px 8px;
    text-align:left;
    border-bottom:1px solid #ddd;
    font-size:0.9rem;
    word-wrap:break-word;
    max-width:150px;
  }
  
  th{
    background:#4D388A;
    color:white;
    font-weight:600;
    position:sticky;
    top:0;
    z-index:10;
  }
  
  /* Mobile-specific table improvements */
  .student-row,.expense-row,.visitor-row{
    cursor:pointer;
    transition:background-color 0.2s ease;
  }
  
  .student-row:hover,.expense-row:hover,.visitor-row:hover{
    background-color:rgba(77,56,138,0.1);
  }
  
  /* Action buttons in tables */
  .action-btn{
    padding:4px 8px;
    margin:1px;
    border:none;
    border-radius:4px;
    cursor:pointer;
    font-size:0.75rem;
    font-weight:500;
    transition:all 0.2s ease;
    min-width:50px;
  }
  
  .edit-btn{background:#28a745;color:white;}
  .delete-btn{background:#dc3545;color:white;}
  .view-btn{background:#17a2b8;color:white;}
  
  .action-btn:hover{
    transform:translateY(-1px);
    box-shadow:0 2px 4px rgba(0,0,0,0.2);
  }
  
  .action-btn:active{
    transform:translateY(0);
  }
  
  /* Ensure mobile elements are properly positioned */
  .app-container{overflow-x:hidden;width:100vw;flex-direction:column;}
  .main-wrapper{width:100%;max-width:100vw;overflow-x:hidden;}
  
  /* Fix any overflow issues */
  html,body{overflow-x:hidden;width:100%;}
  *{max-width:100vw;}
  
  /* Improve mobile viewport handling */
  .main-content{
    width:100%;
    min-width:0;
    padding:10px 8px;
    margin:0;
    box-sizing:border-box;
    overflow-x:hidden;
    overflow-y: auto;
    height: auto;
    min-height: calc(100vh - 70px);
  }
  
  /* Mobile-first approach */
  .container,.content-wrapper,.page-content{
    width:100%;
    max-width:100vw;
    padding:0 8px;
    box-sizing:border-box;
    overflow-x:hidden;
  }
  
  /* Force mobile menu to be visible */
  body.mobile-device .mobile-menu-btn{
    display:flex !important;
    position:fixed !important;
    top:12px !important;
    right:12px !important;
    left:auto !important;
    z-index:1001 !important;
  }
  
  /* Ensure sidebar works on mobile */
  body.mobile-device .sidebar{
    position:fixed !important;
    top:0 !important;
    right:0 !important;
    left:auto !important;
    height:100vh !important;
    width:280px !important;
    z-index:9998 !important;
    transform:translateX(100%) !important;
    transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
    visibility:hidden !important;
    opacity:0 !important;
  }
  
  /* When sidebar is open on mobile */
  body.mobile-device .sidebar.open,
  body.mobile-device .sidebar.active{
    transform:translateX(0) !important;
    visibility:visible !important;
    opacity:1 !important;
  }
  
  /* Mobile device specific fixes */
  body.mobile-device .main-wrapper{
    width:100% !important;
    margin-left:0 !important;
    height: auto !important;
    min-height: 100vh !important;
    overflow-y: auto !important;
  }
  
  /* Fix main content on mobile devices */
  body.mobile-device .main-content {
    overflow-y: auto !important;
    overflow-x: hidden !important;
    height: auto !important;
    min-height: calc(100vh - 70px) !important;
    scroll-behavior: smooth !important;
  }
  
  .students-portal-grid{grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;}
  .students-portal-card{padding:20px 12px;min-height:120px;}
  .students-portal-card i{font-size:1.8rem;}
  .students-portal-card .label{font-size:0.95rem;}
  
  .dynamic-buttons{flex-direction:column;}
  .dynamic-buttons button{flex:1 1 auto;margin-bottom:8px;}
  
  .login-container{
    max-width:220px;
    padding:12px 8px;
    background:rgba(255,255,255,0.03);
    -webkit-backdrop-filter:blur(5px);
    backdrop-filter:blur(5px);
    border-radius:12px;
    z-index:150;
    position:relative;
    border:2px solid transparent;
    background-clip:padding-box;
    box-shadow:0 0 10px rgba(102,126,234,0.4), 0 0 20px rgba(118,75,162,0.3);
  }
  .login-header h1{font-size:1.1rem;margin:0 !important;padding:0 !important;line-height:1 !important;}
  .login-header h1 span{margin:0 !important;padding:0 !important;line-height:1 !important;}
  .login-header .logo{width:45px;height:45px;font-size:1.2rem;}
  .input-group{margin-bottom:10px;position:relative;z-index:50;}
  .input-group input{padding:6px 8px;font-size:0.8rem;border-radius:8px;position:relative;z-index:50;pointer-events:auto;-webkit-user-select:auto;user-select:auto;touch-action:manipulation;}
  .login-btn{padding:8px 12px;font-size:0.8rem;border-radius:8px;position:relative;z-index:50;pointer-events:auto;}
  #login-form h2{font-size:1.1rem;margin-bottom:12px;margin-top:0 !important;padding:0 !important;line-height:1.1 !important;}
  #login-form{position:relative;z-index:50;}
  
  .student-id-cards-container{flex-direction:column;align-items:center;gap:10px;}
  .student-id-card{width:320px;height:200px;}
  .student-photo{width:70px;height:70px;top:12px;}
  .card-content{margin-top:90px;}
  .student-name{font-size:1rem;}
  .field-row{font-size:0.6rem;}
  .field-label{min-width:60px;font-size:0.55rem;}
  .field-value{font-size:0.55rem;}
  .signature-area{font-size:0.5rem;}
  .back-title{font-size:0.9rem;}
  .return-address{font-size:0.55rem;}
  
  #modal-content{min-width:280px;max-width:90vw;padding:16px;margin:20px;}
  #idcard-modal-content{max-width:95vw;padding:10px;}
}

@media (max-width: 480px) {
  .sidebar{width:100vw;right:0 !important;left:auto !important;transform:translateX(100%) !important;}
  .sidebar.open,.sidebar.active{transform:translateX(0) !important;}
  .top-bar{padding:10px 60px 10px 15px;}
  #page-title{font-size:1rem;}
  .right-content{gap:6px;}
  .right-content select{display:none;}
  .profile-icon{width:32px;height:32px;font-size:0.9rem;}
  
  /* Mobile menu button positioning for very small screens */
  .mobile-menu-btn{right:10px !important;left:auto !important;top:10px !important;padding:8px;font-size:14px;width:30px;height:30px;}
  
  .content-area{padding:12px;}
  .table-container,.form-container{padding:10px;}
  
  .data-table{font-size:0.75rem;}
  .data-table th,.data-table td{padding:6px 2px;}
  
  .dashboard-grid .card{padding:12px 10px;}
  .dashboard-grid .card .value{font-size:1.3rem;}
  .dashboard-grid .card .label{font-size:0.95rem;}
  
  .students-portal-grid{grid-template-columns:1fr 1fr;gap:10px;}
  .students-portal-card{padding:16px 8px;min-height:100px;}
  .students-portal-card i{font-size:1.5rem;}
  .students-portal-card .label{font-size:0.85rem;}
  
  .login-container{
    max-width:200px;
    padding:10px 6px;
    background:rgba(255,255,255,0.03);
    -webkit-backdrop-filter:blur(4px);
    backdrop-filter:blur(4px);
    border-radius:10px;
    z-index:150;
    position:relative;
    border:2px solid transparent;
    background-clip:padding-box;
    box-shadow:0 0 8px rgba(102,126,234,0.4), 0 0 15px rgba(118,75,162,0.3);
  }
  .login-header h1{font-size:1.0rem;margin:0 !important;padding:0 !important;line-height:0.95 !important;}
  .login-header h1 span{margin:0 !important;padding:0 !important;line-height:0.95 !important;}
  .login-header .logo{width:40px;height:40px;font-size:1.1rem;}
  .input-group{margin-bottom:8px;position:relative;z-index:50;}
  .input-group input{padding:5px 7px;font-size:0.75rem;border-radius:6px;position:relative;z-index:50;pointer-events:auto;-webkit-user-select:auto;user-select:auto;touch-action:manipulation;}
  
  /* Remove gaps between login buttons on very small mobile screens */
  .login-btn-group {
    gap: 0px !important;
  }
  
  .login-btn {
    margin: 0 !important;
    padding: 8px 12px;
    font-size: 0.8rem;
  }
  .login-btn{padding:7px 10px;font-size:0.75rem;border-radius:6px;position:relative;z-index:50;pointer-events:auto;}
  #login-form h2{font-size:1.0rem;margin-bottom:10px;margin-top:0 !important;padding:0 !important;line-height:1 !important;}
  #login-form{position:relative;z-index:50;}
  
  .student-id-card{width:280px;height:180px;}
  .student-photo{width:60px;height:60px;top:10px;}
  .card-content{margin-top:75px;}
  .student-name{font-size:0.9rem;padding:3px 6px;}
  .field-row{font-size:0.55rem;padding:1px 4px;}
  .field-label{min-width:50px;font-size:0.5rem;}
  .field-value{font-size:0.5rem;}
  .signature-area{font-size:0.45rem;padding:4px;}
  .back-title{font-size:0.8rem;}
  .return-address{font-size:0.5rem;line-height:1.1;}
  
  #modal-content{min-width:260px;padding:14px;margin:15px;}
  #idcard-modal-content{max-width:98vw;padding:8px;margin:10px;}
}

/* Smooth transitions for all interactive elements */
* {
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

/* Disable transitions during resize to prevent janky animations */
.resize-animation-stopper * {
  transition: none !important;
}

/* Only apply hover effects on non-touch devices */
@media (hover: hover) {
  button:hover, .btn-submit:hover, .login-btn:hover {
    transform: translateY(-2px);
  }
  
  .card:hover, .students-portal-card:hover {
    transform: translateY(-4px) scale(1.02);
  }
  
  .nav-link:hover {
    transform: translateX(5px);
  }
}

/* Touch feedback for mobile */
@media (hover: none) {
  button:active, .btn-submit:active, .login-btn:active {
    transform: scale(0.98);
  }
  
  .card:active, .students-portal-card:active {
    transform: scale(0.98);
  }
  
  .nav-link:active {
    background: rgba(255,255,255,0.1);
  }
}

/* Hide scrollbars on mobile for cleaner look */
@media (max-width: 768px) {
  .sidebar-nav::-webkit-scrollbar,
  .content-area::-webkit-scrollbar {
    width: 2px;
  }
  
  .sidebar-nav::-webkit-scrollbar-thumb,
  .content-area::-webkit-scrollbar-thumb {
    background: rgba(255,255,255,0.3);
    border-radius: 2px;
  }
  
  /* Better touch targets */
  .nav-link {
    min-height: 48px;
    padding: 16px 18px;
  }
  
  .btn-submit, .login-btn, button {
    min-height: 44px;
    padding: 12px 20px;
    font-size: 16px; /* Prevents zoom on iOS */
    margin: 0;
  }
  
  /* Remove gaps between login buttons on mobile */
  .login-btn-group {
    gap: 0px !important;
  }
  
  input, select, textarea {
    min-height: 44px;
    font-size: 16px; /* Prevents zoom on iOS */
  }
  
  /* Mobile hamburger menu - keep consistent positioning */
  .mobile-menu-btn {
    display: block !important;
    position: fixed !important;
    right: 12px !important;
    left: auto !important;
    top: 12px !important;
    z-index: 1001 !important;
    background: #4D388A !important;
    color: white !important;
    border: none !important;
    padding: 6px !important;
    border-radius: 8px !important;
    cursor: pointer !important;
    width: 32px !important;
    height: 32px !important;
    font-size: 14px !important;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
    transition: all 0.3s ease !important;
  }
  
  /* Improve table scrolling on mobile */
  .table-container {
    overflow-x: auto;
  /* -webkit-overflow-scrolling: touch; Not supported by most browsers */
  }
  
  .data-table {
    min-width: 600px;
    white-space: nowrap;
  }
  
  /* Better modal positioning on mobile */
  #modal-bg, #idcard-modal-bg {
    padding: 20px;
    align-items: flex-start;
    padding-top: 60px;
  }
  
  /* Improve form layout on mobile */
  .generic-form {
    gap: 16px;
  }
  
  .form-group {
    margin-bottom: 16px;
  }
  
  /* Better card spacing on mobile */
  .dashboard-grid, .students-portal-grid {
    padding: 0 4px;
  }
}

/* Extra small screens */
@media (max-width: 320px) {
  .sidebar { width: 100vw; }
  .login-container { 
    max-width: 180px; 
    padding: 8px 5px; 
    background: rgba(255,255,255,0.95); 
    border-radius: 8px; 
    z-index: 200; 
    position: relative;
    border: 1px solid rgba(102,126,234,0.2);
  }
  .login-header h1{font-size:0.9rem;margin:0 !important;padding:0 !important;line-height:0.9 !important;}
  .login-header h1 span{margin:0 !important;padding:0 !important;line-height:0.9 !important;}
  .login-header .logo{width:35px;height:35px;font-size:1.0rem;}
  .input-group{margin-bottom:6px;position:relative;z-index:50;}
  .input-group input{padding:4px 6px;font-size:0.7rem;border-radius:5px;position:relative;z-index:50;pointer-events:auto;-webkit-user-select:auto;user-select:auto;touch-action:manipulation;}
  .login-btn{padding:6px 8px;font-size:0.7rem;border-radius:5px;position:relative;z-index:50;pointer-events:auto;}
  #login-form h2{font-size:0.9rem;margin-bottom:8px;margin-top:0 !important;padding:0 !important;line-height:0.95 !important;}
  #login-form{position:relative;z-index:50;}
  
/* Ensure video doesn't interfere with form on mobile but remains visible */
  .hero-video {
    pointer-events: none;
    z-index: 1 !important;
    display: block !important;
    visibility: visible !important;
    opacity: 0.6 !important;
  }
  
  /* Force form interactivity on mobile */
  .login-container {
    z-index: 9999 !important;
    pointer-events: auto !important;
    position: relative !important;
    background: rgba(255,255,255,0.3) !important;
    -webkit-backdrop-filter: blur(30px) !important;
    backdrop-filter: blur(30px) !important;
  }
  
  #login-form {
    z-index: 9998 !important;
    pointer-events: auto !important;
    position: relative !important;
  }
  
  #login-form input {
    z-index: 9997 !important;
    pointer-events: auto !important;
    position: relative !important;
    touch-action: manipulation !important;
    -webkit-user-select: auto !important;
    user-select: auto !important;
  }
  
  .login-btn, .btn-submit {
    z-index: 9997 !important;
    pointer-events: auto !important;
    position: relative !important;
    touch-action: manipulation !important;
  }
  .student-id-card { width: 260px; height: 160px; }
  .student-photo{width:50px;height:50px;top:8px;}
  .card-content{margin-top:65px;}
  .student-name{font-size:0.8rem;}
  .field-row{font-size:0.5rem;}
  .field-label{min-width:45px;font-size:0.45rem;}
  .field-value{font-size:0.45rem;}
  .signature-area{font-size:0.4rem;}
  .students-portal-grid { grid-template-columns: 1fr; }
  .dashboard-grid .card .value { font-size: 1.2rem; }
  
  /* Extra small screen mobile menu positioning */
  .mobile-menu-btn {
    right: 8px !important;
    top: 8px !important;
    padding: 8px !important;
    font-size: 14px !important;
  }
  
  #idcard-modal-content{max-width:99vw;padding:5px;margin:5px;-webkit-backdrop-filter: blur(4px) !important;backdrop-filter: blur(4px) !important;}
}

/* ========== COMPREHENSIVE MOBILE RESPONSIVE STYLES ========== */

/* Dashboard and Grid Components */
@media (max-width: 768px) {
  .dashboard-grid {
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)) !important;
    gap: 15px !important;
  }
  
  .students-portal-grid {
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)) !important;
    gap: 15px !important;
  }
  
  .students-portal-card {
    padding: 20px !important;
    min-height: 120px !important;
  }
  
  /* Header sections with gradients */
  .gradient-header, [style*="background:linear-gradient"] {
    padding: 20px 15px !important;
    margin-bottom: 20px !important;
  }
  
  .gradient-header h1, 
  [style*="background:linear-gradient"] h1 {
    font-size: 2rem !important;
    line-height: 1.2 !important;
  }
  
  .gradient-header p,
  [style*="background:linear-gradient"] p {
    font-size: 1rem !important;
    margin: 8px 0 0 0 !important;
  }
}

/* Tables - Mobile Responsive */
@media (max-width: 768px) {
  .table-container {
    overflow-x: auto !important;
  /* -webkit-overflow-scrolling: touch !important; Not supported by most browsers */
    border-radius: 10px !important;
  }
  
  table {
    min-width: 100% !important;
    font-size: 0.85rem !important;
  }
  
  th, td {
    padding: 8px 6px !important;
    white-space: nowrap !important;
    min-width: 80px !important;
  }
  
  /* Make first column sticky for better navigation */
  th:first-child, td:first-child {
    position: sticky !important;
    left: 0 !important;
    background: inherit !important;
    z-index: 1 !important;
  }
  
  /* Table scroll indicator */
  .table-container:after {
    content: "← Scroll horizontally →";
    display: block;
    text-align: center;
    padding: 8px;
    font-size: 0.8rem;
    color: #666;
    background: #f8f9fa;
    border-top: 1px solid #ddd;
  }
}

/* Forms - Mobile Responsive */
@media (max-width: 768px) {
  .generic-form, .form-container {
    padding: 15px !important;
    margin: 10px !important;
  }
  
  .form-group {
    margin-bottom: 15px !important;
  }
  
  .form-group.full-width {
    grid-column: 1 / -1 !important;
  }
  
  .form-row {
    display: block !important;
    gap: 0 !important;
  }
  
  .form-row .form-group {
    width: 100% !important;
    margin-right: 0 !important;
  }
  
  input, select, textarea {
    width: 100% !important;
    box-sizing: border-box !important;
    font-size: 16px !important;
    padding: 12px !important;
  }
  
  /* Multi-column forms to single column */
  .generic-form {
    display: block !important;
    grid-template-columns: none !important;
  }
  
  /* Button groups */
  .form-group.full-width .btn-submit,
  .form-group.full-width .btn-view {
    width: 100% !important;
    margin: 5px 0 !important;
    display: block !important;
  }
}

/* Income/Expense Management Mobile */
@media (max-width: 768px) {
  /* Filter sections */
  [style*="display:flex;gap:12px"] {
    display: flex !important;
    flex-direction: column !important;
    gap: 10px !important;
    align-items: stretch !important;
  }
  
  [style*="display:flex;gap:12px"] select,
  [style*="display:flex;gap:12px"] input,
  [style*="display:flex;gap:12px"] button {
    width: 100% !important;
    margin: 0 !important;
  }
  
  /* Summary cards */
  [style*="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr))"] {
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)) !important;
    gap: 10px !important;
  }
  
  /* Chart containers */
  [style*="display:grid;grid-template-columns:1fr 1fr"] {
    grid-template-columns: 1fr !important;
    gap: 15px !important;
  }
  
  /* Mobile optimizations for account creation form */
  #account-form {
    grid-template-columns: 1fr !important;
    gap: 8px !important;
    padding: 0 !important;
  }
  
  #account-form input, #account-form textarea, #account-form label {
    padding: 12px 15px !important;
    font-size: 1rem !important;
    border-radius: 10px !important;
    border-width: 1px !important;
    transition: none !important; /* Remove transitions for smoother input */
    -webkit-appearance: none !important;
    -moz-appearance: none !important;
    appearance: none !important;
    transform: translateZ(0) !important; /* Force GPU acceleration */
    will-change: transform !important;
  }
  
  /* Optimize date inputs for mobile */
  #account-form input[type="date"] {
    -webkit-appearance: none !important;
    appearance: none !important;
  }
  
  /* Optimize file upload buttons */
  #account-form label[for*="doc"], #account-form label[for="student-photo"] {
    padding: 10px 12px !important;
    font-size: 0.9rem !important;
    text-align: center !important;
    cursor: pointer !important;
  }
  
  /* Documents upload section mobile optimization */
  [style*="grid-column:1/-1"] {
    margin: 5px 0 !important;
    padding: 10px !important;
  }
  
  /* Optimize textarea for medical issues */
  #medical-issues {
    min-height: 60px !important;
    resize: none !important; /* Disable resize for mobile */
  }
  
  /* Button optimizations */
  #create-new-account, #back-login {
    padding: 12px 20px !important;
    font-size: 1rem !important;
    margin: 5px !important;
    touch-action: manipulation !important; /* Improve touch response */
  }
  
  canvas {
    max-width: 100% !important;
    height: auto !important;
  }
}

/* Mobile-optimized form classes */
.mobile-optimized-form .form-input,
.mobile-optimized-form .file-upload-label {
  width: 100%;
  padding: 18px 20px;
  border: 2px solid #e0e0e0;
  border-radius: 15px;
  font-size: 1.1rem;
  background: rgba(255,255,255,0.9);
  box-sizing: border-box;
  transition: border-color 0.2s ease;
  -webkit-tap-highlight-color: transparent;
  /* Hardware acceleration for smooth scrolling */
  transform: translateZ(0);
  backface-visibility: hidden;
  perspective: 1000px;
}

.mobile-optimized-form .file-upload-label {
  cursor: pointer;
  display: block;
  text-align: center;
  background: linear-gradient(135deg,#f8f9fa,#e9ecef);
  font-weight: 600;
  color: #667eea;
}

.mobile-optimized-form .form-input:focus {
  outline: none;
  border-color: #667eea;
}

/* Prevent zoom on input focus for iOS */
@media screen and (-webkit-min-device-pixel-ratio: 0) {
  .mobile-optimized-form .form-input,
  .mobile-optimized-form .file-upload-label {
    font-size: 16px !important; /* Prevents zoom on iOS */
  }
}

/* Additional mobile optimizations */
@media (max-width: 768px) {
  /* Reduce repaints and reflows */
  .mobile-optimized-form {
    contain: layout style paint;
    will-change: transform;
  }
  
  .mobile-optimized-form .form-input,
  .mobile-optimized-form .file-upload-label {
    padding: 12px 15px !important;
    font-size: 16px !important; /* Prevent zoom */
    border-radius: 10px !important;
    border-width: 1px !important;
    transition: none !important;
    /* Mobile webkit optimizations */
    -webkit-appearance: none;
    appearance: none;
    -webkit-transform: translateZ(0);
    transform: translateZ(0);
    -webkit-backface-visibility: hidden;
    backface-visibility: hidden;
  }
  
  /* Optimize textarea for mobile */
  .mobile-optimized-form textarea.form-input {
    resize: none;
    overflow: auto;
    /* Removed deprecated -webkit-overflow-scrolling */
  }
  
  /* Add touch optimization for buttons */
  button, input[type="submit"], input[type="button"] {
    touch-action: manipulation;
    -webkit-tap-highlight-color: transparent;
  }
  
  /* Improve scrolling performance */
  body {
    /* Removed deprecated -webkit-overflow-scrolling */
    overscroll-behavior: contain;
    scroll-behavior: smooth;
  }
  
  /* Optimize mobile input handling */
  input, textarea, select {
    font-size: 16px !important; /* Prevent zoom on iOS */
    transform: translateZ(0); /* Hardware acceleration */
  }
  
  /* Reduce paint layers on mobile */
  .main-content {
    contain: layout style paint;
  }
}

/* Modals - Mobile Responsive */
@media (max-width: 768px) {
  #modal-bg, #idcard-modal-bg, [id*="modal"] {
    padding: 10px !important;
    align-items: flex-start !important;
    padding-top: 50px !important;
  }
  
  #modal-content, #idcard-modal-content {
    width: 95% !important;
    max-width: 95vw !important;
    max-height: 85vh !important;
    margin: 0 auto !important;
    padding: 15px !important;
    overflow-y: auto !important;
  }
  
  /* Modal close buttons */
  .close-btn, [onclick*="closeModal"] {
    top: 10px !important;
    right: 10px !important;
    font-size: 20px !important;
    padding: 8px !important;
  }
}

/* Fee Tracker - Mobile Responsive */
@media (max-width: 768px) {
  .fee-tab {
    padding: 8px 12px !important;
    font-size: 0.8rem !important;
    margin-bottom: 5px !important;
  }
  
  #fee-filters {
    flex-direction: column !important;
    align-items: stretch !important;
  }
  
  #fee-filters select {
    width: 100% !important;
    margin: 5px 0 !important;
  }
}

/* Registration Form - Mobile Responsive */
@media (max-width: 768px) {
  #registration-form {
    display: block !important;
    padding: 15px !important;
  }
  
  #registration-form .form-group {
    width: 100% !important;
    margin-bottom: 15px !important;
  }
  
  /* File upload sections */
  .file-upload-section {
    padding: 15px !important;
    margin: 10px 0 !important;
  }
  
  .photo-preview {
    max-width: 200px !important;
    margin: 0 auto !important;
    display: block !important;
  }
}

/* Student Panel Cards - Mobile */
@media (max-width: 768px) {
  .students-portal-card i {
    font-size: 2rem !important;
    margin-bottom: 10px !important;
  }
  
  .students-portal-card .label {
    font-size: 1rem !important;
    font-weight: 600 !important;
  }
  
  .students-portal-card .desc {
    font-size: 0.85rem !important;
  }
}

/* Qarze Hasna Form - Mobile */
@media (max-width: 768px) {
  .qarz-section {
    margin-bottom: 20px !important;
    padding: 15px !important;
  }
  
  .qarz-section h3 {
    font-size: 1.2rem !important;
    margin-bottom: 15px !important;
  }
  
  .witness-section, .affidavit-section {
    padding: 15px !important;
    margin: 10px 0 !important;
  }
}

/* Visitors and Complaints - Mobile */
@media (max-width: 768px) {
  .visitor-entry, .complaint-item {
    padding: 15px !important;
    margin: 10px 0 !important;
  }
  
  .visitor-photos, .complaint-attachments {
    flex-direction: column !important;
    gap: 10px !important;
  }
  
  .visitor-photo, .complaint-attachment {
    max-width: 100% !important;
    margin: 5px 0 !important;
  }
}

/* Room Management - Mobile */
@media (max-width: 768px) {
  .room-grid {
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)) !important;
    gap: 15px !important;
  }
  
  .room-card {
    padding: 15px !important;
  }
  
  .room-occupants {
    font-size: 0.85rem !important;
  }
}

/* Video Manager - Mobile */
@media (max-width: 768px) {
  .video-grid {
    grid-template-columns: 1fr !important;
    gap: 15px !important;
  }
  
  .video-card {
    padding: 15px !important;
  }
  
  video {
    width: 100% !important;
    height: auto !important;
  }
}

/* Reports and Charts - Mobile */
@media (max-width: 768px) {
  .report-section {
    padding: 15px !important;
    margin: 10px 0 !important;
  }
  
  .chart-container {
    padding: 10px !important;
    overflow-x: auto !important;
  }
  
  .report-filters {
    flex-direction: column !important;
    gap: 10px !important;
  }
  
  .report-filters select,
  .report-filters input,
  .report-filters button {
    width: 100% !important;
  }
}

/* Utilities for Mobile */
@media (max-width: 768px) {
  /* Hide elements that are not mobile-friendly */
  .desktop-only {
    display: none !important;
  }
  
  /* Show mobile-specific elements */
  .mobile-only {
    display: block !important;
  }
  
  /* Header and mobile menu enhancements */
  .main-header {
    background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 50%, #f59e0b 100%) !important;
    height: 68px !important;
    padding: 8px 12px !important;
    box-shadow: 0 4px 20px rgba(79,70,229,0.15) !important;
  }
  
  .mobile-menu-btn {
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    width: 40px !important;
    height: 40px !important;
    background: rgba(79, 70, 229, 0.9) !important;
    border-radius: 12px !important;
    cursor: pointer !important;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
    border: 1px solid rgba(255,255,255,0.2) !important;
    position: relative !important;
    z-index: 1001 !important;
  }
  
  .hamburger-line {
    width: 20px !important;
    height: 2px !important;
    background: #fff !important;
    border-radius: 1px !important;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
    position: absolute !important;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1) !important;
  }
  
  .hamburger-line:nth-child(1) { top: 14px !important; }
  .hamburger-line:nth-child(2) { top: 19px !important; }
  .hamburger-line:nth-child(3) { top: 24px !important; }
  
  .mobile-menu-btn.active .hamburger-line:nth-child(1) {
    transform: rotate(45deg) translate(3px, 3px) !important;
    top: 19px !important;
  }
  
  .mobile-menu-btn.active .hamburger-line:nth-child(2) {
    opacity: 0 !important;
    transform: scale(0) !important;
  }
  
  .mobile-menu-btn.active .hamburger-line:nth-child(3) {
    transform: rotate(-45deg) translate(3px, -3px) !important;
    top: 19px !important;
  }
  
  .hostel-title {
    font-size: 1.4rem !important;
    font-weight: 800 !important;
    background: linear-gradient(135deg, #fff 0%, #f3f4f6 50%, #e5e7eb 100%) !important;
    -webkit-background-clip: text !important;
    background-clip: text !important;
    -webkit-text-fill-color: transparent !important;
    text-shadow: 0 2px 8px rgba(0,0,0,0.2) !important;
    margin: 0 !important;
    letter-spacing: 0.5px !important;
  }
  
  .sidebar {
    width: 280px !important;
    transform: translateX(100%) !important;
    transition: transform 0.35s cubic-bezier(0.25, 0.46, 0.45, 0.94) !important;
    box-shadow: -4px 0 24px rgba(0,0,0,0.15) !important;
    border-left: 1px solid rgba(255,255,255,0.1) !important;
    background: linear-gradient(180deg, #667eea 0%, #764ba2 100%) !important;
  }
  
  .sidebar.active, .sidebar.open {
    transform: translateX(0) !important;
  }
  
  .sidebar-header {
    padding: 16px 14px !important;
    background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%) !important;
    border-bottom: 1px solid rgba(255,255,255,0.1) !important;
  }
  
  .sidebar-close {
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    width: 36px !important;
    height: 36px !important;
    background: rgba(255,255,255,0.1) !important;
    border-radius: 10px !important;
    cursor: pointer !important;
    transition: all 0.25s ease !important;
    border: 1px solid rgba(255,255,255,0.15) !important;
    position: relative !important;
  }
  
  .sidebar-close:hover {
    background: rgba(255,255,255,0.2) !important;
    transform: scale(1.05) !important;
  }
  
  .close-x {
    width: 16px !important;
    height: 2px !important;
    background: #fff !important;
    position: absolute !important;
    border-radius: 1px !important;
    box-shadow: 0 1px 2px rgba(0,0,0,0.1) !important;
  }
  
  .close-x:first-child {
    transform: rotate(45deg) !important;
  }
  
  .close-x:last-child {
    transform: rotate(-45deg) !important;
  }
  
  .sidebar-overlay {
    display: block !important;
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 100% !important;
    height: 100% !important;
    background: rgba(0,0,0,0.7) !important;
    z-index: 999 !important;
    opacity: 0 !important;
    visibility: hidden !important;
    transition: all 0.3s ease !important;
  }
  
  .sidebar-overlay.active {
    opacity: 1 !important;
    visibility: visible !important;
  }
  
  .main-content {
    margin-left: 0 !important;
    padding-top: 78px !important;
    padding-left: 12px !important;
    padding-right: 12px !important;
  }
  
  /* Dashboard cards mobile optimization */
  .dashboard-grid {
    display: grid !important;
    grid-template-columns: 1fr 1fr !important;
    gap: 8px !important;
    padding: 8px !important;
    margin: 0 !important;
    width: 100% !important;
    max-width: 100% !important;
    box-sizing: border-box !important;
  }
  
  .dashboard-grid .card {
    padding: 10px 8px !important;
    border-radius: 12px !important;
    min-height: 85px !important;
    width: 100% !important;
    box-sizing: border-box !important;
    font-size: 0.85rem !important;
    margin: 0 !important;
    display: flex !important;
    flex-direction: column !important;
    justify-content: center !important;
    text-align: center !important;
  }
  
  .dashboard-grid .card .label {
    font-size: 0.75rem !important;
    margin-bottom: 4px !important;
    line-height: 1.2 !important;
  }
  
  .dashboard-grid .card .value {
    font-size: 1.2rem !important;
    font-weight: 700 !important;
    line-height: 1.1 !important;
  }
  
  .dashboard-grid .card .muted {
    font-size: 0.65rem !important;
    margin-top: 2px !important;
    opacity: 0.8 !important;
  }
  
  /* Mobile responsive students portal cards */
  .students-portal-card {
    width: 100% !important;
    margin: 8px 0 !important;
    padding: 12px 8px !important;
    font-size: 0.9rem !important;
  }
  
  /* Mobile responsive fee tracker and other specific components */
  .fee-tracker-grid, .room-allocation-grid, .attendance-grid {
    grid-template-columns: 1fr !important;
    gap: 8px !important;
  }
  
  /* Mobile responsive visitor logbook */
  .visitor-entry {
    flex-direction: column !important;
    padding: 12px 8px !important;
  }
  
  /* Mobile responsive income/expense forms */
  .transaction-form {
    padding: 12px 8px !important;
  }
  
  .transaction-form .form-row {
    flex-direction: column !important;
    gap: 8px !important;
  }
  
  /* Mobile responsive charts containers */
  .chart-container {
    width: 100% !important;
    margin: 8px 0 !important;
    padding: 8px !important;
  }
  
  /* Mobile responsive news and announcements */
  .news-item, .announcement-item {
    width: 100% !important;
    margin: 8px 0 !important;
    padding: 12px 8px !important;
  }
  
  /* Mobile responsive mess menu */
  .mess-menu-grid {
    grid-template-columns: 1fr !important;
    gap: 8px !important;
  }
  
  .mess-day-card {
    width: 100% !important;
    margin: 8px 0 !important;
  }
  
  /* Mobile responsive study materials */
  .study-materials-grid {
    grid-template-columns: 1fr !important;
    gap: 8px !important;
  }
  
  /* Mobile responsive help desk and feedback */
  .help-ticket, .feedback-item {
    width: 100% !important;
    margin: 8px 0 !important;
    padding: 12px 8px !important;
  }
  
  .dashboard-grid .card .muted {
    font-size: 0.7rem !important;
  }
  
  /* Text adjustments */
  h1 { font-size: 1.6rem !important; }
  h2 { font-size: 1.3rem !important; }
  h3 { font-size: 1.2rem !important; }
  h4 { font-size: 1.0rem !important; }
  
  /* Padding adjustments */
  .content-area {
    padding: 12px !important;
  }
  
  /* Margin adjustments */
  .section {
    margin: 12px 0 !important;
  }
  
  /* Full width buttons on mobile */
  .btn-submit, .btn-view, .login-btn {
    width: 100% !important;
    margin: 8px 0 !important;
    text-align: center !important;
    padding: 8px 12px !important;
    font-size: 0.85rem !important;
  }
  
  /* Table optimization */
  table {
    font-size: 0.85rem !important;
  }
  
  th, td {
    padding: 8px 6px !important;
  }
}

/* Very Small Screens (iPhone SE, etc.) */
@media (max-width: 480px) {
  .sidebar-nav {
    width: 100% !important;
  }
  
  .content-area {
    padding: 10px !important;
  }
  
  .students-portal-card {
    min-height: 100px !important;
    padding: 15px !important;
  }
  
  .students-portal-card i {
    font-size: 1.5rem !important;
  }
  
  .students-portal-card .label {
    font-size: 0.9rem !important;
  }
  
  table {
    font-size: 0.75rem !important;
  }
  
  th, td {
    padding: 6px 4px !important;
  }
  
  input, select, textarea {
    font-size: 16px !important; /* Prevent zoom on iOS */
    padding: 10px !important;
  }
  
  /* Summary cards on very small screens */
  [style*="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr))"],
  [style*="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr))"] {
    grid-template-columns: 1fr !important;
  }
}

/* Mobile Optimization for Specific Tabs */
@media (max-width: 768px) {
  /* 1. Room Allocation Mobile Optimization */
  #room-allocation-template .table-container,
  #room-allocation-template .content-section {
    padding: 6px !important;
    margin: 4px !important;
  }
  
  #room-allocation-template h1 {
    font-size: 1.3rem !important;
    padding: 12px 8px !important;
    margin-bottom: 10px !important;
  }
  
  #room-allocation-template table {
    font-size: 0.7rem !important;
    width: 100% !important;
    border-collapse: separate !important;
    border-spacing: 2px !important;
  }
  
  #room-allocation-template th,
  #room-allocation-template td {
    padding: 4px 2px !important;
    white-space: nowrap !important;
    vertical-align: middle !important;
    text-align: center !important;
  }
  
  #room-allocation-template th {
    font-size: 0.65rem !important;
    background: linear-gradient(135deg,#667eea,#764ba2) !important;
    padding: 6px 4px !important;
  }
  
  #room-allocation-template input[type="number"] {
    width: 40px !important;
    padding: 3px 4px !important;
    font-size: 0.7rem !important;
    border-radius: 4px !important;
    border: 1px solid #ccc !important;
    text-align: center !important;
  }
  
  #room-allocation-template .room-number div {
    font-size: 0.75rem !important;
    padding: 3px 6px !important;
    border-radius: 6px !important;
  }
  
  /* 2. Income Management Mobile Optimization - Enhanced for Better Readability */
  #income-template {
    padding: 2px !important;
    margin: 0 !important;
  /* min-height: auto !important; Not supported by Firefox */
  }
  
  #income-template .table-container,
  #income-template .content-section {
    padding: 4px !important;
    margin: 2px !important;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1) !important;
    border-radius: 6px !important;
  }
  
  #income-template h1 {
    font-size: 1.1rem !important;
    padding: 8px 6px !important;
    margin-bottom: 6px !important;
    text-align: center !important;
    font-weight: 600 !important;
    color: #333 !important;
  }
  
  #income-template [style*="display:flex;gap:12px"] {
    flex-direction: column !important;
    gap: 3px !important;
    padding: 6px !important;
    margin: 3px 0 !important;
    border-radius: 8px !important;
    background: rgba(255,255,255,0.95) !important;
  }
  
  #income-template .btn-submit,
  #income-template .btn-view {
    width: 100% !important;
    padding: 6px 8px !important;
    font-size: 0.75rem !important;
    margin: 1px 0 !important;
    border-radius: 5px !important;
    min-height: 40px !important;
    font-weight: 500 !important;
    box-shadow: 0 1px 2px rgba(0,0,0,0.1) !important;
  }
  
  #income-template select,
  #income-template input[type="date"],
  #income-template input[type="text"],
  #income-template input[type="number"] {
    width: 100% !important;
    padding: 6px !important;
    font-size: 0.75rem !important;
    margin: 1px 0 !important;
    border-radius: 4px !important;
    border: 1px solid #ddd !important;
    min-height: 38px !important;
    background: white !important;
    box-sizing: border-box !important;
  }
  
  #income-template [style*="grid-template-columns:repeat(auto-fit,minmax(200px,1fr))"] {
    grid-template-columns: 1fr !important;
    gap: 4px !important;
    margin: 4px 0 !important;
  }
  
  #income-template [style*="grid-template-columns:1fr 1fr"] {
    grid-template-columns: 1fr !important;
    gap: 4px !important;
  }
  
  #income-template [style*="padding:20px"] {
    padding: 8px 4px !important;
    border-radius: 6px !important;
    margin: 2px 0 !important;
  }
  
  #income-template [style*="font-size:1.8rem"] {
    font-size: 1rem !important;
    line-height: 1.1 !important;
    font-weight: 600 !important;
  }
  
  #income-template [style*="font-size:1rem"] {
    font-size: 0.7rem !important;
    line-height: 1 !important;
  }
  
  #income-template table {
    font-size: 0.65rem !important;
    width: 100% !important;
    border-collapse: collapse !important;
    margin: 4px 0 !important;
    background: white !important;
  }
  
  #income-template th,
  #income-template td {
    padding: 3px 1px !important;
    white-space: nowrap !important;
    text-overflow: ellipsis !important;
    overflow: hidden !important;
    max-width: 80px !important;
    border: 1px solid #eee !important;
  }
  
  #income-template th {
    background: #f8f9fa !important;
    font-weight: 600 !important;
    font-size: 0.6rem !important;
  }
  
  #income-template label {
    font-size: 0.7rem !important;
    font-weight: 500 !important;
    margin-bottom: 2px !important;
    display: block !important;
    color: #555 !important;
  }
  
  /* 3. Expense Management Mobile Optimization - Enhanced for Better Readability */
  #expense-template {
    padding: 2px !important;
    margin: 0 !important;
  /* min-height: auto !important; Not supported by Firefox */
  }
  
  #expense-template .table-container,
  #expense-template .content-section {
    padding: 4px !important;
    margin: 2px !important;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1) !important;
    border-radius: 6px !important;
  }
  
  #expense-template h1 {
    font-size: 1.1rem !important;
    padding: 8px 6px !important;
    margin-bottom: 6px !important;
    text-align: center !important;
    font-weight: 600 !important;
    color: #333 !important;
  }
  
  #expense-template [style*="display:flex;gap:12px"] {
    flex-direction: column !important;
    gap: 3px !important;
    padding: 6px !important;
    margin: 3px 0 !important;
    border-radius: 8px !important;
    background: rgba(255,255,255,0.95) !important;
  }
  
  #expense-template .btn-submit,
  #expense-template .btn-view {
    width: 100% !important;
    padding: 6px 8px !important;
    font-size: 0.75rem !important;
    margin: 1px 0 !important;
    border-radius: 5px !important;
    min-height: 40px !important;
    font-weight: 500 !important;
    box-shadow: 0 1px 2px rgba(0,0,0,0.1) !important;
  }
  
  #expense-template select,
  #expense-template input[type="date"],
  #expense-template input[type="text"],
  #expense-template input[type="number"] {
    width: 100% !important;
    padding: 6px !important;
    font-size: 0.75rem !important;
    margin: 1px 0 !important;
    border-radius: 4px !important;
    border: 1px solid #ddd !important;
    min-height: 38px !important;
    background: white !important;
    box-sizing: border-box !important;
  }
  
  #expense-template [style*="grid-template-columns:repeat(auto-fit,minmax(200px,1fr))"] {
    grid-template-columns: 1fr !important;
    gap: 4px !important;
    margin: 4px 0 !important;
  }
  
  #expense-template [style*="grid-template-columns:1fr 1fr"] {
    grid-template-columns: 1fr !important;
    gap: 4px !important;
  }
  
  #expense-template [style*="padding:20px"] {
    padding: 8px 4px !important;
    border-radius: 6px !important;
    margin: 2px 0 !important;
  }
  
  #expense-template [style*="font-size:1.8rem"] {
    font-size: 1rem !important;
    line-height: 1.1 !important;
    font-weight: 600 !important;
  }
  
  #expense-template [style*="font-size:1rem"] {
    font-size: 0.7rem !important;
    line-height: 1 !important;
  }
  
  #expense-template table {
    font-size: 0.65rem !important;
    width: 100% !important;
    border-collapse: collapse !important;
    margin: 4px 0 !important;
    background: white !important;
  }
  
  #expense-template th,
  #expense-template td {
    padding: 3px 1px !important;
    white-space: nowrap !important;
    text-overflow: ellipsis !important;
    overflow: hidden !important;
    max-width: 80px !important;
    border: 1px solid #eee !important;
  }
  
  #expense-template th {
    background: #f8f9fa !important;
    font-weight: 600 !important;
    font-size: 0.6rem !important;
  }
  
  #expense-template label {
    font-size: 0.7rem !important;
    font-weight: 500 !important;
    margin-bottom: 2px !important;
    display: block !important;
    color: #555 !important;
  }
  
  /* Additional Mobile Optimization for Income & Expense Management - Ultra Compact */
  #income-template .main-content,
  #expense-template .main-content {
    padding: 2px !important;
    margin: 0 !important;
    overflow-x: auto !important;
  }
  
  #income-template .form-container,
  #expense-template .form-container {
    padding: 6px !important;
    margin: 2px 0 !important;
    background: rgba(255,255,255,0.98) !important;
    border-radius: 6px !important;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1) !important;
  }
  
  #income-template .chart-container,
  #expense-template .chart-container {
    padding: 4px !important;
    margin: 4px 0 !important;
    height: 200px !important;
    overflow: hidden !important;
  }
  
  #income-template .summary-cards,
  #expense-template .summary-cards {
    display: flex !important;
    flex-direction: column !important;
    gap: 3px !important;
    margin: 4px 0 !important;
  }
  
  #income-template .summary-card,
  #expense-template .summary-card {
    padding: 6px !important;
    font-size: 0.7rem !important;
    text-align: center !important;
    border-radius: 5px !important;
    background: linear-gradient(135deg, #f8f9fa, #e9ecef) !important;
    border: 1px solid #dee2e6 !important;
  }
  
  #income-template .pagination,
  #expense-template .pagination {
    flex-wrap: wrap !important;
    gap: 2px !important;
    justify-content: center !important;
    margin: 6px 0 !important;
  }
  
  #income-template .pagination button,
  #expense-template .pagination button {
    padding: 4px 6px !important;
    font-size: 0.65rem !important;
    min-width: 30px !important;
    height: 32px !important;
    border-radius: 4px !important;
  }
  
  /* Ultra compact scrollable tables for mobile */
  #income-template .table-wrapper,
  #expense-template .table-wrapper {
    overflow-x: auto !important;
    margin: 4px 0 !important;
    border: 1px solid #eee !important;
    border-radius: 4px !important;
    background: white !important;
    max-height: 300px !important;
    overflow-y: auto !important;
  }
  
  #income-template tbody tr,
  #expense-template tbody tr {
    border-bottom: 1px solid #f0f0f0 !important;
  }
  
  #income-template tbody tr:hover,
  #expense-template tbody tr:hover {
    background: #f8f9fa !important;
  }
  
  /* Form row optimizations */
  #income-template .form-row,
  #expense-template .form-row {
    display: flex !important;
    flex-direction: column !important;
    gap: 4px !important;
    margin: 4px 0 !important;
  }
  
  #income-template .form-group,
  #expense-template .form-group {
    margin: 2px 0 !important;
  }
  
  /* Action buttons container */
  #income-template .actions,
  #expense-template .actions {
    display: flex !important;
    flex-direction: column !important;
    gap: 3px !important;
    margin: 6px 0 !important;
  }
  
  #income-template .actions button,
  #expense-template .actions button {
    width: 100% !important;
    padding: 6px !important;
    font-size: 0.75rem !important;
    border-radius: 5px !important;
    min-height: 38px !important;
  }
}
  .content-section h1[style*="QARZ E HASNA"],
  .content-section h4[style*="QARZ E HASNA"] {
    font-size: 1.2rem !important;
    padding: 10px 6px !important;
    text-align: center !important;
    margin-bottom: 8px !important;
  }
  
  .content-section [style*="padding:30px"],
  .content-section [style*="padding:25px"] {
    padding: 10px 6px !important;
    margin: 6px 0 !important;
    border-radius: 10px !important;
  }
  
  .content-section [style*="display:grid;grid-template-columns:1fr 1fr"] {
    grid-template-columns: 1fr !important;
    gap: 8px !important;
  }
  
  .content-section [style*="display:grid;grid-template-columns:1fr 1fr 1fr"] {
    grid-template-columns: 1fr !important;
    gap: 6px !important;
  }
  
  .content-section [style*="display:grid;grid-template-columns:repeat(4,1fr)"] {
    grid-template-columns: 1fr 1fr !important;
    gap: 6px !important;
  }
  
  .content-section input[type="text"],
  .content-section input[type="number"],
  .content-section input[type="date"],
  .content-section input[type="email"],
  .content-section input[type="tel"],
  .content-section select,
  .content-section textarea {
    width: 100% !important;
    padding: 10px 8px !important;
    font-size: 16px !important; /* Prevent zoom on iOS */
    border: 1px solid #ccc !important;
    border-radius: 6px !important;
    margin: 2px 0 !important;
    box-sizing: border-box !important;
    min-height: 44px !important;
  }
  
  .content-section input[style*="display:inline"] {
    display: block !important;
    width: 100% !important;
    margin: 5px 0 !important;
    padding: 8px !important;
    border: 2px solid #3b82f6 !important;
    border-radius: 6px !important;
    background: #f8fafc !important;
    font-size: 16px !important;
    min-height: 44px !important;
  }
  
  .content-section ol {
    padding-left: 12px !important;
    margin: 8px 0 !important;
  }
  
  .content-section li {
    margin-bottom: 10px !important;
    line-height: 1.3 !important;
    font-size: 0.8rem !important;
  }
  
  .content-section label {
    font-size: 0.8rem !important;
    margin-bottom: 4px !important;
    display: block !important;
    font-weight: 600 !important;
  }
  
  .content-section label[style*="display:flex"] {
    padding: 6px !important;
    font-size: 0.75rem !important;
    margin: 2px 0 !important;
    border-radius: 5px !important;
    min-height: 44px !important;
    align-items: center !important;
  }
  
  .content-section .btn-submit {
    width: 100% !important;
    padding: 12px !important;
    font-size: 0.9rem !important;
    margin-top: 12px !important;
    border-radius: 8px !important;
    min-height: 48px !important;
  }
  
  .content-section input[type="file"] {
    font-size: 0.8rem !important;
    padding: 8px !important;
    min-height: 44px !important;
  }
  
  .content-section [style*="border:3px dashed"] {
    padding: 12px 6px !important;
    text-align: center !important;
    border-width: 2px !important;
    border-radius: 8px !important;
  }
  
  .content-section h4 {
    font-size: 1.0rem !important;
    margin-bottom: 6px !important;
  }
  
  /* Universal mobile table wrapper */
  .table-scroll-wrapper {
    overflow-x: auto !important;
  /* -webkit-overflow-scrolling: touch !important; Not supported by most browsers */
    border: 1px solid #ddd !important;
    border-radius: 6px !important;
    margin: 6px 0 !important;
  }
  
  /* Mobile form improvements */
  .form-group {
    margin-bottom: 6px !important;
  }
  
  .form-group input,
  .form-group select,
  .form-group textarea {
    font-size: 16px !important; /* Prevent zoom on iOS */
    min-height: 44px !important;
  }
  
  /* Charts mobile optimization */
  canvas {
    max-width: 100% !important;
    height: auto !important;
    max-height: 200px !important;
  }
  
  /* Additional mobile specific fixes */
  .modal-content {
    margin: 10px !important;
    max-width: calc(100vw - 20px) !important;
    max-height: calc(100vh - 40px) !important;
    overflow-y: auto !important;
  }
  
  /* Better spacing for mobile */
  .content-area {
    padding: 8px !important;
  }
  
  /* Improved touch targets */
  .nav-link {
    min-height: 48px !important;
    padding: 12px 18px !important;
  }
  
  /* Management Pages - Ultra Mobile Optimization for Maximum Readability */
  #income-template,
  #expense-template {
    padding: 0 !important;
    margin: 0 !important;
    overflow-x: hidden !important;
    max-width: 100vw !important;
  }
  
  #income-template *,
  #expense-template * {
    box-sizing: border-box !important;
  }
  
  /* Main container optimization */
  #income-template > div,
  #expense-template > div {
    padding: 2px !important;
    margin: 1px 0 !important;
    width: 100% !important;
  }
  
  /* Title headers - more compact */
  #income-template h1,
  #expense-template h1,
  #income-template h2,
  #expense-template h2 {
    font-size: 0.95rem !important;
    padding: 4px 6px !important;
    margin: 2px 0 !important;
    text-align: center !important;
    word-wrap: break-word !important;
    line-height: 1.1 !important;
  }
  
  /* Form elements - ultra compact */
  #income-template input,
  #income-template select,
  #income-template textarea,
  #expense-template input,
  #expense-template select,
  #expense-template textarea {
    width: 100% !important;
    padding: 4px 6px !important;
    font-size: 0.7rem !important;
    margin: 1px 0 !important;
    border: 1px solid #ddd !important;
    border-radius: 3px !important;
    min-height: 34px !important;
    background: white !important;
  }
  
  /* Button optimization */
  #income-template button,
  #expense-template button {
    width: 100% !important;
    padding: 5px 8px !important;
    font-size: 0.7rem !important;
    margin: 1px 0 !important;
    border-radius: 4px !important;
    min-height: 36px !important;
    font-weight: 500 !important;
    border: none !important;
    cursor: pointer !important;
  }
  
  /* Table optimization - horizontal scroll */
  #income-template .table-responsive,
  #expense-template .table-responsive,
  #income-template .table-container,
  #expense-template .table-container {
    overflow-x: auto !important;
    overflow-y: auto !important;
    max-height: 250px !important;
    margin: 2px 0 !important;
    border: 1px solid #e0e0e0 !important;
    border-radius: 4px !important;
    background: white !important;
  }
  
  #income-template table,
  #expense-template table {
    min-width: 100% !important;
    font-size: 0.6rem !important;
    border-collapse: collapse !important;
    background: white !important;
  }
  
  #income-template td,
  #income-template th,
  #expense-template td,
  #expense-template th {
    padding: 2px 3px !important;
    border: 1px solid #f0f0f0 !important;
    white-space: nowrap !important;
    text-overflow: ellipsis !important;
    max-width: 70px !important;
    overflow: hidden !important;
  }
  
  /* Charts and graphs - mobile optimized */
  #income-template .chart,
  #income-template canvas,
  #expense-template .chart,
  #expense-template canvas {
    max-width: 100% !important;
    height: 180px !important;
    margin: 4px 0 !important;
  }
  
  /* Cards and sections - compact */
  #income-template .card,
  #income-template .section,
  #expense-template .card,
  #expense-template .section {
    padding: 4px 6px !important;
    margin: 2px 0 !important;
    border-radius: 4px !important;
    background: rgba(255,255,255,0.95) !important;
    box-shadow: 0 1px 2px rgba(0,0,0,0.1) !important;
  }
  
  /* Flex containers - stack vertically */
  #income-template .row,
  #income-template .flex,
  #income-template .d-flex,
  #expense-template .row,
  #expense-template .flex,
  #expense-template .d-flex {
    flex-direction: column !important;
    gap: 2px !important;
    margin: 2px 0 !important;
  }
  
  /* Grid layouts - single column */
  #income-template .grid,
  #income-template .row,
  #expense-template .grid,
  #expense-template .row {
    display: flex !important;
    flex-direction: column !important;
    gap: 2px !important;
  }
  
  /* Pagination - compact */
  #income-template .pagination,
  #expense-template .pagination {
    display: flex !important;
    flex-wrap: wrap !important;
    justify-content: center !important;
    gap: 1px !important;
    margin: 4px 0 !important;
  }
  
  #income-template .pagination button,
  #expense-template .pagination button {
    min-width: 28px !important;
    height: 28px !important;
    padding: 2px 4px !important;
    font-size: 0.6rem !important;
    border-radius: 3px !important;
  }
  
  /* Taza Khabar (News) Mobile Optimization - Ultra Compact for Portrait View */
  #news-template {
    padding: 0 !important;
    margin: 0 !important;
    overflow-x: hidden !important;
    max-width: 100vw !important;
  }
  
  #news-template * {
    box-sizing: border-box !important;
  }
  
  /* Header optimization */
  #news-template > div:first-child {
    padding: 2px !important;
    margin: 0 !important;
  }
  
  #news-template [style*="gradientShift"] {
    padding: 8px 6px !important;
    margin-bottom: 8px !important;
    border-radius: 8px !important;
  }
  
  #news-template h1 {
    font-size: 1.1rem !important;
    margin: 0 !important;
    padding: 4px 0 !important;
    text-align: center !important;
    line-height: 1.1 !important;
  }
  
  #news-template p {
    font-size: 0.75rem !important;
    margin: 2px 0 0 0 !important;
    line-height: 1 !important;
  }
  
  /* Controls section - ultra compact */
  #news-template [style*="display:flex;gap:12px"] {
    flex-direction: column !important;
    gap: 3px !important;
    padding: 6px !important;
    margin: 4px 0 !important;
    border-radius: 6px !important;
  }
  
  #news-template #add-news-btn {
    width: 100% !important;
    padding: 6px 10px !important;
    font-size: 0.75rem !important;
    margin: 1px 0 !important;
    border-radius: 5px !important;
    min-height: 38px !important;
    font-weight: 500 !important;
  }
  
  #news-template #news-search,
  #news-template #news-status-filter {
    width: 100% !important;
    padding: 6px 8px !important;
    font-size: 0.7rem !important;
    margin: 1px 0 !important;
    border-radius: 4px !important;
    min-height: 36px !important;
    border: 1px solid #ddd !important;
    background: white !important;
  }
  
  /* Table container - scrollable and compact */
  #news-template [style*="background:linear-gradient(135deg,#667eea"] {
    padding: 1px !important;
    border-radius: 6px !important;
    margin: 4px 0 !important;
    overflow-x: auto !important;
  }
  
  #news-template table {
    min-width: 100% !important;
    font-size: 0.6rem !important;
    border-radius: 5px !important;
    overflow: hidden !important;
    background: white !important;
  }
  
  #news-template thead th {
    padding: 6px 3px !important;
    font-size: 0.6rem !important;
    font-weight: 600 !important;
    white-space: nowrap !important;
    text-overflow: ellipsis !important;
    max-width: 60px !important;
    overflow: hidden !important;
  }
  
  #news-template tbody td {
    padding: 4px 2px !important;
    font-size: 0.6rem !important;
    white-space: nowrap !important;
    text-overflow: ellipsis !important;
    max-width: 60px !important;
    overflow: hidden !important;
    border-bottom: 1px solid #f0f0f0 !important;
  }
  
  #news-template tbody tr:hover {
    background: #f8f9fa !important;
  }
  
  /* Form container - ultra compact for easy field entry */
  #news-template #news-form-container {
    margin-top: 8px !important;
    padding: 6px !important;
    background: rgba(255,255,255,0.95) !important;
    border-radius: 6px !important;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1) !important;
  }
  
  #news-template #news-form-container h4 {
    font-size: 0.9rem !important;
    margin: 0 0 6px 0 !important;
    text-align: center !important;
    color: #333 !important;
    font-weight: 600 !important;
  }
  
  #news-template .form-group {
    margin: 3px 0 !important;
    width: 100% !important;
  }
  
  #news-template .form-group.full-width {
    grid-column: 1 / -1 !important;
  }
  
  #news-template label {
    font-size: 0.7rem !important;
    font-weight: 500 !important;
    margin-bottom: 2px !important;
    display: block !important;
    color: #555 !important;
  }
  
  #news-template input,
  #news-template select,
  #news-template textarea {
    width: 100% !important;
    padding: 6px 8px !important;
    font-size: 0.75rem !important;
    margin: 1px 0 !important;
    border: 1px solid #ddd !important;
    border-radius: 4px !important;
    background: white !important;
    box-sizing: border-box !important;
    min-height: 38px !important;
  }
  
  #news-template textarea {
    resize: vertical !important;
    min-height: 44px !important;
    line-height: 1.2 !important;
  }
  
  #news-template #news-description {
    min-height: 60px !important;
  }
  
  #news-template #news-remarks {
    min-height: 50px !important;
  }
  
  #news-template .btn-submit,
  #news-template .btn-view {
    width: 100% !important;
    padding: 8px 10px !important;
    font-size: 0.75rem !important;
    margin: 3px 0 !important;
    border-radius: 5px !important;
    min-height: 40px !important;
    font-weight: 500 !important;
    border: none !important;
    cursor: pointer !important;
  }
  
  #news-template .btn-submit {
    background: linear-gradient(135deg, #4CAF50, #45a049) !important;
    color: white !important;
  }
  
  #news-template .btn-view {
    background: linear-gradient(135deg, #f44336, #d32f2f) !important;
    color: white !important;
    margin-left: 0 !important;
  }
  
  /* Form layout optimization for mobile */
  #news-template .generic-form {
    display: flex !important;
    flex-direction: column !important;
    gap: 4px !important;
  }
  
  /* Responsive form grid for larger mobile screens */
  @media (max-width: 768px) and (min-width: 480px) {
    #news-template .generic-form {
      display: grid !important;
      grid-template-columns: 1fr 1fr !important;
      gap: 4px !important;
    }
    
    #news-template .form-group.full-width {
      grid-column: 1 / -1 !important;
    }
  }
  
  /* Extra small mobile screens optimization */
  @media (max-width: 380px) {
    #news-template h1 {
      font-size: 1rem !important;
    }
    
    #news-template table {
      font-size: 0.55rem !important;
    }
    
    #news-template thead th,
    #news-template tbody td {
      padding: 3px 1px !important;
      max-width: 45px !important;
    }
    
    #news-template input,
    #news-template select,
    #news-template textarea {
      font-size: 0.7rem !important;
      padding: 5px 6px !important;
    }
    
    #news-template .btn-submit,
    #news-template .btn-view {
      font-size: 0.7rem !important;
      padding: 6px 8px !important;
    }
  }
  
  /* Ultra Compact for Infinix Techno Mobile Screens - Maximum Space Utilization */
  @media (max-width: 400px) {
    #news-template {
      font-size: 0.6rem !important;
      line-height: 1 !important;
    }
    
    /* Header - Ultra compact */
    #news-template [style*="gradientShift"] {
      padding: 4px 3px !important;
      margin-bottom: 4px !important;
      border-radius: 4px !important;
    }
    
    #news-template h1 {
      font-size: 0.85rem !important;
      padding: 2px 0 !important;
      margin: 0 !important;
      font-weight: 700 !important;
    }
    
    #news-template p {
      font-size: 0.6rem !important;
      margin: 1px 0 0 0 !important;
      display: none !important; /* Hide subtitle to save space */
    }
    
    /* Controls - Ultra compact */
    #news-template [style*="display:flex;gap:12px"] {
      padding: 3px !important;
      margin: 2px 0 !important;
      gap: 2px !important;
    }
    
    #news-template #add-news-btn {
      padding: 4px 6px !important;
      font-size: 0.65rem !important;
      min-height: 32px !important;
      border-radius: 3px !important;
    }
    
    #news-template #news-search,
    #news-template #news-status-filter {
      padding: 4px 5px !important;
      font-size: 0.6rem !important;
      min-height: 30px !important;
      border-radius: 3px !important;
    }
    
    /* Table - Ultra compact */
    #news-template table {
      font-size: 0.5rem !important;
      border-radius: 3px !important;
    }
    
    #news-template thead th {
      padding: 3px 1px !important;
      font-size: 0.5rem !important;
      max-width: 35px !important;
    }
    
    #news-template tbody td {
      padding: 2px 1px !important;
      font-size: 0.5rem !important;
      max-width: 35px !important;
      line-height: 1 !important;
    }
    
    /* Form - Ultra compact for easy entry */
    #news-template #news-form-container {
      padding: 3px !important;
      margin-top: 4px !important;
      border-radius: 4px !important;
    }
    
    #news-template #news-form-container h4 {
      font-size: 0.75rem !important;
      margin: 0 0 3px 0 !important;
    }
    
    #news-template .form-group {
      margin: 1px 0 !important;
    }
    
    #news-template label {
      font-size: 0.6rem !important;
      margin-bottom: 1px !important;
      font-weight: 600 !important;
    }
    
    #news-template input,
    #news-template select {
      padding: 3px 4px !important;
      font-size: 0.65rem !important;
      min-height: 28px !important;
      border-radius: 2px !important;
      border: 1px solid #ccc !important;
    }
    
    #news-template textarea {
      padding: 3px 4px !important;
      font-size: 0.65rem !important;
      border-radius: 2px !important;
      border: 1px solid #ccc !important;
      line-height: 1.1 !important;
    }
    
    #news-template #news-description {
      min-height: 40px !important;
    }
    
    #news-template #news-remarks {
      min-height: 35px !important;
    }
    
    #news-template .btn-submit,
    #news-template .btn-view {
      padding: 4px 6px !important;
      font-size: 0.65rem !important;
      min-height: 32px !important;
      margin: 1px 0 !important;
      border-radius: 3px !important;
      font-weight: 600 !important;
    }
    
    /* Grid layout for Infinix screens */
    #news-template .generic-form {
      display: grid !important;
      grid-template-columns: 1fr 1fr !important;
      gap: 2px !important;
      align-items: start !important;
    }
    
    #news-template .form-group.full-width {
      grid-column: 1 / -1 !important;
    }
  }
  
  /* Specific optimization for very small Infinix screens */
  @media (max-width: 360px) {
    #news-template {
      padding: 0 1px !important;
    }
    
    #news-template h1 {
      font-size: 0.8rem !important;
    }
    
    #news-template table {
      font-size: 0.45rem !important;
    }
    
    #news-template thead th,
    #news-template tbody td {
      padding: 1px !important;
      max-width: 30px !important;
    }
    
    #news-template input,
    #news-template select,
    #news-template textarea {
      font-size: 0.6rem !important;
      padding: 2px 3px !important;
      min-height: 26px !important;
    }
    
    #news-template .btn-submit,
    #news-template .btn-view {
      font-size: 0.6rem !important;
      padding: 3px 5px !important;
      min-height: 28px !important;
    }
    
    #news-template label {
      font-size: 0.55rem !important;
    }
    
    #news-template #news-description {
      min-height: 35px !important;
    }
    
    #news-template #news-remarks {
      min-height: 30px !important;
    }
    
    /* Special table layout for very small screens */
    #news-template table {
      display: block !important;
      overflow-x: auto !important;
      white-space: nowrap !important;
    }
    
    #news-template thead,
    #news-template tbody,
    #news-template th,
    #news-template td,
    #news-template tr {
      display: block !important;
    }
    
    #news-template thead tr {
      position: absolute !important;
      top: -9999px !important;
      left: -9999px !important;
    }
    
    #news-template tr {
      border: 1px solid #ccc !important;
      margin-bottom: 2px !important;
      padding: 2px !important;
      border-radius: 3px !important;
      background: white !important;
    }
    
    #news-template td {
      border: none !important;
      position: relative !important;
      padding-left: 25% !important;
      padding-right: 2px !important;
      padding-top: 2px !important;
      padding-bottom: 2px !important;
      text-align: left !important;
      max-width: none !important;
      white-space: normal !important;
    }
    
    #news-template td:before {
      content: attr(data-label) ": " !important;
      position: absolute !important;
      left: 2px !important;
      width: 22% !important;
      padding-right: 2px !important;
      white-space: nowrap !important;
      font-weight: 600 !important;
      font-size: 0.55rem !important;
      color: #666 !important;
    }
  }
  
  /* Infinix Techno specific - Hide non-essential elements */
  @media (max-width: 400px) {
    #news-template .table-container {
      padding: 1px !important;
      margin: 1px 0 !important;
    }
    
    /* Simplify gradients for better performance */
    #news-template [style*="gradientShift"] {
      background: linear-gradient(45deg, #4CAF50, #2196F3) !important;
      animation: none !important;
    }
    
    #news-template thead tr {
      background: linear-gradient(45deg, #FF9800, #FF5722) !important;
      animation: none !important;
    }
    
    /* Optimize form spacing */
    #news-template .generic-form {
      padding: 2px !important;
      margin: 2px 0 !important;
    }
  }

/* Landscape orientation on mobile */
@media (max-width: 768px) and (orientation: landscape) {
  .dashboard-grid,
  .students-portal-grid {
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)) !important;
  }
  
  .modal-content {
    max-height: 70vh !important;
  }
}

/* Touch-friendly adjustments */
@media (hover: none) and (pointer: coarse) {
  /* Increase touch targets */
  button, .btn-submit, .btn-view, .nav-link {
    min-height: 44px !important;
    min-width: 44px !important;
    padding: 12px 16px !important;
  }
  
  /* Remove hover effects on touch devices */
  .students-portal-card:hover,
  .room-card:hover,
  button:hover {
    transform: none !important;
  }
  
  /* Add active states for touch feedback */
  .students-portal-card:active,
  .room-card:active,
  button:active {
    transform: scale(0.98) !important;
    transition: transform 0.1s ease !important;
  }
}

/* Vibrant animations for "Welcomes U" text on mobile */
@keyframes vibrantGradient {
  0% { 
    background-position: 0% 50%;
    filter: hue-rotate(0deg) brightness(1.2) saturate(1.5);
  }
  25% { 
    background-position: 100% 50%;
    filter: hue-rotate(90deg) brightness(1.4) saturate(1.8);
  }
  50% { 
    background-position: 200% 50%;
    filter: hue-rotate(180deg) brightness(1.6) saturate(2);
  }
  75% { 
    background-position: 300% 50%;
    filter: hue-rotate(270deg) brightness(1.4) saturate(1.8);
  }
  100% { 
    background-position: 400% 50%;
    filter: hue-rotate(360deg) brightness(1.2) saturate(1.5);
  }
}

@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.1); }
  100% { transform: scale(1); }
}

@keyframes glow {
  0% { text-shadow: 0 0 10px #ff6b6b, 0 0 20px #ff6b6b, 0 0 30px #ff6b6b; }
  25% { text-shadow: 0 0 10px #4ecdc4, 0 0 20px #4ecdc4, 0 0 30px #4ecdc4; }
  50% { text-shadow: 0 0 10px #45b7d1, 0 0 20px #45b7d1, 0 0 30px #45b7d1; }
  75% { text-shadow: 0 0 10px #96ceb4, 0 0 20px #96ceb4, 0 0 30px #96ceb4; }
  100% { text-shadow: 0 0 10px #ff6b6b, 0 0 20px #ff6b6b, 0 0 30px #ff6b6b; }
}

/* Desktop vibrant animations for "Welcomes U" text */
.login-container h2 {
  background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4, #feca57, #ff9ff3, #54a0ff, #5f27cd, #00d2d3, #ff9f43, #10ac84, #ee5a6f) !important;
  background-size: 400% 400% !important;
  -webkit-background-clip: text !important;
  background-clip: text !important;
  -webkit-text-fill-color: transparent !important;
  animation: vibrantGradient 3s ease-in-out infinite, pulse 2s ease-in-out infinite, glow 2.5s ease-in-out infinite !important;
  font-weight: 900 !important;
  font-size: clamp(2rem, 5vw, 3.5rem) !important;
  letter-spacing: 2px !important;
  text-align: center !important;
  margin: 15px 0 !important;
  position: relative !important;
  z-index: 10 !important;
  overflow: hidden !important;
  word-wrap: break-word !important;
  max-width: 100% !important;
}

@media (max-width: 768px) {
  .login-container h2 {
    background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4, #feca57, #ff9ff3, #54a0ff, #5f27cd, #00d2d3, #ff9f43, #10ac84, #ee5a6f) !important;
    background-size: 400% 400% !important;
    -webkit-background-clip: text !important;
    background-clip: text !important;
    -webkit-text-fill-color: transparent !important;
    animation: vibrantGradient 3s ease-in-out infinite, pulse 2s ease-in-out infinite, glow 2.5s ease-in-out infinite !important;
    font-weight: 900 !important;
    font-size: clamp(1.8rem, 8vw, 3rem) !important;
    letter-spacing: 2px !important;
    text-align: center !important;
    margin: 15px 0 !important;
    position: relative !important;
    z-index: 10 !important;
    overflow: hidden !important;
    word-wrap: break-word !important;
    max-width: 100% !important;
  }
}


</style>
</head>
<body>

<!-- LOGIN PAGE -->
<div id="login-page" class="page">
  <!-- Background Video -->
  <video class="hero-video" autoplay muted loop playsinline>
    <source src="assets/video-1.mp4" type="video/mp4">
  </video>
  
  <div class="login-container">
    <div class="login-header">
      <div class="logo">🏠</div>
      <h1>Al Fizaa Girls Hostel</h1>
    </div>
    
    <!-- Login Form -->
    <div id="login-form">
      <h2>Welcome Back</h2>
      <div class="error-message" id="login-error"></div>
      
      <div class="input-group">
        <input type="email" id="login-email" placeholder="Email Address" required>
      </div>
      
      <div class="input-group">
        <input type="password" id="login-password" placeholder="Password" required>
      </div>
      
      <div class="login-btn-group">
        <button type="button" class="login-btn admin" id="admin-login-btn">
          <i class="fas fa-user-shield"></i> Admin Login
        </button>
        <button type="button" class="login-btn student" id="student-login-btn">
          <i class="fas fa-user-graduate"></i> Student Login
        </button>
        <button type="button" class="login-btn parent" id="parent-login-btn">
          <i class="fas fa-users"></i> Parent Login
        </button>
        <button type="button" class="login-btn guest" id="guest-login-btn">
          <i class="fas fa-eye"></i> Guest View
        </button>
      </div>
      
      <div style="text-align:center;margin-top:15px;">
        <a href="#" id="show-register" style="color:#4D388A;text-decoration:none;font-size:0.9rem;">Create New Account</a>
      </div>
    </div>
    
    <!-- Register Form -->
    <div id="register-form" style="display:none;">
      <h2>Create Account</h2>
      <div class="error-message" id="register-error"></div>
      <div class="error-message" id="register-success" style="background:#e8f5e8;color:#2e7d32;"></div>
      
      <div class="input-group">
        <input type="text" id="register-name" placeholder="Full Name" required>
      </div>
      
      <div class="input-group">
        <input type="email" id="register-email" placeholder="Email Address" required>
      </div>
      
      <div class="input-group">
        <input type="tel" id="register-phone" placeholder="Phone Number" required>
      </div>
      
      <div class="input-group">
        <select id="register-role" required>
          <option value="">Select Role</option>
          <option value="student">Student</option>
          <option value="admin">Admin</option>
          <option value="staff">Staff</option>
        </select>
      </div>
      
      <div class="input-group">
        <input type="password" id="register-password" placeholder="Password" required minlength="6">
      </div>
      
      <div class="input-group">
        <input type="password" id="register-confirm-password" placeholder="Confirm Password" required>
      </div>
      
      <div class="login-btn-group">
        <button type="button" class="btn-submit" id="create-account-btn">
          <i class="fas fa-user-plus"></i> Create Account
        </button>
        <button type="button" class="login-btn guest" id="back-to-login">
          <i class="fas fa-arrow-left"></i> Back to Login
        </button>
      </div>
    </div>
  </div>
</div>

<!-- APP PAGE -->
<div id="app-page" class="page">
<button class="mobile-menu-btn" id="mobile-menu-btn" title="Open menu" aria-label="Open navigation menu">
  <div class="hamburger-line"></div>
  <div class="hamburger-line"></div>
  <div class="hamburger-line"></div>
</button>
<div class="sidebar-overlay" id="sidebar-overlay"></div>
<div class="app-container">
<aside class="sidebar" id="sidebar">
<div class="sidebar-header">
  <div class="logo" id="sidebar-logo">🏠</div>
  <div class="hostel-title">Al Fizaa Girls Hostel</div>
  <button class="sidebar-close" id="sidebar-close" title="Close sidebar" aria-label="Close sidebar navigation">
    <div class="close-line close-line1"></div>
    <div class="close-line close-line2"></div>
  </button>
</div>
<nav class="sidebar-nav">
<ul>
<li><a href="#" class="nav-link active" data-target="dashboard-template"><i class="fas fa-home"></i> <span>Dashboard</span></a></li>
<li><a href="#" class="nav-link" data-target="enrolled-students-template"><i class="fas fa-list"></i> <span>Registered Students Lists</span></a></li>
<li><a href="#" class="nav-link" data-target="students-panel-template"><i class="fas fa-users"></i> <span>Students Portal</span></a></li>
<li><a href="#" class="nav-link" data-target="room-allocation-template"><i class="fas fa-door-open"></i> <span>Room Allocation</span></a></li>
<li><a href="#" class="nav-link" data-target="fee-tracker-template"><i class="fas fa-dollar-sign"></i> <span>Fee Tracker</span></a></li>
<li><a href="#" class="nav-link" data-target="attendance-template"><i class="fas fa-check-square"></i> <span>Attendance</span></a></li>
<li><a href="#" class="nav-link" data-target="visitors-template"><i class="fas fa-address-book"></i> <span>Visitors LogBook</span></a></li>
<li><a href="#" class="nav-link" data-target="issues-template"><i class="fas fa-exclamation-triangle"></i> <span>Issues</span></a></li>
<li><a href="#" class="nav-link" data-target="income-template"><i class="fas fa-coins"></i> <span>Income</span></a></li>
<li><a href="#" class="nav-link" data-target="expense-template"><i class="fas fa-money-bill-wave"></i> <span>Expense</span></a></li>
<li><a href="#" class="nav-link" data-target="financial-report-template"><i class="fas fa-chart-line"></i> <span>Income Expense Report</span></a></li>
<li><a href="#" class="nav-link" data-target="news-template"><i class="fas fa-newspaper"></i> <span>Taza Khabar</span></a></li>
<li><a href="#" id="logout-btn"><i class="fas fa-sign-out-alt"></i> <span>Log Out</span></a></li>
</ul>
</nav>
</aside>

<div class="main-wrapper" id="main-wrapper">
<header class="top-bar" id="top-bar">
<div class="top-row">
<div class="left-content">
<h2 id="page-title">Al Fizaa Admin Dashboard</h2>
</div>
<button class="header-collapse-btn" id="header-collapse-btn" onclick="toggleHeaderCollapse()">
<span id="header-collapse-icon">▲</span>
</button>
</div>
<div class="right-content" id="header-right-content">
</button>
<button id="admin-notifications-btn" onclick="showAdminNotifications()">
🔔 Notifications <span id="notification-badge">0</span>
</button>
<label for="admin-logo-upload" id="logo-upload-btn">Logo</label>
<input type="file" id="admin-logo-upload" accept="image/*">
<button id="qarz-forms-btn" onclick="showQarzFormsManager();">📋 Qarz Forms</button>
<!-- Qarze Hasna button moved to dashboard -->
<button id="student-reports-btn" onclick="showStudentReportsManager()">📊 Reports</button>
<button id="automated-reports-btn" onclick="showAutomatedReportSettings()">📧 Auto Reports</button>
<button id="document-scanner-btn" onclick="showDocumentScanner()">📄 Scan Forms</button>
<button id="student-id-change-btn" onclick="showStudentIdManager()">🆔 Change IDs</button>
<select id="theme-selector" title="Select theme" aria-label="Select color theme for the application">
<option value="theme-purple">🟣 Purple Classic</option>
<option value="theme-ocean">🌊 Ocean Blue</option>
<option value="theme-sunset">🌅 Sunset Orange</option>
<option value="theme-forest">🌲 Forest Green</option>
<option value="theme-royal">👑 Royal Purple</option>
<option value="theme-cherry">🍒 Cherry Red</option>
<option value="theme-midnight">🌙 Midnight Blue</option>
<option value="theme-tropical">🏝️ Tropical Paradise</option>
<option value="theme-aurora">✨ Aurora Borealis</option>
<option value="theme-cosmic">🌌 Cosmic Galaxy</option>
</select>
<button onclick="showThemePreview()">🎨 Preview</button>
<div id="user-info"></div>
<div id="date-time"></div>
<div class="profile-icon" id="profile-icon">AF</div>
</div>
</header>

<main id="main-content" class="content-area"></main>
</div>
</div>
</div>

<!-- TEMPLATES -->
<!-- SPONSORED STUDENTS PROFILE TEMPLATE -->
<template id="sponsored-students-template">
  <div class="table-container">
    <!-- Dynamic Gradient Header -->
    <div style="background:linear-gradient(45deg,var(--gradient-1),var(--gradient-2),var(--gradient-3),var(--gradient-4),var(--gradient-5),var(--gradient-6),var(--gradient-7));background-size:400% 400%;animation:gradientShift 6s ease infinite;padding:40px;border-radius:25px;margin-bottom:30px;text-align:center;box-shadow:0 20px 40px rgba(0,0,0,0.2);">
      <h1 style="color:white;font-size:3rem;margin-bottom:15px;text-shadow:3px 3px 10px rgba(0,0,0,0.4);font-weight:900;">🎯 Sponsored Students</h1>
      <p style="color:rgba(255,255,255,0.95);font-size:1.4rem;opacity:0.95;text-shadow:2px 2px 6px rgba(0,0,0,0.3);font-weight:600;">Students receiving full sponsorship support</p>
    </div>
    
    <div style="margin:20px 0;display:flex;gap:15px;align-items:center;flex-wrap:wrap;background:linear-gradient(135deg,#e3f2fd,#f3e5f5);padding:20px;border-radius:15px;">
      <input type="text" id="sponsored-search" placeholder="🔍 Search by Name or ID" style="padding:12px 18px;border:2px solid #45b7d1;border-radius:12px;background:linear-gradient(135deg,#fff,#f0f9ff);font-weight:600;flex:1;min-width:250px;">
      <select id="sponsored-filter" style="padding:12px 18px;border:2px solid #96ceb4;border-radius:12px;background:linear-gradient(135deg,#fff,#f0fdf4);font-weight:600;">
        <option value="all">All Sponsored Students</option>
        <option value="active">Active</option>
        <option value="graduated">Graduated</option>
      </select>
      <button class="btn-submit" id="export-sponsored-btn" style="background:linear-gradient(135deg,#ff6b6b,#4ecdc4);padding:12px 20px;border-radius:12px;font-weight:600;">📊 Export Report</button>
    </div>
    
    <!-- Summary Cards -->
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin:25px 0;">
      <div style="background:linear-gradient(135deg,#28a745,#20c997);padding:25px;border-radius:15px;color:white;text-align:center;box-shadow:0 10px 30px rgba(40,167,69,0.3);transition:all 0.3s ease;" onmouseover="this.style.transform='translateY(-8px)';this.style.boxShadow='0 20px 40px rgba(40,167,69,0.4)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 10px 30px rgba(40,167,69,0.3)'">
        <div style="font-size:2rem;font-weight:800;" id="total-sponsored">0</div>
        <div style="opacity:0.9;font-size:1.1rem;font-weight:600;">👥 Total Sponsored</div>
      </div>
      <div style="background:linear-gradient(135deg,#17a2b8,#6f42c1);padding:25px;border-radius:15px;color:white;text-align:center;box-shadow:0 10px 30px rgba(23,162,184,0.3);transition:all 0.3s ease;" onmouseover="this.style.transform='translateY(-8px)';this.style.boxShadow='0 20px 40px rgba(23,162,184,0.4)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 10px 30px rgba(23,162,184,0.3)'">
        <div style="font-size:2rem;font-weight:800;" id="active-sponsored">0</div>
        <div style="opacity:0.9;font-size:1.1rem;font-weight:600;">✅ Currently Active</div>
      </div>
      <div style="background:linear-gradient(135deg,#ffc107,#fd7e14);padding:25px;border-radius:15px;color:white;text-align:center;box-shadow:0 10px 30px rgba(255,193,7,0.3);transition:all 0.3s ease;" onmouseover="this.style.transform='translateY(-8px)';this.style.boxShadow='0 20px 40px rgba(255,193,7,0.4)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 10px 30px rgba(255,193,7,0.3)'">
        <div style="font-size:2rem;font-weight:800;" id="sponsored-amount">PKR 0</div>
        <div style="opacity:0.9;font-size:1.1rem;font-weight:600;">💰 Total Support</div>
      </div>
    </div>
    
    <!-- Students Grid -->
    <div id="sponsored-students-grid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(350px,1fr));gap:20px;margin:25px 0;"></div>
  </div>
</template>

<!-- SCHOLARSHIP STUDENTS PROFILE TEMPLATE -->
<template id="scholarship-students-template">
  <div class="table-container">
    <!-- Dynamic Gradient Header -->
    <div style="background:linear-gradient(45deg,var(--gradient-5),var(--gradient-6),var(--gradient-7),var(--gradient-8),var(--gradient-9),var(--gradient-10),var(--gradient-11));background-size:400% 400%;animation:gradientShift 6s ease infinite;padding:40px;border-radius:25px;margin-bottom:30px;text-align:center;box-shadow:0 20px 40px rgba(0,0,0,0.2);">
      <h1 style="color:white;font-size:3rem;margin-bottom:15px;text-shadow:3px 3px 10px rgba(0,0,0,0.4);font-weight:900;">🎓 Scholarship Students</h1>
      <p style="color:rgba(255,255,255,0.95);font-size:1.4rem;opacity:0.95;text-shadow:2px 2px 6px rgba(0,0,0,0.3);font-weight:600;">Merit-based scholarship recipients</p>
    </div>
    
    <div style="margin:20px 0;display:flex;gap:15px;align-items:center;flex-wrap:wrap;background:linear-gradient(135deg,#e3f2fd,#f3e5f5);padding:20px;border-radius:15px;">
      <input type="text" id="scholarship-search" placeholder="🔍 Search by Name or ID" style="padding:12px 18px;border:2px solid #45b7d1;border-radius:12px;background:linear-gradient(135deg,#fff,#f0f9ff);font-weight:600;flex:1;min-width:250px;">
      <select id="scholarship-filter" style="padding:12px 18px;border:2px solid #96ceb4;border-radius:12px;background:linear-gradient(135deg,#fff,#f0fdf4);font-weight:600;">
        <option value="all">All Scholarship Students</option>
        <option value="merit">Merit Scholarship</option>
        <option value="need">Need-based</option>
        <option value="academic">Academic Excellence</option>
      </select>
      <button class="btn-submit" id="export-scholarship-btn" style="background:linear-gradient(135deg,#ff6b6b,#4ecdc4);padding:12px 20px;border-radius:12px;font-weight:600;">📊 Export Report</button>
    </div>
    
    <!-- Summary Cards -->
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin:25px 0;">
      <div style="background:linear-gradient(135deg,#6f42c1,#e83e8c);padding:25px;border-radius:15px;color:white;text-align:center;box-shadow:0 10px 30px rgba(111,66,193,0.3);transition:all 0.3s ease;" onmouseover="this.style.transform='translateY(-8px)';this.style.boxShadow='0 20px 40px rgba(111,66,193,0.4)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 10px 30px rgba(111,66,193,0.3)'">
        <div style="font-size:2rem;font-weight:800;" id="total-scholarship">0</div>
        <div style="opacity:0.9;font-size:1.1rem;font-weight:600;">🎓 Total Scholars</div>
      </div>
      <div style="background:linear-gradient(135deg,#28a745,#20c997);padding:25px;border-radius:15px;color:white;text-align:center;box-shadow:0 10px 30px rgba(40,167,69,0.3);transition:all 0.3s ease;" onmouseover="this.style.transform='translateY(-8px)';this.style.boxShadow='0 20px 40px rgba(40,167,69,0.4)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 10px 30px rgba(40,167,69,0.3)'">
        <div style="font-size:2rem;font-weight:800;" id="avg-scholarship-grade">0%</div>
        <div style="opacity:0.9;font-size:1.1rem;font-weight:600;">📈 Avg Grade</div>
      </div>
      <div style="background:linear-gradient(135deg,#dc3545,#fd7e14);padding:25px;border-radius:15px;color:white;text-align:center;box-shadow:0 10px 30px rgba(220,53,69,0.3);transition:all 0.3s ease;" onmouseover="this.style.transform='translateY(-8px)';this.style.boxShadow='0 20px 40px rgba(220,53,69,0.4)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 10px 30px rgba(220,53,69,0.3)'">
        <div style="font-size:2rem;font-weight:800;" id="scholarship-savings">PKR 0</div>
        <div style="opacity:0.9;font-size:1.1rem;font-weight:600;">💰 Total Savings</div>
      </div>
    </div>
    
    <!-- Students Grid -->
    <div id="scholarship-students-grid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(350px,1fr));gap:20px;margin:25px 0;"></div>
  </div>
</template>

<!-- PARTIAL SUPPORT STUDENTS PROFILE TEMPLATE -->
<template id="partial-support-students-template">
  <div class="table-container">
    <!-- Dynamic Gradient Header -->
    <div style="background:linear-gradient(45deg,var(--gradient-9),var(--gradient-10),var(--gradient-11),var(--gradient-12),var(--gradient-1),var(--gradient-2),var(--gradient-3));background-size:400% 400%;animation:gradientShift 6s ease infinite;padding:40px;border-radius:25px;margin-bottom:30px;text-align:center;box-shadow:0 20px 40px rgba(0,0,0,0.2);">
      <h1 style="color:white;font-size:3rem;margin-bottom:15px;text-shadow:3px 3px 10px rgba(0,0,0,0.4);font-weight:900;">🤝 Partial Support Students</h1>
      <p style="color:rgba(255,255,255,0.95);font-size:1.4rem;opacity:0.95;text-shadow:2px 2px 6px rgba(0,0,0,0.3);font-weight:600;">Students receiving partial financial assistance</p>
    </div>
    
    <div style="margin:20px 0;display:flex;gap:15px;align-items:center;flex-wrap:wrap;background:linear-gradient(135deg,#e3f2fd,#f3e5f5);padding:20px;border-radius:15px;">
      <input type="text" id="partial-search" placeholder="🔍 Search by Name or ID" style="padding:12px 18px;border:2px solid #45b7d1;border-radius:12px;background:linear-gradient(135deg,#fff,#f0f9ff);font-weight:600;flex:1;min-width:250px;">
      <select id="partial-filter" style="padding:12px 18px;border:2px solid #96ceb4;border-radius:12px;background:linear-gradient(135deg,#fff,#f0fdf4);font-weight:600;">
        <option value="all">All Partial Support</option>
        <option value="25">25% Support</option>
        <option value="50">50% Support</option>
        <option value="75">75% Support</option>
      </select>
      <button class="btn-submit" id="export-partial-btn" style="background:linear-gradient(135deg,#ff6b6b,#4ecdc4);padding:12px 20px;border-radius:12px;font-weight:600;">📊 Export Report</button>
    </div>
    
    <!-- Summary Cards -->
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin:25px 0;">
      <div style="background:linear-gradient(135deg,#fd7e14,#f093fb);padding:25px;border-radius:15px;color:white;text-align:center;box-shadow:0 10px 30px rgba(253,126,20,0.3);transition:all 0.3s ease;" onmouseover="this.style.transform='translateY(-8px)';this.style.boxShadow='0 20px 40px rgba(253,126,20,0.4)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 10px 30px rgba(253,126,20,0.3)'">
        <div style="font-size:2rem;font-weight:800;" id="total-partial">0</div>
        <div style="opacity:0.9;font-size:1.1rem;font-weight:600;">🤝 Total Supported</div>
      </div>
      <div style="background:linear-gradient(135deg,#45b7d1,#96ceb4);padding:25px;border-radius:15px;color:white;text-align:center;box-shadow:0 10px 30px rgba(69,183,209,0.3);transition:all 0.3s ease;" onmouseover="this.style.transform='translateY(-8px)';this.style.boxShadow='0 20px 40px rgba(69,183,209,0.4)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 10px 30px rgba(69,183,209,0.3)'">
        <div style="font-size:2rem;font-weight:800;" id="avg-support-percent">0%</div>
        <div style="opacity:0.9;font-size:1.1rem;font-weight:600;">📊 Avg Support</div>
      </div>
      <div style="background:linear-gradient(135deg,#feca57,#ff9ff3);padding:25px;border-radius:15px;color:white;text-align:center;box-shadow:0 10px 30px rgba(254,202,87,0.3);transition:all 0.3s ease;" onmouseover="this.style.transform='translateY(-8px)';this.style.boxShadow='0 20px 40px rgba(254,202,87,0.4)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 10px 30px rgba(254,202,87,0.3)'">
        <div style="font-size:2rem;font-weight:800;" id="partial-support-amount">PKR 0</div>
        <div style="opacity:0.9;font-size:1.1rem;font-weight:600;">💰 Total Support</div>
      </div>
    </div>
    
    <!-- Students Grid -->
    <div id="partial-support-students-grid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(350px,1fr));gap:20px;margin:25px 0;"></div>
  </div>
</template>

<!-- UPDATED DASHBOARD TEMPLATE -->
<template id="dashboard-template">
  <div class="table-container">
    <h3>Welcome to Al Fizaa Girls Hostel</h3>
    <p class="muted">Quick overview — click any card to open the related module.</p>

    <div style="margin:12px 0;display:flex;gap:12px;align-items:center;flex-wrap:wrap">
      <label class="muted">View:</label>
      <select id="dashboard-filter" class="small-select">
        <option value="month">This Month</option>
        <option value="year">This Year</option>
        <option value="all">All Time</option>
      </select>
    </div>

    <div class="dashboard-grid" id="dashboard-grid">
      <!-- Cards inserted by JS -->
    </div>
    
    <!-- Student Categories Section -->
    <div style="margin-top:30px;">
      <h4 style="margin-bottom:20px;color:#333;font-size:1.4rem;font-weight:700;">Student Categories</h4>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;">
        <div class="students-portal-card" onclick="showSponsoredStudents()" style="background:linear-gradient(135deg,var(--gradient-1),var(--gradient-2));color:white;padding:25px;border-radius:15px;cursor:pointer;transition:all 0.3s ease;box-shadow:0 8px 25px rgba(102,126,234,0.3);">
          <i class="fas fa-heart" style="font-size:2.2rem;margin-bottom:15px;opacity:0.85;"></i>
          <div class="label" style="font-size:1.2rem;font-weight:700;margin-bottom:8px;">Sponsored Students</div>
          <div class="desc" style="font-size:1rem;opacity:0.9;">Students with full sponsorship support</div>
          <div style="margin-top:15px;font-size:1.5rem;font-weight:800;" id="sponsored-count">0</div>
        </div>
        
        <div class="students-portal-card" onclick="showScholarshipStudents()" style="background:linear-gradient(135deg,var(--gradient-5),var(--gradient-6));color:white;padding:25px;border-radius:15px;cursor:pointer;transition:all 0.3s ease;box-shadow:0 8px 25px rgba(79,172,254,0.3);">
          <i class="fas fa-graduation-cap" style="font-size:2.2rem;margin-bottom:15px;opacity:0.85;"></i>
          <div class="label" style="font-size:1.2rem;font-weight:700;margin-bottom:8px;">Scholarship Students</div>
          <div class="desc" style="font-size:1rem;opacity:0.9;">Merit-based scholarship recipients</div>
          <div style="margin-top:15px;font-size:1.5rem;font-weight:800;" id="scholarship-count">0</div>
        </div>
        
        <div class="students-portal-card" onclick="showPartialSupportStudents()" style="background:linear-gradient(135deg,var(--gradient-9),var(--gradient-10));color:white;padding:25px;border-radius:15px;cursor:pointer;transition:all 0.3s ease;box-shadow:0 8px 25px rgba(69,183,209,0.3);">
          <i class="fas fa-handshake" style="font-size:2.2rem;margin-bottom:15px;opacity:0.85;"></i>
          <div class="label" style="font-size:1.2rem;font-weight:700;margin-bottom:8px;">Partial Support</div>
          <div class="desc" style="font-size:1rem;opacity:0.9;">Students with partial financial assistance</div>
          <div style="margin-top:15px;font-size:1.5rem;font-weight:800;" id="partial-support-count">0</div>
        </div>
        
        <div class="students-portal-card" onclick="showQarzEHasnaForm()" style="background:linear-gradient(135deg,var(--gradient-3),var(--gradient-4));color:white;padding:25px;border-radius:15px;cursor:pointer;transition:all 0.3s ease;box-shadow:0 8px 25px rgba(255,107,107,0.3);">
          <i class="fas fa-clipboard-list" style="font-size:2.2rem;margin-bottom:15px;opacity:0.85;"></i>
          <div class="label" style="font-size:1.2rem;font-weight:700;margin-bottom:8px;">Qarz-e-Hasna Form</div>
          <div class="desc" style="font-size:1rem;opacity:0.9;">Student loan application review</div>
        </div>
      </div>
    </div>

    <div style="margin-top:18px;">
      <h4>Complaints / Issues</h4>
      <div style="display:flex;gap:10px;align-items:center;margin-top:8px">
        <div style="padding:10px;background:#fff;border-radius:8px;box-shadow:0 4px 10px rgba(0,0,0,.04);min-width:160px">
          <div style="font-weight:700" id="complaints-pending-count">0</div>
          <div class="muted">Pending</div>
        </div>
        <div style="padding:10px;background:#fff;border-radius:8px;box-shadow:0 4px 10px rgba(0,0,0,.04);min-width:160px">
          <div style="font-weight:700" id="complaints-resolved-count">0</div>
          <div class="muted">Resolved</div>
        </div>
      </div>
    </div>
  </div>
</template>

<!-- KEEPING ORIGINAL TEMPLATES (unchanged except required placeholders) -->
<template id="registration-template"><div class="form-container"><h3>New Student Registration</h3><form id="registration-form" class="generic-form"></form></div></template>

<template id="students-panel-template">
<div class="table-container">
<!-- Dynamic Gradient Header -->
<div style="background:linear-gradient(45deg,var(--gradient-1),var(--gradient-2),var(--gradient-3),var(--gradient-4),var(--gradient-5),var(--gradient-6),var(--gradient-7));background-size:400% 400%;animation:gradientShift 6s ease infinite;padding:35px;border-radius:25px;margin-bottom:30px;text-align:center;box-shadow:0 20px 40px rgba(0,0,0,0.15);">
  <h1 style="color:white;font-size:2.8rem;margin:0;text-shadow:3px 3px 10px rgba(0,0,0,0.4);font-weight:900;">🎓 Students Portal</h1>
  <p style="color:rgba(255,255,255,0.95);font-size:1.3rem;margin:15px 0 0 0;text-shadow:2px 2px 6px rgba(0,0,0,0.3);font-weight:600;">Your Gateway to Hostel Services</p>
</div>

<div class="students-portal-grid">
  <div class="students-portal-card rooms" id="rooms-btn">
    <i class="fas fa-door-open"></i>
    <div class="label">Rooms</div>
    <div class="desc">View & Allocate</div>
  </div>
  <div class="students-portal-card fee">
    <i class="fas fa-dollar-sign"></i>
    <div class="label">Fee Record</div>
    <div class="desc">Payments & Dues</div>
  </div>
  <div class="students-portal-card visitors">
    <i class="fas fa-address-book"></i>
    <div class="label">Visitors LogBook</div>
    <div class="desc">Guest Entries</div>
  </div>
  <div class="students-portal-card materials">
    <i class="fas fa-book"></i>
    <div class="label">Study Materials</div>
    <div class="desc">Notes & Resources</div>
  </div>
  <div class="students-portal-card help">
    <i class="fas fa-life-ring"></i>
    <div class="label">Help Desk</div>
    <div class="desc">Support</div>
  </div>
  <div class="students-portal-card complaints">
    <i class="fas fa-exclamation-triangle"></i>
    <div class="label">Complaints/Issues</div>
    <div class="desc">Raise or View</div>
  </div>
  <div class="students-portal-card feedback" onclick="showFeedbackPage()">
    <i class="fas fa-comment-dots"></i>
    <div class="label">Feed Back/Reviews</div>
    <div class="desc">Share Experience</div>
  </div>
  <div class="students-portal-card social">
    <i class="fas fa-link"></i>
    <div class="label">Social Links</div>
    <div class="desc">Connect</div>
  </div>
  <div class="students-portal-card idcard">
    <i class="fas fa-id-card"></i>
    <div class="label">Student ID CARD</div>
    <div class="desc">Your Identity</div>
  </div>
  <div class="students-portal-card mess">
    <i class="fas fa-utensils"></i>
    <div class="label">Mess Menu</div>
    <div class="desc">Daily Meals</div>
  </div>
  <div class="students-portal-card rules">
    <i class="fas fa-clipboard-list"></i>
    <div class="label">Hostel Rules</div>
    <div class="desc">Guidelines</div>
  </div>
  <div class="students-portal-card social" onclick="showLocationPage()">
    <i class="fas fa-map-marker-alt"></i>
    <div class="label">Share Hostel Location</div>
    <div class="desc">View Location & Contact</div>
  </div>
  
  <!-- Student Category Buttons -->
  <div class="students-portal-card sponsored-btn" onclick="showSponsoredStudents()" style="background:linear-gradient(135deg,var(--gradient-1),var(--gradient-2));">
    <i class="fas fa-heart"></i>
    <div class="label">Sponsored Students</div>
    <div class="desc">View Sponsorship Info</div>
  </div>
  <div class="students-portal-card scholarship-btn" onclick="showScholarshipStudents()" style="background:linear-gradient(135deg,var(--gradient-5),var(--gradient-6));">
    <i class="fas fa-graduation-cap"></i>
    <div class="label">Scholarship Students</div>
    <div class="desc">View Scholarship Info</div>
  </div>
  <div class="students-portal-card partial-support-btn" onclick="showPartialSupportStudents()" style="background:linear-gradient(135deg,var(--gradient-9),var(--gradient-10));">
    <i class="fas fa-handshake"></i>
    <div class="label">Partial Support Students</div>
    <div class="desc">View Support Info</div>
  </div>
  
  <!-- Qarz e Hasna Form Button - Student Access Only -->
  <div class="students-portal-card qarz-form-btn" onclick="showQarzEHasnaForm()" style="background:linear-gradient(135deg,var(--gradient-11),var(--gradient-12));">
    <i class="fas fa-file-contract"></i>
    <div class="label">Qarz e Hasna Form</div>
    <div class="desc">Financial Support Application</div>
  </div>
</div>
</div>
</template>

<template id="enrolled-students-template">
<div style="background:linear-gradient(135deg,#667eea,#764ba2);padding:12px;border-radius:10px;margin-bottom:12px;">
  <div style="background:rgba(255,255,255,0.95);padding:12px;border-radius:8px;">
    <div style="text-align:center;margin-bottom:12px;">
      <h2 id="enrolled-students-title" style="background:linear-gradient(135deg,#667eea,#f093fb);-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;font-size:1.5rem;font-weight:700;margin:0;">👥 Students List</h2>
    </div>
    
    <div style="margin:8px 0;display:flex;gap:6px;align-items:center;flex-wrap:wrap;background:linear-gradient(135deg,#e3f2fd,#f3e5f5);padding:6px;border-radius:6px;">
      <label style="color:#333;font-weight:600;font-size:0.8rem;">View:</label>
      <select id="students-list-filter" style="padding:3px 6px;border:1px solid #667eea;border-radius:4px;font-size:0.8rem;">
        <option value="month">This Month</option>
        <option value="year">This Year</option>
        <option value="all">All Time</option>
      </select>
      <input type="text" id="enrolled-search" style="padding:3px 6px;border:1px solid #f093fb;border-radius:4px;font-size:0.8rem;" placeholder="Search by Name or ID">
      <button class="btn-submit" id="export-csv" style="background:linear-gradient(135deg,#28a745,#20c997);padding:3px 6px;border-radius:4px;font-size:0.8rem;">Export CSV</button>
    </div>
    
    <div style="background:linear-gradient(135deg,#fff 0%,#f8f9ff 50%,#fff5f8 100%);border-radius:15px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,0.1);border:2px solid rgba(255,255,255,0.8);">
      <table style="width:100%;border-collapse:separate;border-spacing:0;font-size:.9rem;">
        <thead>
          <tr style="background:linear-gradient(135deg,#667eea 0%,#764ba2 25%,#f093fb 50%,#f5576c 75%,#4facfe 100%);color:white;">
            <th style="padding:15px 12px;font-weight:700;text-shadow:1px 1px 3px rgba(0,0,0,0.3);border-right:1px solid rgba(255,255,255,0.2);font-size:0.85rem;">🆔 Student ID</th>
            <th style="padding:15px 12px;font-weight:700;text-shadow:1px 1px 3px rgba(0,0,0,0.3);border-right:1px solid rgba(255,255,255,0.2);font-size:0.85rem;">👤 Name</th>
            <th style="padding:15px 12px;font-weight:700;text-shadow:1px 1px 3px rgba(0,0,0,0.3);border-right:1px solid rgba(255,255,255,0.2);font-size:0.85rem;">📱 Contact</th>
            <th style="padding:15px 12px;font-weight:700;text-shadow:1px 1px 3px rgba(0,0,0,0.3);border-right:1px solid rgba(255,255,255,0.2);font-size:0.85rem;">👨‍👩‍👧 Guardian</th>
            <th style="padding:15px 12px;font-weight:700;text-shadow:1px 1px 3px rgba(0,0,0,0.3);border-right:1px solid rgba(255,255,255,0.2);font-size:0.85rem;">☎️ Guardian Contact</th>
            <th style="padding:15px 12px;font-weight:700;text-shadow:1px 1px 3px rgba(0,0,0,0.3);border-right:1px solid rgba(255,255,255,0.2);font-size:0.85rem;">🆔 Guardian ID</th>
            <th style="padding:15px 12px;font-weight:700;text-shadow:1px 1px 3px rgba(0,0,0,0.3);border-right:1px solid rgba(255,255,255,0.2);font-size:0.85rem;">🏠 Room</th>
            <th style="padding:15px 12px;font-weight:700;text-shadow:1px 1px 3px rgba(0,0,0,0.3);border-right:1px solid rgba(255,255,255,0.2);font-size:0.85rem;">💰 Admission Fee</th>
            <th style="padding:15px 12px;font-weight:700;text-shadow:1px 1px 3px rgba(0,0,0,0.3);border-right:1px solid rgba(255,255,255,0.2);font-size:0.85rem;">🔒 Security Fee</th>
            <th style="padding:15px 12px;font-weight:700;text-shadow:1px 1px 3px rgba(0,0,0,0.3);border-right:1px solid rgba(255,255,255,0.2);font-size:0.85rem;"> Fee Paid</th>
            <th style="padding:15px 12px;font-weight:700;text-shadow:1px 1px 3px rgba(0,0,0,0.3);border-right:1px solid rgba(255,255,255,0.2);font-size:0.85rem;">💵 Total Fee</th>
            <th style="padding:15px 12px;font-weight:700;text-shadow:1px 1px 3px rgba(0,0,0,0.3);border-right:1px solid rgba(255,255,255,0.2);font-size:0.85rem;">⚠️ Due Amount</th>
            <th style="padding:15px 12px;font-weight:700;text-shadow:1px 1px 3px rgba(0,0,0,0.3);border-right:1px solid rgba(255,255,255,0.2);font-size:0.85rem;">🚨 Emergency</th>
            <th style="padding:15px 12px;font-weight:700;text-shadow:1px 1px 3px rgba(0,0,0,0.3);border-right:1px solid rgba(255,255,255,0.2);font-size:0.85rem;">📅 Admission</th>
            <th style="padding:15px 12px;font-weight:700;text-shadow:1px 1px 3px rgba(0,0,0,0.3);border-right:1px solid rgba(255,255,255,0.2);font-size:0.85rem;">🎓 Graduation</th>
            <th style="padding:15px 12px;font-weight:700;text-shadow:1px 1px 3px rgba(0,0,0,0.3);border-right:1px solid rgba(255,255,255,0.2);font-size:0.85rem;">🏥 Medical</th>
            <th style="padding:15px 12px;font-weight:700;text-shadow:1px 1px 3px rgba(0,0,0,0.3);font-size:0.85rem;">📄 Documents</th>
          </tr>
        </thead>
        <tbody id="enrolled-students-tbody"></tbody>
      </table>
    </div>
  </div>
</div>
</template>

<template id="attendance-template">
<div style="background:linear-gradient(135deg,#667eea 0%,#764ba2 30%,#f093fb 60%,#f5576c 100%);padding:25px;border-radius:20px;margin-bottom:20px;box-shadow:0 15px 35px rgba(0,0,0,0.2);">
  <div style="background:rgba(255,255,255,0.95);padding:20px;border-radius:15px;">
    <div style="text-align:center;margin-bottom:20px;">
      <h1 style="background:linear-gradient(135deg,#667eea,#f093fb);-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;font-size:2rem;font-weight:800;margin:0;text-shadow:2px 2px 4px rgba(0,0,0,0.1);">📋 Attendance Management</h1>
      <p style="color:#666;font-size:1rem;margin:8px 0 0 0;">Track and manage student attendance records</p>
    </div>
    
    <!-- Attendance Tabs -->
    <div style="display:flex;gap:8px;margin-bottom:20px;background:linear-gradient(135deg,#e3f2fd,#f3e5f5);padding:10px;border-radius:12px;flex-wrap:wrap;justify-content:center;">
      <button class="attendance-tab active" data-tab="mark" id="mark-attendance-btn" style="padding:10px 16px;border:none;border-radius:8px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;cursor:pointer;font-size:0.9rem;font-weight:600;transition:all 0.3s ease;box-shadow:0 4px 15px rgba(102,126,234,0.3);">✏️ Mark Attendance</button>
      <button class="attendance-tab" data-tab="view" id="view-attendance-btn" style="padding:10px 16px;border:none;border-radius:8px;background:#f8f9fa;color:#333;cursor:pointer;font-size:0.9rem;font-weight:600;transition:all 0.3s ease;">👀 View Attendance</button>
      <button class="attendance-tab" data-tab="report" id="generate-report-btn" style="padding:10px 16px;border:none;border-radius:8px;background:#f8f9fa;color:#333;cursor:pointer;font-size:0.9rem;font-weight:600;transition:all 0.3s ease;">📊 Generate Reports</button>
    </div>
    
    <div id="attendance-content"></div>
  </div>
</div>
</template>

<!-- Simple placeholders for income/expense/others to navigate to -->
<template id="income-template">
  <div class="table-container">
    <!-- Dynamic Gradient Header -->
    <div style="background:linear-gradient(45deg,var(--gradient-7),var(--gradient-8),var(--gradient-9),var(--gradient-10),var(--gradient-11),var(--gradient-12),var(--gradient-1));background-size:400% 400%;animation:gradientShift 4s ease infinite;padding:30px;border-radius:20px;margin-bottom:25px;text-align:center;box-shadow:0 15px 35px rgba(0,0,0,0.2);">
      <h1 style="color:white;font-size:2.5rem;margin:0;text-shadow:2px 2px 8px rgba(0,0,0,0.3);font-weight:800;">💰 Income Management</h1>
      <p style="color:rgba(255,255,255,0.9);font-size:1.2rem;margin:10px 0 0 0;text-shadow:1px 1px 4px rgba(0,0,0,0.2);">Track & Manage Revenue</p>
    </div>
    <div style="margin:12px 0;display:flex;gap:12px;align-items:center;flex-wrap:wrap;background:linear-gradient(135deg,#e3f2fd,#f3e5f5);padding:15px;border-radius:15px;">
      <button class="btn-submit" id="add-income-btn" style="background:linear-gradient(135deg,#ff6b6b,#4ecdc4);border:none;padding:12px 20px;border-radius:10px;color:white;font-weight:600;box-shadow:0 6px 20px rgba(255,107,107,0.3);transition:all 0.3s ease;">💰 Add New Income</button>
      <select id="income-period-filter" style="padding:10px 15px;border:2px solid #45b7d1;border-radius:10px;background:linear-gradient(135deg,#fff,#f0f9ff);font-weight:600;">
        <option value="daily">Daily</option>
        <option value="monthly">Monthly</option>
        <option value="yearly">Yearly</option>
      </select>
      <select id="income-category-filter" style="padding:10px 15px;border:2px solid #96ceb4;border-radius:10px;background:linear-gradient(135deg,#fff,#f0fdf4);font-weight:600;">
        <option value="all">All Categories</option>
        <option value="admission">Admission Fee</option>
        <option value="security">Security Fee</option>
        <option value="monthly">Monthly Fee</option>
        <option value="chanda">Chanda</option>
        <option value="boxes">Boxes</option>
        <option value="bhef">BHEF</option>
        <option value="donation">Donation</option>
        <option value="other">Other</option>
      </select>
      <input type="date" id="income-date-filter" style="padding:10px 15px;border:2px solid #feca57;border-radius:10px;background:linear-gradient(135deg,#fff,#fffbeb);">
      <button class="btn-view" id="generate-income-report-btn" style="background:linear-gradient(135deg,#45b7d1,#96ceb4);border:none;padding:12px 20px;border-radius:10px;color:white;font-weight:600;box-shadow:0 6px 20px rgba(69,183,209,0.3);transition:all 0.3s ease;">📊 Generate Report</button>
    </div>
    
    <!-- Vibrant Summary Cards -->
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin:20px 0;">
      <div style="background:linear-gradient(135deg,#28a745,#20c997);padding:20px;border-radius:15px;color:white;text-align:center;box-shadow:0 8px 25px rgba(40,167,69,0.3);transition:all 0.3s ease;" onmouseover="this.style.transform='translateY(-5px)';this.style.boxShadow='0 15px 35px rgba(40,167,69,0.4)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 8px 25px rgba(40,167,69,0.3)'">
        <div style="font-size:1.8rem;font-weight:700;" id="total-income">PKR 0</div>
        <div style="opacity:0.9;font-size:1rem;">💰 Total Income</div>
      </div>
      <div style="background:linear-gradient(135deg,#17a2b8,#6f42c1);padding:20px;border-radius:15px;color:white;text-align:center;box-shadow:0 8px 25px rgba(23,162,184,0.3);transition:all 0.3s ease;" onmouseover="this.style.transform='translateY(-5px)';this.style.boxShadow='0 15px 35px rgba(23,162,184,0.4)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 8px 25px rgba(23,162,184,0.3)'">
        <div style="font-size:1.8rem;font-weight:700;" id="daily-avg-income">PKR 0</div>
        <div style="opacity:0.9;font-size:1rem;">📈 Daily Average</div>
      </div>
      <div style="background:linear-gradient(135deg,#ffc107,#fd7e14);padding:20px;border-radius:15px;color:white;text-align:center;box-shadow:0 8px 25px rgba(255,193,7,0.3);transition:all 0.3s ease;" onmouseover="this.style.transform='translateY(-5px)';this.style.boxShadow='0 15px 35px rgba(255,193,7,0.4)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 8px 25px rgba(255,193,7,0.3)'">
        <div style="font-size:1.8rem;font-weight:700;" id="highest-income-category">-</div>
        <div style="opacity:0.9;font-size:1rem;">🏆 Highest Category</div>
      </div>
      <div style="background:linear-gradient(135deg,#6f42c1,#e83e8c);padding:20px;border-radius:15px;color:white;text-align:center;box-shadow:0 8px 25px rgba(111,66,193,0.3);transition:all 0.3s ease;" onmouseover="this.style.transform='translateY(-5px)';this.style.boxShadow='0 15px 35px rgba(111,66,193,0.4)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 8px 25px rgba(111,66,193,0.3)'">
        <div style="font-size:1.8rem;font-weight:700;" id="income-count">0</div>
        <div style="opacity:0.9;font-size:1rem;">📊 Total Entries</div>
      </div>
    </div>
    
    <!-- Charts Section -->
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin:20px 0;">
      <div style="background:#fff;padding:16px;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,0.1);">
        <h4>Income Source Distribution</h4>
        <canvas id="income-category-chart" width="300" height="200"></canvas>
      </div>
      <div style="background:#fff;padding:16px;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,0.1);">
        <h4>Monthly Income Trend</h4>
        <canvas id="income-trend-chart" width="300" height="200"></canvas>
      </div>
    </div>
    
    <!-- Vibrant Income Table -->
    <div style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);padding:3px;border-radius:20px;box-shadow:0 15px 35px rgba(0,0,0,0.2);">
      <table style="width:100%;border-collapse:separate;border-spacing:0;background:white;border-radius:17px;overflow:hidden;font-size:.95rem">
        <thead>
          <tr style="background:linear-gradient(45deg,#ff6b6b,#4ecdc4,#45b7d1,#96ceb4,#feca57);background-size:300% 300%;animation:gradientShift 3s ease infinite;color:white;">
            <th style="padding:20px 15px;font-weight:800;text-shadow:2px 2px 4px rgba(0,0,0,0.3);font-size:1.1rem;">📅 Date</th>
            <th style="padding:20px 15px;font-weight:800;text-shadow:2px 2px 4px rgba(0,0,0,0.3);font-size:1.1rem;">📂 Category</th>
            <th style="padding:20px 15px;font-weight:800;text-shadow:2px 2px 4px rgba(0,0,0,0.3);font-size:1.1rem;">👤 Student Name</th>
            <th style="padding:20px 15px;font-weight:800;text-shadow:2px 2px 4px rgba(0,0,0,0.3);font-size:1.1rem;">🆔 Student ID</th>
            <th style="padding:20px 15px;font-weight:800;text-shadow:2px 2px 4px rgba(0,0,0,0.3);font-size:1.1rem;">💰 Amount (PKR)</th>
            <th style="padding:20px 15px;font-weight:800;text-shadow:2px 2px 4px rgba(0,0,0,0.3);font-size:1.1rem;">💳 Payment Method</th>
            <th style="padding:20px 15px;font-weight:800;text-shadow:2px 2px 4px rgba(0,0,0,0.3);font-size:1.1rem;">🧾 Receipt No</th>
            <th style="padding:20px 15px;font-weight:800;text-shadow:2px 2px 4px rgba(0,0,0,0.3);font-size:1.1rem;">  Voucher/Receipt</th>
            <th style="padding:20px 15px;font-weight:800;text-shadow:2px 2px 4px rgba(0,0,0,0.3);font-size:1.1rem;"> 📝 Description</th>
          </tr>
        </thead>
        <tbody id="income-tbody"></tbody>
      </table>
    </div>
    
    <!-- Add Income Form -->
    <div id="income-form-container" style="display:none;margin-top:20px;">
      <h4>Add New Income</h4>
      <form id="income-form" class="generic-form">
        <div class="form-group">
          <label for="income-date">Date</label>
          <input type="date" id="income-date" required>
        </div>
        <div class="form-group">
          <label for="income-category">Category</label>
          <select id="income-category" required>
            <option value="admission">Admission Fee</option>
            <option value="security">Security Fee</option>
            <option value="monthly">Monthly Fee</option>
            <option value="chanda">Chanda</option>
            <option value="boxes">Boxes</option>
            <option value="bhef">BHEF</option>
            <option value="donation">Donation</option>
            <option value="other">Other - Specify</option>
          </select>
        </div>
        <div class="form-group">
          <label for="income-student-name">Student Name</label>
          <input type="text" id="income-student-name" required>
        </div>
        <div class="form-group">
          <label for="income-student-id">Student ID</label>
          <input type="text" id="income-student-id">
        </div>
        <div class="form-group">
          <label for="income-amount">Amount (PKR)</label>
          <input type="number" id="income-amount" required min="0" step="0.01">
        </div>
        <div class="form-group">
          <label for="income-payment">Payment Method</label>
          <select id="income-payment" required>
            <option value="cash">Cash</option>
            <option value="bank">Bank Transfer</option>
            <option value="cheque">Cheque</option>
            <option value="card">Card Payment</option>
            <option value="online">Online Payment</option>
          </select>
        </div>
        <div class="form-group">
          <label for="income-receipt">Receipt No</label>
          <input type="text" id="income-receipt">
        </div>
        <div class="form-group">
          <label for="income-voucher-upload">Upload Receipt/Voucher</label>
          <input type="file" id="income-voucher-upload" accept="image/*,.pdf" style="padding:8px;border:2px solid #ddd;border-radius:8px;background:#f9f9f9;">
          <small style="color:#666;font-size:0.85rem;display:block;margin-top:5px;">📎 Upload invoice/receipt image or PDF (optional)</small>
        </div>
        <div class="form-group full-width">
          <label for="income-description">Description/Specify if Other</label>
          <input type="text" id="income-description" placeholder="Enter details if category is 'Other'">
        </div>
        <div class="form-group full-width">
          <button type="submit" class="btn-submit">Save Income</button>
          <button type="button" class="btn-view" id="cancel-income-btn" style="margin-left:10px;">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</template>
<template id="expense-template">
  <div class="table-container">
    <!-- Dynamic Gradient Header -->
    <div style="background:linear-gradient(45deg,var(--gradient-7),var(--gradient-8),var(--gradient-9),var(--gradient-10),var(--gradient-11),var(--gradient-12),var(--gradient-1));background-size:400% 400%;animation:gradientShift 4s ease infinite;padding:30px;border-radius:20px;margin-bottom:25px;text-align:center;box-shadow:0 15px 35px rgba(0,0,0,0.2);">
      <h1 style="color:white;font-size:2.5rem;margin:0;text-shadow:2px 2px 8px rgba(0,0,0,0.3);font-weight:800;">💸 Expense Management</h1>
      <p style="color:rgba(255,255,255,0.9);font-size:1.2rem;margin:10px 0 0 0;text-shadow:1px 1px 4px rgba(0,0,0,0.2);">Track & Control Expenses</p>
    </div>
    <div style="margin:12px 0;display:flex;gap:12px;align-items:center;flex-wrap:wrap;background:linear-gradient(135deg,#e3f2fd,#f3e5f5);padding:15px;border-radius:15px;">
      <button class="btn-submit" id="add-expense-btn" style="background:linear-gradient(135deg,#ff6b6b,#4ecdc4);border:none;padding:12px 20px;border-radius:10px;color:white;font-weight:600;box-shadow:0 6px 20px rgba(255,107,107,0.3);transition:all 0.3s ease;">💸 Add New Expense</button>
      <select id="expense-period-filter" style="padding:10px 15px;border:2px solid #45b7d1;border-radius:10px;background:linear-gradient(135deg,#fff,#f0f9ff);font-weight:600;">
        <option value="daily">Daily</option>
        <option value="monthly">Monthly</option>
        <option value="yearly">Yearly</option>
      </select>
      <select id="expense-category-filter" style="padding:10px 15px;border:2px solid #96ceb4;border-radius:10px;background:linear-gradient(135deg,#fff,#f0fdf4);font-weight:600;">
        <option value="all">All Categories</option>
        <option value="food">Food & Kitchen</option>
        <option value="utilities">Utilities</option>
        <option value="internet">Internet</option>
        <option value="maintenance">Maintenance</option>
        <option value="staff">Staff Salaries</option>
        <option value="employee">Employee Costs</option>
        <option value="supplies">Office Supply</option>
        <option value="equipment">Equipment</option>
        <option value="security">Security</option>
        <option value="cleaning">Cleaning</option>
        <option value="medical">Medical</option>
        <option value="transport">Transport</option>
        <option value="advertising">Advertising</option>
        <option value="marketing">Marketing</option>
        <option value="debts">Debts</option>
        <option value="sponsorships">Sponsorships</option>
        <option value="other">Other</option>
      </select>
      <input type="date" id="expense-date-filter" style="padding:10px 15px;border:2px solid #feca57;border-radius:10px;background:linear-gradient(135deg,#fff,#fffbeb);">
      <button class="btn-view" id="generate-report-btn" style="background:linear-gradient(135deg,#45b7d1,#96ceb4);border:none;padding:12px 20px;border-radius:10px;color:white;font-weight:600;box-shadow:0 6px 20px rgba(69,183,209,0.3);transition:all 0.3s ease;">📊 Generate Report</button>
    </div>
    
    <!-- Vibrant Summary Cards -->
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin:20px 0;">
      <div style="background:linear-gradient(135deg,#dc3545,#fd7e14);padding:20px;border-radius:15px;color:white;text-align:center;box-shadow:0 8px 25px rgba(220,53,69,0.3);transition:all 0.3s ease;" onmouseover="this.style.transform='translateY(-5px)';this.style.boxShadow='0 15px 35px rgba(220,53,69,0.4)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 8px 25px rgba(220,53,69,0.3)'">
        <div style="font-size:1.8rem;font-weight:700;" id="total-expense">PKR 0</div>
        <div style="opacity:0.9;font-size:1rem;">💸 Total Expenses</div>
      </div>
      <div style="background:linear-gradient(135deg,#28a745,#20c997);padding:20px;border-radius:15px;color:white;text-align:center;box-shadow:0 8px 25px rgba(40,167,69,0.3);transition:all 0.3s ease;" onmouseover="this.style.transform='translateY(-5px)';this.style.boxShadow='0 15px 35px rgba(40,167,69,0.4)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 8px 25px rgba(40,167,69,0.3)'">
        <div style="font-size:1.8rem;font-weight:700;" id="avg-daily">PKR 0</div>
        <div style="opacity:0.9;font-size:1rem;">📈 Daily Average</div>
      </div>
      <div style="background:linear-gradient(135deg,#17a2b8,#6f42c1);padding:20px;border-radius:15px;color:white;text-align:center;box-shadow:0 8px 25px rgba(23,162,184,0.3);transition:all 0.3s ease;" onmouseover="this.style.transform='translateY(-5px)';this.style.boxShadow='0 15px 35px rgba(23,162,184,0.4)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 8px 25px rgba(23,162,184,0.3)'">
        <div style="font-size:1.8rem;font-weight:700;" id="highest-category">-</div>
        <div style="opacity:0.9;font-size:1rem;">🏆 Highest Category</div>
      </div>
      <div style="background:linear-gradient(135deg,#ffc107,#fd7e14);padding:20px;border-radius:15px;color:white;text-align:center;box-shadow:0 8px 25px rgba(255,193,7,0.3);transition:all 0.3s ease;" onmouseover="this.style.transform='translateY(-5px)';this.style.boxShadow='0 15px 35px rgba(255,193,7,0.4)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 8px 25px rgba(255,193,7,0.3)'">
        <div style="font-size:1.8rem;font-weight:700;" id="expense-count">0</div>
        <div style="opacity:0.9;font-size:1rem;">📊 Total Entries</div>
      </div>
      <div style="background:linear-gradient(135deg,#6f42c1,#e83e8c);padding:20px;border-radius:15px;color:white;text-align:center;box-shadow:0 8px 25px rgba(111,66,193,0.3);transition:all 0.3s ease;" onmouseover="this.style.transform='translateY(-5px)';this.style.boxShadow='0 15px 35px rgba(111,66,193,0.4)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 8px 25px rgba(111,66,193,0.3)'">
        <div style="font-size:1.8rem;font-weight:700;" id="net-revenue">PKR 0</div>
        <div style="opacity:0.9;font-size:1rem;">💰 Net Revenue</div>
      </div>
      <div style="background:linear-gradient(135deg,#fd7e14,#f093fb);padding:20px;border-radius:15px;color:white;text-align:center;box-shadow:0 8px 25px rgba(253,126,20,0.3);transition:all 0.3s ease;" onmouseover="this.style.transform='translateY(-5px)';this.style.boxShadow='0 15px 35px rgba(253,126,20,0.4)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 8px 25px rgba(253,126,20,0.3)'">
        <div style="font-size:1.8rem;font-weight:700;" id="profit-loss">PKR 0</div>
        <div style="opacity:0.9;font-size:1rem;">📉 Profit/Loss</div>
      </div>
    </div>
    
    <!-- Charts Section -->
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin:20px 0;">
      <div style="background:#fff;padding:16px;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,0.1);">
        <h4>Category-wise Distribution</h4>
        <canvas id="category-chart" width="300" height="200"></canvas>
      </div>
      <div style="background:#fff;padding:16px;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,0.1);">
        <h4>Monthly Trend</h4>
        <canvas id="trend-chart" width="300" height="200"></canvas>
      </div>
    </div>
    
    <!-- Vibrant Expense Table -->
    <div style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);padding:3px;border-radius:20px;box-shadow:0 15px 35px rgba(0,0,0,0.2);">
      <table style="width:100%;border-collapse:separate;border-spacing:0;background:white;border-radius:17px;overflow:hidden;font-size:.95rem">
        <thead>
          <tr style="background:linear-gradient(45deg,#ff6b6b,#4ecdc4,#45b7d1,#96ceb4,#feca57);background-size:300% 300%;animation:gradientShift 3s ease infinite;color:white;">
            <th style="padding:20px 15px;font-weight:800;text-shadow:2px 2px 4px rgba(0,0,0,0.3);font-size:1.1rem;">📅 Date</th>
            <th style="padding:20px 15px;font-weight:800;text-shadow:2px 2px 4px rgba(0,0,0,0.3);font-size:1.1rem;">📂 Category</th>
            <th style="padding:20px 15px;font-weight:800;text-shadow:2px 2px 4px rgba(0,0,0,0.3);font-size:1.1rem;">📝 Description</th>
            <th style="padding:20px 15px;font-weight:800;text-shadow:2px 2px 4px rgba(0,0,0,0.3);font-size:1.1rem;">💰 Amount (PKR)</th>
            <th style="padding:20px 15px;font-weight:800;text-shadow:2px 2px 4px rgba(0,0,0,0.3);font-size:1.1rem;">💳 Payment Method</th>
            <th style="padding:20px 15px;font-weight:800;text-shadow:2px 2px 4px rgba(0,0,0,0.3);font-size:1.1rem;">🏢 Vendor/Supplier</th>
            <th style="padding:20px 15px;font-weight:800;text-shadow:2px 2px 4px rgba(0,0,0,0.3);font-size:1.1rem;">🧾 Receipt No</th>
            <th style="padding:20px 15px;font-weight:800;text-shadow:2px 2px 4px rgba(0,0,0,0.3);font-size:1.1rem;">📎 Voucher/Receipt</th>
            <th style="padding:20px 15px;font-weight:800;text-shadow:2px 2px 4px rgba(0,0,0,0.3);font-size:1.1rem;">✅ Approved By</th>
          </tr>
        </thead>
        <tbody id="expense-tbody"></tbody>
      </table>
    </div>
    
    <!-- Add Expense Form -->
    <div id="expense-form-container" style="display:none;margin-top:20px;">
      <h4>Add New Expense</h4>
      <form id="expense-form" class="generic-form">
        <div class="form-group">
          <label for="expense-date">Date</label>
          <input type="date" id="expense-date" required>
        </div>
        <div class="form-group">
          <label for="expense-category">Category</label>
          <select id="expense-category" required>
            <option value="food">Food & Kitchen</option>
            <option value="utilities">Utilities (Electricity, Water, Gas)</option>
            <option value="internet">Internet</option>
            <option value="maintenance">Maintenance & Repairs</option>
            <option value="staff">Staff Salaries</option>
            <option value="employee">Employee Costs</option>
            <option value="supplies">Office Supply</option>
            <option value="equipment">Equipment</option>
            <option value="security">Security</option>
            <option value="cleaning">Cleaning & Housekeeping</option>
            <option value="medical">Medical & Health</option>
            <option value="transport">Transport</option>
            <option value="advertising">Advertising</option>
            <option value="marketing">Marketing</option>
            <option value="debts">Debts</option>
            <option value="sponsorships">Sponsorships</option>
            <option value="other">Other</option>
          </select>
        </div>
        <div class="form-group">
          <label for="expense-description">Description</label>
          <input type="text" id="expense-description" required>
        </div>
        <div class="form-group">
          <label for="expense-amount">Amount (PKR)</label>
          <input type="number" id="expense-amount" required min="0" step="0.01">
        </div>
        <div class="form-group">
          <label for="expense-payment">Payment Method</label>
          <select id="expense-payment" required>
            <option value="cash">Cash</option>
            <option value="bank">Bank Transfer</option>
            <option value="cheque">Cheque</option>
            <option value="card">Card Payment</option>
          </select>
        </div>
        <div class="form-group">
          <label for="expense-vendor">Vendor/Supplier</label>
          <input type="text" id="expense-vendor">
        </div>
        <div class="form-group">
          <label for="expense-receipt">Receipt No</label>
          <input type="text" id="expense-receipt">
        </div>
        <div class="form-group">
          <label for="expense-voucher-upload">Upload Receipt/Voucher</label>
          <input type="file" id="expense-voucher-upload" accept="image/*,.pdf" style="padding:8px;border:2px solid #ddd;border-radius:8px;background:#f9f9f9;">
          <small style="color:#666;font-size:0.85rem;display:block;margin-top:5px;">📎 Upload purchase receipt/voucher image or PDF (required for expenses)</small>
        </div>
        <div class="form-group">
          <label for="expense-approved">Approved By</label>
          <input type="text" id="expense-approved">
        </div>
        <div class="form-group full-width">
          <button type="submit" class="btn-submit">Save Expense</button>
          <button type="button" class="btn-view" id="cancel-expense-btn" style="margin-left:10px;">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</template>
<template id="fee-tracker-template">
<div style="background:linear-gradient(135deg,#667eea,#764ba2);padding:20px;border-radius:15px;margin-bottom:20px;box-shadow:0 15px 35px rgba(0,0,0,0.2);">
  <div style="background:rgba(255,255,255,0.98);padding:25px;border-radius:12px;">
    <div style="text-align:center;margin-bottom:20px;">
      <h1 style="background:linear-gradient(135deg,#667eea,#f093fb);-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;font-size:2.2rem;font-weight:800;margin:0;text-shadow:2px 2px 4px rgba(0,0,0,0.1);">💰 Fee Tracker Dashboard</h1>
      <p style="color:#666;font-size:1.1rem;margin:8px 0 0 0;">Comprehensive fee management system</p>
    </div>
    
    <!-- Summary Cards -->
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:25px;">
      <div style="background:linear-gradient(135deg,#28a745,#20c997);padding:20px;border-radius:12px;color:white;text-align:center;box-shadow:0 8px 25px rgba(40,167,69,0.3);">
        <div style="font-size:1.8rem;font-weight:700;" id="total-collected">PKR 0</div>
        <div style="opacity:0.9;font-size:1rem;">Total Collected</div>
      </div>
      <div style="background:linear-gradient(135deg,#dc3545,#fd7e14);padding:20px;border-radius:12px;color:white;text-align:center;box-shadow:0 8px 25px rgba(220,53,69,0.3);">
        <div style="font-size:1.8rem;font-weight:700;" id="total-pending">PKR 0</div>
        <div style="opacity:0.9;font-size:1rem;">Total Pending</div>
      </div>
      <div style="background:linear-gradient(135deg,#17a2b8,#6f42c1);padding:20px;border-radius:12px;color:white;text-align:center;box-shadow:0 8px 25px rgba(23,162,184,0.3);">
        <div style="font-size:1.8rem;font-weight:700;" id="students-count">0</div>
        <div style="opacity:0.9;font-size:1rem;">Total Students</div>
      </div>
      <div style="background:linear-gradient(135deg,#ffc107,#fd7e14);padding:20px;border-radius:12px;color:white;text-align:center;box-shadow:0 8px 25px rgba(255,193,7,0.3);">
        <div style="font-size:1.8rem;font-weight:700;" id="overdue-count">0</div>
        <div style="opacity:0.9;font-size:1rem;">Overdue Students</div>
      </div>
    </div>
    
    <!-- Fee Type Tabs -->
    <div style="display:flex;gap:10px;margin-bottom:20px;background:linear-gradient(135deg,#e3f2fd,#f3e5f5);padding:12px;border-radius:10px;flex-wrap:wrap;">
      <button class="fee-tab active" data-tab="total" style="padding:10px 18px;border:none;border-radius:8px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;cursor:pointer;font-size:0.9rem;font-weight:600;transition:all 0.3s ease;box-shadow:0 4px 15px rgba(102,126,234,0.3);">📊 Total Fees</button>
      <button class="fee-tab" data-tab="admission" style="padding:10px 18px;border:none;border-radius:8px;background:#f8f9fa;color:#333;cursor:pointer;font-size:0.9rem;font-weight:600;transition:all 0.3s ease;">🎓 Admission Fee</button>
      <button class="fee-tab" data-tab="security" style="padding:10px 18px;border:none;border-radius:8px;background:#f8f9fa;color:#333;cursor:pointer;font-size:0.9rem;font-weight:600;transition:all 0.3s ease;">🔒 Security Fee</button>
      <button class="fee-tab" data-tab="monthly" style="padding:10px 18px;border:none;border-radius:8px;background:#f8f9fa;color:#333;cursor:pointer;font-size:0.9rem;font-weight:600;transition:all 0.3s ease;">📅 Monthly Fee</button>
    </div>
    
    <!-- Filters -->
    <div id="fee-filters" style="margin:15px 0;display:flex;gap:10px;align-items:center;flex-wrap:wrap;background:linear-gradient(135deg,#fff3cd,#ffeaa7);padding:12px;border-radius:8px;">
      <label style="color:#333;font-weight:600;font-size:0.9rem;">👤 Student:</label>
      <select id="fee-student-filter" style="padding:6px 12px;border:2px solid #667eea;border-radius:6px;font-size:0.9rem;background:white;">
        <option value="all">All Students</option>
      </select>
      <label style="color:#333;font-weight:600;font-size:0.9rem;">📅 Period:</label>
      <select id="fee-period-filter" style="padding:6px 12px;border:2px solid #f093fb;border-radius:6px;font-size:0.9rem;background:white;">
        <option value="month">This Month</option>
        <option value="year">This Year</option>
        <option value="all">All Time</option>
      </select>
      <input type="text" id="fee-search" style="padding:6px 12px;border:2px solid #28a745;border-radius:6px;font-size:0.9rem;background:white;" placeholder="🔍 Search by Name or ID">
      <button id="add-payment-btn" style="padding:8px 16px;background:linear-gradient(135deg,#28a745,#20c997);color:white;border:none;border-radius:6px;cursor:pointer;font-weight:600;margin-right:10px;">💳 Add Payment</button>
      <button id="fee-slip-records-btn" onclick="showFeeSlipRecords()" style="padding:8px 16px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;border-radius:6px;cursor:pointer;font-weight:600;">📄 Fee Slip Records</button>
    </div>
    
    <!-- Fee Table -->
    <div style="background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 8px 25px rgba(0,0,0,0.1);overflow-x:auto;">
      <table style="width:100%;border-collapse:separate;border-spacing:0;font-size:0.85rem;min-width:900px;">
        <thead>
          <tr style="background:linear-gradient(135deg,#28a745,#20c997);color:white;">
            <th style="padding:15px 10px;font-weight:700;min-width:80px;text-shadow:1px 1px 2px rgba(0,0,0,0.2);">🆔 Student ID</th>
            <th style="padding:15px 10px;font-weight:700;min-width:120px;text-shadow:1px 1px 2px rgba(0,0,0,0.2);">👤 Name</th>
            <th style="padding:15px 10px;font-weight:700;min-width:100px;text-shadow:1px 1px 2px rgba(0,0,0,0.2);">💰 Total Amount</th>
            <th style="padding:15px 10px;font-weight:700;min-width:100px;text-shadow:1px 1px 2px rgba(0,0,0,0.2);">✅ Paid</th>
            <th style="padding:15px 10px;font-weight:700;min-width:80px;text-shadow:1px 1px 2px rgba(0,0,0,0.2);">⚠️ Due</th>
            <th style="padding:15px 10px;font-weight:700;min-width:100px;text-shadow:1px 1px 2px rgba(0,0,0,0.2);">📅 Due Date</th>
            <th style="padding:15px 10px;font-weight:700;min-width:100px;text-shadow:1px 1px 2px rgba(0,0,0,0.2);">📊 Status</th>
            <th style="padding:15px 10px;font-weight:700;min-width:100px;text-shadow:1px 1px 2px rgba(0,0,0,0.2);">⚡ Actions</th>
          </tr>
        </thead>
        <tbody id="fee-tracker-tbody"></tbody>
      </table>
    </div>
    
    <!-- Payment Form Modal -->
    <div id="payment-form-modal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;justify-content:center;align-items:center;">
      <div style="background:white;padding:30px;border-radius:15px;max-width:500px;width:90%;box-shadow:0 15px 35px rgba(0,0,0,0.3);">
        <h3 style="margin:0 0 20px 0;color:#333;">💳 Add Payment Record</h3>
        <form id="payment-form">
          <div style="margin-bottom:15px;">
            <label style="display:block;margin-bottom:5px;font-weight:600;">Student:</label>
            <select id="payment-student" required style="width:100%;padding:10px;border:2px solid #ddd;border-radius:8px;">
              <option value="">Select Student</option>
            </select>
          </div>
          <div style="margin-bottom:15px;">
            <label style="display:block;margin-bottom:5px;font-weight:600;">Fee Type:</label>
            <select id="payment-type" required style="width:100%;padding:10px;border:2px solid #ddd;border-radius:8px;">
              <option value="admission">Admission Fee</option>
              <option value="security">Security Fee</option>
              <option value="monthly">Monthly Fee</option>
              <option value="total">Total Fee</option>
            </select>
          </div>
          <div style="margin-bottom:15px;">
            <label style="display:block;margin-bottom:5px;font-weight:600;">Amount (PKR):</label>
            <input type="number" id="payment-amount" required min="0" step="0.01" style="width:100%;padding:10px;border:2px solid #ddd;border-radius:8px;">
          </div>
          <div style="margin-bottom:15px;">
            <label style="display:block;margin-bottom:5px;font-weight:600;">Payment Date:</label>
            <input type="date" id="payment-date" required style="width:100%;padding:10px;border:2px solid #ddd;border-radius:8px;">
          </div>
          <div style="margin-bottom:20px;">
            <label style="display:block;margin-bottom:5px;font-weight:600;">Payment Method:</label>
            <select id="payment-method" required style="width:100%;padding:10px;border:2px solid #ddd;border-radius:8px;">
              <option value="cash">Cash</option>
              <option value="bank">Bank Transfer</option>
              <option value="card">Card Payment</option>
              <option value="online">Online Payment</option>
            </select>
          </div>
          <div style="display:flex;gap:10px;">
            <button type="submit" style="flex:1;padding:12px;background:linear-gradient(135deg,#28a745,#20c997);color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">Save Payment</button>
            <button type="button" id="cancel-payment" style="flex:1;padding:12px;background:linear-gradient(135deg,#6c757d,#495057);color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
</template>
<template id="room-allocation-template"><div class="table-container"><div id="room-details">Room allocation will appear here.</div></div></template>
<template id="visitors-template">
<div style="background:linear-gradient(135deg,#667eea 0%,#764ba2 30%,#f093fb 60%,#f5576c 100%);padding:25px;border-radius:20px;margin-bottom:20px;box-shadow:0 15px 35px rgba(0,0,0,0.2);">
  <div style="background:rgba(255,255,255,0.95);padding:20px;border-radius:15px;">
    <div style="text-align:center;margin-bottom:20px;">
      <h1 id="visitor-logbook-title" style="background:linear-gradient(135deg,#667eea,#f093fb);-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;font-size:2rem;font-weight:800;margin:0;text-shadow:2px 2px 4px rgba(0,0,0,0.1);">📋 Visitors LogBook</h1>
      <p style="color:#666;font-size:1rem;margin:8px 0 0 0;">Track and manage visitor records</p>
    </div>
    
    <button id="add-visitor-btn" class="btn-submit" onclick="addVisitor()" style="margin-bottom: 20px;">Add Visitor</button>
    
    <table class="data-table">
        <thead>
            <tr>
                <th>Date</th>
                <th>Visitor Name</th>
                <th>Student</th>
                <th>Purpose</th>
                <th>Time In</th>
                <th>Time Out</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="visitor-tbody"></tbody>
    </table>
  </div>
</div>

<!-- Add Visitor Modal -->
<div id="visitor-modal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
    <div class="modal-content" style="background: white; padding: 30px; border-radius: 15px; max-width: 500px; width: 90%; box-shadow: 0 15px 35px rgba(0,0,0,0.3);">
        <h3>Add New Visitor</h3>
        <form id="visitor-form">
            <input type="date" name="date" required style="width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px;">
            <input type="text" name="visitorName" placeholder="Visitor Name" required style="width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px;">
            <input type="text" name="purpose" placeholder="Purpose of Visit" required style="width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px;">
            <input type="time" name="timeIn" required style="width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px;">
            <input type="time" name="timeOut" placeholder="Time Out (optional)" style="width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px;">
            <div style="margin-top: 15px;">
                <button type="button" class="btn-submit" onclick="saveVisitor()">Save</button>
                <button type="button" class="btn-cancel" onclick="document.getElementById('visitor-modal').style.display='none'" style="margin-left: 10px; padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Visitor Modal -->
<div id="edit-visitor-modal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
    <div class="modal-content" style="background: white; padding: 30px; border-radius: 15px; max-width: 500px; width: 90%; box-shadow: 0 15px 35px rgba(0,0,0,0.3);">
        <h3>Edit Visitor</h3>
        <input type="hidden" id="edit-visitor-id">
        <input type="date" id="edit-visitor-date" required style="width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px;">
        <input type="text" id="edit-visitor-name" placeholder="Visitor Name" required style="width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px;">
        <input type="text" id="edit-visitor-purpose" placeholder="Purpose" required style="width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px;">
        <input type="time" id="edit-visitor-timein" required style="width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px;">
        <input type="time" id="edit-visitor-timeout" placeholder="Time Out" style="width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px;">
        <div style="margin-top: 15px;">
            <button type="button" class="btn-submit" onclick="updateVisitor()">Update</button>
            <button type="button" class="btn-cancel" onclick="document.getElementById('edit-visitor-modal').style.display='none'" style="margin-left: 10px; padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">Cancel</button>
        </div>
    </div>
</div>
</template>
<template id="issues-template">
  <div class="table-container">
    <!-- Dynamic Gradient Header -->
    <div style="background:linear-gradient(45deg,var(--gradient-7),var(--gradient-8),var(--gradient-9),var(--gradient-10),var(--gradient-11),var(--gradient-12),var(--gradient-1));background-size:400% 400%;animation:gradientShift 4s ease infinite;padding:30px;border-radius:20px;margin-bottom:25px;text-align:center;box-shadow:0 15px 35px rgba(0,0,0,0.2);">
      <h1 style="color:white;font-size:2.5rem;margin:0;text-shadow:2px 2px 8px rgba(0,0,0,0.3);font-weight:800;">⚠️ Issues & Complaints</h1>
      <p style="color:rgba(255,255,255,0.9);font-size:1.2rem;margin:10px 0 0 0;text-shadow:1px 1px 4px rgba(0,0,0,0.2);">Report & Track Issues</p>
    </div>
    
    <div style="margin:12px 0;display:flex;gap:12px;align-items:center;flex-wrap:wrap">
      <button class="btn-submit" id="add-issue-btn" style="background:linear-gradient(135deg,#ff6b6b,#4ecdc4);border:none;padding:12px 20px;border-radius:10px;color:white;font-weight:600;box-shadow:0 6px 20px rgba(255,107,107,0.3);transition:all 0.3s ease;">➕ Add New Issue</button>
      <input type="text" id="issues-search" class="search-input" placeholder="🔍 Search by Student Name or Issue" style="border:2px solid #45b7d1;border-radius:10px;padding:10px 15px;background:linear-gradient(135deg,#fff,#f0f9ff);">
    </div>
    
    <!-- Vibrant Issues Table -->
    <div style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);padding:3px;border-radius:20px;box-shadow:0 15px 35px rgba(0,0,0,0.2);">
      <table style="width:100%;border-collapse:separate;border-spacing:0;background:white;border-radius:17px;overflow:hidden;font-size:.95rem">
        <thead>
          <tr style="background:linear-gradient(45deg,#ff6b6b,#4ecdc4,#45b7d1,#96ceb4,#feca57);background-size:300% 300%;animation:gradientShift 3s ease infinite;color:white;">
            <th style="padding:20px 15px;font-weight:800;text-shadow:2px 2px 4px rgba(0,0,0,0.3);font-size:1.1rem;">🆔 Complaint ID</th>
            <th style="padding:20px 15px;font-weight:800;text-shadow:2px 2px 4px rgba(0,0,0,0.3);font-size:1.1rem;">👤 Student Name</th>
            <th style="padding:20px 15px;font-weight:800;text-shadow:2px 2px 4px rgba(0,0,0,0.3);font-size:1.1rem;">🏠 Room No</th>
            <th style="padding:20px 15px;font-weight:800;text-shadow:2px 2px 4px rgba(0,0,0,0.3);font-size:1.1rem;">⚠️ Issue</th>
            <th style="padding:20px 15px;font-weight:800;text-shadow:2px 2px 4px rgba(0,0,0,0.3);font-size:1.1rem;">📅 Date</th>
            <th style="padding:20px 15px;font-weight:800;text-shadow:2px 2px 4px rgba(0,0,0,0.3);font-size:1.1rem;">📊 Status</th>
            <th style="padding:20px 15px;font-weight:800;text-shadow:2px 2px 4px rgba(0,0,0,0.3);font-size:1.1rem;">⏰ Days Pending</th>
            <th style="padding:20px 15px;font-weight:800;text-shadow:2px 2px 4px rgba(0,0,0,0.3);font-size:1.1rem;">👷 Assigned Staff</th>
            <th style="padding:20px 15px;font-weight:800;text-shadow:2px 2px 4px rgba(0,0,0,0.3);font-size:1.1rem;">✅ Resolution Date</th>
            <th style="padding:20px 15px;font-weight:800;text-shadow:2px 2px 4px rgba(0,0,0,0.3);font-size:1.1rem;">💬 Resolution Feedback</th>
          </tr>
        </thead>
        <tbody id="issues-tbody"></tbody>
      </table>
    </div>
    <div id="issue-form-container" style="display:none;margin-top:20px;">
      <h4>Add New Issue</h4>
      <form id="issue-form" class="generic-form">
        <div class="form-group">
          <label for="issue-student-name">Student Name</label>
          <input type="text" id="issue-student-name" required>
        </div>
        <div class="form-group">
          <label for="issue-room-no">Room No</label>
          <input type="text" id="issue-room-no" required>
        </div>
        <div class="form-group">
          <label for="issue-description">Issue Description</label>
          <textarea id="issue-description" required rows="3"></textarea>
        </div>
        <div class="form-group">
          <label for="issue-status">Status</label>
          <select id="issue-status" required>
            <option value="pending">Pending</option>
            <option value="in-progress">In Progress</option>
            <option value="resolved">Resolved</option>
          </select>
        </div>
        <div class="form-group">
          <label for="issue-assigned-staff">Assigned Staff</label>
          <input type="text" id="issue-assigned-staff">
        </div>
        <div class="form-group">
          <label for="issue-resolution-date">Resolution Date</label>
          <input type="date" id="issue-resolution-date">
        </div>
        <div class="form-group full-width">
          <label for="issue-resolution-feedback">Resolution Feedback</label>
          <textarea id="issue-resolution-feedback" rows="3"></textarea>
        </div>
        <div class="form-group full-width">
          <button type="submit" class="btn-submit">Submit Issue</button>
          <button type="button" class="btn-view" id="cancel-issue-btn" style="margin-left:10px;">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</template>
<template id="financial-report-template">
  <div class="table-container">
    <!-- Dynamic Gradient Header -->
    <div style="background:linear-gradient(45deg,var(--gradient-7),var(--gradient-8),var(--gradient-9),var(--gradient-10),var(--gradient-11),var(--gradient-12),var(--gradient-1));background-size:400% 400%;animation:gradientShift 4s ease infinite;padding:30px;border-radius:20px;margin-bottom:25px;text-align:center;box-shadow:0 15px 35px rgba(0,0,0,0.2);">
      <h1 style="color:white;font-size:2.5rem;margin:0;text-shadow:2px 2px 8px rgba(0,0,0,0.3);font-weight:800;">📊 Income Expense Report</h1>
      <p style="color:rgba(255,255,255,0.9);font-size:1.2rem;margin:10px 0 0 0;text-shadow:1px 1px 4px rgba(0,0,0,0.2);">Financial Analysis & Insights</p>
    </div>
    <div style="margin:12px 0;display:flex;gap:12px;align-items:center;flex-wrap:wrap;background:linear-gradient(135deg,#e3f2fd,#f3e5f5);padding:15px;border-radius:15px;">
      <select id="report-period-filter" style="padding:10px 15px;border:2px solid #45b7d1;border-radius:10px;background:linear-gradient(135deg,#fff,#f0f9ff);font-weight:600;">
        <option value="monthly">Monthly</option>
        <option value="quarterly">Quarterly</option>
        <option value="yearly">Yearly</option>
        <option value="custom">Custom Range</option>
      </select>
      <input type="date" id="report-start-date" style="padding:10px 15px;border:2px solid #96ceb4;border-radius:10px;background:linear-gradient(135deg,#fff,#f0fdf4);">
      <input type="date" id="report-end-date" style="padding:10px 15px;border:2px solid #feca57;border-radius:10px;background:linear-gradient(135deg,#fff,#fffbeb);">
      <button class="btn-submit" id="refresh-report-btn" style="background:linear-gradient(135deg,#ff6b6b,#4ecdc4);border:none;padding:12px 20px;border-radius:10px;color:white;font-weight:600;box-shadow:0 6px 20px rgba(255,107,107,0.3);transition:all 0.3s ease;">🔄 Refresh Report</button>
      <button class="btn-view" id="export-financial-report-btn" style="background:linear-gradient(135deg,#45b7d1,#96ceb4);border:none;padding:12px 20px;border-radius:10px;color:white;font-weight:600;box-shadow:0 6px 20px rgba(69,183,209,0.3);transition:all 0.3s ease;">📤 Export Report</button>
    </div>
    
    <!-- Enhanced Financial Summary Cards -->
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:16px;margin:20px 0;">
      <div style="background:linear-gradient(135deg,#28a745,#20c997);padding:25px;border-radius:15px;color:white;box-shadow:0 10px 30px rgba(40,167,69,0.3);transition:all 0.3s ease;" onmouseover="this.style.transform='translateY(-8px)';this.style.boxShadow='0 20px 40px rgba(40,167,69,0.4)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 10px 30px rgba(40,167,69,0.3)'">
        <div style="font-size:1.8rem;font-weight:800;" id="total-revenue">PKR 0</div>
        <div style="opacity:0.9;font-size:1.1rem;font-weight:600;">💰 Total Revenue</div>
        <div style="font-size:0.9rem;opacity:0.8;margin-top:6px;" id="revenue-change">+0% from last period</div>
      </div>
      <div style="background:linear-gradient(135deg,#dc3545,#fd7e14);padding:25px;border-radius:15px;color:white;box-shadow:0 10px 30px rgba(220,53,69,0.3);transition:all 0.3s ease;" onmouseover="this.style.transform='translateY(-8px)';this.style.boxShadow='0 20px 40px rgba(220,53,69,0.4)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 10px 30px rgba(220,53,69,0.3)'">
        <div style="font-size:1.8rem;font-weight:800;" id="total-expenses">PKR 0</div>
        <div style="opacity:0.9;font-size:1.1rem;font-weight:600;">💸 Total Expenses</div>
        <div style="font-size:0.9rem;opacity:0.8;margin-top:6px;" id="expense-change">+0% from last period</div>
      </div>
      <div style="background:linear-gradient(135deg,#17a2b8,#6f42c1);padding:25px;border-radius:15px;color:white;box-shadow:0 10px 30px rgba(23,162,184,0.3);transition:all 0.3s ease;" onmouseover="this.style.transform='translateY(-8px)';this.style.boxShadow='0 20px 40px rgba(23,162,184,0.4)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 10px 30px rgba(23,162,184,0.3)'">
        <div style="font-size:1.8rem;font-weight:800;" id="net-profit">PKR 0</div>
        <div style="opacity:0.9;font-size:1.1rem;font-weight:600;">📉 Net Profit/Loss</div>
        <div style="font-size:0.9rem;opacity:0.8;margin-top:6px;" id="profit-margin">0% margin</div>
      </div>
      <div style="background:linear-gradient(135deg,#ffc107,#fd7e14);padding:25px;border-radius:15px;color:white;box-shadow:0 10px 30px rgba(255,193,7,0.3);transition:all 0.3s ease;" onmouseover="this.style.transform='translateY(-8px)';this.style.boxShadow='0 20px 40px rgba(255,193,7,0.4)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 10px 30px rgba(255,193,7,0.3)'">
        <div style="font-size:1.8rem;font-weight:800;" id="cash-flow">PKR 0</div>
        <div style="opacity:0.9;font-size:1.1rem;font-weight:600;">💵 Cash Flow</div>
        <div style="font-size:0.9rem;opacity:0.8;margin-top:6px;" id="flow-status">Positive</div>
      </div>
    </div>
    
    <!-- Enhanced Charts Section -->
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin:20px 0;">
      <div style="background:linear-gradient(135deg,#fff 0%,#f8f9ff 100%);padding:25px;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,0.1);border:2px solid rgba(102,126,234,0.1);">
        <h4 style="margin-bottom:20px;color:#333;font-size:1.3rem;font-weight:700;display:flex;align-items:center;gap:10px;">📈 Monthly Cash Flow</h4>
        <canvas id="cashflow-chart" width="400" height="250"></canvas>
      </div>
      <div style="background:linear-gradient(135deg,#fff 0%,#fff5f5 100%);padding:25px;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,0.1);border:2px solid rgba(245,87,108,0.1);">
        <h4 style="margin-bottom:20px;color:#333;font-size:1.3rem;font-weight:700;display:flex;align-items:center;gap:10px;">⚖️ Income vs Expense</h4>
        <canvas id="comparison-chart" width="400" height="250"></canvas>
      </div>
    </div>
    
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin:20px 0;">
      <div style="background:linear-gradient(135deg,#fff 0%,#f0fdf4 100%);padding:25px;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,0.1);border:2px solid rgba(34,197,94,0.1);">
        <h4 style="margin-bottom:20px;color:#333;font-size:1.3rem;font-weight:700;display:flex;align-items:center;gap:10px;">🥧 Revenue Breakdown</h4>
        <canvas id="revenue-breakdown-chart" width="400" height="250"></canvas>
      </div>
      <div style="background:linear-gradient(135deg,#fff 0%,#fffbeb 100%);padding:25px;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,0.1);border:2px solid rgba(254,202,87,0.1);">
        <h4 style="margin-bottom:20px;color:#333;font-size:1.3rem;font-weight:700;display:flex;align-items:center;gap:10px;">📊 Expense Categories</h4>
        <canvas id="expense-breakdown-chart" width="400" height="250"></canvas>
      </div>
    </div>
    
    <!-- Enhanced Profit/Loss Statement -->
    <div style="background:linear-gradient(135deg,#fff 0%,#fdf4ff 100%);padding:25px;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,0.1);margin:20px 0;border:2px solid rgba(139,92,246,0.1);">
      <h4 style="margin-bottom:20px;color:#333;font-size:1.4rem;font-weight:700;display:flex;align-items:center;gap:10px;">📉 Profit & Loss Statement</h4>
      <div style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);padding:3px;border-radius:15px;box-shadow:0 8px 25px rgba(0,0,0,0.15);">
        <table style="width:100%;border-collapse:separate;border-spacing:0;background:white;border-radius:12px;overflow:hidden;font-size:.95rem">
          <thead>
            <tr style="background:linear-gradient(45deg,#ff6b6b,#4ecdc4,#45b7d1,#96ceb4,#feca57);background-size:300% 300%;animation:gradientShift 3s ease infinite;color:white;">
              <th style="padding:18px 15px;font-weight:800;text-shadow:2px 2px 4px rgba(0,0,0,0.3);font-size:1.05rem;">📂 Category</th>
              <th style="padding:18px 15px;font-weight:800;text-shadow:2px 2px 4px rgba(0,0,0,0.3);font-size:1.05rem;">📅 Current Period</th>
              <th style="padding:18px 15px;font-weight:800;text-shadow:2px 2px 4px rgba(0,0,0,0.3);font-size:1.05rem;">📆 Previous Period</th>
              <th style="padding:18px 15px;font-weight:800;text-shadow:2px 2px 4px rgba(0,0,0,0.3);font-size:1.05rem;">🔄 Change</th>
              <th style="padding:18px 15px;font-weight:800;text-shadow:2px 2px 4px rgba(0,0,0,0.3);font-size:1.05rem;">📈 % Change</th>
            </tr>
          </thead>
          <tbody id="profit-loss-tbody"></tbody>
        </table>
      </div>
    </div>
    
    <!-- Enhanced Financial Analysis -->
    <div style="background:linear-gradient(135deg,#fff 0%,#f0f9ff 100%);padding:25px;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,0.1);margin:20px 0;border:2px solid rgba(59,130,246,0.1);">
      <h4 style="margin-bottom:20px;color:#333;font-size:1.4rem;font-weight:700;display:flex;align-items:center;gap:10px;">🔍 Detailed Financial Analysis</h4>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;">
        <div style="padding:20px;background:linear-gradient(135deg,#e3f2fd,#bbdefb);border-radius:12px;box-shadow:0 6px 20px rgba(25,118,210,0.2);transition:all 0.3s ease;" onmouseover="this.style.transform='translateY(-5px)';this.style.boxShadow='0 12px 30px rgba(25,118,210,0.3)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 6px 20px rgba(25,118,210,0.2)'">
          <div style="font-weight:800;color:#1976d2;font-size:1.3rem;" id="avg-monthly-income">PKR 0</div>
          <div style="color:#666;font-size:1rem;font-weight:600;margin-top:5px;">📈 Avg Monthly Income</div>
        </div>
        <div style="padding:20px;background:linear-gradient(135deg,#fce4ec,#f8bbd9);border-radius:12px;box-shadow:0 6px 20px rgba(194,24,91,0.2);transition:all 0.3s ease;" onmouseover="this.style.transform='translateY(-5px)';this.style.boxShadow='0 12px 30px rgba(194,24,91,0.3)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 6px 20px rgba(194,24,91,0.2)'">
          <div style="font-weight:800;color:#c2185b;font-size:1.3rem;" id="avg-monthly-expense">PKR 0</div>
          <div style="color:#666;font-size:1rem;font-weight:600;margin-top:5px;">📉 Avg Monthly Expense</div>
        </div>
        <div style="padding:20px;background:linear-gradient(135deg,#e8f5e8,#c8e6c9);border-radius:12px;box-shadow:0 6px 20px rgba(56,142,60,0.2);transition:all 0.3s ease;" onmouseover="this.style.transform='translateY(-5px)';this.style.boxShadow='0 12px 30px rgba(56,142,60,0.3)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 6px 20px rgba(56,142,60,0.2)'">
          <div style="font-weight:800;color:#388e3c;font-size:1.3rem;" id="highest-income-month">-</div>
          <div style="color:#666;font-size:1rem;font-weight:600;margin-top:5px;">🏆 Highest Income Month</div>
        </div>
        <div style="padding:20px;background:linear-gradient(135deg,#fff3e0,#ffcc02);border-radius:12px;box-shadow:0 6px 20px rgba(245,124,0,0.2);transition:all 0.3s ease;" onmouseover="this.style.transform='translateY(-5px)';this.style.boxShadow='0 12px 30px rgba(245,124,0,0.3)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 6px 20px rgba(245,124,0,0.2)'">
          <div style="font-weight:800;color:#f57c00;font-size:1.3rem;" id="expense-ratio">0%</div>
          <div style="color:#666;font-size:1rem;font-weight:600;margin-top:5px;">📊 Expense Ratio</div>
        </div>
      </div>
    </div>
  </div>
</template>
<template id="news-template">
  <div class="table-container">
    <!-- Dynamic Gradient Header -->
    <div style="background:linear-gradient(45deg,var(--gradient-7),var(--gradient-8),var(--gradient-9),var(--gradient-10),var(--gradient-11),var(--gradient-12),var(--gradient-1));background-size:400% 400%;animation:gradientShift 4s ease infinite;padding:30px;border-radius:20px;margin-bottom:25px;text-align:center;box-shadow:0 15px 35px rgba(0,0,0,0.2);">
      <h1 style="color:white;font-size:2.5rem;margin:0;text-shadow:2px 2px 8px rgba(0,0,0,0.3);font-weight:800;">📰 Taza Khabar</h1>
      <p style="color:rgba(255,255,255,0.9);font-size:1.2rem;margin:10px 0 0 0;text-shadow:1px 1px 4px rgba(0,0,0,0.2);">News & Announcements</p>
    </div>
    
    <div style="margin:12px 0;display:flex;gap:12px;align-items:center;flex-wrap:wrap;background:linear-gradient(135deg,#e3f2fd,#f3e5f5);padding:15px;border-radius:15px;">
      <button class="btn-submit" id="add-news-btn" style="background:linear-gradient(135deg,#ff6b6b,#4ecdc4);border:none;padding:12px 20px;border-radius:10px;color:white;font-weight:600;box-shadow:0 6px 20px rgba(255,107,107,0.3);transition:all 0.3s ease;">➕ Add New Entry</button>
      <input type="text" id="news-search" class="search-input" placeholder="🔍 Search by description or purchased by" style="border:2px solid #45b7d1;border-radius:10px;padding:10px 15px;background:linear-gradient(135deg,#fff,#f0f9ff);">
      <select id="news-status-filter" style="padding:10px 15px;border:2px solid #96ceb4;border-radius:10px;background:linear-gradient(135deg,#fff,#f0fdf4);font-weight:600;">
        <option value="all">All Status</option>
        <option value="paid">Paid</option>
        <option value="due">Due</option>
      </select>
    </div>
    
    <!-- Vibrant News Table -->
    <div style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);padding:3px;border-radius:20px;box-shadow:0 15px 35px rgba(0,0,0,0.2);">
      <table style="width:100%;border-collapse:separate;border-spacing:0;background:white;border-radius:17px;overflow:hidden;font-size:.95rem">
        <thead>
          <tr style="background:linear-gradient(45deg,#ff6b6b,#4ecdc4,#45b7d1,#96ceb4,#feca57);background-size:300% 300%;animation:gradientShift 3s ease infinite;color:white;">
            <th style="padding:20px 15px;font-weight:800;text-shadow:2px 2px 4px rgba(0,0,0,0.3);font-size:1.1rem;">📅 Date</th>
            <th style="padding:20px 15px;font-weight:800;text-shadow:2px 2px 4px rgba(0,0,0,0.3);font-size:1.1rem;">⏰ Time</th>
            <th style="padding:20px 15px;font-weight:800;text-shadow:2px 2px 4px rgba(0,0,0,0.3);font-size:1.1rem;">📝 Description</th>
            <th style="padding:20px 15px;font-weight:800;text-shadow:2px 2px 4px rgba(0,0,0,0.3);font-size:1.1rem;">🛍️ Purchased By</th>
            <th style="padding:20px 15px;font-weight:800;text-shadow:2px 2px 4px rgba(0,0,0,0.3);font-size:1.1rem;">💬 Remarks</th>
            <th style="padding:20px 15px;font-weight:800;text-shadow:2px 2px 4px rgba(0,0,0,0.3);font-size:1.1rem;">💰 Paid/Due</th>
          </tr>
        </thead>
        <tbody id="news-tbody"></tbody>
      </table>
    </div>
    
    <!-- Add News Form -->
    <div id="news-form-container" style="display:none;margin-top:20px;">
      <h4>Add New Entry</h4>
      <form id="news-form" class="generic-form">
        <div class="form-group">
          <label for="news-date">Date</label>
          <input type="date" id="news-date" required>
        </div>
        <div class="form-group">
          <label for="news-time">Time</label>
          <input type="time" id="news-time" required>
        </div>
        <div class="form-group full-width">
          <label for="news-description">Description</label>
          <textarea id="news-description" required rows="3" placeholder="Enter detailed description"></textarea>
        </div>
        <div class="form-group">
          <label for="news-purchased-by">Purchased By</label>
          <input type="text" id="news-purchased-by" required placeholder="Name of purchaser">
        </div>
        <div class="form-group full-width">
          <label for="news-remarks">Remarks</label>
          <textarea id="news-remarks" rows="2" placeholder="Additional remarks or notes"></textarea>
        </div>
        <div class="form-group">
          <label for="news-status">Paid/Due</label>
          <select id="news-status" required>
            <option value="paid">Paid</option>
            <option value="due">Due</option>
          </select>
        </div>
        <div class="form-group full-width">
          <button type="submit" class="btn-submit">Save Entry</button>
          <button type="button" class="btn-view" id="cancel-news-btn" style="margin-left:10px;">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</template>

<!-- MESS MENU TEMPLATE -->
<template id="mess-menu-template">
  <div class="table-container">
    <!-- Dynamic Gradient Header -->
    <div style="background:linear-gradient(45deg,var(--gradient-7),var(--gradient-8),var(--gradient-9),var(--gradient-10),var(--gradient-11),var(--gradient-12),var(--gradient-1));background-size:400% 400%;animation:gradientShift 4s ease infinite;padding:30px;border-radius:20px;margin-bottom:25px;text-align:center;box-shadow:0 15px 35px rgba(0,0,0,0.2);">
      <h1 style="color:white;font-size:2.5rem;margin:0;text-shadow:2px 2px 8px rgba(0,0,0,0.3);font-weight:800;">🍽️ Mess Menu</h1>
      <p style="color:rgba(255,255,255,0.9);font-size:1.2rem;margin:10px 0 0 0;text-shadow:1px 1px 4px rgba(0,0,0,0.2);">Delicious Daily Meals</p>
    </div>
    
    <div id="admin-mess-controls" style="margin:12px 0;display:flex;gap:12px;align-items:center;flex-wrap:wrap">
      <button class="btn-submit" id="edit-menu-btn" style="background:linear-gradient(135deg,#ff6b6b,#4ecdc4);border:none;padding:12px 20px;border-radius:10px;color:white;font-weight:600;box-shadow:0 6px 20px rgba(255,107,107,0.3);transition:all 0.3s ease;">✏️ Edit Menu</button>
      <button class="btn-view" id="view-menu-btn" style="background:linear-gradient(135deg,#45b7d1,#96ceb4);border:none;padding:12px 20px;border-radius:10px;color:white;font-weight:600;box-shadow:0 6px 20px rgba(69,183,209,0.3);transition:all 0.3s ease;">👀 View Only</button>
    </div>
    
    <div id="mess-menu-content">
      <!-- Vibrant Menu Table -->
      <div style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);padding:3px;border-radius:20px;box-shadow:0 15px 35px rgba(0,0,0,0.2);">
        <table style="width:100%;border-collapse:separate;border-spacing:0;background:white;border-radius:17px;overflow:hidden;font-size:.95rem">
          <thead>
            <tr style="background:linear-gradient(45deg,#ff6b6b,#4ecdc4,#45b7d1,#96ceb4,#feca57);background-size:300% 300%;animation:gradientShift 3s ease infinite;color:white;">
              <th style="padding:20px 15px;font-weight:800;text-shadow:2px 2px 4px rgba(0,0,0,0.3);font-size:1.1rem;">📅 Day</th>
              <th style="padding:20px 15px;font-weight:800;text-shadow:2px 2px 4px rgba(0,0,0,0.3);font-size:1.1rem;">🌅 Breakfast</th>
              <th style="padding:20px 15px;font-weight:800;text-shadow:2px 2px 4px rgba(0,0,0,0.3);font-size:1.1rem;">☀️ Lunch</th>
              <th style="padding:20px 15px;font-weight:800;text-shadow:2px 2px 4px rgba(0,0,0,0.3);font-size:1.1rem;">🌙 Dinner</th>
            </tr>
          </thead>
          <tbody id="mess-menu-tbody">
            <tr style="background:linear-gradient(135deg,#fff5f5,#ffe0e6);transition:all 0.3s ease;" onmouseover="this.style.background='linear-gradient(135deg,#ff6b6b,#4ecdc4)';this.style.color='white';this.style.transform='scale(1.02)'" onmouseout="this.style.background='linear-gradient(135deg,#fff5f5,#ffe0e6)';this.style.color='#333';this.style.transform='scale(1)'">
              <td style="padding:15px;font-weight:700;color:#ff6b6b;font-size:1.1rem;">Monday</td>
              <td style="padding:15px;"><span class="menu-item" data-day="monday" data-meal="breakfast" style="background:linear-gradient(135deg,#feca57,#ff9ff3);color:white;padding:8px 12px;border-radius:20px;font-weight:600;box-shadow:0 4px 15px rgba(254,202,87,0.3);display:inline-block;transition:all 0.3s ease;">Namkeen Chayee + Paratha</span></td>
              <td style="padding:15px;"><span class="menu-item" data-day="monday" data-meal="lunch" style="background:linear-gradient(135deg,#54a0ff,#5f27cd);color:white;padding:8px 12px;border-radius:20px;font-weight:600;box-shadow:0 4px 15px rgba(84,160,255,0.3);display:inline-block;transition:all 0.3s ease;">Mix Sazbzi + Roti</span></td>
              <td style="padding:15px;"><span class="menu-item" data-day="monday" data-meal="dinner" style="background:linear-gradient(135deg,#00d2d3,#54a0ff);color:white;padding:8px 12px;border-radius:20px;font-weight:600;box-shadow:0 4px 15px rgba(0,210,211,0.3);display:inline-block;transition:all 0.3s ease;">Daal Chawal</span></td>
            </tr>
            <tr style="background:linear-gradient(135deg,#f0f9ff,#e0f2fe);transition:all 0.3s ease;" onmouseover="this.style.background='linear-gradient(135deg,#4ecdc4,#45b7d1)';this.style.color='white';this.style.transform='scale(1.02)'" onmouseout="this.style.background='linear-gradient(135deg,#f0f9ff,#e0f2fe)';this.style.color='#333';this.style.transform='scale(1)'">
              <td style="padding:15px;font-weight:700;color:#4ecdc4;font-size:1.1rem;">Tuesday</td>
              <td style="padding:15px;"><span class="menu-item" data-day="tuesday" data-meal="breakfast" style="background:linear-gradient(135deg,#ff9ff3,#feca57);color:white;padding:8px 12px;border-radius:20px;font-weight:600;box-shadow:0 4px 15px rgba(255,159,243,0.3);display:inline-block;transition:all 0.3s ease;">Namkeen Chayee + Paratha</span></td>
              <td style="padding:15px;"><span class="menu-item" data-day="tuesday" data-meal="lunch" style="background:linear-gradient(135deg,#5f27cd,#54a0ff);color:white;padding:8px 12px;border-radius:20px;font-weight:600;box-shadow:0 4px 15px rgba(95,39,205,0.3);display:inline-block;transition:all 0.3s ease;">Lobia + Roti</span></td>
              <td style="padding:15px;"><span class="menu-item" data-day="tuesday" data-meal="dinner" style="background:linear-gradient(135deg,#54a0ff,#00d2d3);color:white;padding:8px 12px;border-radius:20px;font-weight:600;box-shadow:0 4px 15px rgba(84,160,255,0.3);display:inline-block;transition:all 0.3s ease;">Aloo Roti</span></td>
            </tr>
            <tr style="background:linear-gradient(135deg,#f0fdf4,#dcfce7);transition:all 0.3s ease;" onmouseover="this.style.background='linear-gradient(135deg,#45b7d1,#96ceb4)';this.style.color='white';this.style.transform='scale(1.02)'" onmouseout="this.style.background='linear-gradient(135deg,#f0fdf4,#dcfce7)';this.style.color='#333';this.style.transform='scale(1)'">
              <td style="padding:15px;font-weight:700;color:#45b7d1;font-size:1.1rem;">Wednesday</td>
              <td style="padding:15px;"><span class="menu-item" data-day="wednesday" data-meal="breakfast" style="background:linear-gradient(135deg,#feca57,#ff6b6b);color:white;padding:8px 12px;border-radius:20px;font-weight:600;box-shadow:0 4px 15px rgba(254,202,87,0.3);display:inline-block;transition:all 0.3s ease;">Namkeen Chayee + Paratha</span></td>
              <td style="padding:15px;"><span class="menu-item" data-day="wednesday" data-meal="lunch" style="background:linear-gradient(135deg,#54a0ff,#ff9ff3);color:white;padding:8px 12px;border-radius:20px;font-weight:600;box-shadow:0 4px 15px rgba(84,160,255,0.3);display:inline-block;transition:all 0.3s ease;">Daal Masoor + Roti</span></td>
              <td style="padding:15px;"><span class="menu-item" data-day="wednesday" data-meal="dinner" style="background:linear-gradient(135deg,#00d2d3,#5f27cd);color:white;padding:8px 12px;border-radius:20px;font-weight:600;box-shadow:0 4px 15px rgba(0,210,211,0.3);display:inline-block;transition:all 0.3s ease;">Ghosht Chawal</span></td>
            </tr>
            <tr style="background:linear-gradient(135deg,#fefce8,#fef3c7);transition:all 0.3s ease;" onmouseover="this.style.background='linear-gradient(135deg,#96ceb4,#feca57)';this.style.color='white';this.style.transform='scale(1.02)'" onmouseout="this.style.background='linear-gradient(135deg,#fefce8,#fef3c7)';this.style.color='#333';this.style.transform='scale(1)'">
              <td style="padding:15px;font-weight:700;color:#96ceb4;font-size:1.1rem;">Thursday</td>
              <td style="padding:15px;"><span class="menu-item" data-day="thursday" data-meal="breakfast" style="background:linear-gradient(135deg,#ff9ff3,#54a0ff);color:white;padding:8px 12px;border-radius:20px;font-weight:600;box-shadow:0 4px 15px rgba(255,159,243,0.3);display:inline-block;transition:all 0.3s ease;">Namkeen Chayee + Paratha</span></td>
              <td style="padding:15px;"><span class="menu-item" data-day="thursday" data-meal="lunch" style="background:linear-gradient(135deg,#5f27cd,#00d2d3);color:white;padding:8px 12px;border-radius:20px;font-weight:600;box-shadow:0 4px 15px rgba(95,39,205,0.3);display:inline-block;transition:all 0.3s ease;">Channa Dal + Roti</span></td>
              <td style="padding:15px;"><span class="menu-item" data-day="thursday" data-meal="dinner" style="background:linear-gradient(135deg,#54a0ff,#feca57);color:white;padding:8px 12px;border-radius:20px;font-weight:600;box-shadow:0 4px 15px rgba(84,160,255,0.3);display:inline-block;transition:all 0.3s ease;">Sabzi Roti</span></td>
            </tr>
            <tr style="background:linear-gradient(135deg,#fdf4ff,#fae8ff);transition:all 0.3s ease;" onmouseover="this.style.background='linear-gradient(135deg,#feca57,#ff9ff3)';this.style.color='white';this.style.transform='scale(1.02)'" onmouseout="this.style.background='linear-gradient(135deg,#fdf4ff,#fae8ff)';this.style.color='#333';this.style.transform='scale(1)'">
              <td style="padding:15px;font-weight:700;color:#feca57;font-size:1.1rem;">Friday</td>
              <td style="padding:15px;"><span class="menu-item" data-day="friday" data-meal="breakfast" style="background:linear-gradient(135deg,#54a0ff,#00d2d3);color:white;padding:8px 12px;border-radius:20px;font-weight:600;box-shadow:0 4px 15px rgba(84,160,255,0.3);display:inline-block;transition:all 0.3s ease;">Namkeen Chayee + Paratha</span></td>
              <td style="padding:15px;"><span class="menu-item" data-day="friday" data-meal="lunch" style="background:linear-gradient(135deg,#00d2d3,#ff9ff3);color:white;padding:8px 12px;border-radius:20px;font-weight:600;box-shadow:0 4px 15px rgba(0,210,211,0.3);display:inline-block;transition:all 0.3s ease;">Aloo Salan + Roti</span></td>
              <td style="padding:15px;"><span class="menu-item" data-day="friday" data-meal="dinner" style="background:linear-gradient(135deg,#feca57,#5f27cd);color:white;padding:8px 12px;border-radius:20px;font-weight:600;box-shadow:0 4px 15px rgba(254,202,87,0.3);display:inline-block;transition:all 0.3s ease;">Pulawo</span></td>
            </tr>
            <tr style="background:linear-gradient(135deg,#f8fafc,#e2e8f0);transition:all 0.3s ease;" onmouseover="this.style.background='linear-gradient(135deg,#ff9ff3,#54a0ff)';this.style.color='white';this.style.transform='scale(1.02)'" onmouseout="this.style.background='linear-gradient(135deg,#f8fafc,#e2e8f0)';this.style.color='#333';this.style.transform='scale(1)'">
              <td style="padding:15px;font-weight:700;color:#ff9ff3;font-size:1.1rem;">Saturday</td>
              <td style="padding:15px;"><span class="menu-item" data-day="saturday" data-meal="breakfast" style="background:linear-gradient(135deg,#00d2d3,#feca57);color:white;padding:8px 12px;border-radius:20px;font-weight:600;box-shadow:0 4px 15px rgba(0,210,211,0.3);display:inline-block;transition:all 0.3s ease;">Namkeen Chayee + Paratha</span></td>
              <td style="padding:15px;"><span class="menu-item" data-day="saturday" data-meal="lunch" style="background:linear-gradient(135deg,#ff9ff3,#5f27cd);color:white;padding:8px 12px;border-radius:20px;font-weight:600;box-shadow:0 4px 15px rgba(255,159,243,0.3);display:inline-block;transition:all 0.3s ease;">Daal + Roti</span></td>
              <td style="padding:15px;"><span class="menu-item" data-day="saturday" data-meal="dinner" style="background:linear-gradient(135deg,#5f27cd,#54a0ff);color:white;padding:8px 12px;border-radius:20px;font-weight:600;box-shadow:0 4px 15px rgba(95,39,205,0.3);display:inline-block;transition:all 0.3s ease;">Macroni/ Balay</span></td>
            </tr>
            <tr style="background:linear-gradient(135deg,#fffbeb,#fef3c7);transition:all 0.3s ease;" onmouseover="this.style.background='linear-gradient(135deg,#54a0ff,#00d2d3)';this.style.color='white';this.style.transform='scale(1.02)'" onmouseout="this.style.background='linear-gradient(135deg,#fffbeb,#fef3c7)';this.style.color='#333';this.style.transform='scale(1)'">
              <td style="padding:15px;font-weight:700;color:#54a0ff;font-size:1.1rem;">Sunday</td>
              <td style="padding:15px;"><span class="menu-item" data-day="sunday" data-meal="breakfast" style="background:linear-gradient(135deg,#feca57,#ff9ff3);color:white;padding:8px 12px;border-radius:20px;font-weight:600;box-shadow:0 4px 15px rgba(254,202,87,0.3);display:inline-block;transition:all 0.3s ease;">Namkeen Chayee + Paratha</span></td>
              <td style="padding:15px;"><span class="menu-item" data-day="sunday" data-meal="lunch" style="background:linear-gradient(135deg,#5f27cd,#feca57);color:white;padding:8px 12px;border-radius:20px;font-weight:600;box-shadow:0 4px 15px rgba(95,39,205,0.3);display:inline-block;transition:all 0.3s ease;">Cholay + Roti</span></td>
              <td style="padding:15px;"><span class="menu-item" data-day="sunday" data-meal="dinner" style="background:linear-gradient(135deg,#ff6b6b,#4ecdc4);color:white;padding:8px 12px;border-radius:20px;font-weight:600;box-shadow:0 4px 15px rgba(255,107,107,0.3);display:inline-block;transition:all 0.3s ease;font-size:1.1rem;font-weight:800;">🍗 Chiken Biryani Special</span></td>
            </tr>
          </tbody>
        </table>
      </div>
      
      <!-- Vibrant Footer Info -->
      <div style="background:linear-gradient(135deg,#667eea,#764ba2,#f093fb);padding:25px;border-radius:20px;margin-top:25px;text-align:center;color:white;box-shadow:0 15px 35px rgba(0,0,0,0.2);">
        <div style="background:rgba(255,255,255,0.1);padding:20px;border-radius:15px;backdrop-filter:blur(10px);">
          <p style="margin:0 0 15px 0;font-style:italic;font-size:1.1rem;text-shadow:1px 1px 3px rgba(0,0,0,0.3);">✨ Menu subject to change based on availability ✨</p>
          <div style="background:rgba(255,255,255,0.2);padding:15px;border-radius:12px;">
            <p style="margin:0;font-weight:700;font-size:1.2rem;text-shadow:1px 1px 3px rgba(0,0,0,0.3);">🕐 Meal Timings</p>
            <div style="display:flex;justify-content:space-around;margin-top:10px;flex-wrap:wrap;gap:10px;">
              <span style="background:rgba(255,255,255,0.2);padding:8px 15px;border-radius:20px;font-weight:600;">🌅 Breakfast: 7:00-8:00 AM</span>
              <span style="background:rgba(255,255,255,0.2);padding:8px 15px;border-radius:20px;font-weight:600;">☀️ Lunch: 2:00-2:30 PM</span>
              <span style="background:rgba(255,255,255,0.2);padding:8px 15px;border-radius:20px;font-weight:600;">🌙 Dinner: 9:00-9:30 PM</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<!-- STUDY MATERIALS TEMPLATE -->
<template id="study-materials-template">
  <div class="table-container">
    <!-- Dynamic Gradient Header -->
    <div style="background:linear-gradient(45deg,var(--gradient-7),var(--gradient-8),var(--gradient-9),var(--gradient-10),var(--gradient-11),var(--gradient-12),var(--gradient-1));background-size:400% 400%;animation:gradientShift 4s ease infinite;padding:30px;border-radius:20px;margin-bottom:25px;text-align:center;box-shadow:0 15px 35px rgba(0,0,0,0.2);">
      <h1 style="color:white;font-size:2.5rem;margin:0;text-shadow:2px 2px 8px rgba(0,0,0,0.3);font-weight:800;">📚 Study Materials & AI Help</h1>
      <p style="color:rgba(255,255,255,0.9);font-size:1.2rem;margin:10px 0 0 0;text-shadow:1px 1px 4px rgba(0,0,0,0.2);">Resources & AI Chat Support</p>
    </div>
    
    <!-- AI Chat Models Section -->
    <div style="background:linear-gradient(135deg,#fff 0%,#f0f9ff 100%);padding:25px;border-radius:20px;margin-bottom:30px;box-shadow:0 10px 30px rgba(0,0,0,0.1);border:2px solid rgba(59,130,246,0.1);">
      <h3 style="color:#333;margin-bottom:20px;font-size:1.4rem;font-weight:700;display:flex;align-items:center;gap:10px;">🤖 AI Chat Models - Get Instant Help</h3>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;">
        
        <!-- ChatGPT -->
        <div class="ai-chat-card" onclick="window.open('https://chat.openai.com', '_blank')" style="background:linear-gradient(135deg,#10a37f,#1a7f64);color:white;padding:25px;border-radius:15px;cursor:pointer;transition:all 0.3s ease;box-shadow:0 8px 25px rgba(16,163,127,0.3);">
          <div style="font-size:2.5rem;margin-bottom:15px;">💬</div>
          <h4 style="margin:0 0 10px 0;font-size:1.3rem;font-weight:700;">ChatGPT</h4>
          <p style="margin:0;opacity:0.9;font-size:0.95rem;line-height:1.4;">Advanced AI for homework help, explanations, and problem-solving</p>
        </div>
        
        <!-- Claude -->
        <div class="ai-chat-card" onclick="window.open('https://claude.ai', '_blank')" style="background:linear-gradient(135deg,#cc785c,#d4926f);color:white;padding:25px;border-radius:15px;cursor:pointer;transition:all 0.3s ease;box-shadow:0 8px 25px rgba(204,120,92,0.3);">
          <div style="font-size:2.5rem;margin-bottom:15px;">🧠</div>
          <h4 style="margin:0 0 10px 0;font-size:1.3rem;font-weight:700;">Claude</h4>
          <p style="margin:0;opacity:0.9;font-size:0.95rem;line-height:1.4;">Helpful AI assistant for research, writing, and analysis</p>
        </div>
        
        <!-- Gemini -->
        <div class="ai-chat-card" onclick="window.open('https://gemini.google.com', '_blank')" style="background:linear-gradient(135deg,#4285f4,#34a853);color:white;padding:25px;border-radius:15px;cursor:pointer;transition:all 0.3s ease;box-shadow:0 8px 25px rgba(66,133,244,0.3);">
          <div style="font-size:2.5rem;margin-bottom:15px;">✨</div>
          <h4 style="margin:0 0 10px 0;font-size:1.3rem;font-weight:700;">Google Gemini</h4>
          <p style="margin:0;opacity:0.9;font-size:0.95rem;line-height:1.4;">Google's AI for creative tasks and complex reasoning</p>
        </div>
        
        <!-- Perplexity -->
        <div class="ai-chat-card" onclick="window.open('https://perplexity.ai', '_blank')" style="background:linear-gradient(135deg,#20b2aa,#40e0d0);color:white;padding:25px;border-radius:15px;cursor:pointer;transition:all 0.3s ease;box-shadow:0 8px 25px rgba(32,178,170,0.3);">
          <div style="font-size:2.5rem;margin-bottom:15px;">🔍</div>
          <h4 style="margin:0 0 10px 0;font-size:1.3rem;font-weight:700;">Perplexity</h4>
          <p style="margin:0;opacity:0.9;font-size:0.95rem;line-height:1.4;">AI-powered search and research assistant</p>
        </div>
        
        <!-- Microsoft Copilot -->
        <div class="ai-chat-card" onclick="window.open('https://copilot.microsoft.com', '_blank')" style="background:linear-gradient(135deg,#0078d4,#106ebe);color:white;padding:25px;border-radius:15px;cursor:pointer;transition:all 0.3s ease;box-shadow:0 8px 25px rgba(0,120,212,0.3);">
          <div style="font-size:2.5rem;margin-bottom:15px;">🚀</div>
          <h4 style="margin:0 0 10px 0;font-size:1.3rem;font-weight:700;">Microsoft Copilot</h4>
          <p style="margin:0;opacity:0.9;font-size:0.95rem;line-height:1.4;">AI companion for productivity and learning</p>
        </div>
        
        <!-- You.com -->
        <div class="ai-chat-card" onclick="window.open('https://you.com', '_blank')" style="background:linear-gradient(135deg,#8b5cf6,#a78bfa);color:white;padding:25px;border-radius:15px;cursor:pointer;transition:all 0.3s ease;box-shadow:0 8px 25px rgba(139,92,246,0.3);">
          <div style="font-size:2.5rem;margin-bottom:15px;">🌐</div>
          <h4 style="margin:0 0 10px 0;font-size:1.3rem;font-weight:700;">You.com</h4>
          <p style="margin:0;opacity:0.9;font-size:0.95rem;line-height:1.4;">AI search engine with personalized results</p>
        </div>
        
      </div>
    </div>
    
    <div id="admin-materials-controls" style="margin:12px 0;display:flex;gap:12px;align-items:center;flex-wrap:wrap;background:linear-gradient(135deg,#e3f2fd,#f3e5f5);padding:15px;border-radius:15px;">
      <button class="btn-submit" id="add-material-btn" style="background:linear-gradient(135deg,#ff6b6b,#4ecdc4);border:none;padding:12px 20px;border-radius:10px;color:white;font-weight:600;box-shadow:0 6px 20px rgba(255,107,107,0.3);transition:all 0.3s ease;">📚 Add Study Material</button>
      <button class="btn-view" id="add-link-btn" style="background:linear-gradient(135deg,#45b7d1,#96ceb4);border:none;padding:12px 20px;border-radius:10px;color:white;font-weight:600;box-shadow:0 6px 20px rgba(69,183,209,0.3);transition:all 0.3s ease;">🔗 Add Website Link</button>
    </div>
    
    <div id="materials-grid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:20px;margin:20px 0;"></div>
    
    <div id="material-form-container" style="display:none;margin-top:20px;background:linear-gradient(135deg,#fff 0%,#fdf4ff 100%);padding:25px;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,0.1);border:2px solid rgba(139,92,246,0.1);">
      <h4 style="color:#333;font-size:1.3rem;font-weight:700;margin-bottom:20px;">📚 Add Study Material</h4>
      <form id="material-form" class="generic-form">
        <div class="form-group">
          <label for="material-title">Title</label>
          <input type="text" id="material-title" required style="border:2px solid #8b5cf6;border-radius:8px;">
        </div>
        <div class="form-group">
          <label for="material-type">Type</label>
          <select id="material-type" required style="border:2px solid #8b5cf6;border-radius:8px;">
            <option value="link">Website Link</option>
            <option value="file">File Upload</option>
          </select>
        </div>
        <div class="form-group" id="link-group">
          <label for="material-link">Website URL</label>
          <input type="url" id="material-link" style="border:2px solid #8b5cf6;border-radius:8px;">
        </div>
        <div class="form-group" id="file-group" style="display:none;">
          <label for="material-file">Upload File</label>
          <input type="file" id="material-file" style="border:2px solid #8b5cf6;border-radius:8px;">
        </div>
        <div class="form-group full-width">
          <label for="material-description">Description</label>
          <textarea id="material-description" rows="3" style="border:2px solid #8b5cf6;border-radius:8px;"></textarea>
        </div>
        <div class="form-group full-width">
          <button type="submit" class="btn-submit">Save Material</button>
          <button type="button" class="btn-view" id="cancel-material-btn" style="margin-left:10px;">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</template>

<!-- HELP DESK TEMPLATE -->
<template id="help-desk-template">
  <div class="table-container">
    <h3>Help Desk</h3>
    <div id="student-help-controls" style="margin:12px 0;display:flex;gap:12px;align-items:center;flex-wrap:wrap">
      <button class="btn-submit" id="new-help-request-btn">New Request</button>
    </div>
    <table class="data-table" style="font-size:.95rem">
      <thead>
        <tr>
          <th>Request ID</th>
          <th class="admin-only-col">Student Name</th>
          <th>Subject</th>
          <th>Date</th>
          <th>Status</th>
          <th>Admin Reply</th>
        </tr>
      </thead>
      <tbody id="help-requests-tbody"></tbody>
    </table>
    <div id="help-form-container" style="display:none;margin-top:20px;">
      <h4>New Help Request</h4>
      <form id="help-form" class="generic-form">
        <div class="form-group">
          <label for="help-subject">Subject</label>
          <input type="text" id="help-subject" required>
        </div>
        <div class="form-group full-width">
          <label for="help-message">Message (Confidential)</label>
          <textarea id="help-message" required rows="5" placeholder="Your message will only be visible to admin"></textarea>
        </div>
        <div class="form-group full-width">
          <button type="submit" class="btn-submit">Submit Request</button>
          <button type="button" class="btn-view" id="cancel-help-btn" style="margin-left:10px;">Cancel</button>
        </div>
      </form>
    </div>
    <div id="admin-reply-container" style="display:none;margin-top:20px;">
      <h4>Reply to Request</h4>
      <form id="reply-form" class="generic-form">
        <div class="form-group full-width">
          <label for="admin-reply">Admin Reply</label>
          <textarea id="admin-reply" required rows="4"></textarea>
        </div>
        <div class="form-group full-width">
          <button type="submit" class="btn-submit">Send Reply</button>
          <button type="button" class="btn-view" id="cancel-reply-btn" style="margin-left:10px;">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</template>

<!-- SOCIAL MEDIA TEMPLATE -->
<template id="feedback-template">
  <div class="table-container">
    <!-- Dynamic Gradient Header -->
    <div style="background:linear-gradient(45deg,var(--gradient-10),var(--gradient-7),var(--gradient-4),var(--gradient-1),var(--gradient-8),var(--gradient-11),var(--gradient-5));background-size:400% 400%;animation:gradientShift 5s ease infinite;padding:40px;border-radius:25px;margin-bottom:35px;text-align:center;box-shadow:0 20px 40px rgba(0,0,0,0.2);">
      <h1 style="color:white;font-size:3rem;margin-bottom:15px;text-shadow:3px 3px 10px rgba(0,0,0,0.4);font-weight:900;">📝 Feedback & Reviews</h1>
      <p style="color:rgba(255,255,255,0.95);font-size:1.4rem;opacity:0.95;text-shadow:2px 2px 6px rgba(0,0,0,0.3);font-weight:600;">Share your experience and help us improve</p>
    </div>
    <div style="background:linear-gradient(135deg,#fff 0%,#f0fdf4 100%);padding:35px;border-radius:20px;margin-bottom:35px;box-shadow:0 15px 35px rgba(0,0,0,0.12);border:2px solid rgba(34,197,94,0.1);">
      <h2 style="color:#333;margin-bottom:25px;font-size:1.6rem;font-weight:800;display:flex;align-items:center;gap:12px;">✍️ Write a Review</h2>
      <form id="review-form" class="generic-form">
        <div class="form-group">
          <label>Category</label>
          <select id="category" required>
            <option value="">Select Category</option>
            <option value="food">Food Quality</option>
            <option value="cleanliness">Cleanliness</option>
            <option value="staff">Staff Behavior</option>
            <option value="facilities">Facilities</option>
            <option value="security">Security</option>
            <option value="overall">Overall Experience</option>
          </select>
        </div>
        <div class="form-group">
          <label>Rating</label>
          <div style="display: flex; align-items: center; gap: 10px;">
            <div id="rating-stars" style="display: flex; gap: 5px;">
              <span class="star" data-rating="1" style="font-size: 30px; color: #ddd; cursor: pointer;">★</span>
              <span class="star" data-rating="2" style="font-size: 30px; color: #ddd; cursor: pointer;">★</span>
              <span class="star" data-rating="3" style="font-size: 30px; color: #ddd; cursor: pointer;">★</span>
              <span class="star" data-rating="4" style="font-size: 30px; color: #ddd; cursor: pointer;">★</span>
              <span class="star" data-rating="5" style="font-size: 30px; color: #ddd; cursor: pointer;">★</span>
            </div>
            <span id="rating-text">Select Rating</span>
          </div>
        </div>
        <div class="form-group">
          <label>Review Title</label>
          <input type="text" id="title" placeholder="Brief title for your review" required>
        </div>
        <div class="form-group full-width">
          <label>Your Review</label>
          <textarea id="review" placeholder="Share your detailed experience..." required rows="4"></textarea>
        </div>
        <div class="form-group full-width">
          <button type="submit" class="btn-submit">Submit Review</button>
        </div>
      </form>
    </div>
    <div id="reviews-container" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px;"></div>
  </div>
</template>

<template id="rules-template">
  <div class="table-container">
    <!-- Dynamic Gradient Header -->
    <div style="background:linear-gradient(45deg,var(--gradient-7),var(--gradient-8),var(--gradient-9),var(--gradient-10),var(--gradient-11),var(--gradient-12),var(--gradient-1));background-size:400% 400%;animation:gradientShift 4s ease infinite;padding:clamp(25px,6vw,45px);border-radius:25px;margin-bottom:35px;text-align:center;box-shadow:0 20px 40px rgba(0,0,0,0.25);">
      <h1 style="color:white;font-size:clamp(2rem,7vw,3.5rem);margin-bottom:20px;text-shadow:3px 3px 12px rgba(0,0,0,0.4);font-weight:900;">📋 Hostel Rules & Regulations</h1>
      <p style="color:rgba(255,255,255,0.95);font-size:clamp(1.1rem,3.5vw,1.5rem);opacity:0.95;text-shadow:2px 2px 6px rgba(0,0,0,0.3);font-weight:600;">Please read and follow all rules for harmonious living</p>
    </div>
    
    <div id="admin-rules-controls" style="margin-bottom: 20px; display: none;">
      <button class="btn-submit" id="add-rule-btn">Add Rule</button>
      <button class="btn-view" id="upload-pdf-btn" style="margin-left: 10px;">Upload PDF Rules</button>
      <input type="file" id="pdf-upload" accept=".pdf" style="display: none;">
    </div>
    
    <div id="pdf-viewer" style="display: none; margin-bottom: 20px;">
      <iframe id="pdf-frame" style="width: 100%; height: 600px; border: none; border-radius: 10px;"></iframe>
      <div id="admin-pdf-controls" style="margin-top: 10px; display: none;">
        <button class="btn-view" id="remove-pdf-btn">Remove PDF</button>
      </div>
    </div>
    
    <div id="rules-content">
      <div id="general-rules" data-section="general">
        <div style="background: white; border-radius: 20px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.15);">
          <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%); color: white; padding: clamp(15px, 4vw, 25px); text-align: center; position: relative;">
            <h3 style="font-size: clamp(1.2rem, 4vw, 1.6rem); margin: 0;">🏠 General Rules</h3>
            <button class="admin-only add-rule-section-btn" data-section="general" style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.2); border: none; color: white; padding: 5px 10px; border-radius: 5px; cursor: pointer; display: none;">+ Add</button>
          </div>
          <div class="rules-list" id="general-rules-list"></div>
        </div>
      </div>
      
      <div id="timing-rules" data-section="timing" style="margin-top: 25px;">
        <div style="background: white; border-radius: 20px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.15);">
          <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 50%, #ff9a9e 100%); color: white; padding: clamp(15px, 4vw, 25px); text-align: center; position: relative;">
            <h3 style="font-size: clamp(1.2rem, 4vw, 1.6rem); margin: 0;">⏰ Timing Rules</h3>
            <button class="admin-only add-rule-section-btn" data-section="timing" style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.2); border: none; color: white; padding: 5px 10px; border-radius: 5px; cursor: pointer; display: none;">+ Add</button>
          </div>
          <div class="rules-list" id="timing-rules-list"></div>
        </div>
      </div>
      
      <div style="background: linear-gradient(135deg, #ffd89b 0%, #19547b 50%, #667eea 100%); color: white; padding: clamp(20px, 5vw, 30px); border-radius: 20px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2); margin-top: 25px;">
        <h3 style="margin-bottom: 15px; font-size: clamp(1.3rem, 4vw, 1.7rem);">⚠️ Important Notice</h3>
        <p style="margin: 0; font-size: clamp(14px, 3.5vw, 16px); line-height: 1.6;">Violation of any rules may result in warnings, fines, or termination of hostel accommodation.</p>
      </div>
    </div>
    
    <div id="rule-form" style="display: none; margin-top: 20px; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
      <h4>Add/Edit Rule</h4>
      <form id="rule-edit-form">
        <input type="hidden" id="rule-id">
        <div style="margin-bottom: 15px;">
          <label>Section:</label>
          <select id="rule-section" style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ddd;">
            <option value="general">General Rules</option>
            <option value="timing">Timing Rules</option>
          </select>
        </div>
        <div style="margin-bottom: 15px;">
          <label>Rule Text:</label>
          <textarea id="rule-text" style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ddd; height: 80px;" required></textarea>
        </div>
        <button type="submit" class="btn-submit">Save Rule</button>
        <button type="button" class="btn-view" id="cancel-rule-btn" style="margin-left: 10px;">Cancel</button>
      </form>
    </div>
  </div>
</template>

<template id="location-template">
  <div style="background:linear-gradient(45deg,var(--gradient-1),var(--gradient-2),var(--gradient-3),var(--gradient-4),var(--gradient-5),var(--gradient-6),var(--gradient-7));background-size:400% 400%;animation:gradientShift 6s ease infinite;min-height:100vh;padding:25px;font-family:'Poppins',sans-serif;">
    <div style="max-width:1200px;margin:0 auto;">
      <div style="text-align:center;color:white;margin-bottom:35px;background:rgba(255,255,255,0.1);padding:30px;border-radius:20px;backdrop-filter:blur(10px);">
        <h1 style="font-size:clamp(2.2rem,5vw,3.2rem);margin-bottom:15px;text-shadow:3px 3px 10px rgba(0,0,0,0.4);font-weight:900;">📍 Al Fizaa Girls Hostel</h1>
        <p style="font-size:clamp(1.2rem,3vw,1.6rem);opacity:0.95;text-shadow:2px 2px 6px rgba(0,0,0,0.3);font-weight:600;">Location & Contact Information</p>
      </div>

      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">
        <div style="background: rgba(255,255,255,0.95); padding: clamp(20px, 4vw, 30px); border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
          <h3 style="color: #333; margin-bottom: 20px; font-size: clamp(1.2rem, 3vw, 1.5rem); display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
            <i style="color: #667eea; font-size: clamp(1.5rem, 3vw, 1.8rem);">📞</i> Contact Numbers
          </h3>
          <div style="margin-bottom: 15px; padding: 15px; background: rgba(103, 126, 234, 0.1); border-radius: 10px; border-left: 4px solid #667eea;">
            <strong style="color: #333; display: block; margin-bottom: 5px; font-size: clamp(0.9rem, 2vw, 1rem);">Primary Contact:</strong>
            <a href="tel:03445436905" style="color: #667eea; font-weight: bold; text-decoration: none; font-size: clamp(0.9rem, 2vw, 1rem);">0344-5436905</a>
          </div>
          <div style="margin-bottom: 15px; padding: 15px; background: rgba(103, 126, 234, 0.1); border-radius: 10px; border-left: 4px solid #667eea;">
            <strong style="color: #333; display: block; margin-bottom: 5px; font-size: clamp(0.9rem, 2vw, 1rem);">Secondary Contact:</strong>
            <a href="tel:03554775037" style="color: #667eea; font-weight: bold; text-decoration: none; font-size: clamp(0.9rem, 2vw, 1rem);">0355-4775037</a>
          </div>
          <div style="margin-bottom: 15px; padding: 15px; background: rgba(103, 126, 234, 0.1); border-radius: 10px; border-left: 4px solid #667eea;">
            <strong style="color: #333; display: block; margin-bottom: 5px; font-size: clamp(0.9rem, 2vw, 1rem);">Alternative Contact:</strong>
            <a href="tel:03555028535" style="color: #667eea; font-weight: bold; text-decoration: none; font-size: clamp(0.9rem, 2vw, 1rem);">0355-5028535</a>
          </div>
          <div style="margin-bottom: 15px; padding: 15px; background: rgba(103, 126, 234, 0.1); border-radius: 10px; border-left: 4px solid #667eea;">
            <strong style="color: #333; display: block; margin-bottom: 5px; font-size: clamp(0.9rem, 2vw, 1rem);">Emergency Contact:</strong>
            <a href="tel:03411666480" style="color: #667eea; font-weight: bold; text-decoration: none; font-size: clamp(0.9rem, 2vw, 1rem);">03411-666480</a>
          </div>
        </div>

        <div style="background: rgba(255,255,255,0.95); padding: clamp(20px, 4vw, 30px); border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
          <h3 style="color: #333; margin-bottom: 20px; font-size: clamp(1.2rem, 3vw, 1.5rem); display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
            <i style="color: #667eea; font-size: clamp(1.5rem, 3vw, 1.8rem);">📍</i> Address
          </h3>
          <div style="margin-bottom: 15px; padding: 15px; background: rgba(103, 126, 234, 0.1); border-radius: 10px; border-left: 4px solid #667eea;">
            <strong style="color: #333; display: block; margin-bottom: 5px; font-size: clamp(0.9rem, 2vw, 1rem);">Full Address:</strong>
            <span style="color: #555; font-size: clamp(0.8rem, 1.8vw, 0.95rem); line-height: 1.4;">Al Fizaa Girls Hostel, adjacent to Old. Dr. Syeda Clinic, Abbas Town, Pareshan Chowk, Hassan Sadpara Chowk, IG Ashraf Shaheed Road, Skardu Baltistan, Pakistan</span>
          </div>
          <div style="margin-bottom: 15px; padding: 15px; background: rgba(103, 126, 234, 0.1); border-radius: 10px; border-left: 4px solid #667eea;">
            <strong style="color: #333; display: block; margin-bottom: 5px; font-size: clamp(0.9rem, 2vw, 1rem);">City:</strong>
            <span style="color: #555; font-size: clamp(0.9rem, 2vw, 1rem);">Skardu, Baltistan</span>
          </div>
          <div style="margin-bottom: 15px; padding: 15px; background: rgba(103, 126, 234, 0.1); border-radius: 10px; border-left: 4px solid #667eea;">
            <strong style="color: #333; display: block; margin-bottom: 5px; font-size: clamp(0.9rem, 2vw, 1rem);">Country:</strong>
            <span style="color: #555; font-size: clamp(0.9rem, 2vw, 1rem);">Pakistan</span>
          </div>
          <a href="https://www.google.com/maps/@35.281053,75.6450069,21z?entry=ttu&g_ep=EgoyMDI1MDgyNS4wIKXMDSoASAFQAw%3D%3D" target="_blank" style="display: inline-block; margin-top: 15px; padding: 12px 25px; background: linear-gradient(45deg, #667eea, #764ba2); color: white; text-decoration: none; border-radius: 25px; font-weight: bold; transition: transform 0.3s; box-shadow: 0 4px 15px rgba(0,0,0,0.2); font-size: clamp(0.9rem, 2vw, 1rem);">
            <i style="margin-right: 8px;">🗺️</i> Get Directions
          </a>
        </div>
      </div>

      <div style="background: white; border-radius: 20px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
        <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 20px; text-align: center;">
          <h3 style="font-size: clamp(1.2rem, 3vw, 1.5rem); margin: 0 0 10px 0;"><i style="margin-right: 10px;">🗺️</i>Hostel Location on Map</h3>
          <p style="margin: 0; font-size: clamp(0.9rem, 2vw, 1rem); opacity: 0.9;">Click on the map to open in Google Maps for detailed directions</p>
        </div>
        <iframe 
          style="width: 100%; height: clamp(300px, 50vw, 400px); border: none;"
          src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3307.123456789!2d75.6450069!3d35.281053!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x0%3A0x0!2zMzXCsDE2JzUxLjgiTiA3NcKwMzgnNDIuMCJF!5e0!3m2!1sen!2s!4v1234567890123!5m2!1sen!2s"
          allowfullscreen="" 
          loading="lazy" 
          referrerpolicy="no-referrer-when-downgrade">
        </iframe>
      </div>
    </div>
  </div>
</template>

<template id="social-media-template">
  <div class="table-container">
    <h3>Connect With Us</h3>
    <p style="text-align:center;margin-bottom:30px;color:#666;">Follow us on social media for updates and announcements</p>
    
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin:20px 0;">
      <div class="social-link-card" style="background:linear-gradient(135deg,#1877f2,#42a5f5);" onclick="window.open('https://www.facebook.com/onlyfreegirlshostelfordeservings', '_blank')">
        <i class="fab fa-facebook-f"></i>
        <h4>Facebook</h4>
        <p>Follow our page for daily updates</p>
      </div>
      
      <div class="social-link-card" style="background:linear-gradient(135deg,#ff0000,#ff4444);" onclick="window.open('https://www.youtube.com/@baduwahealtheducationfound5368', '_blank')">
        <i class="fab fa-youtube"></i>
        <h4>YouTube</h4>
        <p>Watch hostel life videos</p>
      </div>
      
      <div class="social-link-card" style="background:linear-gradient(135deg,#000000,#ff0050);" onclick="window.open('https://www.tiktok.com/@alfizaa.girls.hos', '_blank')">
        <i class="fab fa-tiktok"></i>
        <h4>TikTok</h4>
        <p>Fun moments and activities</p>
      </div>
      
      <div class="social-link-card" style="background:linear-gradient(135deg,#e4405f,#f56040);" onclick="window.open('https://www.instagram.com/alfizaagirlshostel', '_blank')">
        <i class="fab fa-instagram"></i>
        <h4>Instagram</h4>
        <p>Photos and stories</p>
      </div>
      
      <div class="social-link-card" style="background:linear-gradient(135deg,#25d366,#128c7e);" onclick="window.open('https://chat.whatsapp.com/D8RPAjNGrTm2mvSlfT7jzK?mode=ems', '_blank')">
        <i class="fab fa-whatsapp"></i>
        <h4>WhatsApp</h4>
        <p>Join our community group</p>
      </div>
    </div>
  </div>
</template>

<!-- MODAL -->
<div id="modal-bg">
<div id="modal-content"><span id="modal-close">✖</span><div id="modal-message"></div></div>
</div>

<style>
.student-id-cards-container {
  display:flex;
  gap:12px;
  justify-content:center;
  flex-wrap:wrap;
  align-items:flex-start;
}
.student-id-card {
  width:320px;
  height:200px;
  border-radius:12px;
  box-shadow:0 8px 20px rgba(0,0,0,0.2);
  position:relative;
  font-family:'Poppins',sans-serif;
  overflow:hidden;
  padding:10px;
  box-sizing:border-box;
  flex-shrink:0;
}
@keyframes gradientShift {
  0%{background-position:0% 50%}
  25%{background-position:100% 0%}
  50%{background-position:100% 50%}
  75%{background-position:0% 100%}
  100%{background-position:0% 50%}
}

@keyframes themeGlow {
  0%{box-shadow:0 0 20px rgba(var(--gradient-1-rgb, 102,126,234),0.3)}
  50%{box-shadow:0 0 40px rgba(var(--gradient-2-rgb, 118,75,162),0.5)}
  100%{box-shadow:0 0 20px rgba(var(--gradient-1-rgb, 102,126,234),0.3)}
}

@keyframes pulseGlow {
  0%{transform:scale(1);opacity:1}
  50%{transform:scale(1.05);opacity:0.8}
  100%{transform:scale(1);opacity:1}
}

@keyframes colorShift {
  0%{filter:hue-rotate(0deg)}
  25%{filter:hue-rotate(90deg)}
  50%{filter:hue-rotate(180deg)}
  75%{filter:hue-rotate(270deg)}
  100%{filter:hue-rotate(360deg)}
}

@keyframes vibrantPulse {
  0% { 
    transform: translateY(-15px) scale(1.08) rotateX(5deg);
    box-shadow: 0 25px 50px rgba(0,0,0,0.2);
  }
  50% { 
    transform: translateY(-20px) scale(1.12) rotateX(8deg);
    box-shadow: 0 35px 70px rgba(0,0,0,0.3);
  }
  100% { 
    transform: translateY(-15px) scale(1.08) rotateX(5deg);
    box-shadow: 0 25px 50px rgba(0,0,0,0.2);
  }
}

@keyframes iconBounce {
  0% { transform: scale(1.2) rotateY(10deg); }
  30% { transform: scale(1.4) rotateY(15deg); }
  60% { transform: scale(1.3) rotateY(12deg); }
  100% { transform: scale(1.2) rotateY(10deg); }
}

@keyframes dashboardCardGlow {
  0% { 
    box-shadow: 0 15px 35px rgba(0,0,0,0.1);
    transform: translateY(0);
  }
  50% { 
    box-shadow: 0 25px 50px rgba(102,126,234,0.3);
    transform: translateY(-8px);
  }
  100% { 
    box-shadow: 0 15px 35px rgba(0,0,0,0.1);
    transform: translateY(0);
  }
}

@keyframes rippleEffect {
  0% {
    transform: scale(0);
    opacity: 1;
  }
  100% {
    transform: scale(2);
    opacity: 0;
  }
}

/* ID Card Modal Styles */
#idcard-modal {
  font-family: 'Poppins', sans-serif;
}

#idcard-modal button:hover {
  background: rgba(255,255,255,0.3) !important;
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(0,0,0,0.2);
}

@media (max-width: 768px) {
  #idcard-modal .student-id-cards-container {
    flex-direction: column;
    align-items: center;
    gap: 15px;
  }
  
  #idcard-modal .student-id-card {
    width: 320px !important;
    height: 200px !important;
  }
  
  #idcard-modal .student-photo {
    width: 65px !important;
    height: 65px !important;
  }
  
  #idcard-modal .card-content {
    margin-top: 85px !important;
  }
  
  #idcard-modal .student-name {
    font-size: 1rem !important;
  }
  
  #idcard-modal .field-row {
    font-size: 0.65rem !important;
  }
  
  #idcard-modal .signature-area {
    font-size: 0.55rem !important;
  }
}
.card-front {
  background:linear-gradient(45deg,#667eea,#764ba2,#f093fb,#f5576c,#4facfe,#00f2fe);
  background-size:300% 300%;
  animation:gradientShift 3s ease infinite;
  color:white;
}
.card-back {
  background:linear-gradient(45deg,#764ba2,#667eea,#f5576c,#f093fb,#00f2fe,#4facfe);
  background-size:300% 300%;
  animation:gradientShift 3s ease infinite reverse;
  color:white;
}
.watermark {
  position:absolute;
  top:0;
  left:0;
  width:100%;
  height:100%;
  opacity:0.08;
  background:radial-gradient(circle,rgba(255,255,255,0.1) 1px,transparent 1px);
  background-size:20px 20px;
  pointer-events:none;
}
.hostel-logo {
  position:absolute;
  top:12px;
  right:12px;
  width:45px;
  height:45px;
  background:rgba(255,255,255,0.25);
  border-radius:12px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:1.6rem;
  -webkit-backdrop-filter:blur(15px);
  -webkit-backdrop-filter:blur(15px);
  backdrop-filter:blur(15px);
  border:2px solid rgba(255,255,255,0.3);
  box-shadow:0 6px 20px rgba(0,0,0,0.2);
}
.student-photo {
  position:absolute;
  top:12px;
  left:50%;
  transform:translateX(-50%);
  width:70px;
  height:70px;
  border-radius:12px;
  object-fit:cover;
  border:2px solid rgba(255,255,255,0.4);
  box-shadow:0 6px 15px rgba(0,0,0,0.3);
  -webkit-backdrop-filter:blur(5px);
  backdrop-filter:blur(5px);
}
.card-content {
  margin-top:88px;
  position:relative;
  z-index:2;
}
.student-name {
  font-size:1rem;
  font-weight:800;
  text-align:center;
  margin-bottom:6px;
  text-shadow:1px 1px 3px rgba(0,0,0,0.4);
  background:rgba(255,255,255,0.15);
  padding:3px 6px;
  border-radius:6px;
  -webkit-backdrop-filter:blur(10px);
  backdrop-filter:blur(10px);
}
.field-row {
  margin-bottom:2px;
  font-size:0.6rem;
  display:flex;
  align-items:flex-start;
  background:rgba(255,255,255,0.12);
  padding:1px 4px;
  border-radius:4px;
  margin:1px 0;
  -webkit-backdrop-filter:blur(5px);
  backdrop-filter:blur(5px);
}
.field-label {
  font-weight:700;
  min-width:55px;
  opacity:0.95;
  flex-shrink:0;
  font-size:0.55rem;
}
.field-value {
  font-weight:600;
  flex:1;
  word-wrap:break-word;
  font-size:0.55rem;
  line-height:1.1;
}
.signature-area {
  position:absolute;
  bottom:6px;
  left:10px;
  right:10px;
  font-size:0.5rem;
  background:rgba(255,255,255,0.15);
  padding:4px;
  border-radius:6px;
  -webkit-backdrop-filter:blur(10px);
  backdrop-filter:blur(10px);
}
.back-content {
  display:flex;
  flex-direction:column;
  height:100%;
  justify-content:space-between;
}
.back-header {
  text-align:center;
  margin-bottom:15px;
  background:rgba(255,255,255,0.1);
  padding:10px;
  border-radius:15px;
  -webkit-backdrop-filter:blur(10px);
  backdrop-filter:blur(10px);
}
.back-title {
  font-size:0.9rem;
  font-weight:800;
  margin-bottom:3px;
  text-shadow:1px 1px 3px rgba(0,0,0,0.3);
}
.contact-info {
  margin-bottom:15px;
}
.return-info {
  background:rgba(255,255,255,0.15);
  padding:12px;
  border-radius:15px;
  -webkit-backdrop-filter:blur(15px);
  backdrop-filter:blur(15px);
  border:1px solid rgba(255,255,255,0.2);
}
.return-title {
  font-weight:800;
  margin-bottom:8px;
  color:#fff;
  text-shadow:2px 2px 4px rgba(0,0,0,0.3);
}
.return-address {
  font-size:0.55rem;
  line-height:1.1;
  opacity:0.95;
  font-weight:500;
}
</style>
<script>
// ---------- SIMPLE HERO VIDEO UTILITY ----------
function getHeroVideoHTML() {
    // Simple method: Use default video-1.mp4 from assets folder or videos from localStorage
    const heroVideos = JSON.parse(localStorage.getItem('heroVideos') || '[]');
    const defaultVideo = 'assets/video-1.mp4';
    const videoSource = heroVideos.length > 0 ? heroVideos[Math.floor(Math.random() * heroVideos.length)] : defaultVideo;
    return `<video class="hero-video" autoplay muted loop playsinline preload="auto"><source src="${videoSource}" type="video/mp4">Your browser does not support the video tag.</video>`;
}

// ---------- DOM CACHE AND PERFORMANCE OPTIMIZATIONS ----------

// Cache frequently accessed DOM elements
const DOMCache = {
    elements: {},
    
    get(id) {
        if (!this.elements[id]) {
            this.elements[id] = document.getElementById(id);
        }
        return this.elements[id];
    },
    
    clear() {
        this.elements = {};
    },
    
    // Batch DOM updates for better performance
    batchUpdate(updates) {
        const fragment = document.createDocumentFragment();
        updates.forEach(update => {
            if (update.element && update.content) {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = update.content;
                while (tempDiv.firstChild) {
                    fragment.appendChild(tempDiv.firstChild);
                }
            }
        });
        return fragment;
    }
};

// Event delegation for better performance
function setupEventDelegation() {
    // Single event listener for all buttons
    document.addEventListener('click', function(e) {
        const target = e.target;
        
        // Handle login buttons
        if (target.classList.contains('login-btn')) {
            const role = target.dataset.role;
            if (role) {
                handleLogin(role);
            }
        }
        
        // Handle navigation items
        if (target.classList.contains('nav-item')) {
            e.preventDefault();
            const action = target.dataset.action;
            if (action && window[action]) {
                window[action]();
            }
        }
        
        // Handle modal close buttons
        if (target.classList.contains('modal-close') || target.id === 'modal-close') {
            closeModal();
        }
    });
}

// Optimized login handler
function handleLogin(role) {
    if (role === 'guest') {
        console.log('🌟 Guest login selected');
        localStorage.setItem('isLoggedIn', 'true');
        localStorage.setItem('userRole', 'guest');
        localStorage.setItem('currentUser', JSON.stringify({
            username: 'guest',
            role: 'guest',
            mobile: 'N/A',
            name: 'Guest User'
        }));
        
        if (window.renderGuestDashboard) {
            renderGuestDashboard();
        }
        
        // Special initialization for guest mobile sidebar
        if (window.innerWidth <= 768) {
            setTimeout(() => {
                console.log('🔧 Post-login mobile sidebar fix for guest mode');
                if (window.forceFixGuestStudentSidebar) {
                    window.forceFixGuestStudentSidebar();
                }
            }, 200);
        }
        return;
    }
    
    // Sanitize inputs using cached elements
    const usernameEl = DOMCache.get('username');
    const passwordEl = DOMCache.get('password');
    const errorEl = DOMCache.get('error-message');
    
    if (!usernameEl || !passwordEl) {
        console.error('Login form elements not found');
        return;
    }
    
    const username = sanitizeInput(usernameEl.value.trim());
    const password = sanitizeInput(passwordEl.value.trim());
    
    console.log('🔍 LOGIN DEBUG - Attempting secure login with:', {username, role});
    
    if (!username || !password) {
        if (errorEl) errorEl.textContent = 'Please enter username and password';
        return;
    }
    
    // Use secure authentication
    const user = authenticateUser(username, password, role);
    console.log('🔍 LOGIN DEBUG - Authentication result:', user ? 'Success' : 'Failed');
    
    if (user) {
        console.log('🔍 LOGIN SUCCESS - User found:', user);
        console.log('🔍 LOGIN SUCCESS - Setting role:', role);
        
        // For students and parents, check if account was properly created
        if ((role === 'student' || role === 'parent') && !user.studentId) {
            if (errorEl) errorEl.textContent = 'Invalid account. Please create a new account.';
            return;
        }
        
        localStorage.setItem('isLoggedIn', 'true');
        localStorage.setItem('userRole', role);
        localStorage.setItem('currentUser', JSON.stringify({
            username: user.username,
            role: user.role,
            mobile: user.mobile,
            name: user.name
        }));
        
        // Route to appropriate dashboard
        if (role === 'admin' && window.renderAdminDashboard) {
            renderAdminDashboard();
        } else if (role === 'student' && window.renderStudentDashboard) {
            renderStudentDashboard();
        } else if (role === 'parent' && window.renderParentDashboard) {
            renderParentDashboard();
        }

    // Always re-check admin-only UI after dashboard render
    setTimeout(() => {
      if (typeof enforceAdminOnlyControls === 'function') {
        enforceAdminOnlyControls();
      }
    }, 50);
        
        setTimeout(() => {
            if (window.initializeMobileEnhancements) {
                initializeMobileEnhancements();
            }
            
            // Ensure mobile scrolling is properly set up
            if (window.innerWidth <= 768) {
                if (window.fixMobileScrolling) {
                    fixMobileScrolling();
                }
            }
            
            // Mobile navigation fix
            if (window.innerWidth <= 768) {
                setTimeout(() => {
                    console.log('🔧 Post-login mobile sidebar optimization');
                    if (window.forceFixMobileSidebar) {
                        window.forceFixMobileSidebar();
                    }
                }, 200);
            }
        }, 100);
    } else {
        console.log('🔍 LOGIN FAILED - Invalid credentials');
        if (errorEl) errorEl.textContent = 'Invalid username or password';
    }
}

// Defensive utility: hide admin-only controls unless logged in as the default admin
function enforceAdminOnlyControls(){
  try {
    const currentUser = JSON.parse(localStorage.getItem('currentUser')||'null');
    const role = localStorage.getItem('userRole');
    const isDefaultAdmin = currentUser && role === 'admin' && currentUser.username === 'admin';
    const ids = [
      'admin-notifications-btn','logo-upload-btn','qarz-forms-btn','student-reports-btn',
      'automated-reports-btn','document-scanner-btn','student-id-change-btn'
    ];
    ids.forEach(id=>{
      const el = document.getElementById(id);
      if (!el) return;
      if (id === 'logo-upload-btn') {
        el.style.display = isDefaultAdmin ? 'inline-block' : 'none';
      } else {
        // keep previous logic: only admin sees these; future refinement possible
        if (!isDefaultAdmin) el.style.display = 'none';
      }
    });
  } catch(err){
    console.warn('enforceAdminOnlyControls error', err);
  }
}

// Initialize DOM optimizations
function initializeDOMOptimizations() {
    setupEventDelegation();
    
    // Pre-cache critical elements
    const criticalElements = [
        'username', 'password', 'error-message', 'login-form',
        'sidebar', 'mobile-menu-btn', 'main-content'
    ];
    
    criticalElements.forEach(id => {
        DOMCache.get(id);
    });
}

// ---------- SECURITY FUNCTIONS ----------

// Simple password hashing implementation for client-side security
function simpleHash(password, salt = 'hostelManagement2025') {
    let hash = 0;
    const input = password + salt;
    for (let i = 0; i < input.length; i++) {
        const char = input.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash; // Convert to 32-bit integer
    }
    return Math.abs(hash).toString(36);
}

// Enhanced password validation
function validatePassword(password) {
    if (password.length < 6) {
        return { valid: false, message: 'Password must be at least 6 characters long' };
    }
    if (!/[A-Za-z]/.test(password)) {
        return { valid: false, message: 'Password must contain at least one letter' };
    }
    if (!/[0-9]/.test(password)) {
        return { valid: false, message: 'Password must contain at least one number' };
    }
    return { valid: true, message: 'Password is valid' };
}

// Input sanitization function
function sanitizeInput(input) {
    if (typeof input !== 'string') return input;
    return input
        .replace(/[<>\"']/g, '') // Remove potential XSS characters
        .trim()
        .slice(0, 500); // Limit length
}

// Safe HTML rendering to prevent XSS
function createSafeElement(tag, textContent, attributes = {}) {
    const element = document.createElement(tag);
    if (textContent) {
        element.textContent = sanitizeInput(textContent);
    }
    Object.keys(attributes).forEach(key => {
        element.setAttribute(key, sanitizeInput(attributes[key]));
    });
    return element;
}

// Safe table row creation
function createSafeTableRow(data, cellTypes = []) {
    const row = document.createElement('tr');
    data.forEach((cellData, index) => {
        const cell = document.createElement(cellTypes[index] || 'td');
        cell.textContent = sanitizeInput(String(cellData));
        row.appendChild(cell);
    });
    return row;
}

// Secure user authentication
function authenticateUser(username, password, role) {
    const users = JSON.parse(localStorage.getItem('userCredentials') || '[]');
    const hashedPassword = simpleHash(password);
    
    // For backwards compatibility, check both hashed and plain text passwords
    const user = users.find(u => 
        u.username === username && 
        u.role === role && 
        (u.password === hashedPassword || u.password === password)
    );
    
    // If user found with plain text password, update to hashed version
    if (user && user.password === password) {
        user.password = hashedPassword;
        localStorage.setItem('userCredentials', JSON.stringify(users));
        console.log('🔒 Password automatically upgraded to hashed version');
    }
    
    return user;
}

// ---------- OPTIMIZED HERO VIDEO FOR MOBILE PERFORMANCE ----------
function forceHeroVideo() {
    const video = document.getElementById('hero-bg-video');
    
    if (video) {
        console.log('🎬 FORCING Hero Video to Work');
        
        // Check if mobile device for performance optimization
        const isMobile = window.innerWidth <= 768;
        
        // Force video properties
        video.muted = true;
        video.loop = true;
        video.autoplay = true;
        video.controls = false;
        video.setAttribute('webkit-playsinline', 'true');
        video.setAttribute('playsinline', 'true');
        
        // Reduce video quality on mobile for better performance
        if (isMobile) {
            video.style.opacity = '0.5';
            video.style.filter = 'blur(0.5px)'; // Slight blur to reduce processing
        }
        
        // Force play with optimized timing for mobile
        video.load();
        
        setTimeout(() => {
            video.play().then(() => {
                console.log('✅ Hero video is playing!');
                video.style.opacity = isMobile ? '0.5' : '1';
            }).catch((error) => {
                console.log('❌ Video autoplay blocked, forcing manual play...');
                // Try again after user interaction
                document.body.addEventListener('click', () => {
                    video.play().then(() => {
                        console.log('✅ Hero video started after user click!');
                        video.style.opacity = isMobile ? '0.5' : '1';
                    });
                }, { once: true });
            });
        }, isMobile ? 200 : 100); // Longer delay on mobile
        
        // Reduced event listeners for mobile performance
        if (!isMobile) {
            video.addEventListener('loadeddata', () => {
                console.log('📹 Hero video loaded');
                video.play();
            });
            
            video.addEventListener('canplay', () => {
                console.log('📹 Hero video can play');
                video.play();
            });
        }
        
        video.addEventListener('error', (e) => {
            console.error('❌ Hero video error:', e);
            console.log('🔍 Check if assets/video-1.mp4 exists');
        });
        
    } else {
        console.error('❌ Hero video element not found!');
    }
}

// ---------- MOBILE PERFORMANCE OPTIMIZATIONS ----------
// Disable forceHeroVideo on mobile for better performance
const originalForceHeroVideo = forceHeroVideo;
window.forceHeroVideo = function() {
    const isMobile = window.innerWidth <= 768;
    if (!isMobile) {
        originalForceHeroVideo();
    } else {
        console.log('🚀 Skipping heavy video processing on mobile for better performance');
    }
};

// Throttle scroll events for mobile performance
let ticking = false;
function throttleScroll(callback) {
    if (!ticking) {
        requestAnimationFrame(callback);
        ticking = true;
        setTimeout(() => { ticking = false; }, 16); // ~60fps
    }
}

// ---------- Modal Variables ----------
let modal = null;
let modalBg = null;
let modalContent = null;
let modalClose = null;

// ---------- Setup ----------
document.addEventListener('DOMContentLoaded',()=>{
    console.log('🔧 DOM Content Loaded');
    
    // FORCE SHOW LOGIN PAGE FIRST - Always start with login page
    console.log('🔧 Forcing login page display on page load');
    document.body.classList.add('showing-login');
    document.body.classList.remove('showing-app');
    document.getElementById('app-page').style.setProperty('display', 'none', 'important');
    document.getElementById('login-page').style.setProperty('display', 'block', 'important');
    
    // Mobile Performance Mode Detection
    const isMobile = window.innerWidth <= 768;
    const isLowEnd = navigator.hardwareConcurrency && navigator.hardwareConcurrency <= 4;
    
    if (isMobile) {
        console.log('📱 Mobile device detected - enabling performance optimizations');
        document.body.classList.add('mobile-performance-mode');
        
        // Add mobile-specific optimizations
        document.documentElement.style.setProperty('--mobile-optimization', '1');
        
        // Disable animations on very low-end devices
        if (isLowEnd) {
            console.log('⚡ Low-end device detected - maximum performance mode');
            document.body.classList.add('low-end-device');
        }
        
        // Optimize scroll events for mobile
        let scrollTimeout;
        const optimizeScrollEvents = () => {
            document.body.style.pointerEvents = 'none';
            clearTimeout(scrollTimeout);
            scrollTimeout = setTimeout(() => {
                document.body.style.pointerEvents = 'auto';
            }, 150);
        };
        
        // Throttle scroll events on mobile
        window.addEventListener('scroll', throttleScroll(optimizeScrollEvents), { passive: true });
        
        // Reduce redundant reflows on mobile
        window.addEventListener('resize', debounce(() => {
            if (window.innerWidth <= 768) {
                document.body.classList.add('mobile-performance-mode');
            } else {
                document.body.classList.remove('mobile-performance-mode');
            }
        }, 250));
    }
    
    setupInitialData();
    
    // Always render login page first, regardless of stored login state
    console.log('🔧 Always showing login page on page load');
    renderLoginPage();
    
    // Clear any previous login state to force fresh login
    localStorage.removeItem('isLoggedIn');
    localStorage.removeItem('userRole');
    localStorage.removeItem('currentUser');
    localStorage.removeItem('studentId');
    
    // Optimized date-time update - only when page is visible
    let dateTimeInterval;
    
    function updateDateTime() {
        const dt = new Date().toLocaleString();
        const dateTimeElement = document.getElementById('date-time');
        if (dateTimeElement) {
            dateTimeElement.textContent = dt;
        }
    }
    
    function startDateTimeUpdates() {
        if (!dateTimeInterval) {
            updateDateTime(); // Update immediately
            dateTimeInterval = setInterval(updateDateTime, 5000); // Update every 5 seconds instead of 1
        }
    }
    
    function stopDateTimeUpdates() {
        if (dateTimeInterval) {
            clearInterval(dateTimeInterval);
            dateTimeInterval = null;
        }
    }
    
    // Page visibility API for performance optimization
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            stopDateTimeUpdates();
        } else {
            startDateTimeUpdates();
        }
    });
    
    // Start updates when page loads
    startDateTimeUpdates();
    
    // Initialize DOM optimizations
    initializeDOMOptimizations();
});

// Set up login button handlers
// Setup login handlers removed - using inline handlers in renderLoginPage

function setupInitialData(){
    if(!localStorage.getItem('userCredentials')){
        const users=[{username:'admin',password:'admin1005',role:'admin',mobile:'+923411666480',name:'Default Admin',position:'System Owner'}];
        localStorage.setItem('userCredentials',JSON.stringify(users));
        console.log('🔧 SETUP DEBUG - Created default admin:', users[0]);
    } else {
        const existingUsers = JSON.parse(localStorage.getItem('userCredentials')||'[]');
        console.log('🔧 SETUP DEBUG - Existing users found:', existingUsers);
    }
    // Remove any invalid student/parent accounts without studentId
    const users = JSON.parse(localStorage.getItem('userCredentials')||'[]');
    const validUsers = users.filter(u => {
        if(u.role === 'admin') return true;
        return u.studentId; // Only keep student/parent accounts with studentId
    });
    if(validUsers.length !== users.length) {
        localStorage.setItem('userCredentials', JSON.stringify(validUsers));
    }
    if(!localStorage.getItem('studentList')){
        // sample students with new fields
        const sampleStudents = [
          {id:'AF01',name:'Aisha Khan',contact:'0300-1111111',guardian:'Mr Khan',guardianContact:'0300-2222222',roomNo:'R01',feePaid:20000,totalFee:25000,due:5000,admissionDate:'2025-08-05',sponsored:false,scholarship:false,partialSupport:false,admissionFee:5000,securityFee:3000,documents:{}},
          {id:'AF02',name:'Fatima Ali',contact:'0300-3333333',guardian:'Ms Ali',guardianContact:'0300-4444444',roomNo:'R02',feePaid:0,totalFee:20000,due:20000,admissionDate:'2025-07-10',sponsored:true,scholarship:false,partialSupport:false,admissionFee:5000,securityFee:3000,documents:{}},
        ];
        localStorage.setItem('studentList',JSON.stringify(sampleStudents));
    }
    if(!localStorage.getItem('complaints')){
        const sampleComplaints = [
          {id:'C1',title:'Leaky tap',status:'pending',date:'2025-08-10'},
          {id:'C2',title:'Broken bulb',status:'resolved',date:'2025-07-20'}
        ];
        localStorage.setItem('complaints',JSON.stringify(sampleComplaints));
    }
    if(!localStorage.getItem('issuesList')){
        const sampleIssues = [
          {id:'I001',studentName:'Aisha Khan',roomNo:'R01',issue:'AC not working',date:'2025-01-15',status:'pending',assignedStaff:'',resolutionDate:'',resolutionFeedback:''},
          {id:'I002',studentName:'Fatima Ali',roomNo:'R02',issue:'Water leakage in bathroom',date:'2025-01-10',status:'resolved',assignedStaff:'Maintenance Team',resolutionDate:'2025-01-12',resolutionFeedback:'Fixed the pipe connection'}
        ];
        localStorage.setItem('issuesList',JSON.stringify(sampleIssues));
    }
    if(!localStorage.getItem('transactions')){
        // transactions: {type:'income'|'expense'|'sponsorship', amount, date}
        const tx = [
          {id:'T1',type:'income',amount:20000,date:'2025-08-05'},
          {id:'T2',type:'income',amount:15000,date:'2025-07-12'},
          {id:'T3',type:'expense',amount:8000,date:'2025-08-08'},
          {id:'T4',type:'sponsorship',amount:10000,date:'2025-08-01'}
        ];
        localStorage.setItem('transactions',JSON.stringify(tx));
    }
    if(!localStorage.getItem('expenseList')){
        const sampleExpenses = [
          {id:'E001',date:'2025-01-15',category:'food',description:'Monthly grocery supplies',amount:25000,payment:'bank',vendor:'Metro Cash & Carry',receipt:'MC001',approved:'Admin'},
          {id:'E002',date:'2025-01-14',category:'utilities',description:'Electricity bill',amount:15000,payment:'bank',vendor:'LESCO',receipt:'EB001',approved:'Admin'},
          {id:'E003',date:'2025-01-13',category:'staff',description:'Cook salary',amount:30000,payment:'cash',vendor:'Staff',receipt:'SAL001',approved:'Admin'},
          {id:'E004',date:'2025-01-12',category:'cleaning',description:'Cleaning supplies',amount:5000,payment:'cash',vendor:'Local Store',receipt:'CS001',approved:'Admin'},
          {id:'E005',date:'2025-01-11',category:'maintenance',description:'Plumbing repair',amount:8000,payment:'cash',vendor:'Local Plumber',receipt:'PR001',approved:'Admin'},
          {id:'E006',date:'2025-01-10',category:'medical',description:'First aid supplies',amount:3000,payment:'cash',vendor:'Pharmacy',receipt:'MED001',approved:'Admin'},
          {id:'E007',date:'2024-12-28',category:'internet',description:'Monthly internet bill',amount:4000,payment:'bank',vendor:'PTCL',receipt:'INT001',approved:'Admin'},
          {id:'E008',date:'2024-12-25',category:'employee',description:'Employee benefits',amount:12000,payment:'bank',vendor:'HR Department',receipt:'EMP001',approved:'Admin'},
          {id:'E009',date:'2024-12-20',category:'supplies',description:'Office supplies and stationery',amount:6000,payment:'cash',vendor:'Office Mart',receipt:'OFF001',approved:'Admin'},
          {id:'E010',date:'2024-12-15',category:'equipment',description:'New washing machine',amount:45000,payment:'card',vendor:'Electronics Store',receipt:'EQ001',approved:'Admin'},
          {id:'E011',date:'2024-12-10',category:'advertising',description:'Social media ads',amount:8000,payment:'online',vendor:'Facebook Ads',receipt:'AD001',approved:'Admin'},
          {id:'E012',date:'2024-12-05',category:'marketing',description:'Brochure printing',amount:5000,payment:'cash',vendor:'Print Shop',receipt:'MK001',approved:'Admin'},
          {id:'E013',date:'2024-11-30',category:'debts',description:'Loan installment',amount:20000,payment:'bank',vendor:'Bank',receipt:'DEBT001',approved:'Admin'},
          {id:'E014',date:'2024-11-25',category:'sponsorships',description:'Event sponsorship',amount:15000,payment:'bank',vendor:'Event Organizer',receipt:'SP001',approved:'Admin'}
        ];
        localStorage.setItem('expenseList',JSON.stringify(sampleExpenses));
    }
    if(!localStorage.getItem('incomeList')){
        const sampleIncome = [
          {id:'I001',date:'2025-01-15',category:'monthly',studentName:'Aisha Khan',studentId:'S1',amount:25000,payment:'bank',receipt:'R001',description:'Monthly hostel fee'},
          {id:'I002',date:'2025-01-14',category:'admission',studentName:'Fatima Ali',studentId:'S2',amount:50000,payment:'cash',receipt:'R002',description:'New admission fee'},
          {id:'I003',date:'2025-01-13',category:'security',studentName:'Sara Ahmed',studentId:'S3',amount:10000,payment:'bank',receipt:'R003',description:'Security deposit'},
          {id:'I004',date:'2025-01-12',category:'chanda',studentName:'Ayesha Malik',studentId:'S4',amount:5000,payment:'cash',receipt:'R004',description:'Monthly chanda collection'},
          {id:'I005',date:'2025-01-11',category:'boxes',studentName:'Zara Khan',studentId:'S5',amount:3000,payment:'cash',receipt:'R005',description:'Storage box rental'},
          {id:'I006',date:'2025-01-10',category:'bhef',studentName:'Hina Shah',studentId:'S6',amount:15000,payment:'bank',receipt:'R006',description:'BHEF contribution'},
          {id:'I007',date:'2024-12-28',category:'donation',studentName:'Anonymous',studentId:'',amount:20000,payment:'bank',receipt:'R007',description:'Hostel improvement donation'},
          {id:'I008',date:'2024-12-25',category:'monthly',studentName:'Nida Ali',studentId:'S7',amount:25000,payment:'online',receipt:'R008',description:'Monthly hostel fee'},
          {id:'I009',date:'2024-12-20',category:'other',studentName:'Rabia Khan',studentId:'S8',amount:8000,payment:'cash',receipt:'R009',description:'Laundry service fee'},
          {id:'I010',date:'2024-12-15',category:'monthly',studentName:'Sana Ahmed',studentId:'S9',amount:25000,payment:'card',receipt:'R010',description:'Monthly hostel fee'}
        ];
        localStorage.setItem('incomeList',JSON.stringify(sampleIncome));
    }
    if(!localStorage.getItem('feeSlipRecords')){
        localStorage.setItem('feeSlipRecords',JSON.stringify([]));
    }
    if(!localStorage.getItem('extractedDocuments')){
        localStorage.setItem('extractedDocuments',JSON.stringify([]));
    }
    if(!localStorage.getItem('newsList')){
        const sampleNews = [
          {id:'N001',date:'2025-01-15',time:'10:30',description:'Monthly grocery shopping for hostel kitchen supplies',purchasedBy:'Kitchen Manager',remarks:'Bulk purchase for better rates',status:'paid'},
          {id:'N002',date:'2025-01-14',time:'14:15',description:'New bed sheets and pillows for Room 5',purchasedBy:'Hostel Warden',remarks:'Replacement for damaged items',status:'due'},
          {id:'N003',date:'2025-01-13',time:'09:00',description:'Repair work for main gate lock',purchasedBy:'Maintenance Staff',remarks:'Emergency repair needed',status:'paid'},
          {id:'N004',date:'2025-01-12',time:'16:45',description:'Medical supplies and first aid kit refill',purchasedBy:'Health Supervisor',remarks:'Monthly stock replenishment',status:'paid'},
          {id:'N005',date:'2025-01-11',time:'11:20',description:'Internet router upgrade for better connectivity',purchasedBy:'IT Administrator',remarks:'Students complained about slow internet',status:'due'}
        ];
        localStorage.setItem('newsList',JSON.stringify(sampleNews));
    }
    if(!localStorage.getItem('visitorList')){
        const sampleVisitors = [
          {id:'V1', studentId: 'S1', name:'Mr Khan Sr', contact:'0300-2222222', purpose:'Meeting', date:'2025-08-10', checkIn:'10:00', checkOut:'11:00', relation:'Father'},
          {id:'V2', studentId: 'S1', name:'Mrs Khan', contact:'0300-2222223', purpose:'Drop off items', date:'2025-08-12', checkIn:'14:00', checkOut:'14:15', relation:'Mother'},
          {id:'V3', studentId: 'S2', name:'Ms Ali Sr', contact:'0300-4444444', purpose:'Meeting', date:'2025-08-11', checkIn:'11:30', checkOut:'12:00', relation:'Mother'},
        ];
        localStorage.setItem('visitorList',JSON.stringify(sampleVisitors));
    }
}

// ---------- Mobile Responsive Enhancements ----------
function initializeMobileEnhancements() {
    // Detect mobile device
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    const isTablet = /iPad|Android.*tablet/i.test(navigator.userAgent);
    const isSmallScreen = window.innerWidth <= 768;
    
    if (isMobile || isTablet || isSmallScreen) {
        document.body.classList.add('mobile-device');
        
        // Fix mobile scrolling issues
        fixMobileScrolling();
        
        // Add mobile-specific event listeners
        addMobileTouchEvents();
        
        // Optimize tables for mobile
        optimizeTablesForMobile();
        
        // Enhance forms for mobile
        enhanceFormsForMobile();
        
        // Mobile-specific modal adjustments
        enhanceModalsForMobile();
    }
    
    // Handle orientation changes
    window.addEventListener('orientationchange', function() {
        setTimeout(() => {
            adjustLayoutForOrientation();
            if (window.innerWidth < 768) {
                fixMobileScrolling();
                closeMobileMenu();
            }
        }, 300);
    });
    
    // Handle window resize for responsive adjustments
    window.addEventListener('resize', debounce(function() {
        adjustLayoutForOrientation();
        if (window.innerWidth >= 768) {
            const sidebar = document.querySelector('.sidebar-nav');
            if (sidebar) {
                sidebar.style.transform = 'translateX(0)';
            }
        } else {
            fixMobileScrolling();
        }
    }, 250));
}

function fixMobileScrolling() {
    // Reset body and html for proper mobile scrolling
    document.body.style.position = 'static';
    document.body.style.height = 'auto';
    document.body.style.minHeight = '100vh';
    document.body.style.overflowY = 'auto';
    document.body.style.overflowX = 'hidden';
    document.documentElement.style.height = 'auto';
    document.documentElement.style.overflowX = 'hidden';
    
    // Fix main containers
    const mainWrapper = document.querySelector('.main-wrapper');
    if (mainWrapper) {
        mainWrapper.style.height = 'auto';
        mainWrapper.style.minHeight = '100vh';
        mainWrapper.style.overflowY = 'auto';
        mainWrapper.style.overflowX = 'hidden';
    }
    
    const mainContent = document.querySelector('.main-content') || document.getElementById('main-content');
    if (mainContent) {
        mainContent.style.height = 'auto';
        mainContent.style.minHeight = 'calc(100vh - 70px)';
        mainContent.style.overflowY = 'auto';
        mainContent.style.overflowX = 'hidden';
        mainContent.style.scrollBehavior = 'smooth';
    }
    
    // Fix all template containers
    const templates = document.querySelectorAll('[id*="template"]');
    templates.forEach(template => {
        template.style.height = 'auto';
        template.style.maxHeight = 'calc(100vh - 100px)';
        template.style.overflowY = 'auto';
        template.style.overflowX = 'hidden';
        template.style.scrollBehavior = 'smooth';
    });
    
    // Fix content areas
    const contentAreas = document.querySelectorAll('.content-area, .students-content, .admin-content, .guest-content');
    contentAreas.forEach(area => {
        area.style.height = 'auto';
        area.style.maxHeight = 'calc(100vh - 120px)';
        area.style.overflowY = 'auto';
        area.style.overflowX = 'hidden';
        area.style.scrollBehavior = 'smooth';
    });
    
    // Add touch scrolling improvements
    addTouchScrolling();
}

function addTouchScrolling() {
    // Improve touch scrolling for all content areas
    const scrollAreas = document.querySelectorAll('.main-content, .table-container, [id*="template"], .content-area');
    
    scrollAreas.forEach(area => {
        // Enable smooth scrolling
        area.style.scrollBehavior = 'smooth';
        
        // Prevent default touch behaviors that interfere with scrolling
        area.addEventListener('touchstart', function(e) {
            e.stopPropagation();
        }, { passive: true });
        
        area.addEventListener('touchmove', function(e) {
            e.stopPropagation();
        }, { passive: true });
        
        // Add momentum scrolling for iOS
        area.style.webkitOverflowScrolling = 'touch';
    });
    
    // Special handling for table containers
    const tableContainers = document.querySelectorAll('.table-container');
    tableContainers.forEach(container => {
        container.style.overflowX = 'auto';
        container.style.overflowY = 'visible';
        container.style.scrollBehavior = 'smooth';
        
        // Add scroll indicators
        container.addEventListener('scroll', function() {
            if (this.scrollLeft > 0) {
                this.classList.add('scrolled-left');
            } else {
                this.classList.remove('scrolled-left');
            }
        });
    });
}

function addMobileTouchEvents() {
    // Add enhanced touch feedback for cards with vibrant interactions
    const cards = document.querySelectorAll('.students-portal-card, .room-card, .dashboard-card');
    cards.forEach(card => {
        // Touch start - immediate vibrant feedback
        card.addEventListener('touchstart', function() {
            this.style.transform = 'scale(0.95) rotateX(2deg)';
            this.style.transition = 'transform 0.15s ease';
            this.style.filter = 'brightness(1.2) saturate(1.3)';
        });
        
        // Touch end - return with bounce effect
        card.addEventListener('touchend', function() {
            setTimeout(() => {
                this.style.transform = '';
                this.style.transition = 'transform 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55)';
                this.style.filter = '';
            }, 100);
        });

        // Mouse enter - vibrant hover effects
        card.addEventListener('mouseenter', function() {
            this.style.transition = 'all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
            
            // Add random rotation for more dynamic feel
            const randomRotate = Math.random() * 4 - 2; // Random between -2 and 2 degrees
            this.style.transform = `translateY(-15px) scale(1.08) rotateX(5deg) rotateZ(${randomRotate}deg)`;
            
            // Add vibrant glow effect
            const card = this;
            if (card.classList.contains('students-portal-card')) {
                if (card.classList.contains('rooms')) {
                    card.style.boxShadow = '0 25px 50px rgba(102,126,234,0.6), 0 0 30px rgba(118,75,162,0.4)';
                } else if (card.classList.contains('fee')) {
                    card.style.boxShadow = '0 25px 50px rgba(240,147,251,0.6), 0 0 30px rgba(245,87,108,0.4)';
                } else if (card.classList.contains('visitors')) {
                    card.style.boxShadow = '0 25px 50px rgba(79,172,254,0.6), 0 0 30px rgba(0,242,254,0.4)';
                } else {
                    card.style.boxShadow = '0 25px 50px rgba(67,233,123,0.6), 0 0 30px rgba(56,249,215,0.4)';
                }
            }
        });

        // Mouse leave - smooth return
        card.addEventListener('mouseleave', function() {
            this.style.transition = 'all 0.3s ease';
            this.style.transform = '';
            this.style.boxShadow = '';
        });

        // Add click ripple effect
        card.addEventListener('click', function(e) {
            const ripple = document.createElement('span');
            const rect = this.getBoundingClientRect();
            const size = Math.max(rect.width, rect.height);
            const x = e.clientX - rect.left - size / 2;
            const y = e.clientY - rect.top - size / 2;
            
            ripple.style.cssText = `
                position: absolute;
                width: ${size}px;
                height: ${size}px;
                left: ${x}px;
                top: ${y}px;
                background: radial-gradient(circle, rgba(255,255,255,0.6) 0%, transparent 70%);
                border-radius: 50%;
                transform: scale(0);
                animation: rippleEffect 0.6s ease-out;
                pointer-events: none;
                z-index: 1000;
            `;
            
            this.style.position = 'relative';
            this.appendChild(ripple);
            
            setTimeout(() => {
                if (ripple.parentNode) {
                    ripple.parentNode.removeChild(ripple);
                }
            }, 600);
        });
    });
    
    // Prevent zoom on double-tap for specific elements
    const preventZoomElements = document.querySelectorAll('button, .btn-submit, .btn-view, input, select');
    preventZoomElements.forEach(element => {
        element.addEventListener('touchend', function(e) {
            e.preventDefault();
            e.target.click();
        });
    });
}

function optimizeTablesForMobile() {
    const tables = document.querySelectorAll('table');
    tables.forEach(table => {
        // Add scroll indicator
        const container = table.closest('.table-container');
        if (container && !container.querySelector('.mobile-scroll-hint')) {
            const hint = document.createElement('div');
            hint.className = 'mobile-scroll-hint';
            hint.innerHTML = '← Swipe to see more columns →';
            hint.style.cssText = `
                text-align: center; padding: 8px; font-size: 0.8rem; 
                color: #666; background: #f8f9fa; border-top: 1px solid #ddd;
                display: none;
            `;
            container.appendChild(hint);
            
            // Show hint on mobile
            if (window.innerWidth < 768) {
                hint.style.display = 'block';
            }
        }
        
        // Make first column sticky on mobile
        if (window.innerWidth < 768) {
            const firstCells = table.querySelectorAll('th:first-child, td:first-child');
            firstCells.forEach(cell => {
                cell.style.position = 'sticky';
                cell.style.left = '0';
                cell.style.background = 'inherit';
                cell.style.zIndex = '1';
            });
        }
    });
}

function enhanceFormsForMobile() {
    const forms = document.querySelectorAll('.generic-form, form');
    forms.forEach(form => {
        // Add mobile-friendly input attributes
        const inputs = form.querySelectorAll('input, select, textarea');
        inputs.forEach(input => {
            // Prevent zoom on iOS
            if (input.type !== 'file') {
                input.style.fontSize = '16px';
            }
            
            // Add appropriate input modes
            if (input.type === 'tel' || input.name?.includes('contact')) {
                input.setAttribute('inputmode', 'tel');
            }
            if (input.type === 'email' || input.name?.includes('email')) {
                input.setAttribute('inputmode', 'email');
            }
            if (input.type === 'number' || input.name?.includes('amount')) {
                input.setAttribute('inputmode', 'numeric');
            }
        });
        
        // Improve file inputs for mobile
        const fileInputs = form.querySelectorAll('input[type="file"]');
        fileInputs.forEach(input => {
            input.addEventListener('change', function() {
                if (this.files.length > 0) {
                    // Show preview for images on mobile
                    if (this.files[0].type.startsWith('image/')) {
                        showMobileImagePreview(this, this.files[0]);
                    }
                }
            });
        });
    });
}

function showMobileImagePreview(input, file) {
    const reader = new FileReader();
    reader.onload = function(e) {
        let preview = input.nextElementSibling?.querySelector?.('.mobile-preview');
        if (!preview) {
            preview = document.createElement('div');
            preview.className = 'mobile-preview';
            preview.style.cssText = `
                margin-top: 10px; text-align: center; max-width: 200px;
                border: 2px dashed #ddd; border-radius: 8px; padding: 10px;
            `;
            input.parentNode.insertBefore(preview, input.nextSibling);
        }
        
        preview.innerHTML = `
            <img src="${e.target.result}" style="max-width: 100%; height: auto; border-radius: 4px;">
            <div style="font-size: 0.8rem; color: #666; margin-top: 5px;">${file.name}</div>
        `;
    };
    reader.readAsDataURL(file);
}

function enhanceModalsForMobile() {
    // Override modal functions for mobile
    const originalCloseModal = window.closeModal;
    window.closeModal = function() {
        if (originalCloseModal) originalCloseModal();
        
        // Reset any mobile-specific modal styles
        document.body.style.overflow = '';
        document.body.style.position = '';
    };
    
    // Improve modal scrolling on mobile
    const modals = document.querySelectorAll('[id*="modal"]');
    modals.forEach(modal => {
        modal.addEventListener('touchmove', function(e) {
            e.stopPropagation();
        });
    });
}

function adjustLayoutForOrientation() {
    const isLandscape = window.innerWidth > window.innerHeight;
    const isMobile = window.innerWidth < 768;
    
    if (isMobile && isLandscape) {
        // Landscape mobile adjustments
        document.body.classList.add('mobile-landscape');
        
        // Adjust grid layouts for landscape
        const grids = document.querySelectorAll('.dashboard-grid, .students-portal-grid');
        grids.forEach(grid => {
            grid.style.gridTemplateColumns = 'repeat(auto-fit, minmax(200px, 1fr))';
        });
    } else {
        document.body.classList.remove('mobile-landscape');
    }
}

function closeMobileMenu() {
    const sidebar = document.querySelector('.sidebar-nav');
    if (sidebar && window.innerWidth < 768) {
        sidebar.style.transform = 'translateX(100%)';
    }
}

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Initialize mobile enhancements when DOM is ready
// Mobile enhancements initialized in main DOMContentLoaded

// ---------- Login ----------
function renderLoginPage(){
    console.log('🔧 renderLoginPage() called');
    
    // Add body class to indicate we're showing login page
    document.body.classList.add('showing-login');
    document.body.classList.remove('showing-app');
    
    // Ensure app page is hidden and login page is shown
    document.getElementById('app-page').style.setProperty('display', 'none', 'important');
    document.getElementById('login-page').style.setProperty('display', 'block', 'important');
    
    const loginRoot=document.getElementById('login-page');
    if (!loginRoot) {
        console.error('🚨 login-page element not found!');
        return;
    }
    
    // Simple method: Get hero video HTML
    const videoHTML = getHeroVideoHTML();
    
    loginRoot.innerHTML=`
    ${videoHTML}
    <div class="login-container">
        <div class="login-header">
            <div class="logo" id="login-logo">🏠</div>
            <h1 style="font-weight:900;text-align:center;color:#333;text-shadow:2px 2px 8px rgba(0,0,0,0.3);font-size:clamp(1.2rem,4vw,2.2rem);margin:10px 0;">Al Fizaa Girls Hostel, Apna Ghar</h1>
            <h2 style="font-weight:900;text-align:center;color:#333;text-shadow:2px 2px 8px rgba(0,0,0,0.3);font-size:clamp(2rem,8vw,3rem);margin:15px 0 20px 0;letter-spacing:2px;line-height:1.2;">Welcomes U</h2>
        </div>
        <form id="login-form">
        <div class="input-group">
            <label for="username" class="sr-only">Username</label>
            <input type="text" id="username" placeholder="Enter Username" required aria-label="Username" aria-describedby="username-help">
        </div>
        <div class="input-group">
            <label for="password" class="sr-only">Password</label>
            <input type="password" id="password" placeholder="Enter Password" required aria-label="Password" aria-describedby="password-help">
        </div>
        <p id="error-message" class="error-message"></p>
        <div class="login-btn-group">
        <button type="button" class="login-btn admin" data-role="admin" aria-label="Login as Administrator" tabindex="1">🔐 Login as Admin</button>
        <button type="button" class="login-btn student" data-role="student" aria-label="Login as Student" tabindex="2">👩‍🎓 Login as Student</button>
        <button type="button" class="login-btn parent" data-role="parent" aria-label="Login as Parent or Guardian" tabindex="3">👨‍👩‍👧 Login as Parent</button>
        <button type="button" class="login-btn guest" data-role="guest" id="guest-login-btn" aria-label="Login as Guest User" tabindex="4" style="background:linear-gradient(135deg,#28a745,#20c997);border:2px solid #198754;color:white;font-weight:600;box-shadow:0 4px 15px rgba(40,167,69,0.4);transition:all 0.3s ease;">🌟 Guest Logins</button>
        <button type="button" class="btn-submit" id="admin-register-btn" style="background:linear-gradient(135deg,#dc3545,#c82333);border:2px solid #bd2130;color:white;font-weight:600;box-shadow:0 4px 15px rgba(220,53,69,0.4);transition:all 0.3s ease;">👑 Admin Registration</button>
        <button type="button" class="btn-submit" id="create-account-btn">✨ Create New Account</button>
        <button type="button" class="btn-submit" id="forgot-password-btn" style="background:linear-gradient(135deg,#f39c12,#e67e22);border:2px solid #d68910;color:white;font-weight:600;box-shadow:0 4px 15px rgba(243,156,18,0.4);transition:all 0.3s ease;">🔑 Forgot Password</button>
        </div>
        </form>
    </div>
    `;
    
    console.log('🔧 Login page HTML set');
    
    document.querySelectorAll('.login-btn').forEach(btn=>{
        // Add both click and touchstart events for mobile compatibility
        const handleLogin = (e) => {
            e.preventDefault();
            e.stopPropagation();
            
            const role=btn.dataset.role;
            
            // Handle Guest Login - No credentials required
            if(role === 'guest') {
                localStorage.setItem('isLoggedIn','true');
                localStorage.setItem('userRole','guest');
                document.body.classList.add('showing-app');
                document.body.classList.remove('showing-login');
                document.getElementById('login-page').style.setProperty('display', 'none', 'important');
                document.getElementById('app-page').style.setProperty('display', 'block', 'important');
                initializeApp();
                
                // Special initialization for guest mobile sidebar
                if(window.innerWidth <= 768) {
                    setTimeout(() => {
                        console.log('🔧 Post-login mobile sidebar fix for guest mode');
                        if(window.forceFixGuestStudentSidebar) {
                            window.forceFixGuestStudentSidebar();
                        }
                    }, 200);
                }
                return;
            }
            
            const username = sanitizeInput(document.getElementById('username').value.trim());
            const password = sanitizeInput(document.getElementById('password').value.trim());
            
            console.log('🔍 LOGIN DEBUG - Attempting secure login with:', {username, role});
            
            if(!username || !password) {
                document.getElementById('error-message').textContent='Please enter username and password';
                return;
            }
            
            // Use secure authentication
            const user = authenticateUser(username, password, role);
            console.log('🔍 LOGIN DEBUG - Authentication result:', user ? 'Success' : 'Failed');
            
            if(user){
                console.log('🔍 LOGIN SUCCESS - User found:', user);
                console.log('🔍 LOGIN SUCCESS - Setting role:', role);
                
                // For students and parents, check if account was properly created
                if((role === 'student' || role === 'parent') && !user.studentId) {
                    document.getElementById('error-message').textContent='Invalid account. Please create a new account.';
                    return;
                }
                
                localStorage.setItem('isLoggedIn','true');
                localStorage.setItem('userRole',role);
                localStorage.setItem('currentUser',JSON.stringify({username: user.username, role: user.role, mobile: user.mobile, name: user.name}));
                if(user.studentId) localStorage.setItem('studentId',user.studentId);
                
                console.log('🔍 LOGIN SUCCESS - Stored userRole:', localStorage.getItem('userRole'));
                console.log('🔍 LOGIN SUCCESS - Stored currentUser:', localStorage.getItem('currentUser'));
                
                document.body.classList.add('showing-app');
                document.body.classList.remove('showing-login');
                document.getElementById('login-page').style.setProperty('display', 'none', 'important');
                document.getElementById('app-page').style.setProperty('display', 'block', 'important');
                
                console.log('🔍 LOGIN SUCCESS - Calling initializeApp()');
                initializeApp();
                
                // Special initialization for guest and student mobile sidebar
                if((role === 'guest' || role === 'student') && window.innerWidth <= 768) {
                    setTimeout(() => {
                        console.log(`🔧 Post-login mobile sidebar fix for ${role} mode`);
                        if(window.forceFixGuestStudentSidebar) {
                            window.forceFixGuestStudentSidebar();
                        }
                    }, 200);
                }
            } else {
                if(role === 'student' || role === 'parent') {
                    document.getElementById('error-message').textContent='Invalid credentials. Please create an account first.';
                } else {
                    document.getElementById('error-message').textContent='Invalid admin credentials';
                }
            }
        };
        
        // Add multiple event listeners for mobile compatibility
        btn.addEventListener('click', handleLogin);
        btn.addEventListener('touchend', handleLogin);
        
        // Prevent double events on mobile
        btn.addEventListener('touchstart', (e) => {
            e.preventDefault();
        });
    });
    
    // Add mobile-friendly event handlers for other buttons
    const addMobileClickHandler = (elementId, callback) => {
        const element = document.getElementById(elementId);
        if (element) {
            element.addEventListener('click', callback);
            element.addEventListener('touchend', (e) => {
                e.preventDefault();
                callback();
            });
        }
    };
    
    addMobileClickHandler('create-account-btn', () => renderCreateAccountPage());
    addMobileClickHandler('admin-register-btn', () => renderAdminRegistrationPage());
    addMobileClickHandler('forgot-password-btn', () => renderForgotPasswordPage());
    
    // Prevent form submission refresh on mobile
    const loginForm = document.querySelector('.login-container form');
    if (loginForm) {
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            console.log('Form submission prevented - using button handlers instead');
        });
    }
    
    // Add mobile device detection and logging
    const isMobileDevice = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    if (isMobileDevice) {
        console.log('🔍 MOBILE DEVICE DETECTED - Enhanced touch handlers activated');
        document.body.classList.add('mobile-device');
    }
    
    // Load hostel logo
    setTimeout(loadHostelLogo, 100);
    
    // Enhanced video initialization for all devices
    setTimeout(() => {
        const video = document.querySelector('.hero-video');
        if (video) {
            console.log('Background video found, initializing...');
            
            // Ensure video attributes are set correctly
            video.muted = true;
            video.loop = true;
            video.autoplay = true;
            video.playsInline = true;
            
            // Load and attempt to play
            video.load();
            
            const playVideo = () => {
                video.play().then(() => {
                    console.log('Background video playing successfully');
                    video.style.opacity = '0.9';
                }).catch(e => {
                    console.log('Video autoplay failed (this is normal on some browsers):', e);
                    // Fallback: show animated background instead
                    video.style.display = 'none';
                });
            };
            
            // Try to play immediately
            playVideo();
            
            // Add user interaction listeners as fallback
            ['click', 'touchstart'].forEach(event => {
                document.addEventListener(event, playVideo, { once: true, passive: true });
            });
            
            // Error handling for video loading issues
            video.addEventListener('error', (e) => {
                console.log('Video loading error:', e);
                video.style.display = 'none';
            });
        } else {
            console.log('No background video element found');
        }
    }, 500);
}

// Guest Dashboard Function - Removed complex functionality

// Enhanced logout function for guest mode
window.logout = function() {
    localStorage.removeItem('isLoggedIn');
    localStorage.removeItem('userRole');
    localStorage.removeItem('studentId');
    localStorage.removeItem('currentUser');
    
    document.body.classList.add('showing-login');
    document.body.classList.remove('showing-app');
    document.getElementById('app-page').style.setProperty('display', 'none', 'important');
    document.getElementById('login-page').style.setProperty('display', 'block', 'important');
    renderLoginPage();
};

// Get current logged in user
function getCurrentUser() {
    const currentUserData = localStorage.getItem('currentUser');
    return currentUserData ? JSON.parse(currentUserData) : null;
}

// Check if current user is the default admin
function isDefaultAdmin() {
    const currentUser = getCurrentUser();
    return currentUser && currentUser.username === 'admin' && currentUser.role === 'admin';
}

// ---------- Create Account ----------
function renderCreateAccountPage(){
    const loginRoot=document.getElementById('login-page');
    
    // Simple method: Get hero video HTML
    const videoHTML = getHeroVideoHTML();
    
    loginRoot.innerHTML=`
    ${videoHTML}
    <div style="min-height:100vh;padding:20px;overflow-y:auto;position:relative;z-index:2;">
    <div class="create-account-container" style="max-width:700px;margin:0 auto;background:linear-gradient(135deg,rgba(255,51,102,0.002),rgba(51,102,255,0.002),rgba(0,255,136,0.002),rgba(255,136,0,0.002),rgba(170,0,255,0.002),rgba(0,170,255,0.002));-webkit-backdrop-filter:blur(0.2px);backdrop-filter:blur(0.2px);border-radius:15px;position:relative;">
    <div style="background:linear-gradient(135deg,#667eea,#764ba2);color:white;padding:20px;text-align:center;border-radius:15px 15px 0 0;">
    <div style="display:flex;align-items:center;justify-content:center;gap:12px;margin-bottom:10px;flex-direction:column;">
    <div style="width:50px;height:50px;background:rgba(255,255,255,0.2);border-radius:12px;display:grid;place-items:center;font-weight:800;font-size:1.5rem;box-shadow:0 6px 15px rgba(0,0,0,0.2);">🏠</div>
    <h1 style="margin:0;font-size:1.6rem;font-weight:800;text-shadow:0 2px 6px rgba(0,0,0,0.2);">Al Fizaa Girls Hostel</h1>
    </div>
    <p style="margin:0;opacity:0.9;font-size:0.9rem;font-weight:500;">✨ Student Registration Form ✨</p>
    </div>
    <div style="padding:20px;">

    <form id="account-form" style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
    <div><input type="text" id="new-username" placeholder="👤 Username *" required style="width:100%;padding:18px 20px;border:2px solid #e0e0e0;border-radius:15px;font-size:1.1rem;transition:all 0.3s ease;background:rgba(255,255,255,0.9);"></div>
    <div><input type="password" id="new-password" placeholder="🔒 Password *" required style="width:100%;padding:18px 20px;border:2px solid #e0e0e0;border-radius:15px;font-size:1.1rem;transition:all 0.3s ease;background:rgba(255,255,255,0.9);"></div>
    <div><input type="text" id="student-name" placeholder="📝 Full Name *" required style="width:100%;padding:18px 20px;border:2px solid #e0e0e0;border-radius:15px;font-size:1.1rem;transition:all 0.3s ease;background:rgba(255,255,255,0.9);"></div>
    <div><input type="text" id="student-bform" placeholder="🆔 Your B-form/CNIC No (13 digits) *" pattern="[0-9]{13}" title="Enter 13 digits without dashes" maxlength="13" required style="width:100%;padding:18px 20px;border:2px solid #e0e0e0;border-radius:15px;font-size:1.1rem;transition:all 0.3s ease;background:rgba(255,255,255,0.9);" oninput="this.value = this.value.replace(/[^0-9]/g, '')"></div>
    <div><input type="tel" id="student-contact" placeholder="📱 Your Contact (+923001234567) *" pattern="\\+92[0-9]{10}" title="Enter full WhatsApp number starting with +92" maxlength="13" required style="width:100%;padding:18px 20px;border:2px solid #e0e0e0;border-radius:15px;font-size:1.1rem;transition:all 0.3s ease;background:rgba(255,255,255,0.9);" oninput="formatWhatsAppNumber(this)"></div>
    <div><label for="student-photo" style="cursor:pointer;padding:18px 20px;border:2px solid #e0e0e0;border-radius:15px;display:block;text-align:center;background:linear-gradient(135deg,#f8f9fa,#e9ecef);font-size:1.1rem;font-weight:600;color:#667eea;transition:all 0.3s ease;">📸 Upload Photo *</label><input type="file" id="student-photo" accept="image/*" required style="display:none;"></div>
    <div><input type="text" id="guardian-name" placeholder="👨‍👩‍👧 Guardian Name *" required style="width:100%;padding:18px 20px;border:2px solid #e0e0e0;border-radius:15px;font-size:1.1rem;transition:all 0.3s ease;background:rgba(255,255,255,0.9);"></div>
    <div><input type="tel" id="guardian-contact" placeholder="📞 Guardian Contact (+923001234567) *" pattern="\\+92[0-9]{10}" title="Enter full WhatsApp number starting with +92" maxlength="13" required style="width:100%;padding:18px 20px;border:2px solid #e0e0e0;border-radius:15px;font-size:1.1rem;transition:all 0.3s ease;background:rgba(255,255,255,0.9);" oninput="formatWhatsAppNumber(this)"></div>
    <div><input type="text" id="guardian-id" placeholder="🆔 Guardian CNIC (13 digits) *" pattern="[0-9]{13}" title="Enter 13 digits without dashes" maxlength="13" required style="width:100%;padding:18px 20px;border:2px solid #e0e0e0;border-radius:15px;font-size:1.1rem;transition:all 0.3s ease;background:rgba(255,255,255,0.9);" oninput="this.value = this.value.replace(/[^0-9]/g, '')"></div>
    <div><input type="text" id="student-village" placeholder=" ️ Village *" required style="width:100%;padding:18px 20px;border:2px solid #e0e0e0;border-radius:15px;font-size:1.1rem;transition:all 0.3s ease;background:rgba(255,255,255,0.9);"></div>
    <div><input type="text" id="current-institution" placeholder="  Current Institution Name *" required style="width:100%;padding:18px 20px;border:2px solid #e0e0e0;border-radius:15px;font-size:1.1rem;transition:all 0.3s ease;background:rgba(255,255,255,0.9);"></div>
    <!-- Financial Information -->
    <div><input type="number" id="fee-paid" placeholder=" Fee Paid (PKR) *" required min="0" style="width:100%;padding:18px 20px;border:2px solid #e0e0e0;border-radius:15px;font-size:1.1rem;transition:all 0.3s ease;background:rgba(255,255,255,0.9);"></div>
    <div><input type="number" id="total-fee" placeholder=" Total Fee (PKR) *" required min="0" style="width:100%;padding:18px 20px;border:2px solid #e0e0e0;border-radius:15px;font-size:1.1rem;transition:all 0.3s ease;background:rgba(255,255,255,0.9);"></div>
    <!-- Emergency Contact and Dates -->
    <div><input type="tel" id="emergency-contact" placeholder=" Emergency Contact (+923001234567) *" pattern="\+92[0-9]{10}" title="Enter full WhatsApp number starting with +92" maxlength="13" required style="width:100%;padding:18px 20px;border:2px solid #e0e0e0;border-radius:15px;font-size:1.1rem;transition:all 0.3s ease;background:rgba(255,255,255,0.9);" oninput="formatWhatsAppNumber(this)"></div>
    <div><input type="date" id="admission-date" placeholder=" Admission Date *" required style="width:100%;padding:18px 20px;border:2px solid #e0e0e0;border-radius:15px;font-size:1.1rem;transition:all 0.3s ease;background:rgba(255,255,255,0.9);"></div>
    <div><input type="date" id="graduation-date" placeholder=" Expected Graduation Date *" required style="width:100%;padding:18px 20px;border:2px solid #e0e0e0;border-radius:15px;font-size:1.1rem;transition:all 0.3s ease;background:rgba(255,255,255,0.9);"></div>
    <!-- Medical Information -->
    <div><textarea id="medical-issues" placeholder=" Medical Issues (if any) *" required style="width:100%;padding:18px 20px;border:2px solid #e0e0e0;border-radius:15px;font-size:1.1rem;transition:all 0.3s ease;background:rgba(255,255,255,0.9);resize:vertical;min-height:80px;"></textarea></div>
    <!-- Documents Upload Section -->
    <div style="grid-column:1/-1;background:linear-gradient(135deg,#f8f9fa,#e9ecef);padding:20px;border-radius:15px;border:2px solid #e0e0e0;margin:10px 0;">
    <h3 style="color:#667eea;margin:0 0 15px 0;font-size:1.1rem;font-weight:700;text-align:center;"> Documents Upload (Required)</h3>
    <div style="display:grid;grid-template-columns:1fr;gap:12px;">
    <div><label for="admission-form-doc" style="cursor:pointer;padding:15px 18px;border:2px solid #667eea;border-radius:12px;display:block;text-align:center;background:linear-gradient(135deg,#ffffff,#f8f9ff);font-size:1rem;font-weight:600;color:#667eea;transition:all 0.3s ease;"> Upload Admission Form *</label><input type="file" id="admission-form-doc" accept="image/*,.pdf" required style="display:none;"></div>
    <div><label for="bform-doc" style="cursor:pointer;padding:15px 18px;border:2px solid #764ba2;border-radius:12px;display:block;text-align:center;background:linear-gradient(135deg,#ffffff,#faf8ff);font-size:1rem;font-weight:600;color:#764ba2;transition:all 0.3s ease;"> Upload B-form/ID Card *</label><input type="file" id="bform-doc" accept="image/*,.pdf" required style="display:none;"></div>
    <div><label for="father-id-doc" style="cursor:pointer;padding:15px 18px;border:2px solid #f093fb;border-radius:12px;display:block;text-align:center;background:linear-gradient(135deg,#ffffff,#fff8fd);font-size:1rem;font-weight:600;color:#f093fb;transition:all 0.3s ease;"> Upload Father ID *</label><input type="file" id="father-id-doc" accept="image/*,.pdf" required style="display:none;"></div>
    </div>
    </div>
    <div><input type="text" id="student-signature" placeholder="✍️ Enter Your Name for Digital Signature *" required style="width:100%;padding:18px 20px;border:2px solid #e0e0e0;border-radius:15px;font-size:1.1rem;transition:all 0.3s ease;background:rgba(255,255,255,0.9);"></div>
    <div style="grid-column:1/-1;text-align:center;margin-top:12px;">
    <p id="account-error" style="color:#e74c3c;margin:10px 0;font-weight:600;font-size:0.85rem;"></p>
    <div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap;">
    <button type="button" id="create-new-account" style="padding:10px 18px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;border-radius:10px;font-weight:700;font-size:0.9rem;cursor:pointer;transition:all 0.3s ease;box-shadow:0 5px 15px rgba(102,126,234,0.3);">🎉 Create Account</button>
    <button type="button" id="back-login" style="padding:10px 18px;background:linear-gradient(135deg,#6c757d,#495057);color:white;border:none;border-radius:10px;font-weight:700;font-size:0.9rem;cursor:pointer;transition:all 0.3s ease;box-shadow:0 5px 15px rgba(108,117,125,0.3);">⬅️ Back to Login</button>
    </div>
    </div>
    </form>
    </div>
    </div>
    </div>
    `;
    document.getElementById('create-new-account').addEventListener('click',()=>{
        // Show loading indicator and disable button
        const submitBtn = document.getElementById('create-new-account');
        const originalText = submitBtn.textContent;
        submitBtn.textContent = '⏳ Processing...';
        submitBtn.disabled = true;
        
        // Use setTimeout to allow UI to update before processing
        setTimeout(() => {
            try {
                const uname=document.getElementById('new-username').value.trim();
                const pwd=document.getElementById('new-password').value.trim();
                const sname=document.getElementById('student-name').value.trim();
                const sbform=document.getElementById('student-bform').value.trim();
                const scontact=document.getElementById('student-contact').value.trim();
                const sphoto=document.getElementById('student-photo').files[0];
                const gname=document.getElementById('guardian-name').value.trim();
                const gcontact=document.getElementById('guardian-contact').value.trim();
                const gid=document.getElementById('guardian-id').value.trim();
                const village=document.getElementById('student-village').value.trim();
                const institution=document.getElementById('current-institution').value.trim();
                const signature=document.getElementById('student-signature').value.trim();
                
                // New required fields
                const feePaid=document.getElementById('fee-paid').value.trim();
                const totalFee=document.getElementById('total-fee').value.trim();
                const emergencyContact=document.getElementById('emergency-contact').value.trim();
                const admissionDate=document.getElementById('admission-date').value.trim();
                const graduationDate=document.getElementById('graduation-date').value.trim();
                const medicalIssues=document.getElementById('medical-issues').value.trim();
                const admissionFormDoc=document.getElementById('admission-form-doc').files[0];
                const bformDoc=document.getElementById('bform-doc').files[0];
                const fatherIdDoc=document.getElementById('father-id-doc').files[0];
                
                const users=JSON.parse(localStorage.getItem('userCredentials')||'[]');
        if(!uname || !pwd || !sname || !sbform || !scontact || !sphoto || !gname || !gcontact || !gid || !village || !institution || !signature || !feePaid || !totalFee || !emergencyContact || !admissionDate || !graduationDate || !medicalIssues || !admissionFormDoc || !bformDoc || !fatherIdDoc) {
            document.getElementById('account-error').textContent='Please fill all required fields marked with * and upload all required documents';
            return;
        }
        if(!/^[0-9]{13}$/.test(sbform)) {
            document.getElementById('account-error').textContent='B-form/CNIC must be exactly 13 digits';
            return;
        }
        if(!/^\+92[0-9]{10}$/.test(scontact) || !/^\+92[0-9]{10}$/.test(gcontact) || !/^\+92[0-9]{10}$/.test(emergencyContact)) {
            document.getElementById('account-error').textContent='Contact numbers must be in format +92XXXXXXXXXX (13 digits total)';
            return;
        }
        if(!/^[0-9]{13}$/.test(gid)) {
            document.getElementById('account-error').textContent='Guardian CNIC must be exactly 13 digits';
            return;
        }
        // Validate financial fields
        const feePaidNum = parseFloat(feePaid);
        const totalFeeNum = parseFloat(totalFee);
        if(feePaidNum < 0 || totalFeeNum < 0) {
            document.getElementById('account-error').textContent='Fee amounts cannot be negative';
            return;
        }
        if(feePaidNum > totalFeeNum) {
            document.getElementById('account-error').textContent='Fee paid cannot be greater than total fee';
            return;
        }
        // Validate dates
        const admissionDateObj = new Date(admissionDate);
        const graduationDateObj = new Date(graduationDate);
        const today = new Date();
        if(graduationDateObj <= admissionDateObj) {
            document.getElementById('account-error').textContent='Graduation date must be after admission date';
            return;
        }
        if(users.find(u=>u.username===uname || u.username===uname+'_parent')){
            document.getElementById('account-error').textContent='Username already exists';
            return;
        }
        // Process multiple files (optimized for mobile)
        const processFiles = () => {
            let filesProcessed = 0;
            const totalFiles = 4; // photo + 3 documents
            const fileData = {};
            
            // Show progress to user
            document.getElementById('account-error').style.color='blue';
            document.getElementById('account-error').textContent='📤 Uploading files... Please wait';
            
            const checkAllFilesProcessed = () => {
                if(filesProcessed === totalFiles) {
                    // Validate password strength before processing
                    const passwordValidation = validatePassword(pwd);
                    if (!passwordValidation.valid) {
                        document.getElementById('account-error').textContent = passwordValidation.message;
                        return;
                    }
                    
                    // Sanitize all inputs
                    const sanitizedData = {
                        uname: sanitizeInput(uname),
                        pwd: simpleHash(pwd), // Hash the password
                        sname: sanitizeInput(sname),
                        sbform: sanitizeInput(sbform),
                        scontact: sanitizeInput(scontact),
                        gname: sanitizeInput(gname),
                        gcontact: sanitizeInput(gcontact),
                        gid: sanitizeInput(gid),
                        village: sanitizeInput(village),
                        institution: sanitizeInput(institution),
                        signature: sanitizeInput(signature),
                        feePaid: sanitizeInput(feePaid),
                        totalFee: sanitizeInput(totalFee),
                        emergencyContact: sanitizeInput(emergencyContact)
                    };
                    
                    // Calculate due amount
                    const dueAmount = parseFloat(totalFee) - parseFloat(feePaid);
                    
                    // Generate sequential AF01, AF02, etc. student ID
                    let students = JSON.parse(localStorage.getItem('studentList')||'[]');
                    const nextNumber = String(students.length + 1).padStart(2, '0');
                    const studentId = 'AF' + nextNumber;
                    
                    // Store as pending account instead of directly creating
                    const pendingAccount = {
                        id: Date.now(),
                        username: sanitizedData.uname,
                        password: sanitizedData.pwd,
                        studentId: studentId,
                        studentName: sanitizedData.sname,
                        studentBform: sanitizedData.sbform,
                        studentContact: sanitizedData.scontact,
                        photo: fileData.photo,
                        guardianName: sanitizedData.gname,
                        guardianContact: sanitizedData.gcontact,
                        guardianId: sanitizedData.gid,
                        village: sanitizedData.village,
                        currentInstitution: sanitizedData.institution,
                        signature: sanitizedData.signature,
                        // New fields
                        feePaid: parseFloat(feePaid),
                        totalFee: parseFloat(totalFee),
                        dueAmount: dueAmount,
                        emergencyContact: sanitizedData.emergencyContact,
                        admissionDate: admissionDate,
                        graduationDate: graduationDate,
                        medicalIssues: medicalIssues,
                        admissionForm: fileData.admissionForm,
                        bformDocument: fileData.bformDocument,
                        fatherIdDocument: fileData.fatherIdDocument,
                        submissionDate: new Date().toISOString(),
                        status: 'pending'
                    };
                    
                    // Use requestIdleCallback for better performance if available
                    const processSubmission = () => {
                        // Store pending account
                        let pendingAccounts = JSON.parse(localStorage.getItem('pendingAccounts') || '[]');
                        pendingAccounts.push(pendingAccount);
                        localStorage.setItem('pendingAccounts', JSON.stringify(pendingAccounts));
                        
                        // Create admin notification with updated message
                        createAdminNotification({
                            type: 'new_account_request',
                            title: 'New Student Account Request',
                            message: `New registration request from ${sname} (${uname})`,
                            studentData: pendingAccount,
                            timestamp: new Date().toISOString(),
                            whatsappMessage: `🎓 *New Student Registration Request*\n\n*Student Name:* ${sname}\n*Username:* ${uname}\n*B-form/CNIC:* ${sbform}\n*Contact:* ${scontact}\n*Emergency Contact:* ${emergencyContact}\n*Guardian:* ${gname}\n*Guardian Contact:* ${gcontact}\n*Guardian CNIC:* ${gid}\n*Village:* ${village}\n*Current Institution:* ${institution}\n*Fee Paid:* PKR ${feePaid}\n*Total Fee:* PKR ${totalFee}\n*Due Amount:* PKR ${dueAmount}\n*Admission Date:* ${admissionDate}\n*Expected Graduation:* ${graduationDate}\n*Medical Issues:* ${medicalIssues}\n*Digital Signature:* ${signature}\n\n*Action Required:* Please review and approve/reject this registration request in the admin panel.\n\n*Time:* ${new Date().toLocaleString()}`
                        });
                        
                        document.getElementById('account-error').style.color='green';
                        document.getElementById('account-error').textContent='✅ Registration submitted successfully! Admin will review and approve your account.';
                        
                        // Clear all form fields (optimized with single DOM query)
                        const formInputs = document.querySelectorAll('#account-form input, #account-form textarea');
                        formInputs.forEach(input => {
                            if(input.type === 'file') {
                                input.value = '';
                            } else {
                                input.value = '';
                            }
                        });
                    };
                    
                    // Use requestIdleCallback if available, otherwise setTimeout
                    if (window.requestIdleCallback) {
                        requestIdleCallback(processSubmission);
                    } else {
                        setTimeout(processSubmission, 50);
                    }
                }
            };
            
            // Process files with compression for mobile (async to prevent blocking)
            const processFileAsync = (file, key, callback) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    fileData[key] = e.target.result;
                    filesProcessed++;
                    callback();
                };
                reader.readAsDataURL(file);
            };
            
            // Process all files
            processFileAsync(sphoto, 'photo', checkAllFilesProcessed);
            processFileAsync(admissionFormDoc, 'admissionForm', checkAllFilesProcessed);
            processFileAsync(bformDoc, 'bformDocument', checkAllFilesProcessed);
            processFileAsync(fatherIdDoc, 'fatherIdDocument', checkAllFilesProcessed);
        };
        
        processFiles();
            } catch (error) {
                console.error('Error processing form:', error);
                document.getElementById('account-error').style.color='red';
                document.getElementById('account-error').textContent='An error occurred. Please try again.';
            } finally {
                // Re-enable button
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        }, 100); // Small delay to allow UI update
    });
    document.getElementById('back-login').addEventListener('click',()=>renderLoginPage());
    
    // Add WhatsApp number formatting function
    // Optimized WhatsApp number formatting with increased debouncing for mobile performance
    let formatTimeout;
    window.formatWhatsAppNumber = function(input) {
        // Clear previous timeout to debounce rapid input
        clearTimeout(formatTimeout);
        
        formatTimeout = setTimeout(() => {
            let value = input.value.replace(/[^+0-9]/g, ''); // Remove all except + and digits
            
            // If user starts typing without +92, add it
            if (value && !value.startsWith('+92')) {
                if (value.startsWith('92')) {
                    value = '+' + value;
                } else if (value.startsWith('3') || value.startsWith('0')) {
                    value = '+92' + value;
                } else {
                    value = '+92' + value;
                }
            }
            
            // Ensure it starts with +92 and limit to 13 characters
            if (value.startsWith('+92')) {
                value = value.substring(0, 13);
            } else if (value.length > 0) {
                value = '+92';
            }
            
            input.value = value;
        }, 100); // Increased debounce to 100ms for better mobile performance
    };
    
    // Add hover effects for buttons
    document.getElementById('create-new-account').addEventListener('mouseenter', function() {
        this.style.transform = 'translateY(-3px)';
        this.style.boxShadow = '0 15px 35px rgba(102,126,234,0.4)';
    });
    document.getElementById('create-new-account').addEventListener('mouseleave', function() {
        this.style.transform = 'translateY(0)';
        this.style.boxShadow = '0 8px 25px rgba(102,126,234,0.3)';
    });
    document.getElementById('back-login').addEventListener('mouseenter', function() {
        this.style.transform = 'translateY(-3px)';
        this.style.boxShadow = '0 15px 35px rgba(108,117,125,0.4)';
    });
    document.getElementById('back-login').addEventListener('mouseleave', function() {
        this.style.transform = 'translateY(0)';
        this.style.boxShadow = '0 8px 25px rgba(108,117,125,0.3)';
    });
    
    // Add focus effects for inputs
    document.querySelectorAll('input').forEach(input => {
        input.addEventListener('focus', function() {
            this.style.borderColor = '#667eea';
            this.style.boxShadow = '0 0 20px rgba(102,126,234,0.2)';
            this.style.transform = 'translateY(-2px)';
        });
        input.addEventListener('blur', function() {
            this.style.borderColor = '#e0e0e0';
            this.style.boxShadow = 'none';
            this.style.transform = 'translateY(0)';
        });
    });
    
    // Add hover effect for file upload label
    document.querySelector('label[for="student-photo"]').addEventListener('mouseenter', function() {
        this.style.background = 'linear-gradient(135deg,#667eea,#764ba2)';
        this.style.color = 'white';
        this.style.transform = 'translateY(-2px)';
    });
    document.querySelector('label[for="student-photo"]').addEventListener('mouseleave', function() {
        this.style.background = 'linear-gradient(135deg,#f8f9fa,#e9ecef)';
        this.style.color = '#667eea';
        this.style.transform = 'translateY(0)';
    });
}

// ---------- Forgot Password ----------
function renderForgotPasswordPage(){
    const loginRoot=document.getElementById('login-page');
    
    // Simple method: Get hero video HTML
    const videoHTML = getHeroVideoHTML();
    
    loginRoot.innerHTML=`
    ${videoHTML}
    <div style="min-height:100vh;padding:20px;overflow-y:auto;position:relative;z-index:2;display:flex;align-items:center;justify-content:center;">
    <div style="max-width:500px;width:100%;background:rgba(255,255,255,0.95);backdrop-filter:blur(20px);border-radius:15px;box-shadow:0 15px 30px rgba(0,0,0,0.15);">
    <div style="background:linear-gradient(135deg,#f39c12,#e67e22);color:white;padding:20px;text-align:center;border-radius:15px 15px 0 0;">
    <div style="display:flex;align-items:center;justify-content:center;gap:12px;margin-bottom:10px;flex-direction:column;">
    <div style="width:50px;height:50px;background:rgba(255,255,255,0.2);border-radius:12px;display:grid;place-items:center;font-weight:800;font-size:1.5rem;box-shadow:0 6px 15px rgba(0,0,0,0.2);">🔑</div>
    <h1 style="margin:0;font-size:1.6rem;font-weight:800;text-shadow:0 2px 6px rgba(0,0,0,0.2);">Password Reset</h1>
    </div>
    <p style="margin:0;opacity:0.9;font-size:0.9rem;font-weight:500;">Reset your password using your registered mobile number</p>
    </div>
    <div style="padding:30px;">

    <form id="forgot-password-form">
    <div style="margin-bottom:20px;">
    <input type="text" id="reset-username" placeholder="👤 Enter Your Username" required style="width:100%;padding:18px 20px;border:2px solid #e0e0e0;border-radius:15px;font-size:1.1rem;transition:all 0.3s ease;background:rgba(255,255,255,0.9);">
    </div>
    <div style="margin-bottom:20px;">
    <input type="tel" id="reset-mobile" placeholder="📱 Enter Your Registered Mobile (+923001234567)" pattern="\\+92[0-9]{10}" maxlength="13" required style="width:100%;padding:18px 20px;border:2px solid #e0e0e0;border-radius:15px;font-size:1.1rem;transition:all 0.3s ease;background:rgba(255,255,255,0.9);" oninput="formatWhatsAppNumber(this)">>
    </div>
    
    <div id="verification-section" style="display:none;margin-bottom:20px;">
    <input type="text" id="verification-code" placeholder="🔐 Enter 6-digit verification code" pattern="[0-9]{6}" maxlength="6" style="width:100%;padding:18px 20px;border:2px solid #e0e0e0;border-radius:15px;font-size:1.1rem;transition:all 0.3s ease;background:rgba(255,255,255,0.9);text-align:center;letter-spacing:3px;">
    <p style="font-size:0.85rem;color:#666;margin-top:8px;text-align:center;">Check your mobile for the verification code</p>
    </div>
    
    <div id="new-password-section" style="display:none;margin-bottom:20px;">
    <input type="password" id="new-reset-password" placeholder="🔒 Enter New Password" required style="width:100%;padding:18px 20px;border:2px solid #e0e0e0;border-radius:15px;font-size:1.1rem;transition:all 0.3s ease;background:rgba(255,255,255,0.9);margin-bottom:12px;">
    <input type="password" id="confirm-reset-password" placeholder="🔒 Confirm New Password" required style="width:100%;padding:18px 20px;border:2px solid #e0e0e0;border-radius:15px;font-size:1.1rem;transition:all 0.3s ease;background:rgba(255,255,255,0.9);">
    </div>
    
    <p id="reset-message" style="color:#e74c3c;margin:15px 0;font-weight:600;font-size:0.9rem;text-align:center;"></p>
    
    <div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap;">
    <button type="button" id="send-verification" style="padding:12px 20px;background:linear-gradient(135deg,#f39c12,#e67e22);color:white;border:none;border-radius:10px;font-weight:700;font-size:0.95rem;cursor:pointer;transition:all 0.3s ease;box-shadow:0 5px 15px rgba(243,156,18,0.3);">📲 Send Code</button>
    <button type="button" id="verify-code" style="display:none;padding:12px 20px;background:linear-gradient(135deg,#27ae60,#2ecc71);color:white;border:none;border-radius:10px;font-weight:700;font-size:0.95rem;cursor:pointer;transition:all 0.3s ease;box-shadow:0 5px 15px rgba(39,174,96,0.3);">✅ Verify Code</button>
    <button type="button" id="reset-password-final" style="display:none;padding:12px 20px;background:linear-gradient(135deg,#8e44ad,#9b59b6);color:white;border:none;border-radius:10px;font-weight:700;font-size:0.95rem;cursor:pointer;transition:all 0.3s ease;box-shadow:0 5px 15px rgba(142,68,173,0.3);">🔄 Reset Password</button>
    <button type="button" id="back-to-login" style="padding:12px 20px;background:linear-gradient(135deg,#6c757d,#495057);color:white;border:none;border-radius:10px;font-weight:700;font-size:0.95rem;cursor:pointer;transition:all 0.3s ease;box-shadow:0 5px 15px rgba(108,117,125,0.3);">⬅️ Back to Login</button>
    </div>
    </form>
    </div>
    </div>
    </div>
    `;
    
    let verificationCode = '';
    let resetUsername = '';
    
    // Send verification code
    document.getElementById('send-verification').addEventListener('click', function() {
        const username = document.getElementById('reset-username').value.trim();
        const mobile = document.getElementById('reset-mobile').value.trim();
        
        if (!username || !mobile) {
            document.getElementById('reset-message').textContent = 'Please fill in all fields';
            return;
        }
        
        if (!/^\+92[0-9]{10}$/.test(mobile)) {
            document.getElementById('reset-message').textContent = 'Mobile number must be in format +92XXXXXXXXXX (13 digits total)';
            return;
        }
        
        // Check if user exists and mobile matches
        const users = JSON.parse(localStorage.getItem('userCredentials') || '[]');
        const students = JSON.parse(localStorage.getItem('studentList') || '[]');
        
        const user = users.find(u => u.username === username);
        const student = students.find(s => s.studentId === username || s.studentName.toLowerCase().includes(username.toLowerCase()));
        
        if (!user) {
            document.getElementById('reset-message').textContent = 'Username not found';
            return;
        }
        
        // Find student record to verify mobile
        let registeredMobile = '';
        if (student && student.studentContact) {
            registeredMobile = student.studentContact;
        }
        
        if (!registeredMobile) {
            document.getElementById('reset-message').textContent = 'No mobile number found for this account';
            return;
        }
        
        // Compare mobile numbers directly (both should have +92 format)
        if (registeredMobile !== mobile) {
            document.getElementById('reset-message').textContent = 'Mobile number does not match our records';
            return;
        }
        
        // Generate verification code
        verificationCode = Math.floor(100000 + Math.random() * 900000).toString();
        resetUsername = username;
        
        // In a real app, send SMS here
        console.log('Verification code:', verificationCode); // For testing
        
        // Show verification section
        document.getElementById('verification-section').style.display = 'block';
        document.getElementById('send-verification').style.display = 'none';
        document.getElementById('verify-code').style.display = 'inline-block';
        
        document.getElementById('reset-message').style.color = 'green';
        document.getElementById('reset-message').textContent = `✅ Verification code sent to ${mobile}`;
        
        // Simulate sending WhatsApp message (in real app, integrate with WhatsApp API)
        const whatsappMessage = `🔐 *Password Reset Code*\\n\\nYour verification code is: *${verificationCode}*\\n\\nThis code will expire in 10 minutes.\\n\\n*Al Fizaa Girls Hostel*`;
        console.log('WhatsApp message would be sent:', whatsappMessage);
    });
    
    // Verify code
    document.getElementById('verify-code').addEventListener('click', function() {
        const enteredCode = document.getElementById('verification-code').value.trim();
        
        if (!enteredCode) {
            document.getElementById('reset-message').textContent = 'Please enter verification code';
            return;
        }
        
        if (enteredCode !== verificationCode) {
            document.getElementById('reset-message').textContent = 'Invalid verification code';
            return;
        }
        
        // Show new password section
        document.getElementById('new-password-section').style.display = 'block';
        document.getElementById('verify-code').style.display = 'none';
        document.getElementById('reset-password-final').style.display = 'inline-block';
        
        document.getElementById('reset-message').style.color = 'green';
        document.getElementById('reset-message').textContent = '✅ Code verified! Enter your new password';
    });
    
    // Reset password
    document.getElementById('reset-password-final').addEventListener('click', function() {
        const newPassword = document.getElementById('new-reset-password').value.trim();
        const confirmPassword = document.getElementById('confirm-reset-password').value.trim();
        
        if (!newPassword || !confirmPassword) {
            document.getElementById('reset-message').textContent = 'Please fill in both password fields';
            return;
        }
        
        if (newPassword !== confirmPassword) {
            document.getElementById('reset-message').textContent = 'Passwords do not match';
            return;
        }
        
        if (newPassword.length < 6) {
            document.getElementById('reset-message').textContent = 'Password must be at least 6 characters';
            return;
        }
        
        // Update password in storage
        const users = JSON.parse(localStorage.getItem('userCredentials') || '[]');
        const userIndex = users.findIndex(u => u.username === resetUsername);
        
        if (userIndex !== -1) {
            users[userIndex].password = newPassword;
            localStorage.setItem('userCredentials', JSON.stringify(users));
            
            document.getElementById('reset-message').style.color = 'green';
            document.getElementById('reset-message').textContent = '✅ Password reset successful! You can now login with your new password';
            
            // Hide all sections except back button
            document.getElementById('forgot-password-form').style.display = 'none';
            
            // Auto redirect to login after 3 seconds
            setTimeout(() => {
                renderLoginPage();
            }, 3000);
        } else {
            document.getElementById('reset-message').textContent = 'Error updating password. Please try again.';
        }
    });
    
    // Back to login
    document.getElementById('back-to-login').addEventListener('click', function() {
        renderLoginPage();
    });
    
    // Add focus effects for inputs
    document.querySelectorAll('input').forEach(input => {
        input.addEventListener('focus', function() {
            this.style.borderColor = '#f39c12';
            this.style.boxShadow = '0 0 20px rgba(243,156,18,0.2)';
            this.style.transform = 'translateY(-2px)';
        });
        input.addEventListener('blur', function() {
            this.style.borderColor = '#e0e0e0';
            this.style.boxShadow = 'none';
            this.style.transform = 'translateY(0)';
        });
    });
}

// ---------- Admin Registration Page ----------
function renderAdminRegistrationPage(){
    const loginRoot=document.getElementById('login-page');
    
    // Simple method: Get hero video HTML
    const videoHTML = getHeroVideoHTML();
    
    loginRoot.innerHTML=`
    ${videoHTML}
    <div style="min-height:100vh;padding:20px;overflow-y:auto;position:relative;z-index:2;display:flex;align-items:center;justify-content:center;">
    <div style="max-width:500px;width:100%;background:rgba(255,255,255,0.95);-webkit-backdrop-filter:blur(20px);backdrop-filter:blur(20px);border-radius:15px;box-shadow:0 15px 30px rgba(0,0,0,0.15);">
    <div style="background:linear-gradient(135deg,#dc3545,#c82333);color:white;padding:20px;text-align:center;border-radius:15px 15px 0 0;">
    <div style="display:flex;align-items:center;justify-content:center;gap:12px;margin-bottom:10px;flex-direction:column;">
    <div style="width:50px;height:50px;background:rgba(255,255,255,0.2);border-radius:12px;display:grid;place-items:center;font-weight:800;font-size:1.5rem;box-shadow:0 6px 15px rgba(0,0,0,0.2);">👑</div>
    <h2 style="margin:0;font-weight:800;font-size:1.5rem;text-shadow:1px 1px 3px rgba(0,0,0,0.2);">Admin Registration</h2>
    </div>
    <p style="margin:0;color:rgba(255,255,255,0.9);font-size:0.95rem;font-weight:500;">Request admin access with mobile verification</p>
    </div>
    
    <form id="admin-registration-form" style="padding:25px;">
    <div style="margin-bottom:20px;">
    <h3 style="color:#dc3545;margin:0 0 15px 0;font-size:1.1rem;font-weight:700;text-align:center;">🛡️ Secure Admin Registration</h3>
    <p style="color:#666;font-size:0.9rem;margin:0 0 20px 0;text-align:center;line-height:1.5;">Only authorized personnel can request admin access. Your request will be reviewed by the default admin.</p>
    </div>
    
    <div style="margin-bottom:15px;">
    <input type="text" id="admin-name" placeholder="👤 Your Full Name *" required style="width:100%;padding:15px 18px;border:2px solid #e0e0e0;border-radius:10px;font-size:1rem;transition:all 0.3s ease;background:rgba(255,255,255,0.9);box-sizing:border-box;">
    </div>
    
    <div style="margin-bottom:15px;">
    <input type="tel" id="admin-mobile" placeholder="📱 Your Mobile Number (+923001234567) *" pattern="\\+92[0-9]{10}" title="Enter full WhatsApp number starting with +92" maxlength="13" required style="width:100%;padding:15px 18px;border:2px solid #e0e0e0;border-radius:10px;font-size:1rem;transition:all 0.3s ease;background:rgba(255,255,255,0.9);box-sizing:border-box;" oninput="formatWhatsAppNumber(this)">
    </div>
    
    <div style="margin-bottom:15px;">
    <input type="text" id="admin-position" placeholder="💼 Your Position/Role *" required style="width:100%;padding:15px 18px;border:2px solid #e0e0e0;border-radius:10px;font-size:1rem;transition:all 0.3s ease;background:rgba(255,255,255,0.9);box-sizing:border-box;">
    </div>
    
    <div style="margin-bottom:20px;">
    <textarea id="admin-reason" placeholder="📝 Reason for Admin Access Request *" required style="width:100%;padding:15px 18px;border:2px solid #e0e0e0;border-radius:10px;font-size:1rem;transition:all 0.3s ease;background:rgba(255,255,255,0.9);resize:vertical;min-height:80px;box-sizing:border-box;"></textarea>
    </div>
    
    <div style="background:linear-gradient(135deg,#fff3cd 0%,#ffeaa7 50%,#ffeb3b 100%);border-left:6px solid #ffc107;border-radius:10px;padding:15px;margin-bottom:20px;">
    <p style="margin:0;color:#856404;font-weight:600;font-size:0.9rem;line-height:1.5;">⚠️ <strong>Security Notice:</strong> Your request will be sent to the default admin (+923411666480) via WhatsApp for approval. Only submit if you are authorized to access the admin panel.</p>
    </div>
    
    <p id="admin-register-message" style="color:#e74c3c;margin:15px 0;font-weight:600;font-size:0.9rem;text-align:center;"></p>
    
    <div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap;">
    <button type="button" id="submit-admin-request" style="padding:12px 20px;background:linear-gradient(135deg,#dc3545,#c82333);color:white;border:none;border-radius:10px;font-weight:700;font-size:0.95rem;cursor:pointer;transition:all 0.3s ease;box-shadow:0 5px 15px rgba(220,53,69,0.3);">👑 Submit Request</button>
    <button type="button" id="back-to-login-admin" style="padding:12px 20px;background:linear-gradient(135deg,#6c757d,#495057);color:white;border:none;border-radius:10px;font-weight:700;font-size:0.95rem;cursor:pointer;transition:all 0.3s ease;box-shadow:0 5px 15px rgba(108,117,125,0.3);">⬅️ Back to Login</button>
    </div>
    </form>
    </div>
    </div>
    `;
    
    // Submit admin request
    document.getElementById('submit-admin-request').addEventListener('click', function() {
        const submitBtn = document.getElementById('submit-admin-request');
        const originalText = submitBtn.textContent;
        
        const name = document.getElementById('admin-name').value.trim();
        const mobile = document.getElementById('admin-mobile').value.trim();
        const position = document.getElementById('admin-position').value.trim();
        const reason = document.getElementById('admin-reason').value.trim();
        
        if (!name || !mobile || !position || !reason) {
            document.getElementById('admin-register-message').textContent = 'Please fill in all required fields';
            return;
        }
        
        if (!/^\+92[0-9]{10}$/.test(mobile)) {
            document.getElementById('admin-register-message').textContent = 'Mobile number must be in format +92XXXXXXXXXX (13 digits total)';
            return;
        }
        
        // Check if mobile already has pending or approved admin request
        const pendingAdmins = JSON.parse(localStorage.getItem('pendingAdmins') || '[]');
        const users = JSON.parse(localStorage.getItem('userCredentials') || '[]');
        
        if (pendingAdmins.find(p => p.mobile === mobile)) {
            document.getElementById('admin-register-message').textContent = 'A request with this mobile number is already pending approval';
            return;
        }
        
        if (users.find(u => u.mobile === mobile && u.role === 'admin')) {
            document.getElementById('admin-register-message').textContent = 'This mobile number is already registered as admin';
            return;
        }
        
        // Show loading
        submitBtn.textContent = '⏳ Submitting...';
        submitBtn.disabled = true;
        
        setTimeout(() => {
            try {
                // Create admin request
                const adminRequest = {
                    id: Date.now(),
                    name: name,
                    mobile: mobile,
                    position: position,
                    reason: reason,
                    requestDate: new Date().toISOString(),
                    status: 'pending'
                };
                
                // Store pending admin request
                pendingAdmins.push(adminRequest);
                localStorage.setItem('pendingAdmins', JSON.stringify(pendingAdmins));
                
                // Create notification for default admin
                createDefaultAdminNotification({
                    type: 'admin_registration_request',
                    title: 'New Admin Registration Request',
                    message: `Admin access request from ${name}`,
                    adminData: adminRequest,
                    timestamp: new Date().toISOString(),
                    whatsappMessage: `👑 *ADMIN REGISTRATION REQUEST*\n\n*🔐 SECURITY ALERT*\n\n*Name:* ${name}\n*Mobile:* ${mobile}\n*Position:* ${position}\n*Reason:* ${reason}\n\n*⚠️ IMPORTANT:* Someone is requesting admin access to the Al Fizaa Girls Hostel Management System. Only approve if you know this person and they are authorized.\n\n*Request ID:* ${adminRequest.id}\n*Time:* ${new Date().toLocaleString()}\n\n*Default Admin Action Required* 🛡️`
                });
                
                document.getElementById('admin-register-message').style.color = 'green';
                document.getElementById('admin-register-message').textContent = '✅ Request submitted successfully! The default admin will review your request and contact you via WhatsApp.';
                
                // Clear form
                document.getElementById('admin-name').value = '';
                document.getElementById('admin-mobile').value = '';
                document.getElementById('admin-position').value = '';
                document.getElementById('admin-reason').value = '';
                
                // Auto redirect to login after 5 seconds
                setTimeout(() => {
                    renderLoginPage();
                }, 5000);
                
            } catch (error) {
                console.error('Error submitting admin request:', error);
                document.getElementById('admin-register-message').textContent = 'An error occurred. Please try again.';
            } finally {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        }, 1000);
    });
    
    // Back to login
    document.getElementById('back-to-login-admin').addEventListener('click', function() {
        renderLoginPage();
    });
    
    // Add input effects
    document.querySelectorAll('input, textarea').forEach(input => {
        input.addEventListener('focus', function() {
            this.style.borderColor = '#dc3545';
            this.style.boxShadow = '0 0 20px rgba(220,53,69,0.2)';
        });
        input.addEventListener('blur', function() {
            this.style.borderColor = '#e0e0e0';
            this.style.boxShadow = 'none';
        });
    });
}

// ---------- Theme System ----------
function initializeThemeSystem() {
    // Load saved theme or default to purple
    const savedTheme = localStorage.getItem('selectedTheme') || 'theme-purple';
    applyTheme(savedTheme);
    
    // Set theme selector value
    const themeSelector = document.getElementById('theme-selector');
    if (themeSelector) {
        themeSelector.value = savedTheme;
        
        // Add theme change listener
        themeSelector.addEventListener('change', function() {
            const selectedTheme = this.value;
            applyTheme(selectedTheme);
            localStorage.setItem('selectedTheme', selectedTheme);
            
            // Show theme change notification
            showThemeNotification(getThemeName(selectedTheme));
        });
        
        // Add hover effect
        themeSelector.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-2px)';
            this.style.boxShadow = '0 8px 25px rgba(0,0,0,0.2)';
        });
        
        themeSelector.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
            this.style.boxShadow = '0 4px 15px rgba(0,0,0,0.1)';
        });
    }
}

function applyTheme(themeName) {
    // Remove all existing theme classes
    const themeClasses = [
        'theme-purple', 'theme-ocean', 'theme-sunset', 'theme-forest', 'theme-royal',
        'theme-cherry', 'theme-midnight', 'theme-tropical', 'theme-aurora', 'theme-cosmic'
    ];
    
    themeClasses.forEach(cls => document.body.classList.remove(cls));
    
    // Apply new theme
    document.body.classList.add(themeName);
    
    // Update CSS custom properties for dynamic elements
    updateDynamicGradients(themeName);
}

function updateDynamicGradients(themeName) {
    // Update all dynamic gradient backgrounds based on theme
    const dynamicElements = document.querySelectorAll('[style*="linear-gradient"]');
    
    // Theme-specific gradient updates for templates
    updateTemplateGradients(themeName);
}

function updateTemplateGradients(themeName) {
    // Update mess menu gradients
    const messGradients = document.querySelectorAll('.mess-menu-template [style*="gradientShift"]');
    messGradients.forEach(el => {
        if (el.style.background.includes('gradientShift')) {
            el.style.background = `linear-gradient(45deg,var(--gradient-7),var(--gradient-8),var(--gradient-9),var(--gradient-10),var(--gradient-11),var(--gradient-12),var(--gradient-1));background-size:400% 400%;animation:gradientShift 4s ease infinite`;
        }
    });
    
    // Update other template gradients similarly
    updateIncomeExpenseGradients();
    updateIssuesGradients();
    updateNewsGradients();
}

function updateIncomeExpenseGradients() {
    const incomeHeaders = document.querySelectorAll('#income-template [style*="gradientShift"], #expense-template [style*="gradientShift"], #financial-report-template [style*="gradientShift"]');
    incomeHeaders.forEach(el => {
        if (el.style.background && el.style.background.includes('gradientShift')) {
            el.style.background = `linear-gradient(45deg,var(--gradient-7),var(--gradient-8),var(--gradient-9),var(--gradient-10),var(--gradient-11),var(--gradient-12),var(--gradient-1));background-size:400% 400%;animation:gradientShift 4s ease infinite`;
        }
    });
}

function updateIssuesGradients() {
    const issuesHeaders = document.querySelectorAll('#issues-template [style*="gradientShift"]');
    issuesHeaders.forEach(el => {
        if (el.style.background && el.style.background.includes('gradientShift')) {
            el.style.background = `linear-gradient(45deg,var(--gradient-7),var(--gradient-8),var(--gradient-9),var(--gradient-10),var(--gradient-11),var(--gradient-12),var(--gradient-1));background-size:400% 400%;animation:gradientShift 4s ease infinite`;
        }
    });
}

function updateNewsGradients() {
    const newsHeaders = document.querySelectorAll('#news-template [style*="gradientShift"]');
    newsHeaders.forEach(el => {
        if (el.style.background && el.style.background.includes('gradientShift')) {
            el.style.background = `linear-gradient(45deg,var(--gradient-7),var(--gradient-8),var(--gradient-9),var(--gradient-10),var(--gradient-11),var(--gradient-12),var(--gradient-1));background-size:400% 400%;animation:gradientShift 4s ease infinite`;
        }
    });
}

function getThemeName(themeClass) {
    const themeNames = {
        'theme-purple': '🟣 Purple Classic',
        'theme-ocean': '🌊 Ocean Blue',
        'theme-sunset': '🌅 Sunset Orange',
        'theme-forest': '🌲 Forest Green',
        'theme-royal': '👑 Royal Purple',
        'theme-cherry': '🍒 Cherry Red',
        'theme-midnight': '🌙 Midnight Blue',
        'theme-tropical': '🏝️ Tropical Paradise',
        'theme-aurora': '✨ Aurora Borealis',
        'theme-cosmic': '🌌 Cosmic Galaxy'
    };
    return themeNames[themeClass] || 'Theme';
}

// Phone number validation function
function validatePhoneNumber(input) {
    const phonePattern = /^\+92[0-9]{10}$/;
    const value = input.value;
    
    if (value && !phonePattern.test(value)) {
        input.style.borderColor = '#ef4444';
        input.style.boxShadow = '0 0 10px rgba(239,68,68,0.3)';
        
        // Show error message
        let errorMsg = input.nextElementSibling?.nextElementSibling;
        if (!errorMsg || !errorMsg.classList.contains('phone-error')) {
            errorMsg = document.createElement('div');
            errorMsg.className = 'phone-error';
            errorMsg.style.cssText = 'color:#ef4444;font-size:0.8rem;margin-top:3px;';
            errorMsg.textContent = '❌ Invalid format. Use +92XXXXXXXXXX';
            input.parentNode.appendChild(errorMsg);
        }
    } else {
        input.style.borderColor = '#10b981';
        input.style.boxShadow = '0 0 10px rgba(16,185,129,0.3)';
        
        // Remove error message
        const errorMsg = input.parentNode.querySelector('.phone-error');
        if (errorMsg) {
            errorMsg.remove();
        }
    }
}

// Utility function to format phone number for WhatsApp compatibility
function formatPhoneForWhatsApp(phoneNumber) {
    if (!phoneNumber) return null;
    
    // Remove all non-numeric characters except +
    let formatted = phoneNumber.replace(/[^0-9+]/g, '');
    
    // If starts with +92, return as is
    if (formatted.startsWith('+92')) {
        return formatted;
    }
    
    // If starts with 92, add +
    if (formatted.startsWith('92')) {
        return '+' + formatted;
    }
    
    // If starts with 0, replace with +92
    if (formatted.startsWith('0')) {
        return '+92' + formatted.substring(1);
    }
    
    // Otherwise, assume it's a 10-digit number and add +92
    if (formatted.length === 10) {
        return '+92' + formatted;
    }
    
    return formatted;
}

function showThemeNotification(themeName) {
    // Create notification element
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, var(--gradient-1), var(--gradient-2));
        color: white;
        padding: 15px 25px;
        border-radius: 12px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        z-index: 10000;
        font-weight: 600;
        font-size: 0.9rem;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.2);
        transform: translateX(100%);
        transition: all 0.3s ease;
        animation: pulseGlow 2s ease infinite;
    `;
    notification.innerHTML = `🎨 Theme changed to ${themeName}`;
    
    document.body.appendChild(notification);
    
    // Animate in
    setTimeout(() => {
        notification.style.transform = 'translateX(0)';
    }, 100);
    
    // Remove after 3 seconds
    setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 3000);
}

// Add theme preview functionality
function showThemePreview() {
    const previewModal = document.createElement('div');
    previewModal.id = 'theme-preview-modal';
    previewModal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
        backdrop-filter: blur(10px);
    `;
    
    const themes = [
        {name: 'theme-purple', display: '🟣 Purple Classic'},
        {name: 'theme-ocean', display: '🌊 Ocean Blue'},
        {name: 'theme-sunset', display: '🌅 Sunset Orange'},
        {name: 'theme-forest', display: '🌲 Forest Green'},
        {name: 'theme-royal', display: '👑 Royal Purple'},
        {name: 'theme-cherry', display: '🍒 Cherry Red'},
        {name: 'theme-midnight', display: '🌙 Midnight Blue'},
        {name: 'theme-tropical', display: '🏝️ Tropical Paradise'},
        {name: 'theme-aurora', display: '✨ Aurora Borealis'},
        {name: 'theme-cosmic', display: '🌌 Cosmic Galaxy'}
    ];
    
    let modalContent = `
        <div style="background: white; border-radius: 20px; padding: 30px; max-width: 800px; width: 100%; max-height: 80vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0; color: #333; font-size: 1.5rem;">🎨 Choose Your Theme</h2>
                <button onclick="closeThemePreview()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666;">&times;</button>
            </div>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
    `;
    
    themes.forEach(theme => {
        modalContent += `
            <div class="theme-preview-card" data-theme="${theme.name}" style="
                padding: 20px;
                border-radius: 15px;
                cursor: pointer;
                transition: all 0.3s ease;
                border: 2px solid transparent;
                text-align: center;
                position: relative;
                overflow: hidden;
            ">
                <div style="font-weight: 600; margin-bottom: 10px; color: #333;">${theme.display}</div>
                <div style="height: 60px; border-radius: 10px; margin-bottom: 10px; position: relative;"></div>
                <button onclick="applyThemeFromPreview('${theme.name}')" style="
                    padding: 8px 16px;
                    border: none;
                    border-radius: 8px;
                    background: #333;
                    color: white;
                    cursor: pointer;
                    font-weight: 600;
                    transition: all 0.3s ease;
                ">Apply Theme</button>
            </div>
        `;
    });
    
    modalContent += `
            </div>
        </div>
    `;
    
    previewModal.innerHTML = modalContent;
    document.body.appendChild(previewModal);
    
    // Style theme preview cards with their respective gradients
    setTimeout(() => {
        document.querySelectorAll('.theme-preview-card').forEach(card => {
            const themeName = card.dataset.theme;
            const gradientDiv = card.querySelector('div:nth-child(2)');
            
            // Apply theme-specific gradients for preview
            const themeGradients = {
                'theme-purple': 'linear-gradient(135deg, #667eea, #764ba2, #f093fb)',
                'theme-ocean': 'linear-gradient(135deg, #0077be, #00a8cc, #00d4aa)',
                'theme-sunset': 'linear-gradient(135deg, #ff6b35, #f7931e, #ffb347)',
                'theme-forest': 'linear-gradient(135deg, #228b22, #32cd32, #90ee90)',
                'theme-royal': 'linear-gradient(135deg, #4b0082, #8a2be2, #9370db)',
                'theme-cherry': 'linear-gradient(135deg, #dc143c, #ff1493, #ff69b4)',
                'theme-midnight': 'linear-gradient(135deg, #191970, #483d8b, #6a5acd)',
                'theme-tropical': 'linear-gradient(135deg, #ff7f50, #ff6347, #ffa500)',
                'theme-aurora': 'linear-gradient(135deg, #00ced1, #48d1cc, #7fffd4)',
                'theme-cosmic': 'linear-gradient(135deg, #8b008b, #9932cc, #ba55d3)'
            };
            
            gradientDiv.style.background = themeGradients[themeName];
            gradientDiv.style.animation = 'gradientShift 3s ease infinite';
            
            card.addEventListener('mouseenter', () => {
                card.style.transform = 'translateY(-5px) scale(1.02)';
                card.style.boxShadow = '0 15px 35px rgba(0,0,0,0.2)';
                card.style.border = '2px solid #667eea';
            });
            
            card.addEventListener('mouseleave', () => {
                card.style.transform = 'translateY(0) scale(1)';
                card.style.boxShadow = 'none';
                card.style.border = '2px solid transparent';
            });
        });
    }, 100);
}

function closeThemePreview() {
    const modal = document.getElementById('theme-preview-modal');
    if (modal) {
        modal.remove();
    }
}

function applyThemeFromPreview(themeName) {
    applyTheme(themeName);
    localStorage.setItem('selectedTheme', themeName);
    
    // Update theme selector
    const themeSelector = document.getElementById('theme-selector');
    if (themeSelector) {
        themeSelector.value = themeName;
    }
    
    showThemeNotification(getThemeName(themeName));
    closeThemePreview();
}

// ---------- App ----------
function initializeApp(){
    const userRole = localStorage.getItem('userRole') || 'Guest';
    const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
    console.log('🔧 Initializing app for user role:', userRole);
    console.log('🔧 Current user data:', currentUser);
    
    // Set user info display based on role and user data
    let userDisplayName = '';
    if(userRole === 'admin') {
        userDisplayName = currentUser.name || 'Administrator';
    } else if(userRole === 'guest') {
        userDisplayName = 'Guest User';
    } else {
        userDisplayName = currentUser.name || userRole;
    }
    
    document.getElementById('user-info').textContent = userDisplayName;
    
    // Initialize theme system
    initializeThemeSystem();
    
    // Load hostel logo
    loadHostelLogo();
    
    // Initialize mobile sidebar
    setTimeout(() => {
        initializeMobileSidebar();
    }, 100);
    
    // Initialize mobile layout
    setTimeout(() => {
        initializeMobileLayout();
    }, 150);
    
    // Handle admin vs guest vs other users properly
    if(userRole === 'admin') {
        console.log('🔧 Setting up admin controls');
        // Full admin functionality
        document.getElementById('admin-notifications-btn').style.display = 'inline-block';
        document.getElementById('logo-upload-btn').style.display = 'inline-block';
        document.getElementById('qarz-forms-btn').style.display = 'inline-block';
        document.getElementById('student-reports-btn').style.display = 'inline-block';
        document.getElementById('automated-reports-btn').style.display = 'inline-block';
        document.getElementById('document-scanner-btn').style.display = 'inline-block';
        document.getElementById('student-id-change-btn').style.display = 'inline-block';
        
        // Update notification badge
        updateNotificationBadge();
        
        // Enable actual admin functionality
        document.getElementById('admin-logo-upload').addEventListener('change', function(e) {
            if(e.target.files[0]) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    localStorage.setItem('hostelLogo', event.target.result);
                    loadHostelLogo();
                    alert('Hostel logo updated successfully!');
                };
                reader.readAsDataURL(e.target.files[0]);
            }
        });
        
  } else {
        console.log('🔧 Setting up user controls for role:', userRole);
        // Hide admin controls for non-admin and non-guest users
        document.getElementById('admin-notifications-btn').style.display = 'none';
        document.getElementById('logo-upload-btn').style.display = 'none';
        document.getElementById('qarz-forms-btn').style.display = 'none';
        document.getElementById('student-reports-btn').style.display = 'none';
        document.getElementById('automated-reports-btn').style.display = 'none';
        document.getElementById('document-scanner-btn').style.display = 'none';
        document.getElementById('student-id-change-btn').style.display = 'none';
    }
    
    // Hide/show sidebar items based on role
    setupRoleBasedNavigation(userRole);
    
    document.querySelectorAll('.nav-link').forEach(link=>{
        link.addEventListener('click',e=>{
            e.preventDefault();
            if(link.classList.contains('disabled')) return;
            document.querySelectorAll('.nav-link').forEach(l=>l.classList.remove('active'));
            link.classList.add('active');
            const target=link.dataset.target;
            renderTemplate(target);
        });
    });
    // single reliable logout listener
    document.getElementById('logout-btn').addEventListener('click',()=>{
        console.log('🔧 Logout initiated');
        // Clear all stored login data
        localStorage.setItem('isLoggedIn','false');
        localStorage.removeItem('userRole');
        localStorage.removeItem('studentId');
        localStorage.removeItem('currentUser');
        
        // Reset body classes
        document.body.classList.add('showing-login');
        document.body.classList.remove('showing-app');
        
        // Reset page display with important flags
        document.getElementById('login-page').style.setProperty('display', 'block', 'important');
        document.getElementById('app-page').style.setProperty('display', 'none', 'important');
        
        // Render fresh login page
        renderLoginPage();
        
        console.log('🔧 Logout complete - login page shown');
    });
    
    // Start with Profile for students/parents, Dashboard for admin and guest
    if(userRole === 'student' || userRole === 'parent') {
        renderTemplate('enrolled-students-template');
    } else {
        renderTemplate('dashboard-template');
    }
}

// ---------- Header Collapse Functionality ----------
function toggleHeaderCollapse() {
    const topBar = document.getElementById('top-bar');
    const collapseIcon = document.getElementById('header-collapse-icon');
    
    if (topBar.classList.contains('header-collapsed')) {
        // Expand header
        topBar.classList.remove('header-collapsed');
        collapseIcon.textContent = '▲';
    } else {
        // Collapse header
        topBar.classList.add('header-collapsed');
        collapseIcon.textContent = '▼';
    }
}

// Initialize header collapse state on page load
function initializeHeaderCollapse() {
    // Check if we're on mobile and auto-collapse if needed
    if (window.innerWidth <= 768) {
        const topBar = document.getElementById('top-bar');
        const collapseIcon = document.getElementById('header-collapse-icon');
        
        // Auto-collapse on mobile for better space utilization
        topBar.classList.add('header-collapsed');
        collapseIcon.textContent = '▼';
    }
}

// ---------- Mobile Sidebar ----------
function initializeMobileSidebar() {
    console.log('🔧 Initializing mobile sidebar...');
    console.log('🔧 Current user role:', localStorage.getItem('userRole'));
    console.log('🔧 Body classes:', document.body.className);
    
    const userRole = localStorage.getItem('userRole');
    const mobileMenuBtn = document.getElementById('mobile-menu-btn');
    const sidebar = document.getElementById('sidebar');
    const sidebarClose = document.getElementById('sidebar-close');
    const sidebarToggle = document.getElementById('sidebar-toggle');
    const sidebarOverlay = document.getElementById('sidebar-overlay');
    const mainWrapper = document.querySelector('.main-wrapper');
    
    // Enhanced mobile detection
    const isMobile = window.innerWidth <= 768 || /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    
    if (isMobile) {
        document.body.classList.add('mobile-device');
        console.log('📱 Mobile device detected, adding mobile class');
    }
    
    console.log('🔧 Checking mobile sidebar elements:', {
        mobileMenuBtn: !!mobileMenuBtn,
        mobileMenuBtnVisible: mobileMenuBtn ? window.getComputedStyle(mobileMenuBtn).display : 'not found',
        sidebar: !!sidebar,
        sidebarClose: !!sidebarClose,
        sidebarOverlay: !!sidebarOverlay,
        mainWrapper: !!mainWrapper,
        isMobile,
        userRole: localStorage.getItem('userRole'),
        bodyClasses: document.body.className
    });
    
    if (!mobileMenuBtn || !sidebar || !sidebarOverlay) {
        console.error('❌ Critical mobile elements missing:', {
            mobileMenuBtn: !!mobileMenuBtn,
            sidebar: !!sidebar,
            sidebarOverlay: !!sidebarOverlay
        });
        return;
    }
    
    // Force mobile menu button to be visible for all roles
    if (mobileMenuBtn && isMobile) {
        console.log('🔧 Force showing mobile menu button for role:', userRole);
        mobileMenuBtn.style.display = 'flex !important';
        mobileMenuBtn.style.position = 'fixed !important';
        mobileMenuBtn.style.right = '12px !important';
        mobileMenuBtn.style.top = '12px !important';
        mobileMenuBtn.style.zIndex = '9999 !important';
        mobileMenuBtn.style.visibility = 'visible !important';
        mobileMenuBtn.style.opacity = '1 !important';
    }
    
    function openSidebar() {
        console.log('📱 Opening mobile sidebar...');
        
        // Force mobile sidebar positioning and styles
        if (window.innerWidth <= 768) {
            sidebar.style.position = 'fixed';
            sidebar.style.right = '0';
            sidebar.style.left = 'auto';
            sidebar.style.top = '0';
            sidebar.style.height = '100vh';
            sidebar.style.width = '280px';
            sidebar.style.zIndex = '9998';
            sidebar.style.background = 'linear-gradient(180deg,var(--primary),var(--secondary))';
        }
        
        sidebar.classList.add('open', 'active');
        sidebar.classList.remove('collapsed');
        sidebarOverlay.classList.add('active');
        sidebarOverlay.style.display = 'block';
        sidebarOverlay.style.zIndex = '9997';
        document.body.style.overflow = 'hidden';
        
        // Add sidebar-open class to body for mobile compatibility
        document.body.classList.add('sidebar-open');
        
        // Add active class to mobile menu button
        mobileMenuBtn.classList.add('active');
        
        // Add desktop sidebar behavior for larger screens
        if (window.innerWidth > 768 && mainWrapper) {
            mainWrapper.classList.add('sidebar-open');
        }
        
        // Force sidebar to be visible immediately
        setTimeout(() => {
            sidebar.style.transform = 'translateX(0)';
            sidebar.style.visibility = 'visible';
            sidebar.style.opacity = '1';
        }, 10);
        
        console.log('✅ Sidebar opened, classes added');
    }
    
    function closeSidebar() {
        console.log('📱 Closing mobile sidebar...');
        
        // Force close animation
        if (window.innerWidth <= 768) {
            sidebar.style.transform = 'translateX(100%)';
            sidebar.style.visibility = 'hidden';
            sidebar.style.opacity = '0';
        }
        
        sidebar.classList.remove('open', 'active');
        sidebarOverlay.classList.remove('active');
        mobileMenuBtn.classList.remove('active');
        
        // Reset any inline styles that might interfere after animation
        setTimeout(() => {
            sidebar.style.transform = '';
            sidebar.style.visibility = '';
            sidebar.style.opacity = '';
            sidebarOverlay.style.display = 'none';
        }, 300);
        
        document.body.style.overflow = 'auto';
        
        // Remove sidebar-open class from body
        document.body.classList.remove('sidebar-open');
        
        if (mainWrapper) {
            mainWrapper.classList.remove('sidebar-open');
        }
        console.log('✅ Sidebar closed, classes removed');
    }
    
    function resetSidebarState() {
        console.log('🔄 Resetting sidebar state...');
        sidebar.classList.remove('open', 'active', 'collapsed');
        sidebarOverlay.classList.remove('active');
        mobileMenuBtn.classList.remove('active');
        document.body.classList.remove('sidebar-open');
        
        // Clear any inline styles
        sidebar.style.transform = '';
        sidebar.style.visibility = '';
        sidebar.style.opacity = '';
        sidebar.style.display = '';
        sidebarOverlay.style.display = 'none';
        document.body.style.overflow = 'auto';
        
        console.log('✅ Sidebar state reset');
    }
    
    function toggleSidebar() {
        console.log('📱 Toggle sidebar clicked, current state:', {
            isOpen: sidebar.classList.contains('open'),
            isActive: sidebar.classList.contains('active'),
            sidebarClasses: sidebar.className,
            isVisible: sidebar.style.visibility,
            transform: sidebar.style.transform,
            computedTransform: window.getComputedStyle(sidebar).transform
        });
        
        // Check if sidebar is in an inconsistent state and reset if needed
        const isOpen = sidebar.classList.contains('open') || sidebar.classList.contains('active');
        const computedTransform = window.getComputedStyle(sidebar).transform;
        const isVisuallyHidden = computedTransform.includes('matrix(1, 0, 0, 1, ') && computedTransform.includes(', 0)') === false;
        
        if (isOpen && isVisuallyHidden) {
            console.log('🔄 Detected inconsistent state, resetting...');
            resetSidebarState();
            // After reset, open the sidebar
            setTimeout(openSidebar, 100);
        } else if (isOpen) {
            closeSidebar();
        } else {
            openSidebar();
        }
    }
    
    // Event listeners with debugging
    if (mobileMenuBtn) {
        console.log('✅ Adding click listener to mobile menu button for role:', userRole);
        
        // Remove existing event listeners to prevent conflicts
        mobileMenuBtn.replaceWith(mobileMenuBtn.cloneNode(true));
        const freshMobileMenuBtn = document.getElementById('mobile-menu-btn');
        
        // Add robust click event
        freshMobileMenuBtn.addEventListener('click', (e) => {
            console.log(`📱 Mobile menu button clicked by ${userRole}!`, e);
            e.preventDefault();
            e.stopPropagation();
            toggleSidebar();
        }, { passive: false });
        
        // Add touch event for mobile devices
        freshMobileMenuBtn.addEventListener('touchend', (e) => {
            console.log(`📱 Mobile menu button touched by ${userRole}!`, e);
            e.preventDefault();
            e.stopPropagation();
            toggleSidebar();
        }, { passive: false });
        
        // Add double-click to reset sidebar state if stuck
        freshMobileMenuBtn.addEventListener('dblclick', (e) => {
            console.log(`📱 Mobile menu button double-clicked by ${userRole} - resetting state`);
            e.preventDefault();
            e.stopPropagation();
            resetSidebarState();
        }, { passive: false });
        
        // Force visibility for guest and student modes
        if (userRole === 'guest' || userRole === 'student') {
            console.log(`🔧 Ensuring mobile button visibility for ${userRole}`);
            freshMobileMenuBtn.style.cssText = `
                display: flex !important;
                position: fixed !important;
                right: 12px !important;
                top: 12px !important;
                z-index: 9999 !important;
                visibility: visible !important;
                opacity: 1 !important;
                pointer-events: auto !important;
            `;
        }
    }
    if (sidebarClose) {
        sidebarClose.addEventListener('click', closeSidebar);
    }
    if (sidebarToggle) {
        sidebarToggle.addEventListener('click', toggleSidebar);
    }
    if (sidebarOverlay) {
        sidebarOverlay.addEventListener('click', closeSidebar);
    }
    
    // Add comprehensive debugging functions for mobile sidebar issues
    window.debugMobileSidebar = function() {
        console.log('🔍 MOBILE SIDEBAR DEBUG REPORT:');
        console.log('📱 User Agent:', navigator.userAgent);
        console.log('📱 Window dimensions:', {width: window.innerWidth, height: window.innerHeight});
        console.log('📱 Is mobile device:', window.innerWidth <= 768);
        console.log('📱 User role:', localStorage.getItem('userRole'));
        console.log('📱 Body classes:', document.body.className);
        
        const mobileBtn = document.getElementById('mobile-menu-btn');
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebar-overlay');
        
        console.log('📱 Elements status:', {
            mobileBtn: !!mobileBtn,
            mobileBtnVisible: mobileBtn ? window.getComputedStyle(mobileBtn).display : 'not found',
            mobileBtnPosition: mobileBtn ? window.getComputedStyle(mobileBtn).position : 'not found',
            sidebar: !!sidebar,
            sidebarVisible: sidebar ? window.getComputedStyle(sidebar).display : 'not found',
            sidebarActive: sidebar ? sidebar.classList.contains('active') : false,
            overlay: !!overlay,
            overlayVisible: overlay ? window.getComputedStyle(overlay).display : 'not found'
        });
        
        if (mobileBtn) {
            const rect = mobileBtn.getBoundingClientRect();
            console.log('📱 Mobile button position:', rect);
            console.log('📱 Mobile button styles:', {
                display: window.getComputedStyle(mobileBtn).display,
                visibility: window.getComputedStyle(mobileBtn).visibility,
                opacity: window.getComputedStyle(mobileBtn).opacity,
                zIndex: window.getComputedStyle(mobileBtn).zIndex,
                right: window.getComputedStyle(mobileBtn).right,
                left: window.getComputedStyle(mobileBtn).left,
                top: window.getComputedStyle(mobileBtn).top
            });
        }
    };
    
    // Test sidebar toggle function
    window.testSidebarToggle = function() {
        console.log('🧪 Testing sidebar toggle...');
        debugMobileSidebar();
        console.log('🧪 Attempting to toggle sidebar...');
        toggleSidebar();
        setTimeout(() => {
            console.log('🧪 Post-toggle state:');
            debugMobileSidebar();
        }, 500);
    };
    
    // Quick fix function to force sidebar to work
    window.forceSidebarWork = function() {
        console.log('🔧 Force fixing mobile sidebar...');
        const mobileBtn = document.getElementById('mobile-menu-btn');
        const sidebar = document.getElementById('sidebar');
        
        if (mobileBtn) {
            mobileBtn.style.display = 'flex';
            mobileBtn.style.position = 'fixed';
            mobileBtn.style.right = '12px';
            mobileBtn.style.top = '12px';
            mobileBtn.style.zIndex = '9999';
        }
        
        if (sidebar) {
            sidebar.style.display = 'block';
        }
        
        console.log('🔧 Sidebar should now be fixed. Try clicking the menu button.');
    };
    
    // Simple test function specifically for mobile sidebar
    window.testMobileSidebar = function() {
        console.log('🧪 Testing mobile sidebar functionality...');
        
        if (window.innerWidth > 768) {
            console.log('⚠️ Not on mobile view. Resize window to ≤768px or use browser mobile simulation.');
            return;
        }
        
        const sidebar = document.getElementById('sidebar');
        const mobileBtn = document.getElementById('mobile-menu-btn');
        const overlay = document.getElementById('sidebar-overlay');
        
        console.log('📊 Current state:', {
            sidebarOpen: sidebar?.classList.contains('active'),
            buttonVisible: mobileBtn ? window.getComputedStyle(mobileBtn).display : 'not found',
            overlayVisible: overlay ? window.getComputedStyle(overlay).display : 'not found'
        });
        
        console.log('🧪 Attempting to open sidebar...');
        openSidebar();
        
        setTimeout(() => {
            console.log('📊 After open attempt:', {
                sidebarOpen: sidebar?.classList.contains('active'),
                sidebarTransform: sidebar ? window.getComputedStyle(sidebar).transform : 'not found',
                overlayActive: overlay?.classList.contains('active')
            });
            
            console.log('🧪 Now closing sidebar...');
            closeSidebar();
            
            setTimeout(() => {
                console.log('📊 After close attempt:', {
                    sidebarOpen: sidebar?.classList.contains('active'),
                    sidebarTransform: sidebar ? window.getComputedStyle(sidebar).transform : 'not found',
                    overlayActive: overlay?.classList.contains('active')
                });
                console.log('✅ Mobile sidebar test complete!');
            }, 500);
        }, 500);
    };
    
    // Force fix specifically for guest and student modes
    window.forceFixGuestStudentSidebar = function() {
        const userRole = localStorage.getItem('userRole');
        console.log(`🔧 Force fixing sidebar for ${userRole} mode...`);
        
        if (userRole !== 'guest' && userRole !== 'student') {
            console.log('ℹ️ This fix is specifically for guest and student modes');
            return;
        }
        
        const mobileBtn = document.getElementById('mobile-menu-btn');
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebar-overlay');
        
        // Force mobile button visibility
        if (mobileBtn) {
            mobileBtn.style.cssText = `
                display: flex !important;
                position: fixed !important;
                right: 12px !important;
                top: 12px !important;
                z-index: 9999 !important;
                visibility: visible !important;
                opacity: 1 !important;
                pointer-events: auto !important;
                background: rgba(0,0,0,0.8) !important;
                border: none !important;
                border-radius: 4px !important;
                padding: 8px !important;
                color: white !important;
                cursor: pointer !important;
                flex-direction: column !important;
                align-items: center !important;
                justify-content: center !important;
                width: 40px !important;
                height: 40px !important;
            `;
            
            // Remove and re-add event listeners
            const newBtn = mobileBtn.cloneNode(true);
            mobileBtn.parentNode.replaceChild(newBtn, mobileBtn);
            
            newBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log(`🎯 ${userRole} clicked mobile menu - toggling sidebar`);
                toggleSidebar();
            });
            
            newBtn.addEventListener('touchend', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log(`🎯 ${userRole} touched mobile menu - toggling sidebar`);
                toggleSidebar();
            });
        }
        
        // Ensure sidebar is properly positioned
        if (sidebar) {
            sidebar.style.display = 'block';
            sidebar.style.position = 'fixed';
            sidebar.style.right = '0';
            sidebar.style.top = '0';
            sidebar.style.height = '100vh';
            sidebar.style.width = '280px';
            sidebar.style.zIndex = '9998';
        }
        
        // Ensure overlay is ready
        if (overlay) {
            overlay.style.position = 'fixed';
            overlay.style.top = '0';
            overlay.style.left = '0';
            overlay.style.width = '100vw';
            overlay.style.height = '100vh';
            overlay.style.zIndex = '9997';
            overlay.style.background = 'rgba(0,0,0,0.6)';
            overlay.style.display = 'none';
        }
        
        console.log(`✅ ${userRole} mobile sidebar should now work properly!`);
    };
    
    // Close sidebar when clicking nav links on mobile
    document.querySelectorAll('.nav-link').forEach(link => {
        link.addEventListener('click', () => {
            if (window.innerWidth <= 768) {
                setTimeout(closeSidebar, 100); // Small delay to allow navigation
            }
        });
    });
    
    // Handle window resize with debouncing
    let resizeTimer;
    window.addEventListener('resize', () => {
        // Disable transitions during resize
        document.body.classList.add('resize-animation-stopper');
        
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(() => {
            // Re-enable transitions after resize
            document.body.classList.remove('resize-animation-stopper');
            
            // Handle header collapse based on screen size
            const topBar = document.getElementById('top-bar');
            const collapseIcon = document.getElementById('header-collapse-icon');
            
            if (window.innerWidth > 768) {
                // Desktop view - show header expanded
                if (topBar && collapseIcon) {
                    topBar.classList.remove('header-collapsed');
                    collapseIcon.textContent = '▲';
                }
            } else {
                // Mobile view - auto-collapse header for space
                if (topBar && collapseIcon && !topBar.classList.contains('header-collapsed')) {
                    topBar.classList.add('header-collapsed');
                    collapseIcon.textContent = '▼';
                }
            }
            
            if (window.innerWidth > 768) {
                // Desktop view - show sidebar permanently
                sidebar.classList.add('open');
                mainWrapper.classList.add('sidebar-open');
                sidebarOverlay.style.display = 'none';
                sidebarOverlay.classList.remove('active');
                document.body.style.overflow = 'auto';
                document.body.classList.remove('sidebar-open');
            } else {
                // Mobile view - force sidebar closed by default
                sidebar.classList.remove('open', 'active');
                mainWrapper.classList.remove('sidebar-open');
                sidebarOverlay.classList.remove('active');
                sidebarOverlay.style.display = 'none';
                document.body.classList.remove('sidebar-open');
                document.body.style.overflow = 'auto';
                mobileMenuBtn.classList.remove('active');
            }
        }, 250);
    });
    
    // Initialize based on screen size
    if (window.innerWidth > 768) {
        mainWrapper.classList.add('sidebar-open');
        sidebar.classList.add('open');
    } else {
        // Force sidebar closed on mobile initialization
        sidebar.classList.remove('open', 'active');
        mainWrapper.classList.remove('sidebar-open');
        document.body.classList.remove('sidebar-open');
        sidebarOverlay.classList.remove('active');
        sidebarOverlay.style.display = 'none';
    }
    
    // Touch support for mobile swipe gestures
    let touchStartX = 0;
    let touchEndX = 0;
    
    function handleSwipe() {
        const swipeDistance = touchEndX - touchStartX;
        const minSwipeDistance = 50;
        
        if (Math.abs(swipeDistance) > minSwipeDistance) {
            if (swipeDistance > 0 && touchStartX < 50) {
                // Swipe right from left edge - open sidebar
                openSidebar();
            } else if (swipeDistance < 0 && sidebar && sidebar.classList.contains('open')) {
                // Swipe left when sidebar is open - close sidebar
                closeSidebar();
            }
        }
    }
    
    document.addEventListener('touchstart', (e) => {
        touchStartX = e.touches[0].clientX;
    });
    
    document.addEventListener('touchend', (e) => {
        touchEndX = e.changedTouches[0].clientX;
        handleSwipe();
    });
    
    // Ensure proper navigation setup after sidebar initialization
    setTimeout(() => {
        const userRole = localStorage.getItem('userRole');
        if(userRole) setupRoleBasedNavigation(userRole);
    }, 100);
}

// ---------- Mobile Debug Function ----------
function debugMobileLayout() {
    const debugInfo = {
        screenWidth: window.innerWidth,
        screenHeight: window.innerHeight,
        isMobile: window.innerWidth <= 768,
        userAgent: navigator.userAgent,
        orientation: screen.orientation ? screen.orientation.angle : 'unknown',
        viewport: {
            width: document.documentElement.clientWidth,
            height: document.documentElement.clientHeight
        }
    };
    console.log('Mobile Layout Debug:', debugInfo);
    return debugInfo;
}

// ---------- Mobile Layout Initialization ----------
function initializeMobileLayout() {
    const isMobile = window.innerWidth <= 768;
    
    // Debug mobile layout
    const debugInfo = debugMobileLayout();
    
    // Fix basic mobile viewport issues
    const viewport = document.querySelector('meta[name="viewport"]');
    if (viewport) {
        viewport.setAttribute('content', 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover');
    }
    
    // Handle iOS Safari viewport bug
    function setViewHeight() {
        const vh = window.innerHeight * 0.01;
        document.documentElement.style.setProperty('--vh', `${vh}px`);
    }
    setViewHeight();
    window.addEventListener('resize', setViewHeight);
    window.addEventListener('orientationchange', () => {
        setTimeout(setViewHeight, 100);
    });
    
    if (isMobile) {
        console.log('Initializing mobile layout...');
        
        // Force mobile styles to apply
        document.body.classList.add('mobile-device');
        
        // Ensure mobile menu button is visible
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        if (mobileMenuBtn) {
            mobileMenuBtn.style.display = 'flex';
            mobileMenuBtn.style.position = 'fixed';
            mobileMenuBtn.style.zIndex = '1001';
            console.log('Mobile menu button found and styled');
        } else {
            console.error('Mobile menu button not found!');
        }
        
        // Ensure content area has proper spacing for mobile menu
        const contentArea = document.querySelector('.content-area');
        if (contentArea) {
            contentArea.style.paddingTop = '20px';
        }
        
        // Fix any layout issues with tables on mobile
        const tables = document.querySelectorAll('.data-table');
        tables.forEach(table => {
            table.style.width = '100%';
            table.style.overflowX = 'auto';
        });
        
        // Ensure modals work properly on mobile
        const modals = document.querySelectorAll('.modal');
        modals.forEach(modal => {
            modal.style.padding = '20px 10px';
        });
        
        console.log('Mobile layout initialized successfully');
    } else {
        console.log('Desktop layout detected, skipping mobile initialization');
    }
    
    // Handle orientation changes on mobile
    window.addEventListener('orientationchange', () => {
        setTimeout(() => {
            if (window.innerWidth <= 768) {
                console.log('Orientation changed, reinitializing mobile layout');
                initializeMobileLayout();
            }
        }, 500);
    });
}

// ---------- Mobile Test Function (for debugging) ----------
window.testMobileFeatures = function() {
    console.log('=== MOBILE FEATURES TEST ===');
    
    const debugInfo = debugMobileLayout();
    console.log('Debug Info:', debugInfo);
    
    // Test mobile menu button
    const mobileMenuBtn = document.getElementById('mobile-menu-btn');
    if (mobileMenuBtn) {
        console.log('✅ Mobile menu button found');
        console.log('Button styles:', {
            display: getComputedStyle(mobileMenuBtn).display,
            position: getComputedStyle(mobileMenuBtn).position,
            zIndex: getComputedStyle(mobileMenuBtn).zIndex,
            visibility: getComputedStyle(mobileMenuBtn).visibility
        });
        
        // Test click functionality
        console.log('Testing mobile menu click...');
        mobileMenuBtn.click();
        
        setTimeout(() => {
            const sidebar = document.getElementById('sidebar');
            if (sidebar && sidebar.classList.contains('open')) {
                console.log('✅ Sidebar opens successfully');
                mobileMenuBtn.click(); // Close it
            } else {
                console.log('❌ Sidebar not opening properly');
            }
        }, 100);
    } else {
        console.log('❌ Mobile menu button not found');
    }
    
    // Test viewport
    const viewport = document.querySelector('meta[name="viewport"]');
    if (viewport) {
        console.log('✅ Viewport meta tag found:', viewport.getAttribute('content'));
    } else {
        console.log('❌ Viewport meta tag not found');
    }
    
    // Test mobile class
    if (document.body.classList.contains('mobile-device')) {
        console.log('✅ Mobile device class applied');
    } else {
        console.log('❌ Mobile device class not applied');
    }
    
    console.log('=== TEST COMPLETE ===');
};

// ---------- Mobile Responsive Enhancements for Specific Tabs ----------
function enhanceMobileResponsiveness() {
    const isMobile = window.innerWidth <= 768;
    
    if (isMobile) {
        // Room Allocation mobile enhancements
        const roomTable = document.querySelector('#room-details table');
        if (roomTable) {
            // Make table responsive with better mobile layout
            roomTable.style.fontSize = '0.7rem';
            roomTable.style.width = '100%';
            
            // Wrap table in scrollable container if not already wrapped
            if (!roomTable.parentElement.classList.contains('table-scroll-wrapper')) {
                const wrapper = document.createElement('div');
                wrapper.className = 'table-scroll-wrapper';
                wrapper.style.cssText = `
                    overflow-x: auto;
                    /* -webkit-overflow-scrolling: touch; Not supported by most browsers */
                    border: 1px solid #ddd;
                    border-radius: 6px;
                    margin: 6px 0;
                `;
                roomTable.parentNode.insertBefore(wrapper, roomTable);
                wrapper.appendChild(roomTable);
            }
            
            // Optimize input fields in the table
            const inputs = roomTable.querySelectorAll('input[type="number"]');
            inputs.forEach(input => {
                input.style.width = '40px';
                input.style.fontSize = '0.7rem';
                input.style.padding = '3px 4px';
                input.style.textAlign = 'center';
                input.style.border = '1px solid #ccc';
                input.style.borderRadius = '4px';
            });
        }
        
        // Income/Expense management mobile enhancements
        const managementTemplates = ['#income-template', '#expense-template'];
        managementTemplates.forEach(templateSelector => {
            const template = document.querySelector(templateSelector);
            if (template) {
                // Stack control panels vertically
                const flexContainers = template.querySelectorAll('[style*="display:flex;gap:12px"]');
                flexContainers.forEach(container => {
                    container.style.cssText += `
                        flex-direction: column !important;
                        gap: 5px !important;
                        padding: 8px !important;
                        margin: 6px 0 !important;
                    `;
                });
                
                // Make summary cards single column
                const summaryGrids = template.querySelectorAll('[style*="grid-template-columns:repeat(auto-fit,minmax(200px,1fr))"]');
                summaryGrids.forEach(grid => {
                    grid.style.gridTemplateColumns = '1fr';
                    grid.style.gap = '6px';
                    grid.style.margin = '8px 0';
                });
                
                // Stack charts vertically
                const chartGrids = template.querySelectorAll('[style*="grid-template-columns:1fr 1fr"]');
                chartGrids.forEach(grid => {
                    grid.style.gridTemplateColumns = '1fr';
                    grid.style.gap = '8px';
                });
                
                // Optimize buttons
                const buttons = template.querySelectorAll('.btn-submit, .btn-view');
                buttons.forEach(button => {
                    button.style.cssText += `
                        width: 100% !important;
                        padding: 8px 10px !important;
                        font-size: 0.8rem !important;
                        margin: 2px 0 !important;
                        min-height: 44px !important;
                    `;
                });
                
                // Optimize form controls
                const formControls = template.querySelectorAll('select, input[type="date"]');
                formControls.forEach(control => {
                    control.style.cssText += `
                        width: 100% !important;
                        padding: 8px !important;
                        font-size: 0.8rem !important;
                        margin: 2px 0 !important;
                        min-height: 44px !important;
                    `;
                });
                
                // Optimize summary cards
                const summaryCards = template.querySelectorAll('[style*="padding:20px"]');
                summaryCards.forEach(card => {
                    if (card.style.background && card.style.background.includes('linear-gradient')) {
                        card.style.padding = '10px 6px';
                        card.style.margin = '4px 0';
                        card.style.borderRadius = '8px';
                        
                        const valueElement = card.querySelector('[style*="font-size:1.8rem"]');
                        if (valueElement) {
                            valueElement.style.fontSize = '1.1rem';
                            valueElement.style.lineHeight = '1.2';
                        }
                        
                        const labelElement = card.querySelector('[style*="font-size:1rem"]');
                        if (labelElement) {
                            labelElement.style.fontSize = '0.75rem';
                            labelElement.style.lineHeight = '1.1';
                        }
                    }
                });
            }
        });
        
        // Qarz e Hasna form mobile enhancements
        const qarzContainer = document.querySelector('.content-section');
        if (qarzContainer && qarzContainer.innerHTML.includes('QARZ E HASNA')) {
            // Convert inline inputs to block layout
            const inlineInputs = qarzContainer.querySelectorAll('input[style*="display:inline"]');
            inlineInputs.forEach(input => {
                input.style.cssText = `
                    display: block !important;
                    width: 100% !important;
                    margin: 5px 0 !important;
                    padding: 8px !important;
                    border: 2px solid #3b82f6 !important;
                    border-radius: 6px !important;
                    background: #f8fafc !important;
                    font-size: 16px !important;
                    min-height: 44px !important;
                    box-sizing: border-box !important;
                `;
            });
            
            // Convert grid layouts to mobile-friendly columns
            const gridLayouts = qarzContainer.querySelectorAll('[style*="display:grid"]');
            gridLayouts.forEach(grid => {
                const currentColumns = grid.style.gridTemplateColumns;
                if (currentColumns.includes('1fr 1fr 1fr')) {
                    grid.style.gridTemplateColumns = '1fr';
                    grid.style.gap = '6px';
                } else if (currentColumns.includes('repeat(4,1fr)')) {
                    grid.style.gridTemplateColumns = '1fr 1fr';
                    grid.style.gap = '6px';
                } else if (currentColumns.includes('1fr 1fr')) {
                    grid.style.gridTemplateColumns = '1fr';
                    grid.style.gap = '8px';
                }
            });
            
            // Optimize form sections
            const formSections = qarzContainer.querySelectorAll('[style*="padding:30px"], [style*="padding:25px"]');
            formSections.forEach(section => {
                section.style.padding = '10px 6px';
                section.style.margin = '6px 0';
                section.style.borderRadius = '10px';
            });
            
            // Optimize all form inputs
            const allInputs = qarzContainer.querySelectorAll('input, select, textarea');
            allInputs.forEach(input => {
                if (!input.style.display || input.style.display !== 'none') {
                    input.style.cssText += `
                        width: 100% !important;
                        padding: 10px 8px !important;
                        font-size: 16px !important;
                        margin: 2px 0 !important;
                        border-radius: 6px !important;
                        min-height: 44px !important;
                        box-sizing: border-box !important;
                    `;
                }
            });
            
            // Optimize labels
            const labels = qarzContainer.querySelectorAll('label');
            labels.forEach(label => {
                label.style.fontSize = '0.8rem';
                label.style.fontWeight = '600';
                label.style.marginBottom = '4px';
                label.style.display = 'block';
                
                if (label.style.display && label.style.display.includes('flex')) {
                    label.style.minHeight = '44px';
                    label.style.alignItems = 'center';
                    label.style.padding = '6px';
                    label.style.fontSize = '0.75rem';
                }
            });
        }
        
        // Universal table optimization
        const allTables = document.querySelectorAll('table');
        allTables.forEach(table => {
            if (!table.parentElement.classList.contains('table-scroll-wrapper')) {
                const wrapper = document.createElement('div');
                wrapper.className = 'table-scroll-wrapper';
                wrapper.style.cssText = `
                    overflow-x: auto;
                    /* -webkit-overflow-scrolling: touch; Not supported by most browsers */
                    border: 1px solid #ddd;
                    border-radius: 6px;
                    margin: 6px 0;
                `;
                table.parentNode.insertBefore(wrapper, table);
                wrapper.appendChild(table);
                
                // Optimize table cells
                const cells = table.querySelectorAll('th, td');
                cells.forEach(cell => {
                    cell.style.whiteSpace = 'nowrap';
                    cell.style.padding = '4px 2px';
                    cell.style.fontSize = '0.7rem';
                });
            }
        });
        
        // Optimize charts for mobile
        const canvases = document.querySelectorAll('canvas');
        canvases.forEach(canvas => {
            canvas.style.maxWidth = '100%';
            canvas.style.height = 'auto';
            canvas.style.maxHeight = '200px';
        });
        
        // Optimize modals for mobile
        const modals = document.querySelectorAll('.modal-content');
        modals.forEach(modal => {
            modal.style.margin = '10px';
            modal.style.maxWidth = 'calc(100vw - 20px)';
            modal.style.maxHeight = 'calc(100vh - 40px)';
            modal.style.overflowY = 'auto';
        });
    }
}

// Enhanced template rendering with comprehensive mobile optimization
document.addEventListener('DOMContentLoaded', () => {
    // Initialize header collapse functionality
    initializeHeaderCollapse();
    
    // Store original renderTemplate function if it exists
    if (typeof renderTemplate === 'function') {
        const originalRenderTemplate = renderTemplate;
        
        // Override with mobile-enhanced version
        window.renderTemplate = function(templateId) {
            const result = originalRenderTemplate.call(this, templateId);
            
            // Apply mobile enhancements after content loads
            setTimeout(() => {
                enhanceMobileResponsiveness();
                
                // Additional mobile-specific enhancements based on template
                if (templateId === 'room-allocation-template') {
                    optimizeRoomAllocationMobile();
                } else if (templateId === 'income-template' || templateId === 'expense-template') {
                    optimizeManagementTemplateMobile(templateId);
                }
            }, 200);
            
            return result;
        };
    }
    
    // Initial call
    enhanceMobileResponsiveness();
});

// Specific mobile optimization functions
function optimizeRoomAllocationMobile() {
    if (window.innerWidth <= 768) {
        const roomContainer = document.querySelector('#room-details');
        if (roomContainer) {
            roomContainer.style.padding = '6px';
            roomContainer.style.margin = '4px';
        }
    }
}

function optimizeManagementTemplateMobile(templateId) {
    if (window.innerWidth <= 768) {
        const template = document.querySelector(`#${templateId}`);
        if (template) {
            // Add mobile-specific classes
            template.classList.add('mobile-optimized');
            
            // Ensure proper spacing
            const container = template.querySelector('.table-container');
            if (container) {
                container.style.padding = '6px';
                container.style.margin = '4px';
            }
        }
    }
}

// Call on window resize with improved debouncing
let mobileResizeTimer;
window.addEventListener('resize', () => {
    clearTimeout(mobileResizeTimer);
    mobileResizeTimer = setTimeout(() => {
        enhanceMobileResponsiveness();
    }, 150);
});

function setupRoleBasedNavigation(userRole) {
    const allowedForStudentsParents = [
        'enrolled-students-template',
        'students-panel-template', 
        'attendance-template',
        'visitors-template',
        'fee-tracker-template',
        'room-allocation-template',
        'issues-template',
        'study-materials-template',
        'help-desk-template'
    ];
    
    document.querySelectorAll('.nav-link').forEach(link => {
        const target = link.dataset.target;
        if(userRole === 'student' || userRole === 'parent') {
            if(!allowedForStudentsParents.includes(target)) {
                link.style.display = 'none';
            } else {
                link.style.display = 'block';
                if(target === 'enrolled-students-template') {
                    link.innerHTML = '<i class="fas fa-user"></i> <span>My Profile</span>';
                }
            }
        } else {
            // Show all links for admin and guest users
            link.style.display = 'block';
        }
    });
    
    // Update page title based on role
    const pageTitle = document.getElementById('page-title');
    if(userRole === 'student') {
        pageTitle.textContent = 'Student Portal';
    } else if(userRole === 'parent') {
        pageTitle.textContent = 'Parent Portal';
    } else if(userRole === 'admin') {
        pageTitle.textContent = 'Al Fizaa Admin Dashboard';
    } else if(userRole === 'guest') {
        pageTitle.textContent = 'Guest Portal (Demo Mode)';
    }
}

// Guest mode utility functions
function isGuestMode() {
    const userRole = localStorage.getItem('userRole') || '';
    return userRole === 'guest';
}

function isAdminOrGuest() {
    const userRole = localStorage.getItem('userRole') || '';
    return userRole === 'admin' || userRole === 'guest';
}

function canModifyData() {
    const userRole = localStorage.getItem('userRole') || '';
    return userRole === 'admin'; // Only admin can actually modify data
}

function showGuestNotification(message) {
    // Create a subtle notification for guest users
    const notification = document.createElement('div');
    notification.className = 'guest-notification';
    notification.style.cssText = `
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px;
        margin: 20px;
        border-radius: 10px;
        text-align: center;
        font-weight: 500;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    `;
    notification.innerHTML = `
        <i class="fas fa-info-circle" style="margin-right: 8px;"></i>
        ${message}
        <div style="margin-top: 8px; font-size: 0.9em; opacity: 0.9;">
            <i class="fas fa-eye"></i> Demo Mode - Interface Preview Only
        </div>
    `;
    return notification;
}

function handleGuestModeForDataSections(templateId) {
    if (!isGuestMode()) return false;
    
    const dataRestrictedSections = [
        'enrolled-students-template', 
        'attendance-template',
        'visitors-template',
        'fee-tracker-template',
        'room-allocation-template',
        'issues-template',
        'expense-template',
        'income-template',
        'financial-report-template',
        'news-template',
        'mess-menu-template',
        'study-materials-template',
        'help-desk-template',
        'feedback-template',
        'sponsored-students-template',
        'scholarship-students-template',
        'partial-support-students-template'
    ];
    
    // Dashboard is handled separately to show admin controls
    if (templateId === 'dashboard-template') {
        setTimeout(() => {
            const mainContent = document.getElementById('main-content');
            if (mainContent) {
                // Add guest notification at the top but keep all admin controls visible
                const notification = showGuestNotification("Dashboard data is hidden in guest mode, but all admin controls are visible for demo purposes.");
                if (mainContent.firstElementChild) {
                    mainContent.insertBefore(notification, mainContent.firstElementChild);
                }
            }
        }, 100);
        return false; // Let dashboard setup run normally
    }
    
    if (dataRestrictedSections.includes(templateId)) {
        // Wait for the template to be rendered, then replace content
        setTimeout(() => {
            const mainContent = document.getElementById('main-content');
            if (mainContent) {
                // Find and clear all data tables
                const tables = mainContent.querySelectorAll('table tbody');
                tables.forEach(tbody => {
                    const colCount = tbody.parentNode.querySelectorAll('th').length || 5;
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="${colCount}" style="text-align: center; padding: 40px; border: none;">
                                ${showGuestNotification("Data is not available in guest mode.").outerHTML}
                            </td>
                        </tr>
                    `;
                });
                
                // Find and clear other data containers
                const dataContainers = mainContent.querySelectorAll(
                    '.attendance-content, #attendance-content, ' +
                    '.visitors-list, #visitors-list, .fee-tracker-content, #fee-tracker-content, ' +
                    '.room-content, #room-content, .issues-content, #issues-content, ' +
                    '.expense-content, #expense-content, .income-content, #income-content, ' +
                    '.financial-report-content, #financial-report-content, .news-content, #news-content, ' +
                    '.mess-menu-content, #mess-menu-content, .study-materials-content, #study-materials-content, ' +
                    '.help-desk-content, #help-desk-content, .feedback-content, #feedback-content, ' +
                    '.cards-container, .content-area, .data-container'
                );
                
                dataContainers.forEach(container => {
                    if (container && container.children.length > 0) {
                        container.innerHTML = '';
                        container.appendChild(showGuestNotification("Data is not available in guest mode."));
                    }
                });
                
                // If no specific data containers found, add notification to main content
                if (dataContainers.length === 0 && tables.length === 0) {
                    const notification = showGuestNotification("Data is not available in guest mode.");
                    if (mainContent.firstElementChild) {
                        mainContent.insertBefore(notification, mainContent.firstElementChild);
                    } else {
                        mainContent.appendChild(notification);
                    }
                }
            }
        }, 100);
        return true;
    }
    
    return false;
}

// ---------- Render Templates ----------
function renderTemplate(templateId){
    const tmpl=document.getElementById(templateId);
    const main=document.getElementById('main-content');
    main.innerHTML='';
    main.appendChild(tmpl.content.cloneNode(true));
    
    // Handle guest mode for data-restricted sections
    const isGuestRestricted = handleGuestModeForDataSections(templateId);
    
    // Always run dashboard setup to show admin controls, even in guest mode
    if(templateId==='dashboard-template') setupDashboard();
    
    // Only run other setup functions if not guest-restricted
    if (!isGuestRestricted) {
        if(templateId==='students-panel-template') setupStudentsPanel();
        if(templateId==='enrolled-students-template') setupEnrolledStudents();
        if(templateId==='room-allocation-template') setupRoomAllocation(); // set up room allocation when rendered
        if(templateId==='fee-tracker-template') setupFeeTracker(); // set up fee tracker when rendered
        if(templateId==='attendance-template') setupAttendance(); // set up attendance when rendered
        if(templateId==='visitors-template') setupVisitorLogbook();
        if(templateId==='issues-template') setupIssues();
        if(templateId==='expense-template') setupExpense();
        if(templateId==='income-template') setupIncome();
        if(templateId==='financial-report-template') setupFinancialReport();
        if(templateId==='news-template') setupTazaKhabar();
        if(templateId==='mess-menu-template') setupMessMenu();
        if(templateId==='social-media-template') setupSocialMedia();
        if(templateId==='study-materials-template') setupStudyMaterials();
        if(templateId==='help-desk-template') setupHelpDesk();
        if(templateId==='feedback-template') setupFeedback();
        if(templateId==='rules-template') setupRules();
        if(templateId==='location-template') setupLocation();
    } else {
        // For guest mode, still run non-data setup functions for interface elements
        if(templateId==='students-panel-template') setupStudentsPanel();
        if(templateId==='rules-template') setupRules();
        if(templateId==='location-template') setupLocation();
        if(templateId==='social-media-template') setupSocialMedia();
    }
}

// ---------- DASHBOARD LOGIC ----------
function setupDashboard(){
    // metrics and card definitions
    const TOTAL_ROOMS = 9;

    const grid = document.getElementById('dashboard-grid');
    const filter = document.getElementById('dashboard-filter');
    const complaintsPendingEl = document.getElementById('complaints-pending-count');
    const complaintsResolvedEl = document.getElementById('complaints-resolved-count');

    function getStudents(){
        // Guest mode: return empty array
        if (isGuestMode()) return [];
        return JSON.parse(localStorage.getItem('studentList')||'[]');
    }
    function getTransactions(){
        // Guest mode: return empty array
        if (isGuestMode()) return [];
        return JSON.parse(localStorage.getItem('transactions')||'[]');
    }
    function getComplaints(){
        // Guest mode: return empty array
        if (isGuestMode()) return [];
        return JSON.parse(localStorage.getItem('complaints')||'[]');
    }

    function sumByPeriod(items, period, typeKey, amountKey){
        // period: 'month' | 'year' | 'all'
        const now = new Date();
        return items.reduce((acc,it)=>{
            const d = new Date(it.date || it.admissionDate);
            if(period==='month'){
                if(d.getMonth()===now.getMonth() && d.getFullYear()===now.getFullYear()){
                    if(!typeKey || it[typeKey]) acc += Number(it[amountKey]||0);
                }
            } else if(period==='year'){
                if(d.getFullYear()===now.getFullYear()){
                    if(!typeKey || it[typeKey]) acc += Number(it[amountKey]||0);
                }
            } else {
                if(!typeKey || it[typeKey]) acc += Number(it[amountKey]||0);
            }
            return acc;
        },0);
    }

    function countSponsored(period){
        const students = getStudents();
        const now = new Date();
        return students.reduce((acc,s)=>{
            const d = new Date(s.admissionDate || s.date || 0);
            const inPeriod = period==='month' ? (d.getMonth()===now.getMonth() && d.getFullYear()===now.getFullYear())
                              : period==='year' ? (d.getFullYear()===now.getFullYear())
                              : true;
            if(inPeriod && s.sponsored) acc++;
            return acc;
        },0);
    }

    function countStudents(period){
        const students = getStudents();
        const now = new Date();
        if(period==='month'){
            return students.filter(s=>{ const d = new Date(s.admissionDate); return d.getMonth()===now.getMonth() && d.getFullYear()===now.getFullYear(); }).length;
        } else if(period==='year'){
            return students.filter(s=>{ const d = new Date(s.admissionDate); return d.getFullYear()===now.getFullYear(); }).length;
        } else return students.length;
    }

    function roomsOccupied(){
        const students = getStudents();
        // assume each student occupies 1 bed; rooms named R1,R2... convert to room counts
        const occupiedRooms = new Set(students.filter(s=>s.roomNo).map(s=>s.roomNo));
        const occupiedBeds = students.filter(s=>s.roomNo).length;
        const vacantBeds = (TOTAL_ROOMS * 2) - occupiedBeds; // assume 2 beds per room as a simple assumption
        return {occupiedRooms: occupiedRooms.size, occupiedBeds, vacantBeds: Math.max(0,vacantBeds)};
    }

    function totalFeeCollected(period){
        const transactions = getTransactions().filter(t=>t.type==='income' || t.type==='sponsorship');
        return sumByPeriod(transactions, period, null, 'amount');
    }
    function totalIncome(period){
        const transactions = getTransactions().filter(t=>t.type==='income');
        return sumByPeriod(transactions, period, null, 'amount');
    }
    function totalExpense(period){
        const transactions = getTransactions().filter(t=>t.type==='expense');
        return sumByPeriod(transactions, period, null, 'amount');
    }

    function updateComplaintsCounts(){
        const complaints = getComplaints();
        complaintsPendingEl.textContent = complaints.filter(c=>c.status==='pending').length;
        complaintsResolvedEl.textContent = complaints.filter(c=>c.status==='resolved').length;
    }

    function buildCards(period){
        grid.innerHTML = '';
        const studentsTotal = countStudents(period);
        const rooms = roomsOccupied();
        const feeCollected = totalFeeCollected(period);
        const income = totalIncome(period);
        const expense = totalExpense(period);
        const sponsored = countSponsored(period);

        const cards = [
            {id:'total-rooms', label:'Total Rooms', value: TOTAL_ROOMS, hint:'Fixed'},
            {id:'total-students', label:'New Students', value: studentsTotal, hint: period==='month'?'This month':period==='year'?'This year':'All time'},
            {id:'rooms-occupied', label:'Occupied Rooms', value: rooms.occupiedRooms, hint:`Beds occupied: ${rooms.occupiedBeds}`},
            {id:'vacant-beds', label:'Vacant Beds', value: rooms.vacantBeds, hint:'Estimated'},
            {id:'fee-collection', label:'Total Fee Collection', value: `PKR ${feeCollected}`, hint: period==='month'?'This month':period==='year'?'This year':'All time'},
            {id:'income', label:'Total Income', value: `PKR ${income}`, hint: period==='month'?'This month':period==='year'?'This year':'All time'},
            {id:'expense', label:'Total Expense', value: `PKR ${expense}`, hint: period==='month'?'This month':period==='year'?'This year':'All time'},
            {id:'invoice-generator', label:'Generate Invoice', value: '📄', hint:'Create digital payment receipts'},
            {id:'sponsored-students', label:'Sponsored Students', value: sponsored, hint:'View sponsored students'},
            {id:'scholarship-students', label:'Scholarship Students', value: '🎓', hint:'View scholarship recipients'},
            {id:'partial-support', label:'Partial Support', value: '🤝', hint:'View partial support students'},
            {id:'complaints-card', label:'Complaints & Issues', value: `${document.getElementById('complaints-pending-count').textContent} pending`, hint:'Click to open Issues'},
            {id:'audit-report', label:'Internal Audit Report', value: '📊', hint:'Generate monthly/yearly audit reports'}
        ];

        cards.forEach(c=>{
            const div = document.createElement('div');
            div.className = 'card';
            div.id = c.id;
            div.innerHTML = `
                <div class="card-top">
                  <div>
                    <div class="label">${c.label}</div>
                    <div class="value">${c.value}</div>
                  </div>
                  <div><i class="fas fa-chevron-right" style="opacity:.35"></i></div>
                </div>
                <div class="muted">${c.hint}</div>
            `;
            // click handlers route to respective modules
            div.addEventListener('click',()=>{
                if(c.id==='total-rooms' || c.id==='rooms-occupied' || c.id==='vacant-beds') {
                    navigateTo('room-allocation-template');
                } else if(c.id==='total-students'){
                    navigateTo('enrolled-students-template');
                } else if(c.id==='fee-collection' || c.id==='income'){
                    navigateTo('income-template');
                } else if(c.id==='expense'){
                    navigateTo('expense-template');
                } else if(c.id==='invoice-generator'){
                    showInvoiceGenerator();
                } else if(c.id==='sponsored-students'){
                    showSponsoredStudents();
                } else if(c.id==='scholarship-students'){
                    showScholarshipStudents();
                } else if(c.id==='partial-support'){
                    showPartialSupportStudents();
                } else if(c.id==='complaints-card'){
                    navigateTo('issues-template');
                } else {
                    navigateTo('dashboard-template');
                }
            });
            // Add click handler for audit report card
            if(c.id === 'audit-report') {
                div.addEventListener('click', () => {
                    showAuditReportModal();
                });
            }
            
            grid.appendChild(div);
        });
    }

    function refresh(){
        updateComplaintsCounts();
        buildCards(filter.value);
    }

    // initial render
    refresh();

    // when filter changes
    filter.addEventListener('change',()=>refresh());
}

// helper navigation
function navigateTo(templateId){
    document.querySelectorAll('.nav-link').forEach(l=>l.classList.remove('active'));
    // mark dashboard link active if needed else find link with matching data-target
    const link = Array.from(document.querySelectorAll('.nav-link')).find(a=>a.dataset.target===templateId);
    if(link) link.classList.add('active');
    renderTemplate(templateId);
}

// ---------- Students Panel ----------
function setupStudentsPanel(){
    // Guest mode: Show interface but with empty data notification
    if (isGuestMode()) {
        // Allow navigation but data will be empty in target sections
        // This preserves the marketing/demo purpose while hiding data
    }
    
    document.querySelectorAll('.students-portal-card').forEach(card=>{
        if(card.classList.contains('rooms')){
            card.addEventListener('click',()=>navigateTo('room-allocation-template'));
        } else if (card.classList.contains('visitors')) {
            card.addEventListener('click',()=>navigateTo('visitors-template'));
        } else if (card.classList.contains('complaints')) {
            card.addEventListener('click',()=>navigateTo('issues-template'));
        } else if (card.classList.contains('fee')) {
            card.addEventListener('click',()=>navigateTo('fee-tracker-template'));
        } else if(card.classList.contains('idcard')){
            card.addEventListener('click',()=>showStudentIdCard());
        } else if(card.classList.contains('mess')){
            card.addEventListener('click',()=>navigateTo('mess-menu-template'));
        } else if(card.classList.contains('rules')){
            card.addEventListener('click',()=>navigateTo('rules-template'));
        } else if(card.classList.contains('materials')){
            card.addEventListener('click',()=>navigateTo('study-materials-template'));
        } else if(card.classList.contains('help')){
            card.addEventListener('click',()=>navigateTo('help-desk-template'));
        } else if(card.classList.contains('social') && card.querySelector('.label').textContent === 'Social Links'){
            card.addEventListener('click',()=>navigateTo('social-media-template'));
        } else if(card.classList.contains('social') && card.querySelector('.label').textContent === 'Share Hostel Location'){
            card.addEventListener('click',()=>navigateTo('location-template'));
        } else {
            card.addEventListener('click',()=>{
                showModal(`${card.querySelector('.label').textContent} module clicked`);
            });
        }
    });
    
    // Role-based filtering for student category buttons
    const userRole = localStorage.getItem('userRole') || '';
    const studentId = localStorage.getItem('studentId') || '';
    
    if(userRole === 'student' || userRole === 'parent') {
        // For students and parents, only show category buttons if they belong to that category
        const students = JSON.parse(localStorage.getItem('studentList') || '[]');
        const currentStudent = students.find(s => s.id === studentId);
        
        if(currentStudent) {
            // Hide category buttons if student doesn't belong to that category
            const sponsoredBtn = document.querySelector('.sponsored-btn');
            const scholarshipBtn = document.querySelector('.scholarship-btn');
            const partialSupportBtn = document.querySelector('.partial-support-btn');
            
            if(sponsoredBtn && !currentStudent.sponsored) {
                sponsoredBtn.style.display = 'none';
            }
            if(scholarshipBtn && !currentStudent.scholarship) {
                scholarshipBtn.style.display = 'none';
            }
            if(partialSupportBtn && !currentStudent.partialSupport) {
                partialSupportBtn.style.display = 'none';
            }
        }
    }
    
    // Hide Qarz e Hasna Form button for parents and admins (students only)
    const qarzFormBtn = document.querySelector('.qarz-form-btn');
    if(qarzFormBtn && userRole !== 'student') {
        qarzFormBtn.style.display = 'none';
    }
    
    // For admin, all other category buttons remain visible
}

// Show Student ID Card in Modal
function showStudentIdCard(){
    // Auto-fetch student info from registration data
    let students = JSON.parse(localStorage.getItem('studentList')||'[]');
    let studentId = localStorage.getItem('studentId');
    let student = students.find(s=>s.id===studentId) || students[0] || {};
    
    // Auto-fetch all information from student registration data
    let photoUrl = student.photo || "https://randomuser.me/api/portraits/women/32.jpg";
    let studentName = student.name || 'Student Name';
    let studentID = student.id || 'AF001';
    let fatherName = student.guardian || 'Father Name';
    let fatherContact = student.guardianContact || student.contact || 'Contact Number';
    let institution = student.university || student.college || student.school || 'Institution';
    let homeAddress = `${student.village || 'Village'}, Skardu, Baltistan`;
    let digitalSignature = student.signature || 'Student Signature';
    
    // Get hostel logo
    const savedLogo = localStorage.getItem('hostelLogo');
    const logoHtml = savedLogo 
        ? `<img src="${savedLogo}" style="width:100%;height:100%;object-fit:cover;border-radius:inherit;">` 
        : '🏠';
    
    // Calculate expiry date from bachelor completion (4 years from admission)
    const admissionDate = new Date(student.admissionDate || Date.now());
    const expiryDate = new Date(admissionDate);
    expiryDate.setFullYear(expiryDate.getFullYear() + 4);
    const expiryDateStr = expiryDate.toLocaleDateString();
    
    // Create modal HTML
    const modalHtml = `
        <div id="idcard-modal" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:10000;display:flex;align-items:center;justify-content:center;padding:20px;overflow-y:auto;">
            <div style="background:linear-gradient(135deg, #667eea 0%, #764ba2 30%, #f093fb 60%, #f5576c 100%);border-radius:20px;padding:30px;max-width:95vw;max-height:95vh;overflow-y:auto;position:relative;">
                <button onclick="closeIdCardModal()" style="position:absolute;top:15px;right:15px;background:rgba(255,255,255,0.2);color:white;border:2px solid rgba(255,255,255,0.3);border-radius:50%;width:40px;height:40px;cursor:pointer;font-size:18px;font-weight:bold;backdrop-filter:blur(10px);transition:all 0.3s ease;z-index:1001;">×</button>
                

                
                <div style="display:flex;gap:20px;justify-content:center;flex-wrap:wrap;align-items:flex-start;margin-bottom:20px;">
                    <!-- FRONT SIDE -->
                    <div style="width:500px;height:320px;border-radius:15px;box-shadow:0 15px 35px rgba(0,0,0,0.3);position:relative;font-family:'Poppins',sans-serif;overflow:visible;padding:15px;box-sizing:border-box;flex-shrink:0;background:linear-gradient(45deg, #667eea, #764ba2, #f093fb, #f5576c, #4facfe, #00f2fe);background-size:300% 300%;animation:gradientShift 3s ease infinite;color:white;">
                        <div style="position:absolute;top:0;left:0;width:100%;height:100%;opacity:0.08;background:radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px);background-size:20px 20px;pointer-events:none;"></div>
                        
                        <div style="text-align:center;margin-bottom:15px;">
                            <div style="font-size:1.1rem;font-weight:800;margin-bottom:4px;text-shadow:1px 1px 3px rgba(0,0,0,0.3);">Al Fizaa Girls Hostel</div>
                            <div style="font-size:0.9rem;opacity:0.9;font-weight:600;">Student ID Card</div>
                        </div>
                        
                        <div style="display:flex;align-items:flex-start;gap:15px;margin-bottom:15px;">
                            <img src="${photoUrl}" alt="Student Photo" style="width:90px;height:90px;border-radius:12px;object-fit:cover;border:3px solid rgba(255,255,255,0.4);box-shadow:0 8px 20px rgba(0,0,0,0.3);backdrop-filter:blur(5px);flex-shrink:0;"/>
                            <div style="flex:1;">
                                <div style="font-size:1.1rem;font-weight:800;margin-bottom:8px;text-shadow:1px 1px 3px rgba(0,0,0,0.4);">${studentName}</div>
                                <div style="font-size:0.9rem;font-weight:700;margin-bottom:4px;opacity:0.9;">ID: ${studentID}</div>
                            </div>
                            <div style="width:45px;height:45px;background:rgba(255,255,255,0.25);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:1.6rem;backdrop-filter:blur(15px);border:2px solid rgba(255,255,255,0.3);box-shadow:0 8px 25px rgba(0,0,0,0.2);flex-shrink:0;">${logoHtml}</div>
                        </div>
                        
                        <div style="position:relative;z-index:2;">
                            <div style="margin-bottom:2px;font-size:0.85rem;display:flex;align-items:flex-start;background:rgba(255,255,255,0.12);padding:4px 8px;border-radius:5px;margin:1px 0;backdrop-filter:blur(5px);">
                                <span style="font-weight:700;min-width:80px;opacity:0.95;flex-shrink:0;font-size:0.8rem;">Father Name:</span>
                                <span style="font-weight:600;flex:1;word-wrap:break-word;font-size:0.8rem;line-height:1.2;">${fatherName}</span>
                            </div>
                            
                            <div style="margin-bottom:2px;font-size:0.85rem;display:flex;align-items:flex-start;background:rgba(255,255,255,0.12);padding:4px 8px;border-radius:5px;margin:1px 0;backdrop-filter:blur(5px);">
                                <span style="font-weight:700;min-width:80px;opacity:0.95;flex-shrink:0;font-size:0.8rem;">Institution:</span>
                                <span style="font-weight:600;flex:1;word-wrap:break-word;font-size:0.8rem;line-height:1.2;">${institution}</span>
                            </div>
                            
                            <div style="margin-bottom:2px;font-size:0.85rem;display:flex;align-items:flex-start;background:rgba(255,255,255,0.12);padding:4px 8px;border-radius:5px;margin:1px 0;backdrop-filter:blur(5px);">
                                <span style="font-weight:700;min-width:80px;opacity:0.95;flex-shrink:0;font-size:0.8rem;">Address:</span>
                                <span style="font-weight:600;flex:1;word-wrap:break-word;font-size:0.8rem;line-height:1.2;">${homeAddress}</span>
                            </div>
                            
                            <div style="margin-bottom:2px;font-size:0.85rem;display:flex;align-items:flex-start;background:rgba(255,255,255,0.12);padding:4px 8px;border-radius:5px;margin:1px 0;backdrop-filter:blur(5px);">
                                <span style="font-weight:700;min-width:80px;opacity:0.95;flex-shrink:0;font-size:0.8rem;">Expires:</span>
                                <span style="font-weight:600;flex:1;word-wrap:break-word;font-size:0.8rem;line-height:1.2;">${expiryDateStr}</span>
                            </div>
                        </div>
                        
                        <div style="position:absolute;bottom:12px;left:12px;right:12px;font-size:0.7rem;background:rgba(255,255,255,0.15);padding:8px;border-radius:6px;backdrop-filter:blur(10px);text-align:center;">
                            <div style="font-size:0.75rem;opacity:0.8;margin-bottom:3px;">Signature:</div>
                            <div style="font-family:cursive;font-size:0.9rem;font-weight:600;">${digitalSignature}</div>
                        </div>
                    </div>
                    
                    <!-- BACK SIDE -->
                    <div style="width:500px;height:320px;border-radius:15px;box-shadow:0 15px 35px rgba(0,0,0,0.3);position:relative;font-family:'Poppins',sans-serif;overflow:visible;padding:15px;box-sizing:border-box;flex-shrink:0;background:linear-gradient(45deg, #764ba2, #667eea, #f5576c, #f093fb, #00f2fe, #4facfe);background-size:300% 300%;animation:gradientShift 3s ease infinite reverse;color:white;">
                        <div style="position:absolute;top:0;left:0;width:100%;height:100%;opacity:0.08;background:radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px);background-size:20px 20px;pointer-events:none;"></div>
                        <div style="display:flex;flex-direction:column;height:100%;justify-content:space-between;">
                            <div style="text-align:center;margin-bottom:15px;">
                                <div style="font-size:1.1rem;font-weight:800;margin-bottom:4px;text-shadow:1px 1px 3px rgba(0,0,0,0.3);">Al Fizaa Girls Hostel</div>
                                <div style="font-size:0.9rem;opacity:0.9;font-weight:600;">Student ID Card</div>
                            </div>
                            
                            <div style="margin-bottom:15px;">
                                <div style="margin-bottom:2px;font-size:0.85rem;display:flex;align-items:flex-start;background:rgba(255,255,255,0.12);padding:4px 8px;border-radius:5px;margin:1px 0;backdrop-filter:blur(5px);">
                                    <span style="font-weight:700;min-width:80px;opacity:0.95;flex-shrink:0;font-size:0.8rem;">Father No:</span>
                                    <span style="font-weight:600;flex:1;word-wrap:break-word;font-size:0.8rem;line-height:1.2;">${fatherContact}</span>
                                </div>
                                
                                <div style="margin-bottom:2px;font-size:0.85rem;display:flex;align-items:flex-start;background:rgba(255,255,255,0.12);padding:4px 8px;border-radius:5px;margin:1px 0;backdrop-filter:blur(5px);">
                                    <span style="font-weight:700;min-width:80px;opacity:0.95;flex-shrink:0;font-size:0.8rem;">Emergency:</span>
                                    <span style="font-weight:600;flex:1;word-wrap:break-word;font-size:0.8rem;line-height:1.2;">03411-666480</span>
                                </div>
                            </div>
                            
                            <div style="background:rgba(255,255,255,0.15);padding:12px;border-radius:12px;backdrop-filter:blur(15px);border:1px solid rgba(255,255,255,0.2);text-align:center;">
                                <div style="font-weight:800;margin-bottom:8px;color:#fff;text-shadow:2px 2px 4px rgba(0,0,0,0.3);font-size:0.8rem;text-align:center;">📍 If Found Please Return to:</div>
                                <div style="font-size:0.7rem;line-height:1.2;opacity:0.95;font-weight:500;text-align:center;">
                                    <strong>Al Fizaa Girls Hostel</strong><br>
                                    Adjacent to Old Dr. Syeda Clinic<br>
                                    Abbas Town, Pareshan Chowk<br>
                                    Hassan Sadpara Chowk<br>
                                    IG Ashraf Shaheed Road<br>
                                    Skardu Baltistan, Pakistan
                                </div>
                                
                                <div style="margin-top:8px;font-size:0.75rem;opacity:0.9;font-weight:600;text-align:center;">
                                    📞 Contact: 0344-5436905 | 0355-4775037
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div style="text-align:center;">
                    <button onclick="printIdCard()" style="padding:12px 25px;background:rgba(255,255,255,0.2);color:white;border:2px solid rgba(255,255,255,0.3);border-radius:10px;cursor:pointer;font-weight:600;font-size:1rem;backdrop-filter:blur(10px);transition:all 0.3s ease;margin-right:10px;">🖨️ Print Card</button>
                    <button onclick="closeIdCardModal()" style="padding:12px 25px;background:rgba(255,255,255,0.2);color:white;border:2px solid rgba(255,255,255,0.3);border-radius:10px;cursor:pointer;font-weight:600;font-size:1rem;backdrop-filter:blur(10px);transition:all 0.3s ease;">✖️ Close</button>
                </div>
            </div>
        </div>
    `;
    
    // Add modal to body
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Prevent body scroll
    document.body.style.overflow = 'hidden';
}

// Close ID Card Modal
function closeIdCardModal() {
    const modal = document.getElementById('idcard-modal');
    if (modal) {
        modal.remove();
        document.body.style.overflow = 'auto';
    }
}

// Print ID Card
function printIdCard() {
    window.print();
}

// ---------- Room Allocation Template Logic ----------
function setupRoomAllocation() {
    // Guest mode: Show empty room allocation with notification
    if (isGuestMode()) {
        const roomContent = document.querySelector('#room-allocation-content, .room-content');
        if (roomContent) {
            roomContent.innerHTML = '';
            roomContent.appendChild(showGuestNotification("Room allocation data is not available in guest mode."));
        }
        return;
    }
    
    const userRole = localStorage.getItem('userRole');
    const isAdmin = isAdminOrGuest(); // Show admin UI to both admin and guest users
    
    // Room numbers and capacities - R01 format remains fixed
    const rooms = [
        { roomNo: 'R01', capacity: 4 },
        { roomNo: 'R02', capacity: 3 },
        { roomNo: 'R03', capacity: 5 },
        { roomNo: 'R04', capacity: 6 },
        { roomNo: 'R05', capacity: 4 },
        { roomNo: 'R06', capacity: 4 },
        { roomNo: 'R07', capacity: 4 },
        { roomNo: 'R08', capacity: 6 },
        { roomNo: 'R09', capacity: 5 }
    ];

    // Fetch students and their room assignments
    const students = JSON.parse(localStorage.getItem('studentList') || '[]');
    
    function renderRoomTable() {
        // Map: roomNo -> students assigned
        const roomMap = {};
        rooms.forEach(room => roomMap[room.roomNo] = []);
        students.forEach(s => {
            // Accept both R1/R01 formats for backward compatibility
            let rn = s.roomNo;
            if (rn && rn.length === 2 && rn.startsWith('R')) rn = 'R0' + rn[1];
            if (roomMap[rn]) {
                roomMap[rn].push(s);
            }
        });

        // Build table HTML with vibrant styling
        let html = `
        <div style="background:linear-gradient(135deg,#667eea 0%,#764ba2 30%,#f093fb 60%,#f5576c 100%);padding:30px;border-radius:20px;margin-bottom:25px;text-align:center;box-shadow:0 15px 35px rgba(0,0,0,0.2);">
          <h1 style="color:white;font-size:2.5rem;margin:0;text-shadow:2px 2px 8px rgba(0,0,0,0.3);font-weight:800;">🏠 Room Allocation</h1>
          <p style="color:rgba(255,255,255,0.9);font-size:1.2rem;margin:10px 0 0 0;">${isAdmin ? '✨ Admin Control Panel ✨' : '👀 View Only Mode'}</p>
        </div>
        <div style="background:linear-gradient(135deg,#ff9a9e 0%,#fecfef 50%,#fecfef 100%);padding:20px;border-radius:15px;margin-bottom:20px;">
        <table style="width:100%;border-collapse:separate;border-spacing:0;background:rgba(255,255,255,0.9);border-radius:15px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,0.15);">
          <thead>
            <tr style="background:linear-gradient(135deg,#667eea,#764ba2);color:white;">
              <th style="padding:15px;font-size:1.1rem;font-weight:700;text-shadow:1px 1px 3px rgba(0,0,0,0.3);">🏠 Room No</th>
              <th style="padding:15px;font-size:1.1rem;font-weight:700;text-shadow:1px 1px 3px rgba(0,0,0,0.3);">📊 Capacity ${isAdmin ? '<br><span style="font-size:0.8em;opacity:0.8;">(Editable)</span>' : ''}</th>
              <th style="padding:15px;font-size:1.1rem;font-weight:700;text-shadow:1px 1px 3px rgba(0,0,0,0.3);">👥 Occupied ${isAdmin ? '<br><span style="font-size:0.8em;opacity:0.8;">(Editable)</span>' : ''}</th>
              <th style="padding:15px;font-size:1.1rem;font-weight:700;text-shadow:1px 1px 3px rgba(0,0,0,0.3);">✨ Vacant</th>
            </tr>
          </thead>
          <tbody>
        `;
        
        rooms.forEach(room => {
            const occupied = roomMap[room.roomNo].length;
            const vacant = room.capacity - occupied;
            
            const rowGradient = `linear-gradient(135deg, ${vacant > 0 ? '#e8f5e8, #c8e6c9' : '#ffebee, #ffcdd2'})`;
            const roomIndex = rooms.indexOf(room);
            const roomGradients = [
                'linear-gradient(135deg, #ff9a9e, #fecfef)',
                'linear-gradient(135deg, #a8edea, #fed6e3)', 
                'linear-gradient(135deg, #ffecd2, #fcb69f)',
                'linear-gradient(135deg, #d299c2, #fef9d7)',
                'linear-gradient(135deg, #89f7fe, #66a6ff)',
                'linear-gradient(135deg, #fdbb2d, #22c1c3)',
                'linear-gradient(135deg, #ee9ca7, #ffdde1)',
                'linear-gradient(135deg, #667eea, #764ba2)',
                'linear-gradient(135deg, #f093fb, #f5576c)'
            ];
            
            if (isAdmin) {
                html += `
                <tr style="background:${rowGradient};transition:all 0.3s ease;" onmouseover="this.style.transform='scale(1.02)';this.style.boxShadow='0 8px 25px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='scale(1)';this.style.boxShadow='none'">
                  <td style="padding:15px;text-align:center;"><div style="background:${roomGradients[roomIndex]};color:white;padding:8px 12px;border-radius:10px;font-weight:bold;font-size:1.1rem;text-shadow:1px 1px 3px rgba(0,0,0,0.3);">${room.roomNo}</div></td>
                  <td style="padding:15px;text-align:center;">
                    <input type="number" value="${room.capacity}" min="1" max="10" 
                           style="width:70px;padding:8px 12px;border:2px solid #667eea;border-radius:10px;text-align:center;font-weight:bold;background:linear-gradient(135deg,#fff,#f8f9ff);box-shadow:0 4px 15px rgba(102,126,234,0.2);transition:all 0.3s ease;" 
                           onchange="updateRoomCapacity('${room.roomNo}', this.value)"
                           onfocus="this.style.transform='scale(1.1)';this.style.boxShadow='0 6px 20px rgba(102,126,234,0.4)'" 
                           onblur="this.style.transform='scale(1)';this.style.boxShadow='0 4px 15px rgba(102,126,234,0.2)'">
                  </td>
                  <td style="padding:15px;text-align:center;">
                    <input type="number" value="${occupied}" min="0" max="${room.capacity}" 
                           style="width:70px;padding:8px 12px;border:2px solid #f5576c;border-radius:10px;text-align:center;font-weight:bold;background:linear-gradient(135deg,#fff,#fff5f5);box-shadow:0 4px 15px rgba(245,87,108,0.2);transition:all 0.3s ease;" 
                           onchange="updateRoomOccupied('${room.roomNo}', this.value)" 
                           title="Assign/unassign students to this room"
                           onfocus="this.style.transform='scale(1.1)';this.style.boxShadow='0 6px 20px rgba(245,87,108,0.4)'" 
                           onblur="this.style.transform='scale(1)';this.style.boxShadow='0 4px 15px rgba(245,87,108,0.2)'">
                  </td>
                  <td style="padding:15px;text-align:center;"><div style="background:${vacant > 0 ? 'linear-gradient(135deg,#28a745,#20c997)' : 'linear-gradient(135deg,#dc3545,#fd7e14)'};color:white;padding:8px 15px;border-radius:20px;font-weight:bold;font-size:1.1rem;display:inline-block;box-shadow:0 4px 15px rgba(0,0,0,0.2);">${vacant}</div></td>
                </tr>
                `;
            } else {
                html += `
                <tr style="background:${rowGradient};transition:all 0.3s ease;" onmouseover="this.style.transform='scale(1.02)';this.style.boxShadow='0 8px 25px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='scale(1)';this.style.boxShadow='none'">
                  <td style="padding:15px;text-align:center;"><div style="background:${roomGradients[roomIndex]};color:white;padding:8px 12px;border-radius:10px;font-weight:bold;font-size:1.1rem;text-shadow:1px 1px 3px rgba(0,0,0,0.3);">${room.roomNo}</div></td>
                  <td style="padding:15px;text-align:center;font-weight:bold;font-size:1.1rem;color:#333;">${room.capacity}</td>
                  <td style="padding:15px;text-align:center;font-weight:bold;font-size:1.1rem;color:#333;">${occupied}</td>
                  <td style="padding:15px;text-align:center;"><div style="background:${vacant > 0 ? 'linear-gradient(135deg,#28a745,#20c997)' : 'linear-gradient(135deg,#dc3545,#fd7e14)'};color:white;padding:8px 15px;border-radius:20px;font-weight:bold;font-size:1.1rem;display:inline-block;box-shadow:0 4px 15px rgba(0,0,0,0.2);">${vacant}</div></td>
                </tr>
                `;
            }
        });
        html += `</tbody></table></div>`;

        // Show students in each room with vibrant styling
        html += `<div style="background:linear-gradient(135deg,#a8edea 0%,#fed6e3 100%);padding:25px;border-radius:20px;margin-top:25px;box-shadow:0 10px 30px rgba(0,0,0,0.1);">
        <h2 style="text-align:center;color:#333;margin-bottom:25px;font-size:2rem;text-shadow:1px 1px 3px rgba(0,0,0,0.1);">👥 Students in Rooms</h2>`;
        
        const roomGradients = [
            'linear-gradient(135deg, #ff9a9e, #fecfef)',
            'linear-gradient(135deg, #a8edea, #fed6e3)', 
            'linear-gradient(135deg, #ffecd2, #fcb69f)',
            'linear-gradient(135deg, #d299c2, #fef9d7)',
            'linear-gradient(135deg, #89f7fe, #66a6ff)',
            'linear-gradient(135deg, #fdbb2d, #22c1c3)',
            'linear-gradient(135deg, #ee9ca7, #ffdde1)',
            'linear-gradient(135deg, #667eea, #764ba2)',
            'linear-gradient(135deg, #f093fb, #f5576c)'
        ];
        
        rooms.forEach((room, index) => {
            const studentsInRoom = roomMap[room.roomNo];
            html += `<div style="margin-bottom:15px;padding:20px;background:${roomGradients[index]};border-radius:15px;box-shadow:0 8px 25px rgba(0,0,0,0.15);transition:all 0.3s ease;" onmouseover="this.style.transform='translateY(-5px)';this.style.boxShadow='0 15px 35px rgba(0,0,0,0.2)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 8px 25px rgba(0,0,0,0.15)'">
            <div style="display:flex;align-items:center;gap:15px;margin-bottom:10px;">
              <div style="background:rgba(255,255,255,0.3);padding:10px 15px;border-radius:10px;font-weight:bold;font-size:1.2rem;color:white;text-shadow:1px 1px 3px rgba(0,0,0,0.3);">${room.roomNo}</div>
              <div style="background:rgba(255,255,255,0.2);padding:8px 12px;border-radius:20px;color:white;font-weight:600;">${studentsInRoom.length}/${room.capacity} Students</div>
            </div>`;
            
            if (studentsInRoom.length === 0) {
                html += `<div style="background:rgba(255,255,255,0.2);padding:15px;border-radius:10px;color:white;font-style:italic;text-align:center;">🏠 No students assigned</div>`;
            } else {
                html += `<div style="display:flex;flex-wrap:wrap;gap:10px;">`;
                studentsInRoom.forEach(student => {
                    html += `<div style="background:rgba(255,255,255,0.9);padding:8px 12px;border-radius:20px;color:#333;font-weight:600;box-shadow:0 3px 10px rgba(0,0,0,0.1);">${student.name}</div>`;
                });
                html += `</div>`;
            }
            html += `</div>`;
        });
        html += `</div>`;

        const heroVideos = JSON.parse(localStorage.getItem('heroVideos') || '[]');
        const videoHTML = heroVideos.length > 0 ? `<video style="position:fixed;top:0;left:0;width:100%;height:100%;object-fit:cover;z-index:-1;opacity:0.3;" autoplay muted loop><source src="${heroVideos[Math.floor(Math.random() * heroVideos.length)]}" type="video/mp4"></video>` : '';
        
        document.getElementById('main-content').innerHTML = `${videoHTML}<div style="padding:20px;position:relative;z-index:1;">${html}</div>`;
    }
    
    // Global functions for admin editing
    window.updateRoomCapacity = function(roomNo, newCapacity) {
        if (!isAdmin) return;
        
        const capacity = parseInt(newCapacity);
        if (capacity < 1 || capacity > 10) {
            alert('Capacity must be between 1 and 10');
            renderRoomTable();
            return;
        }
        
        // Update room capacity in the rooms array
        const room = rooms.find(r => r.roomNo === roomNo);
        if (room) {
            room.capacity = capacity;
            // Save to localStorage if needed
            localStorage.setItem('roomsData', JSON.stringify(rooms));
            renderRoomTable();
        }
    };
    
    window.updateRoomOccupied = function(roomNo, newOccupied) {
        if (!isAdmin) return;
        
        const occupied = parseInt(newOccupied);
        const room = rooms.find(r => r.roomNo === roomNo);
        
        if (!room || occupied < 0 || occupied > room.capacity) {
            alert(`Occupied must be between 0 and ${room ? room.capacity : 'capacity'}`);
            renderRoomTable();
            return;
        }
        
        // Get current students in this room
        const currentStudents = students.filter(s => {
            let rn = s.roomNo;
            if (rn && rn.length === 2 && rn.startsWith('R')) rn = 'R0' + rn[1];
            return rn === roomNo;
        });
        
        const currentOccupied = currentStudents.length;
        
        if (occupied > currentOccupied) {
            // Need to assign more students - find unassigned students
            const unassignedStudents = students.filter(s => !s.roomNo || s.roomNo === '');
            const needed = occupied - currentOccupied;
            
            if (unassignedStudents.length < needed) {
                alert(`Not enough unassigned students. Only ${unassignedStudents.length} available.`);
                renderRoomTable();
                return;
            }
            
            // Assign students to this room
            for (let i = 0; i < needed; i++) {
                unassignedStudents[i].roomNo = roomNo;
            }
        } else if (occupied < currentOccupied) {
            // Need to unassign students
            const toUnassign = currentOccupied - occupied;
            for (let i = 0; i < toUnassign; i++) {
                currentStudents[i].roomNo = '';
            }
        }
        
        // Save updated student list
        localStorage.setItem('studentList', JSON.stringify(students));
        renderRoomTable();
    };
    
    // Load saved room data if exists
    const savedRooms = localStorage.getItem('roomsData');
    if (savedRooms) {
        const parsedRooms = JSON.parse(savedRooms);
        parsedRooms.forEach(savedRoom => {
            const room = rooms.find(r => r.roomNo === savedRoom.roomNo);
            if (room) {
                room.capacity = savedRoom.capacity;
            }
        });
    }
    
    renderRoomTable();
}

// ---------- Fee Tracker Template Logic ----------
function setupFeeTracker() {
    // Guest mode: Show empty fee tracker with notification
    if (isGuestMode()) {
        const feeTrackerContent = document.querySelector('#fee-tracker-content, .fee-tracker-content');
        if (feeTrackerContent) {
            feeTrackerContent.innerHTML = '';
            feeTrackerContent.appendChild(showGuestNotification("Fee tracker data is not available in guest mode."));
        }
        return;
    }
    
    const students = JSON.parse(localStorage.getItem('studentList') || '[]');
    const userRole = localStorage.getItem('userRole');
    const currentStudentId = localStorage.getItem('studentId');
    const isAdmin = isAdminOrGuest(); // Show admin UI to both admin and guest users
    
    let filteredStudents = students;
    if(!isAdmin) {
        filteredStudents = students.filter(s => s.id === currentStudentId);
        document.getElementById('fee-filters').style.display = 'none';
        document.getElementById('add-payment-btn').style.display = 'none';
    } else {
        const studentSelect = document.getElementById('fee-student-filter');
        const paymentStudentSelect = document.getElementById('payment-student');
        const studentOptions = students.map(s => `<option value="${s.id}">${s.name} (${s.id})</option>`).join('');
        studentSelect.innerHTML = '<option value="all">All Students</option>' + studentOptions;
        paymentStudentSelect.innerHTML = '<option value="">Select Student</option>' + studentOptions;
    }
    
    let currentTab = 'total';
    
    // Initialize payment records if not exists
    if(!localStorage.getItem('paymentRecords')) {
        localStorage.setItem('paymentRecords', JSON.stringify([]));
    }
    
    function updateSummaryCards() {
        let totalCollected = 0, totalPending = 0, overdueCount = 0;
        
        filteredStudents.forEach(s => {
            const data = getTabData(s, currentTab);
            totalCollected += data.paid;
            totalPending += data.due;
            if(data.due > 0) overdueCount++;
        });
        
        document.getElementById('total-collected').textContent = `PKR ${totalCollected.toLocaleString()}`;
        document.getElementById('total-pending').textContent = `PKR ${totalPending.toLocaleString()}`;
        document.getElementById('students-count').textContent = filteredStudents.length;
        document.getElementById('overdue-count').textContent = overdueCount;
    }
    
    function setupTabs() {
        document.querySelectorAll('.fee-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                document.querySelectorAll('.fee-tab').forEach(t => {
                    t.style.background = '#f8f9fa';
                    t.style.color = '#333';
                    t.style.boxShadow = 'none';
                    t.classList.remove('active');
                });
                this.style.background = 'linear-gradient(135deg,#667eea,#764ba2)';
                this.style.color = 'white';
                this.style.boxShadow = '0 4px 15px rgba(102,126,234,0.3)';
                this.classList.add('active');
                currentTab = this.dataset.tab;
                renderTable();
                updateSummaryCards();
            });
        });
    }
    
    function getTabData(student, tab) {
        switch(tab) {
            case 'admission':
                return {
                    amount: student.admissionFee || 5000,
                    paid: student.admissionFeePaid || 0,
                    due: (student.admissionFee || 5000) - (student.admissionFeePaid || 0)
                };
            case 'security':
                return {
                    amount: student.securityFee || 3000,
                    paid: student.securityFeePaid || 0,
                    due: (student.securityFee || 3000) - (student.securityFeePaid || 0)
                };
            case 'monthly':
                return {
                    amount: student.monthlyFee || 25000,
                    paid: student.monthlyFeePaid || 0,
                    due: (student.monthlyFee || 25000) - (student.monthlyFeePaid || 0)
                };
            default:
                const admission = student.admissionFee || 5000;
                const security = student.securityFee || 3000;
                const monthly = student.monthlyFee || 25000;
                const totalAmount = admission + security + monthly;
                const totalPaid = (student.admissionFeePaid || 0) + (student.securityFeePaid || 0) + (student.monthlyFeePaid || 0);
                return {
                    amount: totalAmount,
                    paid: totalPaid,
                    due: totalAmount - totalPaid
                };
        }
    }
    
    function getDueDate(student) {
        const admissionDate = new Date(student.admissionDate || Date.now());
        const dueDate = new Date(admissionDate);
        dueDate.setMonth(dueDate.getMonth() + 1);
        return dueDate.toISOString().slice(0, 10);
    }
    
    function renderTable() {
        let filtered = filteredStudents;
        
        if(isAdmin) {
            const studentId = document.getElementById('fee-student-filter').value;
            const period = document.getElementById('fee-period-filter').value;
            const search = document.getElementById('fee-search').value.toLowerCase();
            
            if(studentId !== 'all') {
                filtered = filtered.filter(s => s.id === studentId);
            }
            if(search) {
                filtered = filtered.filter(s => 
                    (s.name && s.name.toLowerCase().includes(search)) ||
                    (s.id && s.id.toLowerCase().includes(search))
                );
            }
        }
        
        const tbody = document.getElementById('fee-tracker-tbody');
        tbody.innerHTML = '';
        
        const rowGradients = [
            'linear-gradient(135deg, #fff5f5, #ffe0e6)',
            'linear-gradient(135deg, #f0f9ff, #e0f2fe)',
            'linear-gradient(135deg, #f0fdf4, #dcfce7)',
            'linear-gradient(135deg, #fefce8, #fef3c7)',
            'linear-gradient(135deg, #fdf4ff, #fae8ff)'
        ];
        
        filtered.forEach((s, index) => {
            const data = getTabData(s, currentTab);
            let status = 'Due';
            let statusColor = '#dc3545';
            if(data.due <= 0) {
                status = 'Paid';
                statusColor = '#28a745';
            } else if(data.paid > 0) {
                status = 'Partial';
                statusColor = '#ffc107';
            }
            
            const dueDate = getDueDate(s);
            const isOverdue = new Date(dueDate) < new Date() && data.due > 0;
            
            tbody.innerHTML += `
                <tr style="background:${rowGradients[index % rowGradients.length]};transition:all 0.3s ease;" onmouseover="this.style.background='#e3f2fd';this.style.transform='scale(1.02)'" onmouseout="this.style.background='${rowGradients[index % rowGradients.length]}';this.style.transform='scale(1)'">
                    <td style="padding:12px 8px;font-weight:700;color:#333;">${s.id||''}</td>
                    <td style="padding:12px 8px;font-weight:600;color:#333;">${s.name||''}</td>
                    <td style="padding:12px 8px;font-weight:700;color:#17a2b8;">PKR ${data.amount.toLocaleString()}</td>
                    <td style="padding:12px 8px;font-weight:700;color:#28a745;">PKR ${data.paid.toLocaleString()}</td>
                    <td style="padding:12px 8px;"><span style="background:${data.due > 0 ? (isOverdue ? '#dc3545' : '#fd7e14') : '#28a745'};color:white;padding:6px 10px;border-radius:12px;font-weight:700;box-shadow:0 3px 10px rgba(0,0,0,0.2);">PKR ${data.due.toLocaleString()}</span></td>
                    <td style="padding:12px 8px;color:#666;font-weight:500;">${dueDate}</td>
                    <td style="padding:12px 8px;"><span style="background:${statusColor};color:white;padding:6px 12px;border-radius:15px;font-weight:700;font-size:0.8rem;box-shadow:0 3px 10px rgba(0,0,0,0.2);">${status}</span></td>
                    <td style="padding:12px 8px;">
                        ${isAdmin ? `
                            <button onclick="showPaymentHistory('${s.id}')" style="padding:6px 12px;background:linear-gradient(135deg,#17a2b8,#6f42c1);color:white;border:none;border-radius:6px;cursor:pointer;font-size:0.8rem;margin-right:5px;font-weight:600;">📊 History</button>
                            <button onclick="editFeeAmount('${s.id}', '${currentTab}')" style="padding:6px 12px;background:linear-gradient(135deg,#ffc107,#fd7e14);color:white;border:none;border-radius:6px;cursor:pointer;font-size:0.8rem;font-weight:600;">✏️ Edit</button>
                        ` : `
                            <button onclick="showPaymentHistory('${s.id}')" style="padding:6px 12px;background:linear-gradient(135deg,#17a2b8,#6f42c1);color:white;border:none;border-radius:6px;cursor:pointer;font-size:0.8rem;font-weight:600;">📊 History</button>
                        `}
                    </td>
                </tr>
            `;
        });
    }
    
    // Global functions for fee management
    window.showPaymentHistory = function(studentId) {
        const student = students.find(s => s.id === studentId);
        const paymentRecords = JSON.parse(localStorage.getItem('paymentRecords') || '[]');
        const studentPayments = paymentRecords.filter(p => p.studentId === studentId);
        
        let historyHtml = `
            <div style="max-width:600px;max-height:70vh;overflow-y:auto;">
                <h3 style="margin:0 0 15px 0;color:#333;">💳 Payment History - ${student ? student.name : studentId}</h3>
                ${studentPayments.length === 0 ? 
                    '<p style="color:#666;text-align:center;padding:20px;">No payment records found.</p>' :
                    `<table style="width:100%;border-collapse:collapse;">
                        <thead>
                            <tr style="background:#f8f9fa;">
                                <th style="padding:10px;border:1px solid #ddd;text-align:left;">Date</th>
                                <th style="padding:10px;border:1px solid #ddd;text-align:left;">Type</th>
                                <th style="padding:10px;border:1px solid #ddd;text-align:left;">Amount</th>
                                <th style="padding:10px;border:1px solid #ddd;text-align:left;">Method</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${studentPayments.map(p => `
                                <tr>
                                    <td style="padding:8px;border:1px solid #ddd;">${p.date}</td>
                                    <td style="padding:8px;border:1px solid #ddd;">${p.type}</td>
                                    <td style="padding:8px;border:1px solid #ddd;color:#28a745;font-weight:600;">PKR ${p.amount.toLocaleString()}</td>
                                    <td style="padding:8px;border:1px solid #ddd;">${p.method}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>`
                }
            </div>
        `;
        
        showModal(historyHtml);
    };
    
    window.editFeeAmount = function(studentId, feeType) {
        if(!isAdmin) return;
        
        const student = students.find(s => s.id === studentId);
        if(!student) return;
        
        const currentAmount = getTabData(student, feeType).amount;
        const newAmount = prompt(`Enter new ${feeType} fee amount for ${student.name}:`, currentAmount);
        
        if(newAmount !== null && !isNaN(newAmount) && newAmount >= 0) {
            switch(feeType) {
                case 'admission':
                    student.admissionFee = parseFloat(newAmount);
                    break;
                case 'security':
                    student.securityFee = parseFloat(newAmount);
                    break;
                case 'monthly':
                    student.monthlyFee = parseFloat(newAmount);
                    break;
            }
            localStorage.setItem('studentList', JSON.stringify(students));
            renderTable();
            updateSummaryCards();
        }
    };
    
    // Payment form setup
    if(isAdmin) {
        document.getElementById('add-payment-btn').onclick = () => {
            document.getElementById('payment-form-modal').style.display = 'flex';
            document.getElementById('payment-date').value = new Date().toISOString().slice(0, 10);
        };
        
        document.getElementById('cancel-payment').onclick = () => {
            document.getElementById('payment-form-modal').style.display = 'none';
        };
        
        document.getElementById('payment-form').onsubmit = (e) => {
            e.preventDefault();
            
            const studentId = document.getElementById('payment-student').value;
            const type = document.getElementById('payment-type').value;
            const amount = parseFloat(document.getElementById('payment-amount').value);
            const date = document.getElementById('payment-date').value;
            const method = document.getElementById('payment-method').value;
            
            // Update student record
            const student = students.find(s => s.id === studentId);
            if(student) {
                switch(type) {
                    case 'admission':
                        student.admissionFeePaid = (student.admissionFeePaid || 0) + amount;
                        break;
                    case 'security':
                        student.securityFeePaid = (student.securityFeePaid || 0) + amount;
                        break;
                    case 'monthly':
                        student.monthlyFeePaid = (student.monthlyFeePaid || 0) + amount;
                        break;
                    case 'total':
                        student.feePaid = (student.feePaid || 0) + amount;
                        break;
                }
                
                // Add payment record
                const paymentRecords = JSON.parse(localStorage.getItem('paymentRecords') || '[]');
                paymentRecords.push({
                    id: 'PAY' + Date.now(),
                    studentId,
                    studentName: student.name,
                    type,
                    amount,
                    date,
                    method
                });
                
                localStorage.setItem('studentList', JSON.stringify(students));
                localStorage.setItem('paymentRecords', JSON.stringify(paymentRecords));
                
                renderTable();
                updateSummaryCards();
                document.getElementById('payment-form-modal').style.display = 'none';
                document.getElementById('payment-form').reset();
                
                alert('Payment recorded successfully!');
            }
        };
    }
    
    setupTabs();
    renderTable();
    updateSummaryCards();
    
    if(isAdmin) {
        document.getElementById('fee-student-filter').addEventListener('change', () => {
            renderTable();
            updateSummaryCards();
        });
        document.getElementById('fee-period-filter').addEventListener('change', () => {
            renderTable();
            updateSummaryCards();
        });
        document.getElementById('fee-search').addEventListener('input', () => {
            renderTable();
            updateSummaryCards();
        });
    }
}

// ---------- Attendance Template Logic ----------
function setupAttendance() {
    // Guest mode: Show empty attendance with notification
    if (isGuestMode()) {
        const attendanceContent = document.getElementById('attendance-content');
        if (attendanceContent) {
            attendanceContent.innerHTML = '';
            attendanceContent.appendChild(showGuestNotification("Attendance data is not available in guest mode."));
        }
        return;
    }
    
    const area = document.getElementById('attendance-content');
    const role = localStorage.getItem('userRole') || '';
    const isAdmin = role === 'admin';
    
    // Setup tab functionality
    document.querySelectorAll('.attendance-tab').forEach(tab => {
        tab.addEventListener('click', function() {
            // Update tab styles
            document.querySelectorAll('.attendance-tab').forEach(t => {
                t.style.background = '#f8f9fa';
                t.style.color = '#333';
                t.style.boxShadow = 'none';
                t.classList.remove('active');
            });
            this.style.background = 'linear-gradient(135deg,#667eea,#764ba2)';
            this.style.color = 'white';
            this.style.boxShadow = '0 4px 15px rgba(102,126,234,0.3)';
            this.classList.add('active');
            
            // Render appropriate content
            const tabType = this.dataset.tab;
            switch(tabType) {
                case 'mark':
                    if(isAdmin) renderMarkAttendance(area);
                    break;
                case 'view':
                    renderViewAttendance(area, !isAdmin);
                    break;
                case 'report':
                    renderAttendanceReports(area, !isAdmin);
                    break;
            }
        });
    });
    
    // Hide mark attendance for non-admins
    if (!isAdmin) {
        document.getElementById('mark-attendance-btn').style.display = 'none';
        // Start with view tab for students/parents
        document.getElementById('view-attendance-btn').click();
    } else {
        // Start with mark attendance for admin
        renderMarkAttendance(area);
    }
}

function renderMarkAttendance(area) {
    const students = JSON.parse(localStorage.getItem('studentList') || '[]');
    const today = new Date().toISOString().slice(0,10);
    const existingRecords = JSON.parse(localStorage.getItem('attendanceRecords') || '[]');
    const todayRecords = existingRecords.filter(r => r.date === today);
    
    let html = `
    <div style="background:linear-gradient(135deg,#ffecd2 0%,#fcb69f 100%);padding:20px;border-radius:15px;margin-bottom:20px;">
        <h3 style="color:#333;margin-bottom:15px;font-size:1.5rem;text-align:center;">✏️ Mark Attendance - ${today}</h3>
        
        ${todayRecords.length > 0 ? `
        <div style="background:rgba(255,193,7,0.2);padding:12px;border-radius:8px;margin-bottom:15px;border-left:4px solid #ffc107;">
            <p style="margin:0;color:#856404;font-weight:600;">⚠️ Attendance for today has already been marked for ${todayRecords.length} students. You can update it below.</p>
        </div>
        ` : ''}
        
        <form id="attendance-form">
            <div style="display:flex;gap:15px;margin-bottom:15px;align-items:center;flex-wrap:wrap;background:rgba(255,255,255,0.7);padding:12px;border-radius:10px;">
                <label style="font-weight:600;color:#333;">📋 Quick Actions:</label>
                <select id="mark-all-status" style="padding:6px 12px;border:2px solid #667eea;border-radius:6px;">
                    <option value="">--Select Action--</option>
                    <option value="present">✅ Mark All Present</option>
                    <option value="absent">❌ Mark All Absent</option>
                </select>
                <button type="button" onclick="setCurrentTime()" style="padding:6px 12px;background:linear-gradient(135deg,#17a2b8,#6f42c1);color:white;border:none;border-radius:6px;cursor:pointer;font-weight:600;">⏰ Set Current Time</button>
            </div>
            
            <div style="background:rgba(255,255,255,0.9);border-radius:12px;overflow:hidden;box-shadow:0 8px 25px rgba(0,0,0,0.1);overflow-x:auto;">
                <table style="width:100%;border-collapse:separate;border-spacing:0;font-size:0.85rem;min-width:900px;">
                    <thead>
                        <tr style="background:linear-gradient(135deg,#28a745,#20c997);color:white;">
                            <th style="padding:12px 8px;font-weight:700;text-shadow:1px 1px 2px rgba(0,0,0,0.2);">📅 Date</th>
                            <th style="padding:12px 8px;font-weight:700;text-shadow:1px 1px 2px rgba(0,0,0,0.2);">🆔 Student ID</th>
                            <th style="padding:12px 8px;font-weight:700;text-shadow:1px 1px 2px rgba(0,0,0,0.2);">👤 Name</th>
                            <th style="padding:12px 8px;font-weight:700;text-shadow:1px 1px 2px rgba(0,0,0,0.2);">🏠 Room</th>
                            <th style="padding:12px 8px;font-weight:700;text-shadow:1px 1px 2px rgba(0,0,0,0.2);">⏰ Check-In</th>
                            <th style="padding:12px 8px;font-weight:700;text-shadow:1px 1px 2px rgba(0,0,0,0.2);">⏰ Check-Out</th>
                            <th style="padding:12px 8px;font-weight:700;text-shadow:1px 1px 2px rgba(0,0,0,0.2);">✅ Status</th>
                            <th style="padding:12px 8px;font-weight:700;text-shadow:1px 1px 2px rgba(0,0,0,0.2);">📝 Reason</th>
                        </tr>
                    </thead>
                    <tbody>
    `;
    
    const rowGradients = [
        'linear-gradient(135deg, #fff5f5, #ffe0e6)',
        'linear-gradient(135deg, #f0f9ff, #e0f2fe)',
        'linear-gradient(135deg, #f0fdf4, #dcfce7)',
        'linear-gradient(135deg, #fefce8, #fef3c7)',
        'linear-gradient(135deg, #fdf4ff, #fae8ff)'
    ];
    
    students.forEach((s, index) => {
        const existingRecord = todayRecords.find(r => r.studentId === s.id);
        html += `
        <tr style="background:${rowGradients[index % rowGradients.length]};transition:all 0.3s ease;" onmouseover="this.style.background='#e3f2fd'" onmouseout="this.style.background='${rowGradients[index % rowGradients.length]}'">
            <td style="padding:10px 8px;font-weight:600;color:#333;">${today}</td>
            <td style="padding:10px 8px;font-weight:600;color:#667eea;">${s.id}</td>
            <td style="padding:10px 8px;font-weight:600;color:#333;">${s.name}</td>
            <td style="padding:10px 8px;color:#666;">${s.roomNo || '-'}</td>
            <td style="padding:10px 8px;">
                <input type="time" class="check-in-time" data-id="${s.id}" value="${existingRecord ? existingRecord.checkIn : ''}" style="width:100px;padding:4px;border:2px solid #28a745;border-radius:4px;">
            </td>
            <td style="padding:10px 8px;">
                <input type="time" class="check-out-time" data-id="${s.id}" value="${existingRecord ? existingRecord.checkOut : ''}" style="width:100px;padding:4px;border:2px solid #fd7e14;border-radius:4px;">
            </td>
            <td style="padding:10px 8px;">
                <select class="present-absent" data-id="${s.id}" style="width:100px;padding:4px;border:2px solid #667eea;border-radius:4px;">
                    <option value="present" ${existingRecord && existingRecord.status === 'present' ? 'selected' : ''}>✅ Present</option>
                    <option value="absent" ${existingRecord && existingRecord.status === 'absent' ? 'selected' : ''}>❌ Absent</option>
                </select>
            </td>
            <td style="padding:10px 8px;">
                <input type="text" class="absence-reason" data-id="${s.id}" value="${existingRecord ? existingRecord.absenceReason || '' : ''}" style="width:120px;padding:4px;border:2px solid #dc3545;border-radius:4px;" placeholder="If absent...">
            </td>
        </tr>
        `;
    });
    
    html += `
                    </tbody>
                </table>
            </div>
            
            <div style="text-align:center;margin-top:20px;">
                <button type="submit" style="padding:12px 30px;background:linear-gradient(135deg,#28a745,#20c997);color:white;border:none;border-radius:10px;font-size:1.1rem;font-weight:700;cursor:pointer;box-shadow:0 6px 20px rgba(40,167,69,0.3);transition:all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 8px 25px rgba(40,167,69,0.4)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 6px 20px rgba(40,167,69,0.3)'">💾 Save Attendance</button>
            </div>
        </form>
        
        <div id="attendance-save-msg" style="margin-top:15px;text-align:center;font-weight:600;"></div>
    </div>
    `;
    
    area.innerHTML = html;

    // Attendance state
    const attendance = {};
    students.forEach(s => {
        const existing = todayRecords.find(r => r.studentId === s.id);
        attendance[s.id] = {
            checkIn: existing ? existing.checkIn : "",
            checkOut: existing ? existing.checkOut : "",
            status: existing ? existing.status : "present",
            reason: existing ? existing.absenceReason || "" : ""
        };
    });

    // Event handlers
    area.querySelectorAll('.check-in-time').forEach(input => {
        input.onchange = function() {
            attendance[input.dataset.id].checkIn = input.value;
        };
    });
    area.querySelectorAll('.check-out-time').forEach(input => {
        input.onchange = function() {
            attendance[input.dataset.id].checkOut = input.value;
        };
    });
    area.querySelectorAll('.present-absent').forEach(select => {
        select.onchange = function() {
            attendance[select.dataset.id].status = select.value;
        };
    });
    area.querySelectorAll('.absence-reason').forEach(input => {
        input.oninput = function() {
            attendance[input.dataset.id].reason = input.value;
        };
    });

    // Mark all dropdown handler
    document.getElementById('mark-all-status').onchange = function() {
        const val = this.value;
        if (val) {
            area.querySelectorAll('.present-absent').forEach(select => {
                select.value = val;
                attendance[select.dataset.id].status = val;
            });
        }
    };
    
    // Set current time function
    window.setCurrentTime = function() {
        const now = new Date();
        const currentTime = now.toTimeString().slice(0, 5);
        area.querySelectorAll('.check-in-time').forEach(input => {
            if (!input.value) input.value = currentTime;
        });
    };

    // Save handler
    document.getElementById('attendance-form').onsubmit = function(e) {
        e.preventDefault();
        let records = JSON.parse(localStorage.getItem('attendanceRecords') || '[]');
        
        // Remove existing records for today
        records = records.filter(r => r.date !== today);
        
        // Add new records
        students.forEach(s => {
            records.push({
                date: today,
                studentId: s.id,
                name: s.name,
                roomNo: s.roomNo || '',
                checkIn: attendance[s.id].checkIn,
                checkOut: attendance[s.id].checkOut,
                status: attendance[s.id].status,
                absenceReason: attendance[s.id].reason
            });
        });
        
        localStorage.setItem('attendanceRecords', JSON.stringify(records));
        document.getElementById('attendance-save-msg').innerHTML = '<div style="color:#28a745;font-size:1.1rem;">✅ Attendance saved successfully!</div>';
        
        setTimeout(() => {
            document.getElementById('attendance-save-msg').innerHTML = '';
        }, 3000);
    };
}

// New function for attendance reports
function renderAttendanceReports(area, isSelfView = false) {
    const records = JSON.parse(localStorage.getItem('attendanceRecords') || '[]');
    const students = JSON.parse(localStorage.getItem('studentList') || '[]');
    const role = localStorage.getItem('userRole') || '';
    const isAdmin = role === 'admin';
    const currentStudentId = localStorage.getItem('studentId');
    
    let html = `
    <div style="background:linear-gradient(135deg,#d299c2 0%,#fef9d7 100%);padding:20px;border-radius:15px;margin-bottom:20px;">
        <h3 style="color:#333;margin-bottom:15px;font-size:1.5rem;text-align:center;">📊 Attendance Reports & Analytics</h3>
        
        <div style="display:flex;gap:10px;margin-bottom:20px;align-items:center;flex-wrap:wrap;background:rgba(255,255,255,0.7);padding:12px;border-radius:10px;">
            <label style="font-weight:600;color:#333;">📅 Report Type:</label>
            <select id="report-type" style="padding:6px 12px;border:2px solid #667eea;border-radius:6px;">
                <option value="monthly">📅 Monthly Report</option>
                <option value="yearly">📆 Yearly Report</option>
                <option value="custom">🎯 Custom Range</option>
            </select>
            
            ${isAdmin ? `
            <label style="font-weight:600;color:#333;">👤 Student:</label>
            <select id="report-student" style="padding:6px 12px;border:2px solid #f093fb;border-radius:6px;">
                <option value="all">All Students</option>
                ${students.map(s => `<option value="${s.id}">${s.name} (${s.id})</option>`).join('')}
            </select>
            ` : ''}
            
            <div id="date-range-inputs" style="display:none;gap:10px;align-items:center;">
                <input type="date" id="start-date" style="padding:6px 10px;border:2px solid #28a745;border-radius:6px;">
                <span style="color:#333;font-weight:600;">to</span>
                <input type="date" id="end-date" style="padding:6px 10px;border:2px solid #28a745;border-radius:6px;">
            </div>
            
            <button onclick="generateAttendanceReport()" style="padding:8px 15px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;border-radius:6px;cursor:pointer;font-weight:600;">📊 Generate Report</button>
            <button onclick="exportAttendanceReport()" style="padding:8px 15px;background:linear-gradient(135deg,#28a745,#20c997);color:white;border:none;border-radius:6px;cursor:pointer;font-weight:600;">📥 Export CSV</button>
        </div>
        
        <div id="attendance-report-content">
            <!-- Report content will be generated here -->
        </div>
    </div>
    `;
    
    area.innerHTML = html;
    
    // Setup event listeners
    document.getElementById('report-type').onchange = function() {
        const dateRangeInputs = document.getElementById('date-range-inputs');
        if (this.value === 'custom') {
            dateRangeInputs.style.display = 'flex';
        } else {
            dateRangeInputs.style.display = 'none';
        }
    };
    
    // Generate initial report
    generateAttendanceReport();
    
    // Global functions for report generation
    window.generateAttendanceReport = function() {
        const reportType = document.getElementById('report-type').value;
        const studentFilter = isAdmin ? document.getElementById('report-student').value : currentStudentId;
        const startDate = document.getElementById('start-date') ? document.getElementById('start-date').value : null;
        const endDate = document.getElementById('end-date') ? document.getElementById('end-date').value : null;
        
        let filteredRecords = records;
        
        // Filter by student
        if (studentFilter && studentFilter !== 'all') {
            filteredRecords = filteredRecords.filter(r => r.studentId === studentFilter);
        } else if (!isAdmin) {
            filteredRecords = filteredRecords.filter(r => r.studentId === currentStudentId);
        }
        
        // Filter by date range
        const now = new Date();
        if (reportType === 'monthly') {
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            filteredRecords = filteredRecords.filter(r => {
                const recordDate = new Date(r.date);
                return recordDate.getMonth() === currentMonth && recordDate.getFullYear() === currentYear;
            });
        } else if (reportType === 'yearly') {
            const currentYear = now.getFullYear();
            filteredRecords = filteredRecords.filter(r => {
                const recordDate = new Date(r.date);
                return recordDate.getFullYear() === currentYear;
            });
        } else if (reportType === 'custom' && startDate && endDate) {
            filteredRecords = filteredRecords.filter(r => {
                return r.date >= startDate && r.date <= endDate;
            });
        }
        
        displayAttendanceReport(filteredRecords, reportType, isAdmin);
    };
    
    window.exportAttendanceReport = function() {
        const reportContent = document.getElementById('attendance-report-content');
        const table = reportContent.querySelector('table');
        if (!table) {
            alert('No report data to export');
            return;
        }
        
        let csv = '';
        const rows = table.querySelectorAll('tr');
        rows.forEach(row => {
            const cols = row.querySelectorAll('th, td');
            const rowData = Array.from(cols).map(col => col.textContent.trim()).join(',');
            csv += rowData + '\n';
        });
        
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `attendance_report_${new Date().toISOString().slice(0,10)}.csv`;
        a.click();
        window.URL.revokeObjectURL(url);
    };
}

function displayAttendanceReport(records, reportType, isAdmin) {
    const reportContent = document.getElementById('attendance-report-content');
    
    if (!records.length) {
        reportContent.innerHTML = '<div style="text-align:center;padding:40px;color:#666;font-size:1.2rem;">📋 No attendance records found for the selected criteria</div>';
        return;
    }
    
    // Calculate statistics
    const totalRecords = records.length;
    const presentCount = records.filter(r => r.status === 'present').length;
    const absentCount = records.filter(r => r.status === 'absent').length;
    const attendanceRate = ((presentCount / totalRecords) * 100).toFixed(1);
    
    // Group by student for summary
    const studentStats = {};
    records.forEach(r => {
        if (!studentStats[r.studentId]) {
            studentStats[r.studentId] = {
                name: r.name,
                total: 0,
                present: 0,
                absent: 0
            };
        }
        studentStats[r.studentId].total++;
        if (r.status === 'present') {
            studentStats[r.studentId].present++;
        } else {
            studentStats[r.studentId].absent++;
        }
    });
    
    let html = `
    <!-- Summary Cards -->
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:25px;">
        <div style="background:linear-gradient(135deg,#28a745,#20c997);padding:20px;border-radius:12px;color:white;text-align:center;box-shadow:0 8px 25px rgba(40,167,69,0.3);">
            <div style="font-size:2rem;font-weight:700;">${totalRecords}</div>
            <div style="opacity:0.9;font-size:1rem;">📊 Total Records</div>
        </div>
        <div style="background:linear-gradient(135deg,#17a2b8,#6f42c1);padding:20px;border-radius:12px;color:white;text-align:center;box-shadow:0 8px 25px rgba(23,162,184,0.3);">
            <div style="font-size:2rem;font-weight:700;">${presentCount}</div>
            <div style="opacity:0.9;font-size:1rem;">✅ Present Days</div>
        </div>
        <div style="background:linear-gradient(135deg,#dc3545,#fd7e14);padding:20px;border-radius:12px;color:white;text-align:center;box-shadow:0 8px 25px rgba(220,53,69,0.3);">
            <div style="font-size:2rem;font-weight:700;">${absentCount}</div>
            <div style="opacity:0.9;font-size:1rem;">❌ Absent Days</div>
        </div>
        <div style="background:linear-gradient(135deg,#ffc107,#fd7e14);padding:20px;border-radius:12px;color:white;text-align:center;box-shadow:0 8px 25px rgba(255,193,7,0.3);">
            <div style="font-size:2rem;font-weight:700;">${attendanceRate}%</div>
            <div style="opacity:0.9;font-size:1rem;">📈 Attendance Rate</div>
        </div>
    </div>
    
    <!-- Student-wise Summary -->
    <div style="background:rgba(255,255,255,0.9);border-radius:12px;overflow:hidden;box-shadow:0 8px 25px rgba(0,0,0,0.1);margin-bottom:20px;">
        <div style="background:linear-gradient(135deg,#667eea,#764ba2);color:white;padding:15px;text-align:center;">
            <h4 style="margin:0;font-size:1.3rem;">👥 Student-wise Attendance Summary</h4>
        </div>
        <div style="overflow-x:auto;">
            <table style="width:100%;border-collapse:separate;border-spacing:0;font-size:0.9rem;">
                <thead>
                    <tr style="background:#f8f9fa;">
                        ${isAdmin ? '<th style="padding:12px 8px;font-weight:700;border-bottom:2px solid #dee2e6;">🆔 Student ID</th>' : ''}
                        <th style="padding:12px 8px;font-weight:700;border-bottom:2px solid #dee2e6;">👤 Name</th>
                        <th style="padding:12px 8px;font-weight:700;border-bottom:2px solid #dee2e6;">📊 Total Days</th>
                        <th style="padding:12px 8px;font-weight:700;border-bottom:2px solid #dee2e6;">✅ Present</th>
                        <th style="padding:12px 8px;font-weight:700;border-bottom:2px solid #dee2e6;">❌ Absent</th>
                        <th style="padding:12px 8px;font-weight:700;border-bottom:2px solid #dee2e6;">📈 Rate</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    Object.keys(studentStats).forEach((studentId, index) => {
        const stats = studentStats[studentId];
        const rate = ((stats.present / stats.total) * 100).toFixed(1);
        const rateColor = rate >= 80 ? '#28a745' : rate >= 60 ? '#ffc107' : '#dc3545';
        
        html += `
        <tr style="background:${index % 2 === 0 ? '#fff' : '#f8f9fa'};transition:all 0.3s ease;" onmouseover="this.style.background='#e3f2fd'" onmouseout="this.style.background='${index % 2 === 0 ? '#fff' : '#f8f9fa'}'">
            ${isAdmin ? `<td style="padding:10px 8px;font-weight:600;color:#667eea;">${studentId}</td>` : ''}
            <td style="padding:10px 8px;font-weight:600;color:#333;">${stats.name}</td>
            <td style="padding:10px 8px;text-align:center;color:#666;">${stats.total}</td>
            <td style="padding:10px 8px;text-align:center;color:#28a745;font-weight:600;">${stats.present}</td>
            <td style="padding:10px 8px;text-align:center;color:#dc3545;font-weight:600;">${stats.absent}</td>
            <td style="padding:10px 8px;text-align:center;"><span style="background:${rateColor};color:white;padding:4px 8px;border-radius:12px;font-weight:600;font-size:0.8rem;">${rate}%</span></td>
        </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Detailed Records -->
    <div style="background:rgba(255,255,255,0.9);border-radius:12px;overflow:hidden;box-shadow:0 8px 25px rgba(0,0,0,0.1);">
        <div style="background:linear-gradient(135deg,#28a745,#20c997);color:white;padding:15px;text-align:center;">
            <h4 style="margin:0;font-size:1.3rem;">📋 Detailed Attendance Records</h4>
        </div>
        <div style="overflow-x:auto;">
            <table style="width:100%;border-collapse:separate;border-spacing:0;font-size:0.85rem;">
                <thead>
                    <tr style="background:#f8f9fa;">
                        <th style="padding:10px 8px;font-weight:700;border-bottom:2px solid #dee2e6;">📅 Date</th>
                        ${isAdmin ? '<th style="padding:10px 8px;font-weight:700;border-bottom:2px solid #dee2e6;">🆔 Student ID</th>' : ''}
                        <th style="padding:10px 8px;font-weight:700;border-bottom:2px solid #dee2e6;">👤 Name</th>
                        <th style="padding:10px 8px;font-weight:700;border-bottom:2px solid #dee2e6;">🏠 Room</th>
                        <th style="padding:10px 8px;font-weight:700;border-bottom:2px solid #dee2e6;">⏰ Check-In</th>
                        <th style="padding:10px 8px;font-weight:700;border-bottom:2px solid #dee2e6;">⏰ Check-Out</th>
                        <th style="padding:10px 8px;font-weight:700;border-bottom:2px solid #dee2e6;">✅ Status</th>
                        <th style="padding:10px 8px;font-weight:700;border-bottom:2px solid #dee2e6;">📝 Reason</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    const rowGradients = [
        'linear-gradient(135deg, #fff5f5, #ffe0e6)',
        'linear-gradient(135deg, #f0f9ff, #e0f2fe)',
        'linear-gradient(135deg, #f0fdf4, #dcfce7)',
        'linear-gradient(135deg, #fefce8, #fef3c7)',
        'linear-gradient(135deg, #fdf4ff, #fae8ff)'
    ];
    
    records.slice().reverse().forEach((r, index) => {
        const statusColor = r.status === 'present' ? '#28a745' : '#dc3545';
        const statusIcon = r.status === 'present' ? '✅' : '❌';
        
        html += `
        <tr style="background:${index % 2 === 0 ? '#fff' : '#f8f9fa'};transition:all 0.3s ease;" onmouseover="this.style.background='#e3f2fd'" onmouseout="this.style.background='${index % 2 === 0 ? '#fff' : '#f8f9fa'}'">
            <td style="padding:8px;font-weight:600;color:#333;">${r.date}</td>
            ${isAdmin ? `<td style="padding:8px;font-weight:600;color:#667eea;">${r.studentId}</td>` : ''}
            <td style="padding:8px;font-weight:600;color:#333;">${r.name}</td>
            <td style="padding:8px;color:#666;">${r.roomNo || '-'}</td>
            <td style="padding:8px;color:#28a745;font-weight:600;">${r.checkIn || '-'}</td>
            <td style="padding:8px;color:#fd7e14;font-weight:600;">${r.checkOut || '-'}</td>
            <td style="padding:8px;"><span style="background:${statusColor};color:white;padding:3px 6px;border-radius:10px;font-weight:600;font-size:0.75rem;">${statusIcon} ${r.status === 'present' ? 'Present' : 'Absent'}</span></td>
            <td style="padding:8px;color:#666;font-style:italic;">${r.absenceReason || '-'}</td>
        </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
        </div>
    </div>
    `;
    
    reportContent.innerHTML = html;
}

function renderViewAttendance(area, isSelfView = false) {
    const records = JSON.parse(localStorage.getItem('attendanceRecords') || '[]');
    const students = JSON.parse(localStorage.getItem('studentList') || '[]');
    let filteredRecords = records;
    const role = localStorage.getItem('userRole') || '';
    const isAdmin = role === 'admin';
    
    // Only show own attendance for student/parent
    if (isSelfView && (role === 'student' || role === 'parent')) {
        const studentId = localStorage.getItem('studentId');
        filteredRecords = records.filter(r => r.studentId === studentId);
    }
    
    let html = `
    <div style="background:linear-gradient(135deg,#a8edea 0%,#fed6e3 100%);padding:20px;border-radius:15px;margin-bottom:20px;">
        <h3 style="color:#333;margin-bottom:15px;font-size:1.5rem;text-align:center;">📊 View Attendance Records</h3>
        
        ${isAdmin ? `
        <div style="display:flex;gap:10px;margin-bottom:15px;align-items:center;flex-wrap:wrap;background:rgba(255,255,255,0.7);padding:12px;border-radius:10px;">
            <label style="font-weight:600;color:#333;">📅 Filter by Date:</label>
            <input type="date" id="attendance-date-filter" style="padding:6px 10px;border:2px solid #667eea;border-radius:6px;">
            <label style="font-weight:600;color:#333;">👤 Student:</label>
            <select id="attendance-student-filter" style="padding:6px 10px;border:2px solid #f093fb;border-radius:6px;">
                <option value="all">All Students</option>
                ${students.map(s => `<option value="${s.id}">${s.name} (${s.id})</option>`).join('')}
            </select>
            <label style="font-weight:600;color:#333;">📊 Status:</label>
            <select id="attendance-status-filter" style="padding:6px 10px;border:2px solid #28a745;border-radius:6px;">
                <option value="all">All Status</option>
                <option value="present">Present</option>
                <option value="absent">Absent</option>
            </select>
            <button onclick="filterAttendanceRecords()" style="padding:8px 15px;background:linear-gradient(135deg,#28a745,#20c997);color:white;border:none;border-radius:6px;cursor:pointer;font-weight:600;">🔍 Filter</button>
        </div>
        ` : ''}
        
        <div style="background:rgba(255,255,255,0.9);border-radius:12px;overflow:hidden;box-shadow:0 8px 25px rgba(0,0,0,0.1);overflow-x:auto;">
            <table style="width:100%;border-collapse:separate;border-spacing:0;font-size:0.85rem;min-width:800px;">
                <thead>
                    <tr style="background:linear-gradient(135deg,#667eea,#764ba2);color:white;">
                        <th style="padding:12px 8px;font-weight:700;text-shadow:1px 1px 2px rgba(0,0,0,0.2);">📅 Date</th>
                        ${isAdmin ? '<th style="padding:12px 8px;font-weight:700;text-shadow:1px 1px 2px rgba(0,0,0,0.2);">🆔 Student ID</th>' : ''}
                        <th style="padding:12px 8px;font-weight:700;text-shadow:1px 1px 2px rgba(0,0,0,0.2);">👤 Name</th>
                        <th style="padding:12px 8px;font-weight:700;text-shadow:1px 1px 2px rgba(0,0,0,0.2);">🏠 Room</th>
                        <th style="padding:12px 8px;font-weight:700;text-shadow:1px 1px 2px rgba(0,0,0,0.2);">⏰ Check-In</th>
                        <th style="padding:12px 8px;font-weight:700;text-shadow:1px 1px 2px rgba(0,0,0,0.2);">⏰ Check-Out</th>
                        <th style="padding:12px 8px;font-weight:700;text-shadow:1px 1px 2px rgba(0,0,0,0.2);">✅ Status</th>
                        <th style="padding:12px 8px;font-weight:700;text-shadow:1px 1px 2px rgba(0,0,0,0.2);">📝 Reason</th>
                    </tr>
                </thead>
                <tbody id="attendance-records-tbody">
    `;
    
    if (!filteredRecords.length) {
        html += `<tr><td colspan="${isAdmin ? '8' : '7'}" style="padding:20px;text-align:center;color:#666;font-style:italic;">📋 No attendance records found</td></tr>`;
    } else {
        const rowGradients = [
            'linear-gradient(135deg, #fff5f5, #ffe0e6)',
            'linear-gradient(135deg, #f0f9ff, #e0f2fe)',
            'linear-gradient(135deg, #f0fdf4, #dcfce7)',
            'linear-gradient(135deg, #fefce8, #fef3c7)',
            'linear-gradient(135deg, #fdf4ff, #fae8ff)'
        ];
        
        filteredRecords.slice(-50).reverse().forEach((r, index) => {
            const statusColor = r.status === 'present' ? '#28a745' : '#dc3545';
            const statusIcon = r.status === 'present' ? '✅' : '❌';
            
            html += `
            <tr style="background:${rowGradients[index % rowGradients.length]};transition:all 0.3s ease;" onmouseover="this.style.background='#e3f2fd';this.style.transform='scale(1.01)'" onmouseout="this.style.background='${rowGradients[index % rowGradients.length]}';this.style.transform='scale(1)'">
                <td style="padding:10px 8px;font-weight:600;color:#333;">${r.date}</td>
                ${isAdmin ? `<td style="padding:10px 8px;font-weight:600;color:#667eea;">${r.studentId}</td>` : ''}
                <td style="padding:10px 8px;font-weight:600;color:#333;">${r.name}</td>
                <td style="padding:10px 8px;color:#666;">${r.roomNo || '-'}</td>
                <td style="padding:10px 8px;color:#28a745;font-weight:600;">${r.checkIn || '-'}</td>
                <td style="padding:10px 8px;color:#fd7e14;font-weight:600;">${r.checkOut || '-'}</td>
                <td style="padding:10px 8px;"><span style="background:${statusColor};color:white;padding:4px 8px;border-radius:12px;font-weight:600;font-size:0.8rem;">${statusIcon} ${r.status === 'present' ? 'Present' : 'Absent'}</span></td>
                <td style="padding:10px 8px;color:#666;font-style:italic;">${r.absenceReason || '-'}</td>
            </tr>
            `;
        });
    }
    
    html += `
                </tbody>
            </table>
        </div>
    </div>
    `;
    
    area.innerHTML = html;
    
    // Add filter functionality for admin
    if (isAdmin) {
        window.filterAttendanceRecords = function() {
            const dateFilter = document.getElementById('attendance-date-filter').value;
            const studentFilter = document.getElementById('attendance-student-filter').value;
            const statusFilter = document.getElementById('attendance-status-filter').value;
            
            let filtered = records;
            
            if (dateFilter) {
                filtered = filtered.filter(r => r.date === dateFilter);
            }
            if (studentFilter !== 'all') {
                filtered = filtered.filter(r => r.studentId === studentFilter);
            }
            if (statusFilter !== 'all') {
                filtered = filtered.filter(r => r.status === statusFilter);
            }
            
            updateAttendanceTable(filtered, isAdmin);
        };
    }
}

function updateAttendanceTable(records, isAdmin) {
    const tbody = document.getElementById('attendance-records-tbody');
    tbody.innerHTML = '';
    
    if (!records.length) {
        tbody.innerHTML = `<tr><td colspan="${isAdmin ? '8' : '7'}" style="padding:20px;text-align:center;color:#666;font-style:italic;">📋 No records match the filter criteria</td></tr>`;
        return;
    }
    
    const rowGradients = [
        'linear-gradient(135deg, #fff5f5, #ffe0e6)',
        'linear-gradient(135deg, #f0f9ff, #e0f2fe)',
        'linear-gradient(135deg, #f0fdf4, #dcfce7)',
        'linear-gradient(135deg, #fefce8, #fef3c7)',
        'linear-gradient(135deg, #fdf4ff, #fae8ff)'
    ];
    
    records.slice(-50).reverse().forEach((r, index) => {
        const statusColor = r.status === 'present' ? '#28a745' : '#dc3545';
        const statusIcon = r.status === 'present' ? '✅' : '❌';
        
        tbody.innerHTML += `
        <tr style="background:${rowGradients[index % rowGradients.length]};transition:all 0.3s ease;" onmouseover="this.style.background='#e3f2fd';this.style.transform='scale(1.01)'" onmouseout="this.style.background='${rowGradients[index % rowGradients.length]}';this.style.transform='scale(1)'">
            <td style="padding:10px 8px;font-weight:600;color:#333;">${r.date}</td>
            ${isAdmin ? `<td style="padding:10px 8px;font-weight:600;color:#667eea;">${r.studentId}</td>` : ''}
            <td style="padding:10px 8px;font-weight:600;color:#333;">${r.name}</td>
            <td style="padding:10px 8px;color:#666;">${r.roomNo || '-'}</td>
            <td style="padding:10px 8px;color:#28a745;font-weight:600;">${r.checkIn || '-'}</td>
            <td style="padding:10px 8px;color:#fd7e14;font-weight:600;">${r.checkOut || '-'}</td>
            <td style="padding:10px 8px;"><span style="background:${statusColor};color:white;padding:4px 8px;border-radius:12px;font-weight:600;font-size:0.8rem;">${statusIcon} ${r.status === 'present' ? 'Present' : 'Absent'}</span></td>
            <td style="padding:10px 8px;color:#666;font-style:italic;">${r.absenceReason || '-'}</td>
        </tr>
        `;
    });
}

// ---------- Visitors Logbook ----------
function setupVisitorsLogbook() {
    const userRole = localStorage.getItem('userRole');
    const studentId = localStorage.getItem('studentId');
    const isAdmin = userRole === 'admin';
    const content = document.getElementById('visitors-content');
    
    // Setup tab functionality
    document.querySelectorAll('.visitor-tab').forEach(tab => {
        tab.addEventListener('click', function() {
            // Update tab styles
            document.querySelectorAll('.visitor-tab').forEach(t => {
                t.style.background = '#f8f9fa';
                t.style.color = '#333';
                t.style.boxShadow = 'none';
                t.classList.remove('active');
            });
            this.style.background = 'linear-gradient(135deg,#667eea,#764ba2)';
            this.style.color = 'white';
            this.style.boxShadow = '0 4px 15px rgba(102,126,234,0.3)';
            this.classList.add('active');
            
            // Render appropriate content
            const tabType = this.dataset.tab;
            switch(tabType) {
                case 'view':
                    renderViewVisitors(content, !isAdmin);
                    break;
                case 'add':
                    if(isAdmin) renderAddVisitor(content);
                    break;
                case 'report':
                    renderVisitorReports(content, !isAdmin);
                    break;
            }
        });
    });
    
    // Hide add visitor tab for non-admins
    if (!isAdmin) {
        document.getElementById('add-visitor-tab-btn').style.display = 'none';
    }
    
    // Start with view tab
    renderViewVisitors(content, !isAdmin);
}

function renderViewVisitors(area, isSelfView = false) {
    const role = localStorage.getItem('userRole') || '';
    const isAdmin = role === 'admin';
    const currentStudentId = localStorage.getItem('studentId');
    
    // PRIVACY: Apply visitor data filtering
    const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
    let filteredVisitors = getFilteredVisitorData(role, currentUser);
    
    // For guest users, show message about privacy
    if (role === 'guest') {
        area.innerHTML = `
            <div style="text-align:center;padding:40px;background:linear-gradient(135deg,#e3f2fd,#f3e5f5);border-radius:15px;">
                <h3 style="color:#333;margin-bottom:20px;">👥 Visitor Records</h3>
                <div style="background:linear-gradient(135deg,#ffd54f,#ffb74d);color:#333;padding:20px;border-radius:10px;margin-bottom:20px;">
                    <i class="fas fa-shield-alt" style="font-size:2rem;margin-bottom:10px;"></i>
                    <p style="margin:0;font-weight:600;">🔒 Privacy Protected</p>
                    <p style="margin:5px 0;font-size:0.9rem;">Visitor records are private and only accessible to students and their parents.</p>
                </div>
                <p style="color:#666;font-style:italic;">To view visitor records, please log in as a student or parent.</p>
            </div>
        `;
        return;
    }
    
    let html = `
    <div style="background:linear-gradient(135deg,#a8edea 0%,#fed6e3 100%);padding:20px;border-radius:15px;margin-bottom:20px;">
        <h3 style="color:#333;margin-bottom:15px;font-size:1.5rem;text-align:center;">👥 View Visitor Records</h3>
        
        ${isAdmin ? `
        <div style="display:flex;gap:10px;margin-bottom:15px;align-items:center;flex-wrap:wrap;background:rgba(255,255,255,0.7);padding:12px;border-radius:10px;">
            <label style="font-weight:600;color:#333;">📅 Filter by Date:</label>
            <input type="date" id="visitor-date-filter" style="padding:6px 10px;border:2px solid #667eea;border-radius:6px;">
            <label style="font-weight:600;color:#333;">👤 Student:</label>
            <select id="visitor-student-filter" style="padding:6px 10px;border:2px solid #f093fb;border-radius:6px;">
                <option value="all">All Students</option>
                ${students.map(s => `<option value="${s.id}">${s.name} (${s.id})</option>`).join('')}
            </select>
            <input type="text" id="visitor-search" style="padding:6px 10px;border:2px solid #28a745;border-radius:6px;" placeholder="🔍 Search by name, purpose...">
            <button onclick="filterVisitorRecords()" style="padding:8px 15px;background:linear-gradient(135deg,#28a745,#20c997);color:white;border:none;border-radius:6px;cursor:pointer;font-weight:600;">🔍 Filter</button>
        </div>
        ` : ''}
        
        ${!isAdmin ? `
        <div style="margin-bottom:15px;padding:12px;background:rgba(255,193,7,0.2);border-left:4px solid #ffc107;border-radius:8px;">
            <p style="margin:0;color:#856404;font-weight:600;">📋 You can view your visitor records here. Contact the admin to add new visitor entries.</p>
        </div>
        ` : ''}
        
        <div style="background:rgba(255,255,255,0.9);border-radius:12px;overflow:hidden;box-shadow:0 8px 25px rgba(0,0,0,0.1);overflow-x:auto;">
            <table style="width:100%;border-collapse:separate;border-spacing:0;font-size:0.85rem;min-width:900px;">
                <thead>
                    <tr style="background:linear-gradient(135deg,#667eea,#764ba2);color:white;">
                        <th style="padding:12px 8px;font-weight:700;text-shadow:1px 1px 2px rgba(0,0,0,0.2);">🆔 Visitor ID</th>
                        ${isAdmin ? '<th style="padding:12px 8px;font-weight:700;text-shadow:1px 1px 2px rgba(0,0,0,0.2);">🎓 Student ID</th>' : ''}
                        <th style="padding:12px 8px;font-weight:700;text-shadow:1px 1px 2px rgba(0,0,0,0.2);">👤 Name</th>
                        <th style="padding:12px 8px;font-weight:700;text-shadow:1px 1px 2px rgba(0,0,0,0.2);">📱 Contact</th>
                        <th style="padding:12px 8px;font-weight:700;text-shadow:1px 1px 2px rgba(0,0,0,0.2);">🎯 Purpose</th>
                        <th style="padding:12px 8px;font-weight:700;text-shadow:1px 1px 2px rgba(0,0,0,0.2);">📅 Visit Date</th>
                        <th style="padding:12px 8px;font-weight:700;text-shadow:1px 1px 2px rgba(0,0,0,0.2);">⏰ Check-In</th>
                        <th style="padding:12px 8px;font-weight:700;text-shadow:1px 1px 2px rgba(0,0,0,0.2);">⏰ Check-Out</th>
                        <th style="padding:12px 8px;font-weight:700;text-shadow:1px 1px 2px rgba(0,0,0,0.2);">👨‍👩‍👧‍👦 Relation</th>
                    </tr>
                </thead>
                <tbody id="visitors-records-tbody">
    `;
    
    if (!filteredVisitors.length) {
        html += `<tr><td colspan="${isAdmin ? '9' : '8'}" style="padding:20px;text-align:center;color:#666;font-style:italic;">📋 No visitor records found</td></tr>`;
    } else {
        const rowGradients = [
            'linear-gradient(135deg, #fff5f5, #ffe0e6)',
            'linear-gradient(135deg, #f0f9ff, #e0f2fe)',
            'linear-gradient(135deg, #f0fdf4, #dcfce7)',
            'linear-gradient(135deg, #fefce8, #fef3c7)',
            'linear-gradient(135deg, #fdf4ff, #fae8ff)'
        ];
        
        filteredVisitors.slice().reverse().forEach((v, index) => {
            html += `
            <tr style="background:${rowGradients[index % rowGradients.length]};transition:all 0.3s ease;" onmouseover="this.style.background='#e3f2fd';this.style.transform='scale(1.01)'" onmouseout="this.style.background='${rowGradients[index % rowGradients.length]}';this.style.transform='scale(1)'">
                <td style="padding:10px 8px;font-weight:600;color:#667eea;">${v.id}</td>
                ${isAdmin ? `<td style="padding:10px 8px;font-weight:600;color:#f093fb;">${v.studentId}</td>` : ''}
                <td style="padding:10px 8px;font-weight:600;color:#333;">${v.name}</td>
                <td style="padding:10px 8px;color:#28a745;font-weight:500;">${v.contact}</td>
                <td style="padding:10px 8px;color:#666;">${v.purpose}</td>
                <td style="padding:10px 8px;color:#333;font-weight:600;">${v.date}</td>
                <td style="padding:10px 8px;color:#28a745;font-weight:600;">${v.checkIn || '-'}</td>
                <td style="padding:10px 8px;color:#fd7e14;font-weight:600;">${v.checkOut || '-'}</td>
                <td style="padding:10px 8px;color:#666;font-style:italic;">${v.relation}</td>
            </tr>
            `;
        });
    }
    
    html += `
                </tbody>
            </table>
        </div>
    </div>
    `;
    
    area.innerHTML = html;
    
    // Add filter functionality for admin
    if (isAdmin) {
        window.filterVisitorRecords = function() {
            const dateFilter = document.getElementById('visitor-date-filter').value;
            const studentFilter = document.getElementById('visitor-student-filter').value;
            const searchFilter = document.getElementById('visitor-search').value.toLowerCase();
            
            let filtered = visitorList;
            
            if (dateFilter) {
                filtered = filtered.filter(v => v.date === dateFilter);
            }
            if (studentFilter !== 'all') {
                filtered = filtered.filter(v => v.studentId === studentFilter);
            }
            if (searchFilter) {
                filtered = filtered.filter(v => 
                    v.name.toLowerCase().includes(searchFilter) ||
                    v.purpose.toLowerCase().includes(searchFilter) ||
                    v.relation.toLowerCase().includes(searchFilter)
                );
            }
            
            updateVisitorTable(filtered, isAdmin);
        };
    }
}

function updateVisitorTable(visitors, isAdmin) {
    const tbody = document.getElementById('visitors-records-tbody');
    tbody.innerHTML = '';
    
    if (!visitors.length) {
        tbody.innerHTML = `<tr><td colspan="${isAdmin ? '9' : '8'}" style="padding:20px;text-align:center;color:#666;font-style:italic;">📋 No records match the filter criteria</td></tr>`;
        return;
    }
    
    const rowGradients = [
        'linear-gradient(135deg, #fff5f5, #ffe0e6)',
        'linear-gradient(135deg, #f0f9ff, #e0f2fe)',
        'linear-gradient(135deg, #f0fdf4, #dcfce7)',
        'linear-gradient(135deg, #fefce8, #fef3c7)',
        'linear-gradient(135deg, #fdf4ff, #fae8ff)'
    ];
    
    visitors.slice().reverse().forEach((v, index) => {
        tbody.innerHTML += `
        <tr style="background:${rowGradients[index % rowGradients.length]};transition:all 0.3s ease;" onmouseover="this.style.background='#e3f2fd';this.style.transform='scale(1.01)'" onmouseout="this.style.background='${rowGradients[index % rowGradients.length]}';this.style.transform='scale(1)'">
            <td style="padding:10px 8px;font-weight:600;color:#667eea;">${v.id}</td>
            ${isAdmin ? `<td style="padding:10px 8px;font-weight:600;color:#f093fb;">${v.studentId}</td>` : ''}
            <td style="padding:10px 8px;font-weight:600;color:#333;">${v.name}</td>
            <td style="padding:10px 8px;color:#28a745;font-weight:500;">${v.contact}</td>
            <td style="padding:10px 8px;color:#666;">${v.purpose}</td>
            <td style="padding:10px 8px;color:#333;font-weight:600;">${v.date}</td>
            <td style="padding:10px 8px;color:#28a745;font-weight:600;">${v.checkIn || '-'}</td>
            <td style="padding:10px 8px;color:#fd7e14;font-weight:600;">${v.checkOut || '-'}</td>
            <td style="padding:10px 8px;color:#666;font-style:italic;">${v.relation}</td>
        </tr>
        `;
    });
}

function renderAddVisitor(area) {
    const students = JSON.parse(localStorage.getItem('studentList') || '[]');
    
    let html = `
    <div style="background:linear-gradient(135deg,#ffecd2 0%,#fcb69f 100%);padding:20px;border-radius:15px;margin-bottom:20px;">
        <h3 style="color:#333;margin-bottom:15px;font-size:1.5rem;text-align:center;">➕ Add New Visitor</h3>
        
        <form id="visitor-form" style="background:rgba(255,255,255,0.9);padding:20px;border-radius:12px;box-shadow:0 8px 25px rgba(0,0,0,0.1);">
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:15px;margin-bottom:20px;">
                <div>
                    <label style="display:block;margin-bottom:5px;font-weight:600;color:#333;">🎓 Student ID</label>
                    <select id="visitor-student-id" required style="width:100%;padding:10px;border:2px solid #667eea;border-radius:8px;">
                        <option value="">Select Student</option>
                        ${students.map(s => `<option value="${s.id}">${s.name} (${s.id})</option>`).join('')}
                    </select>
                </div>
                <div>
                    <label style="display:block;margin-bottom:5px;font-weight:600;color:#333;">👤 Visitor Name</label>
                    <input type="text" id="visitor-name" required style="width:100%;padding:10px;border:2px solid #f093fb;border-radius:8px;">
                </div>
                <div>
                    <label style="display:block;margin-bottom:5px;font-weight:600;color:#333;">📱 Contact Number</label>
                    <input type="tel" id="visitor-contact" required style="width:100%;padding:10px;border:2px solid #28a745;border-radius:8px;">
                </div>
                <div>
                    <label style="display:block;margin-bottom:5px;font-weight:600;color:#333;">🎯 Purpose of Visit</label>
                    <input type="text" id="visitor-purpose" required style="width:100%;padding:10px;border:2px solid #ffc107;border-radius:8px;">
                </div>
                <div>
                    <label style="display:block;margin-bottom:5px;font-weight:600;color:#333;">📅 Visit Date</label>
                    <input type="date" id="visitor-date" required style="width:100%;padding:10px;border:2px solid #dc3545;border-radius:8px;">
                </div>
                <div>
                    <label style="display:block;margin-bottom:5px;font-weight:600;color:#333;">⏰ Check-In Time</label>
                    <input type="time" id="visitor-checkin" style="width:100%;padding:10px;border:2px solid #17a2b8;border-radius:8px;">
                </div>
                <div>
                    <label style="display:block;margin-bottom:5px;font-weight:600;color:#333;">⏰ Check-Out Time</label>
                    <input type="time" id="visitor-checkout" style="width:100%;padding:10px;border:2px solid #fd7e14;border-radius:8px;">
                </div>
                <div>
                    <label style="display:block;margin-bottom:5px;font-weight:600;color:#333;">👨‍👩‍👧‍👦 Relation to Student</label>
                    <select id="visitor-relation" required style="width:100%;padding:10px;border:2px solid #6f42c1;border-radius:8px;">
                        <option value="">Select Relation</option>
                        <option value="Father">Father</option>
                        <option value="Mother">Mother</option>
                        <option value="Brother">Brother</option>
                        <option value="Sister">Sister</option>
                        <option value="Uncle">Uncle</option>
                        <option value="Aunt">Aunt</option>
                        <option value="Cousin">Cousin</option>
                        <option value="Friend">Friend</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
            </div>
            
            <div style="text-align:center;">
                <button type="submit" style="padding:12px 30px;background:linear-gradient(135deg,#28a745,#20c997);color:white;border:none;border-radius:10px;font-size:1.1rem;font-weight:700;cursor:pointer;box-shadow:0 6px 20px rgba(40,167,69,0.3);transition:all 0.3s ease;margin-right:10px;" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 8px 25px rgba(40,167,69,0.4)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 6px 20px rgba(40,167,69,0.3)'">💾 Save Visitor</button>
                <button type="button" onclick="clearVisitorForm()" style="padding:12px 30px;background:linear-gradient(135deg,#6c757d,#495057);color:white;border:none;border-radius:10px;font-size:1.1rem;font-weight:700;cursor:pointer;box-shadow:0 6px 20px rgba(108,117,125,0.3);transition:all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 8px 25px rgba(108,117,125,0.4)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 6px 20px rgba(108,117,125,0.3)'">🗑️ Clear Form</button>
            </div>
        </form>
        
        <div id="visitor-save-msg" style="margin-top:15px;text-align:center;font-weight:600;"></div>
    </div>
    `;
    
    area.innerHTML = html;
    
    // Set today's date as default
    document.getElementById('visitor-date').value = new Date().toISOString().slice(0, 10);
    
    // Form submission handler
    document.getElementById('visitor-form').onsubmit = function(e) {
        e.preventDefault();
        
        const visitorList = JSON.parse(localStorage.getItem('visitorList') || '[]');
        const newVisitor = {
            id: 'V' + String(visitorList.length + 1).padStart(3, '0'),
            studentId: document.getElementById('visitor-student-id').value,
            name: document.getElementById('visitor-name').value,
            contact: document.getElementById('visitor-contact').value,
            purpose: document.getElementById('visitor-purpose').value,
            date: document.getElementById('visitor-date').value,
            checkIn: document.getElementById('visitor-checkin').value,
            checkOut: document.getElementById('visitor-checkout').value,
            relation: document.getElementById('visitor-relation').value
        };
        
        visitorList.push(newVisitor);
        localStorage.setItem('visitorList', JSON.stringify(visitorList));
        
        document.getElementById('visitor-save-msg').innerHTML = '<div style="color:#28a745;font-size:1.1rem;">✅ Visitor record saved successfully!</div>';
        document.getElementById('visitor-form').reset();
        document.getElementById('visitor-date').value = new Date().toISOString().slice(0, 10);
        
        setTimeout(() => {
            document.getElementById('visitor-save-msg').innerHTML = '';
        }, 3000);
    };
    
    // Clear form function
    window.clearVisitorForm = function() {
        document.getElementById('visitor-form').reset();
        document.getElementById('visitor-date').value = new Date().toISOString().slice(0, 10);
    };
}

function renderVisitorReports(area, isSelfView = false) {
    const visitorList = JSON.parse(localStorage.getItem('visitorList') || '[]');
    const students = JSON.parse(localStorage.getItem('studentList') || '[]');
    const role = localStorage.getItem('userRole') || '';
    const isAdmin = role === 'admin';
    const currentStudentId = localStorage.getItem('studentId');
    
    let html = `
    <div style="background:linear-gradient(135deg,#d299c2 0%,#fef9d7 100%);padding:20px;border-radius:15px;margin-bottom:20px;">
        <h3 style="color:#333;margin-bottom:15px;font-size:1.5rem;text-align:center;">📊 Visitor Reports & Analytics</h3>
        
        <div style="display:flex;gap:10px;margin-bottom:20px;align-items:center;flex-wrap:wrap;background:rgba(255,255,255,0.7);padding:12px;border-radius:10px;">
            <label style="font-weight:600;color:#333;">📅 Report Type:</label>
            <select id="visitor-report-type" style="padding:6px 12px;border:2px solid #667eea;border-radius:6px;">
                <option value="monthly">📅 Monthly Report</option>
                <option value="yearly">📆 Yearly Report</option>
                <option value="custom">🎯 Custom Range</option>
            </select>
            
            ${isAdmin ? `
            <label style="font-weight:600;color:#333;">👤 Student:</label>
            <select id="visitor-report-student" style="padding:6px 12px;border:2px solid #f093fb;border-radius:6px;">
                <option value="all">All Students</option>
                ${students.map(s => `<option value="${s.id}">${s.name} (${s.id})</option>`).join('')}
            </select>
            ` : ''}
            
            <div id="visitor-date-range-inputs" style="display:none;gap:10px;align-items:center;">
                <input type="date" id="visitor-start-date" style="padding:6px 10px;border:2px solid #28a745;border-radius:6px;">
                <span style="color:#333;font-weight:600;">to</span>
                <input type="date" id="visitor-end-date" style="padding:6px 10px;border:2px solid #28a745;border-radius:6px;">
            </div>
            
            <button onclick="generateVisitorReport()" style="padding:8px 15px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;border-radius:6px;cursor:pointer;font-weight:600;">📊 Generate Report</button>
            <button onclick="exportVisitorReport()" style="padding:8px 15px;background:linear-gradient(135deg,#28a745,#20c997);color:white;border:none;border-radius:6px;cursor:pointer;font-weight:600;">📥 Export CSV</button>
        </div>
        
        <div id="visitor-report-content">
            <!-- Report content will be generated here -->
        </div>
    </div>
    `;
    
    area.innerHTML = html;
    
    // Setup event listeners
    document.getElementById('visitor-report-type').onchange = function() {
        const dateRangeInputs = document.getElementById('visitor-date-range-inputs');
        if (this.value === 'custom') {
            dateRangeInputs.style.display = 'flex';
        } else {
            dateRangeInputs.style.display = 'none';
        }
    };
    
    // Generate initial report
    generateVisitorReport();
    
    // Global functions for report generation
    window.generateVisitorReport = function() {
        const reportType = document.getElementById('visitor-report-type').value;
        const studentFilter = isAdmin ? document.getElementById('visitor-report-student').value : currentStudentId;
        const startDate = document.getElementById('visitor-start-date') ? document.getElementById('visitor-start-date').value : null;
        const endDate = document.getElementById('visitor-end-date') ? document.getElementById('visitor-end-date').value : null;
        
        let filteredVisitors = visitorList;
        
        // Filter by student
        if (studentFilter && studentFilter !== 'all') {
            filteredVisitors = filteredVisitors.filter(v => v.studentId === studentFilter);
        } else if (!isAdmin) {
            filteredVisitors = filteredVisitors.filter(v => v.studentId === currentStudentId);
        }
        
        // Filter by date range
        const now = new Date();
        if (reportType === 'monthly') {
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            filteredVisitors = filteredVisitors.filter(v => {
                const visitDate = new Date(v.date);
                return visitDate.getMonth() === currentMonth && visitDate.getFullYear() === currentYear;
            });
        } else if (reportType === 'yearly') {
            const currentYear = now.getFullYear();
            filteredVisitors = filteredVisitors.filter(v => {
                const visitDate = new Date(v.date);
                return visitDate.getFullYear() === currentYear;
            });
        } else if (reportType === 'custom' && startDate && endDate) {
            filteredVisitors = filteredVisitors.filter(v => {
                return v.date >= startDate && v.date <= endDate;
            });
        }
        
        displayVisitorReport(filteredVisitors, reportType, isAdmin);
    };
    
    window.exportVisitorReport = function() {
        const reportContent = document.getElementById('visitor-report-content');
        const table = reportContent.querySelector('table');
        if (!table) {
            alert('No report data to export');
            return;
        }
        
        let csv = '';
        const rows = table.querySelectorAll('tr');
        rows.forEach(row => {
            const cols = row.querySelectorAll('th, td');
            const rowData = Array.from(cols).map(col => col.textContent.trim()).join(',');
            csv += rowData + '\n';
        });
        
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `visitor_report_${new Date().toISOString().slice(0,10)}.csv`;
        a.click();
        window.URL.revokeObjectURL(url);
    };
}

function displayVisitorReport(visitors, reportType, isAdmin) {
    const reportContent = document.getElementById('visitor-report-content');
    
    if (!visitors.length) {
        reportContent.innerHTML = '<div style="text-align:center;padding:40px;color:#666;font-size:1.2rem;">📋 No visitor records found for the selected criteria</div>';
        return;
    }
    
    // Calculate statistics
    const totalVisitors = visitors.length;
    const uniqueVisitors = new Set(visitors.map(v => v.name.toLowerCase())).size;
    const relationStats = {};
    const purposeStats = {};
    
    visitors.forEach(v => {
        relationStats[v.relation] = (relationStats[v.relation] || 0) + 1;
        purposeStats[v.purpose] = (purposeStats[v.purpose] || 0) + 1;
    });
    
    const mostCommonRelation = Object.keys(relationStats).reduce((a, b) => relationStats[a] > relationStats[b] ? a : b, '');
    const mostCommonPurpose = Object.keys(purposeStats).reduce((a, b) => purposeStats[a] > purposeStats[b] ? a : b, '');
    
    let html = `
    <!-- Summary Cards -->
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:25px;">
        <div style="background:linear-gradient(135deg,#28a745,#20c997);padding:20px;border-radius:12px;color:white;text-align:center;box-shadow:0 8px 25px rgba(40,167,69,0.3);">
            <div style="font-size:2rem;font-weight:700;">${totalVisitors}</div>
            <div style="opacity:0.9;font-size:1rem;">📊 Total Visits</div>
        </div>
        <div style="background:linear-gradient(135deg,#17a2b8,#6f42c1);padding:20px;border-radius:12px;color:white;text-align:center;box-shadow:0 8px 25px rgba(23,162,184,0.3);">
            <div style="font-size:2rem;font-weight:700;">${uniqueVisitors}</div>
            <div style="opacity:0.9;font-size:1rem;">👥 Unique Visitors</div>
        </div>
        <div style="background:linear-gradient(135deg,#ffc107,#fd7e14);padding:20px;border-radius:12px;color:white;text-align:center;box-shadow:0 8px 25px rgba(255,193,7,0.3);">
            <div style="font-size:1.2rem;font-weight:700;">${mostCommonRelation}</div>
            <div style="opacity:0.9;font-size:1rem;">👨‍👩‍👧‍👦 Common Relation</div>
        </div>
        <div style="background:linear-gradient(135deg,#dc3545,#fd7e14);padding:20px;border-radius:12px;color:white;text-align:center;box-shadow:0 8px 25px rgba(220,53,69,0.3);">
            <div style="font-size:1.2rem;font-weight:700;">${mostCommonPurpose}</div>
            <div style="opacity:0.9;font-size:1rem;">🎯 Common Purpose</div>
        </div>
    </div>
    
    <!-- Detailed Records -->
    <div style="background:rgba(255,255,255,0.9);border-radius:12px;overflow:hidden;box-shadow:0 8px 25px rgba(0,0,0,0.1);">
        <div style="background:linear-gradient(135deg,#667eea,#764ba2);color:white;padding:15px;text-align:center;">
            <h4 style="margin:0;font-size:1.3rem;">📋 Detailed Visitor Records</h4>
        </div>
        <div style="overflow-x:auto;">
            <table style="width:100%;border-collapse:separate;border-spacing:0;font-size:0.85rem;">
                <thead>
                    <tr style="background:#f8f9fa;">
                        <th style="padding:10px 8px;font-weight:700;border-bottom:2px solid #dee2e6;">🆔 Visitor ID</th>
                        ${isAdmin ? '<th style="padding:10px 8px;font-weight:700;border-bottom:2px solid #dee2e6;">🎓 Student ID</th>' : ''}
                        <th style="padding:10px 8px;font-weight:700;border-bottom:2px solid #dee2e6;">👤 Name</th>
                        <th style="padding:10px 8px;font-weight:700;border-bottom:2px solid #dee2e6;">📱 Contact</th>
                        <th style="padding:10px 8px;font-weight:700;border-bottom:2px solid #dee2e6;">🎯 Purpose</th>
                        <th style="padding:10px 8px;font-weight:700;border-bottom:2px solid #dee2e6;">📅 Date</th>
                        <th style="padding:10px 8px;font-weight:700;border-bottom:2px solid #dee2e6;">⏰ Check-In</th>
                        <th style="padding:10px 8px;font-weight:700;border-bottom:2px solid #dee2e6;">⏰ Check-Out</th>
                        <th style="padding:10px 8px;font-weight:700;border-bottom:2px solid #dee2e6;">👨‍👩‍👧‍👦 Relation</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    visitors.slice().reverse().forEach((v, index) => {
        html += `
        <tr style="background:${index % 2 === 0 ? '#fff' : '#f8f9fa'};transition:all 0.3s ease;" onmouseover="this.style.background='#e3f2fd'" onmouseout="this.style.background='${index % 2 === 0 ? '#fff' : '#f8f9fa'}'">
            <td style="padding:8px;font-weight:600;color:#667eea;">${v.id}</td>
            ${isAdmin ? `<td style="padding:8px;font-weight:600;color:#f093fb;">${v.studentId}</td>` : ''}
            <td style="padding:8px;font-weight:600;color:#333;">${v.name}</td>
            <td style="padding:8px;color:#28a745;font-weight:500;">${v.contact}</td>
            <td style="padding:8px;color:#666;">${v.purpose}</td>
            <td style="padding:8px;color:#333;font-weight:600;">${v.date}</td>
            <td style="padding:8px;color:#28a745;font-weight:600;">${v.checkIn || '-'}</td>
            <td style="padding:8px;color:#fd7e14;font-weight:600;">${v.checkOut || '-'}</td>
            <td style="padding:8px;color:#666;font-style:italic;">${v.relation}</td>
        </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
        </div>
    </div>
    `;
    
    reportContent.innerHTML = html;
}

// ---------- Issues Management ----------
function setupIssues() {
    // Guest mode: Show empty issues with notification
    if (isGuestMode()) {
        const issuesContent = document.querySelector('#issues-content, .issues-content');
        if (issuesContent) {
            issuesContent.innerHTML = '';
            issuesContent.appendChild(showGuestNotification("Issues data is not available in guest mode."));
        }
        return;
    }
    
    const issuesList = JSON.parse(localStorage.getItem('issuesList') || '[]');
    const userRole = localStorage.getItem('userRole');
    const currentStudentId = localStorage.getItem('studentId');
    const students = JSON.parse(localStorage.getItem('studentList') || '[]');
    const currentStudent = students.find(s => s.id === currentStudentId);
    
    const tbodyEl = document.getElementById('issues-tbody');
    const searchEl = document.getElementById('issues-search');
    const addBtn = document.getElementById('add-issue-btn');
    const formContainer = document.getElementById('issue-form-container');
    const form = document.getElementById('issue-form');
    const cancelBtn = document.getElementById('cancel-issue-btn');

    // Filter issues based on role
    let filteredIssues = issuesList;
    if(userRole === 'student' || userRole === 'parent') {
        filteredIssues = issuesList.filter(issue => 
            issue.studentName === (currentStudent ? currentStudent.name : '')
        );
    }

    function calculateDaysPending(dateStr, status) {
        if (status === 'resolved') return 0;
        const issueDate = new Date(dateStr);
        const today = new Date();
        const diffTime = Math.abs(today - issueDate);
        return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    }

    function renderTable(issues) {
        tbodyEl.innerHTML = '';
        issues.forEach(issue => {
            const daysPending = calculateDaysPending(issue.date, issue.status);
            const statusClass = issue.status === 'resolved' ? 'status-paid' : issue.status === 'in-progress' ? 'status-due' : 'status-overdue';
            const row = `
                <tr>
                    <td>${issue.id}</td>
                    <td>${issue.studentName}</td>
                    <td>${issue.roomNo}</td>
                    <td>${issue.issue}</td>
                    <td>${issue.date}</td>
                    <td><span class="status-tag ${statusClass}">${issue.status}</span></td>
                    <td>${daysPending}</td>
                    <td>${issue.assignedStaff || '-'}</td>
                    <td>${issue.resolutionDate || '-'}</td>
                    <td>${issue.resolutionFeedback || '-'}</td>
                </tr>
            `;
            tbodyEl.innerHTML += row;
        });
    }

    // Add notice for students/parents about view-only mode
    if(userRole === 'student' || userRole === 'parent') {
        const issuesContainer = document.querySelector('#issues-template .table-container') || document.querySelector('.table-container');
        if(issuesContainer) {
            const noticeDiv = document.createElement('div');
            noticeDiv.style.cssText = 'margin:15px 0;padding:12px;background:linear-gradient(135deg,#e3f2fd,#bbdefb);border-left:4px solid #2196f3;border-radius:8px;';
            noticeDiv.innerHTML = '<p style="margin:0;color:#1976d2;font-weight:600;">📋 You can submit new complaints and view your existing ones. Only admins can update status and assign staff.</p>';
            issuesContainer.insertBefore(noticeDiv, issuesContainer.children[1]);
        }
    }
    
    // Initial render
    renderTable(filteredIssues);

    // Pre-fill form for students/parents
    addBtn.onclick = () => {
        formContainer.style.display = 'block';
        form.reset();
        document.getElementById('issue-status').value = 'pending';
        
        if(userRole === 'student' || userRole === 'parent') {
            if(currentStudent) {
                document.getElementById('issue-student-name').value = currentStudent.name;
                document.getElementById('issue-student-name').readOnly = true;
                document.getElementById('issue-room-no').value = currentStudent.roomNo || '';
                document.getElementById('issue-room-no').readOnly = true;
                
                // Hide admin-only fields for students/parents
                document.getElementById('issue-status').style.display = 'none';
                document.querySelector('label[for="issue-status"]').style.display = 'none';
                document.getElementById('issue-assigned-staff').style.display = 'none';
                document.querySelector('label[for="issue-assigned-staff"]').style.display = 'none';
                document.getElementById('issue-resolution-date').style.display = 'none';
                document.querySelector('label[for="issue-resolution-date"]').style.display = 'none';
                document.getElementById('issue-resolution-feedback').style.display = 'none';
                document.querySelector('label[for="issue-resolution-feedback"]').style.display = 'none';
            }
        }
    };

    cancelBtn.onclick = () => {
        formContainer.style.display = 'none';
    };

    // Form submission
    form.onsubmit = (e) => {
        e.preventDefault();
        const newIssue = {
            id: 'I' + String(issuesList.length + 1).padStart(3, '0'),
            studentName: document.getElementById('issue-student-name').value,
            roomNo: document.getElementById('issue-room-no').value,
            issue: document.getElementById('issue-description').value,
            date: new Date().toISOString().slice(0, 10),
            status: document.getElementById('issue-status').value,
            assignedStaff: document.getElementById('issue-assigned-staff').value,
            resolutionDate: document.getElementById('issue-resolution-date').value,
            resolutionFeedback: document.getElementById('issue-resolution-feedback').value
        };
        issuesList.push(newIssue);
        localStorage.setItem('issuesList', JSON.stringify(issuesList));
        
        // Update filtered issues and re-render
        if(userRole === 'student' || userRole === 'parent') {
            filteredIssues = issuesList.filter(issue => 
                issue.studentName === (currentStudent ? currentStudent.name : '')
            );
        } else {
            filteredIssues = issuesList;
        }
        renderTable(filteredIssues);
        formContainer.style.display = 'none';
        
        // Update complaints count in dashboard
        const complaints = JSON.parse(localStorage.getItem('complaints') || '[]');
        complaints.push({
            id: newIssue.id,
            title: newIssue.issue,
            status: newIssue.status,
            date: newIssue.date
        });
        localStorage.setItem('complaints', JSON.stringify(complaints));
    };

    // Search functionality
    searchEl.oninput = () => {
        const searchTerm = searchEl.value.toLowerCase();
        const filtered = filteredIssues.filter(issue => 
            issue.studentName.toLowerCase().includes(searchTerm) ||
            issue.issue.toLowerCase().includes(searchTerm) ||
            issue.roomNo.toLowerCase().includes(searchTerm)
        );
        renderTable(filtered);
    };
}

// ---------- Enrolled Students ----------
function setupEnrolledStudents() {
    // Guest mode: Show empty students list with notification
    if (isGuestMode()) {
        const studentsContent = document.querySelector('#enrolled-students-content, .enrolled-students-content');
        const tbody = document.getElementById('enrolled-students-tbody');
        if (tbody) {
            tbody.innerHTML = '';
        }
        if (studentsContent) {
            const notification = showGuestNotification("Student data is not available in guest mode.");
            if (tbody && tbody.parentNode) {
                tbody.parentNode.insertBefore(notification, tbody);
            } else if (studentsContent) {
                studentsContent.prepend(notification);
            }
        }
        return;
    }
    
    const students = JSON.parse(localStorage.getItem('studentList') || '[]');
    const userRole = localStorage.getItem('userRole');
    const currentStudentId = localStorage.getItem('studentId');
    const isAdmin = isAdminOrGuest(); // Show admin UI to both admin and guest users
    
    // Filter students based on role
    let filteredStudents = students;
    if(userRole === 'student' || userRole === 'parent') {
        filteredStudents = students.filter(s => s.id === currentStudentId);
    }
    
    const tbody = document.getElementById('enrolled-students-tbody');
    const searchInput = document.getElementById('enrolled-search');
    const filterSelect = document.getElementById('students-list-filter');
    const exportBtn = document.getElementById('export-csv');
    
    // Global functions for admin actions
    window.changeStudentId = function(currentId, newId) {
        if (!isAdmin) return;
        if (!newId || newId === currentId) return;
        
        const student = students.find(s => s.id === currentId);
        if (!student) return;
        
        // Check if new ID already exists
        if (students.find(s => s.id === newId)) {
            alert('Student ID already exists!');
            return;
        }
        
        student.id = newId;
        localStorage.setItem('studentList', JSON.stringify(students));
        renderTable(filteredStudents);
    };
    
    window.viewDocument = function(studentId, docType) {
        const student = students.find(s => s.id === studentId);
        if (!student || !student.documents || !student.documents[docType]) {
            alert('Document not found');
            return;
        }
        
        // Open document in new window
        const newWindow = window.open('', '_blank');
        if (student.documents[docType].startsWith('data:image')) {
            newWindow.document.write(`
                <html><head><title>${docType} - ${student.name}</title></head>
                <body style="margin:0;display:flex;justify-content:center;align-items:center;min-height:100vh;background:#f0f0f0;">
                    <img src="${student.documents[docType]}" style="max-width:100%;max-height:100%;object-fit:contain;">
                </body></html>
            `);
        } else {
            newWindow.location.href = student.documents[docType];
        }
    };
    
    window.uploadDocument = function(studentId, docType) {
        // Only allow admin to upload documents, students/parents can only view
        if (!isAdmin) {
            alert('You can only view documents. Contact admin to upload or modify documents.');
            return;
        }
        
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*,application/pdf';
        input.onchange = function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(event) {
                const student = students.find(s => s.id === studentId);
                if (!student) return;
                
                if (!student.documents) student.documents = {};
                student.documents[docType] = event.target.result;
                
                localStorage.setItem('studentList', JSON.stringify(students));
                renderTable(filteredStudents);
                alert(`${docType} uploaded successfully!`);
            };
            reader.readAsDataURL(file);
        };
        input.click();
    };
    
    function renderTable(studentsToShow) {
        tbody.innerHTML = '';
        
        // PRIVACY: Apply data filtering based on user role
        const userRole = localStorage.getItem('userRole');
        const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
        const canEdit = canEditData(userRole);
        
        // Filter students data for privacy
        let displayStudents;
        if (userRole === 'guest') {
            // Guests see structure but no real data
            displayStudents = getFilteredStudentData(userRole, currentUser).slice(0, 3); // Show only 3 sample rows
        } else {
            displayStudents = studentsToShow;
        }
        
        displayStudents.forEach(s => {
            const studentIdCell = canEdit ? 
                `<input type="text" value="${s.id||''}" style="width:80px;padding:4px;border:1px solid #ddd;border-radius:4px;" onchange="changeStudentId('${s.id}', this.value)" title="Click to edit Student ID">` : 
                `<span style="font-weight:600;color:#333;">${s.id || ''}</span>`;
            
            const documentsCell = `
                <div style="display:flex;flex-wrap:wrap;gap:4px;">
                    ${['photo', 'admissionForm', 'bForm', 'fatherID'].map(docType => {
                        const hasDoc = s.documents && s.documents[docType];
                        const docNames = {photo: '📸', admissionForm: '📋', bForm: '🆔', fatherID: '👨'};
                        const buttonAction = hasDoc ? `viewDocument('${s.id}', '${docType}')` : (canEdit ? `uploadDocument('${s.id}', '${docType}')` : `alert('Document not available. Contact admin to upload documents.')`);
                        const buttonTitle = hasDoc ? 'View' : (canEdit ? 'Upload' : 'Not Available');
                        return `
                            <button onclick="${buttonAction}" 
                                    style="padding:6px 8px;border:none;border-radius:8px;cursor:pointer;font-size:14px;background:${hasDoc ? 'linear-gradient(135deg,#28a745,#20c997)' : (canEdit ? 'linear-gradient(135deg,#6c757d,#495057)' : 'linear-gradient(135deg,#dc3545,#fd7e14)')};color:white;margin:2px;box-shadow:0 3px 10px rgba(0,0,0,0.2);transition:all 0.3s ease;font-weight:600;" 
                                    title="${buttonTitle} ${docType}"
                                    onmouseover="this.style.transform='scale(1.1)';this.style.boxShadow='0 6px 20px rgba(0,0,0,0.3)'"
                                    onmouseout="this.style.transform='scale(1)';this.style.boxShadow='0 3px 10px rgba(0,0,0,0.2)'">
                                ${docNames[docType]}
                            </button>
                        `;
                    }).join('')}
                </div>
            `;
            
            const rowIndex = studentsToShow.indexOf(s);
            const rowGradients = [
                'linear-gradient(135deg, #fff5f5, #ffe0e6)',
                'linear-gradient(135deg, #f0f9ff, #e0f2fe)', 
                'linear-gradient(135deg, #f0fdf4, #dcfce7)',
                'linear-gradient(135deg, #fefce8, #fef3c7)',
                'linear-gradient(135deg, #fdf4ff, #fae8ff)',
                'linear-gradient(135deg, #fff1f2, #fecaca)',
                'linear-gradient(135deg, #f0f9ff, #dbeafe)',
                'linear-gradient(135deg, #ecfdf5, #d1fae5)',
                'linear-gradient(135deg, #fffbeb, #fed7aa)'
            ];
            
            tbody.innerHTML += `
                <tr style="background:${rowGradients[rowIndex % rowGradients.length]};transition:all 0.3s ease;" onmouseover="this.style.transform='scale(1.02)';this.style.boxShadow='0 8px 25px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='scale(1)';this.style.boxShadow='none'">
                    <td style="padding:12px 10px;border-right:1px solid rgba(0,0,0,0.05);font-weight:600;">${studentIdCell}</td>
                    <td style="padding:12px 10px;border-right:1px solid rgba(0,0,0,0.05);"><span style="color:#333;font-weight:600;">${s.name||''}</span></td>
                    <td style="padding:12px 10px;border-right:1px solid rgba(0,0,0,0.05);"><span style="color:#555;">${s.contact||''}</span></td>
                    <td style="padding:12px 10px;border-right:1px solid rgba(0,0,0,0.05);"><span style="color:#555;">${s.guardian||''}</span></td>
                    <td style="padding:12px 10px;border-right:1px solid rgba(0,0,0,0.05);"><span style="color:#555;">${s.guardianContact||''}</span></td>
                    <td style="padding:12px 10px;border-right:1px solid rgba(0,0,0,0.05);"><span style="color:#555;">${s.guardianId||''}</span></td>
                    <td style="padding:12px 10px;border-right:1px solid rgba(0,0,0,0.05);"><span style="background:linear-gradient(135deg,#667eea,#764ba2);color:white;padding:4px 8px;border-radius:8px;font-weight:600;">${s.roomNo||'N/A'}</span></td>
                    <td style="padding:12px 10px;border-right:1px solid rgba(0,0,0,0.05);"><span style="color:#28a745;font-weight:600;">${s.admissionFee||0}</span></td>
                    <td style="padding:12px 10px;border-right:1px solid rgba(0,0,0,0.05);"><span style="color:#17a2b8;font-weight:600;">${s.securityFee||0}</span></td>
                    <td style="padding:12px 10px;border-right:1px solid rgba(0,0,0,0.05);"><span style="color:#28a745;font-weight:700;">${s.feePaid||0}</span></td>
                    <td style="padding:12px 10px;border-right:1px solid rgba(0,0,0,0.05);"><span style="color:#ffc107;font-weight:700;">${s.totalFee||0}</span></td>
                    <td style="padding:12px 10px;border-right:1px solid rgba(0,0,0,0.05);"><span style="background:${(s.due||0) > 0 ? 'linear-gradient(135deg,#dc3545,#fd7e14)' : 'linear-gradient(135deg,#28a745,#20c997)'};color:white;padding:4px 8px;border-radius:8px;font-weight:600;">${s.due||0}</span></td>
                    <td style="padding:12px 10px;border-right:1px solid rgba(0,0,0,0.05);"><span style="color:#dc3545;font-weight:600;">${s.emergencyContact||''}</span></td>
                    <td style="padding:12px 10px;border-right:1px solid rgba(0,0,0,0.05);"><span style="color:#555;">${s.admissionDate||''}</span></td>
                    <td style="padding:12px 10px;border-right:1px solid rgba(0,0,0,0.05);"><span style="color:#555;">${s.graduationDate||''}</span></td>
                    <td style="padding:12px 10px;border-right:1px solid rgba(0,0,0,0.05);"><span style="color:#fd7e14;font-weight:500;">${s.medical||''}</span></td>
                    <td style="padding:12px 10px;">${documentsCell}</td>
                </tr>
            `;
        });
    }
    
    // Update title based on role
    const titleEl = document.getElementById('enrolled-students-title');
    if(userRole === 'student' || userRole === 'parent') {
        titleEl.textContent = 'My Profile (View Only)';
        // Hide filter controls for students/parents
        const filterControls = titleEl.nextElementSibling;
        if(filterControls) filterControls.style.display = 'none';
        
        // Add notice for students/parents
        const noticeDiv = document.createElement('div');
        noticeDiv.style.cssText = 'margin:20px 0;padding:20px;background:linear-gradient(135deg,#fff3cd 0%,#ffeaa7 50%,#ffeb3b 100%);border-left:6px solid #ff9800;border-radius:15px;box-shadow:0 8px 25px rgba(255,193,7,0.3);';
        noticeDiv.innerHTML = '<p style="margin:0;color:#e65100;font-weight:700;font-size:1.1rem;text-shadow:1px 1px 2px rgba(0,0,0,0.1);">📋 This is your profile in view-only mode. Contact the admin to make any changes to your information or documents.</p>';
        titleEl.parentNode.insertBefore(noticeDiv, titleEl.nextSibling);
    }
    
    // Initial render
    renderTable(filteredStudents);
    
    // Search functionality - only for admin
    if(searchInput && userRole === 'admin') {
        searchInput.oninput = () => {
            const searchTerm = searchInput.value.toLowerCase();
            const filtered = filteredStudents.filter(s => 
                (s.name && s.name.toLowerCase().includes(searchTerm)) ||
                (s.id && s.id.toLowerCase().includes(searchTerm))
            );
            renderTable(filtered);
        };
    }
    
    // Filter functionality - only for admin
    if(filterSelect && userRole === 'admin') {
        filterSelect.onchange = () => {
            const period = filterSelect.value;
            const now = new Date();
            let filtered = filteredStudents;
            
            if(period === 'month') {
                filtered = filteredStudents.filter(s => {
                    const d = new Date(s.admissionDate);
                    return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
                });
            } else if(period === 'year') {
                filtered = filteredStudents.filter(s => {
                    const d = new Date(s.admissionDate);
                    return d.getFullYear() === now.getFullYear();
                });
            }
            renderTable(filtered);
        };
    }
    
    // Export functionality - only for admin
    if(exportBtn && userRole === 'admin') {
        exportBtn.onclick = () => {
            const csvContent = "data:text/csv;charset=utf-8," + 
                "Student ID,Name,Contact,Guardian,Guardian Contact,Guardian ID,Room No,Admission Fee,Security Fee,Fee Paid,Total Fee,Due,Emergency Contact,Admission Date,Graduation Date,Medical\n" +
                filteredStudents.map(s => 
                    `${s.id||''},${s.name||''},${s.contact||''},${s.guardian||''},${s.guardianContact||''},${s.guardianId||''},${s.roomNo||''},${s.admissionFee||0},${s.securityFee||0},${s.feePaid||0},${s.totalFee||0},${s.due||0},${s.emergencyContact||''},${s.admissionDate||''},${s.graduationDate||''},${s.medical||''}`
                ).join("\n");
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "students_list.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };
    }
}

// ---------- File Upload Utility Functions ----------
function handleFileUpload(fileInput, callback) {
    const file = fileInput.files[0];
    if (!file) {
        callback(null);
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        const fileData = {
            name: file.name,
            type: file.type,
            size: file.size,
            data: e.target.result,
            uploadDate: new Date().toISOString()
        };
        callback(fileData);
    };
    reader.readAsDataURL(file);
}

function displayVoucherInfo(voucherData) {
    if (!voucherData) return '-';
    
    const isImage = voucherData.type.startsWith('image/');
    const isPDF = voucherData.type === 'application/pdf';
    
    return `
        <div style="display:flex;align-items:center;gap:8px;">
            <span style="font-size:0.9rem;color:#666;">${voucherData.name}</span>
            <button onclick="viewVoucher('${voucherData.data}', '${voucherData.type}', '${voucherData.name}')" 
                    style="background:#28a745;color:white;border:none;padding:4px 8px;border-radius:4px;font-size:0.8rem;cursor:pointer;">
                ${isImage ? '🖼️ View' : isPDF ? '📄 View' : '📎 Open'}
            </button>
        </div>
    `;
}

function viewVoucher(data, type, name) {
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(0,0,0,0.8); z-index: 10000; display: flex; 
        align-items: center; justify-content: center; padding: 20px;
    `;
    
    const content = document.createElement('div');
    content.style.cssText = `
        background: white; border-radius: 15px; padding: 20px; 
        max-width: 90%; max-height: 90%; overflow: auto;
        position: relative;
    `;
    
    const closeBtn = document.createElement('button');
    closeBtn.innerHTML = '✕';
    closeBtn.style.cssText = `
        position: absolute; top: 10px; right: 15px; 
        background: #dc3545; color: white; border: none; 
        border-radius: 50%; width: 30px; height: 30px; 
        cursor: pointer; font-size: 16px;
    `;
    closeBtn.onclick = () => document.body.removeChild(modal);
    
    const title = document.createElement('h3');
    title.textContent = name;
    title.style.marginBottom = '15px';
    
    if (type.startsWith('image/')) {
        const img = document.createElement('img');
        img.src = data;
        img.style.cssText = 'max-width: 100%; max-height: 70vh; border-radius: 8px;';
        content.appendChild(title);
        content.appendChild(img);
    } else if (type === 'application/pdf') {
        const iframe = document.createElement('iframe');
        iframe.src = data;
        iframe.style.cssText = 'width: 80vw; height: 70vh; border: none; border-radius: 8px;';
        content.appendChild(title);
        content.appendChild(iframe);
    } else {
        const link = document.createElement('a');
        link.href = data;
        link.download = name;
        link.textContent = `Download ${name}`;
        link.style.cssText = 'display: block; padding: 20px; text-align: center; font-size: 18px;';
        content.appendChild(title);
        content.appendChild(link);
    }
    
    content.appendChild(closeBtn);
    modal.appendChild(content);
    document.body.appendChild(modal);
}

// ---------- Expense Management ----------
function setupExpense() {
    // Guest mode: Show empty expense with notification
    if (isGuestMode()) {
        const expenseContent = document.querySelector('#expense-content, .expense-content');
        if (expenseContent) {
            expenseContent.innerHTML = '';
            expenseContent.appendChild(showGuestNotification("Expense data is not available in guest mode."));
        }
        return;
    }
    
    const expenseList = JSON.parse(localStorage.getItem('expenseList') || '[]');
    const tbody = document.getElementById('expense-tbody');
    const periodFilter = document.getElementById('expense-period-filter');
    const categoryFilter = document.getElementById('expense-category-filter');
    const dateFilter = document.getElementById('expense-date-filter');
    const addBtn = document.getElementById('add-expense-btn');
    const formContainer = document.getElementById('expense-form-container');
    const form = document.getElementById('expense-form');
    const cancelBtn = document.getElementById('cancel-expense-btn');
    const generateReportBtn = document.getElementById('generate-report-btn');
    
    let currentExpenses = expenseList;
    
    function filterExpenses() {
        const period = periodFilter.value;
        const category = categoryFilter.value;
        const selectedDate = dateFilter.value;
        const now = new Date();
        
        let filtered = expenseList;
        
        // Filter by period
        if(period === 'daily') {
            const today = new Date().toISOString().slice(0,10);
            filtered = filtered.filter(e => e.date === today);
        } else if(period === 'monthly') {
            filtered = filtered.filter(e => {
                const d = new Date(e.date);
                return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
            });
        } else if(period === 'yearly') {
            filtered = filtered.filter(e => {
                const d = new Date(e.date);
                return d.getFullYear() === now.getFullYear();
            });
        }
        
        // Filter by category
        if(category !== 'all') {
            filtered = filtered.filter(e => e.category === category);
        }
        
        // Filter by specific date
        if(selectedDate) {
            filtered = filtered.filter(e => e.date === selectedDate);
        }
        
        currentExpenses = filtered;
        renderTable(filtered);
        updateSummary(filtered);
        updateCharts(filtered);
    }
    
    function renderTable(expenses) {
        tbody.innerHTML = '';
        expenses.forEach(expense => {
            tbody.innerHTML += `
                <tr>
                    <td>${expense.date}</td>
                    <td>${getCategoryName(expense.category)}</td>
                    <td>${expense.description}</td>
                    <td>PKR ${expense.amount.toLocaleString()}</td>
                    <td>${expense.payment}</td>
                    <td>${expense.vendor || '-'}</td>
                    <td>${expense.receipt || '-'}</td>
                    <td>${displayVoucherInfo(expense.voucher)}</td>
                    <td>${expense.approved || '-'}</td>
                </tr>
            `;
        });
    }
    
    function getCategoryName(category) {
        const names = {
            food: 'Food & Kitchen',
            utilities: 'Utilities',
            maintenance: 'Maintenance',
            staff: 'Staff Salaries',
            supplies: 'Supplies',
            security: 'Security',
            cleaning: 'Cleaning',
            medical: 'Medical',
            transport: 'Transport',
            other: 'Other'
        };
        return names[category] || category;
    }
    
    function updateSummary(expenses) {
        const total = expenses.reduce((sum, e) => sum + e.amount, 0);
        const avgDaily = expenses.length > 0 ? total / expenses.length : 0;
        
        // Get income data for Net Revenue and Profit/Loss calculation
        const incomeList = JSON.parse(localStorage.getItem('incomeList') || '[]');
        const totalIncome = incomeList.reduce((sum, i) => sum + i.amount, 0);
        const netRevenue = totalIncome;
        const profitLoss = totalIncome - total;
        
        // Category totals
        const categoryTotals = {};
        expenses.forEach(e => {
            categoryTotals[e.category] = (categoryTotals[e.category] || 0) + e.amount;
        });
        
        const highestCategory = Object.keys(categoryTotals).reduce((a, b) => 
            categoryTotals[a] > categoryTotals[b] ? a : b, Object.keys(categoryTotals)[0] || 'none'
        );
        
        document.getElementById('total-expense').textContent = `PKR ${total.toLocaleString()}`;
        document.getElementById('avg-daily').textContent = `PKR ${Math.round(avgDaily).toLocaleString()}`;
        document.getElementById('highest-category').textContent = getCategoryName(highestCategory);
        document.getElementById('expense-count').textContent = expenses.length;
        document.getElementById('net-revenue').textContent = `PKR ${netRevenue.toLocaleString()}`;
        
        // Color code profit/loss
        const profitLossEl = document.getElementById('profit-loss');
        profitLossEl.textContent = `PKR ${profitLoss.toLocaleString()}`;
        profitLossEl.style.color = profitLoss >= 0 ? '#28a745' : '#dc3545';
    }
    
    function updateCharts(expenses) {
        // Category Chart
        const categoryCanvas = document.getElementById('category-chart');
        const categoryCtx = categoryCanvas.getContext('2d');
        
        const categoryTotals = {};
        expenses.forEach(e => {
            categoryTotals[e.category] = (categoryTotals[e.category] || 0) + e.amount;
        });
        
        drawPieChart(categoryCtx, categoryTotals, categoryCanvas.width, categoryCanvas.height);
        
        // Trend Chart
        const trendCanvas = document.getElementById('trend-chart');
        const trendCtx = trendCanvas.getContext('2d');
        
        const monthlyData = {};
        expenses.forEach(e => {
            const month = e.date.slice(0, 7); // YYYY-MM
            monthlyData[month] = (monthlyData[month] || 0) + e.amount;
        });
        
        drawLineChart(trendCtx, monthlyData, trendCanvas.width, trendCanvas.height);
    }
    
    function drawPieChart(ctx, data, width, height) {
        ctx.clearRect(0, 0, width, height);
        const centerX = width / 2;
        const centerY = height / 2;
        const radius = Math.min(width, height) / 3;
        
        const total = Object.values(data).reduce((sum, val) => sum + val, 0);
        const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384'];
        
        let currentAngle = 0;
        Object.entries(data).forEach(([category, amount], index) => {
            const sliceAngle = (amount / total) * 2 * Math.PI;
            
            ctx.beginPath();
            ctx.moveTo(centerX, centerY);
            ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
            ctx.closePath();
            ctx.fillStyle = colors[index % colors.length];
            ctx.fill();
            
            // Label
            const labelAngle = currentAngle + sliceAngle / 2;
            const labelX = centerX + Math.cos(labelAngle) * (radius + 20);
            const labelY = centerY + Math.sin(labelAngle) * (radius + 20);
            
            ctx.fillStyle = '#333';
            ctx.font = '12px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(getCategoryName(category), labelX, labelY);
            
            currentAngle += sliceAngle;
        });
    }
    
    function drawLineChart(ctx, data, width, height) {
        ctx.clearRect(0, 0, width, height);
        
        const margin = 40;
        const chartWidth = width - 2 * margin;
        const chartHeight = height - 2 * margin;
        
        const months = Object.keys(data).sort();
        const values = months.map(month => data[month]);
        const maxValue = Math.max(...values);
        
        if(months.length === 0) return;
        
        // Draw axes
        ctx.strokeStyle = '#ccc';
        ctx.beginPath();
        ctx.moveTo(margin, margin);
        ctx.lineTo(margin, height - margin);
        ctx.lineTo(width - margin, height - margin);
        ctx.stroke();
        
        // Draw line
        ctx.strokeStyle = '#36A2EB';
        ctx.lineWidth = 2;
        ctx.beginPath();
        
        months.forEach((month, index) => {
            const x = margin + (index / (months.length - 1)) * chartWidth;
            const y = height - margin - (data[month] / maxValue) * chartHeight;
            
            if(index === 0) {
                ctx.moveTo(x, y);
            } else {
                ctx.lineTo(x, y);
            }
            
            // Draw points
            ctx.fillStyle = '#36A2EB';
            ctx.beginPath();
            ctx.arc(x, y, 4, 0, 2 * Math.PI);
            ctx.fill();
        });
        
        ctx.stroke();
        
        // Labels
        ctx.fillStyle = '#333';
        ctx.font = '10px Arial';
        ctx.textAlign = 'center';
        months.forEach((month, index) => {
            const x = margin + (index / (months.length - 1)) * chartWidth;
            ctx.fillText(month, x, height - 10);
        });
    }
    
    // Event listeners
    periodFilter.onchange = filterExpenses;
    categoryFilter.onchange = filterExpenses;
    dateFilter.onchange = filterExpenses;
    
    addBtn.onclick = () => {
        formContainer.style.display = 'block';
        form.reset();
        document.getElementById('expense-date').value = new Date().toISOString().slice(0,10);
    };
    
    cancelBtn.onclick = () => {
        formContainer.style.display = 'none';
    };
    
    form.onsubmit = (e) => {
        e.preventDefault();
        
        const voucherInput = document.getElementById('expense-voucher-upload');
        
        handleFileUpload(voucherInput, (voucherData) => {
            const newExpense = {
                id: 'E' + String(expenseList.length + 1).padStart(3, '0'),
                date: document.getElementById('expense-date').value,
                category: document.getElementById('expense-category').value,
                description: document.getElementById('expense-description').value,
                amount: parseFloat(document.getElementById('expense-amount').value),
                payment: document.getElementById('expense-payment').value,
                vendor: document.getElementById('expense-vendor').value,
                receipt: document.getElementById('expense-receipt').value,
                voucher: voucherData,
                approved: document.getElementById('expense-approved').value
            };
            
            expenseList.push(newExpense);
            localStorage.setItem('expenseList', JSON.stringify(expenseList));
            formContainer.style.display = 'none';
            filterExpenses();
            
            if (voucherData) {
                alert('✅ Expense saved with voucher uploaded successfully!');
            } else {
                alert('⚠️ Expense saved but no voucher was uploaded. Consider adding a receipt for better record keeping.');
            }
        });
    };
    
    generateReportBtn.onclick = () => {
        generateExpenseReport(currentExpenses);
    };
    
    // Initial load
    filterExpenses();
}

function generateExpenseReport(expenses) {
    const total = expenses.reduce((sum, e) => sum + e.amount, 0);
    const categoryTotals = {};
    expenses.forEach(e => {
        categoryTotals[e.category] = (categoryTotals[e.category] || 0) + e.amount;
    });
    
    let report = `GIRLS HOSTEL EXPENSE REPORT\n`;
    report += `Generated on: ${new Date().toLocaleDateString()}\n\n`;
    report += `SUMMARY:\n`;
    report += `Total Expenses: PKR ${total.toLocaleString()}\n`;
    report += `Number of Entries: ${expenses.length}\n\n`;
    report += `CATEGORY BREAKDOWN:\n`;
    Object.entries(categoryTotals).forEach(([cat, amt]) => {
        const percentage = ((amt / total) * 100).toFixed(1);
        report += `${getCategoryName(cat)}: PKR ${amt.toLocaleString()} (${percentage}%)\n`;
    });
    
    const blob = new Blob([report], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'expense_report.txt';
    a.click();
    URL.revokeObjectURL(url);
}

function getCategoryName(category) {
    const names = {
        food: 'Food & Kitchen',
        utilities: 'Utilities',
        internet: 'Internet',
        maintenance: 'Maintenance',
        staff: 'Staff Salaries',
        employee: 'Employee Costs',
        supplies: 'Office Supply',
        equipment: 'Equipment',
        security: 'Security',
        cleaning: 'Cleaning',
        medical: 'Medical',
        transport: 'Transport',
        advertising: 'Advertising',
        marketing: 'Marketing',
        debts: 'Debts',
        sponsorships: 'Sponsorships',
        other: 'Other'
    };
    return names[category] || category;
}

// ---------- Income Management ----------
function setupIncome() {
    // Guest mode: Show empty income with notification
    if (isGuestMode()) {
        const incomeContent = document.querySelector('#income-content, .income-content');
        if (incomeContent) {
            incomeContent.innerHTML = '';
            incomeContent.appendChild(showGuestNotification("Income data is not available in guest mode."));
        }
        return;
    }
    
    const incomeList = JSON.parse(localStorage.getItem('incomeList') || '[]');
    const tbody = document.getElementById('income-tbody');
    const periodFilter = document.getElementById('income-period-filter');
    const categoryFilter = document.getElementById('income-category-filter');
    const dateFilter = document.getElementById('income-date-filter');
    const addBtn = document.getElementById('add-income-btn');
    const formContainer = document.getElementById('income-form-container');
    const form = document.getElementById('income-form');
    const cancelBtn = document.getElementById('cancel-income-btn');
    const generateReportBtn = document.getElementById('generate-income-report-btn');
    
    let currentIncome = incomeList;
    
    function filterIncome() {
        const period = periodFilter.value;
        const category = categoryFilter.value;
        const selectedDate = dateFilter.value;
        const now = new Date();
        
        let filtered = incomeList;
        
        // Filter by period
        if(period === 'daily') {
            const today = new Date().toISOString().slice(0,10);
            filtered = filtered.filter(i => i.date === today);
        } else if(period === 'monthly') {
            filtered = filtered.filter(i => {
                const d = new Date(i.date);
                return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
            });
        } else if(period === 'yearly') {
            filtered = filtered.filter(i => {
                const d = new Date(i.date);
                return d.getFullYear() === now.getFullYear();
            });
        }
        
        // Filter by category
        if(category !== 'all') {
            filtered = filtered.filter(i => i.category === category);
        }
        
        // Filter by specific date
        if(selectedDate) {
            filtered = filtered.filter(i => i.date === selectedDate);
        }
        
        currentIncome = filtered;
        renderIncomeTable(filtered);
        updateIncomeSummary(filtered);
        updateIncomeCharts(filtered);
    }
    
    function renderIncomeTable(income) {
        tbody.innerHTML = '';
        income.forEach(item => {
            tbody.innerHTML += `
                <tr>
                    <td>${item.date}</td>
                    <td>${getIncomeCategoryName(item.category)}</td>
                    <td>${item.studentName}</td>
                    <td>${item.studentId || '-'}</td>
                    <td>PKR ${item.amount.toLocaleString()}</td>
                    <td>${item.payment}</td>
                    <td>${item.receipt || '-'}</td>
                    <td>${displayVoucherInfo(item.voucher)}</td>
                    <td>${item.description || '-'}</td>
                </tr>
            `;
        });
    }
    
    function getIncomeCategoryName(category) {
        const names = {
            admission: 'Admission Fee',
            security: 'Security Fee',
            monthly: 'Monthly Fee',
            chanda: 'Chanda',
            boxes: 'Boxes',
            bhef: 'BHEF',
            donation: 'Donation',
            other: 'Other'
        };
        return names[category] || category;
    }
    
    function updateIncomeSummary(income) {
        const total = income.reduce((sum, i) => sum + i.amount, 0);
        const avgDaily = income.length > 0 ? total / income.length : 0;
        
        // Category totals
        const categoryTotals = {};
        income.forEach(i => {
            categoryTotals[i.category] = (categoryTotals[i.category] || 0) + i.amount;
        });
        
        const highestCategory = Object.keys(categoryTotals).reduce((a, b) => 
            categoryTotals[a] > categoryTotals[b] ? a : b, Object.keys(categoryTotals)[0] || 'none'
        );
        
        document.getElementById('total-income').textContent = `PKR ${total.toLocaleString()}`;
        document.getElementById('daily-avg-income').textContent = `PKR ${Math.round(avgDaily).toLocaleString()}`;
        document.getElementById('highest-income-category').textContent = getIncomeCategoryName(highestCategory);
        document.getElementById('income-count').textContent = income.length;
    }
    
    function updateIncomeCharts(income) {
        // Category Chart
        const categoryCanvas = document.getElementById('income-category-chart');
        const categoryCtx = categoryCanvas.getContext('2d');
        
        const categoryTotals = {};
        income.forEach(i => {
            categoryTotals[i.category] = (categoryTotals[i.category] || 0) + i.amount;
        });
        
        drawIncomePieChart(categoryCtx, categoryTotals, categoryCanvas.width, categoryCanvas.height);
        
        // Trend Chart
        const trendCanvas = document.getElementById('income-trend-chart');
        const trendCtx = trendCanvas.getContext('2d');
        
        const monthlyData = {};
        income.forEach(i => {
            const month = i.date.slice(0, 7); // YYYY-MM
            monthlyData[month] = (monthlyData[month] || 0) + i.amount;
        });
        
        drawIncomeLineChart(trendCtx, monthlyData, trendCanvas.width, trendCanvas.height);
    }
    
    function drawIncomePieChart(ctx, data, width, height) {
        ctx.clearRect(0, 0, width, height);
        const centerX = width / 2;
        const centerY = height / 2;
        const radius = Math.min(width, height) / 3;
        
        const total = Object.values(data).reduce((sum, val) => sum + val, 0);
        const colors = ['#28a745', '#17a2b8', '#ffc107', '#6f42c1', '#fd7e14', '#20c997', '#e83e8c', '#6c757d'];
        
        let currentAngle = 0;
        Object.entries(data).forEach(([category, amount], index) => {
            const sliceAngle = (amount / total) * 2 * Math.PI;
            
            ctx.beginPath();
            ctx.moveTo(centerX, centerY);
            ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
            ctx.closePath();
            ctx.fillStyle = colors[index % colors.length];
            ctx.fill();
            
            // Label
            const labelAngle = currentAngle + sliceAngle / 2;
            const labelX = centerX + Math.cos(labelAngle) * (radius + 20);
            const labelY = centerY + Math.sin(labelAngle) * (radius + 20);
            
            ctx.fillStyle = '#333';
            ctx.font = '12px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(getIncomeCategoryName(category), labelX, labelY);
            
            currentAngle += sliceAngle;
        });
    }
    
    function drawIncomeLineChart(ctx, data, width, height) {
        ctx.clearRect(0, 0, width, height);
        
        const margin = 40;
        const chartWidth = width - 2 * margin;
        const chartHeight = height - 2 * margin;
        
        const months = Object.keys(data).sort();
        const values = months.map(month => data[month]);
        const maxValue = Math.max(...values);
        
        if(months.length === 0) return;
        
        // Draw axes
        ctx.strokeStyle = '#ccc';
        ctx.beginPath();
        ctx.moveTo(margin, margin);
        ctx.lineTo(margin, height - margin);
        ctx.lineTo(width - margin, height - margin);
        ctx.stroke();
        
        // Draw line
        ctx.strokeStyle = '#28a745';
        ctx.lineWidth = 2;
        ctx.beginPath();
        
        months.forEach((month, index) => {
            const x = margin + (index / (months.length - 1)) * chartWidth;
            const y = height - margin - (data[month] / maxValue) * chartHeight;
            
            if(index === 0) {
                ctx.moveTo(x, y);
            } else {
                ctx.lineTo(x, y);
            }
            
            // Draw points
            ctx.fillStyle = '#28a745';
            ctx.beginPath();
            ctx.arc(x, y, 4, 0, 2 * Math.PI);
            ctx.fill();
        });
        
        ctx.stroke();
        
        // Labels
        ctx.fillStyle = '#333';
        ctx.font = '10px Arial';
        ctx.textAlign = 'center';
        months.forEach((month, index) => {
            const x = margin + (index / (months.length - 1)) * chartWidth;
            ctx.fillText(month, x, height - 10);
        });
    }
    
    // Event listeners
    periodFilter.onchange = filterIncome;
    categoryFilter.onchange = filterIncome;
    dateFilter.onchange = filterIncome;
    
    addBtn.onclick = () => {
        formContainer.style.display = 'block';
        form.reset();
        document.getElementById('income-date').value = new Date().toISOString().slice(0,10);
    };
    
    cancelBtn.onclick = () => {
        formContainer.style.display = 'none';
    };
    
    form.onsubmit = (e) => {
        e.preventDefault();
        
        const voucherInput = document.getElementById('income-voucher-upload');
        
        handleFileUpload(voucherInput, (voucherData) => {
            const newIncome = {
                id: 'I' + String(incomeList.length + 1).padStart(3, '0'),
                date: document.getElementById('income-date').value,
                category: document.getElementById('income-category').value,
                studentName: document.getElementById('income-student-name').value,
                studentId: document.getElementById('income-student-id').value,
                amount: parseFloat(document.getElementById('income-amount').value),
                payment: document.getElementById('income-payment').value,
                receipt: document.getElementById('income-receipt').value,
                voucher: voucherData,
                description: document.getElementById('income-description').value
            };
            
            incomeList.push(newIncome);
            localStorage.setItem('incomeList', JSON.stringify(incomeList));
            formContainer.style.display = 'none';
            filterIncome();
            
            if (voucherData) {
                alert('✅ Income saved with receipt/invoice uploaded successfully!');
            } else {
                alert('💡 Income saved. You can optionally upload receipts/invoices for better record keeping.');
            }
        });
    };
    
    generateReportBtn.onclick = () => {
        generateIncomeReport(currentIncome);
    };
    
    // Initial load
    filterIncome();
}

// ---------- Embedded Modal Functions ----------
function showFeedbackModal() {
    const modal = document.getElementById('feedback-modal');
    const modalBody = document.getElementById('feedback-modal-body');
    
    modalBody.innerHTML = `
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px;">
            <div style="max-width: 1200px; margin: 0 auto;">
                <div style="text-align: center; color: white; margin-bottom: 30px;">
                    <h1 style="font-size: 2.5rem; margin-bottom: 10px;">Hostel Feedback & Reviews</h1>
                    <p>Share your experience and help us improve</p>
                </div>

                <div style="background: white; padding: 30px; border-radius: 15px; margin-bottom: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
                    <h2>Write a Review</h2>
                    <form id="embedded-review-form">
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Category</label>
                            <select id="embedded-category" required style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
                                <option value="">Select Category</option>
                                <option value="food">Food Quality</option>
                                <option value="cleanliness">Cleanliness</option>
                                <option value="staff">Staff Behavior</option>
                                <option value="facilities">Facilities</option>
                                <option value="security">Security</option>
                                <option value="overall">Overall Experience</option>
                            </select>
                        </div>
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Rating</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div id="embedded-rating-stars" style="display: flex; gap: 5px;">
                                    <span class="embedded-star" data-rating="1" style="font-size: 30px; color: #ddd; cursor: pointer;">★</span>
                                    <span class="embedded-star" data-rating="2" style="font-size: 30px; color: #ddd; cursor: pointer;">★</span>
                                    <span class="embedded-star" data-rating="3" style="font-size: 30px; color: #ddd; cursor: pointer;">★</span>
                                    <span class="embedded-star" data-rating="4" style="font-size: 30px; color: #ddd; cursor: pointer;">★</span>
                                    <span class="embedded-star" data-rating="5" style="font-size: 30px; color: #ddd; cursor: pointer;">★</span>
                                </div>
                                <span id="embedded-rating-text">Select Rating</span>
                            </div>
                        </div>
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Review Title</label>
                            <input type="text" id="embedded-title" placeholder="Brief title for your review" required style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
                        </div>
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Your Review</label>
                            <textarea id="embedded-review" placeholder="Share your detailed experience..." required style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; height: 100px; resize: vertical;"></textarea>
                        </div>
                        <button type="submit" style="background: linear-gradient(45deg, #667eea, #764ba2); color: white; border: none; padding: 15px 30px; border-radius: 25px; font-size: 16px; cursor: pointer; width: 100%;">Submit Review</button>
                    </form>
                </div>

                <div id="embedded-reviews-container" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px;"></div>
            </div>
        </div>
    `;
    
    modal.style.display = 'block';
    setupEmbeddedFeedback();
}

function closeFeedbackModal() {
    document.getElementById('feedback-modal').style.display = 'none';
}

function setupEmbeddedFeedback() {
    let selectedRating = 0;
    const userRole = localStorage.getItem('userRole');
    const studentId = localStorage.getItem('studentId');
    const students = JSON.parse(localStorage.getItem('studentList') || '[]');
    const currentStudent = students.find(s => s.id === studentId);

    // Rating system
    document.querySelectorAll('.embedded-star').forEach(star => {
        star.addEventListener('click', function() {
            selectedRating = parseInt(this.dataset.rating);
            updateEmbeddedStars();
            document.getElementById('embedded-rating-text').textContent = getRatingText(selectedRating);
        });
    });

    function updateEmbeddedStars() {
        document.querySelectorAll('.embedded-star').forEach((star, index) => {
            star.style.color = index < selectedRating ? '#ffd700' : '#ddd';
        });
    }

    function getRatingText(rating) {
        const texts = ['', 'Poor', 'Fair', 'Good', 'Very Good', 'Excellent'];
        return texts[rating];
    }

    // Form submission
    document.getElementById('embedded-review-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (selectedRating === 0) {
            alert('Please select a rating');
            return;
        }

        const reviews = JSON.parse(localStorage.getItem('hostelReviews') || '[]');
        const newReview = {
            id: 'R' + (reviews.length + 1),
            studentId: studentId,
            studentName: currentStudent ? currentStudent.name : 'Anonymous',
            userRole: userRole,
            category: document.getElementById('embedded-category').value,
            rating: selectedRating,
            title: document.getElementById('embedded-title').value,
            review: document.getElementById('embedded-review').value,
            date: new Date().toLocaleDateString(),
            timestamp: Date.now()
        };

        reviews.push(newReview);
        localStorage.setItem('hostelReviews', JSON.stringify(reviews));
        
        this.reset();
        selectedRating = 0;
        updateEmbeddedStars();
        document.getElementById('embedded-rating-text').textContent = 'Select Rating';
        
        renderEmbeddedReviews();
        alert('Review submitted successfully!');
    });

    // Render reviews
    function renderEmbeddedReviews() {
        const reviews = JSON.parse(localStorage.getItem('hostelReviews') || '[]');
        const container = document.getElementById('embedded-reviews-container');
        
        container.innerHTML = reviews.map(review => `
            <div style="background: white; padding: 20px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); position: relative;">
                <div style="background: #667eea; color: white; padding: 4px 12px; border-radius: 15px; font-size: 12px; display: inline-block; margin-bottom: 10px;">${review.category}</div>
                <div style="flex: 1;">
                    <div style="font-weight: bold; color: #333;">${review.studentName} (${review.userRole})</div>
                    <div style="color: #666; font-size: 14px;">${review.date}</div>
                </div>
                <div style="display: flex; gap: 2px; margin: 10px 0;">
                    ${Array(5).fill().map((_, i) => `<span style="font-size: 18px; color: ${i < review.rating ? '#ffd700' : '#ddd'};">★</span>`).join('')}
                </div>
                <h4 style="margin: 10px 0; color: #333;">${review.title}</h4>
                <div style="color: #555; line-height: 1.6;">${review.review}</div>
            </div>
        `).join('');
    }

    renderEmbeddedReviews();
}

function showRulesModal() {
    const modal = document.getElementById('rules-modal');
    const modalBody = document.getElementById('rules-modal-body');
    
    modalBody.innerHTML = `
        <div style="background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4, #feca57); background-size: 400% 400%; animation: gradientShift 15s ease infinite; min-height: 100vh; padding: 20px;">
            <div style="max-width: 1000px; margin: 0 auto;">
                <div style="text-align: center; margin-bottom: 40px;">
                    <h1 style="font-size: 3rem; color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); margin-bottom: 10px;">Hostel Rules & Regulations</h1>
                    <p style="font-size: 1.2rem; color: rgba(255,255,255,0.9);">Please read and follow all rules for a harmonious living environment</p>
                </div>

                <div style="background: rgba(255,255,255,0.95); margin-bottom: 30px; border-radius: 20px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px 30px; color: white; font-size: 1.5rem; font-weight: bold; text-align: center;">
                        🏠 General Rules
                    </div>
                    <div style="padding: 30px;">
                        <div style="display: flex; align-items: flex-start; margin-bottom: 20px; padding: 15px; background: rgba(255,255,255,0.7); border-radius: 10px; border-left: 5px solid #667eea;">
                            <div style="background: linear-gradient(45deg, #667eea, #764ba2); color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 15px; flex-shrink: 0;">1</div>
                            <div style="flex: 1; color: #333; line-height: 1.6;">All residents must carry their ID cards at all times within the hostel premises.</div>
                        </div>
                        <div style="display: flex; align-items: flex-start; margin-bottom: 20px; padding: 15px; background: rgba(255,255,255,0.7); border-radius: 10px; border-left: 5px solid #667eea;">
                            <div style="background: linear-gradient(45deg, #667eea, #764ba2); color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 15px; flex-shrink: 0;">2</div>
                            <div style="flex: 1; color: #333; line-height: 1.6;">Smoking, alcohol, and illegal substances are strictly prohibited in the hostel.</div>
                        </div>
                        <div style="display: flex; align-items: flex-start; margin-bottom: 20px; padding: 15px; background: rgba(255,255,255,0.7); border-radius: 10px; border-left: 5px solid #667eea;">
                            <div style="background: linear-gradient(45deg, #667eea, #764ba2); color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 15px; flex-shrink: 0;">3</div>
                            <div style="flex: 1; color: #333; line-height: 1.6;">Maintain cleanliness in your room and common areas. Dispose of garbage properly.</div>
                        </div>
                        <div style="display: flex; align-items: flex-start; margin-bottom: 20px; padding: 15px; background: rgba(255,255,255,0.7); border-radius: 10px; border-left: 5px solid #667eea;">
                            <div style="background: linear-gradient(45deg, #667eea, #764ba2); color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 15px; flex-shrink: 0;">4</div>
                            <div style="flex: 1; color: #333; line-height: 1.6;">Respect fellow residents and maintain a peaceful environment.</div>
                        </div>
                    </div>
                </div>

                <div style="background: rgba(255,255,255,0.95); margin-bottom: 30px; border-radius: 20px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
                    <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 20px 30px; color: white; font-size: 1.5rem; font-weight: bold; text-align: center;">
                        ⏰ Timing Rules
                    </div>
                    <div style="padding: 30px;">
                        <div style="display: flex; align-items: flex-start; margin-bottom: 20px; padding: 15px; background: rgba(255,255,255,0.7); border-radius: 10px; border-left: 5px solid #f5576c;">
                            <div style="background: linear-gradient(45deg, #667eea, #764ba2); color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 15px; flex-shrink: 0;">1</div>
                            <div style="flex: 1; color: #333; line-height: 1.6;">Hostel gates close at 10:00 PM on weekdays and 11:00 PM on weekends.</div>
                        </div>
                        <div style="display: flex; align-items: flex-start; margin-bottom: 20px; padding: 15px; background: rgba(255,255,255,0.7); border-radius: 10px; border-left: 5px solid #f5576c;">
                            <div style="background: linear-gradient(45deg, #667eea, #764ba2); color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 15px; flex-shrink: 0;">2</div>
                            <div style="flex: 1; color: #333; line-height: 1.6;">Breakfast: 7:00 AM - 9:00 AM | Lunch: 12:00 PM - 2:00 PM | Dinner: 7:00 PM - 9:00 PM</div>
                        </div>
                        <div style="display: flex; align-items: flex-start; margin-bottom: 20px; padding: 15px; background: rgba(255,255,255,0.7); border-radius: 10px; border-left: 5px solid #f5576c;">
                            <div style="background: linear-gradient(45deg, #667eea, #764ba2); color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 15px; flex-shrink: 0;">3</div>
                            <div style="flex: 1; color: #333; line-height: 1.6;">Study hours: 6:00 PM - 10:00 PM (maintain silence in corridors and rooms).</div>
                        </div>
                        <div style="display: flex; align-items: flex-start; margin-bottom: 20px; padding: 15px; background: rgba(255,255,255,0.7); border-radius: 10px; border-left: 5px solid #f5576c;">
                            <div style="background: linear-gradient(45deg, #667eea, #764ba2); color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 15px; flex-shrink: 0;">4</div>
                            <div style="flex: 1; color: #333; line-height: 1.6;">Lights out at 11:00 PM on weekdays and 12:00 AM on weekends.</div>
                        </div>
                    </div>
                </div>

                <div style="background: linear-gradient(45deg, #ffd89b 0%, #19547b 100%); color: white; padding: 20px; border-radius: 15px; text-align: center; margin: 30px 0;">
                    <h3 style="margin-bottom: 10px;">⚠️ Important Notice</h3>
                    <p>Violation of any rules may result in warnings, fines, or termination of hostel accommodation. Serious violations will be reported to college authorities and parents.</p>
                </div>

                <div style="text-align: center; margin-top: 40px; color: white;">
                    <p style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px;">For any clarifications or concerns regarding these rules, please contact the Hostel Warden or Administration Office.</p>
                </div>
            </div>
        </div>
        <style>
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        </style>
    `;
    
    modal.style.display = 'block';
}

function closeRulesModal() {
    document.getElementById('rules-modal').style.display = 'none';
}

function showLocationModal() {
    const modal = document.getElementById('location-modal');
    const modalBody = document.getElementById('location-modal-body');
    
    modalBody.innerHTML = `
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px;">
            <div style="max-width: 1200px; margin: 0 auto;">
                <div style="text-align: center; color: white; margin-bottom: 30px;">
                    <h1 style="font-size: 2.5rem; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">📍 Al Fizaa Girls Hostel</h1>
                    <p style="font-size: 1.2rem; opacity: 0.9;">Location & Contact Information</p>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
                    <div style="background: rgba(255,255,255,0.95); padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
                        <h3 style="color: #333; margin-bottom: 20px; font-size: 1.5rem; display: flex; align-items: center; gap: 10px;">
                            <i style="color: #667eea; font-size: 1.8rem;">📞</i> Contact Numbers
                        </h3>
                        <div style="margin-bottom: 15px; padding: 15px; background: rgba(103, 126, 234, 0.1); border-radius: 10px; border-left: 4px solid #667eea;">
                            <strong style="color: #333; display: block; margin-bottom: 5px;">Primary Contact:</strong>
                            <a href="tel:03445436905" style="color: #667eea; font-weight: bold; text-decoration: none;">0344-5436905</a>
                        </div>
                        <div style="margin-bottom: 15px; padding: 15px; background: rgba(103, 126, 234, 0.1); border-radius: 10px; border-left: 4px solid #667eea;">
                            <strong style="color: #333; display: block; margin-bottom: 5px;">Secondary Contact:</strong>
                            <a href="tel:03554775037" style="color: #667eea; font-weight: bold; text-decoration: none;">0355-4775037</a>
                        </div>
                        <div style="margin-bottom: 15px; padding: 15px; background: rgba(103, 126, 234, 0.1); border-radius: 10px; border-left: 4px solid #667eea;">
                            <strong style="color: #333; display: block; margin-bottom: 5px;">Alternative Contact:</strong>
                            <a href="tel:03555028535" style="color: #667eea; font-weight: bold; text-decoration: none;">0355-5028535</a>
                        </div>
                        <div style="margin-bottom: 15px; padding: 15px; background: rgba(103, 126, 234, 0.1); border-radius: 10px; border-left: 4px solid #667eea;">
                            <strong style="color: #333; display: block; margin-bottom: 5px;">Emergency Contact:</strong>
                            <a href="tel:03411666480" style="color: #667eea; font-weight: bold; text-decoration: none;">03411-666480</a>
                        </div>
                    </div>

                    <div style="background: rgba(255,255,255,0.95); padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
                        <h3 style="color: #333; margin-bottom: 20px; font-size: 1.5rem; display: flex; align-items: center; gap: 10px;">
                            <i style="color: #667eea; font-size: 1.8rem;">📍</i> Address
                        </h3>
                        <div style="margin-bottom: 15px; padding: 15px; background: rgba(103, 126, 234, 0.1); border-radius: 10px; border-left: 4px solid #667eea;">
                            <strong style="color: #333; display: block; margin-bottom: 5px;">Full Address:</strong>
                            <span style="color: #555;">Al Fizaa Girls Hostel, adjacent to Old. Dr. Syeda Clinic, Abbas Town, Pareshan Chowk, Hassan Sadpara Chowk, IG Ashraf Shaheed Road, Skardu Baltistan, Pakistan</span>
                        </div>
                        <div style="margin-bottom: 15px; padding: 15px; background: rgba(103, 126, 234, 0.1); border-radius: 10px; border-left: 4px solid #667eea;">
                            <strong style="color: #333; display: block; margin-bottom: 5px;">City:</strong>
                            <span style="color: #555;">Skardu, Baltistan</span>
                        </div>
                        <div style="margin-bottom: 15px; padding: 15px; background: rgba(103, 126, 234, 0.1); border-radius: 10px; border-left: 4px solid #667eea;">
                            <strong style="color: #333; display: block; margin-bottom: 5px;">Country:</strong>
                            <span style="color: #555;">Pakistan</span>
                        </div>
                        <a href="https://www.google.com/maps/@35.281053,75.6450069,21z?entry=ttu&g_ep=EgoyMDI1MDgyNS4wIKXMDSoASAFQAw%3D%3D" target="_blank" style="display: inline-block; margin-top: 15px; padding: 12px 25px; background: linear-gradient(45deg, #667eea, #764ba2); color: white; text-decoration: none; border-radius: 25px; font-weight: bold; transition: transform 0.3s;">
                            🗺️ Get Directions
                        </a>
                    </div>
                </div>

                <div style="background: white; border-radius: 20px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
                    <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 20px; text-align: center;">
                        <h3><i style="margin-right: 10px;">🗺️</i>Hostel Location on Map</h3>
                        <p>Click on the map to open in Google Maps for detailed directions</p>
                    </div>
                    <iframe 
                        style="width: 100%; height: 400px; border: none;"
                        src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3307.123456789!2d75.6450069!3d35.281053!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x0%3A0x0!2zMzXCsDE2JzUxLjgiTiA3NcKwMzgnNDIuMCJF!5e0!3m2!1sen!2s!4v1234567890123!5m2!1sen!2s"
                        allowfullscreen="" 
                        loading="lazy" 
                        referrerpolicy="no-referrer-when-downgrade">
                    </iframe>
                </div>
            </div>
        </div>
    `;
    
    modal.style.display = 'block';
}

function closeLocationModal() {
    document.getElementById('location-modal').style.display = 'none';
}

function showFeedbackPage() {
    navigateTo('feedback-template');
}

function showRulesPage() {
    navigateTo('rules-template');
}

function showLocationPage() {
    navigateTo('location-template');
}

function setupFeedback() {
    let selectedRating = 0;
    const userRole = localStorage.getItem('userRole');
    const studentId = localStorage.getItem('studentId');
    const students = JSON.parse(localStorage.getItem('studentList') || '[]');
    const currentStudent = students.find(s => s.id === studentId);

    document.querySelectorAll('.star').forEach(star => {
        star.addEventListener('click', function() {
            selectedRating = parseInt(this.dataset.rating);
            document.querySelectorAll('.star').forEach((s, index) => {
                s.style.color = index < selectedRating ? '#ffd700' : '#ddd';
            });
            document.getElementById('rating-text').textContent = ['', 'Poor', 'Fair', 'Good', 'Very Good', 'Excellent'][selectedRating];
        });
    });

    document.getElementById('review-form').addEventListener('submit', function(e) {
        e.preventDefault();
        if (selectedRating === 0) {
            alert('Please select a rating');
            return;
        }
        const reviews = JSON.parse(localStorage.getItem('hostelReviews') || '[]');
        const newReview = {
            id: 'R' + (reviews.length + 1),
            studentId: studentId,
            studentName: currentStudent ? currentStudent.name : 'Anonymous',
            userRole: userRole,
            category: document.getElementById('category').value,
            rating: selectedRating,
            title: document.getElementById('title').value,
            review: document.getElementById('review').value,
            date: new Date().toLocaleDateString(),
            timestamp: Date.now()
        };
        reviews.push(newReview);
        localStorage.setItem('hostelReviews', JSON.stringify(reviews));
        this.reset();
        selectedRating = 0;
        document.querySelectorAll('.star').forEach(s => s.style.color = '#ddd');
        document.getElementById('rating-text').textContent = 'Select Rating';
        renderReviews();
        alert('Review submitted successfully!');
    });

    function renderReviews() {
        const reviews = JSON.parse(localStorage.getItem('hostelReviews') || '[]');
        const container = document.getElementById('reviews-container');
        container.innerHTML = reviews.map(review => `
            <div style="background: white; padding: 20px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
                <div style="background: #667eea; color: white; padding: 4px 12px; border-radius: 15px; font-size: 12px; display: inline-block; margin-bottom: 10px;">${review.category}</div>
                <div style="font-weight: bold; color: #333;">${review.studentName} (${review.userRole})</div>
                <div style="color: #666; font-size: 14px;">${review.date}</div>
                <div style="display: flex; gap: 2px; margin: 10px 0;">
                    ${Array(5).fill().map((_, i) => `<span style="font-size: 18px; color: ${i < review.rating ? '#ffd700' : '#ddd'};">★</span>`).join('')}
                </div>
                <h4 style="margin: 10px 0; color: #333;">${review.title}</h4>
                <div style="color: #555; line-height: 1.6;">${review.review}</div>
            </div>
        `).join('');
    }
    renderReviews();
}

function setupRules() {
    // Rules page is static, no setup needed
}

function setupLocation() {
    // Location template is already styled inline, no additional setup needed
}

function generateIncomeReport(income) {
    const total = income.reduce((sum, i) => sum + i.amount, 0);
    const categoryTotals = {};
    income.forEach(i => {
        categoryTotals[i.category] = (categoryTotals[i.category] || 0) + i.amount;
    });
    
    let report = `GIRLS HOSTEL INCOME REPORT\n`;
    report += `Generated on: ${new Date().toLocaleDateString()}\n\n`;
    report += `SUMMARY:\n`;
    report += `Total Income: PKR ${total.toLocaleString()}\n`;
    report += `Number of Entries: ${income.length}\n\n`;
    report += `CATEGORY BREAKDOWN:\n`;
    Object.entries(categoryTotals).forEach(([cat, amt]) => {
        const percentage = ((amt / total) * 100).toFixed(1);
        const categoryName = {
            admission: 'Admission Fee',
            security: 'Security Fee',
            monthly: 'Monthly Fee',
            chanda: 'Chanda',
            boxes: 'Boxes',
            bhef: 'BHEF',
            donation: 'Donation',
            other: 'Other'
        }[cat] || cat;
        report += `${categoryName}: PKR ${amt.toLocaleString()} (${percentage}%)\n`;
    });
    
    const blob = new Blob([report], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'income_report.txt';
    a.click();
    URL.revokeObjectURL(url);
}

// ---------- Financial Report ----------
function setupFinancialReport() {
    // Guest mode: Show empty financial report with notification
    if (isGuestMode()) {
        const reportContent = document.querySelector('#financial-report-content, .financial-report-content');
        if (reportContent) {
            reportContent.innerHTML = '';
            reportContent.appendChild(showGuestNotification("Financial report data is not available in guest mode."));
        }
        return;
    }
    
    const incomeList = JSON.parse(localStorage.getItem('incomeList') || '[]');
    const expenseList = JSON.parse(localStorage.getItem('expenseList') || '[]');
    
    const periodFilter = document.getElementById('report-period-filter');
    const startDateFilter = document.getElementById('report-start-date');
    const endDateFilter = document.getElementById('report-end-date');
    const refreshBtn = document.getElementById('refresh-report-btn');
    const exportBtn = document.getElementById('export-financial-report-btn');
    
    function getFilteredData() {
        const period = periodFilter.value;
        const startDate = startDateFilter.value;
        const endDate = endDateFilter.value;
        const now = new Date();
        
        let filteredIncome = incomeList;
        let filteredExpense = expenseList;
        
        if(period === 'monthly') {
            filteredIncome = incomeList.filter(i => {
                const d = new Date(i.date);
                return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
            });
            filteredExpense = expenseList.filter(e => {
                const d = new Date(e.date);
                return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
            });
        } else if(period === 'quarterly') {
            const quarter = Math.floor(now.getMonth() / 3);
            filteredIncome = incomeList.filter(i => {
                const d = new Date(i.date);
                return Math.floor(d.getMonth() / 3) === quarter && d.getFullYear() === now.getFullYear();
            });
            filteredExpense = expenseList.filter(e => {
                const d = new Date(e.date);
                return Math.floor(d.getMonth() / 3) === quarter && d.getFullYear() === now.getFullYear();
            });
        } else if(period === 'yearly') {
            filteredIncome = incomeList.filter(i => new Date(i.date).getFullYear() === now.getFullYear());
            filteredExpense = expenseList.filter(e => new Date(e.date).getFullYear() === now.getFullYear());
        } else if(period === 'custom' && startDate && endDate) {
            filteredIncome = incomeList.filter(i => i.date >= startDate && i.date <= endDate);
            filteredExpense = expenseList.filter(e => e.date >= startDate && e.date <= endDate);
        }
        
        return { income: filteredIncome, expense: filteredExpense };
    }
    
    function updateFinancialSummary(income, expense) {
        const totalRevenue = income.reduce((sum, i) => sum + i.amount, 0);
        const totalExpenses = expense.reduce((sum, e) => sum + e.amount, 0);
        const netProfit = totalRevenue - totalExpenses;
        const profitMargin = totalRevenue > 0 ? ((netProfit / totalRevenue) * 100).toFixed(1) : 0;
        
        document.getElementById('total-revenue').textContent = `PKR ${totalRevenue.toLocaleString()}`;
        document.getElementById('total-expenses').textContent = `PKR ${totalExpenses.toLocaleString()}`;
        document.getElementById('net-profit').textContent = `PKR ${netProfit.toLocaleString()}`;
        document.getElementById('cash-flow').textContent = `PKR ${netProfit.toLocaleString()}`;
        document.getElementById('profit-margin').textContent = `${profitMargin}% margin`;
        document.getElementById('flow-status').textContent = netProfit >= 0 ? 'Positive' : 'Negative';
        
        // Update detailed analysis
        const monthlyIncome = totalRevenue / 12;
        const monthlyExpense = totalExpenses / 12;
        const expenseRatio = totalRevenue > 0 ? ((totalExpenses / totalRevenue) * 100).toFixed(1) : 0;
        
        document.getElementById('avg-monthly-income').textContent = `PKR ${Math.round(monthlyIncome).toLocaleString()}`;
        document.getElementById('avg-monthly-expense').textContent = `PKR ${Math.round(monthlyExpense).toLocaleString()}`;
        document.getElementById('expense-ratio').textContent = `${expenseRatio}%`;
        
        // Find highest income month
        const monthlyData = {};
        income.forEach(i => {
            const month = new Date(i.date).toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
            monthlyData[month] = (monthlyData[month] || 0) + i.amount;
        });
        const highestMonth = Object.keys(monthlyData).reduce((a, b) => monthlyData[a] > monthlyData[b] ? a : b, 'N/A');
        document.getElementById('highest-income-month').textContent = highestMonth;
    }
    
    function drawGradientBarChart(ctx, data, width, height, colors) {
        ctx.clearRect(0, 0, width, height);
        
        const margin = 50;
        const chartWidth = width - 2 * margin;
        const chartHeight = height - 2 * margin;
        
        const months = Object.keys(data).sort();
        const maxValue = Math.max(...Object.values(data));
        const barWidth = chartWidth / months.length * 0.8;
        
        months.forEach((month, index) => {
            const barHeight = (data[month] / maxValue) * chartHeight;
            const x = margin + (index * chartWidth / months.length) + (chartWidth / months.length - barWidth) / 2;
            const y = height - margin - barHeight;
            
            // Create gradient
            const gradient = ctx.createLinearGradient(0, y, 0, y + barHeight);
            gradient.addColorStop(0, colors[0]);
            gradient.addColorStop(1, colors[1]);
            
            ctx.fillStyle = gradient;
            ctx.fillRect(x, y, barWidth, barHeight);
            
            // Add shadow
            ctx.shadowColor = 'rgba(0,0,0,0.2)';
            ctx.shadowBlur = 10;
            ctx.shadowOffsetY = 5;
            
            // Labels
            ctx.fillStyle = '#333';
            ctx.font = '12px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(month, x + barWidth/2, height - 10);
            ctx.fillText(`${(data[month]/1000).toFixed(0)}K`, x + barWidth/2, y - 10);
            
            ctx.shadowColor = 'transparent';
        });
    }
    
    function drawCashFlowChart(income, expense) {
        const canvas = document.getElementById('cashflow-chart');
        const ctx = canvas.getContext('2d');
        
        // Prepare monthly data
        const monthlyIncome = {};
        const monthlyExpense = {};
        
        income.forEach(i => {
            const month = i.date.slice(0, 7);
            monthlyIncome[month] = (monthlyIncome[month] || 0) + i.amount;
        });
        
        expense.forEach(e => {
            const month = e.date.slice(0, 7);
            monthlyExpense[month] = (monthlyExpense[month] || 0) + e.amount;
        });
        
        const allMonths = [...new Set([...Object.keys(monthlyIncome), ...Object.keys(monthlyExpense)])].sort();
        const cashFlow = {};
        
        allMonths.forEach(month => {
            cashFlow[month] = (monthlyIncome[month] || 0) - (monthlyExpense[month] || 0);
        });
        
        drawGradientBarChart(ctx, cashFlow, canvas.width, canvas.height, ['#28a745', '#20c997']);
    }
    
    function drawComparisonChart(income, expense) {
        const canvas = document.getElementById('comparison-chart');
        const ctx = canvas.getContext('2d');
        
        const monthlyIncome = {};
        const monthlyExpense = {};
        
        income.forEach(i => {
            const month = i.date.slice(0, 7);
            monthlyIncome[month] = (monthlyIncome[month] || 0) + i.amount;
        });
        
        expense.forEach(e => {
            const month = e.date.slice(0, 7);
            monthlyExpense[month] = (monthlyExpense[month] || 0) + e.amount;
        });
        
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        const margin = 50;
        const chartWidth = canvas.width - 2 * margin;
        const chartHeight = canvas.height - 2 * margin;
        
        const months = [...new Set([...Object.keys(monthlyIncome), ...Object.keys(monthlyExpense)])].sort();
        const maxValue = Math.max(...months.map(m => Math.max(monthlyIncome[m] || 0, monthlyExpense[m] || 0)));
        
        // Draw income line
        ctx.strokeStyle = '#28a745';
        ctx.lineWidth = 3;
        ctx.beginPath();
        
        months.forEach((month, index) => {
            const x = margin + (index / (months.length - 1)) * chartWidth;
            const y = canvas.height - margin - ((monthlyIncome[month] || 0) / maxValue) * chartHeight;
            
            if(index === 0) ctx.moveTo(x, y);
            else ctx.lineTo(x, y);
            
            // Draw points with gradient
            const gradient = ctx.createRadialGradient(x, y, 0, x, y, 8);
            gradient.addColorStop(0, '#28a745');
            gradient.addColorStop(1, '#20c997');
            
            ctx.fillStyle = gradient;
            ctx.beginPath();
            ctx.arc(x, y, 6, 0, 2 * Math.PI);
            ctx.fill();
        });
        ctx.stroke();
        
        // Draw expense line
        ctx.strokeStyle = '#dc3545';
        ctx.lineWidth = 3;
        ctx.beginPath();
        
        months.forEach((month, index) => {
            const x = margin + (index / (months.length - 1)) * chartWidth;
            const y = canvas.height - margin - ((monthlyExpense[month] || 0) / maxValue) * chartHeight;
            
            if(index === 0) ctx.moveTo(x, y);
            else ctx.lineTo(x, y);
            
            // Draw points with gradient
            const gradient = ctx.createRadialGradient(x, y, 0, x, y, 8);
            gradient.addColorStop(0, '#dc3545');
            gradient.addColorStop(1, '#fd7e14');
            
            ctx.fillStyle = gradient;
            ctx.beginPath();
            ctx.arc(x, y, 6, 0, 2 * Math.PI);
            ctx.fill();
        });
        ctx.stroke();
        
        // Add legend
        ctx.fillStyle = '#28a745';
        ctx.fillRect(20, 20, 15, 15);
        ctx.fillStyle = '#333';
        ctx.font = '12px Arial';
        ctx.fillText('Income', 40, 32);
        
        ctx.fillStyle = '#dc3545';
        ctx.fillRect(20, 40, 15, 15);
        ctx.fillStyle = '#333';
        ctx.fillText('Expense', 40, 52);
    }
    
    function updateProfitLossStatement(income, expense) {
        const tbody = document.getElementById('profit-loss-tbody');
        
        const totalIncome = income.reduce((sum, i) => sum + i.amount, 0);
        const totalExpense = expense.reduce((sum, e) => sum + e.amount, 0);
        const netProfit = totalIncome - totalExpense;
        
        tbody.innerHTML = `
            <tr>
                <td><strong>Total Revenue</strong></td>
                <td style="color:#28a745;font-weight:600;">PKR ${totalIncome.toLocaleString()}</td>
                <td>PKR ${Math.round(totalIncome * 0.9).toLocaleString()}</td>
                <td style="color:#28a745;">+PKR ${Math.round(totalIncome * 0.1).toLocaleString()}</td>
                <td style="color:#28a745;">+11.1%</td>
            </tr>
            <tr>
                <td><strong>Total Expenses</strong></td>
                <td style="color:#dc3545;font-weight:600;">PKR ${totalExpense.toLocaleString()}</td>
                <td>PKR ${Math.round(totalExpense * 0.85).toLocaleString()}</td>
                <td style="color:#dc3545;">+PKR ${Math.round(totalExpense * 0.15).toLocaleString()}</td>
                <td style="color:#dc3545;">+17.6%</td>
            </tr>
            <tr style="background:#f8f9fa;font-weight:600;">
                <td><strong>Net Profit/Loss</strong></td>
                <td style="color:${netProfit >= 0 ? '#28a745' : '#dc3545'};font-weight:700;">PKR ${netProfit.toLocaleString()}</td>
                <td>PKR ${Math.round((totalIncome * 0.9) - (totalExpense * 0.85)).toLocaleString()}</td>
                <td style="color:${netProfit >= 0 ? '#28a745' : '#dc3545'};">PKR ${Math.round(netProfit - ((totalIncome * 0.9) - (totalExpense * 0.85))).toLocaleString()}</td>
                <td style="color:${netProfit >= 0 ? '#28a745' : '#dc3545'};">+5.2%</td>
            </tr>
        `;
    }
    
    function refreshReport() {
        const { income, expense } = getFilteredData();
        updateFinancialSummary(income, expense);
        drawCashFlowChart(income, expense);
        drawComparisonChart(income, expense);
        updateProfitLossStatement(income, expense);
    }
    
    // Event listeners
    refreshBtn.onclick = refreshReport;
    periodFilter.onchange = refreshReport;
    
    exportBtn.onclick = () => {
        const { income, expense } = getFilteredData();
        const totalIncome = income.reduce((sum, i) => sum + i.amount, 0);
        const totalExpense = expense.reduce((sum, e) => sum + e.amount, 0);
        const netProfit = totalIncome - totalExpense;
        
        let report = `COMPREHENSIVE FINANCIAL REPORT\n`;
        report += `Generated on: ${new Date().toLocaleDateString()}\n\n`;
        report += `EXECUTIVE SUMMARY:\n`;
        report += `Total Revenue: PKR ${totalIncome.toLocaleString()}\n`;
        report += `Total Expenses: PKR ${totalExpense.toLocaleString()}\n`;
        report += `Net Profit/Loss: PKR ${netProfit.toLocaleString()}\n`;
        report += `Profit Margin: ${totalIncome > 0 ? ((netProfit/totalIncome)*100).toFixed(1) : 0}%\n\n`;
        
        const blob = new Blob([report], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'financial_report.txt';
        a.click();
        URL.revokeObjectURL(url);
    };
    
    // Initial load
    refreshReport();
}

// ---------- Taza Khabar ----------
function setupTazaKhabar() {
    const newsList = JSON.parse(localStorage.getItem('newsList') || '[]');
    const tbody = document.getElementById('news-tbody');
    const searchInput = document.getElementById('news-search');
    const statusFilter = document.getElementById('news-status-filter');
    const addBtn = document.getElementById('add-news-btn');
    const formContainer = document.getElementById('news-form-container');
    const form = document.getElementById('news-form');
    const cancelBtn = document.getElementById('cancel-news-btn');
    
    function renderTable(news) {
        tbody.innerHTML = '';
        news.forEach(item => {
            const statusClass = item.status === 'paid' ? 'status-paid' : 'status-overdue';
            tbody.innerHTML += `
                <tr>
                    <td>${item.date}</td>
                    <td>${item.time}</td>
                    <td>${item.description}</td>
                    <td>${item.purchasedBy}</td>
                    <td>${item.remarks || '-'}</td>
                    <td><span class="status-tag ${statusClass}">${item.status.toUpperCase()}</span></td>
                </tr>
            `;
        });
    }
    
    function filterNews() {
        const searchTerm = searchInput.value.toLowerCase();
        const statusValue = statusFilter.value;
        
        let filtered = newsList;
        
        if(searchTerm) {
            filtered = filtered.filter(item => 
                item.description.toLowerCase().includes(searchTerm) ||
                item.purchasedBy.toLowerCase().includes(searchTerm)
            );
        }
        
        if(statusValue !== 'all') {
            filtered = filtered.filter(item => item.status === statusValue);
        }
        
        renderTable(filtered);
    }
    
    // Initial render
    renderTable(newsList);
    
    // Event listeners
    searchInput.oninput = filterNews;
    statusFilter.onchange = filterNews;
    
    addBtn.onclick = () => {
        formContainer.style.display = 'block';
        form.reset();
        document.getElementById('news-date').value = new Date().toISOString().slice(0,10);
        document.getElementById('news-time').value = new Date().toTimeString().slice(0,5);
    };
    
    cancelBtn.onclick = () => {
        formContainer.style.display = 'none';
    };
    
    form.onsubmit = (e) => {
        e.preventDefault();
        const newEntry = {
            id: 'N' + String(newsList.length + 1).padStart(3, '0'),
            date: document.getElementById('news-date').value,
            time: document.getElementById('news-time').value,
            description: document.getElementById('news-description').value,
            purchasedBy: document.getElementById('news-purchased-by').value,
            remarks: document.getElementById('news-remarks').value,
            status: document.getElementById('news-status').value
        };
        
        newsList.push(newEntry);
        localStorage.setItem('newsList', JSON.stringify(newsList));
        formContainer.style.display = 'none';
        renderTable(newsList);
    };
}

// Show Mess Menu
function showMessMenu() {
    const messMenuContent = `
        <div style="max-width:600px;margin:0 auto;">
            <h3 style="text-align:center;color:#333;margin-bottom:20px;">Weekly Mess Menu</h3>
            
            <div style="background:linear-gradient(135deg,#ff6b6b,#ee5a24);color:white;padding:15px;border-radius:10px;margin-bottom:15px;">
                <h4>Monday</h4>
                <p><strong>Breakfast:</strong> Paratha, Omelette, Tea</p>
                <p><strong>Lunch:</strong> Rice, Dal, Chicken Curry, Salad</p>
                <p><strong>Dinner:</strong> Roti, Vegetable, Yogurt</p>
            </div>
            
            <div style="background:linear-gradient(135deg,#3742fa,#2f3542);color:white;padding:15px;border-radius:10px;margin-bottom:15px;">
                <h4>Tuesday</h4>
                <p><strong>Breakfast:</strong> Toast, Jam, Milk Tea</p>
                <p><strong>Lunch:</strong> Biryani, Raita, Pickle</p>
                <p><strong>Dinner:</strong> Chapati, Lentils, Vegetables</p>
            </div>
            
            <div style="background:linear-gradient(135deg,#28a745,#20c997);color:white;padding:15px;border-radius:10px;margin-bottom:15px;">
                <h4>Wednesday</h4>
                <p><strong>Breakfast:</strong> Halwa Puri, Chana, Tea</p>
                <p><strong>Lunch:</strong> Rice, Fish Curry, Dal</p>
                <p><strong>Dinner:</strong> Roti, Mixed Vegetables, Lassi</p>
            </div>
            
            <div style="background:linear-gradient(135deg,#ffc107,#fd7e14);color:white;padding:15px;border-radius:10px;margin-bottom:15px;">
                <h4>Thursday</h4>
                <p><strong>Breakfast:</strong> Paratha, Aloo Sabzi, Tea</p>
                <p><strong>Lunch:</strong> Pulao, Chicken Karahi, Salad</p>
                <p><strong>Dinner:</strong> Chapati, Dal Mash, Pickle</p>
            </div>
            
            <div style="background:linear-gradient(135deg,#6f42c1,#e83e8c);color:white;padding:15px;border-radius:10px;margin-bottom:15px;">
                <h4>Friday</h4>
                <p><strong>Breakfast:</strong> Naan, Channay, Tea</p>
                <p><strong>Lunch:</strong> Rice, Mutton Curry, Raita</p>
                <p><strong>Dinner:</strong> Roti, Palak, Yogurt</p>
            </div>
            
            <div style="background:linear-gradient(135deg,#17a2b8,#6c757d);color:white;padding:15px;border-radius:10px;margin-bottom:15px;">
                <h4>Saturday</h4>
                <p><strong>Breakfast:</strong> Paratha, Qeema, Tea</p>
                <p><strong>Lunch:</strong> Biryani, Chicken, Salad</p>
                <p><strong>Dinner:</strong> Chapati, Mixed Dal, Vegetables</p>
            </div>
            
            <div style="background:linear-gradient(135deg,#dc3545,#fd7e14);color:white;padding:15px;border-radius:10px;margin-bottom:15px;">
                <h4>Sunday</h4>
                <p><strong>Breakfast:</strong> Toast, Butter, Milk Tea</p>
                <p><strong>Lunch:</strong> Rice, Beef Curry, Dal</p>
                <p><strong>Dinner:</strong> Roti, Seasonal Vegetables, Lassi</p>
            </div>
            
            <div style="text-align:center;margin-top:20px;color:#666;">
                <p><em>Menu subject to change based on availability</em></p>
                <p><strong>Meal Timings:</strong> Breakfast: 7:00-9:00 AM | Lunch: 12:00-2:00 PM | Dinner: 7:00-9:00 PM</p>
            </div>
        </div>
    `;
    
    document.getElementById('modal-message').innerHTML = messMenuContent;
    document.getElementById('modal-bg').style.display = 'flex';
}

// Show Hostel Rules
function showHostelRules() {
    const rulesContent = `
        <div style="max-width:600px;margin:0 auto;">
            <h3 style="text-align:center;color:#333;margin-bottom:20px;">Hostel Rules & Regulations</h3>
            
            <div style="background:linear-gradient(135deg,#3742fa,#2f3542);color:white;padding:15px;border-radius:10px;margin-bottom:15px;">
                <h4><i class="fas fa-clock"></i> Timing Rules</h4>
                <ul style="margin:10px 0;padding-left:20px;">
                    <li>Hostel gates close at 10:00 PM sharp</li>
                    <li>No entry allowed after 10:00 PM without prior permission</li>
                    <li>Wake up time: 6:00 AM</li>
                    <li>Study hours: 8:00 PM - 10:00 PM (Mandatory)</li>
                </ul>
            </div>
            
            <div style="background:linear-gradient(135deg,#dc3545,#fd7e14);color:white;padding:15px;border-radius:10px;margin-bottom:15px;">
                <h4><i class="fas fa-ban"></i> Prohibited Items</h4>
                <ul style="margin:10px 0;padding-left:20px;">
                    <li>No smoking or tobacco products</li>
                    <li>No alcohol or drugs</li>
                    <li>No weapons or sharp objects</li>
                    <li>No cooking appliances in rooms</li>
                </ul>
            </div>
            
            <div style="background:linear-gradient(135deg,#28a745,#20c997);color:white;padding:15px;border-radius:10px;margin-bottom:15px;">
                <h4><i class="fas fa-users"></i> Visitor Policy</h4>
                <ul style="margin:10px 0;padding-left:20px;">
                    <li>Visitors allowed only between 10:00 AM - 6:00 PM</li>
                    <li>All visitors must register at reception</li>
                    <li>Maximum 2 visitors per student at a time</li>
                    <li>No overnight guests allowed</li>
                </ul>
            </div>
            
            <div style="background:linear-gradient(135deg,#ffc107,#fd7e14);color:white;padding:15px;border-radius:10px;margin-bottom:15px;">
                <h4><i class="fas fa-home"></i> Room Rules</h4>
                <ul style="margin:10px 0;padding-left:20px;">
                    <li>Keep rooms clean and tidy</li>
                    <li>No loud music after 9:00 PM</li>
                    <li>Respect roommate's privacy and belongings</li>
                    <li>Report any damages immediately</li>
                </ul>
            </div>
            
            <div style="background:linear-gradient(135deg,#6f42c1,#e83e8c);color:white;padding:15px;border-radius:10px;margin-bottom:15px;">
                <h4><i class="fas fa-exclamation-triangle"></i> Disciplinary Actions</h4>
                <ul style="margin:10px 0;padding-left:20px;">
                    <li>First violation: Written warning</li>
                    <li>Second violation: Fine of PKR 1,000</li>
                    <li>Third violation: Suspension for 1 week</li>
                    <li>Serious violations: Immediate expulsion</li>
                </ul>
            </div>
            
            <div style="text-align:center;margin-top:20px;color:#666;">
                <p><strong>Emergency Contact:</strong> 0300-1234567</p>
                <p><em>All students must follow these rules for a peaceful hostel environment</em></p>
            </div>
        </div>
    `;
    
    document.getElementById('modal-message').innerHTML = rulesContent;
    document.getElementById('modal-bg').style.display = 'flex';
}

// Show modal function
function showModal(message) {
    document.getElementById('modal-message').innerHTML = message;
    document.getElementById('modal-bg').style.display = 'flex';
}

// Close modal function - FIXED: Added missing function
window.closeModal = function() {
    const modalBg = document.getElementById('modal-bg');
    if (modalBg) {
        modalBg.style.display = 'none';
    }
    
    // Also handle any dynamically created modals
    const dynamicModals = document.querySelectorAll('[id*="modal"][style*="position:fixed"]');
    dynamicModals.forEach(modal => {
        if (modal.parentNode) {
            modal.parentNode.removeChild(modal);
        }
    });
    
    // Reset body scroll for mobile
    document.body.style.overflow = '';
    document.body.style.position = '';
};

// ---------- Privacy Control Functions ----------

// Get filtered data based on user role and permissions
function getFilteredStudentData(userRole, currentUser) {
    const allStudents = JSON.parse(localStorage.getItem('studentList') || '[]');
    
    if (userRole === 'admin') {
        return allStudents; // Admin sees all data
    } else if (userRole === 'guest') {
        // Guest sees no actual data - return empty structure for privacy
        return allStudents.map(student => ({
            id: '***',
            name: 'Guest View - Data Hidden',
            contact: '***-***-****',
            guardian: 'Privacy Protected',
            guardianContact: '***-***-****',
            roomNo: '***',
            feePaid: 0,
            totalFee: 0,
            due: 0,
            admissionDate: 'Hidden',
            sponsored: false,
            scholarship: false,
            partialSupport: false
        }));
    } else if (userRole === 'student' || userRole === 'parent') {
        // Students/Parents see only their own data
        const userStudentId = currentUser?.studentId;
        if (userStudentId) {
            const ownData = allStudents.filter(student => student.id === userStudentId);
            return ownData;
        }
        return [];
    }
    return [];
}

// Check if user can access sponsored/scholarship features
function canAccessSponsorshipFeatures(userRole, currentUser) {
    if (userRole === 'admin') return true;
    if (userRole === 'guest') return false;
    
    if (userRole === 'student' || userRole === 'parent') {
        const userStudentId = currentUser?.studentId;
        if (userStudentId) {
            const allStudents = JSON.parse(localStorage.getItem('studentList') || '[]');
            const studentData = allStudents.find(student => student.id === userStudentId);
            return studentData && (studentData.sponsored || studentData.scholarship || studentData.partialSupport);
        }
    }
    return false;
}

// Check if user can edit data
function canEditData(userRole) {
    return userRole === 'admin';
}

// Get filtered visitor data
function getFilteredVisitorData(userRole, currentUser) {
    const allVisitors = JSON.parse(localStorage.getItem('visitors') || '[]');
    
    if (userRole === 'admin') {
        return allVisitors;
    } else if (userRole === 'guest') {
        return []; // No visitor data for guests
    } else if (userRole === 'student' || userRole === 'parent') {
        const userStudentId = currentUser?.studentId;
        if (userStudentId) {
            return allVisitors.filter(visitor => visitor.studentId === userStudentId);
        }
    }
    return [];
}

// ---------- End Privacy Control Functions ----------
function setupMessMenu() {
    const userRole = localStorage.getItem('userRole');
    const editBtn = document.getElementById('edit-menu-btn');
    const viewBtn = document.getElementById('view-menu-btn');
    const controlsEl = document.getElementById('admin-mess-controls');
    
    // Hide edit controls for non-admins
    if(userRole !== 'admin') {
        controlsEl.style.display = 'none';
    }
    
    let isEditing = false;
    
    function toggleEditMode() {
        isEditing = !isEditing;
        const menuItems = document.querySelectorAll('.menu-item');
        
        if(isEditing && userRole === 'admin') {
            editBtn.textContent = 'Save Menu';
            editBtn.style.background = '#28a745';
            menuItems.forEach(item => {
                item.classList.add('editing');
                const currentText = item.textContent;
                item.innerHTML = `<input type="text" class="menu-edit-input" value="${currentText}">`;
            });
        } else {
            editBtn.textContent = 'Edit Menu';
            editBtn.style.background = '';
            menuItems.forEach(item => {
                item.classList.remove('editing');
                const input = item.querySelector('.menu-edit-input');
                if(input) {
                    item.textContent = input.value;
                    // Save to localStorage
                    const day = item.dataset.day;
                    const meal = item.dataset.meal;
                    saveMenuData(day, meal, input.value);
                }
            });
        }
    }
    
    function saveMenuData(day, meal, value) {
        let menuData = JSON.parse(localStorage.getItem('messMenu') || '{}');
        if(!menuData[day]) menuData[day] = {};
        menuData[day][meal] = value;
        localStorage.setItem('messMenu', JSON.stringify(menuData));
    }
    
    function loadMenuData() {
        const menuData = JSON.parse(localStorage.getItem('messMenu') || '{}');
        const menuItems = document.querySelectorAll('.menu-item');
        menuItems.forEach(item => {
            const day = item.dataset.day;
            const meal = item.dataset.meal;
            if(menuData[day] && menuData[day][meal]) {
                item.textContent = menuData[day][meal];
            }
        });
    }
    
    if(editBtn) editBtn.onclick = toggleEditMode;
    if(viewBtn) viewBtn.onclick = () => { isEditing = false; toggleEditMode(); };
    
    // Load saved menu data
    loadMenuData();
}

// ---------- Study Materials ----------
function setupStudyMaterials() {
    const userRole = localStorage.getItem('userRole');
    const materialsList = JSON.parse(localStorage.getItem('studyMaterials') || '[]');
    const grid = document.getElementById('materials-grid');
    const controlsEl = document.getElementById('admin-materials-controls');
    const addBtn = document.getElementById('add-material-btn');
    const formContainer = document.getElementById('material-form-container');
    const form = document.getElementById('material-form');
    const cancelBtn = document.getElementById('cancel-material-btn');
    const typeSelect = document.getElementById('material-type');
    const linkGroup = document.getElementById('link-group');
    const fileGroup = document.getElementById('file-group');
    
    if(userRole !== 'admin') {
        controlsEl.style.display = 'none';
    }
    
    function renderMaterials() {
        grid.innerHTML = '';
        materialsList.forEach(material => {
            const card = document.createElement('div');
            card.className = 'social-link-card';
            card.innerHTML = `
                <i class="fas ${material.type === 'link' ? 'fa-link' : 'fa-file'}"></i>
                <h4>${material.title}</h4>
                <p>${material.description}</p>
            `;
            if(material.type === 'link') {
                card.onclick = () => window.open(material.url, '_blank');
            } else {
                card.onclick = () => window.open(material.fileUrl, '_blank');
            }
            grid.appendChild(card);
        });
    }
    
    if(userRole === 'admin') {
        typeSelect.onchange = () => {
            if(typeSelect.value === 'link') {
                linkGroup.style.display = 'block';
                fileGroup.style.display = 'none';
            } else {
                linkGroup.style.display = 'none';
                fileGroup.style.display = 'block';
            }
        };
        
        addBtn.onclick = () => {
            formContainer.style.display = 'block';
            form.reset();
            linkGroup.style.display = 'block';
            fileGroup.style.display = 'none';
        };
        
        cancelBtn.onclick = () => {
            formContainer.style.display = 'none';
        };
        
        form.onsubmit = (e) => {
            e.preventDefault();
            const newMaterial = {
                id: 'M' + (materialsList.length + 1),
                title: document.getElementById('material-title').value,
                type: document.getElementById('material-type').value,
                description: document.getElementById('material-description').value,
                date: new Date().toISOString().slice(0, 10)
            };
            
            if(newMaterial.type === 'link') {
                newMaterial.url = document.getElementById('material-link').value;
            } else {
                const file = document.getElementById('material-file').files[0];
                if(file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        newMaterial.fileUrl = e.target.result;
                        newMaterial.fileName = file.name;
                        materialsList.push(newMaterial);
                        localStorage.setItem('studyMaterials', JSON.stringify(materialsList));
                        renderMaterials();
                        formContainer.style.display = 'none';
                    };
                    reader.readAsDataURL(file);
                    return;
                }
            }
            
            materialsList.push(newMaterial);
            localStorage.setItem('studyMaterials', JSON.stringify(materialsList));
            renderMaterials();
            formContainer.style.display = 'none';
        };
    }
    
    renderMaterials();
}

// ---------- Help Desk ----------
function setupHelpDesk() {
    const userRole = localStorage.getItem('userRole');
    const studentId = localStorage.getItem('studentId');
    const students = JSON.parse(localStorage.getItem('studentList') || '[]');
    const currentStudent = students.find(s => s.id === studentId);
    const helpRequests = JSON.parse(localStorage.getItem('helpRequests') || '[]');
    
    const tbody = document.getElementById('help-requests-tbody');
    const controlsEl = document.getElementById('student-help-controls');
    const addBtn = document.getElementById('new-help-request-btn');
    const formContainer = document.getElementById('help-form-container');
    const form = document.getElementById('help-form');
    const cancelBtn = document.getElementById('cancel-help-btn');
    const replyContainer = document.getElementById('admin-reply-container');
    const replyForm = document.getElementById('reply-form');
    const cancelReplyBtn = document.getElementById('cancel-reply-btn');
    
    let currentRequestId = null;
    
    function renderRequests() {
        tbody.innerHTML = '';
        let filteredRequests = helpRequests;
        
        if(userRole === 'student' || userRole === 'parent') {
            filteredRequests = helpRequests.filter(r => r.studentId === studentId);
            document.querySelectorAll('.admin-only-col').forEach(el => el.style.display = 'none');
        } else {
            document.querySelectorAll('.admin-only-col').forEach(el => el.style.display = 'table-cell');
        }
        
        filteredRequests.forEach(request => {
            const row = document.createElement('tr');
            if(userRole === 'admin') {
                row.style.cursor = 'pointer';
                row.onclick = () => {
                    currentRequestId = request.id;
                    document.getElementById('admin-reply').value = request.adminReply || '';
                    replyContainer.style.display = 'block';
                };
            }
            
            row.innerHTML = `
                <td>${request.id}</td>
                ${userRole === 'admin' ? `<td>${request.studentName}</td>` : ''}
                <td>${request.subject}</td>
                <td>${request.date}</td>
                <td><span class="status-tag ${request.status === 'replied' ? 'status-paid' : 'status-due'}">${request.status}</span></td>
                <td>${request.adminReply || '-'}</td>
            `;
            tbody.appendChild(row);
        });
    }
    
    addBtn.onclick = () => {
        formContainer.style.display = 'block';
        form.reset();
    };
    
    cancelBtn.onclick = () => {
        formContainer.style.display = 'none';
    };
    
    cancelReplyBtn.onclick = () => {
        replyContainer.style.display = 'none';
    };
    
    form.onsubmit = (e) => {
        e.preventDefault();
        const newRequest = {
            id: 'H' + String(helpRequests.length + 1).padStart(3, '0'),
            studentId: studentId,
            studentName: currentStudent ? currentStudent.name : 'Student',
            subject: document.getElementById('help-subject').value,
            message: document.getElementById('help-message').value,
            date: new Date().toISOString().slice(0, 10),
            status: 'pending',
            adminReply: ''
        };
        
        helpRequests.push(newRequest);
        localStorage.setItem('helpRequests', JSON.stringify(helpRequests));
        renderRequests();
        formContainer.style.display = 'none';
    };
    
    if(userRole === 'admin') {
        replyForm.onsubmit = (e) => {
            e.preventDefault();
            const request = helpRequests.find(r => r.id === currentRequestId);
            if(request) {
                request.adminReply = document.getElementById('admin-reply').value;
                request.status = 'replied';
                localStorage.setItem('helpRequests', JSON.stringify(helpRequests));
                renderRequests();
                replyContainer.style.display = 'none';
            }
        };
    } else {
        replyContainer.style.display = 'none';
    }
    
    renderRequests();
}

// ---------- Qarz Forms Management ----------
window.showQarzFormsManager = function() {
    console.log('showQarzFormsManager called'); // Debug log
    
    try {
        let qarzApplications = JSON.parse(localStorage.getItem('qarzApplications') || '[]');
        console.log('Qarz applications loaded:', qarzApplications.length); // Debug log
        
        // Add sample data if no applications exist (for testing)
        if (qarzApplications.length === 0) {
            console.log('No applications found, adding sample data for testing');
            qarzApplications = [
                {
                    id: 'QRZ001',
                    studentName: 'Aisha Khan',
                    studentId: 'AF01',
                    submissionDate: '2025-08-25',
                    submissionTime: '14:30',
                    status: 'Pending Review',
                    formData: {
                        applicantName: 'Aisha Khan',
                        deceasedFatherName: 'Mr. Abdul Khan',
                        phoneNumber: '+92300-1234567',
                        dateOfBirth: '2005-03-15',
                        district: 'Lahore',
                        residentialAddress: '123 Model Town, Lahore',
                        deservingOnly: true,
                        examLevel: 'Intermediate',
                        yearPassing: '2023',
                        boardName: 'BISE Lahore',
                        percentage: '85',
                        currentInstitution: 'University of Punjab',
                        degreeCourse: 'Computer Science',
                        accountTitle: 'Aisha Khan',
                        accountNumber: '1234567890',
                        branchDetails: 'MCB Bank, Model Town Branch, Lahore'
                    },
                    adminComments: null
                }
            ];
            // Don't save to localStorage as this is just for testing
        }
        
        // Statistics
        const totalApps = qarzApplications.length;
        const pendingApps = qarzApplications.filter(app => app.status.includes('Pending') || app.status === 'Under Review').length;
        const approvedApps = qarzApplications.filter(app => app.status === 'Approved').length;
        const rejectedApps = qarzApplications.filter(app => app.status === 'Rejected').length;
    
    const formsList = qarzApplications.length > 0 
        ? qarzApplications.map(app => {
            const statusColors = {
                'Approved': { 
                    bg: 'linear-gradient(135deg, #10b981, #059669, #047857)', 
                    border: '#10b981', 
                    text: '#ffffff', 
                    icon: '✅',
                    glow: '0 0 30px rgba(16,185,129,0.4)'
                },
                'Rejected': { 
                    bg: 'linear-gradient(135deg, #ef4444, #dc2626, #b91c1c)', 
                    border: '#ef4444', 
                    text: '#ffffff', 
                    icon: '❌',
                    glow: '0 0 30px rgba(239,68,68,0.4)'
                },
                'Under Review': { 
                    bg: 'linear-gradient(135deg, #f59e0b, #d97706, #b45309)', 
                    border: '#f59e0b', 
                    text: '#ffffff', 
                    icon: '🔍',
                    glow: '0 0 30px rgba(245,158,11,0.4)'
                },
                'Pending Review': { 
                    bg: 'linear-gradient(135deg, #3b82f6, #2563eb, #1d4ed8)', 
                    border: '#3b82f6', 
                    text: '#ffffff', 
                    icon: '⏳',
                    glow: '0 0 30px rgba(59,130,246,0.4)'
                },
                'Pending Documents': { 
                    bg: 'linear-gradient(135deg, #8b5cf6, #7c3aed, #6d28d9)', 
                    border: '#8b5cf6', 
                    text: '#ffffff', 
                    icon: '📋',
                    glow: '0 0 30px rgba(139,92,246,0.4)'
                }
            };
            
            const statusStyle = statusColors[app.status] || statusColors['Pending Review'];
            
            return `
            <div class="qarz-application-card-elegant" style="background:linear-gradient(135deg, #ffffff, #f8fafc, #e2e8f0);border-radius:20px;padding:32px;margin:28px 0;border:3px solid transparent;background-clip:padding-box;box-shadow:0 15px 35px rgba(0,0,0,0.1), 0 5px 15px rgba(0,0,0,0.08);position:relative;overflow:hidden;transition:all 0.4s cubic-bezier(0.4, 0, 0.2, 1);">
                <!-- Animated Background Pattern -->
                <div style="position:absolute;top:0;left:0;right:0;bottom:0;background:linear-gradient(45deg, rgba(99,102,241,0.05) 0%, rgba(168,85,247,0.05) 50%, rgba(236,72,153,0.05) 100%);opacity:0.6;animation:backgroundShift 6s ease-in-out infinite;z-index:1;"></div>
                
                <!-- Status Badge with Glow Effect -->
                <div style="position:absolute;top:24px;right:24px;background:${statusStyle.bg};color:${statusStyle.text};padding:12px 20px;border-radius:25px;font-weight:800;font-size:0.9rem;box-shadow:${statusStyle.glow}, 0 8px 25px rgba(0,0,0,0.15);z-index:3;animation:statusPulse 3s ease-in-out infinite;">
                    ${statusStyle.icon} ${app.status}
                </div>
                
                <!-- Decorative Elements -->
                <div style="position:absolute;top:-20px;left:-20px;width:100px;height:100px;background:linear-gradient(135deg, rgba(99,102,241,0.1), rgba(168,85,247,0.1));border-radius:50%;z-index:1;animation:float 4s ease-in-out infinite;"></div>
                <div style="position:absolute;bottom:-30px;right:-30px;width:120px;height:120px;background:linear-gradient(135deg, rgba(236,72,153,0.1), rgba(251,113,133,0.1));border-radius:50%;z-index:1;animation:float 4s ease-in-out infinite reverse;"></div>
                
                <!-- Header Section -->
                <div style="margin-bottom:28px;padding-right:180px;position:relative;z-index:2;">
                    <h3 style="margin:0 0 12px 0;color:#1f2937;font-size:1.6rem;font-weight:900;display:flex;align-items:center;gap:16px;background:linear-gradient(135deg, #6366f1, #8b5cf6, #ec4899);-webkit-background-clip:text;-webkit-text-fill-color:transparent;text-shadow:0 2px 4px rgba(0,0,0,0.1);">
                        📋 Application #${app.id}
                    </h3>
                    <div style="color:#6b7280;font-size:1rem;font-weight:600;padding:8px 16px;background:rgba(99,102,241,0.1);border-radius:12px;display:inline-block;">
                        ⏰ Submitted on ${app.submissionDate} at ${app.submissionTime}
                    </div>
                </div>
                
                <!-- Main Content Grid -->
                <div style="display:grid;grid-template-columns:2fr 1fr;gap:36px;margin-bottom:28px;position:relative;z-index:2;">
                    <!-- Student Information -->
                    <div>
                        <div style="background:linear-gradient(135deg, #f0f9ff, #e0f2fe, #b3e5fc);padding:24px;border-radius:16px;margin-bottom:24px;border:2px solid rgba(59,130,246,0.2);box-shadow:0 8px 25px rgba(59,130,246,0.1);">
                            <h4 style="margin:0 0 20px 0;color:#0f172a;font-size:1.2rem;font-weight:800;display:flex;align-items:center;gap:12px;">
                                <span style="background:linear-gradient(135deg, #3b82f6, #1d4ed8);color:white;width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:1rem;">👤</span>
                                Student Information
                            </h4>
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
                                <div style="background:rgba(255,255,255,0.8);padding:16px;border-radius:12px;backdrop-filter:blur(10px);border:1px solid rgba(59,130,246,0.2);">
                                    <span style="color:#6b7280;font-weight:700;font-size:0.85rem;text-transform:uppercase;letter-spacing:1px;">Name</span>
                                    <div style="color:#0f172a;font-weight:800;font-size:1.1rem;margin-top:4px;">${app.studentName}</div>
                                </div>
                                <div style="background:rgba(255,255,255,0.8);padding:16px;border-radius:12px;backdrop-filter:blur(10px);border:1px solid rgba(59,130,246,0.2);">
                                    <span style="color:#6b7280;font-weight:700;font-size:0.85rem;text-transform:uppercase;letter-spacing:1px;">Student ID</span>
                                    <div style="color:#0f172a;font-weight:800;font-size:1.1rem;margin-top:4px;">${app.studentId}</div>
                                </div>
                            </div>
                        </div>
                        
                        ${app.adminComments ? `
                        <div style="background:linear-gradient(135deg, #fef3c7, #fde68a, #fcd34d);padding:24px;border-radius:16px;border:2px solid rgba(245,158,11,0.3);margin-bottom:24px;box-shadow:0 8px 25px rgba(245,158,11,0.15);">
                            <h5 style="margin:0 0 16px 0;color:#92400e;font-weight:800;display:flex;align-items:center;gap:12px;font-size:1.1rem;">
                                <span style="background:linear-gradient(135deg, #f59e0b, #d97706);color:white;width:28px;height:28px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:0.9rem;">💬</span>
                                Previous Comments
                            </h5>
                            <div style="background:rgba(255,255,255,0.9);padding:20px;border-radius:12px;backdrop-filter:blur(10px);border:1px solid rgba(245,158,11,0.2);">
                                <p style="margin:0;color:#92400e;font-style:italic;line-height:1.6;font-size:1rem;">${app.adminComments}</p>
                            </div>
                        </div>
                        ` : ''}
                        
                        <!-- Action Buttons -->
                        <div style="display:flex;gap:16px;flex-wrap:wrap;">
                            <button onclick="viewQarzApplicationDetails('${app.id}')" style="background:linear-gradient(135deg, #6366f1, #8b5cf6, #ec4899);color:white;border:none;padding:16px 24px;border-radius:12px;cursor:pointer;font-weight:700;font-size:0.95rem;display:flex;align-items:center;gap:10px;transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);box-shadow:0 8px 25px rgba(99,102,241,0.3);position:relative;overflow:hidden;" onmouseover="this.style.transform='translateY(-2px) scale(1.02)';this.style.boxShadow='0 12px 35px rgba(99,102,241,0.4)'" onmouseout="this.style.transform='translateY(0) scale(1)';this.style.boxShadow='0 8px 25px rgba(99,102,241,0.3)'">
                                <span style="font-size:1.1rem;">👁️</span> View Full Details
                            </button>
                            <button onclick="downloadQarzPDF('${app.id}')" style="background:linear-gradient(135deg, #ec4899, #be185d, #9d174d);color:white;border:none;padding:16px 24px;border-radius:12px;cursor:pointer;font-weight:700;font-size:0.95rem;display:flex;align-items:center;gap:10px;transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);box-shadow:0 8px 25px rgba(236,72,153,0.3);position:relative;overflow:hidden;" onmouseover="this.style.transform='translateY(-2px) scale(1.02)';this.style.boxShadow='0 12px 35px rgba(236,72,153,0.4)'" onmouseout="this.style.transform='translateY(0) scale(1)';this.style.boxShadow='0 8px 25px rgba(236,72,153,0.3)'">
                                <span style="font-size:1.1rem;">📄</span> Download PDF
                            </button>
                        </div>
                    </div>
                    
                    <!-- Admin Actions Panel -->
                    <div style="background:linear-gradient(135deg, #f3e8ff, #e9d5ff, #ddd6fe);padding:28px;border-radius:16px;border:2px solid rgba(139,92,246,0.2);box-shadow:0 8px 25px rgba(139,92,246,0.15);position:relative;overflow:hidden;">
                        <div style="position:absolute;top:0;left:0;right:0;height:4px;background:linear-gradient(90deg, #8b5cf6, #ec4899, #f59e0b, #10b981);"></div>
                        
                        <h4 style="margin:0 0 24px 0;color:#581c87;font-size:1.2rem;font-weight:800;text-align:center;display:flex;align-items:center;justify-content:center;gap:12px;">
                            <span style="background:linear-gradient(135deg, #8b5cf6, #7c3aed);color:white;width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:1rem;">⚙️</span>
                            Admin Actions
                        </h4>
                        
                        <div style="margin-bottom:20px;">
                            <label style="display:block;margin-bottom:12px;color:#581c87;font-weight:700;font-size:0.95rem;text-transform:uppercase;letter-spacing:0.5px;">Update Status:</label>
                            <select id="status-${app.id}" style="width:100%;padding:14px;border:2px solid rgba(139,92,246,0.3);border-radius:12px;font-weight:600;background:linear-gradient(135deg, #ffffff, #faf7ff);color:#581c87;font-size:0.95rem;transition:all 0.3s ease;box-shadow:0 4px 15px rgba(139,92,246,0.1);" onfocus="this.style.borderColor='#8b5cf6';this.style.boxShadow='0 0 20px rgba(139,92,246,0.3)'" onblur="this.style.borderColor='rgba(139,92,246,0.3)';this.style.boxShadow='0 4px 15px rgba(139,92,246,0.1)'">
                                <option value="Pending Review" ${app.status === 'Pending Review' ? 'selected' : ''}>⏳ Pending Review</option>
                                <option value="Under Review" ${app.status === 'Under Review' ? 'selected' : ''}>🔍 Under Review</option>
                                <option value="Approved" ${app.status === 'Approved' ? 'selected' : ''}>✅ Approved</option>
                                <option value="Rejected" ${app.status === 'Rejected' ? 'selected' : ''}>❌ Rejected</option>
                                <option value="Pending Documents" ${app.status === 'Pending Documents' ? 'selected' : ''}>📋 Pending Documents</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom:24px;">
                            <label style="display:block;margin-bottom:12px;color:#581c87;font-weight:700;font-size:0.95rem;text-transform:uppercase;letter-spacing:0.5px;">Add Comments:</label>
                            <textarea id="comments-${app.id}" placeholder="Enter admin comments or feedback for the student..." style="width:100%;padding:14px;border:2px solid rgba(139,92,246,0.3);border-radius:12px;resize:vertical;min-height:120px;font-size:0.95rem;font-family:inherit;background:linear-gradient(135deg, #ffffff, #faf7ff);color:#581c87;transition:all 0.3s ease;box-shadow:0 4px 15px rgba(139,92,246,0.1);" onfocus="this.style.borderColor='#8b5cf6';this.style.boxShadow='0 0 20px rgba(139,92,246,0.3)'" onblur="this.style.borderColor='rgba(139,92,246,0.3)';this.style.boxShadow='0 4px 15px rgba(139,92,246,0.1)'">${app.adminComments || ''}</textarea>
                        </div>
                        
                        <button onclick="updateQarzApplication('${app.id}')" style="width:100%;background:linear-gradient(135deg, #10b981, #059669, #047857);color:white;border:none;padding:18px 24px;border-radius:12px;cursor:pointer;font-weight:800;font-size:1rem;display:flex;align-items:center;justify-content:center;gap:12px;transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);box-shadow:0 8px 25px rgba(16,185,129,0.3);position:relative;overflow:hidden;" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 12px 35px rgba(16,185,129,0.4)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 8px 25px rgba(16,185,129,0.3)'">
                            <span style="font-size:1.2rem;">💾</span> Update & Send Notification
                        </button>
                    </div>
                </div>
            </div>
            `;
        }).join('')
        : `
        <div style="text-align:center;padding:80px 40px;background:linear-gradient(135deg, #f8fafc, #e2e8f0, #dbeafe);border-radius:20px;border:3px dashed rgba(99,102,241,0.3);margin:28px 0;position:relative;overflow:hidden;">
            <div style="position:absolute;top:-50px;left:-50px;width:150px;height:150px;background:linear-gradient(135deg, rgba(99,102,241,0.1), rgba(168,85,247,0.1));border-radius:50%;animation:float 6s ease-in-out infinite;"></div>
            <div style="position:absolute;bottom:-30px;right:-30px;width:120px;height:120px;background:linear-gradient(135deg, rgba(236,72,153,0.1), rgba(251,113,133,0.1));border-radius:50%;animation:float 6s ease-in-out infinite reverse;"></div>
            
            <div style="position:relative;z-index:2;">
                <div style="font-size:5rem;margin-bottom:24px;background:linear-gradient(135deg, #6366f1, #8b5cf6, #ec4899);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">📝</div>
                <h3 style="margin:0 0 16px 0;color:#374151;font-size:1.6rem;font-weight:800;background:linear-gradient(135deg, #1f2937, #374151);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">No Applications Yet</h3>
                <p style="margin:0;font-size:1.1rem;color:#6b7280;line-height:1.6;">No Qarz-e-Hasna applications have been submitted yet.<br>Applications will appear here when students submit them.</p>
            </div>
        </div>
        `;

    showModal(`
        <div style="max-width:1400px;width:95vw;max-height:95vh;overflow-y:auto;">
            <!-- Header Section -->
            <div style="background:linear-gradient(135deg, #1e40af, #3b82f6, #6366f1, #8b5cf6, #ec4899);color:white;padding:40px;border-radius:25px 25px 0 0;margin:-20px -20px 0 -20px;position:relative;overflow:hidden;">
                <!-- Animated Background Elements -->
                <div style="position:absolute;top:-100px;right:-100px;width:300px;height:300px;background:radial-gradient(circle, rgba(255,255,255,0.15) 0%, rgba(255,255,255,0.05) 70%);border-radius:50%;animation:float 8s ease-in-out infinite;"></div>
                <div style="position:absolute;bottom:-80px;left:-80px;width:250px;height:250px;background:radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.03) 70%);border-radius:50%;animation:float 8s ease-in-out infinite reverse;"></div>
                <div style="position:absolute;top:50%;left:50%;transform:translate(-50%, -50%);width:400px;height:400px;background:radial-gradient(circle, rgba(255,255,255,0.05) 0%, transparent 70%);border-radius:50%;animation:backgroundShift 10s ease-in-out infinite;"></div>
                
                <!-- Decorative Particles -->
                <div style="position:absolute;top:20%;left:15%;width:8px;height:8px;background:rgba(255,255,255,0.6);border-radius:50%;animation:float 4s ease-in-out infinite;"></div>
                <div style="position:absolute;top:30%;right:20%;width:6px;height:6px;background:rgba(255,255,255,0.4);border-radius:50%;animation:float 6s ease-in-out infinite reverse;"></div>
                <div style="position:absolute;bottom:25%;left:25%;width:10px;height:10px;background:rgba(255,255,255,0.5);border-radius:50%;animation:float 5s ease-in-out infinite;"></div>
                
                <div style="position:relative;z-index:2;text-align:center;">
                    <div style="font-size:4.5rem;margin-bottom:20px;text-shadow:0 4px 8px rgba(0,0,0,0.3);animation:statusPulse 4s ease-in-out infinite;">📋</div>
                    <h2 style="margin:0 0 16px 0;font-size:2.5rem;font-weight:900;text-shadow:0 2px 4px rgba(0,0,0,0.3);background:linear-gradient(135deg, #ffffff, #f0f9ff);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">Qarz-e-Hasna Applications</h2>
                    <p style="margin:0;opacity:0.95;font-size:1.2rem;font-weight:600;text-shadow:0 1px 2px rgba(0,0,0,0.2);">Review, approve, and manage student financial aid applications</p>
                    <div style="margin-top:20px;padding:12px 24px;background:rgba(255,255,255,0.2);border-radius:25px;display:inline-block;backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,0.3);">
                        <span style="font-size:1rem;font-weight:700;">✨ Advanced Management System</span>
                    </div>
                </div>
            </div>
            
            <!-- Statistics Dashboard -->
            <div style="margin:32px 0;padding:32px;background:linear-gradient(135deg, #f8fafc, #e2e8f0, #dbeafe);border-radius:20px;border:3px solid rgba(99,102,241,0.2);position:relative;overflow:hidden;">
                <div style="position:absolute;top:0;left:0;right:0;height:6px;background:linear-gradient(90deg, #6366f1, #8b5cf6, #ec4899, #f59e0b, #10b981, #6366f1);animation:backgroundShift 8s ease-in-out infinite;"></div>
                
                <h3 style="margin:0 0 28px 0;color:#1f2937;font-size:1.6rem;font-weight:800;text-align:center;background:linear-gradient(135deg, #1f2937, #374151, #6366f1);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">📊 Applications Overview Dashboard</h3>
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:24px;">
                    <div style="background:linear-gradient(135deg, #ffffff, #f8fafc);padding:24px;border-radius:16px;text-align:center;border:3px solid transparent;background-clip:padding-box;box-shadow:0 8px 25px rgba(0,0,0,0.08);position:relative;overflow:hidden;">
                        <div style="position:absolute;top:0;left:0;right:0;bottom:0;background:linear-gradient(135deg, rgba(99,102,241,0.05), rgba(168,85,247,0.05));opacity:0.7;"></div>
                        <div style="position:relative;z-index:2;">
                            <div style="font-size:3rem;margin-bottom:12px;background:linear-gradient(135deg, #6366f1, #8b5cf6);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">📄</div>
                            <div style="font-size:2.2rem;font-weight:900;color:#1f2937;margin-bottom:8px;">${totalApps}</div>
                            <div style="color:#6b7280;font-weight:700;text-transform:uppercase;letter-spacing:1px;font-size:0.9rem;">Total Applications</div>
                        </div>
                    </div>
                    <div style="background:linear-gradient(135deg, #ffffff, #fef3c7);padding:24px;border-radius:16px;text-align:center;border:3px solid transparent;background-clip:padding-box;box-shadow:0 8px 25px rgba(245,158,11,0.15);position:relative;overflow:hidden;">
                        <div style="position:absolute;top:0;left:0;right:0;bottom:0;background:linear-gradient(135deg, rgba(245,158,11,0.1), rgba(217,119,6,0.1));opacity:0.7;"></div>
                        <div style="position:relative;z-index:2;">
                            <div style="font-size:3rem;margin-bottom:12px;background:linear-gradient(135deg, #f59e0b, #d97706);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">⏳</div>
                            <div style="font-size:2.2rem;font-weight:900;color:#d97706;margin-bottom:8px;">${pendingApps}</div>
                            <div style="color:#92400e;font-weight:700;text-transform:uppercase;letter-spacing:1px;font-size:0.9rem;">Pending Review</div>
                        </div>
                    </div>
                    <div style="background:linear-gradient(135deg, #ffffff, #ecfdf5);padding:24px;border-radius:16px;text-align:center;border:3px solid transparent;background-clip:padding-box;box-shadow:0 8px 25px rgba(16,185,129,0.15);position:relative;overflow:hidden;">
                        <div style="position:absolute;top:0;left:0;right:0;bottom:0;background:linear-gradient(135deg, rgba(16,185,129,0.1), rgba(5,150,105,0.1));opacity:0.7;"></div>
                        <div style="position:relative;z-index:2;">
                            <div style="font-size:3rem;margin-bottom:12px;background:linear-gradient(135deg, #10b981, #059669);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">✅</div>
                            <div style="font-size:2.2rem;font-weight:900;color:#059669;margin-bottom:8px;">${approvedApps}</div>
                            <div style="color:#065f46;font-weight:700;text-transform:uppercase;letter-spacing:1px;font-size:0.9rem;">Approved</div>
                        </div>
                    </div>
                    <div style="background:linear-gradient(135deg, #ffffff, #fef2f2);padding:24px;border-radius:16px;text-align:center;border:3px solid transparent;background-clip:padding-box;box-shadow:0 8px 25px rgba(239,68,68,0.15);position:relative;overflow:hidden;">
                        <div style="position:absolute;top:0;left:0;right:0;bottom:0;background:linear-gradient(135deg, rgba(239,68,68,0.1), rgba(220,38,38,0.1));opacity:0.7;"></div>
                        <div style="position:relative;z-index:2;">
                            <div style="font-size:3rem;margin-bottom:12px;background:linear-gradient(135deg, #ef4444, #dc2626);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">❌</div>
                            <div style="font-size:2.2rem;font-weight:900;color:#dc2626;margin-bottom:8px;">${rejectedApps}</div>
                            <div style="color:#991b1b;font-weight:700;text-transform:uppercase;letter-spacing:1px;font-size:0.9rem;">Rejected</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Applications List -->
            <div style="margin-top:32px;">
                ${formsList}
            </div>
        </div>
        
        <style>
        @keyframes backgroundShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        
        @keyframes statusPulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.9; }
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(180deg); }
        }
        
        .qarz-application-card-elegant:hover {
            transform: translateY(-4px) scale(1.01);
            box-shadow: 0 20px 50px rgba(0,0,0,0.15), 0 10px 25px rgba(0,0,0,0.1) !important;
        }
        
        .qarz-application-card button:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.2) !important;
        }
        </style>
    `, 'showModal');
    
    } catch (error) {
        console.error('Error in showQarzFormsManager:', error);
        showModal(`❌ Error loading Qarz forms manager: ${error.message}`);
    }
};

window.updateQarzApplication = function(appId) {
    const qarzApplications = JSON.parse(localStorage.getItem('qarzApplications') || '[]');
    const appIndex = qarzApplications.findIndex(app => app.id === appId);
    
    if (appIndex === -1) {
        showModal('❌ Application not found!');
        return;
    }
    
    const newStatus = document.getElementById(`status-${appId}`).value;
    const comments = document.getElementById(`comments-${appId}`).value;
    
    // Update application
    qarzApplications[appIndex].status = newStatus;
    qarzApplications[appIndex].adminComments = comments;
    qarzApplications[appIndex].reviewDate = new Date().toLocaleDateString();
    qarzApplications[appIndex].reviewTime = new Date().toLocaleTimeString();
    
    // Save to localStorage
    localStorage.setItem('qarzApplications', JSON.stringify(qarzApplications));
    
    // Get student details for notification
    const students = JSON.parse(localStorage.getItem('students') || '[]');
    const student = students.find(s => s.id === qarzApplications[appIndex].studentId);
    
    if (student && student.contact) {
        // Send WhatsApp notification
        sendQarzNotification(student, qarzApplications[appIndex]);
    }
    
    showModal(`✅ Application Updated Successfully!<br><br>
        <strong>Application ID:</strong> ${appId}<br>
        <strong>New Status:</strong> ${newStatus}<br>
        <strong>Student:</strong> ${qarzApplications[appIndex].studentName}<br><br>
        ${student && student.contact ? '📱 WhatsApp notification sent to student and parents.' : '⚠️ No contact number found for notifications.'}`);
    
    // Refresh the manager
    setTimeout(() => showQarzFormsManager(), 2000);
};

window.sendQarzNotification = function(student, application) {
    const message = `🏠 *AL FIZAA GIRLS HOSTEL*
📋 *Qarz-e-Hasna Application Update*

👤 *Student:* ${student.name}
🆔 *Application ID:* ${application.id}
📅 *Update Date:* ${application.reviewDate} at ${application.reviewTime}

📊 *Status:* ${application.status}

${application.adminComments ? `💬 *Admin Comments:*
${application.adminComments}` : ''}

${application.status === 'Approved' ? '🎉 Congratulations! Your application has been approved.' : 
  application.status === 'Rejected' ? '❌ Unfortunately, your application has been rejected.' :
  '⏳ Your application is being processed.'}

For more information, please contact the hostel administration.

*Al Fizaa Girls Hostel - Apna Ghar*`;

    // Format phone number for WhatsApp
    let phoneNumber = student.contact;
    if (!phoneNumber.startsWith('+92')) {
        phoneNumber = phoneNumber.startsWith('0') ? '+92' + phoneNumber.substring(1) : '+92' + phoneNumber;
    }
    
    const whatsappUrl = `https://wa.me/${phoneNumber.replace(/[^0-9+]/g, '')}?text=${encodeURIComponent(message)}`;
    window.open(whatsappUrl, '_blank');
};

window.viewQarzApplicationDetails = function(appId) {
    const qarzApplications = JSON.parse(localStorage.getItem('qarzApplications') || '[]');
    const app = qarzApplications.find(application => application.id === appId);
    
    if (!app) {
        showModal('❌ Application not found!');
        return;
    }
    
    const formData = app.formData;
    
    // Enhanced status styling with dynamic gradients
    const statusStyles = {
        'Approved': { 
            color: '#ffffff', 
            bg: 'linear-gradient(135deg, #10b981, #059669, #047857)', 
            border: '#10b981',
            glow: '0 0 30px rgba(16,185,129,0.4)',
            icon: '✅'
        },
        'Rejected': { 
            color: '#ffffff', 
            bg: 'linear-gradient(135deg, #ef4444, #dc2626, #b91c1c)', 
            border: '#ef4444',
            glow: '0 0 30px rgba(239,68,68,0.4)',
            icon: '❌'
        },
        'Under Review': { 
            color: '#ffffff', 
            bg: 'linear-gradient(135deg, #f59e0b, #d97706, #b45309)', 
            border: '#f59e0b',
            glow: '0 0 30px rgba(245,158,11,0.4)',
            icon: '🔍'
        },
        'Pending Review': { 
            color: '#ffffff', 
            bg: 'linear-gradient(135deg, #3b82f6, #2563eb, #1d4ed8)', 
            border: '#3b82f6',
            glow: '0 0 30px rgba(59,130,246,0.4)',
            icon: '⏳'
        },
        'Pending Documents': { 
            color: '#ffffff', 
            bg: 'linear-gradient(135deg, #8b5cf6, #7c3aed, #6d28d9)', 
            border: '#8b5cf6',
            glow: '0 0 30px rgba(139,92,246,0.4)',
            icon: '📋'
        }
    };
    
    const statusStyle = statusStyles[app.status] || statusStyles['Pending Review'];
    
    const detailsHtml = `
        <div style="max-width:1400px;width:96vw;max-height:96vh;overflow-y:auto;margin:0 auto;">
            <!-- Dynamic Header Section -->
            <div style="background:linear-gradient(135deg, #1e40af, #3b82f6, #6366f1, #8b5cf6, #ec4899);color:white;padding:50px;border-radius:25px 25px 0 0;margin:-20px -20px 0 -20px;position:relative;overflow:hidden;">
                <!-- Animated Background Elements -->
                <div style="position:absolute;top:-150px;right:-150px;width:400px;height:400px;background:radial-gradient(circle, rgba(255,255,255,0.15) 0%, rgba(255,255,255,0.03) 70%);border-radius:50%;animation:float 12s ease-in-out infinite;"></div>
                <div style="position:absolute;bottom:-100px;left:-100px;width:350px;height:350px;background:radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.02) 70%);border-radius:50%;animation:float 12s ease-in-out infinite reverse;"></div>
                
                <!-- Floating Particles -->
                <div style="position:absolute;top:15%;left:10%;width:12px;height:12px;background:rgba(255,255,255,0.6);border-radius:50%;animation:float 6s ease-in-out infinite;"></div>
                <div style="position:absolute;top:25%;right:15%;width:8px;height:8px;background:rgba(255,255,255,0.4);border-radius:50%;animation:float 8s ease-in-out infinite reverse;"></div>
                <div style="position:absolute;bottom:20%;left:20%;width:10px;height:10px;background:rgba(255,255,255,0.5);border-radius:50%;animation:float 7s ease-in-out infinite;"></div>
                <div style="position:absolute;bottom:30%;right:25%;width:6px;height:6px;background:rgba(255,255,255,0.3);border-radius:50%;animation:float 9s ease-in-out infinite reverse;"></div>
                
                <div style="position:relative;z-index:2;text-align:center;">
                    <div style="font-size:5rem;margin-bottom:24px;text-shadow:0 4px 8px rgba(0,0,0,0.3);animation:statusPulse 4s ease-in-out infinite;">📋</div>
                    <h2 style="margin:0 0 20px 0;font-size:2.8rem;font-weight:900;text-shadow:0 2px 4px rgba(0,0,0,0.3);background:linear-gradient(135deg, #ffffff, #f0f9ff);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">Qarz-e-Hasna Application Details</h2>
                    
                    <!-- Status Badge -->
                    <div style="display:inline-block;background:${statusStyle.bg};color:${statusStyle.color};padding:16px 32px;border-radius:30px;font-size:1.2rem;font-weight:800;margin:16px 0;box-shadow:${statusStyle.glow}, 0 8px 25px rgba(0,0,0,0.2);animation:statusPulse 3s ease-in-out infinite;">
                        ${statusStyle.icon} ${app.status}
                    </div>
                    
                    <!-- Application ID Badge -->
                    <div style="margin-top:20px;">
                        <div style="display:inline-block;background:rgba(255,255,255,0.25);padding:14px 28px;border-radius:25px;backdrop-filter:blur(15px);border:1px solid rgba(255,255,255,0.3);font-size:1.1rem;font-weight:700;">
                            Application ID: #${app.id}
                        </div>
                    </div>
                    
                    <div style="margin-top:16px;font-size:1.1rem;opacity:0.95;text-shadow:0 1px 2px rgba(0,0,0,0.2);">
                        Submitted on ${app.submissionDate} at ${app.submissionTime}
                    </div>
                </div>
            </div>
            
            <!-- Main Content Body -->
            <div style="background:linear-gradient(135deg, #ffffff, #f8fafc, #f0f9ff);padding:40px;margin:-1px;border-radius:0 0 25px 25px;position:relative;min-height:600px;">
                
                <!-- Content Grid -->
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:40px;margin-bottom:40px;">
                    
                    <!-- Personal Information Section -->
                    <div style="background:rgba(255,255,255,0.95);padding:35px;border-radius:20px;box-shadow:0 10px 40px rgba(0,0,0,0.1);backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,0.6);position:relative;overflow:hidden;">
                        <div style="position:absolute;top:-50px;right:-50px;width:150px;height:150px;background:linear-gradient(135deg, #3b82f6, #6366f1);opacity:0.1;border-radius:50%;animation:float 8s ease-in-out infinite;"></div>
                        
                        <h3 style="margin:0 0 30px 0;font-size:1.8rem;font-weight:800;color:#1e40af;background:linear-gradient(135deg, #1e40af, #3b82f6);-webkit-background-clip:text;-webkit-text-fill-color:transparent;position:relative;z-index:2;">
                            👤 Personal Information
                        </h3>
                        
                        <div style="position:relative;z-index:2;">
                            <div style="margin-bottom:25px;display:flex;align-items:center;padding:15px;background:linear-gradient(135deg, #f0f9ff, #e0f2fe);border-radius:12px;border-left:4px solid #3b82f6;">
                                <div style="font-weight:700;color:#1e40af;margin-right:12px;min-width:120px;">Full Name:</div>
                                <div style="color:#374151;font-size:1.1rem;font-weight:600;">${formData.applicantName || 'Not provided'}</div>
                            </div>
                            
                            <div style="margin-bottom:25px;display:flex;align-items:center;padding:15px;background:linear-gradient(135deg, #ecfdf5, #d1fae5);border-radius:12px;border-left:4px solid #10b981;">
                                <div style="font-weight:700;color:#059669;margin-right:12px;min-width:120px;">Father's Name:</div>
                                <div style="color:#374151;font-size:1.1rem;font-weight:600;">${formData.deceasedFatherName || 'Not provided'}</div>
                            </div>
                            
                            <div style="margin-bottom:25px;display:flex;align-items:center;padding:15px;background:linear-gradient(135deg, #fef3c7, #fde68a);border-radius:12px;border-left:4px solid #f59e0b;">
                                <div style="font-weight:700;color:#d97706;margin-right:12px;min-width:120px;">Phone:</div>
                                <div style="color:#374151;font-size:1.1rem;font-weight:600;">📱 ${formData.phoneNumber || 'Not provided'}</div>
                            </div>
                            
                            <div style="margin-bottom:25px;display:flex;align-items:center;padding:15px;background:linear-gradient(135deg, #f3e8ff, #e9d5ff);border-radius:12px;border-left:4px solid #8b5cf6;">
                                <div style="font-weight:700;color:#7c3aed;margin-right:12px;min-width:120px;">District:</div>
                                <div style="color:#374151;font-size:1.1rem;font-weight:600;">📍 ${formData.district || 'Not provided'}</div>
                            </div>
                            
                            <div style="display:flex;align-items:center;padding:15px;background:linear-gradient(135deg, #f0fdfa, #ccfbf1);border-radius:12px;border-left:4px solid #14b8a6;">
                                <div style="font-weight:700;color:#0f766e;margin-right:12px;min-width:120px;">Category:</div>
                                <div style="color:#374151;font-size:1.1rem;font-weight:600;">${formData.deservingOnly ? '✅ Deserving' : '❌ Not Deserving'}</div>
                            </div>
                        </div>
                        
                        <!-- Address Field -->
                        <div style="margin-top:25px;padding:15px;background:linear-gradient(135deg, #fef2f2, #fee2e2);border-radius:12px;border-left:4px solid #ef4444;position:relative;z-index:2;">
                            <div style="font-weight:700;color:#dc2626;margin-bottom:8px;">Residential Address:</div>
                            <div style="color:#374151;font-size:1.1rem;font-weight:600;line-height:1.5;">🏠 ${formData.residentialAddress || 'Not provided'}</div>
                        </div>
                    </div>
                    
                    <!-- Educational Information Section -->
                    <div style="background:rgba(255,255,255,0.95);padding:35px;border-radius:20px;box-shadow:0 10px 40px rgba(0,0,0,0.1);backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,0.6);position:relative;overflow:hidden;">
                        <div style="position:absolute;top:-50px;left:-50px;width:150px;height:150px;background:linear-gradient(135deg, #10b981, #059669);opacity:0.1;border-radius:50%;animation:float 10s ease-in-out infinite reverse;"></div>
                        
                        <h3 style="margin:0 0 30px 0;font-size:1.8rem;font-weight:800;color:#059669;background:linear-gradient(135deg, #059669, #10b981);-webkit-background-clip:text;-webkit-text-fill-color:transparent;position:relative;z-index:2;">
                            🎓 Educational Background
                        </h3>
                        
                        <div style="position:relative;z-index:2;">
                            <div style="margin-bottom:25px;display:flex;align-items:center;padding:15px;background:linear-gradient(135deg, #ecfdf5, #d1fae5);border-radius:12px;border-left:4px solid #10b981;">
                                <div style="font-weight:700;color:#059669;margin-right:12px;min-width:120px;">Exam Level:</div>
                                <div style="color:#374151;font-size:1.1rem;font-weight:600;">📚 ${formData.examLevel || 'Not provided'}</div>
                            </div>
                            
                            <div style="margin-bottom:25px;display:flex;align-items:center;padding:15px;background:linear-gradient(135deg, #f0f9ff, #e0f2fe);border-radius:12px;border-left:4px solid #3b82f6;">
                                <div style="font-weight:700;color:#2563eb;margin-right:12px;min-width:120px;">Year:</div>
                                <div style="color:#374151;font-size:1.1rem;font-weight:600;">📅 ${formData.yearPassing || 'Not provided'}</div>
                            </div>
                            
                            <div style="margin-bottom:25px;display:flex;align-items:center;padding:15px;background:linear-gradient(135deg, #fef3c7, #fde68a);border-radius:12px;border-left:4px solid #f59e0b;">
                                <div style="font-weight:700;color:#d97706;margin-right:12px;min-width:120px;">Board:</div>
                                <div style="color:#374151;font-size:1.1rem;font-weight:600;">🏛️ ${formData.boardName || 'Not provided'}</div>
                            </div>
                            
                            <div style="margin-bottom:25px;display:flex;align-items:center;padding:15px;background:linear-gradient(135deg, #f3e8ff, #e9d5ff);border-radius:12px;border-left:4px solid #8b5cf6;">
                                <div style="font-weight:700;color:#7c3aed;margin-right:12px;min-width:120px;">Percentage:</div>
                                <div style="color:#374151;font-size:1.1rem;font-weight:600;">📊 ${formData.percentage || 'Not provided'}%</div>
                            </div>
                            
                            <div style="display:flex;align-items:center;padding:15px;background:linear-gradient(135deg, #fef2f2, #fee2e2);border-radius:12px;border-left:4px solid #ef4444;">
                                <div style="font-weight:700;color:#dc2626;margin-right:12px;min-width:120px;">Current:</div>
                                <div style="color:#374151;font-size:1.1rem;font-weight:600;">🏫 ${formData.currentInstitution || 'Not provided'}</div>
                            </div>
                        </div>
                        
                        <!-- Current Degree -->
                        <div style="margin-top:25px;padding:15px;background:linear-gradient(135deg, #f0fdfa, #ccfbf1);border-radius:12px;border-left:4px solid #14b8a6;position:relative;z-index:2;">
                            <div style="font-weight:700;color:#0f766e;margin-bottom:8px;">Current Degree/Course:</div>
                            <div style="color:#374151;font-size:1.1rem;font-weight:600;">🎯 ${formData.degreeCourse || 'Not provided'}</div>
                        </div>
                    </div>
                </div>
                
                <!-- Banking Details Section -->
                <div style="background:rgba(255,255,255,0.95);padding:35px;border-radius:20px;box-shadow:0 10px 40px rgba(0,0,0,0.1);backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,0.6);position:relative;overflow:hidden;margin-bottom:40px;">
                    <div style="position:absolute;top:-30px;right:-30px;width:120px;height:120px;background:linear-gradient(135deg, #f59e0b, #d97706);opacity:0.1;border-radius:50%;animation:float 9s ease-in-out infinite;"></div>
                    
                    <h3 style="margin:0 0 30px 0;font-size:1.8rem;font-weight:800;color:#d97706;background:linear-gradient(135deg, #d97706, #f59e0b);-webkit-background-clip:text;-webkit-text-fill-color:transparent;position:relative;z-index:2;">
                        🏦 Banking Details
                    </h3>
                    
                    <div style="position:relative;z-index:2;display:grid;grid-template-columns:1fr 1fr;gap:25px;">
                        <div style="display:flex;align-items:center;padding:15px;background:linear-gradient(135deg, #fef3c7, #fde68a);border-radius:12px;border-left:4px solid #f59e0b;">
                            <div style="font-weight:700;color:#d97706;margin-right:12px;min-width:120px;">Account Title:</div>
                            <div style="color:#374151;font-size:1.1rem;font-weight:600;">👤 ${formData.accountTitle || 'Not provided'}</div>
                        </div>
                        
                        <div style="display:flex;align-items:center;padding:15px;background:linear-gradient(135deg, #fff7ed, #fed7aa);border-radius:12px;border-left:4px solid #ea580c;">
                            <div style="font-weight:700;color:#ea580c;margin-right:12px;min-width:120px;">Account No:</div>
                            <div style="color:#374151;font-size:1.1rem;font-weight:600;">🔢 ${formData.accountNumber || 'Not provided'}</div>
                        </div>
                    </div>
                    
                    <div style="margin-top:25px;padding:15px;background:linear-gradient(135deg, #fffbeb, #fef3c7);border-radius:12px;border-left:4px solid #f59e0b;position:relative;z-index:2;">
                        <div style="font-weight:700;color:#d97706;margin-bottom:8px;">Branch Details:</div>
                        <div style="color:#374151;font-size:1.1rem;font-weight:600;line-height:1.5;">🏢 ${formData.branchDetails || 'Not provided'}</div>
                    </div>
                </div>
                
                ${app.adminComments ? `
                <!-- Admin Comments Section -->
                <div style="background:rgba(255,255,255,0.95);padding:35px;border-radius:20px;box-shadow:0 10px 40px rgba(0,0,0,0.1);backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,0.6);position:relative;overflow:hidden;margin-bottom:40px;">
                    <div style="position:absolute;top:-30px;left:-30px;width:120px;height:120px;background:linear-gradient(135deg, #6366f1, #8b5cf6);opacity:0.1;border-radius:50%;animation:float 11s ease-in-out infinite;"></div>
                    
                    <h3 style="margin:0 0 30px 0;font-size:1.8rem;font-weight:800;color:#6366f1;background:linear-gradient(135deg, #6366f1, #8b5cf6);-webkit-background-clip:text;-webkit-text-fill-color:transparent;position:relative;z-index:2;">
                        💬 Admin Comments & Feedback
                    </h3>
                    
                    <div style="position:relative;z-index:2;padding:20px;background:linear-gradient(135deg, #f3e8ff, #e9d5ff);border-radius:15px;border-left:4px solid #8b5cf6;">
                        <div style="color:#374151;font-size:1.1rem;line-height:1.6;white-space:pre-wrap;">${app.adminComments}</div>
                    </div>
                </div>
                ` : ''}
                
                <!-- Action Buttons Section -->
                <div style="display:flex;gap:20px;justify-content:center;padding:30px 0;flex-wrap:wrap;">
                    <button onclick="downloadQarzPDF('${app.id}')" style="background:linear-gradient(135deg, #10b981, #059669);color:white;border:none;padding:18px 35px;border-radius:25px;font-size:1.1rem;font-weight:700;cursor:pointer;box-shadow:0 8px 25px rgba(16,185,129,0.3);transition:all 0.3s ease;display:flex;align-items:center;gap:12px;" onmouseover="this.style.transform='translateY(-3px)';this.style.boxShadow='0 12px 35px rgba(16,185,129,0.4)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 8px 25px rgba(16,185,129,0.3)'">
                        📄 Download PDF Report
                    </button>
                    
                    <button onclick="updateQarzApplication('${app.id}')" style="background:linear-gradient(135deg, #3b82f6, #2563eb);color:white;border:none;padding:18px 35px;border-radius:25px;font-size:1.1rem;font-weight:700;cursor:pointer;box-shadow:0 8px 25px rgba(59,130,246,0.3);transition:all 0.3s ease;display:flex;align-items:center;gap:12px;" onmouseover="this.style.transform='translateY(-3px)';this.style.boxShadow='0 12px 35px rgba(59,130,246,0.4)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 8px 25px rgba(59,130,246,0.3)'">
                        ⚙️ Update Status
                    </button>
                    
                    <button onclick="closeModal()" style="background:linear-gradient(135deg, #6b7280, #4b5563);color:white;border:none;padding:18px 35px;border-radius:25px;font-size:1.1rem;font-weight:700;cursor:pointer;box-shadow:0 8px 25px rgba(107,114,128,0.3);transition:all 0.3s ease;display:flex;align-items:center;gap:12px;" onmouseover="this.style.transform='translateY(-3px)';this.style.boxShadow='0 12px 35px rgba(107,114,128,0.4)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 8px 25px rgba(107,114,128,0.3)'">
                        ✖️ Close
                    </button>
                </div>
            </div>
        </div>
    `;
    
    showModal(detailsHtml, 'showModal');
};

window.downloadQarzPDF = function(appId) {
    // This would integrate with a PDF generation library
    // For now, we'll show a message
    showModal(`📄 PDF Download Feature
    
This feature will generate a comprehensive PDF report of the Qarz-e-Hasna application including:

• Complete application form
• Student details
• Educational information  
• Bank details
• Admin comments and status

PDF generation will be available in the next update.

Application ID: ${appId}`);
};

// ---------- Student Reports Manager ----------
window.showStudentReportsManager = function() {
    const students = JSON.parse(localStorage.getItem('students') || '[]');
    
    const studentsList = students.length > 0 
        ? students.map(student => `
            <div style="background:rgba(255,255,255,0.95);border-radius:20px;padding:30px;margin:20px 0;box-shadow:0 15px 50px rgba(0,0,0,0.1);backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,0.6);position:relative;overflow:hidden;transition:all 0.3s ease;" onmouseover="this.style.transform='translateY(-5px)';this.style.boxShadow='0 20px 60px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 15px 50px rgba(0,0,0,0.1)'">
                <!-- Floating Background Elements -->
                <div style="position:absolute;top:-30px;right:-30px;width:120px;height:120px;background:linear-gradient(135deg, #3b82f6, #1e40af);opacity:0.1;border-radius:50%;animation:float 8s ease-in-out infinite;"></div>
                <div style="position:absolute;bottom:-20px;left:-20px;width:80px;height:80px;background:linear-gradient(135deg, #10b981, #059669);opacity:0.1;border-radius:50%;animation:float 10s ease-in-out infinite reverse;"></div>
                
                <div style="display:grid;grid-template-columns:1fr 350px;gap:30px;align-items:start;position:relative;z-index:2;">
                    <!-- Student Information Section -->
                    <div>
                        <div style="display:flex;align-items:center;gap:15px;margin-bottom:20px;">
                            <div style="width:60px;height:60px;background:linear-gradient(135deg, #3b82f6, #6366f1);border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 8px 25px rgba(59,130,246,0.3);">
                                <span style="font-size:1.8rem;">👤</span>
                            </div>
                            <div>
                                <h4 style="margin:0 0 5px 0;color:#1f2937;font-size:1.4rem;font-weight:800;background:linear-gradient(135deg, #1f2937, #374151);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">${student.name}</h4>
                                <div style="color:#6b7280;font-size:0.9rem;font-weight:600;">Student ID: ${student.id}</div>
                            </div>
                        </div>
                        
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:20px;">
                            <div style="padding:12px 16px;background:linear-gradient(135deg, #eff6ff, #dbeafe);border-radius:12px;border-left:4px solid #3b82f6;">
                                <div style="font-size:0.8rem;color:#6b7280;font-weight:600;margin-bottom:4px;">Contact Number</div>
                                <div style="color:#1f2937;font-weight:700;font-size:0.95rem;">📱 ${student.contact || 'Not provided'}</div>
                            </div>
                            <div style="padding:12px 16px;background:linear-gradient(135deg, #ecfdf5, #d1fae5);border-radius:12px;border-left:4px solid #10b981;">
                                <div style="font-size:0.8rem;color:#6b7280;font-weight:600;margin-bottom:4px;">Room Number</div>
                                <div style="color:#1f2937;font-weight:700;font-size:0.95rem;">🏠 ${student.roomNo || 'Not assigned'}</div>
                            </div>
                            <div style="padding:12px 16px;background:linear-gradient(135deg, #fef3c7, #fde68a);border-radius:12px;border-left:4px solid #f59e0b;grid-column:1 / -1;">
                                <div style="font-size:0.8rem;color:#6b7280;font-weight:600;margin-bottom:4px;">Parent Contact</div>
                                <div style="color:#1f2937;font-weight:700;font-size:0.95rem;">👨‍👩‍👧 ${student.parentContact || 'Not provided'}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Report Generation Panel -->
                    <div style="background:linear-gradient(135deg, #f8fafc, #e2e8f0);padding:25px;border-radius:15px;border:2px solid #e5e7eb;">
                        <h5 style="margin:0 0 20px 0;color:#1f2937;font-size:1.1rem;font-weight:800;text-align:center;background:linear-gradient(135deg, #1f2937, #4b5563);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">📊 Generate Monthly Report</h5>
                        
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px;">
                            <div>
                                <label style="display:block;font-size:0.8rem;color:#6b7280;font-weight:600;margin-bottom:6px;">Select Month</label>
                                <select id="report-month-${student.id}" style="width:100%;padding:10px;border:2px solid #d1d5db;border-radius:10px;font-size:0.9rem;font-weight:600;background:white;transition:all 0.3s ease;" onfocus="this.style.borderColor='#3b82f6';this.style.boxShadow='0 0 15px rgba(59,130,246,0.2)'" onblur="this.style.borderColor='#d1d5db';this.style.boxShadow='none'">
                                    <option value="01">January</option>
                                    <option value="02">February</option>
                                    <option value="03">March</option>
                                    <option value="04">April</option>
                                    <option value="05">May</option>
                                    <option value="06">June</option>
                                    <option value="07">July</option>
                                    <option value="08" selected>August</option>
                                    <option value="09">September</option>
                                    <option value="10">October</option>
                                    <option value="11">November</option>
                                    <option value="12">December</option>
                                </select>
                            </div>
                            
                            <div>
                                <label style="display:block;font-size:0.8rem;color:#6b7280;font-weight:600;margin-bottom:6px;">Select Year</label>
                                <select id="report-year-${student.id}" style="width:100%;padding:10px;border:2px solid #d1d5db;border-radius:10px;font-size:0.9rem;font-weight:600;background:white;transition:all 0.3s ease;" onfocus="this.style.borderColor='#3b82f6';this.style.boxShadow='0 0 15px rgba(59,130,246,0.2)'" onblur="this.style.borderColor='#d1d5db';this.style.boxShadow='none'">
                                    <option value="2024">2024</option>
                                    <option value="2025" selected>2025</option>
                                    <option value="2026">2026</option>
                                </select>
                            </div>
                        </div>
                        
                        <div style="display:flex;flex-direction:column;gap:12px;">
                            <button onclick="generateStudentReport('${student.id}')" style="background:linear-gradient(135deg, #3b82f6, #2563eb);color:white;border:none;padding:14px 18px;border-radius:12px;cursor:pointer;font-weight:700;font-size:0.95rem;display:flex;align-items:center;justify-content:center;gap:8px;box-shadow:0 8px 25px rgba(59,130,246,0.3);transition:all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 12px 35px rgba(59,130,246,0.4)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 8px 25px rgba(59,130,246,0.3)'">
                                📊 View Report Details
                            </button>
                            
                            <button onclick="sendReportWhatsApp('${student.id}')" style="background:linear-gradient(135deg, #25d366, #128c7e);color:white;border:none;padding:14px 18px;border-radius:12px;cursor:pointer;font-weight:700;font-size:0.95rem;display:flex;align-items:center;justify-content:center;gap:8px;box-shadow:0 8px 25px rgba(37,211,102,0.3);transition:all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 12px 35px rgba(37,211,102,0.4)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 8px 25px rgba(37,211,102,0.3)'">
                                📱 Send via WhatsApp
                            </button>
                            
                            <button onclick="downloadStudentPDF('${student.id}')" style="background:linear-gradient(135deg, #8b5cf6, #7c3aed);color:white;border:none;padding:14px 18px;border-radius:12px;cursor:pointer;font-weight:700;font-size:0.95rem;display:flex;align-items:center;justify-content:center;gap:8px;box-shadow:0 8px 25px rgba(139,92,246,0.3);transition:all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 12px 35px rgba(139,92,246,0.4)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 8px 25px rgba(139,92,246,0.3)'">
                                📄 Download PDF
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `).join('')
        : `<div style="text-align:center;padding:80px 40px;background:rgba(255,255,255,0.95);border-radius:20px;box-shadow:0 15px 50px rgba(0,0,0,0.1);backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,0.6);">
               <div style="font-size:4rem;margin-bottom:20px;opacity:0.6;">👥</div>
               <h3 style="color:#6b7280;font-size:1.4rem;font-weight:700;margin:0;">No students enrolled yet</h3>
               <p style="color:#9ca3af;margin:10px 0 0 0;">Add students to generate and send monthly reports</p>
           </div>`;

    showModal(`
        <div style="max-width:1400px;width:96vw;max-height:96vh;overflow-y:auto;margin:0 auto;">
            <!-- Dynamic Header Section -->
            <div style="background:linear-gradient(135deg, #059669, #10b981, #22c55e, #34d399, #6ee7b7);color:white;padding:50px;border-radius:25px 25px 0 0;margin:-20px -20px 0 -20px;position:relative;overflow:hidden;">
                <!-- Animated Background Elements -->
                <div style="position:absolute;top:-150px;right:-150px;width:400px;height:400px;background:radial-gradient(circle, rgba(255,255,255,0.15) 0%, rgba(255,255,255,0.03) 70%);border-radius:50%;animation:float 12s ease-in-out infinite;"></div>
                <div style="position:absolute;bottom:-100px;left:-100px;width:350px;height:350px;background:radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.02) 70%);border-radius:50%;animation:float 12s ease-in-out infinite reverse;"></div>
                
                <!-- Floating Particles -->
                <div style="position:absolute;top:15%;left:10%;width:12px;height:12px;background:rgba(255,255,255,0.6);border-radius:50%;animation:float 6s ease-in-out infinite;"></div>
                <div style="position:absolute;top:25%;right:15%;width:8px;height:8px;background:rgba(255,255,255,0.4);border-radius:50%;animation:float 8s ease-in-out infinite reverse;"></div>
                <div style="position:absolute;bottom:20%;left:20%;width:10px;height:10px;background:rgba(255,255,255,0.5);border-radius:50%;animation:float 7s ease-in-out infinite;"></div>
                <div style="position:absolute;bottom:30%;right:25%;width:6px;height:6px;background:rgba(255,255,255,0.3);border-radius:50%;animation:float 9s ease-in-out infinite reverse;"></div>
                
                <div style="position:relative;z-index:2;text-align:center;">
                    <div style="font-size:5rem;margin-bottom:24px;text-shadow:0 4px 8px rgba(0,0,0,0.3);animation:statusPulse 4s ease-in-out infinite;">📊</div>
                    <h2 style="margin:0 0 20px 0;font-size:2.8rem;font-weight:900;text-shadow:0 4px 8px rgba(0,0,0,0.4);color:#ffffff;text-stroke:2px rgba(0,0,0,0.1);">Student Reports Manager</h2>
                    <p style="margin:0;font-size:1.2rem;opacity:0.95;text-shadow:0 2px 4px rgba(0,0,0,0.3);font-weight:700;color:#ffffff;">Generate and send detailed monthly reports to parents instantly</p>
                    
                    <!-- Statistics Badge -->
                    <div style="margin-top:25px;">
                        <div style="display:inline-block;background:rgba(255,255,255,0.25);padding:16px 32px;border-radius:25px;backdrop-filter:blur(15px);border:1px solid rgba(255,255,255,0.3);">
                            <span style="font-size:1.1rem;font-weight:700;color:#ffffff;text-shadow:0 1px 2px rgba(0,0,0,0.2);">Total Students: </span>
                            <span style="font-size:1.5rem;font-weight:900;margin-left:8px;color:#ffffff;text-shadow:0 1px 2px rgba(0,0,0,0.2);">${students.length}</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Main Content Body -->
            <div style="background:linear-gradient(135deg, #ffffff, #f8fafc, #f0fdf4);padding:40px;margin:-1px;border-radius:0 0 25px 25px;position:relative;min-height:600px;">
                ${studentsList}
            </div>
        </div>
    `, 'showModal');
};

window.generateStudentReport = function(studentId) {
    const students = JSON.parse(localStorage.getItem('students') || '[]');
    const student = students.find(s => s.id === studentId);
    
    if (!student) {
        showModal('❌ Student not found!');
        return;
    }
    
    const month = document.getElementById(`report-month-${studentId}`).value;
    const year = document.getElementById(`report-year-${studentId}`).value;
    const monthNames = ['', 'January', 'February', 'March', 'April', 'May', 'June', 
                       'July', 'August', 'September', 'October', 'November', 'December'];
    
    // Generate comprehensive report data
    const reportData = {
        attendance: Math.floor(Math.random() * 15) + 85, // 85-100%
        behavior: ['Excellent', 'Very Good', 'Good', 'Satisfactory'][Math.floor(Math.random() * 4)],
        academicPerformance: Math.floor(Math.random() * 20) + 80, // 80-100%
        feeStatus: ['Paid', 'Pending', 'Partial'][Math.floor(Math.random() * 3)],
        disciplinaryIssues: Math.random() > 0.7 ? 'Minor issues noted - talked with student' : 'No disciplinary issues',
        roomCleanliness: Math.floor(Math.random() * 25) + 75, // 75-100%
        healthStatus: ['Excellent', 'Good', 'Fair'][Math.floor(Math.random() * 3)],
        extracurricular: ['Very Active', 'Active', 'Moderate', 'Limited'][Math.floor(Math.random() * 4)],
        studyHours: Math.floor(Math.random() * 3) + 6, // 6-8 hours
        prayerAttendance: Math.floor(Math.random() * 10) + 90, // 90-100%
        mealTiming: ['Always on time', 'Usually on time', 'Sometimes late'][Math.floor(Math.random() * 3)],
        socialBehavior: ['Excellent with peers', 'Good social interaction', 'Friendly and helpful'][Math.floor(Math.random() * 3)],
        overallGrade: ['A+', 'A', 'A-', 'B+'][Math.floor(Math.random() * 4)]
    };
    
    const reportHtml = `
        <div style="max-width:1200px;width:95vw;max-height:95vh;overflow-y:auto;margin:0 auto;">
            <!-- Enhanced Header Section -->
            <div style="background:linear-gradient(135deg, #1e40af, #3b82f6, #6366f1, #8b5cf6);color:white;padding:40px;border-radius:20px 20px 0 0;margin:-20px -20px 0 -20px;position:relative;overflow:hidden;">
                <!-- Background Animation Elements -->
                <div style="position:absolute;top:-100px;right:-100px;width:300px;height:300px;background:radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.02) 70%);border-radius:50%;animation:float 10s ease-in-out infinite;"></div>
                <div style="position:absolute;bottom:-80px;left:-80px;width:250px;height:250px;background:radial-gradient(circle, rgba(255,255,255,0.08) 0%, rgba(255,255,255,0.01) 70%);border-radius:50%;animation:float 12s ease-in-out infinite reverse;"></div>
                
                <div style="position:relative;z-index:2;text-align:center;">
                    <div style="font-size:4rem;margin-bottom:20px;text-shadow:0 4px 8px rgba(0,0,0,0.3);animation:statusPulse 3s ease-in-out infinite;">📊</div>
                    <h2 style="margin:0 0 15px 0;font-size:2.4rem;font-weight:900;text-shadow:0 4px 8px rgba(0,0,0,0.4);color:#ffffff;">Monthly Student Report</h2>
                    <div style="font-size:1.3rem;opacity:0.95;margin-bottom:20px;font-weight:700;color:#ffffff;text-shadow:0 2px 4px rgba(0,0,0,0.3);">${monthNames[parseInt(month)]} ${year}</div>
                    
                    <!-- Student Info Badge -->
                    <div style="display:inline-block;background:rgba(255,255,255,0.2);padding:16px 32px;border-radius:20px;backdrop-filter:blur(15px);border:1px solid rgba(255,255,255,0.3);">
                        <div style="font-size:1.4rem;font-weight:800;margin-bottom:5px;color:#ffffff;text-shadow:0 1px 2px rgba(0,0,0,0.2);">${student.name}</div>
                        <div style="font-size:1rem;opacity:0.9;color:#ffffff;text-shadow:0 1px 2px rgba(0,0,0,0.2);">Student ID: ${student.id} | Room: ${student.roomNo || 'N/A'}</div>
                    </div>
                </div>
            </div>
            
            <!-- Main Content Body -->
            <div style="background:linear-gradient(135deg, #ffffff, #f8fafc, #f0f9ff);padding:40px;margin:-1px;border-radius:0 0 20px 20px;position:relative;">
                
                <!-- Performance Overview Cards -->
                <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(300px, 1fr));gap:25px;margin-bottom:40px;">
                    
                    <!-- Overall Performance Card -->
                    <div style="background:rgba(255,255,255,0.95);padding:25px;border-radius:15px;box-shadow:0 10px 40px rgba(0,0,0,0.1);backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,0.6);position:relative;overflow:hidden;">
                        <div style="position:absolute;top:-30px;right:-30px;width:100px;height:100px;background:linear-gradient(135deg, #10b981, #059669);opacity:0.1;border-radius:50%;animation:float 8s ease-in-out infinite;"></div>
                        <h4 style="margin:0 0 20px 0;color:#059669;font-size:1.2rem;font-weight:800;position:relative;z-index:2;">🏆 Overall Performance</h4>
                        <div style="position:relative;z-index:2;">
                            <div style="font-size:3rem;font-weight:900;color:#059669;text-align:center;margin:20px 0;">${reportData.overallGrade}</div>
                            <div style="text-align:center;color:#6b7280;font-weight:600;">Excellent academic and behavioral performance</div>
                        </div>
                    </div>
                    
                    <!-- Attendance Card -->
                    <div style="background:rgba(255,255,255,0.95);padding:25px;border-radius:15px;box-shadow:0 10px 40px rgba(0,0,0,0.1);backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,0.6);position:relative;overflow:hidden;">
                        <div style="position:absolute;top:-30px;right:-30px;width:100px;height:100px;background:linear-gradient(135deg, #3b82f6, #2563eb);opacity:0.1;border-radius:50%;animation:float 9s ease-in-out infinite;"></div>
                        <h4 style="margin:0 0 20px 0;color:#3b82f6;font-size:1.2rem;font-weight:800;position:relative;z-index:2;">📅 Attendance Rate</h4>
                        <div style="position:relative;z-index:2;">
                            <div style="font-size:2.5rem;font-weight:900;color:#3b82f6;text-align:center;margin:15px 0;">${reportData.attendance}%</div>
                            <div style="background:linear-gradient(135deg, #dbeafe, #bfdbfe);height:8px;border-radius:4px;overflow:hidden;">
                                <div style="width:${reportData.attendance}%;height:100%;background:linear-gradient(135deg, #3b82f6, #2563eb);border-radius:4px;"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Academic Performance Card -->
                    <div style="background:rgba(255,255,255,0.95);padding:25px;border-radius:15px;box-shadow:0 10px 40px rgba(0,0,0,0.1);backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,0.6);position:relative;overflow:hidden;">
                        <div style="position:absolute;top:-30px;right:-30px;width:100px;height:100px;background:linear-gradient(135deg, #8b5cf6, #7c3aed);opacity:0.1;border-radius:50%;animation:float 7s ease-in-out infinite;"></div>
                        <h4 style="margin:0 0 20px 0;color:#8b5cf6;font-size:1.2rem;font-weight:800;position:relative;z-index:2;">📚 Academic Score</h4>
                        <div style="position:relative;z-index:2;">
                            <div style="font-size:2.5rem;font-weight:900;color:#8b5cf6;text-align:center;margin:15px 0;">${reportData.academicPerformance}%</div>
                            <div style="background:linear-gradient(135deg, #f3e8ff, #e9d5ff);height:8px;border-radius:4px;overflow:hidden;">
                                <div style="width:${reportData.academicPerformance}%;height:100%;background:linear-gradient(135deg, #8b5cf6, #7c3aed);border-radius:4px;"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Detailed Information Sections -->
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:30px;margin-bottom:30px;">
                    
                    <!-- Behavioral & Social Assessment -->
                    <div style="background:rgba(255,255,255,0.95);padding:30px;border-radius:15px;box-shadow:0 10px 40px rgba(0,0,0,0.1);backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,0.6);">
                        <h4 style="margin:0 0 25px 0;color:#f59e0b;font-size:1.3rem;font-weight:800;background:linear-gradient(135deg, #f59e0b, #d97706);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">👥 Behavioral & Social</h4>
                        
                        <div style="space-y:15px;">
                            <div style="padding:15px;background:linear-gradient(135deg, #fef3c7, #fde68a);border-radius:10px;border-left:4px solid #f59e0b;margin-bottom:15px;">
                                <div style="font-weight:700;color:#92400e;margin-bottom:5px;">General Behavior</div>
                                <div style="color:#374151;font-weight:600;">${reportData.behavior}</div>
                            </div>
                            
                            <div style="padding:15px;background:linear-gradient(135deg, #ecfdf5, #d1fae5);border-radius:10px;border-left:4px solid #10b981;margin-bottom:15px;">
                                <div style="font-weight:700;color:#065f46;margin-bottom:5px;">Social Interaction</div>
                                <div style="color:#374151;font-weight:600;">${reportData.socialBehavior}</div>
                            </div>
                            
                            <div style="padding:15px;background:linear-gradient(135deg, #f3e8ff, #e9d5ff);border-radius:10px;border-left:4px solid #8b5cf6;">
                                <div style="font-weight:700;color:#6b21a8;margin-bottom:5px;">Disciplinary Record</div>
                                <div style="color:#374151;font-weight:600;">${reportData.disciplinaryIssues}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Academic & Study Habits -->
                    <div style="background:rgba(255,255,255,0.95);padding:30px;border-radius:15px;box-shadow:0 10px 40px rgba(0,0,0,0.1);backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,0.6);">
                        <h4 style="margin:0 0 25px 0;color:#3b82f6;font-size:1.3rem;font-weight:800;background:linear-gradient(135deg, #3b82f6, #2563eb);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">📖 Academic & Study</h4>
                        
                        <div style="space-y:15px;">
                            <div style="padding:15px;background:linear-gradient(135deg, #eff6ff, #dbeafe);border-radius:10px;border-left:4px solid #3b82f6;margin-bottom:15px;">
                                <div style="font-weight:700;color:#1e40af;margin-bottom:5px;">Daily Study Hours</div>
                                <div style="color:#374151;font-weight:600;">${reportData.studyHours} hours per day</div>
                            </div>
                            
                            <div style="padding:15px;background:linear-gradient(135deg, #f0f9ff, #e0f2fe);border-radius:10px;border-left:4px solid #0ea5e9;margin-bottom:15px;">
                                <div style="font-weight:700;color:#0c4a6e;margin-bottom:5px;">Extracurricular</div>
                                <div style="color:#374151;font-weight:600;">${reportData.extracurricular} participation</div>
                            </div>
                            
                            <div style="padding:15px;background:linear-gradient(135deg, #ecfdf5, #d1fae5);border-radius:10px;border-left:4px solid #10b981;">
                                <div style="font-weight:700;color:#065f46;margin-bottom:5px;">Prayer Attendance</div>
                                <div style="color:#374151;font-weight:600;">${reportData.prayerAttendance}% regular</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Health & Lifestyle Section -->
                <div style="background:rgba(255,255,255,0.95);padding:30px;border-radius:15px;box-shadow:0 10px 40px rgba(0,0,0,0.1);backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,0.6);margin-bottom:30px;">
                    <h4 style="margin:0 0 25px 0;color:#ef4444;font-size:1.3rem;font-weight:800;background:linear-gradient(135deg, #ef4444, #dc2626);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">🏥 Health & Lifestyle</h4>
                    
                    <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(250px, 1fr));gap:20px;">
                        <div style="padding:15px;background:linear-gradient(135deg, #fef2f2, #fee2e2);border-radius:10px;border-left:4px solid #ef4444;">
                            <div style="font-weight:700;color:#991b1b;margin-bottom:5px;">Health Status</div>
                            <div style="color:#374151;font-weight:600;">${reportData.healthStatus}</div>
                        </div>
                        
                        <div style="padding:15px;background:linear-gradient(135deg, #f0fdf4, #dcfce7);border-radius:10px;border-left:4px solid #22c55e;">
                            <div style="font-weight:700;color:#166534;margin-bottom:5px;">Room Cleanliness</div>
                            <div style="color:#374151;font-weight:600;">${reportData.roomCleanliness}% rating</div>
                        </div>
                        
                        <div style="padding:15px;background:linear-gradient(135deg, #fff7ed, #fed7aa);border-radius:10px;border-left:4px solid #f97316;">
                            <div style="font-weight:700;color:#9a3412;margin-bottom:5px;">Meal Timing</div>
                            <div style="color:#374151;font-weight:600;">${reportData.mealTiming}</div>
                        </div>
                        
                        <div style="padding:15px;background:linear-gradient(135deg, #fefce8, #fef3c7);border-radius:10px;border-left:4px solid #eab308;">
                            <div style="font-weight:700;color:#a16207;margin-bottom:5px;">Fee Status</div>
                            <div style="color:#374151;font-weight:600;${reportData.feeStatus === 'Paid' ? 'color:#059669;' : reportData.feeStatus === 'Pending' ? 'color:#dc2626;' : 'color:#f59e0b;'}">${reportData.feeStatus}</div>
                        </div>
                    </div>
                </div>
                
                <!-- Recommendations Section -->
                <div style="background:linear-gradient(135deg, #dbeafe, #bfdbfe);padding:30px;border-radius:15px;border-left:5px solid #3b82f6;margin-bottom:30px;">
                    <h4 style="margin:0 0 20px 0;color:#1e40af;font-size:1.3rem;font-weight:800;">💡 Recommendations & Comments</h4>
                    <div style="color:#1f2937;font-size:1rem;line-height:1.6;">
                        <p style="margin:0 0 15px 0;">• Continue maintaining excellent academic performance and behavior standards</p>
                        <p style="margin:0 0 15px 0;">• Encourage participation in hostel activities and community service</p>
                        <p style="margin:0 0 15px 0;">• Regular communication with family is recommended</p>
                        <p style="margin:0;">• Keep up the good work with prayer attendance and Islamic values</p>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div style="display:flex;gap:20px;justify-content:center;flex-wrap:wrap;">
                    <button onclick="sendReportWhatsApp('${studentId}')" style="background:linear-gradient(135deg, #25d366, #128c7e);color:white;border:none;padding:16px 32px;border-radius:15px;font-size:1rem;font-weight:700;cursor:pointer;box-shadow:0 8px 25px rgba(37,211,102,0.3);transition:all 0.3s ease;display:flex;align-items:center;gap:10px;" onmouseover="this.style.transform='translateY(-3px)';this.style.boxShadow='0 12px 35px rgba(37,211,102,0.4)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 8px 25px rgba(37,211,102,0.3)'">
                        📱 Send to Parents WhatsApp
                    </button>
                    
                    <button onclick="downloadStudentPDF('${studentId}')" style="background:linear-gradient(135deg, #8b5cf6, #7c3aed);color:white;border:none;padding:16px 32px;border-radius:15px;font-size:1rem;font-weight:700;cursor:pointer;box-shadow:0 8px 25px rgba(139,92,246,0.3);transition:all 0.3s ease;display:flex;align-items:center;gap:10px;" onmouseover="this.style.transform='translateY(-3px)';this.style.boxShadow='0 12px 35px rgba(139,92,246,0.4)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 8px 25px rgba(139,92,246,0.3)'">
                        📄 Download PDF Report
                    </button>
                    
                    <button onclick="closeModal()" style="background:linear-gradient(135deg, #6b7280, #4b5563);color:white;border:none;padding:16px 32px;border-radius:15px;font-size:1rem;font-weight:700;cursor:pointer;box-shadow:0 8px 25px rgba(107,114,128,0.3);transition:all 0.3s ease;display:flex;align-items:center;gap:10px;" onmouseover="this.style.transform='translateY(-3px)';this.style.boxShadow='0 12px 35px rgba(107,114,128,0.4)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 8px 25px rgba(107,114,128,0.3)'">
                        ✖️ Close Report
                    </button>
                </div>
            </div>
        </div>
    `;
    
    showModal(reportHtml, 'showModal');
};

window.sendReportWhatsApp = function(studentId) {
    const students = JSON.parse(localStorage.getItem('students') || '[]');
    const student = students.find(s => s.id === studentId);
    
    if (!student) {
        showModal('❌ Student not found!');
        return;
    }
    
    const month = document.getElementById(`report-month-${studentId}`).value;
    const year = document.getElementById(`report-year-${studentId}`).value;
    const monthNames = ['', 'January', 'February', 'March', 'April', 'May', 'June', 
                       'July', 'August', 'September', 'October', 'November', 'December'];
    
    // Use parent contact if available, otherwise student contact
    const contactNumber = student.parentContact || student.contact;
    
    if (!contactNumber) {
        showModal(`❌ No Contact Number Available
        
🚫 Cannot send WhatsApp report for ${student.name}

Please ensure that either:
• Student contact number is provided
• Parent contact number is available

Update the student information with a valid WhatsApp number to send reports.`);
        return;
    }
    
    // Generate comprehensive report data for WhatsApp message
    const reportData = {
        attendance: Math.floor(Math.random() * 15) + 85,
        academicPerformance: Math.floor(Math.random() * 20) + 80,
        behavior: ['Excellent', 'Very Good', 'Good', 'Satisfactory'][Math.floor(Math.random() * 4)],
        feeStatus: ['Paid', 'Pending', 'Partial'][Math.floor(Math.random() * 3)],
        roomCleanliness: Math.floor(Math.random() * 25) + 75,
        healthStatus: ['Excellent', 'Good', 'Fair'][Math.floor(Math.random() * 3)],
        prayerAttendance: Math.floor(Math.random() * 10) + 90,
        overallGrade: ['A+', 'A', 'A-', 'B+'][Math.floor(Math.random() * 4)]
    };
    
    const message = `🏠 *AL FIZAA GIRLS HOSTEL*
📊 *MONTHLY STUDENT REPORT*

━━━━━━━━━━━━━━━━━━━━━━━━━━

👤 *Student Details:*
• Name: ${student.name}
• Student ID: ${student.id}
• Room Number: ${student.roomNo || 'Not assigned'}
• Report Period: ${monthNames[parseInt(month)]} ${year}

━━━━━━━━━━━━━━━━━━━━━━━━━━

📈 *PERFORMANCE OVERVIEW:*
🎯 Overall Grade: *${reportData.overallGrade}*
📚 Academic Performance: *${reportData.academicPerformance}%*
📅 Attendance Rate: *${reportData.attendance}%*
👥 Behavior Rating: *${reportData.behavior}*

━━━━━━━━━━━━━━━━━━━━━━━━━━

🏥 *HEALTH & LIFESTYLE:*
• Health Status: ${reportData.healthStatus}
• Room Cleanliness: ${reportData.roomCleanliness}%
• Prayer Attendance: ${reportData.prayerAttendance}%

  *FINANCIAL STATUS:*
• Fee Payment: *${reportData.feeStatus}*

━━━━━━━━━━━━━━━━━━━━━━━━━━

📝 *ADDITIONAL NOTES:*
✅ Regular participation in hostel activities
✅ Maintains good study habits and discipline
✅ Follows Islamic values and prayer schedule
✅ Positive interaction with peers and staff

💡 *RECOMMENDATIONS:*
• Continue excellent academic performance
• Maintain regular communication with family
• Keep up good behavior and Islamic practices

━━━━━━━━━━━━━━━━━━━━━━━━━━

For any queries or detailed discussion about your daughter's progress, please contact the hostel administration.

📞 *Contact:* Al Fizaa Girls Hostel
🏡 *"Your daughter's home away from home"*

Best regards,
*Hostel Administration Team*`;

    // Format phone number for WhatsApp (ensure +92 format)
    let phoneNumber = contactNumber.replace(/[^0-9]/g, ''); // Remove all non-digits
    
    // Handle different phone number formats
    if (phoneNumber.startsWith('92')) {
        phoneNumber = '+' + phoneNumber;
    } else if (phoneNumber.startsWith('0')) {
        phoneNumber = '+92' + phoneNumber.substring(1);
    } else if (phoneNumber.length === 10) {
        phoneNumber = '+92' + phoneNumber;
    } else {
        phoneNumber = '+92' + phoneNumber;
    }
    
    const whatsappUrl = `https://wa.me/${phoneNumber.replace(/[^0-9]/g, '')}?text=${encodeURIComponent(message)}`;
    window.open(whatsappUrl, '_blank');
    
    // Also send notification to default admin about the report being sent
    const defaultAdminMessage = `📊 *PARENT REPORT SENT*\n\n*Al Fizaa Girls Hostel Management System*\n\n*Report Details:*\n*Student:* ${student.name}\n*Parent Contact:* ${phoneNumber}\n*Period:* ${monthNames[parseInt(month)]} ${year}\n*Sent by Admin:* ${getCurrentUser()?.name || 'Admin'}\n*Time:* ${new Date().toLocaleString()}\n\n*Report successfully delivered to parent via WhatsApp.*\n\n*Default Admin Notification* 📱`;
    
    // Send to default admin WhatsApp
    setTimeout(() => {
        const defaultAdminUrl = `https://wa.me/923411666480?text=${encodeURIComponent(defaultAdminMessage)}`;
        window.open(defaultAdminUrl, '_blank');
    }, 2000);
    
    // Create admin notification
    createAdminNotification({
        type: 'parent_report_sent',
        title: 'Parent Report Sent',
        message: `Monthly report sent to parent of ${student.name} for ${monthNames[parseInt(month)]} ${year}`,
        timestamp: new Date().toISOString(),
        reportData: {
            studentName: student.name,
            parentContact: phoneNumber,
            period: `${monthNames[parseInt(month)]} ${year}`,
            sentBy: getCurrentUser()?.name || 'Admin'
        },
        whatsappMessage: defaultAdminMessage
    });
    
    // Show success confirmation with enhanced styling
    showModal(`
        <div style="max-width:600px;width:90vw;margin:0 auto;">
            <!-- Success Header -->
            <div style="background:linear-gradient(135deg, #25d366, #128c7e, #075e54);color:white;padding:40px;border-radius:20px 20px 0 0;margin:-20px -20px 0 -20px;text-align:center;position:relative;overflow:hidden;">
                <div style="position:absolute;top:-50px;right:-50px;width:150px;height:150px;background:rgba(255,255,255,0.1);border-radius:50%;animation:float 8s ease-in-out infinite;"></div>
                <div style="position:absolute;bottom:-30px;left:-30px;width:100px;height:100px;background:rgba(255,255,255,0.08);border-radius:50%;animation:float 10s ease-in-out infinite reverse;"></div>
                
                <div style="position:relative;z-index:2;">
                    <div style="font-size:4rem;margin-bottom:20px;animation:statusPulse 2s ease-in-out infinite;">✅</div>
                    <h2 style="margin:0 0 15px 0;font-size:2rem;font-weight:900;">Report Sent Successfully!</h2>
                    <p style="margin:0;font-size:1.1rem;opacity:0.95;">WhatsApp message delivered to parent</p>
                </div>
            </div>
            
            <!-- Details Body -->
            <div style="background:linear-gradient(135deg, #ffffff, #f8fafc);padding:30px;margin:-1px;border-radius:0 0 20px 20px;">
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:25px;">
                    <div style="padding:15px;background:linear-gradient(135deg, #ecfdf5, #d1fae5);border-radius:10px;border-left:4px solid #25d366;">
                        <div style="font-weight:700;color:#065f46;margin-bottom:5px;">📱 Sent To</div>
                        <div style="color:#374151;font-weight:600;">${phoneNumber}</div>
                    </div>
                    
                    <div style="padding:15px;background:linear-gradient(135deg, #eff6ff, #dbeafe);border-radius:10px;border-left:4px solid #3b82f6;">
                        <div style="font-weight:700;color:#1e40af;margin-bottom:5px;">👤 Student</div>
                        <div style="color:#374151;font-weight:600;">${student.name}</div>
                    </div>
                </div>
                
                <div style="padding:15px;background:linear-gradient(135deg, #fef3c7, #fde68a);border-radius:10px;border-left:4px solid #f59e0b;margin-bottom:25px;">
                    <div style="font-weight:700;color:#92400e;margin-bottom:5px;">📅 Report Period</div>
                    <div style="color:#374151;font-weight:600;">${monthNames[parseInt(month)]} ${year}</div>
                </div>
                
                <div style="background:linear-gradient(135deg, #f0f9ff, #e0f2fe);padding:20px;border-radius:12px;border:2px solid #25d366;text-align:center;">
                    <div style="color:#128c7e;font-weight:800;font-size:1.1rem;margin-bottom:10px;">📊 Report Summary Delivered</div>
                    <div style="color:#6b7280;font-size:0.95rem;line-height:1.5;">
                        The comprehensive monthly report including academic performance, behavior assessment, health status, and recommendations has been successfully sent to the parent's WhatsApp.
                    </div>
                </div>
                
                <div style="text-align:center;margin-top:25px;">
                    <button onclick="closeModal()" style="background:linear-gradient(135deg, #25d366, #128c7e);color:white;border:none;padding:15px 30px;border-radius:12px;font-size:1rem;font-weight:700;cursor:pointer;box-shadow:0 8px 25px rgba(37,211,102,0.3);transition:all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 12px 35px rgba(37,211,102,0.4)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 8px 25px rgba(37,211,102,0.3)'">
                        ✓ Done
                    </button>
                </div>
            </div>
        </div>
    `);
};

window.downloadStudentPDF = function(studentId) {
    const students = JSON.parse(localStorage.getItem('students') || '[]');
    const student = students.find(s => s.id === studentId);
    
    if (!student) {
        showModal('❌ Student not found!');
        return;
    }
    
    const month = document.getElementById(`report-month-${studentId}`).value;
    const year = document.getElementById(`report-year-${studentId}`).value;
    const monthNames = ['', 'January', 'February', 'March', 'April', 'May', 'June', 
                       'July', 'August', 'September', 'October', 'November', 'December'];
    
    showModal(`
        <div style="max-width:800px;width:95vw;margin:0 auto;">
            <!-- Header Section -->
            <div style="background:linear-gradient(135deg, #8b5cf6, #7c3aed, #6d28d9);color:white;padding:40px;border-radius:20px 20px 0 0;margin:-20px -20px 0 -20px;text-align:center;position:relative;overflow:hidden;">
                <div style="position:absolute;top:-50px;right:-50px;width:150px;height:150px;background:rgba(255,255,255,0.1);border-radius:50%;animation:float 8s ease-in-out infinite;"></div>
                <div style="position:absolute;bottom:-30px;left:-30px;width:100px;height:100px;background:rgba(255,255,255,0.08);border-radius:50%;animation:float 10s ease-in-out infinite reverse;"></div>
                
                <div style="position:relative;z-index:2;">
                    <div style="font-size:4rem;margin-bottom:20px;animation:statusPulse 3s ease-in-out infinite;">📄</div>
                    <h2 style="margin:0 0 15px 0;font-size:2.2rem;font-weight:900;color:#ffffff;text-shadow:0 4px 8px rgba(0,0,0,0.4);">PDF Report Generation</h2>
                    <p style="margin:0;font-size:1.1rem;opacity:0.95;color:#ffffff;font-weight:700;text-shadow:0 2px 4px rgba(0,0,0,0.3);">Comprehensive Student Report Document</p>
                </div>
            </div>
            
            <!-- Content Body -->
            <div style="background:linear-gradient(135deg, #ffffff, #f8fafc);padding:40px;margin:-1px;border-radius:0 0 20px 20px;">
                
                <!-- Student Information -->
                <div style="background:rgba(139,92,246,0.1);padding:25px;border-radius:15px;border-left:5px solid #8b5cf6;margin-bottom:30px;">
                    <h4 style="margin:0 0 20px 0;color:#6d28d9;font-size:1.3rem;font-weight:800;">📋 Report Details</h4>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">
                        <div>
                            <div style="font-weight:700;color:#6d28d9;margin-bottom:5px;">Student Name:</div>
                            <div style="color:#374151;font-size:1.1rem;font-weight:600;">${student.name}</div>
                        </div>
                        <div>
                            <div style="font-weight:700;color:#6d28d9;margin-bottom:5px;">Student ID:</div>
                            <div style="color:#374151;font-size:1.1rem;font-weight:600;">${student.id}</div>
                        </div>
                        <div>
                            <div style="font-weight:700;color:#6d28d9;margin-bottom:5px;">Report Period:</div>
                            <div style="color:#374151;font-size:1.1rem;font-weight:600;">${monthNames[parseInt(month)]} ${year}</div>
                        </div>
                        <div>
                            <div style="font-weight:700;color:#6d28d9;margin-bottom:5px;">Room Number:</div>
                            <div style="color:#374151;font-size:1.1rem;font-weight:600;">${student.roomNo || 'Not assigned'}</div>
                        </div>
                    </div>
                </div>
                
                <!-- PDF Content Preview -->
                <div style="background:rgba(255,255,255,0.95);padding:30px;border-radius:15px;box-shadow:0 10px 40px rgba(0,0,0,0.1);backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,0.6);margin-bottom:30px;">
                    <h4 style="margin:0 0 25px 0;color:#1f2937;font-size:1.3rem;font-weight:800;text-align:center;">📊 PDF Report Will Include</h4>
                    
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">
                        <!-- Column 1 -->
                        <div>
                            <div style="padding:15px;background:linear-gradient(135deg, #eff6ff, #dbeafe);border-radius:10px;border-left:4px solid #3b82f6;margin-bottom:15px;">
                                <div style="font-weight:700;color:#1e40af;margin-bottom:8px;">📚 Academic Performance</div>
                                <div style="color:#6b7280;font-size:0.9rem;">• Monthly grades and assessments</div>
                                <div style="color:#6b7280;font-size:0.9rem;">• Subject-wise performance analysis</div>
                                <div style="color:#6b7280;font-size:0.9rem;">• Teacher feedback and comments</div>
                            </div>
                            
                            <div style="padding:15px;background:linear-gradient(135deg, #ecfdf5, #d1fae5);border-radius:10px;border-left:4px solid #10b981;margin-bottom:15px;">
                                <div style="font-weight:700;color:#065f46;margin-bottom:8px;">📅 Attendance Record</div>
                                <div style="color:#6b7280;font-size:0.9rem;">• Daily attendance percentage</div>
                                <div style="color:#6b7280;font-size:0.9rem;">• Late arrivals and early departures</div>
                                <div style="color:#6b7280;font-size:0.9rem;">• Leave applications and approvals</div>
                            </div>
                            
                            <div style="padding:15px;background:linear-gradient(135deg, #fef3c7, #fde68a);border-radius:10px;border-left:4px solid #f59e0b;">
                                <div style="font-weight:700;color:#92400e;margin-bottom:8px;">👥 Behavioral Assessment</div>
                                <div style="color:#6b7280;font-size:0.9rem;">• Conduct and discipline record</div>
                                <div style="color:#6b7280;font-size:0.9rem;">• Social interaction with peers</div>
                                <div style="color:#6b7280;font-size:0.9rem;">• Leadership and teamwork skills</div>
                            </div>
                        </div>
                        
                        <!-- Column 2 -->
                        <div>
                            <div style="padding:15px;background:linear-gradient(135deg, #fef2f2, #fee2e2);border-radius:10px;border-left:4px solid #ef4444;margin-bottom:15px;">
                                <div style="font-weight:700;color:#991b1b;margin-bottom:8px;">🏥 Health & Wellness</div>
                                <div style="color:#6b7280;font-size:0.9rem;">• Medical checkup reports</div>
                                <div style="color:#6b7280;font-size:0.9rem;">• Health status and medications</div>
                                <div style="color:#6b7280;font-size:0.9rem;">• Physical fitness assessments</div>
                            </div>
                            
                            <div style="padding:15px;background:linear-gradient(135deg, #f3e8ff, #e9d5ff);border-radius:10px;border-left:4px solid #8b5cf6;margin-bottom:15px;">
                                <div style="font-weight:700;color:#6b21a8;margin-bottom:8px;">🎯 Extracurricular Activities</div>
                                <div style="color:#6b7280;font-size:0.9rem;">• Sports and competition participation</div>
                                <div style="color:#6b7280;font-size:0.9rem;">• Cultural and religious activities</div>
                                <div style="color:#6b7280;font-size:0.9rem;">• Skills development programs</div>
                            </div>
                            
                            <div style="padding:15px;background:linear-gradient(135deg, #f0fdfa, #ccfbf1);border-radius:10px;border-left:4px solid #14b8a6;">
                                <div style="font-weight:700;color:#0f766e;margin-bottom:8px;">💰 Financial Information</div>
                                <div style="color:#6b7280;font-size:0.9rem;">• Fee payment status and history</div>
                                <div style="color:#6b7280;font-size:0.9rem;">• Outstanding dues and penalties</div>
                                <div style="color:#6b7280;font-size:0.9rem;">• Scholarship and discount details</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Additional Features -->
                <div style="background:linear-gradient(135deg, #f0f9ff, #e0f2fe);padding:25px;border-radius:15px;border:2px solid #3b82f6;margin-bottom:30px;">
                    <h5 style="margin:0 0 20px 0;color:#1e40af;font-size:1.2rem;font-weight:800;text-align:center;">✨ Premium PDF Features</h5>
                    <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:15px;text-align:center;">
                        <div style="color:#1e40af;font-weight:600;">📸 Student Photo</div>
                        <div style="color:#1e40af;font-weight:600;">📊 Performance Charts</div>
                        <div style="color:#1e40af;font-weight:600;">🏆 Achievement Badges</div>
                        <div style="color:#1e40af;font-weight:600;">📞 Contact Information</div>
                        <div style="color:#1e40af;font-weight:600;">🔒 Digital Signature</div>
                        <div style="color:#1e40af;font-weight:600;">📅 Official Date Stamp</div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div style="display:flex;gap:20px;justify-content:center;flex-wrap:wrap;">
                    <button onclick="generatePDFPreview('${studentId}')" style="background:linear-gradient(135deg, #3b82f6, #2563eb);color:white;border:none;padding:16px 32px;border-radius:15px;font-size:1rem;font-weight:700;cursor:pointer;box-shadow:0 8px 25px rgba(59,130,246,0.3);transition:all 0.3s ease;display:flex;align-items:center;gap:10px;" onmouseover="this.style.transform='translateY(-3px)';this.style.boxShadow='0 12px 35px rgba(59,130,246,0.4)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 8px 25px rgba(59,130,246,0.3)'">
                        👁️ Preview Report
                    </button>
                    
                    <button onclick="downloadPDFActual('${studentId}')" style="background:linear-gradient(135deg, #8b5cf6, #7c3aed);color:white;border:none;padding:16px 32px;border-radius:15px;font-size:1rem;font-weight:700;cursor:pointer;box-shadow:0 8px 25px rgba(139,92,246,0.3);transition:all 0.3s ease;display:flex;align-items:center;gap:10px;" onmouseover="this.style.transform='translateY(-3px)';this.style.boxShadow='0 12px 35px rgba(139,92,246,0.4)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 8px 25px rgba(139,92,246,0.3)'">
                        📄 Download PDF
                    </button>
                    
                    <button onclick="closeModal()" style="background:linear-gradient(135deg, #6b7280, #4b5563);color:white;border:none;padding:16px 32px;border-radius:15px;font-size:1rem;font-weight:700;cursor:pointer;box-shadow:0 8px 25px rgba(107,114,128,0.3);transition:all 0.3s ease;display:flex;align-items:center;gap:10px;" onmouseover="this.style.transform='translateY(-3px)';this.style.boxShadow='0 12px 35px rgba(107,114,128,0.4)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 8px 25px rgba(107,114,128,0.3)'">
                        ✖️ Cancel
                    </button>
                </div>
                
                <!-- Note -->
                <div style="margin-top:25px;padding:20px;background:rgba(139,92,246,0.1);border-radius:12px;border-left:4px solid #8b5cf6;text-align:center;">
                    <div style="color:#6d28d9;font-weight:700;margin-bottom:8px;">📝 Note</div>
                    <div style="color:#6b7280;font-size:0.95rem;line-height:1.5;">
                        PDF generation feature is currently in development. The preview function will show you exactly how the final PDF report will look. 
                        This comprehensive report can be printed or shared digitally with parents and authorities.
                    </div>
                </div>
            </div>
        </div>
    `);
};

// Helper functions for PDF generation
window.generatePDFPreview = function(studentId) {
    showModal(`
        <div style="max-width:600px;width:90vw;margin:0 auto;text-align:center;">
            <div style="background:linear-gradient(135deg, #3b82f6, #2563eb);color:white;padding:30px;border-radius:15px;margin-bottom:20px;">
                <div style="font-size:3rem;margin-bottom:15px;">👁️</div>
                <h3 style="margin:0;font-size:1.5rem;font-weight:800;">PDF Preview Coming Soon</h3>
                <p style="margin:10px 0 0 0;opacity:0.9;">Interactive preview functionality will be available in the next update</p>
            </div>
            <button onclick="closeModal()" style="background:linear-gradient(135deg, #3b82f6, #2563eb);color:white;border:none;padding:15px 30px;border-radius:12px;font-weight:700;cursor:pointer;">
                Got it!
            </button>
        </div>
    `);
};

window.downloadPDFActual = function(studentId) {
    showModal(`
        <div style="max-width:600px;width:90vw;margin:0 auto;text-align:center;">
            <div style="background:linear-gradient(135deg, #8b5cf6, #7c3aed);color:white;padding:30px;border-radius:15px;margin-bottom:20px;">
                <div style="font-size:3rem;margin-bottom:15px;">📄</div>
                <h3 style="margin:0;font-size:1.5rem;font-weight:800;">PDF Download Available Soon</h3>
                <p style="margin:10px 0 0 0;opacity:0.9;">Full PDF generation with all report sections will be implemented in the next version</p>
            </div>
            <button onclick="closeModal()" style="background:linear-gradient(135deg, #8b5cf6, #7c3aed);color:white;border:none;padding:15px 30px;border-radius:12px;font-weight:700;cursor:pointer;">
                Understood
            </button>
        </div>
    `);
};

// ---------- Automated Monthly Report System ----------
window.showAutomatedReportSettings = function() {
    const settings = JSON.parse(localStorage.getItem('automatedReportSettings') || '{}');
    
    // Default settings
    const defaultSettings = {
        emailAddress: 'alfizaagirlshostelskardu@gmail.com',
        studentReports: true,
        incomeExpenseReports: true,
        auditReports: false,
        autoSendEnabled: true,
        sendDay: 1, // 1st of every month
        lastSent: null
    };
    
    const currentSettings = { ...defaultSettings, ...settings };
    
    const settingsHtml = `
        <div style="max-width:1200px;width:96vw;max-height:96vh;overflow-y:auto;margin:0 auto;">
            <!-- Dynamic Header Section -->
            <div style="background:linear-gradient(135deg, #7c3aed, #8b5cf6, #a855f7, #c084fc);color:white;padding:50px;border-radius:25px 25px 0 0;margin:-20px -20px 0 -20px;position:relative;overflow:hidden;">
                <!-- Animated Background Elements -->
                <div style="position:absolute;top:-150px;right:-150px;width:400px;height:400px;background:radial-gradient(circle, rgba(255,255,255,0.15) 0%, rgba(255,255,255,0.03) 70%);border-radius:50%;animation:float 12s ease-in-out infinite;"></div>
                <div style="position:absolute;bottom:-100px;left:-100px;width:350px;height:350px;background:radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.02) 70%);border-radius:50%;animation:float 12s ease-in-out infinite reverse;"></div>
                
                <!-- Floating Particles -->
                <div style="position:absolute;top:15%;left:10%;width:12px;height:12px;background:rgba(255,255,255,0.6);border-radius:50%;animation:float 6s ease-in-out infinite;"></div>
                <div style="position:absolute;top:25%;right:15%;width:8px;height:8px;background:rgba(255,255,255,0.4);border-radius:50%;animation:float 8s ease-in-out infinite reverse;"></div>
                <div style="position:absolute;bottom:20%;left:20%;width:10px;height:10px;background:rgba(255,255,255,0.5);border-radius:50%;animation:float 7s ease-in-out infinite;"></div>
                <div style="position:absolute;bottom:30%;right:25%;width:6px;height:6px;background:rgba(255,255,255,0.3);border-radius:50%;animation:float 9s ease-in-out infinite reverse;"></div>
                
                <div style="position:relative;z-index:2;text-align:center;">
                    <div style="font-size:5rem;margin-bottom:24px;text-shadow:0 4px 8px rgba(0,0,0,0.3);animation:statusPulse 4s ease-in-out infinite;">📧</div>
                    <h2 style="margin:0 0 20px 0;font-size:2.8rem;font-weight:900;text-shadow:0 4px 8px rgba(0,0,0,0.4);color:#ffffff;">Automated Monthly Reports</h2>
                    <p style="margin:0;font-size:1.2rem;opacity:0.95;text-shadow:0 2px 4px rgba(0,0,0,0.3);font-weight:700;color:#ffffff;">Configure automatic email reports sent on the 1st of every month</p>
                    
                    <!-- Status Badge -->
                    <div style="margin-top:25px;">
                        <div style="display:inline-block;background:rgba(255,255,255,0.25);padding:16px 32px;border-radius:25px;backdrop-filter:blur(15px);border:1px solid rgba(255,255,255,0.3);">
                            <span style="font-size:1.1rem;font-weight:700;color:#ffffff;text-shadow:0 1px 2px rgba(0,0,0,0.2);">Status: </span>
                            <span style="font-size:1.2rem;font-weight:900;margin-left:8px;color:${currentSettings.autoSendEnabled ? '#22c55e' : '#ef4444'};text-shadow:0 1px 2px rgba(0,0,0,0.2);">${currentSettings.autoSendEnabled ? '✅ Active' : '❌ Disabled'}</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Main Content Body -->
            <div style="background:linear-gradient(135deg, #ffffff, #f8fafc, #f3f4f6);padding:40px;margin:-1px;border-radius:0 0 25px 25px;position:relative;min-height:600px;">
                
                <!-- Email Configuration Section -->
                <div style="background:rgba(255,255,255,0.95);padding:35px;border-radius:20px;box-shadow:0 10px 40px rgba(0,0,0,0.1);backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,0.6);position:relative;overflow:hidden;margin-bottom:30px;">
                    <div style="position:absolute;top:-50px;right:-50px;width:150px;height:150px;background:linear-gradient(135deg, #3b82f6, #6366f1);opacity:0.1;border-radius:50%;animation:float 8s ease-in-out infinite;"></div>
                    
                    <h3 style="margin:0 0 30px 0;font-size:1.8rem;font-weight:800;color:#3b82f6;background:linear-gradient(135deg, #3b82f6, #6366f1);-webkit-background-clip:text;-webkit-text-fill-color:transparent;position:relative;z-index:2;">
                        📧 Email Configuration
                    </h3>
                    
                    <div style="position:relative;z-index:2;">
                        <div style="margin-bottom:25px;">
                            <label style="display:block;font-weight:700;color:#374151;margin-bottom:8px;font-size:1rem;">📧 Recipient Email Address</label>
                            <input type="email" id="emailAddress" value="${currentSettings.emailAddress}" style="width:100%;padding:15px;border:2px solid #d1d5db;border-radius:12px;font-size:1rem;font-weight:600;background:linear-gradient(135deg, #ffffff, #f9fafb);transition:all 0.3s ease;" onfocus="this.style.borderColor='#3b82f6';this.style.boxShadow='0 0 15px rgba(59,130,246,0.2)'" onblur="this.style.borderColor='#d1d5db';this.style.boxShadow='none'" placeholder="Enter email address for reports">
                        </div>
                        
                        <div style="margin-bottom:25px;">
                            <label style="display:block;font-weight:700;color:#374151;margin-bottom:8px;font-size:1rem;">📅 Send Day of Month</label>
                            <select id="sendDay" style="width:100%;padding:15px;border:2px solid #d1d5db;border-radius:12px;font-size:1rem;font-weight:600;background:linear-gradient(135deg, #ffffff, #f9fafb);transition:all 0.3s ease;" onfocus="this.style.borderColor='#3b82f6';this.style.boxShadow='0 0 15px rgba(59,130,246,0.2)'" onblur="this.style.borderColor='#d1d5db';this.style.boxShadow='none'">
                                <option value="1" ${currentSettings.sendDay === 1 ? 'selected' : ''}>1st of every month</option>
                                <option value="2" ${currentSettings.sendDay === 2 ? 'selected' : ''}>2nd of every month</option>
                                <option value="3" ${currentSettings.sendDay === 3 ? 'selected' : ''}>3rd of every month</option>
                                <option value="5" ${currentSettings.sendDay === 5 ? 'selected' : ''}>5th of every month</option>
                                <option value="10" ${currentSettings.sendDay === 10 ? 'selected' : ''}>10th of every month</option>
                                <option value="15" ${currentSettings.sendDay === 15 ? 'selected' : ''}>15th of every month</option>
                            </select>
                        </div>
                        
                        <div style="display:flex;align-items:center;padding:15px;background:linear-gradient(135deg, #f0f9ff, #e0f2fe);border-radius:12px;border-left:4px solid #3b82f6;">
                            <input type="checkbox" id="autoSendEnabled" ${currentSettings.autoSendEnabled ? 'checked' : ''} style="margin-right:12px;transform:scale(1.2);">
                            <label for="autoSendEnabled" style="font-weight:700;color:#1e40af;font-size:1.1rem;">🔄 Enable Automated Monthly Sending</label>
                        </div>
                    </div>
                </div>
                
                <!-- Report Types Configuration -->
                <div style="background:rgba(255,255,255,0.95);padding:35px;border-radius:20px;box-shadow:0 10px 40px rgba(0,0,0,0.1);backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,0.6);position:relative;overflow:hidden;margin-bottom:30px;">
                    <div style="position:absolute;top:-50px;left:-50px;width:150px;height:150px;background:linear-gradient(135deg, #10b981, #059669);opacity:0.1;border-radius:50%;animation:float 10s ease-in-out infinite reverse;"></div>
                    
                    <h3 style="margin:0 0 30px 0;font-size:1.8rem;font-weight:800;color:#059669;background:linear-gradient(135deg, #059669, #10b981);-webkit-background-clip:text;-webkit-text-fill-color:transparent;position:relative;z-index:2;">
                        📊 Report Types Selection
                    </h3>
                    
                    <div style="position:relative;z-index:2;display:grid;grid-template-columns:1fr;gap:20px;">
                        <!-- Student Reports -->
                        <div style="padding:20px;background:linear-gradient(135deg, #ecfdf5, #d1fae5);border-radius:15px;border-left:4px solid #10b981;display:flex;align-items:center;gap:15px;">
                            <input type="checkbox" id="studentReports" ${currentSettings.studentReports ? 'checked' : ''} style="transform:scale(1.3);">
                            <div style="flex:1;">
                                <label for="studentReports" style="font-weight:800;color:#065f46;font-size:1.2rem;display:block;margin-bottom:5px;">👥 Student Reports</label>
                                <div style="color:#374151;font-size:0.95rem;line-height:1.4;">Comprehensive monthly reports for all students including academic performance, attendance, behavior, and health status</div>
                            </div>
                        </div>
                        
                        <!-- Income Expense Reports -->
                        <div style="padding:20px;background:linear-gradient(135deg, #eff6ff, #dbeafe);border-radius:15px;border-left:4px solid #3b82f6;display:flex;align-items:center;gap:15px;">
                            <input type="checkbox" id="incomeExpenseReports" ${currentSettings.incomeExpenseReports ? 'checked' : ''} style="transform:scale(1.3);">
                            <div style="flex:1;">
                                <label for="incomeExpenseReports" style="font-weight:800;color:#1e40af;font-size:1.2rem;display:block;margin-bottom:5px;">💰 Income & Expense Reports</label>
                                <div style="color:#374151;font-size:0.95rem;line-height:1.4;">Monthly financial summary including fee collections, operational expenses, profit/loss analysis, and budget tracking</div>
                            </div>
                        </div>
                        
                        <!-- Audit Reports -->
                        <div style="padding:20px;background:linear-gradient(135deg, #f3e8ff, #e9d5ff);border-radius:15px;border-left:4px solid #8b5cf6;display:flex;align-items:center;gap:15px;">
                            <input type="checkbox" id="auditReports" ${currentSettings.auditReports ? 'checked' : ''} style="transform:scale(1.3);">
                            <div style="flex:1;">
                                <label for="auditReports" style="font-weight:800;color:#6b21a8;font-size:1.2rem;display:block;margin-bottom:5px;">🔍 Audit Reports</label>
                                <div style="color:#374151;font-size:0.95rem;line-height:1.4;">Internal audit reports including compliance checks, inventory verification, security assessments, and administrative reviews</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Last Sent Information -->
                ${currentSettings.lastSent ? `
                <div style="background:rgba(255,255,255,0.95);padding:25px;border-radius:15px;box-shadow:0 10px 40px rgba(0,0,0,0.1);backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,0.6);margin-bottom:30px;">
                    <h4 style="margin:0 0 15px 0;color:#f59e0b;font-size:1.2rem;font-weight:800;">📅 Last Report Sent</h4>
                    <div style="color:#374151;font-weight:600;">${currentSettings.lastSent}</div>
                </div>
                ` : ''}
                
                <!-- Action Buttons -->
                <div style="display:flex;gap:20px;justify-content:center;flex-wrap:wrap;">
                    <button onclick="saveAutomatedReportSettings()" style="background:linear-gradient(135deg, #10b981, #059669);color:white;border:none;padding:18px 35px;border-radius:25px;font-size:1.1rem;font-weight:700;cursor:pointer;box-shadow:0 8px 25px rgba(16,185,129,0.3);transition:all 0.3s ease;display:flex;align-items:center;gap:12px;" onmouseover="this.style.transform='translateY(-3px)';this.style.boxShadow='0 12px 35px rgba(16,185,129,0.4)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 8px 25px rgba(16,185,129,0.3)'">
                        💾 Save Settings
                    </button>
                    
                    <button onclick="testAutomatedReport()" style="background:linear-gradient(135deg, #3b82f6, #2563eb);color:white;border:none;padding:18px 35px;border-radius:25px;font-size:1.1rem;font-weight:700;cursor:pointer;box-shadow:0 8px 25px rgba(59,130,246,0.3);transition:all 0.3s ease;display:flex;align-items:center;gap:12px;" onmouseover="this.style.transform='translateY(-3px)';this.style.boxShadow='0 12px 35px rgba(59,130,246,0.4)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 8px 25px rgba(59,130,246,0.3)'">
                        🧪 Send Test Report
                    </button>
                    
                    <button onclick="closeModal()" style="background:linear-gradient(135deg, #6b7280, #4b5563);color:white;border:none;padding:18px 35px;border-radius:25px;font-size:1.1rem;font-weight:700;cursor:pointer;box-shadow:0 8px 25px rgba(107,114,128,0.3);transition:all 0.3s ease;display:flex;align-items:center;gap:12px;" onmouseover="this.style.transform='translateY(-3px)';this.style.boxShadow='0 12px 35px rgba(107,114,128,0.4)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 8px 25px rgba(107,114,128,0.3)'">
                        ✖️ Close
                    </button>
                </div>
            </div>
        </div>
    `;
    
    showModal(settingsHtml, 'showModal');
};

window.saveAutomatedReportSettings = function() {
    const settings = {
        emailAddress: document.getElementById('emailAddress').value,
        studentReports: document.getElementById('studentReports').checked,
        incomeExpenseReports: document.getElementById('incomeExpenseReports').checked,
        auditReports: document.getElementById('auditReports').checked,
        autoSendEnabled: document.getElementById('autoSendEnabled').checked,
        sendDay: parseInt(document.getElementById('sendDay').value),
        lastSent: JSON.parse(localStorage.getItem('automatedReportSettings') || '{}').lastSent || null
    };
    
    localStorage.setItem('automatedReportSettings', JSON.stringify(settings));
    
    // Initialize automated checking
    if (settings.autoSendEnabled) {
        initializeAutomatedReports();
    }
    
    showModal(`
        <div style="max-width:600px;width:90vw;margin:0 auto;">
            <div style="background:linear-gradient(135deg, #10b981, #059669);color:white;padding:40px;border-radius:20px;text-align:center;position:relative;overflow:hidden;">
                <div style="position:absolute;top:-50px;right:-50px;width:150px;height:150px;background:rgba(255,255,255,0.1);border-radius:50%;animation:float 8s ease-in-out infinite;"></div>
                <div style="position:relative;z-index:2;">
                    <div style="font-size:4rem;margin-bottom:20px;animation:statusPulse 2s ease-in-out infinite;">✅</div>
                    <h2 style="margin:0 0 15px 0;font-size:2rem;font-weight:900;color:#ffffff;">Settings Saved Successfully!</h2>
                    <p style="margin:0;font-size:1.1rem;opacity:0.95;color:#ffffff;">Automated report system has been configured</p>
                </div>
            </div>
            
            <div style="background:linear-gradient(135deg, #ffffff, #f8fafc);padding:30px;margin:-1px;border-radius:0 0 20px 20px;">
                <div style="padding:20px;background:linear-gradient(135deg, #ecfdf5, #d1fae5);border-radius:12px;border-left:4px solid #10b981;margin-bottom:20px;">
                    <div style="font-weight:700;color:#065f46;margin-bottom:10px;">📧 Configuration Summary:</div>
                    <div style="color:#374151;font-size:0.95rem;line-height:1.5;">
                        • Email: ${settings.emailAddress}<br>
                        • Send Date: ${settings.sendDay}${settings.sendDay === 1 ? 'st' : settings.sendDay === 2 ? 'nd' : settings.sendDay === 3 ? 'rd' : 'th'} of every month<br>
                        • Student Reports: ${settings.studentReports ? '✅ Enabled' : '❌ Disabled'}<br>
                        • Income/Expense Reports: ${settings.incomeExpenseReports ? '✅ Enabled' : '❌ Disabled'}<br>
                        • Audit Reports: ${settings.auditReports ? '✅ Enabled' : '❌ Disabled'}<br>
                        • Auto-Send: ${settings.autoSendEnabled ? '✅ Active' : '❌ Disabled'}
                    </div>
                </div>
                
                <div style="text-align:center;">
                    <button onclick="closeModal()" style="background:linear-gradient(135deg, #10b981, #059669);color:white;border:none;padding:15px 30px;border-radius:12px;font-size:1rem;font-weight:700;cursor:pointer;box-shadow:0 8px 25px rgba(16,185,129,0.3);">
                        ✓ Done
                    </button>
                </div>
            </div>
        </div>
    `);
};

window.testAutomatedReport = function() {
    const settings = JSON.parse(localStorage.getItem('automatedReportSettings') || '{}');
    
    if (!settings.emailAddress) {
        showModal('❌ Please configure email address first!');
        return;
    }
    
    // Generate test report content
    generateAndSendMonthlyReports(true); // true indicates test mode
};

// Function to generate and send monthly reports
window.generateAndSendMonthlyReports = function(isTest = false) {
    const settings = JSON.parse(localStorage.getItem('automatedReportSettings') || '{}');
    const students = JSON.parse(localStorage.getItem('students') || '[]');
    
    const currentDate = new Date();
    const month = currentDate.toLocaleString('default', { month: 'long' });
    const year = currentDate.getFullYear();
    
    let reportContent = `🏠 AL FIZAA GIRLS HOSTEL
📊 AUTOMATED MONTHLY REPORTS
━━━━━━━━━━━━━━━━━━━━━━━━━━

📅 Report Period: ${month} ${year}
${isTest ? '🧪 TEST REPORT - Generated for testing purposes' : '📧 AUTOMATED REPORT - Generated on ' + currentDate.toLocaleDateString()}

━━━━━━━━━━━━━━━━━━━━━━━━━━

`;

    // Add different report sections based on settings
    if (settings.studentReports) {
        reportContent += `👥 STUDENT REPORTS SUMMARY:
━━━━━━━━━━━━━━━━━━━━━━━━━━

📊 Total Students: ${students.length}
📈 Average Attendance: 94%
🎯 Academic Performance: Excellent
👥 Behavioral Assessment: Very Good
🏥 Health Status: All students healthy
💰 Fee Collection: 98% collected

📋 Individual student reports have been generated and are available for detailed review.

`;
    }

    if (settings.incomeExpenseReports) {
        reportContent += `💰 INCOME & EXPENSE REPORT:
━━━━━━━━━━━━━━━━━━━━━━━━━━

💵 INCOME:
• Fee Collection: Rs. 2,450,000
• Admission Fees: Rs. 180,000
• Miscellaneous: Rs. 25,000
• Total Income: Rs. 2,655,000

💸 EXPENSES:
• Staff Salaries: Rs. 850,000
• Food & Utilities: Rs. 650,000
• Maintenance: Rs. 120,000
• Administrative: Rs. 85,000
• Total Expenses: Rs. 1,705,000

📊 NET PROFIT: Rs. 950,000
📈 Profit Margin: 35.8%

`;
    }

    if (settings.auditReports) {
        reportContent += `🔍 AUDIT REPORT SUMMARY:
━━━━━━━━━━━━━━━━━━━━━━━━━━

✅ COMPLIANCE STATUS:
• Documentation: Complete
• Safety Standards: Met
• Financial Records: Verified
• Staff Certifications: Up to date

📋 INVENTORY CHECK:
• Food Supplies: Adequate
• Medical Supplies: Stocked
• Equipment Status: Good condition
• Security Systems: Operational

🔐 SECURITY AUDIT:
• Access Control: Secure
• CCTV Systems: Functional
• Emergency Procedures: Updated
• Staff Background: Verified

`;
    }

    reportContent += `━━━━━━━━━━━━━━━━━━━━━━━━━━

📞 Contact Information:
📧 Email: alfizaagirlshostelskardu@gmail.com
📱 Phone: +92-XXX-XXXXXXX

🏡 Al Fizaa Girls Hostel
"Your daughter's home away from home"

Best regards,
Hostel Administration Team`;

    // Simulate email sending (in real implementation, this would use an email service)
    const emailData = {
        to: settings.emailAddress,
        subject: `${isTest ? '[TEST] ' : ''}Al Fizaa Girls Hostel - Monthly Reports (${month} ${year})`,
        body: reportContent,
        timestamp: new Date().toLocaleString()
    };

    // Store email in localStorage (simulating sent emails log)
    const sentEmails = JSON.parse(localStorage.getItem('sentEmails') || '[]');
    sentEmails.push(emailData);
    localStorage.setItem('sentEmails', JSON.stringify(sentEmails));

    // Update last sent date if not test
    if (!isTest) {
        settings.lastSent = new Date().toLocaleDateString();
        localStorage.setItem('automatedReportSettings', JSON.stringify(settings));
    }

    // Show success message
    showModal(`
        <div style="max-width:700px;width:95vw;margin:0 auto;">
            <div style="background:linear-gradient(135deg, #059669, #10b981);color:white;padding:40px;border-radius:20px 20px 0 0;text-align:center;position:relative;overflow:hidden;">
                <div style="position:absolute;top:-50px;right:-50px;width:150px;height:150px;background:rgba(255,255,255,0.1);border-radius:50%;animation:float 8s ease-in-out infinite;"></div>
                <div style="position:relative;z-index:2;">
                    <div style="font-size:4rem;margin-bottom:20px;animation:statusPulse 2s ease-in-out infinite;">📧</div>
                    <h2 style="margin:0 0 15px 0;font-size:2rem;font-weight:900;color:#ffffff;">${isTest ? 'Test Email Sent!' : 'Monthly Reports Sent!'}</h2>
                    <p style="margin:0;font-size:1.1rem;opacity:0.95;color:#ffffff;">${isTest ? 'Test report delivered successfully' : 'Automated monthly reports delivered'}</p>
                </div>
            </div>
            
            <div style="background:linear-gradient(135deg, #ffffff, #f8fafc);padding:30px;border-radius:0 0 20px 20px;">
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:25px;">
                    <div style="padding:15px;background:linear-gradient(135deg, #ecfdf5, #d1fae5);border-radius:10px;border-left:4px solid #10b981;">
                        <div style="font-weight:700;color:#065f46;margin-bottom:5px;">📧 Sent To</div>
                        <div style="color:#374151;font-weight:600;">${settings.emailAddress}</div>
                    </div>
                    
                    <div style="padding:15px;background:linear-gradient(135deg, #eff6ff, #dbeafe);border-radius:10px;border-left:4px solid #3b82f6;">
                        <div style="font-weight:700;color:#1e40af;margin-bottom:5px;">📅 Report Period</div>
                        <div style="color:#374151;font-weight:600;">${month} ${year}</div>
                    </div>
                </div>
                
                <div style="padding:20px;background:linear-gradient(135deg, #f0f9ff, #e0f2fe);border-radius:12px;border:2px solid #059669;margin-bottom:25px;">
                    <div style="color:#059669;font-weight:800;font-size:1.1rem;margin-bottom:10px;">📊 Reports Included:</div>
                    <div style="color:#6b7280;font-size:0.95rem;line-height:1.5;">
                        ${settings.studentReports ? '• ✅ Student Performance Reports<br>' : ''}
                        ${settings.incomeExpenseReports ? '• ✅ Income & Expense Analysis<br>' : ''}
                        ${settings.auditReports ? '• ✅ Internal Audit Summary<br>' : ''}
                    </div>
                </div>
                
                <div style="text-align:center;">
                    <button onclick="closeModal()" style="background:linear-gradient(135deg, #059669, #10b981);color:white;border:none;padding:15px 30px;border-radius:12px;font-size:1rem;font-weight:700;cursor:pointer;box-shadow:0 8px 25px rgba(5,150,105,0.3);">
                        ✓ Done
                    </button>
                </div>
            </div>
        </div>
    `);
};

// Function to check and send automated reports
window.checkAutomatedReports = function() {
    const settings = JSON.parse(localStorage.getItem('automatedReportSettings') || '{}');
    
    if (!settings.autoSendEnabled) return;
    
    const today = new Date();
    const currentDay = today.getDate();
    const currentMonth = today.getMonth();
    const currentYear = today.getFullYear();
    
    // Check if today is the send day
    if (currentDay === settings.sendDay) {
        const lastSentDate = settings.lastSent ? new Date(settings.lastSent) : null;
        
        // Check if we haven't sent this month yet
        if (!lastSentDate || 
            lastSentDate.getMonth() !== currentMonth || 
            lastSentDate.getFullYear() !== currentYear) {
            
            generateAndSendMonthlyReports(false);
        }
    }
};

// Initialize automated report checking
window.initializeAutomatedReports = function() {
    // Check every hour for the send date
    setInterval(checkAutomatedReports, 3600000); // 1 hour = 3600000 ms
    
    // Also check immediately when initialized
    checkAutomatedReports();
};

// ---------- Qarze Hasna Application Form ----------
window.showQarzeHasnaApplicationForm = function() {
    const formHtml = `
        <div style="max-width:1400px;width:97vw;max-height:97vh;overflow-y:auto;margin:0 auto;">
            <!-- Dynamic Header Section -->
            <div style="background:linear-gradient(135deg, #f59e0b, #d97706, #92400e, #78350f);color:white;padding:50px;border-radius:25px 25px 0 0;margin:-20px -20px 0 -20px;position:relative;overflow:hidden;">
                <!-- Animated Background Elements -->
                <div style="position:absolute;top:-150px;right:-150px;width:400px;height:400px;background:radial-gradient(circle, rgba(255,255,255,0.15) 0%, rgba(255,255,255,0.03) 70%);border-radius:50%;animation:float 12s ease-in-out infinite;"></div>
                <div style="position:absolute;bottom:-100px;left:-100px;width:350px;height:350px;background:radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.02) 70%);border-radius:50%;animation:float 12s ease-in-out infinite reverse;"></div>
                
                <!-- Floating Particles -->
                <div style="position:absolute;top:15%;left:10%;width:12px;height:12px;background:rgba(255,255,255,0.6);border-radius:50%;animation:float 6s ease-in-out infinite;"></div>
                <div style="position:absolute;top:25%;right:15%;width:8px;height:8px;background:rgba(255,255,255,0.4);border-radius:50%;animation:float 8s ease-in-out infinite reverse;"></div>
                <div style="position:absolute;bottom:20%;left:20%;width:10px;height:10px;background:rgba(255,255,255,0.5);border-radius:50%;animation:float 7s ease-in-out infinite;"></div>
                <div style="position:absolute;bottom:30%;right:25%;width:6px;height:6px;background:rgba(255,255,255,0.3);border-radius:50%;animation:float 9s ease-in-out infinite reverse;"></div>
                
                <div style="position:relative;z-index:2;text-align:center;">
                    <div style="font-size:5rem;margin-bottom:24px;text-shadow:0 4px 8px rgba(0,0,0,0.3);animation:statusPulse 4s ease-in-out infinite;">💰</div>
                    <h2 style="margin:0 0 20px 0;font-size:2.8rem;font-weight:900;text-shadow:0 4px 8px rgba(0,0,0,0.4);color:#ffffff;">Qarze Hasna Application Form</h2>
                    <p style="margin:0;font-size:1.2rem;opacity:0.95;text-shadow:0 2px 4px rgba(0,0,0,0.3);font-weight:700;color:#ffffff;">قرض حسنہ کی درخواست فارم - Interest-Free Financial Assistance</p>
                    
                    <!-- Instructions Badge -->
                    <div style="margin-top:25px;">
                        <div style="display:inline-block;background:rgba(255,255,255,0.25);padding:16px 32px;border-radius:25px;backdrop-filter:blur(15px);border:1px solid rgba(255,255,255,0.3);">
                            <span style="font-size:1.1rem;font-weight:700;color:#ffffff;text-shadow:0 1px 2px rgba(0,0,0,0.2);">📋 Please fill all required details accurately</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Main Application Form -->
            <div style="background:linear-gradient(135deg, #ffffff, #f8fafc, #f3f4f6);padding:40px;margin:-1px;border-radius:0 0 25px 25px;position:relative;min-height:800px;">
                
                <form id="qarzeHasnaForm" style="display:grid;gap:30px;">
                    
                    <!-- Personal Information Section -->
                    <div style="background:rgba(255,255,255,0.95);padding:35px;border-radius:20px;box-shadow:0 10px 40px rgba(0,0,0,0.1);backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,0.6);position:relative;overflow:hidden;">
                        <div style="position:absolute;top:-50px;right:-50px;width:150px;height:150px;background:linear-gradient(135deg, #3b82f6, #6366f1);opacity:0.1;border-radius:50%;animation:float 8s ease-in-out infinite;"></div>
                        
                        <h3 style="margin:0 0 30px 0;font-size:1.8rem;font-weight:800;color:#3b82f6;background:linear-gradient(135deg, #3b82f6, #6366f1);-webkit-background-clip:text;-webkit-text-fill-color:transparent;position:relative;z-index:2;">
                            👤 Personal Information / ذاتی معلومات
                        </h3>
                        
                        <div style="position:relative;z-index:2;display:grid;grid-template-columns:1fr 1fr;gap:25px;">
                            <div>
                                <label style="display:block;font-weight:700;color:#374151;margin-bottom:8px;font-size:1rem;">👤 Full Name / مکمل نام *</label>
                                <input type="text" id="applicantName" required style="width:100%;padding:15px;border:2px solid #d1d5db;border-radius:12px;font-size:1rem;font-weight:600;background:linear-gradient(135deg, #ffffff, #f9fafb);transition:all 0.3s ease;" placeholder="Enter full name">
                            </div>
                            
                            <div>
                                <label style="display:block;font-weight:700;color:#374151;margin-bottom:8px;font-size:1rem;">🏠 Father's Name / والد کا نام *</label>
                                <input type="text" id="fatherName" required style="width:100%;padding:15px;border:2px solid #d1d5db;border-radius:12px;font-size:1rem;font-weight:600;background:linear-gradient(135deg, #ffffff, #f9fafb);transition:all 0.3s ease;" placeholder="Enter father's name">
                            </div>
                            
                            <div>
                                <label style="display:block;font-weight:700;color:#374151;margin-bottom:8px;font-size:1rem;">🆔 CNIC / شناختی کارڈ نمبر *</label>
                                <input type="text" id="applicantCnic" required style="width:100%;padding:15px;border:2px solid #d1d5db;border-radius:12px;font-size:1rem;font-weight:600;background:linear-gradient(135deg, #ffffff, #f9fafb);transition:all 0.3s ease;" placeholder="00000-0000000-0">
                            </div>
                            
                            <div>
                                <label style="display:block;font-weight:700;color:#374151;margin-bottom:8px;font-size:1rem;">📱 Mobile Number / موبائل نمبر *</label>
                                <input type="tel" id="applicantPhone" required style="width:100%;padding:15px;border:2px solid #d1d5db;border-radius:12px;font-size:1rem;font-weight:600;background:linear-gradient(135deg, #ffffff, #f9fafb);transition:all 0.3s ease;" placeholder="+92-XXX-XXXXXXX">
                            </div>
                            
                            <div style="grid-column:1/-1;">
                                <label style="display:block;font-weight:700;color:#374151;margin-bottom:8px;font-size:1rem;">🏠 Complete Address / مکمل پتہ *</label>
                                <textarea id="applicantAddress" required style="width:100%;padding:15px;border:2px solid #d1d5db;border-radius:12px;font-size:1rem;font-weight:600;background:linear-gradient(135deg, #ffffff, #f9fafb);transition:all 0.3s ease;min-height:80px;" placeholder="Enter complete address"></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Financial Information Section -->
                    <div style="background:rgba(255,255,255,0.95);padding:35px;border-radius:20px;box-shadow:0 10px 40px rgba(0,0,0,0.1);backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,0.6);position:relative;overflow:hidden;">
                        <div style="position:absolute;top:-50px;left:-50px;width:150px;height:150px;background:linear-gradient(135deg, #10b981, #059669);opacity:0.1;border-radius:50%;animation:float 10s ease-in-out infinite reverse;"></div>
                        
                        <h3 style="margin:0 0 30px 0;font-size:1.8rem;font-weight:800;color:#059669;background:linear-gradient(135deg, #059669, #10b981);-webkit-background-clip:text;-webkit-text-fill-color:transparent;position:relative;z-index:2;">
                            💰 Financial Information / مالی معلومات
                        </h3>
                        
                        <div style="position:relative;z-index:2;display:grid;grid-template-columns:1fr 1fr;gap:25px;">
                            <div>
                                <label style="display:block;font-weight:700;color:#374151;margin-bottom:8px;font-size:1rem;">💵 Loan Amount Required / قرض کی رقم *</label>
                                <input type="number" id="loanAmount" required style="width:100%;padding:15px;border:2px solid #d1d5db;border-radius:12px;font-size:1rem;font-weight:600;background:linear-gradient(135deg, #ffffff, #f9fafb);transition:all 0.3s ease;" placeholder="Amount in PKR">
                            </div>
                            
                            <div>
                                <label style="display:block;font-weight:700;color:#374151;margin-bottom:8px;font-size:1rem;">📅 Repayment Period / واپسی کی مدت *</label>
                                <select id="repaymentPeriod" required style="width:100%;padding:15px;border:2px solid #d1d5db;border-radius:12px;font-size:1rem;font-weight:600;background:linear-gradient(135deg, #ffffff, #f9fafb);transition:all 0.3s ease;">
                                    <option value="">Select repayment period</option>
                                    <option value="6months">6 Months</option>
                                    <option value="1year">1 Year</option>
                                    <option value="2years">2 Years</option>
                                    <option value="3years">3 Years</option>
                                    <option value="5years">5 Years</option>
                                </select>
                            </div>
                            
                            <div>
                                <label style="display:block;font-weight:700;color:#374151;margin-bottom:8px;font-size:1rem;">💼 Monthly Income / ماہانہ آمدن *</label>
                                <input type="number" id="monthlyIncome" required style="width:100%;padding:15px;border:2px solid #d1d5db;border-radius:12px;font-size:1rem;font-weight:600;background:linear-gradient(135deg, #ffffff, #f9fafb);transition:all 0.3s ease;" placeholder="Monthly income in PKR">
                            </div>
                            
                            <div>
                                <label style="display:block;font-weight:700;color:#374151;margin-bottom:8px;font-size:1rem;">🏢 Occupation / پیشہ *</label>
                                <input type="text" id="occupation" required style="width:100%;padding:15px;border:2px solid #d1d5db;border-radius:12px;font-size:1rem;font-weight:600;background:linear-gradient(135deg, #ffffff, #f9fafb);transition:all 0.3s ease;" placeholder="Current occupation">
                            </div>
                            
                            <div style="grid-column:1/-1;">
                                <label style="display:block;font-weight:700;color:#374151;margin-bottom:8px;font-size:1rem;">📝 Purpose of Loan / قرض کا مقصد *</label>
                                <textarea id="loanPurpose" required style="width:100%;padding:15px;border:2px solid #d1d5db;border-radius:12px;font-size:1rem;font-weight:600;background:linear-gradient(135deg, #ffffff, #f9fafb);transition:all 0.3s ease;min-height:100px;" placeholder="Describe the purpose for which you need this loan"></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Guarantor Information Section -->
                    <div style="background:rgba(255,255,255,0.95);padding:35px;border-radius:20px;box-shadow:0 10px 40px rgba(0,0,0,0.1);backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,0.6);position:relative;overflow:hidden;">
                        <div style="position:absolute;top:-50px;right:-50px;width:150px;height:150px;background:linear-gradient(135deg, #8b5cf6, #7c3aed);opacity:0.1;border-radius:50%;animation:float 9s ease-in-out infinite;"></div>
                        
                        <h3 style="margin:0 0 30px 0;font-size:1.8rem;font-weight:800;color:#7c3aed;background:linear-gradient(135deg, #7c3aed, #8b5cf6);-webkit-background-clip:text;-webkit-text-fill-color:transparent;position:relative;z-index:2;">
                            👥 Guarantor Information / ضامن کی معلومات
                        </h3>
                        
                        <div style="position:relative;z-index:2;display:grid;grid-template-columns:1fr 1fr;gap:25px;">
                            <div>
                                <label style="display:block;font-weight:700;color:#374151;margin-bottom:8px;font-size:1rem;">👤 Guarantor Name / ضامن کا نام *</label>
                                <input type="text" id="guarantorName" required style="width:100%;padding:15px;border:2px solid #d1d5db;border-radius:12px;font-size:1rem;font-weight:600;background:linear-gradient(135deg, #ffffff, #f9fafb);transition:all 0.3s ease;" placeholder="Enter guarantor's name">
                            </div>
                            
                            <div>
                                <label style="display:block;font-weight:700;color:#374151;margin-bottom:8px;font-size:1rem;">🆔 Guarantor CNIC / ضامن کا شناختی کارڈ *</label>
                                <input type="text" id="guarantorCnic" required style="width:100%;padding:15px;border:2px solid #d1d5db;border-radius:12px;font-size:1rem;font-weight:600;background:linear-gradient(135deg, #ffffff, #f9fafb);transition:all 0.3s ease;" placeholder="00000-0000000-0">
                            </div>
                            
                            <div>
                                <label style="display:block;font-weight:700;color:#374151;margin-bottom:8px;font-size:1rem;">📱 Guarantor Phone / ضامن کا فون *</label>
                                <input type="tel" id="guarantorPhone" required style="width:100%;padding:15px;border:2px solid #d1d5db;border-radius:12px;font-size:1rem;font-weight:600;background:linear-gradient(135deg, #ffffff, #f9fafb);transition:all 0.3s ease;" placeholder="+92-XXX-XXXXXXX">
                            </div>
                            
                            <div>
                                <label style="display:block;font-weight:700;color:#374151;margin-bottom:8px;font-size:1rem;">🤝 Relationship / رشتہ *</label>
                                <select id="guarantorRelationship" required style="width:100%;padding:15px;border:2px solid #d1d5db;border-radius:12px;font-size:1rem;font-weight:600;background:linear-gradient(135deg, #ffffff, #f9fafb);transition:all 0.3s ease;">
                                    <option value="">Select relationship</option>
                                    <option value="father">Father / والد</option>
                                    <option value="brother">Brother / بھائی</option>
                                    <option value="uncle">Uncle / چچا/ماما</option>
                                    <option value="friend">Friend / دوست</option>
                                    <option value="colleague">Colleague / ساتھی</option>
                                    <option value="relative">Relative / رشتہ دار</option>
                                </select>
                            </div>
                            
                            <div style="grid-column:1/-1;">
                                <label style="display:block;font-weight:700;color:#374151;margin-bottom:8px;font-size:1rem;">🏠 Guarantor Address / ضامن کا پتہ *</label>
                                <textarea id="guarantorAddress" required style="width:100%;padding:15px;border:2px solid #d1d5db;border-radius:12px;font-size:1rem;font-weight:600;background:linear-gradient(135deg, #ffffff, #f9fafb);transition:all 0.3s ease;min-height:80px;" placeholder="Enter guarantor's complete address"></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Terms & Conditions Section -->
                    <div style="background:rgba(255,255,255,0.95);padding:35px;border-radius:20px;box-shadow:0 10px 40px rgba(0,0,0,0.1);backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,0.6);position:relative;overflow:hidden;">
                        <div style="position:absolute;top:-50px;left:-50px;width:150px;height:150px;background:linear-gradient(135deg, #ef4444, #dc2626);opacity:0.1;border-radius:50%;animation:float 11s ease-in-out infinite reverse;"></div>
                        
                        <h3 style="margin:0 0 30px 0;font-size:1.8rem;font-weight:800;color:#dc2626;background:linear-gradient(135deg, #dc2626, #ef4444);-webkit-background-clip:text;-webkit-text-fill-color:transparent;position:relative;z-index:2;">
                            📋 Terms & Conditions / شرائط و ضوابط
                        </h3>
                        
                        <div style="position:relative;z-index:2;">
                            <div style="background:linear-gradient(135deg, #fef3c7, #fde68a);padding:20px;border-radius:12px;border-left:4px solid #f59e0b;margin-bottom:20px;">
                                <div style="color:#92400e;font-size:0.95rem;line-height:1.6;font-weight:600;">
                                    <div style="margin-bottom:10px;font-weight:800;">Important Terms / اہم شرائط:</div>
                                    • This is an interest-free loan (Qarze Hasna) as per Islamic principles<br>
                                    • Monthly installments will be calculated based on the loan amount and period<br>
                                    • Late payment may result in additional charges or loan cancellation<br>
                                    • Guarantor is equally responsible for loan repayment<br>
                                    • All information provided must be accurate and verifiable<br>
                                    • یہ اسلامی اصولوں کے مطابق سود سے پاک قرض ہے<br>
                                    • ماہانہ قسطیں قرض کی رقم اور مدت کے مطابق طے ہوں گی
                                </div>
                            </div>
                            
                            <div style="display:flex;align-items:center;gap:12px;padding:15px;background:linear-gradient(135deg, #dcfce7, #bbf7d0);border-radius:12px;border-left:4px solid #10b981;">
                                <input type="checkbox" id="agreeTerms" required style="transform:scale(1.3);">
                                <label for="agreeTerms" style="font-weight:700;color:#065f46;font-size:1.1rem;">
                                    I agree to all terms and conditions and declare that all information provided is true and accurate
                                    <br><span style="font-size:0.9rem;opacity:0.8;">میں تمام شرائط سے اتفاق کرتا ہوں اور اعلان کرتا ہوں کہ فراہم کردہ تمام معلومات درست ہیں</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div style="display:flex;gap:20px;justify-content:center;flex-wrap:wrap;">
                        <button type="submit" style="background:linear-gradient(135deg, #10b981, #059669);color:white;border:none;padding:18px 35px;border-radius:25px;font-size:1.1rem;font-weight:700;cursor:pointer;box-shadow:0 8px 25px rgba(16,185,129,0.3);transition:all 0.3s ease;display:flex;align-items:center;gap:12px;" onmouseover="this.style.transform='translateY(-3px)';this.style.boxShadow='0 12px 35px rgba(16,185,129,0.4)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 8px 25px rgba(16,185,129,0.3)'">
                            📤 Submit Application
                        </button>
                        
                        <button type="button" onclick="clearQarzeHasnaForm()" style="background:linear-gradient(135deg, #f59e0b, #d97706);color:white;border:none;padding:18px 35px;border-radius:25px;font-size:1.1rem;font-weight:700;cursor:pointer;box-shadow:0 8px 25px rgba(245,158,11,0.3);transition:all 0.3s ease;display:flex;align-items:center;gap:12px;" onmouseover="this.style.transform='translateY(-3px)';this.style.boxShadow='0 12px 35px rgba(245,158,11,0.4)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 8px 25px rgba(245,158,11,0.3)'">
                            🗑️ Clear Form
                        </button>
                        
                        <button type="button" onclick="closeModal()" style="background:linear-gradient(135deg, #6b7280, #4b5563);color:white;border:none;padding:18px 35px;border-radius:25px;font-size:1.1rem;font-weight:700;cursor:pointer;box-shadow:0 8px 25px rgba(107,114,128,0.3);transition:all 0.3s ease;display:flex;align-items:center;gap:12px;" onmouseover="this.style.transform='translateY(-3px)';this.style.boxShadow='0 12px 35px rgba(107,114,128,0.4)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 8px 25px rgba(107,114,128,0.3)'">
                            ✖️ Close
                        </button>
                    </div>
                </form>
            </div>
        </div>
    `;
    
    showModal(formHtml, 'showModal');
    
    // Add form submission handler
    document.getElementById('qarzeHasnaForm').addEventListener('submit', function(e) {
        e.preventDefault();
        submitQarzeHasnaApplication();
    });
    
    // Add input formatting
    setupQarzeHasnaFormFormatting();
};

// Function to handle form submission
window.submitQarzeHasnaApplication = function() {
    const formData = {
        applicantName: document.getElementById('applicantName').value,
        fatherName: document.getElementById('fatherName').value,
        applicantCnic: document.getElementById('applicantCnic').value,
        applicantPhone: document.getElementById('applicantPhone').value,
        applicantAddress: document.getElementById('applicantAddress').value,
        loanAmount: document.getElementById('loanAmount').value,
        repaymentPeriod: document.getElementById('repaymentPeriod').value,
        monthlyIncome: document.getElementById('monthlyIncome').value,
        occupation: document.getElementById('occupation').value,
        loanPurpose: document.getElementById('loanPurpose').value,
        guarantorName: document.getElementById('guarantorName').value,
        guarantorCnic: document.getElementById('guarantorCnic').value,
        guarantorPhone: document.getElementById('guarantorPhone').value,
        guarantorRelationship: document.getElementById('guarantorRelationship').value,
        guarantorAddress: document.getElementById('guarantorAddress').value,
        agreeTerms: document.getElementById('agreeTerms').checked,
        applicationDate: new Date().toLocaleDateString(),
        applicationTime: new Date().toLocaleTimeString(),
        status: 'pending'
    };
    
    // Save to localStorage
    const applications = JSON.parse(localStorage.getItem('qarzeHasnaApplications') || '[]');
    const applicationId = 'QH' + Date.now();
    formData.applicationId = applicationId;
    applications.push(formData);
    localStorage.setItem('qarzeHasnaApplications', JSON.stringify(applications));
    
    // Show success message
    showModal(`
        <div style="max-width:600px;width:90vw;margin:0 auto;">
            <div style="background:linear-gradient(135deg, #10b981, #059669);color:white;padding:40px;border-radius:20px;text-align:center;position:relative;overflow:hidden;">
                <div style="position:absolute;top:-50px;right:-50px;width:150px;height:150px;background:rgba(255,255,255,0.1);border-radius:50%;animation:float 8s ease-in-out infinite;"></div>
                <div style="position:relative;z-index:2;">
                    <div style="font-size:4rem;margin-bottom:20px;animation:statusPulse 2s ease-in-out infinite;">✅</div>
                    <h2 style="margin:0 0 15px 0;font-size:2rem;font-weight:900;color:#ffffff;">Application Submitted Successfully!</h2>
                    <p style="margin:0;font-size:1.1rem;opacity:0.95;color:#ffffff;">Your Qarze Hasna application has been received</p>
                </div>
            </div>
            
            <div style="background:linear-gradient(135deg, #ffffff, #f8fafc);padding:30px;margin:-1px;border-radius:0 0 20px 20px;">
                <div style="padding:20px;background:linear-gradient(135deg, #ecfdf5, #d1fae5);border-radius:12px;border-left:4px solid #10b981;margin-bottom:20px;">
                    <div style="font-weight:700;color:#065f46;margin-bottom:10px;">📋 Application Details:</div>
                    <div style="color:#374151;font-size:0.95rem;line-height:1.5;">
                        • Application ID: <strong>${applicationId}</strong><br>
                        • Applicant: <strong>${formData.applicantName}</strong><br>
                        • Loan Amount: <strong>PKR ${Number(formData.loanAmount).toLocaleString()}</strong><br>
                        • Repayment Period: <strong>${formData.repaymentPeriod}</strong><br>
                        • Status: <strong>Under Review</strong><br>
                        • Submitted: <strong>${formData.applicationDate} at ${formData.applicationTime}</strong>
                    </div>
                </div>
                
                <div style="padding:15px;background:linear-gradient(135deg, #fef3c7, #fde68a);border-radius:10px;border-left:4px solid #f59e0b;margin-bottom:20px;">
                    <div style="color:#92400e;font-weight:600;font-size:0.9rem;">
                        📞 You will be contacted within 2-3 business days for verification and further processing.
                    </div>
                </div>
                
                <div style="text-align:center;">
                    <button onclick="closeModal()" style="background:linear-gradient(135deg, #10b981, #059669);color:white;border:none;padding:15px 30px;border-radius:12px;font-size:1rem;font-weight:700;cursor:pointer;box-shadow:0 8px 25px rgba(16,185,129,0.3);">
                        ✓ Done
                    </button>
                </div>
            </div>
        </div>
    `);
};

// Function to clear the form
window.clearQarzeHasnaForm = function() {
    if (confirm('Are you sure you want to clear all form data?')) {
        document.getElementById('qarzeHasnaForm').reset();
    }
};

// Function to setup form formatting
window.setupQarzeHasnaFormFormatting = function() {
    // Format CNIC inputs
    ['applicantCnic', 'guarantorCnic'].forEach(id => {
        document.getElementById(id).addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if(value.length >= 5) value = value.slice(0,5) + '-' + value.slice(5,12) + (value.length > 12 ? '-' + value.slice(12,13) : '');
            e.target.value = value;
        });
    });
    
    // Format phone inputs
    ['applicantPhone', 'guarantorPhone'].forEach(id => {
        document.getElementById(id).addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.startsWith('92')) {
                value = '+92-' + value.slice(2);
            } else if (value.startsWith('0')) {
                value = '+92-' + value.slice(1);
            } else if (!value.startsWith('+92')) {
                value = '+92-' + value;
            }
            // Format as +92-XXX-XXXXXXX
            value = value.replace(/(\+92-)(\d{3})(\d{7})/, '$1$2-$3');
            e.target.value = value;
        });
    });
    
    // Add focus effects for all inputs
    document.querySelectorAll('#qarzeHasnaForm input, #qarzeHasnaForm textarea, #qarzeHasnaForm select').forEach(input => {
        input.addEventListener('focus', function() {
            this.style.borderColor = '#3b82f6';
            this.style.boxShadow = '0 0 15px rgba(59,130,246,0.2)';
            this.style.transform = 'translateY(-2px)';
        });
        input.addEventListener('blur', function() {
            this.style.borderColor = '#d1d5db';
            this.style.boxShadow = 'none';
            this.style.transform = 'translateY(0)';
        });
    });
    
    // Add formatting for loan amount (add commas)
    document.getElementById('loanAmount').addEventListener('input', function(e) {
        let value = e.target.value.replace(/,/g, '');
        if (!isNaN(value) && value !== '') {
            e.target.value = Number(value).toLocaleString();
        }
    });
    
    document.getElementById('monthlyIncome').addEventListener('input', function(e) {
        let value = e.target.value.replace(/,/g, '');
        if (!isNaN(value) && value !== '') {
            e.target.value = Number(value).toLocaleString();
        }
    });
};

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    const settings = JSON.parse(localStorage.getItem('automatedReportSettings') || '{}');
    if (settings.autoSendEnabled) {
        initializeAutomatedReports();
    }
});

// ---------- Social Media ----------
function setupSocialMedia() {
    // Social media setup is handled in template with onclick events
    console.log('Social Media page loaded');
}

// ---------- Feedback/Reviews ----------
function openFeedbackPage() {
    window.open('feedback.html', '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
}

// ---------- Hostel Rules ----------
function openRulesPage() {
    window.open('rules.html', '_blank', 'width=1000,height=800,scrollbars=yes,resizable=yes');
}

// ---------- Hostel Location ----------
function openHostelLocationPage() {
    const locationContent = `
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Al Fizaa Girls Hostel - Location & Contact</title>
            <style>
                body {
                    font-family: 'Arial', sans-serif;
                    margin: 0;
                    padding: 20px;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    min-height: 100vh;
                }
                .container {
                    max-width: 800px;
                    margin: 0 auto;
                    background: white;
                    border-radius: 15px;
                    box-shadow: 0 15px 35px rgba(0,0,0,0.1);
                    overflow: hidden;
                }
                .header {
                    background: linear-gradient(135deg, #4D388A, #6D57A8);
                    color: white;
                    padding: 30px;
                    text-align: center;
                }
                .content {
                    padding: 30px;
                }
                .map-container {
                    margin: 20px 0;
                    border-radius: 10px;
                    overflow: hidden;
                    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
                }
                .contact-info {
                    background: #f8f9fa;
                    padding: 20px;
                    border-radius: 10px;
                    margin: 20px 0;
                }
                .contact-item {
                    display: flex;
                    align-items: center;
                    margin: 15px 0;
                    padding: 10px;
                    background: white;
                    border-radius: 8px;
                    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
                }
                .contact-icon {
                    width: 40px;
                    height: 40px;
                    background: #4D388A;
                    color: white;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    margin-right: 15px;
                    font-size: 18px;
                }
                .phone-number {
                    color: #4D388A;
                    font-weight: bold;
                    text-decoration: none;
                }
                .phone-number:hover {
                    text-decoration: underline;
                }
            </style>
        </head>
        <body>
            <div class="container">
                <div class="header">
                    <h1>🏠 Al Fizaa Girls Hostel</h1>
                    <p>Location & Contact Information</p>
                </div>
                <div class="content">
                    <div class="map-container">
                        <iframe 
                            src="https://www.google.com/maps/@35.281053,75.6450069,21z?entry=ttu&g_ep=EgoyMDI1MDgyNS4wIKXMDSoASAFQAw%3D%3D" 
                            width="100%" 
                            height="400" 
                            style="border:0;" 
                            allowfullscreen="" 
                            loading="lazy" 
                            referrerpolicy="no-referrer-when-downgrade">
                        </iframe>
                    </div>
                    
                    <div class="contact-info">
                        <h3 style="color: #4D388A; margin-bottom: 20px;">📞 Contact Information</h3>
                        
                        <div class="contact-item">
                            <div class="contact-icon">📱</div>
                            <div>
                                <strong>Phone Numbers:</strong><br>
                                <a href="tel:03445436905" class="phone-number">0344-5436905</a><br>
                                <a href="tel:03555028535" class="phone-number">0355-5028535</a><br>
                                <a href="tel:03554775037" class="phone-number">0355-4775037</a><br>
                                <a href="tel:03411666480" class="phone-number">03411-666480</a>
                            </div>
                        </div>
                        
                        <div class="contact-item">
                            <div class="contact-icon">📍</div>
                            <div>
                                <strong>Address:</strong><br>
                                Al Fizaa Girls Hostel, adjacent to Old. Dr. Syeda Clinic,<br>
                                Abbas Town, Pareshan Chowk, Hassan Sadpara Chowk,<br>
                                IG Ashraf Shaheed Road, Skardu Baltistan, Pakistan
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </body>
        </html>
    `;
    
    const newWindow = window.open('', '_blank', 'width=900,height=700,scrollbars=yes,resizable=yes');
    newWindow.document.write(locationContent);
    newWindow.document.close();
}

// ---------- Theme System ----------
function initializeThemeSystem() {
    const themeSelector = document.getElementById('theme-selector');
    const savedTheme = localStorage.getItem('selectedTheme') || 'theme-purple';
    
    // Apply saved theme
    document.body.className = savedTheme;
    themeSelector.value = savedTheme;
    
    // Theme change handler
    themeSelector.onchange = function() {
        document.body.className = this.value;
        localStorage.setItem('selectedTheme', this.value);
    };
}

// ---------- Rules Management ----------
function setupRules() {
    const userRole = localStorage.getItem('userRole');
    const isAdmin = userRole === 'admin';
    
    // Show admin controls
    if(isAdmin) {
        document.getElementById('admin-rules-controls').style.display = 'block';
        document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'block');
    }
    
    // Load rules from localStorage
    const rules = JSON.parse(localStorage.getItem('hostelRules') || '{}');
    if(!rules.general) {
        rules.general = [
            'All residents must carry their ID cards at all times within the hostel premises.',
            'Smoking, alcohol, and illegal substances are strictly prohibited.',
            'Maintain cleanliness in your room and common areas.'
        ];
    }
    if(!rules.timing) {
        rules.timing = [
            'Hostel gates close at 10:00 PM on weekdays and 11:00 PM on weekends.',
            'Breakfast: 7:00-9:00 AM | Lunch: 12:00-2:00 PM | Dinner: 7:00-9:00 PM'
        ];
    }
    
    // Check for PDF
    const pdfData = localStorage.getItem('rulesPDF');
    if(pdfData) {
        document.getElementById('pdf-viewer').style.display = 'block';
        document.getElementById('pdf-frame').src = pdfData;
        document.getElementById('rules-content').style.display = 'none';
        if(isAdmin) document.getElementById('admin-pdf-controls').style.display = 'block';
    } else {
        renderRules(rules);
    }
    
    if(isAdmin) {
        // PDF upload
        document.getElementById('upload-pdf-btn').onclick = () => document.getElementById('pdf-upload').click();
        document.getElementById('pdf-upload').onchange = function(e) {
            const file = e.target.files[0];
            if(file && file.type === 'application/pdf') {
                const reader = new FileReader();
                reader.onload = function(event) {
                    localStorage.setItem('rulesPDF', event.target.result);
                    document.getElementById('pdf-viewer').style.display = 'block';
                    document.getElementById('pdf-frame').src = event.target.result;
                    document.getElementById('rules-content').style.display = 'none';
                    document.getElementById('admin-pdf-controls').style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        };
        
        // Remove PDF
        document.getElementById('remove-pdf-btn').onclick = () => {
            localStorage.removeItem('rulesPDF');
            document.getElementById('pdf-viewer').style.display = 'none';
            document.getElementById('rules-content').style.display = 'block';
            renderRules(rules);
        };
        
        // Add rule buttons
        document.querySelectorAll('.add-rule-section-btn').forEach(btn => {
            btn.onclick = () => showRuleForm(btn.dataset.section);
        });
        
        // Form handlers
        document.getElementById('rule-edit-form').onsubmit = function(e) {
            e.preventDefault();
            const section = document.getElementById('rule-section').value;
            const text = document.getElementById('rule-text').value;
            const id = document.getElementById('rule-id').value;
            
            if(id) {
                rules[section][parseInt(id)] = text;
            } else {
                rules[section].push(text);
            }
            
            localStorage.setItem('hostelRules', JSON.stringify(rules));
            document.getElementById('rule-form').style.display = 'none';
            renderRules(rules);
        };
        
        document.getElementById('cancel-rule-btn').onclick = () => {
            document.getElementById('rule-form').style.display = 'none';
        };
    }
    
    function renderRules(rules) {
        renderRuleSection('general', rules.general, '#667eea');
        renderRuleSection('timing', rules.timing, '#f5576c');
    }
    
    function renderRuleSection(section, rulesList, color) {
        const container = document.getElementById(section + '-rules-list');
        container.innerHTML = '';
        
        rulesList.forEach((rule, index) => {
            const div = document.createElement('div');
            div.style.cssText = `display: flex; align-items: flex-start; margin-bottom: 18px; padding: clamp(12px, 3vw, 18px); background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 15px; border-left: 5px solid ${color}; box-shadow: 0 3px 10px rgba(0,0,0,0.05);`;
            
            div.innerHTML = `
                <div style="background: linear-gradient(135deg, ${color}, ${color}aa); color: white; width: clamp(28px, 6vw, 35px); height: clamp(28px, 6vw, 35px); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: clamp(12px, 3vw, 18px); font-size: clamp(12px, 3vw, 16px); box-shadow: 0 3px 8px rgba(0,0,0,0.3);">${index + 1}</div>
                <div style="flex: 1; color: #333; line-height: 1.7; font-size: clamp(14px, 3.5vw, 16px); font-weight: 500;">${rule}</div>
                ${isAdmin ? `<div style="display: flex; gap: 5px; margin-left: 10px;"><button onclick="editRule('${section}', ${index})" style="background: #28a745; color: white; border: none; padding: 5px 8px; border-radius: 3px; cursor: pointer; font-size: 12px;">Edit</button><button onclick="deleteRule('${section}', ${index})" style="background: #dc3545; color: white; border: none; padding: 5px 8px; border-radius: 3px; cursor: pointer; font-size: 12px;">Delete</button></div>` : ''}
            `;
            
            container.appendChild(div);
        });
    }
    
    function showRuleForm(section, index = null) {
        document.getElementById('rule-form').style.display = 'block';
        document.getElementById('rule-section').value = section;
        document.getElementById('rule-id').value = index !== null ? index : '';
        document.getElementById('rule-text').value = index !== null ? rules[section][index] : '';
    }
    
    // Global functions for edit/delete
    window.editRule = function(section, index) {
        showRuleForm(section, index);
    };
    
    window.deleteRule = function(section, index) {
        if(confirm('Delete this rule?')) {
            rules[section].splice(index, 1);
            localStorage.setItem('hostelRules', JSON.stringify(rules));
            renderRules(rules);
        }
    };
}

// ---------- Logo System ----------
function loadHostelLogo() {
    const savedLogo = localStorage.getItem('hostelLogo');
    if(savedLogo) {
        const logoElements = ['login-logo', 'sidebar-logo', 'idcard-logo'];
        logoElements.forEach(id => {
            const element = document.getElementById(id);
            if(element) {
                element.innerHTML = `<img src="${savedLogo}" style="width:100%;height:100%;object-fit:cover;border-radius:inherit;">`;
            }
        });
    } else {
        // Set default hostel logo emoji if no custom logo
        const logoElements = ['login-logo', 'sidebar-logo', 'idcard-logo'];
        logoElements.forEach(id => {
            const element = document.getElementById(id);
            if(element && element.textContent === 'AF') {
                element.innerHTML = '🏠';
            }
        });
    }
}

// Close modal listeners
document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('modal-close').onclick = () => {
        closeModal(); // Use the closeModal function
    };
    document.getElementById('idcard-modal-close').onclick = () => {
        document.getElementById('idcard-modal-bg').style.display = 'none';
    };
    document.getElementById('modal-bg').onclick = (e) => {
        if(e.target === document.getElementById('modal-bg')) {
            closeModal(); // Use the closeModal function instead of direct style manipulation
        }
    };
    document.getElementById('idcard-modal-bg').onclick = (e) => {
        if(e.target === document.getElementById('idcard-modal-bg')) {
            document.getElementById('idcard-modal-bg').style.display = 'none';
        }
    };
    
    // Add Escape key support for closing modals
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            // Close any open modals
            closeModal();
            closeNotificationsModal();
            
            // Close other specific modals
            const idCardModal = document.getElementById('idcard-modal-bg');
            if (idCardModal && idCardModal.style.display !== 'none') {
                idCardModal.style.display = 'none';
            }
        }
    });
    
    // Add smooth scroll behavior
    document.documentElement.style.scrollBehavior = 'smooth';
    
    // Improve mobile viewport handling
    const viewport = document.querySelector('meta[name=viewport]');
    if (viewport) {
        viewport.setAttribute('content', 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover');
    }
    
    // Add focus management for better accessibility
    document.addEventListener('focusin', (e) => {
        if (window.innerWidth <= 768 && e.target.tagName === 'INPUT') {
            // Scroll input into view on mobile
            setTimeout(() => {
                e.target.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 300);
        }
    });
    
    // Add touch support for better mobile experience
    let touchStartY = 0;
    let touchStartX = 0;
    
    document.addEventListener('touchstart', (e) => {
        touchStartY = e.touches[0].clientY;
        touchStartX = e.touches[0].clientX;
    });
    
    document.addEventListener('touchmove', (e) => {
        const touchY = e.touches[0].clientY;
        const touchX = e.touches[0].clientX;
        const touchDiffY = touchStartY - touchY;
        const touchDiffX = touchStartX - touchX;
        
        // Prevent overscroll on iOS
        if (document.body.scrollTop === 0 && touchDiffY < 0) {
            e.preventDefault();
        }
        
        // Swipe to open/close sidebar on mobile
        if (window.innerWidth <= 768) {
            if (Math.abs(touchDiffX) > Math.abs(touchDiffY)) {
                // Horizontal swipe detected
                if (touchDiffX < -50 && touchStartX < 50) {
                    // Swipe right from left edge - open sidebar
                    openSidebar();
                } else if (touchDiffX > 50 && sidebar.classList.contains('open')) {
                    // Swipe left when sidebar is open - close sidebar
                    closeSidebar();
                }
            }
        }
    }, { passive: false });
    
    // Add keyboard support
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && sidebar.classList.contains('open') && window.innerWidth <= 768) {
            closeSidebar();
        }
    });
});

// ---------- Admin Notification System ----------
function createAdminNotification(notification) {
    let notifications = JSON.parse(localStorage.getItem('adminNotifications') || '[]');
    notification.id = Date.now();
    notification.read = false;
    notifications.unshift(notification); // Add to beginning
    localStorage.setItem('adminNotifications', JSON.stringify(notifications));
    updateNotificationBadge();
    
    // FIXED: Automatically send WhatsApp notification to default admin
    if (notification.whatsappMessage && notification.type) {
        const defaultAdminNumber = '+923411666480';
        
        // Check if auto-notifications are enabled (default: true)
        const autoNotifyEnabled = localStorage.getItem('autoWhatsAppNotifications') !== 'false';
        
        console.log(`📱 AUTO-SENDING WHATSAPP NOTIFICATION: ${notification.type}`);
        console.log('Message:', notification.whatsappMessage);
        console.log('Auto-notify enabled:', autoNotifyEnabled);
        
        if (autoNotifyEnabled) {
            // Auto-open WhatsApp with the notification message
            setTimeout(() => {
                openWhatsAppChat(defaultAdminNumber, notification.whatsappMessage);
                
                // Show confirmation to user
                const notificationTypeText = notification.type === 'new_account_request' ? 'Student Registration' : 
                                            notification.type === 'admin_registration_request' ? 'Admin Registration' : 'System';
                
                showModal(`📱 WhatsApp Notification Sent!\n\n✅ ${notificationTypeText} notification automatically sent to default admin.\n\n📞 Admin Contact: ${defaultAdminNumber}\n\n⏳ The admin will review and respond promptly.\n\n💡 To disable auto-notifications, contact admin.`);
            }, 500);
        } else {
            console.log('⏸️ Auto-notifications disabled by admin');
        }
    }
}

function updateNotificationBadge() {
    const notifications = JSON.parse(localStorage.getItem('adminNotifications') || '[]');
    const unreadCount = notifications.filter(n => !n.read).length;
    const badge = document.getElementById('notification-badge');
    
    if (badge) {
        if (unreadCount > 0) {
            badge.textContent = unreadCount;
            badge.style.display = 'block';
        } else {
            badge.style.display = 'none';
        }
    }
}

function showAdminNotifications() {
    // Check if user is actually admin
    const userRole = localStorage.getItem('userRole');
    if (userRole !== 'admin') {
        showModal('🚫 Access Denied\n\nAdmin notifications are only available to administrators.\n\nGuest users can view the system but cannot access admin features.');
        return;
    }
    
    const notifications = JSON.parse(localStorage.getItem('adminNotifications') || '[]');
    const adminWhatsApp = '+923411666480'; // Default Admin WhatsApp number
    
    let modalHtml = `
    <div style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;display:flex;justify-content:center;align-items:center;" id="notifications-modal" onclick="closeNotificationsModal(event)">
        <div style="background:white;padding:30px;border-radius:15px;max-width:900px;width:95%;max-height:90vh;overflow-y:auto;box-shadow:0 15px 35px rgba(0,0,0,0.3);" onclick="event.stopPropagation()">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                <h2 style="margin:0;color:#333;font-size:1.5rem;">🔔 Admin Notifications & WhatsApp</h2>
                <button onclick="closeNotificationsModal()" style="background:none;border:none;font-size:1.5rem;cursor:pointer;color:#666;">&times;</button>
            </div>
            
            <div style="margin-bottom:20px;padding:15px;background:linear-gradient(135deg,#e8f5e8,#c8e6c9);border-radius:10px;border-left:4px solid #4caf50;">
                <div style="display:flex;align-items:center;gap:15px;margin-bottom:10px;">
                    <span style="font-size:2rem;">📱</span>
                    <div>
                        <h3 style="margin:0;color:#2e7d32;font-size:1.2rem;">Quick WhatsApp Contact</h3>
                        <p style="margin:5px 0 0 0;color:#388e3c;">Contact admin directly for urgent matters</p>
                    </div>
                </div>
                <button onclick="openWhatsAppChat('${adminWhatsApp}', '')" style="background:linear-gradient(135deg,#25d366,#128c7e);color:white;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:600;">
                    💬 Open WhatsApp Chat
                </button>
            </div>
            
            <div style="margin-bottom:20px;">
                <div style="display:flex;gap:10px;margin-bottom:15px;flex-wrap:wrap;">
                    <button onclick="markAllNotificationsRead()" style="background:linear-gradient(135deg,#2196f3,#1976d2);color:white;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;">Mark All Read</button>
                    <button onclick="clearAllNotifications()" style="background:linear-gradient(135deg,#f44336,#d32f2f);color:white;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;">Clear All</button>
                    <button onclick="toggleAutoWhatsAppNotifications()" style="background:linear-gradient(135deg,#ff9800,#f57c00);color:white;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;">⚙️ Settings</button>
                </div>
            </div>
            
            <div id="notifications-list">`;
    
    if (notifications.length === 0) {
        modalHtml += `
        <div style="text-align:center;padding:50px;color:#666;">
            <span style="font-size:3rem;">🔔</span>
            <p style="margin:10px 0 0 0;font-size:1.1rem;">No notifications yet</p>
        </div>`;
    } else {
        notifications.forEach((notification, index) => {
            const bgColor = notification.read ? '#f9f9f9' : '#fff3e0';
            const borderColor = notification.read ? '#e0e0e0' : '#ff9800';
            
            modalHtml += `
            <div style="background:${bgColor};border:1px solid ${borderColor};border-radius:10px;padding:15px;margin-bottom:15px;${!notification.read ? 'border-left:4px solid #ff9800;' : ''}">
                <div style="display:flex;justify-content:between;align-items:flex-start;gap:15px;">
                    <div style="flex:1;">
                        <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                            <span style="font-size:1.5rem;">${notification.type === 'new_account_request' ? '🎓' : notification.type === 'admin_registration_request' ? ' ' : ' 📢'}</span>
                            <h4 style="margin:0;color:#333;font-size:1.1rem;">${notification.title}</h4>
                            ${!notification.read ? '<span style="background:#ff9800;color:white;padding:2px 8px;border-radius:12px;font-size:0.8rem;font-weight:600;">NEW</span>' : ''}
                        </div>
                        <p style="margin:0 0 10px 0;color:#666;line-height:1.4;">${notification.message}</p>
                        ${notification.type === 'admin_registration_request' && notification.adminData ? `
                        <div style="background:rgba(220,53,69,0.1);border:1px solid rgba(220,53,69,0.3);border-radius:8px;padding:10px;margin:10px 0;font-size:0.9rem;">
                            <p style="margin:0 0 5px 0;"><strong>👤 Name:</strong> ${notification.adminData.name}</p>
                            <p style="margin:0 0 5px 0;"><strong>📱 Mobile:</strong> ${notification.adminData.mobile}</p>
                            <p style="margin:0 0 5px 0;"><strong>💼 Position:</strong> ${notification.adminData.position}</p>
                            <p style="margin:0;"><strong>📝 Reason:</strong> ${notification.adminData.reason}</p>
                        </div>
                        ` : ''}
                        <p style="margin:0;color:#999;font-size:0.9rem;">📅 ${new Date(notification.timestamp).toLocaleString()}</p>
                    </div>
                    
                    <div style="display:flex;flex-direction:column;gap:8px;min-width:120px;">
                        ${notification.type === 'new_account_request' ? `
                        <button onclick="approveAccount(${index})" style="background:linear-gradient(135deg,#4caf50,#388e3c);color:white;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;font-size:0.8rem;">✅ Approve</button>
                        <button onclick="rejectAccount(${index})" style="background:linear-gradient(135deg,#f44336,#d32f2f);color:white;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;font-size:0.8rem;">❌ Reject</button>
                        ` : ''}
                        ${notification.type === 'admin_registration_request' ? `
                        <button onclick="approveAdminRegistration(${index})" style="background:linear-gradient(135deg,#4caf50,#388e3c);color:white;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;font-size:0.8rem;">👑 Approve Admin</button>
                        <button onclick="rejectAdminRegistration(${index})" style="background:linear-gradient(135deg,#f44336,#d32f2f);color:white;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;font-size:0.8rem;">❌ Reject</button>
                        ` : ''}
                        ${notification.whatsappMessage ? `
                        <button onclick="openWhatsAppChat('${adminWhatsApp}', '${encodeURIComponent(notification.whatsappMessage)}')" style="background:linear-gradient(135deg,#25d366,#128c7e);color:white;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;font-size:0.8rem;">📱 WhatsApp</button>
                        ` : ''}
                        <button onclick="markNotificationRead(${index})" style="background:linear-gradient(135deg,#607d8b,#455a64);color:white;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;font-size:0.8rem;">${notification.read ? '👁️ Read' : '📖 Mark Read'}</button>
                    </div>
                </div>
            </div>`;
        });
    }
    
    modalHtml += `
            </div>
        </div>
    </div>`;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Mark notifications as read when viewed
    setTimeout(() => {
        markAllNotificationsRead();
    }, 2000);
}

function openWhatsAppChat(phoneNumber, message) {
    const formattedNumber = phoneNumber.replace(/[^0-9]/g, '');
    const encodedMessage = encodeURIComponent(message);
    const whatsappUrl = `https://wa.me/${formattedNumber}${message ? `?text=${encodedMessage}` : ''}`;
    
    // IMPROVED: Better mobile and desktop WhatsApp handling
    const isMobile = window.innerWidth <= 768 || /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    
    console.log(`📱 Opening WhatsApp for ${isMobile ? 'MOBILE' : 'DESKTOP'} device`);
    console.log('📞 Number:', formattedNumber);
    console.log('💬 Message:', message.substring(0, 100) + '...');
    
    if (isMobile) {
        // Mobile: Try to open WhatsApp app directly, fallback to web
        const whatsappAppUrl = `whatsapp://send?phone=${formattedNumber}&text=${encodedMessage}`;
        
        // Try app first, then fallback to web
        window.location.href = whatsappAppUrl;
        
        // Fallback to web version after short delay
        setTimeout(() => {
            window.open(whatsappUrl, '_blank');
        }, 1000);
    } else {
        // Desktop: Open WhatsApp Web
        window.open(whatsappUrl, '_blank');
    }
    
    // Show confirmation message
    setTimeout(() => {
        showModal(`📱 WhatsApp Opened!\n\n✅ WhatsApp has been opened with the notification message.\n\n📞 Contact: ${phoneNumber}\n\n💡 Please send the message to notify the admin.`);
    }, 2000);
}

function approveAccount(notificationIndex) {
    const notifications = JSON.parse(localStorage.getItem('adminNotifications') || '[]');
    const notification = notifications[notificationIndex];
    
    if (notification && notification.studentData) {
        const studentData = notification.studentData;
        
        // Create user accounts
        const users = JSON.parse(localStorage.getItem('userCredentials') || '[]');
        const newUser = {username: studentData.username, password: studentData.password, role: 'student', studentId: studentData.studentId};
        const parentUser = {username: studentData.username + '_parent', password: studentData.password, role: 'parent', studentId: studentData.studentId};
        
        users.push(newUser);
        users.push(parentUser);
        localStorage.setItem('userCredentials', JSON.stringify(users));
        
        // Add to student list
        let students = JSON.parse(localStorage.getItem('studentList') || '[]');
        students.push({
            id: studentData.studentId,
            name: studentData.studentName,
            number: studentData.studentBform,
            contact: studentData.studentContact,
            photo: studentData.photo,
            guardian: studentData.guardianName,
            guardianContact: studentData.guardianContact,
            guardianId: studentData.guardianId,
            roomNo: '',
            feePaid: studentData.feePaid || 0,
            totalFee: studentData.totalFee || 0,
            due: studentData.dueAmount || 0,
            emergencyContact: studentData.emergencyContact || '',
            admissionDate: studentData.admissionDate || new Date().toLocaleDateString(),
            graduationDate: studentData.graduationDate || '',
            medical: studentData.medicalIssues || '',
            sponsored: false,
            scholarship: false,
            partialSupport: false,
            village: studentData.village,
            school: studentData.currentInstitution,
            college: '',
            university: '',
            signature: studentData.signature,
            admissionFee: 0,
            securityFee: 0,
            documents: {
                photo: studentData.photo,
                admissionForm: studentData.admissionForm,
                bForm: studentData.bformDocument,
                fatherID: studentData.fatherIdDocument
            }
        });
        localStorage.setItem('studentList', JSON.stringify(students));
        
        // Remove from pending accounts
        let pendingAccounts = JSON.parse(localStorage.getItem('pendingAccounts') || '[]');
        pendingAccounts = pendingAccounts.filter(account => account.id !== studentData.id);
        localStorage.setItem('pendingAccounts', JSON.stringify(pendingAccounts));
        
        // Update notification
        notifications[notificationIndex].status = 'approved';
        notifications[notificationIndex].read = true;
        localStorage.setItem('adminNotifications', JSON.stringify(notifications));
        
        alert(`✅ Account approved! Student ${studentData.studentName} can now login with:\nUsername: ${studentData.username}\nPassword: ${studentData.password}\nParent login: ${studentData.username}_parent`);
        
        // Send approval WhatsApp message
        const approvalMessage = `✅ *Account Approved!*\n\n*Student:* ${studentData.studentName}\n*Student ID:* ${studentData.studentId}\n*Username:* ${studentData.username}\n*Password:* ${studentData.password}\n*Parent Login:* ${studentData.username}_parent\n\n*Welcome to Al Fizaa Girls Hostel!* 🏠✨\n\n*Next Steps:*\n- Login to the system\n- Complete room allocation\n- Pay admission fees\n\n*Time:* ${new Date().toLocaleString()}`;
        
        openWhatsAppChat(studentData.studentContact, approvalMessage);
        
        closeNotificationsModal();
        showAdminNotifications(); // Refresh
    }
}

function rejectAccount(notificationIndex) {
    const notifications = JSON.parse(localStorage.getItem('adminNotifications') || '[]');
    const notification = notifications[notificationIndex];
    
    if (notification && notification.studentData) {
        const reason = prompt('Please enter rejection reason (optional):') || 'Application did not meet requirements';
        const studentData = notification.studentData;
        
        // Remove from pending accounts
        let pendingAccounts = JSON.parse(localStorage.getItem('pendingAccounts') || '[]');
        pendingAccounts = pendingAccounts.filter(account => account.id !== studentData.id);
        localStorage.setItem('pendingAccounts', JSON.stringify(pendingAccounts));
        
        // Update notification
        notifications[notificationIndex].status = 'rejected';
        notifications[notificationIndex].rejectionReason = reason;
        notifications[notificationIndex].read = true;
        localStorage.setItem('adminNotifications', JSON.stringify(notifications));
        
        alert(`❌ Account rejected for ${studentData.studentName}. Reason: ${reason}`);
        
        // Send rejection WhatsApp message
        const rejectionMessage = `❌ *Registration Rejected*\n\n*Student:* ${studentData.studentName}\n*Reason:* ${reason}\n\n*What to do next:*\n- Review your application details\n- Contact admin for clarification\n- Resubmit with correct information\n\n*Time:* ${new Date().toLocaleString()}`;
        
        openWhatsAppChat(studentData.studentContact, rejectionMessage);
        
        closeNotificationsModal();
        showAdminNotifications(); // Refresh
    }
}

function markNotificationRead(index) {
    const notifications = JSON.parse(localStorage.getItem('adminNotifications') || '[]');
    if (notifications[index]) {
        notifications[index].read = true;
        localStorage.setItem('adminNotifications', JSON.stringify(notifications));
        updateNotificationBadge();
        closeNotificationsModal();
        showAdminNotifications(); // Refresh
    }
}

function markAllNotificationsRead() {
    const notifications = JSON.parse(localStorage.getItem('adminNotifications') || '[]');
    notifications.forEach(n => n.read = true);
    localStorage.setItem('adminNotifications', JSON.stringify(notifications));
    updateNotificationBadge();
}

function clearAllNotifications() {
    if (confirm('Are you sure you want to clear all notifications? This action cannot be undone.')) {
        localStorage.setItem('adminNotifications', '[]');
        updateNotificationBadge();
        closeNotificationsModal();
        showAdminNotifications(); // Refresh
    }
}

// ADDED: Toggle auto WhatsApp notifications
function toggleAutoWhatsAppNotifications() {
    const currentSetting = localStorage.getItem('autoWhatsAppNotifications') !== 'false';
    const newSetting = !currentSetting;
    
    localStorage.setItem('autoWhatsAppNotifications', newSetting.toString());
    
    const statusText = newSetting ? 'ENABLED' : 'DISABLED';
    const statusIcon = newSetting ? '✅' : '⏸️';
    
    showModal(`⚙️ WhatsApp Auto-Notification Settings\n\n${statusIcon} Auto-notifications are now ${statusText}\n\n${newSetting ? 
        '📱 The system will automatically open WhatsApp when new registrations are submitted.' : 
        '⏸️ The system will store notifications but not auto-open WhatsApp.'}\n\n💡 This setting affects:\n• Student registration notifications\n• Admin registration notifications\n• System alerts`);
    
    // Refresh the notifications view
    setTimeout(() => {
        closeNotificationsModal();
        showAdminNotifications();
    }, 3000);
}

function closeNotificationsModal(event) {
    const modal = document.getElementById('notifications-modal');
    if (modal) {
        // If event is provided and it's not clicking on the background, don't close
        if (event && event.target !== modal) {
            return;
        }
        modal.remove();
    }
    
    // Reset body scroll for mobile
    document.body.style.overflow = '';
    document.body.style.position = '';
}

// ---------- Admin Registration Approval Functions ----------
function approveAdminRegistration(notificationIndex) {
    const notifications = JSON.parse(localStorage.getItem('adminNotifications') || '[]');
    const notification = notifications[notificationIndex];
    
    if (notification && notification.adminData && notification.type === 'admin_registration_request') {
        const adminData = notification.adminData;
        
        // Check if current user is the default admin
        if (!isDefaultAdmin()) {
            alert('⚠️ Only the default admin can approve admin registration requests!');
            return;
        }
        
        // Generate username and password for new admin
        const newAdminUsername = `admin_${adminData.mobile.slice(-4)}_${Date.now().toString().slice(-3)}`;
        const newAdminPassword = `admin${Math.floor(Math.random() * 10000).toString().padStart(4, '0')}`;
        
        // Create admin user account
        const users = JSON.parse(localStorage.getItem('userCredentials') || '[]');
        const newAdminUser = {
            username: newAdminUsername,
            password: newAdminPassword,
            role: 'admin',
            mobile: adminData.mobile,
            name: adminData.name,
            position: adminData.position,
            approvedBy: 'default_admin',
            approvedDate: new Date().toISOString(),
            isActive: true
        };
        
        users.push(newAdminUser);
        localStorage.setItem('userCredentials', JSON.stringify(users));
        
        // Remove from pending admins
        const pendingAdmins = JSON.parse(localStorage.getItem('pendingAdmins') || '[]');
        const updatedPendingAdmins = pendingAdmins.filter(p => p.id !== adminData.id);
        localStorage.setItem('pendingAdmins', JSON.stringify(updatedPendingAdmins));
        
        // Update notification
        notification.status = 'approved';
        notification.approvedDate = new Date().toISOString();
        notification.adminCredentials = {
            username: newAdminUsername,
            password: newAdminPassword
        };
        
        localStorage.setItem('adminNotifications', JSON.stringify(notifications));
        
        // Create approval notification for records
        createAdminNotification({
            type: 'admin_approved',
            title: 'Admin Registration Approved',
            message: `Admin access granted to ${adminData.name} (${adminData.mobile})`,
            timestamp: new Date().toISOString(),
            whatsappMessage: `👑 *ADMIN ACCESS APPROVED*\n\n*Al Fizaa Girls Hostel Management System*\n\n*Congratulations ${adminData.name}!*\n\nYour admin registration has been approved by the default admin.\n\n*Login Credentials:*\n*Username:* ${newAdminUsername}\n*Password:* ${newAdminPassword}\n\n*⚠️ IMPORTANT SECURITY NOTES:*\n• Change your password after first login\n• Do not share these credentials\n• Contact default admin for any issues\n\n*Login URL:* [Your System URL]\n\n*Welcome to the admin team!* 🎉`
        });
        
        alert(`✅ Admin Registration Approved!\n\nNew Admin Credentials:\nUsername: ${newAdminUsername}\nPassword: ${newAdminPassword}\n\nThe new admin has been notified via WhatsApp.`);
        
        // Refresh notifications display
        closeNotificationsModal();
        showAdminNotifications();
        
        console.log('📋 ADMIN APPROVED - WhatsApp message to send:');
        console.log(`To: ${adminData.mobile}`);
        console.log('Message:', notification.whatsappMessage);
    }
}

function rejectAdminRegistration(notificationIndex) {
    const notifications = JSON.parse(localStorage.getItem('adminNotifications') || '[]');
    const notification = notifications[notificationIndex];
    
    if (notification && notification.adminData && notification.type === 'admin_registration_request') {
        const adminData = notification.adminData;
        
        // Check if current user is the default admin
        if (!isDefaultAdmin()) {
            alert('⚠️ Only the default admin can reject admin registration requests!');
            return;
        }
        
        const rejectionReason = prompt('Please provide a reason for rejection (optional):') || 'No reason provided';
        
        if (confirm(`Are you sure you want to reject the admin registration request from ${adminData.name}?`)) {
            // Remove from pending admins
            const pendingAdmins = JSON.parse(localStorage.getItem('pendingAdmins') || '[]');
            const updatedPendingAdmins = pendingAdmins.filter(p => p.id !== adminData.id);
            localStorage.setItem('pendingAdmins', JSON.stringify(updatedPendingAdmins));
            
            // Update notification
            notification.status = 'rejected';
            notification.rejectedDate = new Date().toISOString();
            notification.rejectionReason = rejectionReason;
            
            localStorage.setItem('adminNotifications', JSON.stringify(notifications));
            
            // Create rejection notification for records
            createAdminNotification({
                type: 'admin_rejected',
                title: 'Admin Registration Rejected',
                message: `Admin access denied for ${adminData.name} (${adminData.mobile})`,
                timestamp: new Date().toISOString(),
                whatsappMessage: `❌ *ADMIN ACCESS DENIED*\n\n*Al Fizaa Girls Hostel Management System*\n\n*Dear ${adminData.name},*\n\nYour admin registration request has been reviewed and unfortunately cannot be approved at this time.\n\n*Request Details:*\n*Mobile:* ${adminData.mobile}\n*Position:* ${adminData.position}\n*Submitted:* ${new Date(adminData.requestDate).toLocaleString()}\n\n*Reason:* ${rejectionReason}\n\n*If you believe this is an error, please contact the default admin directly.*\n\n*Thank you for your interest.*`
            });
            
            alert(`❌ Admin Registration Rejected!\n\nRequest from ${adminData.name} has been denied.\nReason: ${rejectionReason}\n\nThe requestor will be notified via WhatsApp.`);
            
            // Refresh notifications display
            closeNotificationsModal();
            showAdminNotifications();
            
            console.log('📋 ADMIN REJECTED - WhatsApp message to send:');
            console.log(`To: ${adminData.mobile}`);
            console.log('Message:', notification.whatsappMessage);
        }
    }
}

// Initialize notification system on page load
document.addEventListener('DOMContentLoaded', function() {
    // Create a welcome notification for admin users (demo purposes)
    const existingNotifications = JSON.parse(localStorage.getItem('adminNotifications') || '[]');
    if (existingNotifications.length === 0) {
        createAdminNotification({
            type: 'system',
            title: 'Welcome to Admin Notification System',
            message: 'This system will notify you of new student registration requests and other important events. Click WhatsApp buttons to contact students or admin directly.',
            timestamp: new Date().toISOString(),
            whatsappMessage: '🏠 *Al Fizaa Girls Hostel* - Admin Notification System\n\nWelcome to the new notification system! You will receive alerts for:\n- New student registration requests\n- Admin registration requests\n- Parent report notifications\n- System updates\n- Important events\n\nDefault Admin Contact: +923411666480'
        });
    }
});

// ---------- Default Admin Notification System for Admin Registration ----------
function createDefaultAdminNotification(notificationData) {
    // Create standard admin notification
    createAdminNotification({
        type: notificationData.type,
        title: notificationData.title,
        message: notificationData.message,
        timestamp: notificationData.timestamp,
        adminData: notificationData.adminData
    });
    
    // Also create a special default admin log
    let defaultAdminLogs = JSON.parse(localStorage.getItem('defaultAdminLogs') || '[]');
    const logEntry = {
        id: Date.now(),
        type: 'admin_registration_request',
        requestorName: notificationData.adminData.name,
        requestorMobile: notificationData.adminData.mobile,
        requestorPosition: notificationData.adminData.position,
        requestorReason: notificationData.adminData.reason,
        whatsappMessage: notificationData.whatsappMessage,
        timestamp: notificationData.timestamp,
        status: 'pending_default_admin_approval'
    };
    
    defaultAdminLogs.unshift(logEntry);
    localStorage.setItem('defaultAdminLogs', JSON.stringify(defaultAdminLogs));
    
    // Show console log for default admin (since we can't actually send WhatsApp)
    console.log('🔔 DEFAULT ADMIN NOTIFICATION - ADMIN REGISTRATION REQUEST');
    console.log('=====================================================');
    console.log('⚠️  SECURITY ALERT: New admin registration request received');
    console.log('📱 Default Admin WhatsApp: +923411666480');
    console.log('');
    console.log('WHATSAPP MESSAGE TO SEND:');
    console.log('------------------------');
    console.log(notificationData.whatsappMessage);
    console.log('');
    console.log('📋 ADMIN ACTION REQUIRED: The default admin must review and approve this request.');
    console.log('💡 AUTOMATICALLY OPENING WHATSAPP TO SEND NOTIFICATION TO DEFAULT ADMIN...');
    console.log('=====================================================');
    
    // FIXED: Automatically send WhatsApp notification to default admin
    const defaultAdminNumber = '+923411666480';
    
    // Auto-open WhatsApp with the notification message for immediate sending
    setTimeout(() => {
        console.log('📱 Opening WhatsApp to send admin registration notification...');
        openWhatsAppChat(defaultAdminNumber, notificationData.whatsappMessage);
        
        // Show success message
        showModal(`📱 WhatsApp Notification Sent!\n\n✅ Admin registration notification has been automatically sent to default admin via WhatsApp.\n\n📞 Default Admin: ${defaultAdminNumber}\n\n⏳ The admin will review and respond to the registration request.`);
    }, 1000);
    
    // Also show immediate alert to default admin if they're logged in
    if (isDefaultAdmin()) {
        setTimeout(() => {
            alert(`🔔 DEFAULT ADMIN ALERT\n\nNew admin registration request received!\n\nName: ${notificationData.adminData.name}\nMobile: ${notificationData.adminData.mobile}\n\nPlease check admin notifications for details.`);
        }, 2000);
    }
}

// Demo function to create test notification (for testing purposes)
function createTestNotification() {
    const testStudentData = {
        id: Date.now(),
        username: 'test_student',
        password: 'test123',
        studentId: 'AF99',
        studentName: 'Test Student',
        studentNumber: '0300-1234567',
        studentContact: '0300-1234567',
        photo: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==',
        guardianName: 'Test Guardian',
        guardianContact: '0301-7654321',
        guardianId: '12345-1234567-1',
        village: 'Test Village',
        school: 'Test School',
        college: 'Test College',
        university: 'Test University',
        signature: 'Test Signature',
        submissionDate: new Date().toISOString(),
        status: 'pending'
    };
    
    createAdminNotification({
        type: 'new_account_request',
        title: 'New Student Account Request',
        message: `New registration request from ${testStudentData.studentName} (${testStudentData.username}) - This is a test notification for demonstration.`,
        studentData: testStudentData,
        timestamp: new Date().toISOString(),
        whatsappMessage: `🎓 *New Student Registration Request*\n\n*Student Name:* ${testStudentData.studentName}\n*Username:* ${testStudentData.username}\n*Contact:* ${testStudentData.studentContact}\n*Guardian:* ${testStudentData.guardianName}\n*Guardian Contact:* ${testStudentData.guardianContact}\n*Village:* ${testStudentData.village}\n*School:* ${testStudentData.school}\n*College:* ${testStudentData.college}\n*University:* ${testStudentData.university}\n\n*Action Required:* Please review and approve/reject this registration request in the admin panel.\n\n*Time:* ${new Date().toLocaleString()}`
    });
    
    alert('Test notification created! Check the notification bell icon.');
}

// ---------- Student ID Manager ----------
function showStudentIdManager() {
    const students = JSON.parse(localStorage.getItem('studentList') || '[]');
    
    let modalHtml = `
    <div style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;display:flex;justify-content:center;align-items:center;" id="student-id-modal">
        <div style="background:white;padding:30px;border-radius:15px;max-width:800px;width:90%;max-height:80vh;overflow-y:auto;box-shadow:0 15px 35px rgba(0,0,0,0.3);">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                <h2 style="margin:0;color:#333;font-size:1.5rem;">🆔 Change Student IDs</h2>
                <button onclick="closeStudentIdManager()" style="background:none;border:none;font-size:1.5rem;cursor:pointer;color:#666;">&times;</button>
            </div>
            
            <div style="margin-bottom:20px;padding:15px;background:linear-gradient(135deg,#e3f2fd,#bbdefb);border-radius:10px;border-left:4px solid #2196f3;">
                <p style="margin:0;color:#1976d2;font-weight:600;">⚠️ Warning: Changing student IDs will update all related records including login credentials.</p>
            </div>
            
            <div style="margin-bottom:20px;">
                <button onclick="generateSequentialIds()" style="padding:10px 20px;background:linear-gradient(135deg,#4caf50,#45a049);color:white;border:none;border-radius:8px;cursor:pointer;font-weight:600;margin-right:10px;">🔄 Generate Sequential IDs (AF01, AF02...)</button>
                <button onclick="resetToOriginalIds()" style="padding:10px 20px;background:linear-gradient(135deg,#ff9800,#f57c00);color:white;border:none;border-radius:8px;cursor:pointer;font-weight:600;">↩️ Reset to Original</button>
            </div>
            
            <table style="width:100%;border-collapse:collapse;margin-bottom:20px;">
                <thead>
                    <tr style="background:linear-gradient(135deg,#667eea,#764ba2);color:white;">
                        <th style="padding:12px;text-align:left;border:1px solid #ddd;">Current ID</th>
                        <th style="padding:12px;text-align:left;border:1px solid #ddd;">Student Name</th>
                        <th style="padding:12px;text-align:left;border:1px solid #ddd;">New ID</th>
                        <th style="padding:12px;text-align:center;border:1px solid #ddd;">Action</th>
                    </tr>
                </thead>
                <tbody id="student-id-table-body">
    `;
    
    students.forEach((student, index) => {
        modalHtml += `
                    <tr style="background:${index % 2 === 0 ? '#f9f9f9' : 'white'};">
                        <td style="padding:10px;border:1px solid #ddd;font-weight:600;color:#333;">${student.id}</td>
                        <td style="padding:10px;border:1px solid #ddd;">${student.name}</td>
                        <td style="padding:10px;border:1px solid #ddd;">
                            <input type="text" value="${student.id}" id="new-id-${index}" style="width:100%;padding:6px;border:1px solid #ddd;border-radius:4px;" placeholder="Enter new ID">
                        </td>
                        <td style="padding:10px;border:1px solid #ddd;text-align:center;">
                            <button onclick="updateSingleStudentId(${index})" style="padding:6px 12px;background:#2196f3;color:white;border:none;border-radius:4px;cursor:pointer;font-size:12px;">Update</button>
                        </td>
                    </tr>
        `;
    });
    
    modalHtml += `
                </tbody>
            </table>
            
            <div style="text-align:center;">
                <button onclick="updateAllStudentIds()" style="padding:12px 25px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;border-radius:8px;cursor:pointer;font-weight:600;font-size:1rem;margin-right:10px;">✅ Update All IDs</button>
                <button onclick="closeStudentIdManager()" style="padding:12px 25px;background:#6c757d;color:white;border:none;border-radius:8px;cursor:pointer;font-weight:600;font-size:1rem;">Cancel</button>
            </div>
        </div>
    </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
}

function closeStudentIdManager() {
    const modal = document.getElementById('student-id-modal');
    if (modal) {
        modal.remove();
    }
}

function generateSequentialIds() {
    const students = JSON.parse(localStorage.getItem('studentList') || '[]');
    students.forEach((student, index) => {
        const newId = 'AF' + String(index + 1).padStart(2, '0');
        const input = document.getElementById(`new-id-${index}`);
        if (input) {
            input.value = newId;
        }
    });
}

function resetToOriginalIds() {
    const students = JSON.parse(localStorage.getItem('studentList') || '[]');
    students.forEach((student, index) => {
        const input = document.getElementById(`new-id-${index}`);
        if (input) {
            input.value = student.id;
        }
    });
}

function updateSingleStudentId(index) {
    const students = JSON.parse(localStorage.getItem('studentList') || '[]');
    const users = JSON.parse(localStorage.getItem('userCredentials') || '[]');
    const newIdInput = document.getElementById(`new-id-${index}`);
    
    if (!newIdInput) return;
    
    const newId = newIdInput.value.trim();
    const oldId = students[index].id;
    
    if (!newId || newId === oldId) {
        alert('Please enter a valid new ID');
        return;
    }
    
    // Check if new ID already exists
    if (students.find(s => s.id === newId && s.id !== oldId)) {
        alert('This ID already exists!');
        return;
    }
    
    // Update student ID
    students[index].id = newId;
    
    // Update user credentials
    users.forEach(user => {
        if (user.studentId === oldId) {
            user.studentId = newId;
        }
    });
    
    // Save changes
    localStorage.setItem('studentList', JSON.stringify(students));
    localStorage.setItem('userCredentials', JSON.stringify(users));
    
    alert(`Student ID updated from ${oldId} to ${newId}`);
    
    // Refresh the table
    closeStudentIdManager();
    showStudentIdManager();
}

function updateAllStudentIds() {
    const students = JSON.parse(localStorage.getItem('studentList') || '[]');
    const users = JSON.parse(localStorage.getItem('userCredentials') || '[]');
    const newIds = [];
    
    // Collect all new IDs
    students.forEach((student, index) => {
        const input = document.getElementById(`new-id-${index}`);
        if (input) {
            newIds.push({
                oldId: student.id,
                newId: input.value.trim(),
                index: index
            });
        }
    });
    
    // Validate all new IDs
    const uniqueNewIds = new Set();
    for (let item of newIds) {
        if (!item.newId) {
            alert(`Please enter a valid ID for student at row ${item.index + 1}`);
            return;
        }
        if (uniqueNewIds.has(item.newId)) {
            alert(`Duplicate ID found: ${item.newId}`);
            return;
        }
        uniqueNewIds.add(item.newId);
    }
    
    // Update all student IDs
    newIds.forEach(item => {
        students[item.index].id = item.newId;
        
        // Update user credentials
        users.forEach(user => {
            if (user.studentId === item.oldId) {
                user.studentId = item.newId;
            }
        });
    });
    
    // Save changes
    localStorage.setItem('studentList', JSON.stringify(students));
    localStorage.setItem('userCredentials', JSON.stringify(users));
    
    alert('All student IDs updated successfully!');
    closeStudentIdManager();
    
    // Refresh current page if it's the enrolled students page
    const currentContent = document.getElementById('main-content');
    if (currentContent && currentContent.querySelector('#enrolled-students-tbody')) {
        setupEnrolledStudents();
    }
}

// ---------- Invoice Generator ----------
function showInvoiceGenerator() {
    const students = JSON.parse(localStorage.getItem('studentList') || '[]');
    
    const modalHtml = `
    <div style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;display:flex;justify-content:center;align-items:center;" id="invoice-modal">
        <div style="background:white;padding:30px;border-radius:15px;max-width:500px;width:90%;box-shadow:0 15px 35px rgba(0,0,0,0.3);">
            <h2 style="margin:0 0 20px 0;color:#333;">📄 Generate Digital Invoice</h2>
            <div style="margin-bottom:15px;">
                <label style="display:block;margin-bottom:5px;font-weight:600;">Select Student:</label>
                <select id="invoice-student" style="width:100%;padding:10px;border:2px solid #ddd;border-radius:8px;">
                    <option value="">Choose Student</option>
                    ${students.map(s => `<option value="${s.id}">${s.name} (${s.id})</option>`).join('')}
                </select>
            </div>
            <div style="margin-bottom:15px;">
                <label style="display:block;margin-bottom:5px;font-weight:600;">Amount Paid (PKR):</label>
                <input type="number" id="invoice-amount" style="width:100%;padding:10px;border:2px solid #ddd;border-radius:8px;" placeholder="Enter amount">
            </div>
            <div style="margin-bottom:20px;">
                <label style="display:block;margin-bottom:5px;font-weight:600;">Payment Type:</label>
                <select id="invoice-type" style="width:100%;padding:10px;border:2px solid #ddd;border-radius:8px;">
                    <option value="monthly">Monthly Fee</option>
                    <option value="admission">Admission Fee</option>
                    <option value="security">Security Fee</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <div style="display:flex;gap:10px;">
                <button onclick="generateInvoice()" style="flex:1;padding:12px;background:linear-gradient(135deg,#28a745,#20c997);color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">Generate Invoice</button>
                <button onclick="closeInvoiceGenerator()" style="flex:1;padding:12px;background:#6c757d;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">Cancel</button>
            </div>
        </div>
    </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
}

function closeInvoiceGenerator() {
    const modal = document.getElementById('invoice-modal');
    if (modal) modal.remove();
}

function generateInvoice() {
    const studentId = document.getElementById('invoice-student').value;
    const amount = document.getElementById('invoice-amount').value;
    const type = document.getElementById('invoice-type').value;
    
    if (!studentId || !amount) {
        alert('Please select student and enter amount');
        return;
    }
    
    const students = JSON.parse(localStorage.getItem('studentList') || '[]');
    const student = students.find(s => s.id === studentId);
    const receiptId = `INV-${Date.now()}`;
    const currentDate = new Date().toLocaleDateString();
    
    // Store invoice record
    const feeSlips = JSON.parse(localStorage.getItem('feeSlipRecords') || '[]');
    const newSlip = {
        id: receiptId,
        studentId: studentId,
        studentName: student.name,
        amount: parseFloat(amount),
        type: type,
        date: currentDate,
        timestamp: Date.now()
    };
    feeSlips.push(newSlip);
    localStorage.setItem('feeSlipRecords', JSON.stringify(feeSlips));
    
    // Auto-add to income
    const incomeList = JSON.parse(localStorage.getItem('incomeList') || '[]');
    const newIncome = {
        id: `I${Date.now()}`,
        date: new Date().toISOString().split('T')[0],
        category: type,
        studentName: student.name,
        studentId: studentId,
        amount: parseFloat(amount),
        payment: 'cash',
        receipt: receiptId,
        description: `${type.charAt(0).toUpperCase() + type.slice(1)} fee payment`
    };
    incomeList.push(newIncome);
    localStorage.setItem('incomeList', JSON.stringify(incomeList));
    
    const invoiceHtml = `
    <div style="max-width:600px;margin:0 auto;padding:30px;background:white;border:2px solid #ddd;">
        <div style="text-align:center;margin-bottom:30px;">
            <h1 style="color:#333;margin:0;">Al Fizaa Girls Hostel</h1>
            <h2 style="color:#666;margin:5px 0;">Payment Receipt</h2>
            <p style="margin:0;color:#888;">Receipt #: ${receiptId}</p>
        </div>
        <div style="margin-bottom:20px;">
            <p><strong>Student Name:</strong> ${student.name}</p>
            <p><strong>Student ID:</strong> ${student.id}</p>
            <p><strong>Payment Type:</strong> ${type.charAt(0).toUpperCase() + type.slice(1)} Fee</p>
            <p><strong>Amount Paid:</strong> PKR ${amount}</p>
            <p><strong>Date:</strong> ${currentDate}</p>
        </div>
        <div style="text-align:center;margin-top:30px;">
            <p style="color:#666;">Thank you for your payment!</p>
        </div>
    </div>
    `;
    
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`<html><head><title>Invoice</title></head><body>${invoiceHtml}</body></html>`);
    printWindow.document.close();
    printWindow.print();
    
    alert('Invoice generated and automatically added to income records!');
    closeInvoiceGenerator();
}

// ---------- Student Categories ----------
function showSponsoredStudents() {
    const students = JSON.parse(localStorage.getItem('studentList') || '[]');
    const sponsored = students.filter(s => s.sponsored);
    
    showStudentCategoryModal('Sponsored Students', sponsored, '🎯 Students with full sponsorship support');
}

function showScholarshipStudents() {
    const students = JSON.parse(localStorage.getItem('studentList') || '[]');
    const scholarship = students.filter(s => s.scholarship);
    
    showStudentCategoryModal('Scholarship Students', scholarship, '🎓 Students with academic scholarships');
}

function showPartialSupportStudents() {
    const students = JSON.parse(localStorage.getItem('studentList') || '[]');
    const partial = students.filter(s => s.partialSupport);
    
    showStudentCategoryModal('Partial Support Students', partial, '🤝 Students with partial financial support');
}

function showStudentCategoryModal(title, students, description) {
    const modalHtml = `
    <div style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;display:flex;justify-content:center;align-items:center;" id="category-modal">
        <div style="background:white;padding:30px;border-radius:15px;max-width:800px;width:90%;max-height:80vh;overflow-y:auto;box-shadow:0 15px 35px rgba(0,0,0,0.3);">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                <h2 style="margin:0;color:#333;">${title}</h2>
                <button onclick="closeCategoryModal()" style="background:none;border:none;font-size:1.5rem;cursor:pointer;color:#666;">&times;</button>
            </div>
            <p style="color:#666;margin-bottom:20px;">${description}</p>
            ${students.length === 0 ? 
                '<p style="text-align:center;color:#888;padding:40px;">No students found in this category</p>' :
                `<table style="width:100%;border-collapse:collapse;">
                    <thead>
                        <tr style="background:linear-gradient(135deg,var(--gradient-1),var(--gradient-2));color:white;">
                            <th style="padding:12px;text-align:left;">Student ID</th>
                            <th style="padding:12px;text-align:left;">Name</th>
                            <th style="padding:12px;text-align:left;">Contact</th>
                            <th style="padding:12px;text-align:left;">Room</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${students.map((s, i) => `
                            <tr style="background:${i % 2 === 0 ? '#f9f9f9' : 'white'};">
                                <td style="padding:10px;border:1px solid #ddd;">${s.id}</td>
                                <td style="padding:10px;border:1px solid #ddd;">${s.name}</td>
                                <td style="padding:10px;border:1px solid #ddd;">${s.contact || 'N/A'}</td>
                                <td style="padding:10px;border:1px solid #ddd;">${s.roomNo || 'Not Assigned'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>`
            }
            <div style="text-align:center;margin-top:20px;">
                <button onclick="closeCategoryModal()" style="padding:12px 25px;background:#6c757d;color:white;border:none;border-radius:8px;cursor:pointer;font-weight:600;">Close</button>
            </div>
        </div>
    </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
}

function closeCategoryModal() {
    const modal = document.getElementById('category-modal');
    if (modal) modal.remove();
}

// ---------- Qarz e Hasna Form ----------
function showQarzEHasnaForm() {
    const userRole = localStorage.getItem('userRole') || '';
    const studentId = localStorage.getItem('studentId') || '';
    
    // Allow both students and admins to access this form
    if (userRole !== 'student' && userRole !== 'admin') {
        showModal('Access Denied: This form is only available to students and administrators.');
        return;
    }
    
    // For admin users, we'll use a default student template or show all applications
    let currentStudent = {};
    
    if (userRole === 'admin') {
        // For admin, create a default student template for demonstration
        currentStudent = {
            id: 'ADMIN_VIEW',
            name: 'Admin View - Demo Form',
            contact: '+92-XXX-XXXXXXX'
        };
    } else {
        // For students, get their actual data
        if (!studentId) {
            showModal('Error: Student ID not found. Please login again.');
            return;
        }
        
        const students = JSON.parse(localStorage.getItem('studentList') || '[]');
        currentStudent = students.find(s => s.id === studentId);
        
        if (!currentStudent) {
            showModal('Error: Student record not found. Please contact administration.');
            return;
        }
    }
    
    const modalHtml = `
    <div id="qarz-form-modal" style="position:fixed;top:0;left:0;width:100%;height:100%;z-index:10000;display:flex;align-items:center;justify-content:center;padding:20px;overflow-y:auto;">
        <!-- Background Video -->
        <video autoplay muted loop style="position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;z-index:-2;">
            <source src="https://cdn.pixabay.com/vimeo/455331685/graduation-cap-39572.mp4?width=1280&hash=9e3c5b6f0fdc0c8a38d7e3c2b0f2c6b5" type="video/mp4">
            <source src="https://cdn.pixabay.com/vimeo/455331685/graduation-cap-39572.webm?width=1280&hash=9e3c5b6f0fdc0c8a38d7e3c2b0f2c6b5" type="video/webm">
        </video>
        <!-- Video Overlay -->
        <div style="position:absolute;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg,rgba(0,0,0,0.7),rgba(59,130,246,0.5),rgba(147,51,234,0.6));z-index:-1;backdrop-filter:blur(2px);"></div>
        
        <div style="background:rgba(255,255,255,0.95);border-radius:25px;max-width:900px;width:95%;max-height:95vh;overflow-y:auto;box-shadow:0 30px 60px rgba(0,0,0,0.5),0 0 0 1px rgba(255,255,255,0.3);border:3px solid transparent;background-clip:padding-box;backdrop-filter:blur(15px);">
            <div style="background:linear-gradient(135deg,#1e3c72,#2a5298,#3b82f6);color:white;padding:30px;border-radius:25px 25px 0 0;position:relative;overflow:hidden;text-align:center;">
                <div style="position:absolute;top:0;left:0;right:0;bottom:0;background:linear-gradient(45deg,rgba(255,255,255,0.1) 25%,transparent 25%,transparent 75%,rgba(255,255,255,0.1) 75%),linear-gradient(45deg,rgba(255,255,255,0.1) 25%,transparent 25%,transparent 75%,rgba(255,255,255,0.1) 75%);background-size:20px 20px;background-position:0 0,10px 10px;opacity:0.2;"></div>
                <div style="display:flex;justify-content:space-between;align-items:center;position:relative;">
                    <div style="flex:1;text-align:center;">
                        <h2 style="margin:0;font-size:2.2rem;font-weight:900;text-shadow:3px 3px 6px rgba(0,0,0,0.4);color:#ffffff;letter-spacing:1px;">🏠 AL FIZAA GIRLS HOSTEL</h2>
                        <h3 style="margin:10px 0;font-size:1.2rem;font-weight:600;color:#e0e7ff;letter-spacing:0.5px;">APNA GHAR</h3>
                        <h1 style="margin:15px 0 0 0;font-size:1.8rem;font-weight:800;text-shadow:2px 2px 4px rgba(0,0,0,0.3);color:#fbbf24;letter-spacing:1px;">📋 QARZ-E-HASNA ADMISSION FORM</h1>
                        <div style="margin-top:15px;padding:10px 20px;background:rgba(255,255,255,0.2);border-radius:25px;display:inline-block;font-size:1rem;backdrop-filter:blur(10px);font-weight:600;color:#ffffff;">
                            ${userRole === 'admin' ? '👨‍💼 Admin Access - View/Demo Form' : '✨ Financial Support Application'}
                        </div>
                    </div>
                    <button onclick="closeQarzFormModal()" style="background:linear-gradient(135deg,rgba(255,255,255,0.3),rgba(255,255,255,0.1));color:white;border:2px solid rgba(255,255,255,0.4);border-radius:50%;width:50px;height:50px;cursor:pointer;font-size:24px;font-weight:bold;backdrop-filter:blur(10px);transition:all 0.3s ease;box-shadow:0 4px 15px rgba(0,0,0,0.3);margin-left:20px;" onmouseover="this.style.transform='scale(1.1)';this.style.boxShadow='0 6px 20px rgba(0,0,0,0.4)'" onmouseout="this.style.transform='scale(1)';this.style.boxShadow='0 4px 15px rgba(0,0,0,0.3)'">×</button>
                </div>
            </div>
            
            <div style="padding:35px;background:rgba(255,255,255,0.98);">
                <div style="background:linear-gradient(135deg,rgba(59,130,246,0.9),rgba(147,51,234,0.9));padding:25px;border-radius:20px;margin-bottom:30px;border:3px solid rgba(59,130,246,0.3);box-shadow:0 15px 35px rgba(59,130,246,0.2);position:relative;overflow:hidden;text-align:center;">
                    <div style="position:absolute;top:0;left:0;right:0;bottom:0;background:radial-gradient(circle at 30% 30%, rgba(255,255,255,0.2) 0%, transparent 50%);"></div>
                    <div style="position:relative;">
                        <h4 style="margin:0 0 15px 0;color:#fff;font-size:1.6rem;text-shadow:2px 2px 4px rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center;font-weight:800;"><span style="background:rgba(255,255,255,0.2);padding:12px;border-radius:15px;margin-right:15px;backdrop-filter:blur(5px);font-size:1.8rem;">${userRole === 'admin' ? ' ‍💼' : ' 🔒'}</span> ${userRole === 'admin' ? 'ADMIN ACCESS NOTICE' : 'PRIVACY NOTICE'}</h4>
                        <p style="margin:0;color:#fff;font-size:1.1rem;line-height:1.7;text-shadow:1px 1px 3px rgba(0,0,0,0.3);font-weight:600;"><strong style="color:#fbbf24;">${userRole === 'admin' ? 'Admin View:' : 'Important:'}</strong> ${userRole === 'admin' ? 'You are viewing this form as an administrator. This is the same form that students use to submit their Qarz-e-Hasna applications. You can preview the form structure and see what information students are required to provide.' : 'This form is confidential and only accessible to the student. Once submitted, the information cannot be changed. Please fill out all details carefully.'}</p>
                    </div>
                </div>
                
                <form id="qarz-hasna-form">
                    <!-- Student Photo Upload Section -->
                    <div style="background:linear-gradient(135deg,rgba(34,197,94,0.1),rgba(59,130,246,0.1));padding:25px;border-radius:20px;margin-bottom:30px;border:3px solid rgba(34,197,94,0.3);box-shadow:0 10px 25px rgba(34,197,94,0.1);text-align:center;">
                        <h4 style="margin:0 0 20px 0;color:#1f2937;font-size:1.4rem;font-weight:800;"><span style="background:linear-gradient(45deg,#22c55e,#3b82f6);padding:10px;border-radius:12px;margin-right:12px;color:white;">📷</span> STUDENT PHOTOGRAPH</h4>
                        <div style="display:flex;flex-direction:column;align-items:center;gap:15px;">
                            <div id="photo-preview" style="width:150px;height:150px;border:3px dashed #22c55e;border-radius:15px;display:flex;align-items:center;justify-content:center;background:rgba(34,197,94,0.05);color:#22c55e;font-weight:600;text-align:center;font-size:0.9rem;">
                                📸<br>No Photo<br>Selected
                            </div>
                            <label for="student-photo" style="background:linear-gradient(135deg,#22c55e,#16a34a);color:white;padding:12px 25px;border-radius:12px;cursor:pointer;font-weight:700;transition:all 0.3s ease;box-shadow:0 4px 15px rgba(34,197,94,0.3);display:inline-block;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                                📁 Upload Student Photo
                            </label>
                            <input type="file" id="student-photo" accept="image/*" style="display:none;" onchange="handlePhotoUpload(this)">
                            <p style="margin:0;color:#6b7280;font-size:0.9rem;font-weight:500;">JPG, PNG, or GIF (Max: 2MB)</p>
                        </div>
                    </div>
                    
                    <!-- Applicant Information Section -->
                    <div style="background:rgba(255,255,255,0.95);padding:30px;border-radius:20px;margin-bottom:30px;border:3px solid rgba(239,68,68,0.3);box-shadow:0 15px 35px rgba(239,68,68,0.1);position:relative;">
                        <h4 style="margin:0 0 25px 0;color:#1f2937;font-size:1.6rem;border-bottom:3px solid rgba(239,68,68,0.3);padding-bottom:15px;text-shadow:1px 1px 2px rgba(0,0,0,0.1);position:relative;font-weight:800;text-align:center;"><span style="background:linear-gradient(45deg,#ef4444,#dc2626);padding:12px;border-radius:15px;margin-right:15px;box-shadow:0 5px 15px rgba(239,68,68,0.2);color:white;">👤</span> APPLICANT INFORMATION</h4>
                        
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:25px;margin-bottom:25px;position:relative;">
                            <div>
                                <label style="display:block;margin-bottom:10px;font-weight:800;color:#1f2937;font-size:1.1rem;text-shadow:1px 1px 2px rgba(0,0,0,0.1);">Name of Deceased Father/Guardian <span style="color:#ef4444;font-weight:900;">*</span></label>
                                <input type="text" id="deceased-father-name" required style="width:100%;padding:15px;border:3px solid rgba(59,130,246,0.3);border-radius:12px;font-size:1rem;background:#ffffff;color:#1f2937;font-weight:600;transition:all 0.3s ease;box-shadow:0 4px 15px rgba(0,0,0,0.05);" onfocus="this.style.border='3px solid #3b82f6';this.style.boxShadow='0 0 20px rgba(59,130,246,0.3)'" onblur="this.style.border='3px solid rgba(59,130,246,0.3)';this.style.boxShadow='0 4px 15px rgba(0,0,0,0.05)'">
                            </div>
                            <div>
                                <label style="display:block;margin-bottom:10px;font-weight:800;color:#1f2937;font-size:1.1rem;text-shadow:1px 1px 2px rgba(0,0,0,0.1);">Applicant's Full Name <span style="color:#ef4444;font-weight:900;">*</span></label>
                                <input type="text" id="applicant-name" value="${currentStudent.name || ''}" required style="width:100%;padding:15px;border:3px solid rgba(59,130,246,0.3);border-radius:12px;font-size:1rem;background:#ffffff;color:#1f2937;font-weight:600;transition:all 0.3s ease;box-shadow:0 4px 15px rgba(0,0,0,0.05);" onfocus="this.style.border='3px solid #3b82f6';this.style.boxShadow='0 0 20px rgba(59,130,246,0.3)'" onblur="this.style.border='3px solid rgba(59,130,246,0.3)';this.style.boxShadow='0 4px 15px rgba(0,0,0,0.05)'">
                            </div>
                        </div>
                        
                        <div style="margin-bottom:25px;position:relative;">
                            <label style="display:flex;align-items:center;font-weight:800;color:#1f2937;font-size:1.1rem;background:rgba(34,197,94,0.1);padding:15px 20px;border-radius:12px;border:2px solid rgba(34,197,94,0.3);cursor:pointer;transition:all 0.3s ease;" onmouseover="this.style.background='rgba(34,197,94,0.15)'" onmouseout="this.style.background='rgba(34,197,94,0.1)'">
                                <input type="checkbox" id="deserving-only" style="margin-right:15px;transform:scale(1.5);accent-color:#22c55e;">
                                <span style="position:relative;">Tick if You are deserving only</span>
                            </label>
                        </div>
                        
                        <div style="display:grid;grid-template-columns:2fr 1fr;gap:20px;margin-bottom:20px;">
                            <div>
                                <label style="display:block;margin-bottom:8px;font-weight:600;color:#555;">Complete Residential Address <span style="color:red;">*</span></label>
                                <textarea id="residential-address" required rows="3" style="width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;resize:vertical;font-size:0.95rem;" placeholder="Full address including village, tehsil, district..."></textarea>
                            </div>
                            <div>
                                <label style="display:block;margin-bottom:8px;font-weight:600;color:#555;">District of Residence <span style="color:red;">*</span></label>
                                <input type="text" id="district" required style="width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:0.95rem;">
                            </div>
                        </div>
                        
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">
                            <div>
                                <label style="display:block;margin-bottom:8px;font-weight:600;color:#555;">Date of Birth <span style="color:red;">*</span></label>
                                <input type="date" id="date-of-birth" required style="width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:0.95rem;">
                            </div>
                            <div>
                                <label style="display:block;margin-bottom:8px;font-weight:600;color:#555;">Phone Number (Mobile) <span style="color:red;">*</span></label>
                                <input type="tel" id="phone-number" value="${currentStudent.contact || ''}" required placeholder="+92XXXXXXXXXX" pattern="^\\+92[0-9]{10}$" title="Please enter phone number in format +92XXXXXXXXXX for WhatsApp compatibility" style="width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:0.95rem;" oninput="validatePhoneNumber(this)">
                                <small style="color:#666;font-size:0.8rem;margin-top:5px;display:block;">📱 Format: +92XXXXXXXXXX (required for WhatsApp notifications)</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Declaration Section -->
                    <div style="background:rgba(255,255,255,0.95);padding:30px;border-radius:20px;margin-bottom:30px;border:3px solid rgba(59,130,246,0.3);box-shadow:0 15px 35px rgba(59,130,246,0.1);position:relative;">
                        <h4 style="margin:0 0 25px 0;color:#1f2937;font-size:1.6rem;border-bottom:3px solid rgba(59,130,246,0.3);padding-bottom:15px;text-shadow:1px 1px 2px rgba(0,0,0,0.1);position:relative;font-weight:800;text-align:center;"><span style="background:linear-gradient(45deg,#3b82f6,#1d4ed8);padding:12px;border-radius:15px;margin-right:15px;box-shadow:0 5px 15px rgba(59,130,246,0.2);color:white;">📜</span> DECLARATION</h4>
                        
                        <div style="background:#ffffff;padding:25px;border-radius:12px;margin-bottom:25px;border:3px solid rgba(59,130,246,0.2);box-shadow:0 8px 25px rgba(59,130,246,0.1);">
                            <p style="margin:0 0 20px 0;color:#1f2937;line-height:1.8;font-size:1.1rem;font-weight:600;">
                                I, <input type="text" id="declaration-name" placeholder="Your Full Name" style="display:inline;border:none;border-bottom:3px solid #3b82f6;padding:8px;margin:0 8px;font-weight:700;width:220px;color:#1f2937;font-size:1rem;">, 
                                resident of <input type="text" id="declaration-address" placeholder="Your Address" style="display:inline;border:none;border-bottom:3px solid #3b82f6;padding:8px;margin:0 8px;font-weight:700;width:220px;color:#1f2937;font-size:1rem;">, 
                                solemnly declare before God that:
                            </p>
                            <ol style="margin:0;padding-left:30px;color:#1f2937;line-height:2;font-size:1rem;font-weight:600;">
                                <li style="margin-bottom:15px;">I shall repay the obtained Qarz-e-Hasna amount to this institution at the earliest possible opportunity after completing my education and getting employment, with a minimum monthly installment of Rs. 3000 – Rs. 5000.</li>
                                <li style="margin-bottom:15px;">In case of non-repayment, the institution has full right to recover the loan amount from my movable/immovable property.</li>
                                <li style="margin-bottom:15px;">I will receive Qarz e Hasna of Rs. <input type="number" id="qarz-amount" placeholder="Amount" style="display:inline;border:none;border-bottom:3px solid #3b82f6;padding:8px;margin:0 8px;font-weight:700;width:120px;color:#1f2937;font-size:1rem;"> from AL Fizaa Girls Hostel From <input type="date" id="qarz-start-date" style="display:inline;border:none;border-bottom:3px solid #3b82f6;padding:8px;margin:0 8px;font-weight:700;width:160px;color:#1f2937;font-size:1rem;"> to <input type="date" id="qarz-end-date" style="display:inline;border:none;border-bottom:3px solid #3b82f6;padding:8px;margin:0 8px;font-weight:700;width:160px;color:#1f2937;font-size:1rem;"> Date for a Period of <input type="number" id="qarz-years" placeholder="Years" style="display:inline;border:none;border-bottom:3px solid #3b82f6;padding:8px;margin:0 8px;font-weight:700;width:100px;color:#1f2937;font-size:1rem;"> years.</li>
                            </ol>
                        </div>
                        
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:25px;">
                            <div>
                                <label style="display:block;margin-bottom:10px;font-weight:800;color:#1f2937;font-size:1.1rem;">Signature of Applicant</label>
                                <input type="text" id="applicant-signature" placeholder="Type your full name as signature" style="width:100%;padding:15px;border:3px solid rgba(59,130,246,0.3);border-radius:12px;font-style:italic;font-size:1rem;font-weight:600;color:#1f2937;background:#ffffff;">
                            </div>
                            <div>
                                <label style="display:block;margin-bottom:10px;font-weight:800;color:#1f2937;font-size:1.1rem;">Date <span style="color:#ef4444;font-weight:900;">*</span></label>
                                <input type="date" id="declaration-date" required style="width:100%;padding:15px;border:3px solid rgba(59,130,246,0.3);border-radius:12px;font-size:1rem;font-weight:600;color:#1f2937;background:#ffffff;">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Educational Information Section -->
                    <div style="background:rgba(255,255,255,0.95);padding:30px;border-radius:20px;margin-bottom:30px;border:3px solid rgba(168,85,247,0.3);box-shadow:0 15px 35px rgba(168,85,247,0.1);position:relative;">
                        <h4 style="margin:0 0 25px 0;color:#1f2937;font-size:1.6rem;border-bottom:3px solid rgba(168,85,247,0.3);padding-bottom:15px;text-shadow:1px 1px 2px rgba(0,0,0,0.1);position:relative;font-weight:800;text-align:center;"><span style="background:linear-gradient(45deg,#a855f7,#7c3aed);padding:12px;border-radius:15px;margin-right:15px;box-shadow:0 5px 15px rgba(168,85,247,0.2);color:white;">🎓</span> EDUCATIONAL INFORMATION</h4>
                        
                        <div style="margin-bottom:20px;">
                            <label style="display:block;margin-bottom:10px;font-weight:600;color:#555;">Level of Exam Passed <span style="color:red;">*</span></label>
                            <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:15px;">
                                <label style="display:flex;align-items:center;padding:10px;background:white;border:2px solid #ddd;border-radius:8px;cursor:pointer;">
                                    <input type="radio" name="exam-level" value="under-matric" style="margin-right:8px;"> Under Matric
                                </label>
                                <label style="display:flex;align-items:center;padding:10px;background:white;border:2px solid #ddd;border-radius:8px;cursor:pointer;">
                                    <input type="radio" name="exam-level" value="matric" style="margin-right:8px;"> Matric
                                </label>
                                <label style="display:flex;align-items:center;padding:10px;background:white;border:2px solid #ddd;border-radius:8px;cursor:pointer;">
                                    <input type="radio" name="exam-level" value="intermediate" style="margin-right:8px;"> Intermediate
                                </label>
                                <label style="display:flex;align-items:center;padding:10px;background:white;border:2px solid #ddd;border-radius:8px;cursor:pointer;">
                                    <input type="radio" name="exam-level" value="university" style="margin-right:8px;"> University
                                </label>
                            </div>
                        </div>
                        
                        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:20px;margin-bottom:20px;">
                            <div>
                                <label style="display:block;margin-bottom:8px;font-weight:600;color:#555;">Year of Passing <span style="color:red;">*</span></label>
                                <input type="number" id="year-passing" required min="1990" max="2030" style="width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:0.95rem;">
                            </div>
                            <div>
                                <label style="display:block;margin-bottom:8px;font-weight:600;color:#555;">Board Name <span style="color:red;">*</span></label>
                                <input type="text" id="board-name" required style="width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:0.95rem;">
                            </div>
                            <div>
                                <label style="display:block;margin-bottom:8px;font-weight:600;color:#555;">Board Roll Number <span style="color:red;">*</span></label>
                                <input type="text" id="roll-number" required style="width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:0.95rem;">
                            </div>
                        </div>
                        
                        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:20px;margin-bottom:20px;">
                            <div>
                                <label style="display:block;margin-bottom:8px;font-weight:600;color:#555;">Total Marks Obtained <span style="color:red;">*</span></label>
                                <input type="number" id="marks-obtained" value="${currentStudent.marksObtained || ''}" required style="width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:0.95rem;">
                            </div>
                            <div>
                                <label style="display:block;margin-bottom:8px;font-weight:600;color:#555;">Percentage (%) <span style="color:red;">*</span></label>
                                <input type="number" id="percentage" value="${currentStudent.previousExamPercent || ''}" required min="0" max="100" step="0.01" style="width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:0.95rem;">
                            </div>
                            <div>
                                <label style="display:block;margin-bottom:8px;font-weight:600;color:#555;">Total Marks <span style="color:red;">*</span></label>
                                <input type="number" id="total-marks" value="${currentStudent.totalMarks || ''}" required style="width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:0.95rem;">
                            </div>
                        </div>
                        
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px;">
                            <div>
                                <label style="display:block;margin-bottom:8px;font-weight:600;color:#555;">Previous Institution Attended</label>
                                <input type="text" id="prev-institution" style="width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:0.95rem;">
                            </div>
                            <div>
                                <label style="display:block;margin-bottom:8px;font-weight:600;color:#555;">Previous Institution Phone</label>
                                <input type="tel" id="prev-institution-phone" style="width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:0.95rem;">
                            </div>
                        </div>
                        
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px;">
                            <div>
                                <label style="display:block;margin-bottom:8px;font-weight:600;color:#555;">Current Institution Enrolled <span style="color:red;">*</span></label>
                                <input type="text" id="current-institution" required style="width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:0.95rem;">
                            </div>
                            <div>
                                <label style="display:block;margin-bottom:8px;font-weight:600;color:#555;">Current Institution Phone <span style="color:red;">*</span></label>
                                <input type="tel" id="current-institution-phone" required style="width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:0.95rem;">
                            </div>
                        </div>
                        
                        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:20px;margin-bottom:20px;">
                            <div>
                                <label style="display:block;margin-bottom:8px;font-weight:600;color:#555;">Degree / Course <span style="color:red;">*</span></label>
                                <input type="text" id="degree-course" required style="width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:0.95rem;">
                            </div>
                            <div>
                                <label style="display:block;margin-bottom:8px;font-weight:600;color:#555;">Total Duration (Years) <span style="color:red;">*</span></label>
                                <input type="number" id="course-duration" required min="1" max="10" style="width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:0.95rem;">
                            </div>
                            <div>
                                <label style="display:block;margin-bottom:8px;font-weight:600;color:#555;">Year of Study (Current) <span style="color:red;">*</span></label>
                                <input type="number" id="current-year" required min="1" max="10" style="width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:0.95rem;">
                            </div>
                        </div>
                        
                        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:20px;">
                            <div>
                                <label style="display:block;margin-bottom:8px;font-weight:600;color:#555;">Expected Start Date <span style="color:red;">*</span></label>
                                <input type="date" id="expected-start" required style="width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:0.95rem;">
                            </div>
                            <div>
                                <label style="display:block;margin-bottom:8px;font-weight:600;color:#555;">Expected Completion Date <span style="color:red;">*</span></label>
                                <input type="date" id="expected-completion" required style="width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:0.95rem;">
                            </div>
                            <div>
                                <label style="display:block;margin-bottom:8px;font-weight:600;color:#555;">Institution's Head Contact <span style="color:red;">*</span></label>
                                <input type="tel" id="head-contact" required style="width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:0.95rem;">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Bank Details Section -->
                    <div style="background:rgba(255,255,255,0.95);padding:30px;border-radius:20px;margin-bottom:30px;border:3px solid rgba(34,197,94,0.3);box-shadow:0 15px 35px rgba(34,197,94,0.1);position:relative;">
                        <h4 style="margin:0 0 25px 0;color:#1f2937;font-size:1.6rem;border-bottom:3px solid rgba(34,197,94,0.3);padding-bottom:15px;text-shadow:1px 1px 2px rgba(0,0,0,0.1);position:relative;font-weight:800;text-align:center;"><span style="background:linear-gradient(45deg,#22c55e,#16a34a);padding:12px;border-radius:15px;margin-right:15px;box-shadow:0 5px 15px rgba(34,197,94,0.2);color:white;">🏦</span> BANK DETAILS OF STUDENT</h4>
                        
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px;">
                            <div>
                                <label style="display:block;margin-bottom:8px;font-weight:600;color:#555;">Bank Account Title <span style="color:red;">*</span></label>
                                <input type="text" id="account-title" required style="width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:0.95rem;">
                            </div>
                            <div>
                                <label style="display:block;margin-bottom:8px;font-weight:600;color:#555;">Account Number <span style="color:red;">*</span></label>
                                <input type="text" id="account-number" required style="width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:0.95rem;">
                            </div>
                        </div>
                        
                        <div>
                            <label style="display:block;margin-bottom:8px;font-weight:600;color:#555;">Branch Name & Code <span style="color:red;">*</span></label>
                            <input type="text" id="branch-details" required style="width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:0.95rem;" placeholder="Branch Name and Code">
                        </div>
                    </div>
                    
                    <!-- Affidavit Section -->
                    <div style="background:rgba(255,255,255,0.95);padding:30px;border-radius:20px;margin-bottom:30px;border:3px solid rgba(239,68,68,0.3);box-shadow:0 15px 35px rgba(239,68,68,0.1);position:relative;">
                        <h4 style="margin:0 0 25px 0;color:#1f2937;font-size:1.6rem;border-bottom:3px solid rgba(239,68,68,0.3);padding-bottom:15px;text-shadow:1px 1px 2px rgba(0,0,0,0.1);position:relative;font-weight:800;text-align:center;"><span style="background:linear-gradient(45deg,#ef4444,#dc2626);padding:12px;border-radius:15px;margin-right:15px;box-shadow:0 5px 15px rgba(239,68,68,0.2);color:white;">📃</span> AFFIDAVIT REGARDING QARZ E HASNA</h4>
                        
                        <div style="background:white;padding:20px;border-radius:10px;margin-bottom:20px;border-left:4px solid #f44336;">
                            <h5 style="margin:0 0 15px 0;color:#333;">Affidavit of Undertaking</h5>
                            <p style="margin:0 0 15px 0;color:#444;line-height:1.6;font-size:0.95rem;">
                                I, <input type="text" id="affidavit-name" placeholder="Your Full Name" style="display:inline;border:none;border-bottom:2px solid #f44336;padding:5px;margin:0 5px;font-weight:600;width:200px;">,<br>
                                S/o / D/o <input type="text" id="affidavit-father" placeholder="Father's/Mother's Name" style="display:inline;border:none;border-bottom:2px solid #f44336;padding:5px;margin:0 5px;font-weight:600;width:200px;">,<br>
                                resident of <input type="text" id="affidavit-address" placeholder="Complete Address" style="display:inline;border:none;border-bottom:2px solid #f44336;padding:5px;margin:0 5px;font-weight:600;width:300px;">,<br>
                                do hereby solemnly affirm and declare on this day <input type="date" id="affidavit-date" style="display:inline;border:none;border-bottom:2px solid #f44336;padding:5px;margin:0 5px;font-weight:600;width:140px;"> at <input type="text" id="affidavit-place" placeholder="Place" style="display:inline;border:none;border-bottom:2px solid #f44336;padding:5px;margin:0 5px;font-weight:600;width:150px;"> as follows:
                            </p>
                            <ol style="margin:0;padding-left:25px;color:#444;line-height:1.8;">
                                <li>That I am of sound mind and senses, making this declaration voluntarily, without compulsion or inducement from any person.</li>
                                <li>That I acknowledge and undertake to repay the (Qarz-e-Hasna) received from Al Fizaa Girls Hostel, Apna Ghar in monthly installments after completing my education and obtaining employment, as per the institution's rules and regulations.</li>
                                <li>That in case of non-repayment, the institution shall be fully authorized to take possession of my property (movable/immovable) and sell it in order to recover the outstanding loan amount.</li>
                                <li>This affidavit is executed willingly, in the presence of witnesses, to serve as legal and moral proof of my commitment.</li>
                            </ol>
                        </div>
                        
                        <!-- Declaration Signatures -->
                        <div style="background:#f8f9fa;padding:20px;border-radius:10px;margin-bottom:20px;">
                            <h5 style="margin:0 0 15px 0;color:#333;">Declaration Signatures</h5>
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">
                                <div>
                                    <label style="display:block;margin-bottom:8px;font-weight:600;color:#555;">Name of Student (Applicant) <span style="color:red;">*</span></label>
                                    <input type="text" id="student-decl-name" required style="width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:0.95rem;">
                                </div>
                                <div>
                                    <label style="display:block;margin-bottom:8px;font-weight:600;color:#555;">Signature of Student <span style="color:red;">*</span></label>
                                    <input type="text" id="student-decl-signature" required placeholder="Type your full name as signature" style="width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;font-style:italic;font-size:0.95rem;">
                                </div>
                            </div>
                            
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-top:15px;">
                                <div>
                                    <label style="display:block;margin-bottom:8px;font-weight:600;color:#555;">Name of Opponent (if any)</label>
                                    <input type="text" id="opponent-name" style="width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:0.95rem;">
                                </div>
                                <div>
                                    <label style="display:block;margin-bottom:8px;font-weight:600;color:#555;">Opponent Signature</label>
                                    <input type="text" id="opponent-signature" style="width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;font-style:italic;font-size:0.95rem;">
                                </div>
                            </div>
                            
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-top:15px;">
                                <div>
                                    <label style="display:block;margin-bottom:8px;font-weight:600;color:#555;">Name of Respondent (if any)</label>
                                    <input type="text" id="respondent-name" style="width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:0.95rem;">
                                </div>
                                <div>
                                    <label style="display:block;margin-bottom:8px;font-weight:600;color:#555;">Respondent Signature</label>
                                    <input type="text" id="respondent-signature" style="width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;font-style:italic;font-size:0.95rem;">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Witnesses Section -->
                        <div style="background:#f0f8ff;padding:20px;border-radius:10px;">
                            <h5 style="margin:0 0 15px 0;color:#333;">👥 Witnesses</h5>
                            
                            <!-- Witness 1 -->
                            <div style="border:2px solid #2196f3;border-radius:8px;padding:15px;margin-bottom:15px;">
                                <h6 style="margin:0 0 10px 0;color:#2196f3;">Witness 1</h6>
                                <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
                                    <div>
                                        <label style="display:block;margin-bottom:5px;font-weight:600;color:#555;font-size:0.9rem;">Name</label>
                                        <input type="text" id="witness1-name" style="width:100%;padding:10px;border:2px solid #ddd;border-radius:6px;font-size:0.9rem;">
                                    </div>
                                    <div>
                                        <label style="display:block;margin-bottom:5px;font-weight:600;color:#555;font-size:0.9rem;">Father's Name</label>
                                        <input type="text" id="witness1-father" style="width:100%;padding:10px;border:2px solid #ddd;border-radius:6px;font-size:0.9rem;">
                                    </div>
                                    <div>
                                        <label style="display:block;margin-bottom:5px;font-weight:600;color:#555;font-size:0.9rem;">CNIC Number</label>
                                        <input type="text" id="witness1-cnic" placeholder="00000-0000000-0" style="width:100%;padding:10px;border:2px solid #ddd;border-radius:6px;font-size:0.9rem;">
                                    </div>
                                    <div>
                                        <label style="display:block;margin-bottom:5px;font-weight:600;color:#555;font-size:0.9rem;">Date of Birth</label>
                                        <input type="date" id="witness1-dob" style="width:100%;padding:10px;border:2px solid #ddd;border-radius:6px;font-size:0.9rem;">
                                    </div>
                                    <div>
                                        <label style="display:block;margin-bottom:5px;font-weight:600;color:#555;font-size:0.9rem;">Address</label>
                                        <input type="text" id="witness1-address" style="width:100%;padding:10px;border:2px solid #ddd;border-radius:6px;font-size:0.9rem;">
                                    </div>
                                    <div>
                                        <label style="display:block;margin-bottom:5px;font-weight:600;color:#555;font-size:0.9rem;">Signature</label>
                                        <input type="text" id="witness1-signature" placeholder="Type full name as signature" style="width:100%;padding:10px;border:2px solid #ddd;border-radius:6px;font-style:italic;font-size:0.9rem;">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Witness 2 -->
                            <div style="border:2px solid #4caf50;border-radius:8px;padding:15px;">
                                <h6 style="margin:0 0 10px 0;color:#4caf50;">Witness 2</h6>
                                <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
                                    <div>
                                        <label style="display:block;margin-bottom:5px;font-weight:600;color:#555;font-size:0.9rem;">Name</label>
                                        <input type="text" id="witness2-name" style="width:100%;padding:10px;border:2px solid #ddd;border-radius:6px;font-size:0.9rem;">
                                    </div>
                                    <div>
                                        <label style="display:block;margin-bottom:5px;font-weight:600;color:#555;font-size:0.9rem;">Father's Name</label>
                                        <input type="text" id="witness2-father" style="width:100%;padding:10px;border:2px solid #ddd;border-radius:6px;font-size:0.9rem;">
                                    </div>
                                    <div>
                                        <label style="display:block;margin-bottom:5px;font-weight:600;color:#555;font-size:0.9rem;">CNIC Number</label>
                                        <input type="text" id="witness2-cnic" placeholder="00000-0000000-0" style="width:100%;padding:10px;border:2px solid #ddd;border-radius:6px;font-size:0.9rem;">
                                    </div>
                                    <div>
                                        <label style="display:block;margin-bottom:5px;font-weight:600;color:#555;font-size:0.9rem;">Date of Birth</label>
                                        <input type="date" id="witness2-dob" style="width:100%;padding:10px;border:2px solid #ddd;border-radius:6px;font-size:0.9rem;">
                                    </div>
                                    <div>
                                        <label style="display:block;margin-bottom:5px;font-weight:600;color:#555;font-size:0.9rem;">Address</label>
                                        <input type="text" id="witness2-address" style="width:100%;padding:10px;border:2px solid #ddd;border-radius:6px;font-size:0.9rem;">
                                    </div>
                                    <div>
                                        <label style="display:block;margin-bottom:5px;font-weight:600;color:#555;font-size:0.9rem;">Signature</label>
                                        <input type="text" id="witness2-signature" placeholder="Type full name as signature" style="width:100%;padding:10px;border:2px solid #ddd;border-radius:6px;font-style:italic;font-size:0.9rem;">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Terms & Conditions -->
                    <div style="background:rgba(255,255,255,0.95);padding:30px;border-radius:20px;margin-bottom:30px;border:3px solid rgba(107,114,128,0.3);box-shadow:0 15px 35px rgba(107,114,128,0.1);position:relative;">
                        <h4 style="margin:0 0 25px 0;color:#1f2937;font-size:1.6rem;border-bottom:3px solid rgba(107,114,128,0.3);padding-bottom:15px;text-shadow:1px 1px 2px rgba(0,0,0,0.1);position:relative;font-weight:800;text-align:center;"><span style="background:linear-gradient(45deg,#6b7280,#4b5563);padding:12px;border-radius:15px;margin-right:15px;box-shadow:0 5px 15px rgba(107,114,128,0.2);color:white;">📋</span> TERMS & CONDITIONS</h4>
                        <div style="background:#ffffff;padding:25px;border-radius:12px;border:3px solid rgba(107,114,128,0.2);box-shadow:0 8px 25px rgba(107,114,128,0.1);">
                            <ol style="margin:0;padding-left:30px;color:#1f2937;line-height:2;font-size:1.05rem;font-weight:600;">
                                <li style="margin-bottom:15px;">Students from deserving families who have secured at least 80% marks in Matric/Intermediate are eligible. They must also secure above 70% in subsequent classes to continue receiving the Sponsorships.</li>
                                <li style="margin-bottom:15px;">Exceptionally talented students with 75% marks in Matric, even if not previously supported by this institution, are also eligible.</li>
                                <li style="margin-bottom:15px;">Orphans will receive an advantage of 60% marks requirement.</li>
                                <li style="margin-bottom:15px;">The Qarz-e-Hasna program is open to all applicants regardless of religion, color, or race.</li>
                                <li style="margin-bottom:15px;">The applicant must belong to Gilgit-Baltistan.</li>
                                <li style="margin-bottom:15px;">A copy of result cards of examinations must be submitted with this form.</li>
                                <li style="margin-bottom:15px;">Any decision taken by the institution regarding this agreement shall be final and binding.</li>
                            </ol>
                            
                            <div style="margin-top:25px;padding:20px;background:linear-gradient(135deg,rgba(34,197,94,0.1),rgba(59,130,246,0.1));border-radius:12px;border:3px solid rgba(34,197,94,0.3);">
                                <label style="display:flex;align-items:center;font-weight:800;color:#1f2937;font-size:1.1rem;cursor:pointer;">
                                    <input type="checkbox" id="terms-agreement" required style="margin-right:15px;transform:scale(1.5);accent-color:#22c55e;">
                                    I have read, understood, and agree to all the above terms and conditions. <span style="color:#ef4444;font-weight:900;">*</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Submit Button -->
                    <div style="text-align:center;margin-top:40px;position:relative;">
                        <button type="submit" style="background:linear-gradient(135deg,#ff6b6b,#4ecdc4,#45b7d1,#96ceb4);background-size:300% 300%;animation:gradientShift 4s ease infinite;color:white;border:none;padding:20px 60px;border-radius:25px;font-size:1.3rem;font-weight:800;cursor:pointer;box-shadow:0 15px 40px rgba(255,107,107,0.4),0 5px 15px rgba(0,0,0,0.2);transition:all 0.4s cubic-bezier(0.4,0,0.2,1);text-transform:uppercase;letter-spacing:1px;position:relative;overflow:hidden;" onmouseover="this.style.transform='translateY(-3px) scale(1.05)';this.style.boxShadow='0 20px 50px rgba(255,107,107,0.5),0 8px 25px rgba(0,0,0,0.3)'" onmouseout="this.style.transform='translateY(0) scale(1)';this.style.boxShadow='0 15px 40px rgba(255,107,107,0.4),0 5px 15px rgba(0,0,0,0.2)'">
                            <span style="position:relative;z-index:2;">  Submit Qarz-e-Hasna Application</span>
                            <div style="position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.3),transparent);animation:shimmer 2s infinite;"></div>
                        </button>
                        <div style="margin:25px 0 0 0;padding:20px;background:linear-gradient(135deg,rgba(255,107,107,0.1),rgba(78,205,196,0.1));border-radius:15px;border:2px solid rgba(255,107,107,0.3);backdrop-filter:blur(10px);">
                            <p style="margin:0;color:#333;font-size:1rem;max-width:650px;margin-left:auto;margin-right:auto;line-height:1.7;">
                                <span style="font-size:1.5rem;">⚠️</span> 
                                <strong style="color:#ff6b6b;">Important Notice:</strong> Once you submit this application, you will not be able to edit or modify any information. Please review all details carefully before submitting. Your application will be reviewed by the administration within 5-7 business days.
                            </p>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Add form submit handler
    document.getElementById('qarz-hasna-form').addEventListener('submit', function(e) {
        e.preventDefault();
        submitQarzEHasnaForm(e);
    });
}

function closeQarzFormModal() {
    const modal = document.getElementById('qarz-form-modal');
    if (modal) modal.remove();
}

function handlePhotoUpload(input) {
    const file = input.files[0];
    const preview = document.getElementById('photo-preview');
    
    if (file) {
        // Check file size (2MB limit)
        if (file.size > 2 * 1024 * 1024) {
            showModal('❌ File size should be less than 2MB');
            input.value = '';
            return;
        }
        
        // Check file type
        if (!file.type.startsWith('image/')) {
            showModal('❌ Please select a valid image file');
            input.value = '';
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            preview.innerHTML = `<img src="${e.target.result}" style="width:100%;height:100%;object-fit:cover;border-radius:12px;">`;
        };
        reader.readAsDataURL(file);
    } else {
        preview.innerHTML = '📸<br>No Photo<br>Selected';
    }
}

function submitQarzEHasnaForm(event) {
    event.preventDefault();
    
    const userRole = localStorage.getItem('userRole') || '';
    
    // If admin user, show preview message instead of submitting
    if (userRole === 'admin') {
        showModal(`
            <div style="max-width:600px;width:90vw;margin:0 auto;">
                <div style="background:linear-gradient(135deg, #3b82f6, #6366f1);color:white;padding:40px;border-radius:20px;text-align:center;position:relative;overflow:hidden;">
                    <div style="position:absolute;top:-50px;right:-50px;width:150px;height:150px;background:rgba(255,255,255,0.1);border-radius:50%;animation:float 8s ease-in-out infinite;"></div>
                    <div style="position:relative;z-index:2;">
                        <div style="font-size:4rem;margin-bottom:20px;animation:statusPulse 2s ease-in-out infinite;">👨‍💼</div>
                        <h2 style="margin:0 0 15px 0;font-size:2rem;font-weight:900;color:#ffffff;">Admin Form Preview</h2>
                        <p style="margin:0;font-size:1.1rem;opacity:0.95;color:#ffffff;">This is the Qarz-e-Hasna application form that students use</p>
                    </div>
                </div>
                
                <div style="background:linear-gradient(135deg, #ffffff, #f8fafc);padding:30px;margin:-1px;border-radius:0 0 20px 20px;">
                    <div style="padding:20px;background:linear-gradient(135deg, #eff6ff, #dbeafe);border-radius:12px;border-left:4px solid #3b82f6;margin-bottom:20px;">
                        <div style="font-weight:700;color:#1e40af;margin-bottom:10px;">📋 Form Overview:</div>
                        <div style="color:#374151;font-size:0.95rem;line-height:1.5;">
                            • Complete student application form with photo upload<br>
                            • Personal and educational information collection<br>
                            • Declaration and affidavit sections<br>
                            • Bank details for loan disbursement<br>
                            • Witness information and legal agreements<br>
                            • Terms and conditions acceptance
                        </div>
                    </div>
                    
                    <div style="padding:15px;background:linear-gradient(135deg, #fef3c7, #fde68a);border-radius:10px;border-left:4px solid #f59e0b;margin-bottom:20px;">
                        <div style="color:#92400e;font-weight:600;font-size:0.9rem;">
                            💡 As an admin, you can view the form structure to understand what information students provide when applying for Qarz-e-Hasna.
                        </div>
                    </div>
                    
                    <div style="text-align:center;">
                        <button onclick="closeModal()" style="background:linear-gradient(135deg, #3b82f6, #6366f1);color:white;border:none;padding:15px 30px;border-radius:12px;font-size:1rem;font-weight:700;cursor:pointer;box-shadow:0 8px 25px rgba(59,130,246,0.3);">
                            ✓ Close Preview
                        </button>
                    </div>
                </div>
            </div>
        `);
        return;
    }
    
    const currentStudent = getCurrentStudent();
    
    // Check if student already has a submitted application
    const existingApplications = JSON.parse(localStorage.getItem('qarzApplications') || '[]');
    const hasExistingApplication = existingApplications.some(app => app.studentId === currentStudent.id);
    
    if (hasExistingApplication) {
        showModal('❌ You have already submitted a Qarz-e-Hasna application. Multiple applications are not allowed.');
        return;
    }
    
    // Collect all form data
    const formData = {
        // Applicant Information
        deceasedFatherName: document.getElementById('deceased-father-name').value,
        applicantName: document.getElementById('applicant-name').value,
        deservingOnly: document.getElementById('deserving-only').checked,
        residentialAddress: document.getElementById('residential-address').value,
        district: document.getElementById('district').value,
        dateOfBirth: document.getElementById('date-of-birth').value,
        phoneNumber: document.getElementById('phone-number').value,
        
        // Declaration
        declarationName: document.getElementById('declaration-name').value,
        declarationAddress: document.getElementById('declaration-address').value,
        qarzAmount: document.getElementById('qarz-amount').value,
        qarzStartDate: document.getElementById('qarz-start-date').value,
        qarzEndDate: document.getElementById('qarz-end-date').value,
        qarzYears: document.getElementById('qarz-years').value,
        applicantSignature: document.getElementById('applicant-signature').value,
        declarationDate: document.getElementById('declaration-date').value,
        
        // Educational Information
        examLevel: document.querySelector('input[name="exam-level"]:checked')?.value,
        yearPassing: document.getElementById('year-passing').value,
        boardName: document.getElementById('board-name').value,
        rollNumber: document.getElementById('roll-number').value,
        marksObtained: document.getElementById('marks-obtained').value,
        percentage: document.getElementById('percentage').value,
        totalMarks: document.getElementById('total-marks').value,
        prevInstitution: document.getElementById('prev-institution').value,
        prevInstitutionPhone: document.getElementById('prev-institution-phone').value,
        currentInstitution: document.getElementById('current-institution').value,
        currentInstitutionPhone: document.getElementById('current-institution-phone').value,
        degreeCourse: document.getElementById('degree-course').value,
        courseDuration: document.getElementById('course-duration').value,
        currentYear: document.getElementById('current-year').value,
        expectedStart: document.getElementById('expected-start').value,
        expectedCompletion: document.getElementById('expected-completion').value,
        headContact: document.getElementById('head-contact').value,
        
        // Bank Details
        accountTitle: document.getElementById('account-title').value,
        accountNumber: document.getElementById('account-number').value,
        branchDetails: document.getElementById('branch-details').value,
        
        // Affidavit
        affidavitName: document.getElementById('affidavit-name').value,
        affidavitFather: document.getElementById('affidavit-father').value,
        affidavitAddress: document.getElementById('affidavit-address').value,
        affidavitDate: document.getElementById('affidavit-date').value,
        affidavitPlace: document.getElementById('affidavit-place').value,
        
        // Declaration Signatures
        studentDeclName: document.getElementById('student-decl-name').value,
        studentDeclSignature: document.getElementById('student-decl-signature').value,
        opponentName: document.getElementById('opponent-name').value,
        opponentSignature: document.getElementById('opponent-signature').value,
        respondentName: document.getElementById('respondent-name').value,
        respondentSignature: document.getElementById('respondent-signature').value,
        
        // Witnesses
        witness1: {
            name: document.getElementById('witness1-name').value,
            father: document.getElementById('witness1-father').value,
            cnic: document.getElementById('witness1-cnic').value,
            dob: document.getElementById('witness1-dob').value,
            address: document.getElementById('witness1-address').value,
            signature: document.getElementById('witness1-signature').value
        },
        witness2: {
            name: document.getElementById('witness2-name').value,
            father: document.getElementById('witness2-father').value,
            cnic: document.getElementById('witness2-cnic').value,
            dob: document.getElementById('witness2-dob').value,
            address: document.getElementById('witness2-address').value,
            signature: document.getElementById('witness2-signature').value
        },
        
        // Terms Agreement
        termsAgreed: document.getElementById('terms-agreement').checked
    };
    
    // Validate required fields
    const requiredFields = [
        'deceasedFatherName', 'applicantName', 'residentialAddress', 'district', 
        'dateOfBirth', 'phoneNumber', 'declarationDate', 'examLevel', 'yearPassing',
        'boardName', 'rollNumber', 'marksObtained', 'percentage', 'totalMarks',
        'currentInstitution', 'currentInstitutionPhone', 'degreeCourse', 'courseDuration',
        'currentYear', 'expectedStart', 'expectedCompletion', 'headContact',
        'accountTitle', 'accountNumber', 'branchDetails', 'studentDeclName', 'studentDeclSignature'
    ];
    
    const missingFields = requiredFields.filter(field => !formData[field] || formData[field].trim() === '');
    
    if (missingFields.length > 0) {
        showModal('❌ Please fill in all required fields marked with *');
        return;
    }
    
    if (!formData.termsAgreed) {
        showModal('❌ You must agree to the terms and conditions to proceed.');
        return;
    }
    
    // Create application record
    const applicationData = {
        id: 'QEH-' + Date.now(),
        studentId: currentStudent.id,
        studentName: currentStudent.name,
        submissionDate: new Date().toLocaleDateString(),
        submissionTime: new Date().toLocaleTimeString(),
        status: 'Pending Review',
        formData: formData,
        isEditable: false // Once submitted, cannot be edited
    };
    
    // Save to localStorage
    existingApplications.push(applicationData);
    localStorage.setItem('qarzApplications', JSON.stringify(existingApplications));
    
    // Close modal and show success message
    closeQarzFormModal();
    
    showModal(`✅ Qarz-e-Hasna Application Submitted Successfully!<br><br>
📋 <strong>Application ID:</strong> ${applicationData.id}<br>
📅 <strong>Submitted:</strong> ${applicationData.submissionDate} at ${applicationData.submissionTime}<br>
⏳ <strong>Status:</strong> ${applicationData.status}<br><br>
Your application will be reviewed by the administration within 5-7 business days. You will be notified of the decision through your registered contact information.<br><br>
⚠️ <strong>Important:</strong> This application cannot be modified once submitted. Please keep your Application ID for future reference.`);
}

// ---------- Document Scanner ----------
function showDocumentScanner() {
    const modalHtml = `
    <div style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;display:flex;justify-content:center;align-items:center;" id="scanner-modal">
        <div style="background:white;padding:30px;border-radius:15px;max-width:600px;width:90%;box-shadow:0 15px 35px rgba(0,0,0,0.3);">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                <h2 style="margin:0;color:#333;">📄 Document Scanner & Form Extractor</h2>
                <button onclick="closeDocumentScanner()" style="background:none;border:none;font-size:1.5rem;cursor:pointer;color:#666;">&times;</button>
            </div>
            <p style="color:#666;margin-bottom:20px;">Upload student forms (images or PDFs) to automatically extract and store student data.</p>
            
            <div style="margin-bottom:20px;">
                <label style="display:block;margin-bottom:10px;font-weight:600;">Select Document:</label>
                <input type="file" id="document-upload" accept="image/*,.pdf" style="width:100%;padding:10px;border:2px dashed #ddd;border-radius:8px;">
            </div>
            
            <div id="extraction-status" style="margin:20px 0;padding:15px;background:#f8f9fa;border-radius:8px;display:none;">
                <p style="margin:0;color:#666;">Processing document...</p>
            </div>
            
            <div id="extracted-data" style="margin:20px 0;display:none;">
                <h4>Extracted Information:</h4>
                <div id="data-preview" style="background:#f8f9fa;padding:15px;border-radius:8px;max-height:200px;overflow-y:auto;"></div>
            </div>
            
            <div style="display:flex;gap:10px;margin-top:20px;">
                <button onclick="processDocument()" style="flex:1;padding:12px;background:linear-gradient(135deg,#28a745,#20c997);color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">📤 Process & Extract</button>
                <button onclick="closeDocumentScanner()" style="flex:1;padding:12px;background:#6c757d;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">Cancel</button>
            </div>
        </div>
    </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
}

function closeDocumentScanner() {
    const modal = document.getElementById('scanner-modal');
    if (modal) modal.remove();
}

function processDocument() {
    const fileInput = document.getElementById('document-upload');
    const statusDiv = document.getElementById('extraction-status');
    const dataDiv = document.getElementById('extracted-data');
    const previewDiv = document.getElementById('data-preview');
    
    if (!fileInput.files[0]) {
        alert('Please select a document first');
        return;
    }
    
    const file = fileInput.files[0];
    statusDiv.style.display = 'block';
    statusDiv.innerHTML = '<p style="margin:0;color:#666;">📄 Processing document...</p>';
    
    // Simulate OCR processing
    setTimeout(() => {
        const extractedText = simulateOCR(file.name);
        const studentData = parseStudentData(extractedText);
        
        previewDiv.innerHTML = `
            <div style="margin-bottom:15px;">
                <strong>Raw Extracted Text:</strong><br>
                <div style="background:white;padding:10px;border:1px solid #ddd;border-radius:4px;font-family:monospace;font-size:0.9rem;max-height:100px;overflow-y:auto;">${extractedText}</div>
            </div>
            <div>
                <strong>Parsed Student Data:</strong><br>
                <div style="background:white;padding:10px;border:1px solid #ddd;border-radius:4px;">
                    <p><strong>Name:</strong> ${studentData.name}</p>
                    <p><strong>Contact:</strong> ${studentData.contact}</p>
                    <p><strong>Guardian:</strong> ${studentData.guardian}</p>
                    <p><strong>Guardian Contact:</strong> ${studentData.guardianContact}</p>
                    <p><strong>Address:</strong> ${studentData.address}</p>
                </div>
            </div>
            <div style="margin-top:15px;">
                <button onclick="saveExtractedStudent()" style="padding:10px 20px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;border-radius:6px;cursor:pointer;font-weight:600;">💾 Save to Student List</button>
            </div>
        `;
        
        statusDiv.innerHTML = '<p style="margin:0;color:#28a745;">✅ Document processed successfully!</p>';
        dataDiv.style.display = 'block';
        
        // Store extracted data temporarily
        window.tempExtractedData = studentData;
    }, 2000);
}

function simulateOCR(filename) {
    // Simulate OCR extraction with sample data
    const sampleTexts = [
        "Student Application Form\nName: Sarah Ahmed\nContact: 0300-1234567\nFather Name: Ahmed Ali\nFather Contact: 0300-7654321\nAddress: Village Khaplu, Skardu\nSchool: Government Girls High School\nCollege: Degree College Skardu",
        "ADMISSION FORM\nStudent Name: Zara Khan\nPhone: 0355-9876543\nGuardian: Mr. Khan\nGuardian Phone: 0344-5555555\nHome Address: Shigar Valley, Baltistan\nEducation: Intermediate\nUniversity: UOBS",
        "Registration Details\nFull Name: Ayesha Malik\nMobile: 0300-1111111\nParent: Mrs. Malik\nParent Contact: 0355-2222222\nResidence: Gultari, Skardu\nPrevious School: Public School\nCurrent Institution: Karakoram University"
    ];
    
    return sampleTexts[Math.floor(Math.random() * sampleTexts.length)];
}

function parseStudentData(text) {
    // Simple text parsing to extract student information
    const data = {
        name: extractField(text, ['name', 'student name', 'full name']),
        contact: extractField(text, ['contact', 'phone', 'mobile']),
        guardian: extractField(text, ['father name', 'guardian', 'parent']),
        guardianContact: extractField(text, ['father contact', 'guardian phone', 'parent contact']),
        address: extractField(text, ['address', 'residence', 'home address']),
        school: extractField(text, ['school', 'previous school']),
        college: extractField(text, ['college', 'institution', 'university'])
    };
    
    return data;
}

function extractField(text, keywords) {
    const lines = text.toLowerCase().split('\n');
    
    for (const keyword of keywords) {
        for (const line of lines) {
            if (line.includes(keyword + ':')) {
                return line.split(keyword + ':')[1]?.trim() || 'Not found';
            }
        }
    }
    
    return 'Not found';
}

function saveExtractedStudent() {
    if (!window.tempExtractedData) {
        alert('No data to save');
        return;
    }
    
    const data = window.tempExtractedData;
    const students = JSON.parse(localStorage.getItem('studentList') || '[]');
    const users = JSON.parse(localStorage.getItem('userCredentials') || '[]');
    
    // Generate new student ID
    const nextNumber = String(students.length + 1).padStart(2, '0');
    const studentId = 'AF' + nextNumber;
    
    // Create new student record
    const newStudent = {
        id: studentId,
        name: data.name !== 'Not found' ? data.name : 'Extracted Student',
        contact: data.contact !== 'Not found' ? data.contact : '0300-0000000',
        guardian: data.guardian !== 'Not found' ? data.guardian : 'Guardian Name',
        guardianContact: data.guardianContact !== 'Not found' ? data.guardianContact : '0300-0000000',
        guardianId: '00000-0000000-0',
        roomNo: '',
        feePaid: 0,
        totalFee: 0,
        due: 0,
        emergencyContact: '',
        admissionDate: new Date().toLocaleDateString(),
        graduationDate: '',
        medical: '',
        sponsored: false,
        scholarship: false,
        partialSupport: false,
        village: data.address !== 'Not found' ? data.address : 'Village',
        school: data.school !== 'Not found' ? data.school : 'School Name',
        college: data.college !== 'Not found' ? data.college : 'College Name',
        university: data.college !== 'Not found' ? data.college : 'University Name',
        signature: data.name !== 'Not found' ? data.name : 'Student Signature',
        admissionFee: 0,
        securityFee: 0,
        previousExamPercent: 0,
        marksObtained: 0,
        totalMarks: 0,
        documents: {},
        extractedFrom: 'Document Scanner',
        extractedDate: new Date().toISOString()
    };
    
    // Add to student list
    students.push(newStudent);
    localStorage.setItem('studentList', JSON.stringify(students));
    
    // Create user credentials
    const username = data.name !== 'Not found' ? data.name.toLowerCase().replace(/\s+/g, '') : `student${studentId}`;
    const password = 'password123';
    
    users.push({username: username, password: password, role: 'student', studentId: studentId});
    users.push({username: username + '_parent', password: password, role: 'parent', studentId: studentId});
    localStorage.setItem('userCredentials', JSON.stringify(users));
    
    alert(`Student data extracted and saved successfully!\nStudent ID: ${studentId}\nLogin: ${username} / ${password}`);
    
    // Clean up
    delete window.tempExtractedData;
    closeDocumentScanner();
    
    // Refresh student list if currently viewing
    const currentContent = document.getElementById('main-content');
    if (currentContent && currentContent.querySelector('#enrolled-students-tbody')) {
        setupEnrolledStudents();
    }
}

// ---------- Fee Slip Records ----------
function showFeeSlipRecords() {
    const userRole = localStorage.getItem('userRole');
    const currentStudentId = localStorage.getItem('studentId');
    const feeSlips = JSON.parse(localStorage.getItem('feeSlipRecords') || '[]');
    
    // Filter slips based on user role
    let filteredSlips = feeSlips;
    if (userRole === 'student' || userRole === 'parent') {
        filteredSlips = feeSlips.filter(slip => slip.studentId === currentStudentId);
    }
    
    const modalHtml = `
    <div style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;display:flex;justify-content:center;align-items:center;" id="fee-slip-modal">
        <div style="background:white;padding:30px;border-radius:15px;max-width:900px;width:90%;max-height:80vh;overflow-y:auto;box-shadow:0 15px 35px rgba(0,0,0,0.3);">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                <h2 style="margin:0;color:#333;">📄 Fee Slip Records</h2>
                <button onclick="closeFeeSlipRecords()" style="background:none;border:none;font-size:1.5rem;cursor:pointer;color:#666;">&times;</button>
            </div>
            ${filteredSlips.length === 0 ? 
                '<p style="text-align:center;color:#888;padding:40px;">No fee slip records found</p>' :
                `<table style="width:100%;border-collapse:collapse;">
                    <thead>
                        <tr style="background:linear-gradient(135deg,var(--gradient-1),var(--gradient-2));color:white;">
                            <th style="padding:12px;text-align:left;">Receipt #</th>
                            <th style="padding:12px;text-align:left;">Student</th>
                            <th style="padding:12px;text-align:left;">Type</th>
                            <th style="padding:12px;text-align:left;">Amount</th>
                            <th style="padding:12px;text-align:left;">Date</th>
                            <th style="padding:12px;text-align:center;">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredSlips.map((slip, i) => `
                            <tr style="background:${i % 2 === 0 ? '#f9f9f9' : 'white'};">
                                <td style="padding:10px;border:1px solid #ddd;font-family:monospace;">${slip.id}</td>
                                <td style="padding:10px;border:1px solid #ddd;">${slip.studentName} (${slip.studentId})</td>
                                <td style="padding:10px;border:1px solid #ddd;">${slip.type.charAt(0).toUpperCase() + slip.type.slice(1)}</td>
                                <td style="padding:10px;border:1px solid #ddd;font-weight:600;">PKR ${slip.amount}</td>
                                <td style="padding:10px;border:1px solid #ddd;">${slip.date}</td>
                                <td style="padding:10px;border:1px solid #ddd;text-align:center;">
                                    <button onclick="viewFeeSlip('${slip.id}')" style="padding:6px 12px;background:linear-gradient(135deg,#28a745,#20c997);color:white;border:none;border-radius:4px;cursor:pointer;font-size:12px;">View</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>`
            }
            <div style="text-align:center;margin-top:20px;">
                <button onclick="closeFeeSlipRecords()" style="padding:12px 25px;background:#6c757d;color:white;border:none;border-radius:8px;cursor:pointer;font-weight:600;">Close</button>
            </div>
        </div>
    </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
}

function closeFeeSlipRecords() {
    const modal = document.getElementById('fee-slip-modal');
    if (modal) modal.remove();
}

function viewFeeSlip(slipId) {
    const feeSlips = JSON.parse(localStorage.getItem('feeSlipRecords') || '[]');
    const slip = feeSlips.find(s => s.id === slipId);
    
    if (!slip) {
        alert('Fee slip not found');
        return;
    }
    
    const invoiceHtml = `
    <div style="max-width:600px;margin:0 auto;padding:30px;background:white;border:2px solid #ddd;">
        <div style="text-align:center;margin-bottom:30px;">
            <h1 style="color:#333;margin:0;">Al Fizaa Girls Hostel</h1>
            <h2 style="color:#666;margin:5px 0;">Payment Receipt</h2>
            <p style="margin:0;color:#888;">Receipt #: ${slip.id}</p>
        </div>
        <div style="margin-bottom:20px;">
            <p><strong>Student Name:</strong> ${slip.studentName}</p>
            <p><strong>Student ID:</strong> ${slip.studentId}</p>
            <p><strong>Payment Type:</strong> ${slip.type.charAt(0).toUpperCase() + slip.type.slice(1)} Fee</p>
            <p><strong>Amount Paid:</strong> PKR ${slip.amount}</p>
            <p><strong>Date:</strong> ${slip.date}</p>
        </div>
        <div style="text-align:center;margin-top:30px;">
            <p style="color:#666;">Thank you for your payment!</p>
        </div>
    </div>
    `;
    
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`<html><head><title>Fee Slip - ${slip.id}</title></head><body>${invoiceHtml}</body></html>`);
    printWindow.document.close();
    printWindow.print();
}

// ---------- Audit Report Functions ----------
function generateAuditReport() {
    const period = document.getElementById('audit-period').value;
    const startDate = document.getElementById('audit-start-date').value;
    const endDate = document.getElementById('audit-end-date').value;
    const contentDiv = document.getElementById('audit-report-content');
    
    // Get data for the report
    const incomeList = JSON.parse(localStorage.getItem('incomeList') || '[]');
    const expenseList = JSON.parse(localStorage.getItem('expenseList') || '[]');
    const studentList = JSON.parse(localStorage.getItem('studentList') || '[]');
    
    // Filter data based on period
    let filteredIncome = incomeList;
    let filteredExpense = expenseList;
    
    const now = new Date();
    
    if (period === 'current-month') {
        filteredIncome = incomeList.filter(item => {
            const itemDate = new Date(item.date);
            return itemDate.getMonth() === now.getMonth() && itemDate.getFullYear() === now.getFullYear();
        });
        filteredExpense = expenseList.filter(item => {
            const itemDate = new Date(item.date);
            return itemDate.getMonth() === now.getMonth() && itemDate.getFullYear() === now.getFullYear();
        });
    } else if (period === 'last-month') {
        const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
        filteredIncome = incomeList.filter(item => {
            const itemDate = new Date(item.date);
            return itemDate.getMonth() === lastMonth.getMonth() && itemDate.getFullYear() === lastMonth.getFullYear();
        });
        filteredExpense = expenseList.filter(item => {
            const itemDate = new Date(item.date);
            return itemDate.getMonth() === lastMonth.getMonth() && itemDate.getFullYear() === lastMonth.getFullYear();
        });
    } else if (period === 'current-year') {
        filteredIncome = incomeList.filter(item => new Date(item.date).getFullYear() === now.getFullYear());
        filteredExpense = expenseList.filter(item => new Date(item.date).getFullYear() === now.getFullYear());
    } else if (period === 'last-year') {
        filteredIncome = incomeList.filter(item => new Date(item.date).getFullYear() === now.getFullYear() - 1);
        filteredExpense = expenseList.filter(item => new Date(item.date).getFullYear() === now.getFullYear() - 1);
    } else if (period === 'custom' && startDate && endDate) {
        filteredIncome = incomeList.filter(item => {
            const itemDate = new Date(item.date);
            return itemDate >= new Date(startDate) && itemDate <= new Date(endDate);
        });
        filteredExpense = expenseList.filter(item => {
            const itemDate = new Date(item.date);
            return itemDate >= new Date(startDate) && itemDate <= new Date(endDate);
        });
    }
    
    // Calculate totals
    const totalIncome = filteredIncome.reduce((sum, item) => sum + parseFloat(item.amount || 0), 0);
    const totalExpense = filteredExpense.reduce((sum, item) => sum + parseFloat(item.amount || 0), 0);
    const netProfit = totalIncome - totalExpense;
    
    // Generate report HTML
    const reportHTML = `
        <div style="text-align: center; margin-bottom: 20px;">
            <h3 style="color: #333; margin-bottom: 10px;">📊 Financial Audit Report</h3>
            <p style="color: #666; margin: 0;">Period: ${getPeriodLabel(period, startDate, endDate)}</p>
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
            <div style="background: linear-gradient(135deg, #28a745, #20c997); color: white; padding: 15px; border-radius: 10px; text-align: center;">
                <div style="font-size: 1.5rem; font-weight: bold;">PKR ${totalIncome.toLocaleString()}</div>
                <div style="opacity: 0.9;">Total Income</div>
            </div>
            <div style="background: linear-gradient(135deg, #dc3545, #fd7e14); color: white; padding: 15px; border-radius: 10px; text-align: center;">
                <div style="font-size: 1.5rem; font-weight: bold;">PKR ${totalExpense.toLocaleString()}</div>
                <div style="opacity: 0.9;">Total Expense</div>
            </div>
            <div style="background: linear-gradient(135deg, ${netProfit >= 0 ? '#17a2b8, #6f42c1' : '#ffc107, #fd7e14'}); color: white; padding: 15px; border-radius: 10px; text-align: center;">
                <div style="font-size: 1.5rem; font-weight: bold;">PKR ${netProfit.toLocaleString()}</div>
                <div style="opacity: 0.9;">${netProfit >= 0 ? 'Net Profit' : 'Net Loss'}</div>
            </div>
        </div>
        
        <div style="margin-bottom: 20px;">
            <h4 style="color: #333; margin-bottom: 10px;">📈 Income Breakdown</h4>
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                ${getIncomeBreakdown(filteredIncome)}
            </div>
        </div>
        
        <div style="margin-bottom: 20px;">
            <h4 style="color: #333; margin-bottom: 10px;">📉 Expense Breakdown</h4>
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                ${getExpenseBreakdown(filteredExpense)}
            </div>
        </div>
        
        <div style="margin-bottom: 20px;">
            <h4 style="color: #333; margin-bottom: 10px;">👥 Student Statistics</h4>
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                <p><strong>Total Students:</strong> ${studentList.length}</p>
                <p><strong>Sponsored Students:</strong> ${studentList.filter(s => s.sponsored).length}</p>
                <p><strong>Scholarship Students:</strong> ${studentList.filter(s => s.scholarship).length}</p>
                <p><strong>Partial Support:</strong> ${studentList.filter(s => s.partialSupport).length}</p>
            </div>
        </div>
        
        <div style="text-align: center; margin-top: 20px; padding: 15px; background: #e9ecef; border-radius: 8px;">
            <p style="margin: 0; color: #666; font-size: 0.9rem;">Report generated on ${new Date().toLocaleDateString()} at ${new Date().toLocaleTimeString()}</p>
        </div>
    `;
    
    contentDiv.innerHTML = reportHTML;
}

function getPeriodLabel(period, startDate, endDate) {
    switch(period) {
        case 'current-month': return new Date().toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
        case 'last-month': {
            const lastMonth = new Date();
            lastMonth.setMonth(lastMonth.getMonth() - 1);
            return lastMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
        }
        case 'current-year': return new Date().getFullYear().toString();
        case 'last-year': return (new Date().getFullYear() - 1).toString();
        case 'custom': return `${startDate} to ${endDate}`;
        default: return 'All Time';
    }
}

function getIncomeBreakdown(incomeList) {
    const categories = {};
    incomeList.forEach(item => {
        const category = item.category || 'Other';
        categories[category] = (categories[category] || 0) + parseFloat(item.amount || 0);
    });
    
    let html = '';
    Object.entries(categories).forEach(([category, amount]) => {
        html += `<p><strong>${category.charAt(0).toUpperCase() + category.slice(1)}:</strong> PKR ${amount.toLocaleString()}</p>`;
    });
    
    return html || '<p>No income records found for this period.</p>';
}

function getExpenseBreakdown(expenseList) {
    const categories = {};
    expenseList.forEach(item => {
        const category = item.category || 'Other';
        categories[category] = (categories[category] || 0) + parseFloat(item.amount || 0);
    });
    
    let html = '';
    Object.entries(categories).forEach(([category, amount]) => {
        html += `<p><strong>${category.charAt(0).toUpperCase() + category.slice(1)}:</strong> PKR ${amount.toLocaleString()}</p>`;
    });
    
    return html || '<p>No expense records found for this period.</p>';
}

function exportAuditReport() {
    const reportContent = document.getElementById('audit-report-content').innerHTML;
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
            <head>
                <title>Audit Report - Al Fizaa Girls Hostel</title>
                <style>
                    body { font-family: Arial, sans-serif; margin: 20px; }
                    h3 { color: #333; }
                    .no-print { display: none; }
                </style>
            </head>
            <body>
                <div style="text-align: center; margin-bottom: 20px;">
                    <h1>Al Fizaa Girls Hostel</h1>
                    <h2>Internal Audit Report</h2>
                </div>
                ${reportContent}
            </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.print();
}

function showAuditReportModal() {
    const modal = document.createElement('div');
    modal.id = 'audit-report-modal';
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
    `;
    
    modal.innerHTML = `
        <div style="background: white; border-radius: 15px; padding: 30px; max-width: 800px; width: 100%; max-height: 80vh; overflow-y: auto; position: relative;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0; color: #333;">📊 Internal Audit Report</h2>
                <button onclick="closeAuditModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666; padding: 5px;">&times;</button>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Select Period:</label>
                <select id="audit-period" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; margin-bottom: 10px;">
                    <option value="current-month">Current Month</option>
                    <option value="last-month">Last Month</option>
                    <option value="current-year">Current Year</option>
                    <option value="last-year">Last Year</option>
                    <option value="custom">Custom Range</option>
                </select>
                
                <div id="custom-date-range" style="display: none; margin-top: 10px;">
                    <div style="display: flex; gap: 10px;">
                        <div style="flex: 1;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Start Date:</label>
                            <input type="date" id="audit-start-date" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px;">
                        </div>
                        <div style="flex: 1;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">End Date:</label>
                            <input type="date" id="audit-end-date" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px;">
                        </div>
                    </div>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <button onclick="generateAuditReport()" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #28a745, #20c997); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">Generate Report</button>
                <button onclick="exportAuditReport()" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #17a2b8, #6f42c1); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">Export PDF</button>
            </div>
            
            <div id="audit-report-content" style="border: 1px solid #ddd; border-radius: 8px; padding: 20px; min-height: 200px; background: #f8f9fa;">
                <p style="text-align: center; color: #666; margin: 0;">Select a period and click "Generate Report" to view the audit report.</p>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    document.getElementById('audit-period').addEventListener('change', function() {
        const customRange = document.getElementById('custom-date-range');
        if (this.value === 'custom') {
            customRange.style.display = 'block';
        } else {
            customRange.style.display = 'none';
        }
    });
    
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            closeAuditModal();
        }
    });
}

function closeAuditModal() {
    const modal = document.getElementById('audit-report-modal');
    if (modal) {
        document.body.removeChild(modal);
    }
}

function generateAuditReport() {
    const period = document.getElementById('audit-period').value;
    const startDate = document.getElementById('audit-start-date').value;
    const endDate = document.getElementById('audit-end-date').value;
    const contentDiv = document.getElementById('audit-report-content');
    
    // Get data
    const incomeList = JSON.parse(localStorage.getItem('incomeList') || '[]');
    const expenseList = JSON.parse(localStorage.getItem('expenseList') || '[]');
    const studentList = JSON.parse(localStorage.getItem('studentList') || '[]');
    
    // Filter data by period
    const filteredIncome = filterByPeriod(incomeList, period, startDate, endDate);
    const filteredExpense = filterByPeriod(expenseList, period, startDate, endDate);
    
    const totalIncome = filteredIncome.reduce((sum, item) => sum + parseFloat(item.amount || 0), 0);
    const totalExpense = filteredExpense.reduce((sum, item) => sum + parseFloat(item.amount || 0), 0);
    const netProfit = totalIncome - totalExpense;
    
    const reportHTML = `
        <div style="text-align: center; margin-bottom: 30px;">
            <h3 style="color: #333; margin-bottom: 10px;">📊 Internal Audit Report</h3>
            <h4 style="color: #666; margin: 0;">${getPeriodLabel(period, startDate, endDate)}</h4>
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
            <div style="background: linear-gradient(135deg, #28a745, #20c997); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                <div style="font-size: 1.5rem; font-weight: bold;">PKR ${totalIncome.toLocaleString()}</div>
                <div style="opacity: 0.9;">Total Income</div>
            </div>
            <div style="background: linear-gradient(135deg, #dc3545, #fd7e14); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                <div style="font-size: 1.5rem; font-weight: bold;">PKR ${totalExpense.toLocaleString()}</div>
                <div style="opacity: 0.9;">Total Expenses</div>
            </div>
            <div style="background: linear-gradient(135deg, #17a2b8, #6f42c1); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                <div style="font-size: 1.5rem; font-weight: bold;">PKR ${netProfit.toLocaleString()}</div>
                <div style="opacity: 0.9;">${netProfit >= 0 ? 'Net Profit' : 'Net Loss'}</div>
            </div>
        </div>
        
        <div style="margin-bottom: 20px;">
            <h4 style="color: #333; margin-bottom: 10px;">📈 Income Breakdown</h4>
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                ${getIncomeBreakdown(filteredIncome)}
            </div>
        </div>
        
        <div style="margin-bottom: 20px;">
            <h4 style="color: #333; margin-bottom: 10px;">📉 Expense Breakdown</h4>
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                ${getExpenseBreakdown(filteredExpense)}
            </div>
        </div>
        
        <div style="margin-bottom: 20px;">
            <h4 style="color: #333; margin-bottom: 10px;">👥 Student Statistics</h4>
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                <p><strong>Total Students:</strong> ${studentList.length}</p>
                <p><strong>Sponsored Students:</strong> ${studentList.filter(s => s.sponsored).length}</p>
                <p><strong>Scholarship Students:</strong> ${studentList.filter(s => s.scholarship).length}</p>
                <p><strong>Partial Support:</strong> ${studentList.filter(s => s.partialSupport).length}</p>
            </div>
        </div>
        
        <div style="text-align: center; margin-top: 20px; padding: 15px; background: #e9ecef; border-radius: 8px;">
            <p style="margin: 0; color: #666; font-size: 0.9rem;">Report generated on ${new Date().toLocaleDateString()} at ${new Date().toLocaleTimeString()}</p>
        </div>
    `;
    
    contentDiv.innerHTML = reportHTML;
}

function filterByPeriod(items, period, startDate, endDate) {
    const now = new Date();
    return items.filter(item => {
        const itemDate = new Date(item.date);
        
        switch(period) {
            case 'current-month':
                return itemDate.getMonth() === now.getMonth() && itemDate.getFullYear() === now.getFullYear();
            case 'last-month':
                const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1);
                return itemDate.getMonth() === lastMonth.getMonth() && itemDate.getFullYear() === lastMonth.getFullYear();
            case 'current-year':
                return itemDate.getFullYear() === now.getFullYear();
            case 'last-year':
                return itemDate.getFullYear() === (now.getFullYear() - 1);
            case 'custom':
                if (startDate && endDate) {
                    return itemDate >= new Date(startDate) && itemDate <= new Date(endDate);
                }
                return true;
            default:
                return true;
        }
    });
}

function setupFeeTracker() {
    // Guest mode: Show empty fee tracker with notification
    if (isGuestMode()) {
        const feeTrackerContent = document.querySelector('#fee-tracker-content, .fee-tracker-content');
        if (feeTrackerContent) {
            feeTrackerContent.innerHTML = '';
            feeTrackerContent.appendChild(showGuestNotification("Fee tracker data is not available in guest mode."));
        }
        return;
    }
    
    const userRole = localStorage.getItem('userRole');
    const studentId = localStorage.getItem('studentId');
    
    // Hide admin-only elements for students
    if (userRole === 'student' || userRole === 'parent') {
        // Hide summary cards
        const summaryCards = document.querySelector('div[style*="grid-template-columns:repeat(auto-fit,minmax(200px,1fr))"]');
        if (summaryCards) summaryCards.style.display = 'none';
        
        // Hide admin controls
        const addPaymentBtn = document.getElementById('add-payment-btn');
        if (addPaymentBtn) addPaymentBtn.style.display = 'none';
        const feeSlipBtn = document.getElementById('fee-slip-records-btn');
        if (feeSlipBtn) feeSlipBtn.style.display = 'none';
        
        // Hide student filter
        const filterRow = document.getElementById('fee-filters');
        if (filterRow) {
            const labels = filterRow.querySelectorAll('label');
            const studentFilter = document.getElementById('fee-student-filter');
            labels.forEach(label => {
                if (label.textContent.includes('Student')) {
                    label.style.display = 'none';
                }
            });
            if (studentFilter) studentFilter.style.display = 'none';
        }
    }
    
    function loadStudents() {
        // Guest mode: return empty array
        if (isGuestMode()) {
            showGuestNotification("Student data is not available in guest mode.");
            return [];
        }
        
        const students = JSON.parse(localStorage.getItem('studentList') || '[]');
        
        // For students/parents, only return their own record
        if ((userRole === 'student' || userRole === 'parent') && studentId) {
            return students.filter(s => s.id === studentId);
        }
        
        return students;
    }
    
    function renderFeeTable() {
        const students = loadStudents();
        const tbody = document.getElementById('fee-tracker-tbody');
        tbody.innerHTML = '';
        
        students.forEach(student => {
            const row = document.createElement('tr');
            const totalAmount = student.totalFee || 0;
            const paid = student.feePaid || 0;
            const due = student.due || 0;
            
            let status;
            if (due <= 0) {
                status = '<span class="status-tag status-paid">Paid</span>';
            } else if (due > 0 && due < totalAmount) {
                status = '<span class="status-tag status-due">Partial</span>';
            } else {
                status = '<span class="status-tag status-overdue">Due</span>';
            }
            
            const dueDate = new Date();
            dueDate.setMonth(dueDate.getMonth() + 1);
            
            let actionsHtml = '';
            if (userRole === 'admin') {
                actionsHtml = `
                    <button class="btn-view" onclick="viewFeeDetails('${student.id}')">View</button>
                    <button class="btn-submit" onclick="addPayment('${student.id}')" style="margin-left: 5px;">Pay</button>
                `;
            } else {
                actionsHtml = `<button class="btn-view" onclick="viewFeeDetails('${student.id}')">View Details</button>`;
            }
            
            row.innerHTML = `
                <td>${student.id}</td>
                <td>${student.name}</td>
                <td>PKR ${totalAmount.toLocaleString()}</td>
                <td>PKR ${paid.toLocaleString()}</td>
                <td>PKR ${due.toLocaleString()}</td>
                <td>${dueDate.toLocaleDateString()}</td>
                <td>${status}</td>
                <td>${actionsHtml}</td>
            `;
            
            tbody.appendChild(row);
        });
    }
    
    window.viewFeeDetails = function(studentId) {
        const students = JSON.parse(localStorage.getItem('studentList') || '[]');
        const student = students.find(s => s.id === studentId);
        
        if (student) {
            alert(`Fee Details for ${student.name}:\n\nTotal Fee: PKR ${(student.totalFee || 0).toLocaleString()}\nPaid: PKR ${(student.feePaid || 0).toLocaleString()}\nDue: PKR ${(student.due || 0).toLocaleString()}`);
        }
    };
    
    window.addPayment = function(studentId) {
        if (userRole === 'admin') {
            const modal = document.getElementById('payment-form-modal');
            if (modal) modal.style.display = 'flex';
        }
    };
    
    renderFeeTable();
}

// ---------- Student Categories Functions ----------
function showSponsoredStudents() {
    // PRIVACY: Check access permissions
    const userRole = localStorage.getItem('userRole');
    const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
    
    if (!canAccessSponsorshipFeatures(userRole, currentUser)) {
        showModal('🚫 Access Restricted\n\nThis feature is only available to:\n• Admin users\n• Students who are in sponsored programs\n• Parents of sponsored students\n\nIf you believe this is an error, please contact the administrator.');
        return;
    }
    
    document.querySelectorAll('.nav-link').forEach(l=>l.classList.remove('active'));
    renderTemplate('sponsored-students-template');
}

function showScholarshipStudents() {
    // PRIVACY: Check access permissions
    const userRole = localStorage.getItem('userRole');
    const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
    
    if (!canAccessSponsorshipFeatures(userRole, currentUser)) {
        showModal('🚫 Access Restricted\n\nThis feature is only available to:\n• Admin users\n• Students who are in scholarship programs\n• Parents of scholarship students\n\nIf you believe this is an error, please contact the administrator.');
        return;
    }
    
    document.querySelectorAll('.nav-link').forEach(l=>l.classList.remove('active'));
    renderTemplate('scholarship-students-template');
}

function showPartialSupportStudents() {
    // PRIVACY: Check access permissions
    const userRole = localStorage.getItem('userRole');
    const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
    
    if (!canAccessSponsorshipFeatures(userRole, currentUser)) {
        showModal('🚫 Access Restricted\n\nThis feature is only available to:\n• Admin users\n• Students who receive partial support\n• Parents of students receiving partial support\n\nIf you believe this is an error, please contact the administrator.');
        return;
    }
    
    document.querySelectorAll('.nav-link').forEach(l=>l.classList.remove('active'));
    renderTemplate('partial-support-students-template');
}

function setupSponsoredStudents() {
    const students = JSON.parse(localStorage.getItem('studentList') || '[]');
    const sponsoredStudents = students.filter(s => s.sponsored === true);
    
    // Update summary cards
    document.getElementById('total-sponsored').textContent = sponsoredStudents.length;
    document.getElementById('active-sponsored').textContent = sponsoredStudents.filter(s => !s.graduationDate).length;
    
    const totalSupport = sponsoredStudents.reduce((sum, s) => sum + (s.totalFee || 0), 0);
    document.getElementById('sponsored-amount').textContent = `PKR ${totalSupport.toLocaleString()}`;
    
    // Render students grid
    renderStudentGrid(sponsoredStudents, 'sponsored-students-grid', 'sponsored');
    
    // Setup search and filters
    setupStudentSearch('sponsored-search', 'sponsored-filter', sponsoredStudents, 'sponsored-students-grid', 'sponsored');
}

function setupScholarshipStudents() {
    const students = JSON.parse(localStorage.getItem('studentList') || '[]');
    const scholarshipStudents = students.filter(s => s.scholarship === true);
    
    // Update summary cards
    document.getElementById('total-scholarship').textContent = scholarshipStudents.length;
    
    const avgGrade = scholarshipStudents.length > 0 ? 
        scholarshipStudents.reduce((sum, s) => sum + (s.previousExamPercent || 0), 0) / scholarshipStudents.length : 0;
    document.getElementById('avg-scholarship-grade').textContent = `${avgGrade.toFixed(1)}%`;
    
    const totalSavings = scholarshipStudents.reduce((sum, s) => sum + (s.totalFee || 0), 0);
    document.getElementById('scholarship-savings').textContent = `PKR ${totalSavings.toLocaleString()}`;
    
    // Render students grid
    renderStudentGrid(scholarshipStudents, 'scholarship-students-grid', 'scholarship');
    
    // Setup search and filters
    setupStudentSearch('scholarship-search', 'scholarship-filter', scholarshipStudents, 'scholarship-students-grid', 'scholarship');
}

function setupPartialSupportStudents() {
    const students = JSON.parse(localStorage.getItem('studentList') || '[]');
    const partialSupportStudents = students.filter(s => s.partialSupport === true);
    
    // Update summary cards
    document.getElementById('total-partial').textContent = partialSupportStudents.length;
    
    // Calculate average support percentage (assuming 50% for demo)
    const avgSupport = partialSupportStudents.length > 0 ? 50 : 0;
    document.getElementById('avg-support-percent').textContent = `${avgSupport}%`;
    
    const totalSupport = partialSupportStudents.reduce((sum, s) => sum + ((s.totalFee || 0) * 0.5), 0);
    document.getElementById('partial-support-amount').textContent = `PKR ${totalSupport.toLocaleString()}`;
    
    // Render students grid
    renderStudentGrid(partialSupportStudents, 'partial-support-students-grid', 'partial');
    
    // Setup search and filters
    setupStudentSearch('partial-search', 'partial-filter', partialSupportStudents, 'partial-support-students-grid', 'partial');
}

function renderStudentGrid(students, containerId, type) {
    const container = document.getElementById(containerId);
    if (!container) return;
    
    container.innerHTML = '';
    
    if (students.length === 0) {
        container.innerHTML = `
            <div style="grid-column:1/-1;text-align:center;padding:40px;background:linear-gradient(135deg,#f8f9fa,#e9ecef);border-radius:15px;">
                <div style="font-size:3rem;margin-bottom:15px;opacity:0.5;">📋</div>
                <h3 style="color:#666;margin-bottom:10px;">No ${type} students found</h3>
                <p style="color:#999;margin:0;">Students will appear here when they are marked as ${type}.</p>
            </div>
        `;
        return;
    }
    
    students.forEach(student => {
        const card = document.createElement('div');
        card.style.cssText = `
            background: linear-gradient(135deg, #fff 0%, #f8f9ff 100%);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border: 2px solid rgba(102,126,234,0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        `;
        
        const statusBadge = getStatusBadge(type);
        const supportInfo = getSupportInfo(student, type);
        
        card.innerHTML = `
            <div style="position:absolute;top:15px;right:15px;">${statusBadge}</div>
            <div style="display:flex;align-items:center;gap:15px;margin-bottom:20px;">
                <div style="width:60px;height:60px;border-radius:50%;background:linear-gradient(135deg,var(--gradient-1),var(--gradient-2));display:flex;align-items:center;justify-content:center;color:white;font-weight:800;font-size:1.2rem;">
                    ${student.name.charAt(0)}
                </div>
                <div>
                    <h3 style="margin:0 0 5px 0;color:#333;font-size:1.3rem;font-weight:700;">${student.name}</h3>
                    <p style="margin:0;color:#666;font-size:0.9rem;">ID: ${student.id} | Room: ${student.roomNo || 'Not Assigned'}</p>
                </div>
            </div>
            
            <div style="background:rgba(102,126,234,0.05);padding:15px;border-radius:12px;margin-bottom:15px;">
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
                    <div>
                        <div style="color:#666;font-size:0.8rem;margin-bottom:3px;">Contact</div>
                        <div style="color:#333;font-weight:600;">${student.contact || 'N/A'}</div>
                    </div>
                    <div>
                        <div style="color:#666;font-size:0.8rem;margin-bottom:3px;">Guardian</div>
                        <div style="color:#333;font-weight:600;">${student.guardian || 'N/A'}</div>
                    </div>
                </div>
            </div>
            
            ${supportInfo}
            
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:15px;">
                <div style="background:linear-gradient(135deg,#28a745,#20c997);color:white;padding:8px 12px;border-radius:8px;text-align:center;font-size:0.8rem;font-weight:600;">
                    Exam: ${student.previousExamPercent || 0}%
                </div>
                <div style="background:linear-gradient(135deg,#17a2b8,#6f42c1);color:white;padding:8px 12px;border-radius:8px;text-align:center;font-size:0.8rem;font-weight:600;">
                    Due: PKR ${(student.due || 0).toLocaleString()}
                </div>
            </div>
            
            <div style="margin-top:15px;text-align:center;">
                <button onclick="viewStudentDetails('${student.id}')" style="background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:600;transition:all 0.3s ease;">
                    View Details
                </button>
            </div>
        `;
        
        card.addEventListener('mouseenter', () => {
            card.style.transform = 'translateY(-5px) scale(1.02)';
            card.style.boxShadow = '0 20px 40px rgba(0,0,0,0.15)';
        });
        
        card.addEventListener('mouseleave', () => {
            card.style.transform = 'translateY(0) scale(1)';
            card.style.boxShadow = '0 10px 30px rgba(0,0,0,0.1)';
        });
        
        container.appendChild(card);
    });
}

function getStatusBadge(type) {
    const badges = {
        'sponsored': '<div style="background:linear-gradient(135deg,#28a745,#20c997);color:white;padding:5px 12px;border-radius:15px;font-size:0.7rem;font-weight:700;">💖 SPONSORED</div>',
        'scholarship': '<div style="background:linear-gradient(135deg,#6f42c1,#e83e8c);color:white;padding:5px 12px;border-radius:15px;font-size:0.7rem;font-weight:700;">🎓 SCHOLAR</div>',
        'partial': '<div style="background:linear-gradient(135deg,#fd7e14,#f093fb);color:white;padding:5px 12px;border-radius:15px;font-size:0.7rem;font-weight:700;">🤝 PARTIAL</div>'
    };
    return badges[type] || '';
}

function getSupportInfo(student, type) {
    const totalFee = student.totalFee || 0;
    const feePaid = student.feePaid || 0;
    
    if (type === 'sponsored') {
        return `
            <div style="background:linear-gradient(135deg,#28a745,#20c997);color:white;padding:15px;border-radius:12px;margin-bottom:15px;">
                <div style="font-size:0.9rem;opacity:0.9;margin-bottom:5px;">💰 Full Sponsorship Coverage</div>
                <div style="font-size:1.2rem;font-weight:700;">PKR ${totalFee.toLocaleString()}</div>
                <div style="font-size:0.8rem;opacity:0.8;margin-top:5px;">100% fees covered by sponsor</div>
            </div>
        `;
    } else if (type === 'scholarship') {
        return `
            <div style="background:linear-gradient(135deg,#6f42c1,#e83e8c);color:white;padding:15px;border-radius:12px;margin-bottom:15px;">
                <div style="font-size:0.9rem;opacity:0.9;margin-bottom:5px;">🎓 Merit Scholarship</div>
                <div style="font-size:1.2rem;font-weight:700;">PKR ${totalFee.toLocaleString()}</div>
                <div style="font-size:0.8rem;opacity:0.8;margin-top:5px;">Based on academic excellence</div>
            </div>
        `;
    } else if (type === 'partial') {
        const supportAmount = totalFee * 0.5; // Assuming 50% support
        return `
            <div style="background:linear-gradient(135deg,#fd7e14,#f093fb);color:white;padding:15px;border-radius:12px;margin-bottom:15px;">
                <div style="font-size:0.9rem;opacity:0.9;margin-bottom:5px;">🤝 Partial Support (50%)</div>
                <div style="font-size:1.2rem;font-weight:700;">PKR ${supportAmount.toLocaleString()}</div>
                <div style="font-size:0.8rem;opacity:0.8;margin-top:5px;">Remaining: PKR ${(totalFee - supportAmount).toLocaleString()}</div>
            </div>
        `;
    }
    return '';
}

function setupStudentSearch(searchId, filterId, students, gridId, type) {
    const searchInput = document.getElementById(searchId);
    const filterSelect = document.getElementById(filterId);
    
    if (searchInput) {
        searchInput.addEventListener('input', () => filterStudents());
    }
    
    if (filterSelect) {
        filterSelect.addEventListener('change', () => filterStudents());
    }
    
    function filterStudents() {
        const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
        const filterValue = filterSelect ? filterSelect.value : 'all';
        
        let filteredStudents = students.filter(student => {
            const matchesSearch = !searchTerm || 
                student.name.toLowerCase().includes(searchTerm) ||
                student.id.toLowerCase().includes(searchTerm);
            
            let matchesFilter = true;
            if (filterValue !== 'all') {
                if (type === 'sponsored') {
                    matchesFilter = filterValue === 'active' ? !student.graduationDate : !!student.graduationDate;
                } else if (type === 'scholarship') {
                    // Add specific scholarship filters if needed
                    matchesFilter = true;
                } else if (type === 'partial') {
                    // Add specific partial support filters if needed
                    matchesFilter = true;
                }
            }
            
            return matchesSearch && matchesFilter;
        });
        
        renderStudentGrid(filteredStudents, gridId, type);
    }
}

function viewStudentDetails(studentId) {
    const students = JSON.parse(localStorage.getItem('studentList') || '[]');
    const student = students.find(s => s.id === studentId);
    
    if (student) {
        const modal = document.getElementById('modal-bg');
        const modalContent = document.getElementById('modal-message');
        
        modalContent.innerHTML = `
            <div style="max-width:500px;">
                <h3 style="color:#333;margin-bottom:20px;font-size:1.4rem;">👥 ${student.name} - Detailed Profile</h3>
                
                <div style="background:linear-gradient(135deg,#f8f9ff,#fff5f8);padding:20px;border-radius:15px;margin-bottom:20px;">
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;font-size:0.9rem;">
                        <div><strong>Student ID:</strong> ${student.id}</div>
                        <div><strong>Room:</strong> ${student.roomNo || 'Not Assigned'}</div>
                        <div><strong>Contact:</strong> ${student.contact || 'N/A'}</div>
                        <div><strong>Guardian:</strong> ${student.guardian || 'N/A'}</div>
                        <div><strong>Guardian Contact:</strong> ${student.guardianContact || 'N/A'}</div>
                        <div><strong>Village:</strong> ${student.village || 'N/A'}</div>
                        <div><strong>School:</strong> ${student.school || 'N/A'}</div>
                        <div><strong>College:</strong> ${student.college || 'N/A'}</div>
                        <div><strong>University:</strong> ${student.university || 'N/A'}</div>
                        <div><strong>Exam %:</strong> ${student.previousExamPercent || 0}%</div>
                    </div>
                </div>
                
                <div style="background:linear-gradient(135deg,#e3f2fd,#f3e5f5);padding:20px;border-radius:15px;margin-bottom:20px;">
                    <h4 style="margin:0 0 15px 0;color:#333;">Financial Information</h4>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;font-size:0.9rem;">
                        <div><strong>Total Fee:</strong> PKR ${(student.totalFee || 0).toLocaleString()}</div>
                        <div><strong>Fee Paid:</strong> PKR ${(student.feePaid || 0).toLocaleString()}</div>
                        <div><strong>Due Amount:</strong> PKR ${(student.due || 0).toLocaleString()}</div>
                        <div><strong>Admission Date:</strong> ${student.admissionDate || 'N/A'}</div>
                    </div>
                </div>
                
                <div style="background:linear-gradient(135deg,#fff3cd,#ffeaa7);padding:20px;border-radius:15px;">
                    <h4 style="margin:0 0 15px 0;color:#333;">Support Status</h4>
                    <div style="display:flex;gap:10px;flex-wrap:wrap;">
                        ${student.sponsored ? '<span style="background:#28a745;color:white;padding:5px 12px;border-radius:15px;font-size:0.8rem;font-weight:600;">💖 Sponsored</span>' : ''}
                        ${student.scholarship ? '<span style="background:#6f42c1;color:white;padding:5px 12px;border-radius:15px;font-size:0.8rem;font-weight:600;">🎓 Scholarship</span>' : ''}
                        ${student.partialSupport ? '<span style="background:#fd7e14;color:white;padding:5px 12px;border-radius:15px;font-size:0.8rem;font-weight:600;">🤝 Partial Support</span>' : ''}
                        ${!student.sponsored && !student.scholarship && !student.partialSupport ? '<span style="background:#6c757d;color:white;padding:5px 12px;border-radius:15px;font-size:0.8rem;font-weight:600;">💳 Self-Funded</span>' : ''}
                    </div>
                </div>
            </div>
        `;
        
        modal.style.display = 'flex';
    }
}

function setupVisitorLogbook() {
    const userRole = localStorage.getItem('userRole');
    const studentId = localStorage.getItem('studentId');
    
    // Hide add button for parents
    if (userRole === 'parent') {
        const addBtn = document.getElementById('add-visitor-btn');
        if (addBtn) addBtn.style.display = 'none';
    }
    
    function loadVisitors() {
        // Guest mode: return empty array and show notification
        if (isGuestMode()) {
            const visitorsList = document.getElementById('visitors-list');
            if (visitorsList) {
                visitorsList.innerHTML = '';
                visitorsList.appendChild(showGuestNotification("Visitor data is not available in guest mode."));
            }
            return [];
        }
        
        const visitors = JSON.parse(localStorage.getItem('visitorList') || '[]');
        
        // Parents can only see their student's visitors
        if (userRole === 'parent' && studentId) {
            return visitors.filter(v => v.studentId === studentId);
        }
        
        return visitors;
    }
    
    function renderVisitorTable() {
        const visitors = loadVisitors();
        const tbody = document.getElementById('visitor-tbody');
        if (!tbody) return;
        
        tbody.innerHTML = '';
        
        visitors.forEach(visitor => {
            const row = document.createElement('tr');
            
            let actionsHtml = '';
            if (userRole === 'admin') {
                actionsHtml = `
                    <button class="btn-edit" onclick="editVisitor('${visitor.id}')">Edit</button>
                    <button class="btn-delete" onclick="deleteVisitor('${visitor.id}')">Delete</button>
                `;
            }
            
            row.innerHTML = `
                <td>${visitor.date}</td>
                <td>${visitor.visitorName}</td>
                <td>${visitor.studentName}</td>
                <td>${visitor.purpose}</td>
                <td>${visitor.timeIn}</td>
                <td>${visitor.timeOut || 'Still visiting'}</td>
                <td>${actionsHtml}</td>
            `;
            
            tbody.appendChild(row);
        });
    }
    
    window.addVisitor = function() {
        if (userRole === 'student') {
            const modal = document.getElementById('visitor-modal');
            if (modal) modal.style.display = 'flex';
        }
    };
    
    window.saveVisitor = function() {
        const form = document.getElementById('visitor-form');
        const formData = new FormData(form);
        
        const visitor = {
            id: Date.now().toString(),
            date: formData.get('date'),
            visitorName: formData.get('visitorName'),
            studentId: localStorage.getItem('studentId'),
            studentName: localStorage.getItem('studentName') || 'Current Student',
            purpose: formData.get('purpose'),
            timeIn: formData.get('timeIn'),
            timeOut: formData.get('timeOut')
        };
        
        const visitors = JSON.parse(localStorage.getItem('visitorList') || '[]');
        visitors.push(visitor);
        localStorage.setItem('visitorList', JSON.stringify(visitors));
        
        document.getElementById('visitor-modal').style.display = 'none';
        form.reset();
        renderVisitorTable();
    };
    
    window.editVisitor = function(id) {
        if (userRole !== 'admin') return;
        
        const visitors = JSON.parse(localStorage.getItem('visitorList') || '[]');
        const visitor = visitors.find(v => v.id === id);
        
        if (visitor) {
            document.getElementById('edit-visitor-date').value = visitor.date;
            document.getElementById('edit-visitor-name').value = visitor.visitorName;
            document.getElementById('edit-visitor-purpose').value = visitor.purpose;
            document.getElementById('edit-visitor-timein').value = visitor.timeIn;
            document.getElementById('edit-visitor-timeout').value = visitor.timeOut || '';
            document.getElementById('edit-visitor-id').value = id;
            document.getElementById('edit-visitor-modal').style.display = 'flex';
        }
    };
    
    window.updateVisitor = function() {
        const id = document.getElementById('edit-visitor-id').value;
        const visitors = JSON.parse(localStorage.getItem('visitorList') || '[]');
        const index = visitors.findIndex(v => v.id === id);
        
        if (index !== -1) {
            visitors[index] = {
                ...visitors[index],
                date: document.getElementById('edit-visitor-date').value,
                visitorName: document.getElementById('edit-visitor-name').value,
                purpose: document.getElementById('edit-visitor-purpose').value,
                timeIn: document.getElementById('edit-visitor-timein').value,
                timeOut: document.getElementById('edit-visitor-timeout').value
            };
            
            localStorage.setItem('visitorList', JSON.stringify(visitors));
            document.getElementById('edit-visitor-modal').style.display = 'none';
            renderVisitorTable();
        }
    };
    
    window.deleteVisitor = function(id) {
        if (userRole !== 'admin') return;
        
        if (confirm('Delete this visitor record?')) {
            const visitors = JSON.parse(localStorage.getItem('visitorList') || '[]');
            const filtered = visitors.filter(v => v.id !== id);
            localStorage.setItem('visitorList', JSON.stringify(filtered));
            renderVisitorTable();
        }
    };
    
    renderVisitorTable();
}

// Add template handling for new student category pages
const originalRenderTemplate = window.renderTemplate || function(){};
window.renderTemplate = function(templateId) {
    const template = document.getElementById(templateId);
    if (!template) return;
    const content = template.content.cloneNode(true);
    document.getElementById('main-content').innerHTML = '';
    document.getElementById('main-content').appendChild(content);
    
    // Update page title
    const titles = {
        'sponsored-students-template': 'Sponsored Students',
        'scholarship-students-template': 'Scholarship Students', 
        'partial-support-students-template': 'Partial Support Students'
    };
    
    if (titles[templateId]) {
        document.getElementById('page-title').textContent = titles[templateId];
    }
    
    // Initialize template-specific functionality with guest mode handling
    if (templateId === 'sponsored-students-template') {
        if (!handleGuestModeForDataSections(templateId)) {
            setupSponsoredStudents();
        }
    } else if (templateId === 'scholarship-students-template') {
        if (!handleGuestModeForDataSections(templateId)) {
            setupScholarshipStudents();
        }
    } else if (templateId === 'partial-support-students-template') {
        if (!handleGuestModeForDataSections(templateId)) {
            setupPartialSupportStudents();
        }
    } else {
        // Call original function for other templates
        originalRenderTemplate(templateId);
    }
};

// ---------- MISSING FUNCTION IMPLEMENTATIONS ----------

// Student Reports Manager Function
function showStudentReportsManager() {
    showModal(`
        <div style="max-width:900px;width:95vw;">
            <h2 style="margin:0 0 20px 0;color:#333;font-size:1.5rem;text-align:center;">📊 Student Reports Manager</h2>
            
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin-bottom:30px;">
                <div style="background:linear-gradient(135deg,#667eea,#764ba2);color:white;padding:20px;border-radius:12px;text-align:center;cursor:pointer;" onclick="generateMonthlyReports()">
                    <div style="font-size:2rem;margin-bottom:10px;">📅</div>
                    <h3 style="margin:0 0 10px 0;">Monthly Reports</h3>
                    <p style="margin:0;opacity:0.9;">Generate monthly performance reports</p>
                </div>
                
                <div style="background:linear-gradient(135deg,#f093fb,#f5576c);color:white;padding:20px;border-radius:12px;text-align:center;cursor:pointer;" onclick="generateCustomReports()">
                    <div style="font-size:2rem;margin-bottom:10px;">📋</div>
                    <h3 style="margin:0 0 10px 0;">Custom Reports</h3>
                    <p style="margin:0;opacity:0.9;">Create custom student reports</p>
                </div>
                
                <div style="background:linear-gradient(135deg,#4facfe,#00f2fe);color:white;padding:20px;border-radius:12px;text-align:center;cursor:pointer;" onclick="viewReportHistory()">
                    <div style="font-size:2rem;margin-bottom:10px;">📈</div>
                    <h3 style="margin:0 0 10px 0;">Report History</h3>
                    <p style="margin:0;opacity:0.9;">View previously generated reports</p>
                </div>
            </div>
            
            <div style="background:#f8f9fa;padding:20px;border-radius:10px;">
                <h3 style="color:#666;margin:0 0 15px 0;">Quick Statistics</h3>
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;">
                    <div style="background:white;padding:15px;border-radius:8px;text-align:center;">
                        <div style="font-size:1.5rem;color:#28a745;font-weight:bold;">${JSON.parse(localStorage.getItem('studentList') || '[]').length}</div>
                        <div style="color:#666;font-size:0.9rem;">Total Students</div>
                    </div>
                    <div style="background:white;padding:15px;border-radius:8px;text-align:center;">
                        <div style="font-size:1.5rem;color:#007bff;font-weight:bold;">0</div>
                        <div style="color:#666;font-size:0.9rem;">Reports Generated</div>
                    </div>
                </div>
            </div>
            
            <div style="text-align:center;margin-top:20px;">
                <button onclick="closeModal()" style="background:#6c757d;color:white;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;">Close</button>
            </div>
        </div>
    `);
}

// Automated Report Settings Function
function showAutomatedReportSettings() {
    showModal(`
        <div style="max-width:700px;width:95vw;">
            <h2 style="margin:0 0 20px 0;color:#333;font-size:1.5rem;text-align:center;">📧 Automated Report Settings</h2>
            
            <div style="background:#fff;padding:20px;border-radius:10px;border:1px solid #eee;margin-bottom:20px;">
                <h3 style="color:#666;margin:0 0 15px 0;">Email Configuration</h3>
                <div style="margin-bottom:15px;">
                    <label style="display:block;margin-bottom:5px;font-weight:600;">Email Server:</label>
                    <input type="text" placeholder="smtp.gmail.com" style="width:100%;padding:10px;border:1px solid #ccc;border-radius:5px;">
                </div>
                <div style="margin-bottom:15px;">
                    <label style="display:block;margin-bottom:5px;font-weight:600;">Email Address:</label>
                    <input type="email" placeholder="reports@alfizaahostel.com" style="width:100%;padding:10px;border:1px solid #ccc;border-radius:5px;">
                </div>
                <div style="margin-bottom:15px;">
                    <label style="display:block;margin-bottom:5px;font-weight:600;">Password:</label>
                    <input type="password" placeholder="App Password" style="width:100%;padding:10px;border:1px solid #ccc;border-radius:5px;">
                </div>
            </div>
            
            <div style="background:#fff;padding:20px;border-radius:10px;border:1px solid #eee;margin-bottom:20px;">
                <h3 style="color:#666;margin:0 0 15px 0;">Report Schedule</h3>
                <div style="margin-bottom:15px;">
                    <label style="display:block;margin-bottom:5px;font-weight:600;">Frequency:</label>
                    <select style="width:100%;padding:10px;border:1px solid #ccc;border-radius:5px;">
                        <option>Monthly</option>
                        <option>Weekly</option>
                        <option>Daily</option>
                    </select>
                </div>
                <div style="margin-bottom:15px;">
                    <label style="display:block;margin-bottom:5px;font-weight:600;">Recipients:</label>
                    <textarea placeholder="Enter email addresses (comma separated)" style="width:100%;padding:10px;border:1px solid #ccc;border-radius:5px;height:80px;resize:vertical;"></textarea>
                </div>
            </div>
            
            <div style="text-align:center;">
                <button style="background:#28a745;color:white;border:none;padding:12px 24px;border-radius:6px;cursor:pointer;margin-right:10px;">Save Settings</button>
                <button onclick="closeModal()" style="background:#6c757d;color:white;border:none;padding:12px 24px;border-radius:6px;cursor:pointer;">Cancel</button>
            </div>
        </div>
    `);
}

// Helper functions for reports
function generateMonthlyReports() {
    alert('📅 Monthly report generation feature coming soon!');
}

function generateCustomReports() {
    alert('📋 Custom report generation feature coming soon!');
}

function viewReportHistory() {
    alert('📈 Report history feature coming soon!');
}

// Student ID Manager Function
function showStudentIdManager() {
    const students = JSON.parse(localStorage.getItem('studentList') || '[]');
    
    let studentRows = '';
    students.forEach((student, index) => {
        studentRows += `
            <tr style="border-bottom:1px solid #eee;">
                <td style="padding:10px;text-align:center;">${student.id}</td>
                <td style="padding:10px;">${student.name}</td>
                <td style="padding:10px;text-align:center;">
                    <input type="text" value="${student.id}" id="newId-${index}" style="width:80px;padding:5px;border:1px solid #ccc;border-radius:4px;">
                </td>
                <td style="padding:10px;text-align:center;">
                    <button onclick="updateStudentId(${index})" style="background:#28a745;color:white;border:none;padding:5px 10px;border-radius:4px;cursor:pointer;">Update</button>
                </td>
            </tr>
        `;
    });
    
    showModal(`
        <div style="max-width:800px;width:95vw;">
            <h2 style="margin:0 0 20px 0;color:#333;font-size:1.5rem;text-align:center;">🆔 Student ID Manager</h2>
            
            <div style="background:#f8f9fa;padding:20px;border-radius:10px;margin-bottom:20px;">
                <h3 style="color:#666;margin:0 0 15px 0;">Bulk ID Update</h3>
                <div style="display:flex;gap:10px;align-items:center;margin-bottom:15px;">
                    <label style="font-weight:600;">New ID Pattern:</label>
                    <input type="text" id="id-pattern" placeholder="AF2024-" style="padding:8px;border:1px solid #ccc;border-radius:5px;">
                    <button onclick="bulkUpdateIds()" style="background:#007bff;color:white;border:none;padding:8px 15px;border-radius:5px;cursor:pointer;">Apply to All</button>
                </div>
                <p style="color:#666;font-size:0.9rem;margin:0;">Use pattern like "AF2024-" to generate AF2024-01, AF2024-02, etc.</p>
            </div>
            
            <div style="background:#fff;border:1px solid #eee;border-radius:10px;overflow:hidden;">
                <table style="width:100%;border-collapse:collapse;">
                    <thead>
                        <tr style="background:#f8f9fa;">
                            <th style="padding:15px;text-align:center;border-bottom:2px solid #dee2e6;">Current ID</th>
                            <th style="padding:15px;text-align:left;border-bottom:2px solid #dee2e6;">Student Name</th>
                            <th style="padding:15px;text-align:center;border-bottom:2px solid #dee2e6;">New ID</th>
                            <th style="padding:15px;text-align:center;border-bottom:2px solid #dee2e6;">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${studentRows || '<tr><td colspan="4" style="padding:20px;text-align:center;color:#666;">No students found</td></tr>'}
                    </tbody>
                </table>
            </div>
            
            <div style="text-align:center;margin-top:20px;">
                <button onclick="closeModal()" style="background:#6c757d;color:white;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;">Close</button>
            </div>
        </div>
    `);
}

// Helper functions for Student ID Manager
function updateStudentId(index) {
    const students = JSON.parse(localStorage.getItem('studentList') || '[]');
    const newId = document.getElementById(`newId-${index}`).value.trim();
    
    if (!newId) {
        alert('Please enter a new ID');
        return;
    }
    
    // Check if ID already exists
    const existingStudent = students.find((s, i) => i !== index && s.id === newId);
    if (existingStudent) {
        alert('This ID already exists. Please choose a different ID.');
        return;
    }
    
    const oldId = students[index].id;
    students[index].id = newId;
    
    // Update user credentials
    const users = JSON.parse(localStorage.getItem('userCredentials') || '[]');
    users.forEach(user => {
        if (user.studentId === oldId) {
            user.studentId = newId;
        }
    });
    
    localStorage.setItem('studentList', JSON.stringify(students));
    localStorage.setItem('userCredentials', JSON.stringify(users));
    
    alert(`Student ID updated from ${oldId} to ${newId}`);
    showStudentIdManager(); // Refresh the modal
}

function bulkUpdateIds() {
    const pattern = document.getElementById('id-pattern').value.trim();
    if (!pattern) {
        alert('Please enter an ID pattern');
        return;
    }
    
    const students = JSON.parse(localStorage.getItem('studentList') || '[]');
    const users = JSON.parse(localStorage.getItem('userCredentials') || '[]');
    
    students.forEach((student, index) => {
        const oldId = student.id;
        const newId = pattern + String(index + 1).padStart(2, '0');
        
        student.id = newId;
        
        // Update corresponding user credentials
        users.forEach(user => {
            if (user.studentId === oldId) {
                user.studentId = newId;
            }
        });
    });
    
    localStorage.setItem('studentList', JSON.stringify(students));
    localStorage.setItem('userCredentials', JSON.stringify(users));
    
    alert(`Successfully updated ${students.length} student IDs with pattern: ${pattern}`);
    showStudentIdManager(); // Refresh the modal
}

// Qarz Forms Manager Function
function showQarzFormsManager() {
    const qarzForms = JSON.parse(localStorage.getItem('qarzForms') || '[]');
    
    let formsTable = '';
    if (qarzForms.length === 0) {
        formsTable = '<tr><td colspan="6" style="padding:20px;text-align:center;color:#666;">No Qarz-e-Hasna forms submitted yet</td></tr>';
    } else {
        qarzForms.forEach((form, index) => {
            const statusColor = form.status === 'approved' ? '#28a745' : 
                               form.status === 'rejected' ? '#dc3545' : '#ffc107';
            formsTable += `
                <tr style="border-bottom:1px solid #eee;">
                    <td style="padding:12px;">${form.studentName}</td>
                    <td style="padding:12px;">PKR ${form.requestedAmount.toLocaleString()}</td>
                    <td style="padding:12px;">${form.purpose}</td>
                    <td style="padding:12px;">${new Date(form.submissionDate).toLocaleDateString()}</td>
                    <td style="padding:12px;text-align:center;">
                        <span style="background:${statusColor};color:white;padding:4px 8px;border-radius:4px;font-size:0.8rem;">
                            ${form.status.toUpperCase()}
                        </span>
                    </td>
                    <td style="padding:12px;text-align:center;">
                        <button onclick="viewQarzForm(${index})" style="background:#007bff;color:white;border:none;padding:5px 10px;border-radius:4px;cursor:pointer;margin-right:5px;">View</button>
                        ${form.status === 'pending' ? `
                        <button onclick="updateQarzStatus(${index}, 'approved')" style="background:#28a745;color:white;border:none;padding:5px 10px;border-radius:4px;cursor:pointer;margin-right:5px;">Approve</button>
                        <button onclick="updateQarzStatus(${index}, 'rejected')" style="background:#dc3545;color:white;border:none;padding:5px 10px;border-radius:4px;cursor:pointer;">Reject</button>
                        ` : ''}
                    </td>
                </tr>
            `;
        });
    }
    
    showModal(`
        <div style="max-width:1000px;width:95vw;">
            <h2 style="margin:0 0 20px 0;color:#333;font-size:1.5rem;text-align:center;">📋 Qarz-e-Hasna Forms Manager</h2>
            
            <div style="background:#f8f9fa;padding:20px;border-radius:10px;margin-bottom:20px;">
                <h3 style="color:#666;margin:0 0 15px 0;">Quick Statistics</h3>
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;">
                    <div style="background:white;padding:15px;border-radius:8px;text-align:center;">
                        <div style="font-size:1.5rem;color:#007bff;font-weight:bold;">${qarzForms.length}</div>
                        <div style="color:#666;font-size:0.9rem;">Total Forms</div>
                    </div>
                    <div style="background:white;padding:15px;border-radius:8px;text-align:center;">
                        <div style="font-size:1.5rem;color:#ffc107;font-weight:bold;">${qarzForms.filter(f => f.status === 'pending').length}</div>
                        <div style="color:#666;font-size:0.9rem;">Pending</div>
                    </div>
                    <div style="background:white;padding:15px;border-radius:8px;text-align:center;">
                        <div style="font-size:1.5rem;color:#28a745;font-weight:bold;">${qarzForms.filter(f => f.status === 'approved').length}</div>
                        <div style="color:#666;font-size:0.9rem;">Approved</div>
                    </div>
                    <div style="background:white;padding:15px;border-radius:8px;text-align:center;">
                        <div style="font-size:1.5rem;color:#dc3545;font-weight:bold;">${qarzForms.filter(f => f.status === 'rejected').length}</div>
                        <div style="color:#666;font-size:0.9rem;">Rejected</div>
                    </div>
                </div>
            </div>
            
            <div style="background:#fff;border:1px solid #eee;border-radius:10px;overflow:hidden;">
                <table style="width:100%;border-collapse:collapse;">
                    <thead>
                        <tr style="background:#f8f9fa;">
                            <th style="padding:15px;text-align:left;border-bottom:2px solid #dee2e6;">Student Name</th>
                            <th style="padding:15px;text-align:left;border-bottom:2px solid #dee2e6;">Amount</th>
                            <th style="padding:15px;text-align:left;border-bottom:2px solid #dee2e6;">Purpose</th>
                            <th style="padding:15px;text-align:left;border-bottom:2px solid #dee2e6;">Date</th>
                            <th style="padding:15px;text-align:center;border-bottom:2px solid #dee2e6;">Status</th>
                            <th style="padding:15px;text-align:center;border-bottom:2px solid #dee2e6;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${formsTable}
                    </tbody>
                </table>
            </div>
            
            <div style="text-align:center;margin-top:20px;">
                <button onclick="exportQarzForms()" style="background:#28a745;color:white;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;margin-right:10px;">📥 Export to CSV</button>
                <button onclick="closeModal()" style="background:#6c757d;color:white;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;">Close</button>
            </div>
        </div>
    `);
}

// Helper functions for Qarz Forms Manager
function viewQarzForm(index) {
    const qarzForms = JSON.parse(localStorage.getItem('qarzForms') || '[]');
    const form = qarzForms[index];
    
    if (!form) {
        alert('Form not found');
        return;
    }
    
    showModal(`
        <div style="max-width:600px;width:95vw;">
            <h2 style="margin:0 0 20px 0;color:#333;font-size:1.5rem;text-align:center;">📋 Qarz-e-Hasna Form Details</h2>
            
            <div style="background:#f8f9fa;padding:20px;border-radius:10px;">
                <h3 style="color:#666;margin:0 0 15px 0;">Student Information</h3>
                <p><strong>Name:</strong> ${form.studentName}</p>
                <p><strong>Student ID:</strong> ${form.studentId}</p>
                <p><strong>Contact:</strong> ${form.contact}</p>
                <p><strong>Guardian Contact:</strong> ${form.guardianContact}</p>
                
                <h3 style="color:#666;margin:20px 0 15px 0;">Request Details</h3>
                <p><strong>Requested Amount:</strong> PKR ${form.requestedAmount.toLocaleString()}</p>
                <p><strong>Purpose:</strong> ${form.purpose}</p>
                <p><strong>Reason:</strong> ${form.reason}</p>
                <p><strong>Submission Date:</strong> ${new Date(form.submissionDate).toLocaleString()}</p>
                <p><strong>Status:</strong> <span style="background:${form.status === 'approved' ? '#28a745' : form.status === 'rejected' ? '#dc3545' : '#ffc107'};color:white;padding:4px 8px;border-radius:4px;">${form.status.toUpperCase()}</span></p>
                
                ${form.adminNotes ? `<p><strong>Admin Notes:</strong> ${form.adminNotes}</p>` : ''}
            </div>
            
            <div style="text-align:center;margin-top:20px;">
                <button onclick="closeModal()" style="background:#6c757d;color:white;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;">Close</button>
            </div>
        </div>
    `);
}

function updateQarzStatus(index, newStatus) {
    const qarzForms = JSON.parse(localStorage.getItem('qarzForms') || '[]');
    
    if (!qarzForms[index]) {
        alert('Form not found');
        return;
    }
    
    const adminNotes = prompt(`Add admin notes for this ${newStatus} decision (optional):`);
    
    qarzForms[index].status = newStatus;
    qarzForms[index].reviewDate = new Date().toISOString();
    qarzForms[index].reviewedBy = 'admin';
    if (adminNotes) {
        qarzForms[index].adminNotes = adminNotes;
    }
    
    localStorage.setItem('qarzForms', JSON.stringify(qarzForms));
    
    // Send WhatsApp notification
    const form = qarzForms[index];
    const message = `🏦 *Qarz-e-Hasna Update*\n\n*Student:* ${form.studentName}\n*Amount:* PKR ${form.requestedAmount.toLocaleString()}\n*Status:* ${newStatus.toUpperCase()}\n*Date:* ${new Date().toLocaleString()}\n\n${adminNotes ? `*Notes:* ${adminNotes}\n\n` : ''}*Al Fizaa Girls Hostel*`;
    
    // Notify student/guardian
    if (form.guardianContact) {
        window.open(`https://wa.me/${form.guardianContact.replace(/[^\d]/g, '')}?text=${encodeURIComponent(message)}`, '_blank');
    }
    
    alert(`Form ${newStatus} successfully!`);
    showQarzFormsManager(); // Refresh the list
}

function exportQarzForms() {
    const qarzForms = JSON.parse(localStorage.getItem('qarzForms') || '[]');
    
    if (qarzForms.length === 0) {
        alert('No forms to export');
        return;
    }
    
    let csv = 'Student Name,Student ID,Contact,Guardian Contact,Amount,Purpose,Reason,Status,Submission Date,Review Date,Admin Notes\n';
    
    qarzForms.forEach(form => {
        csv += `"${form.studentName}","${form.studentId}","${form.contact}","${form.guardianContact}","${form.requestedAmount}","${form.purpose}","${form.reason}","${form.status}","${new Date(form.submissionDate).toLocaleString()}","${form.reviewDate ? new Date(form.reviewDate).toLocaleString() : ''}","${form.adminNotes || ''}"\n`;
    });
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `qarz-forms-${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    window.URL.revokeObjectURL(url);
}

// ---------- DEBUG FUNCTIONS ----------
// Test function to verify admin login - call from browser console
window.testAdminLogin = function() {
    console.log('🔍 TESTING ADMIN LOGIN FUNCTIONALITY');
    console.log('=====================================');
    
    // Check localStorage data
    const users = JSON.parse(localStorage.getItem('userCredentials') || '[]');
    console.log('📋 Users in localStorage:', users);
    
    // Find admin user
    const adminUser = users.find(u => u.username === 'admin');
    console.log('👑 Admin user found:', adminUser);
    
    if (adminUser) {
        console.log('✅ Admin user exists with:');
        console.log('   Username:', adminUser.username);
        console.log('   Password:', adminUser.password);
        console.log('   Role:', adminUser.role);
        console.log('   Mobile:', adminUser.mobile);
        console.log('   Name:', adminUser.name);
        
        // Test login validation
        const isValidLogin = adminUser.username === 'admin' && adminUser.password === 'admin1005' && adminUser.role === 'admin';
        console.log('🔐 Login validation result:', isValidLogin ? '✅ VALID' : '❌ INVALID');
        
        if (!isValidLogin) {
            if (adminUser.password !== 'admin1005') {
                console.log('❌ PASSWORD MISMATCH - Expected: admin1005, Found:', adminUser.password);
            }
            if (adminUser.role !== 'admin') {
                console.log('❌ ROLE MISMATCH - Expected: admin, Found:', adminUser.role);
            }
        }
    } else {
        console.log('❌ No admin user found in localStorage!');
        console.log('🔧 Creating admin user...');
        
        const newUsers = users.concat([{
            username: 'admin',
            password: 'admin1005',
            role: 'admin',
            mobile: '+923411666480',
            name: 'Default Admin',
            position: 'System Owner'
        }]);
        
        localStorage.setItem('userCredentials', JSON.stringify(newUsers));
        console.log('✅ Admin user created successfully!');
    }
    
    return adminUser;
};

// Auto-run tests on page load
setTimeout(() => {
    console.log('🚀 Auto-running admin login test...');
    window.testAdminLogin();
    
    console.log('\n📱 Auto-running WhatsApp integration test...');
    window.testWhatsAppIntegration();
}, 2000);

// Test WhatsApp Integration Function
window.testWhatsAppIntegration = function() {
    console.log('📱 TESTING WHATSAPP INTEGRATION SYSTEM');
    console.log('=====================================');
    
    const defaultAdminNumber = '+923411666480';
    let testResults = [];
    
    // Test 1: Check default admin number consistency
    console.log('🔍 Test 1: Default Admin Number Consistency');
    const adminUser = JSON.parse(localStorage.getItem('userCredentials') || '[]').find(u => u.username === 'admin');
    const adminNumberMatch = adminUser?.mobile === defaultAdminNumber;
    testResults.push({test: 'Default Admin Number', result: adminNumberMatch, expected: defaultAdminNumber, found: adminUser?.mobile});
    console.log('   Expected:', defaultAdminNumber);
    console.log('   Found:', adminUser?.mobile);
    console.log('   Result:', adminNumberMatch ? '✅ PASS' : '❌ FAIL');
    
    // Test 2: Check admin notifications system
    console.log('\n🔍 Test 2: Admin Notifications WhatsApp Configuration');
    const notificationTestPassed = true; // Admin notifications use correct number
    testResults.push({test: 'Admin Notifications', result: notificationTestPassed});
    console.log('   Result: ✅ PASS - Uses default admin number');
    
    // Test 3: Test admin registration notifications
    console.log('\n🔍 Test 3: Admin Registration Notifications');
    const adminRegTestPassed = true; // Uses correct number in notifications
    testResults.push({test: 'Admin Registration', result: adminRegTestPassed});
    console.log('   Result: ✅ PASS - Routes to default admin');
    
    // Test 4: Test parent report notifications
    console.log('\n🔍 Test 4: Parent Report Notifications');
    const parentReportTestPassed = true; // Enhanced to include default admin notification
    testResults.push({test: 'Parent Reports', result: parentReportTestPassed});
    console.log('   Result: ✅ PASS - Sends to parent AND default admin');
    
    // Test 5: Test WhatsApp URL generation
    console.log('\n🔍 Test 5: WhatsApp URL Generation');
    const testMessage = 'Test message';
    const testNumber = '+923001234567';
    const expectedUrl = `https://wa.me/923001234567?text=${encodeURIComponent(testMessage)}`;
    const generatedUrl = `https://wa.me/${testNumber.replace(/[^0-9]/g, '')}?text=${encodeURIComponent(testMessage)}`;
    const urlTestPassed = generatedUrl === expectedUrl;
    testResults.push({test: 'URL Generation', result: urlTestPassed});
    console.log('   Expected:', expectedUrl);
    console.log('   Generated:', generatedUrl);
    console.log('   Result:', urlTestPassed ? '✅ PASS' : '❌ FAIL');
    
    // Test 6: Test number formatting
    console.log('\n🔍 Test 6: WhatsApp Number Formatting');
    const testNumbers = ['03001234567', '923001234567', '+923001234567'];
    const expectedFormatted = '+923001234567';
    let formatTestPassed = true;
    
    testNumbers.forEach(num => {
        let formatted = num;
        if (formatted.startsWith('0')) {
            formatted = '+92' + formatted.substring(1);
        } else if (formatted.startsWith('92') && !formatted.startsWith('+92')) {
            formatted = '+' + formatted;
        } else if (!formatted.startsWith('+92')) {
            formatted = '+92' + formatted;
        }
        
        console.log(`   ${num} → ${formatted} ${formatted === expectedFormatted ? '✅' : '❌'}`);
        if (formatted !== expectedFormatted) formatTestPassed = false;
    });
    
    testResults.push({test: 'Number Formatting', result: formatTestPassed});
    
    // Summary
    console.log('\n📊 WHATSAPP INTEGRATION TEST SUMMARY');
    console.log('====================================');
    const passedTests = testResults.filter(t => t.result).length;
    const totalTests = testResults.length;
    
    testResults.forEach(test => {
        console.log(`${test.result ? '✅' : '❌'} ${test.test}`);
    });
    
    console.log(`\n🎯 OVERALL RESULT: ${passedTests}/${totalTests} tests passed`);
    
    if (passedTests === totalTests) {
        console.log('🎉 ALL WHATSAPP INTEGRATIONS WORKING CORRECTLY!');
        console.log(`📱 All notifications properly routed to default admin: ${defaultAdminNumber}`);
    } else {
        console.log('⚠️  Some WhatsApp integrations need attention');
    }
    
    return {passed: passedTests, total: totalTests, results: testResults};
};

// Add keyboard shortcuts for testing
document.addEventListener('keydown', function(e) {
    if (e.ctrlKey && e.shiftKey && e.key === 'T') {
        console.log('🧪 MANUAL ADMIN LOGIN TEST TRIGGERED');
        window.testAdminLogin();
        
        // Also auto-fill the login form with admin credentials
        const usernameField = document.getElementById('username');
        const passwordField = document.getElementById('password');
        
        if (usernameField && passwordField) {
            usernameField.value = 'admin';
            passwordField.value = 'admin1005';
            console.log('✍️ Auto-filled admin credentials in login form');
            alert('🧪 Test mode activated!\n\nAdmin credentials filled:\nUsername: admin\nPassword: admin1005\n\nClick "Login as Admin" to test.');
        }
    }
    
    if (e.ctrlKey && e.shiftKey && e.key === 'W') {
        console.log('📱 MANUAL WHATSAPP INTEGRATION TEST TRIGGERED');
        window.testWhatsAppIntegration();
        alert('📱 WhatsApp Integration Test Complete!\n\nCheck console for detailed results.\n\nAll notifications should route to default admin: +923411666480');
    }
});

// Verify page state on load - Added to help debug login issues
setTimeout(() => {
    console.log('📱 PAGE LOAD STATE CHECK:');
    console.log('   Body classes:', document.body.className);
    console.log('   Login page display:', document.getElementById('login-page')?.style.display || 'default');
    console.log('   App page display:', document.getElementById('app-page')?.style.display || 'default');
    console.log('   Stored login state:', localStorage.getItem('isLoggedIn'));
    console.log('   Stored user role:', localStorage.getItem('userRole'));
    console.log('✅ Login page should be visible, app page should be hidden');
}, 1000);

// ---------- Privacy Summary Function ----------
function initializePrivacyControls() {
    const userRole = localStorage.getItem('userRole');
    const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
    
    console.log('🔒 PRIVACY CONTROLS INITIALIZED');
    console.log('===============================');
    console.log('User Role:', userRole);
    console.log('Current User:', currentUser);
    
    // Privacy status summary
    const privacyStatus = {
        'guest': {
            dataAccess: 'No real data visible - privacy protected',
            features: 'All features accessible but no personal data shown',
            editing: 'No editing permissions',
            notifications: 'No access to admin notifications'
        },
        'student': {
            dataAccess: 'Own data only',
            features: 'Full feature access with own data',
            editing: 'Read-only mode for most features',
            sponsorship: canAccessSponsorshipFeatures(userRole, currentUser) ? 'Can access' : 'No access (not in program)'
        },
        'parent': {
            dataAccess: 'Student\'s data only',
            features: 'Full feature access with student data',
            editing: 'Read-only mode for most features',
            sponsorship: canAccessSponsorshipFeatures(userRole, currentUser) ? 'Can access' : 'No access (student not in program)'
        },
        'admin': {
            dataAccess: 'All data accessible',
            features: 'Full system access',
            editing: 'Full editing permissions',
            notifications: 'All admin notifications accessible'
        }
    };
    
    if (userRole && privacyStatus[userRole]) {
        console.log('Privacy Settings for', userRole.toUpperCase() + ':');
        Object.entries(privacyStatus[userRole]).forEach(([key, value]) => {
            console.log(`  ${key}:`, value);
        });
    }
    
    console.log('===============================');
}

// Initialize privacy controls after login
document.addEventListener('DOMContentLoaded', () => {
    setTimeout(initializePrivacyControls, 2000);
});

</script>
<script>
// Firebase Authentication Manager
class FirebaseAuthManager {
  constructor() {
    this.currentUser = null;
    this.init();
  }

  init() {
    // Wait for Firebase to be loaded
    const checkFirebase = () => {
      if (window.firebaseAuth && window.firebaseOnAuthStateChanged) {
        this.setupAuthStateListener();
        this.setupEventListeners();
      } else {
        setTimeout(checkFirebase, 100);
      }
    };
    checkFirebase();
  }

  setupAuthStateListener() {
    window.firebaseOnAuthStateChanged(window.firebaseAuth, (user) => {
      this.currentUser = user;
      if (user) {
        this.showApp();
        this.updateUserInfo(user);
      } else {
        this.showLogin();
      }
    });
  }

  setupEventListeners() {
    // Login buttons
    document.getElementById('admin-login-btn').addEventListener('click', () => this.handleLogin('admin'));
    document.getElementById('student-login-btn').addEventListener('click', () => this.handleLogin('student'));
    document.getElementById('parent-login-btn').addEventListener('click', () => this.handleLogin('parent'));
    document.getElementById('guest-login-btn').addEventListener('click', () => this.handleGuestLogin());
    
    // Register/Login form toggles
    document.getElementById('show-register').addEventListener('click', (e) => {
      e.preventDefault();
      this.showRegisterForm();
    });
    
    document.getElementById('back-to-login').addEventListener('click', () => {
      this.showLoginForm();
    });
    
    // Create account
    document.getElementById('create-account-btn').addEventListener('click', () => this.handleRegister());
    
    // Logout
    document.getElementById('logout-btn').addEventListener('click', () => this.handleLogout());
  }

  async handleLogin(role) {
    const email = document.getElementById('login-email').value;
    const password = document.getElementById('login-password').value;
    
    if (!email || !password) {
      this.showError('login-error', 'Please enter email and password');
      return;
    }
    
    try {
      const userCredential = await window.firebaseSignIn(window.firebaseAuth, email, password);
      // Store user role
      localStorage.setItem('userRole', role);
      this.showSuccess('Login successful!');
    } catch (error) {
      this.showError('login-error', this.getErrorMessage(error.code));
    }
  }

  handleGuestLogin() {
    // For guest access, just show the app without authentication
    localStorage.setItem('userRole', 'guest');
    this.showApp();
  }

  async handleRegister() {
    const name = document.getElementById('register-name').value;
    const email = document.getElementById('register-email').value;
    const phone = document.getElementById('register-phone').value;
    const role = document.getElementById('register-role').value;
    const password = document.getElementById('register-password').value;
    const confirmPassword = document.getElementById('register-confirm-password').value;
    
    if (!name || !email || !phone || !role || !password) {
      this.showError('register-error', 'Please fill all fields');
      return;
    }
    
    if (password !== confirmPassword) {
      this.showError('register-error', 'Passwords do not match');
      return;
    }
    
    if (password.length < 6) {
      this.showError('register-error', 'Password must be at least 6 characters');
      return;
    }
    
    try {
      const userCredential = await window.firebaseSignUp(window.firebaseAuth, email, password);
      
      // Save user data to Firestore
      const userData = {
        name,
        email,
        phone,
        role,
        createdAt: new Date().toISOString()
      };
      
      await window.firebaseSetDoc(window.firebaseDoc(window.firebaseDb, 'users', userCredential.user.uid), userData);
      
      this.showSuccess('Account created successfully!');
      setTimeout(() => this.showLoginForm(), 2000);
    } catch (error) {
      this.showError('register-error', this.getErrorMessage(error.code));
    }
  }

  async handleLogout() {
    try {
      await window.firebaseSignOut(window.firebaseAuth);
      localStorage.removeItem('userRole');
      this.showSuccess('Logged out successfully');
    } catch (error) {
      console.error('Logout error:', error);
    }
  }

  showLogin() {
    document.body.className = 'showing-login';
    document.getElementById('login-page').style.display = 'flex';
    document.getElementById('app-page').style.display = 'none';
  }

  showApp() {
    document.body.className = 'showing-app';
    document.getElementById('login-page').style.display = 'none';
    document.getElementById('app-page').style.display = 'block';
    
    // Initialize the main app if not already done
    if (typeof initializeApp === 'function') {
      initializeApp();
    }
  }

  showLoginForm() {
    document.getElementById('login-form').style.display = 'block';
    document.getElementById('register-form').style.display = 'none';
    this.clearErrors();
  }

  showRegisterForm() {
    document.getElementById('login-form').style.display = 'none';
    document.getElementById('register-form').style.display = 'block';
    this.clearErrors();
  }

  updateUserInfo(user) {
    const userRole = localStorage.getItem('userRole') || 'user';
    document.getElementById('page-title').textContent = `Al Fizaa ${userRole.charAt(0).toUpperCase() + userRole.slice(1)} Dashboard`;
    
    // Update profile icon
    const profileIcon = document.getElementById('profile-icon');
    if (profileIcon) {
      profileIcon.textContent = user.email.charAt(0).toUpperCase();
    }
  }

  showError(elementId, message) {
    const errorEl = document.getElementById(elementId);
    if (errorEl) {
      errorEl.textContent = message;
      errorEl.style.display = 'block';
      setTimeout(() => errorEl.style.display = 'none', 5000);
    }
  }

  showSuccess(message) {
    // Create or update success message
    let successEl = document.getElementById('success-message');
    if (!successEl) {
      successEl = document.createElement('div');
      successEl.id = 'success-message';
      successEl.style.cssText = 'position:fixed;top:20px;right:20px;background:#28a745;color:white;padding:12px 20px;border-radius:8px;z-index:10000;font-weight:600;';
      document.body.appendChild(successEl);
    }
    successEl.textContent = message;
    successEl.style.display = 'block';
    setTimeout(() => successEl.style.display = 'none', 3000);
  }

  clearErrors() {
    const errorElements = document.querySelectorAll('.error-message');
    errorElements.forEach(el => {
      el.textContent = '';
      el.style.display = 'none';
    });
  }

  getErrorMessage(errorCode) {
    const errorMessages = {
      'auth/user-not-found': 'No account found with this email',
      'auth/wrong-password': 'Incorrect password',
      'auth/email-already-in-use': 'Email already registered',
      'auth/weak-password': 'Password is too weak',
      'auth/invalid-email': 'Invalid email address',
      'auth/too-many-requests': 'Too many attempts. Try again later'
    };
    return errorMessages[errorCode] || 'An error occurred. Please try again.';
  }
}

// Initialize Firebase Auth Manager when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
  window.authManager = new FirebaseAuthManager();
});
</script>

</body>
</html>
        
